let isBuilding = false;

const vueDev = 'data:text/javascript;base64,LyoqDQoqIHZ1ZSB2My41LjE3DQoqIChjKSAyMDE4LXByZXNlbnQgWXV4aSAoRXZhbikgWW91IGFuZCBWdWUgY29udHJpYnV0b3JzDQoqIEBsaWNlbnNlIE1JVA0KKiovDQp2YXIgVnVlID0gKGZ1bmN0aW9uIChleHBvcnRzKSB7DQogICd1c2Ugc3RyaWN0JzsNCg0KICAvKiEgI19fTk9fU0lERV9FRkZFQ1RTX18gKi8NCiAgLy8gQF9fTk9fU0lERV9FRkZFQ1RTX18NCiAgZnVuY3Rpb24gbWFrZU1hcChzdHIpIHsNCiAgICBjb25zdCBtYXAgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsNCiAgICBmb3IgKGNvbnN0IGtleSBvZiBzdHIuc3BsaXQoIiwiKSkgbWFwW2tleV0gPSAxOw0KICAgIHJldHVybiAodmFsKSA9PiB2YWwgaW4gbWFwOw0KICB9DQoNCiAgY29uc3QgRU1QVFlfT0JKID0gT2JqZWN0LmZyZWV6ZSh7fSkgOw0KICBjb25zdCBFTVBUWV9BUlIgPSBPYmplY3QuZnJlZXplKFtdKSA7DQogIGNvbnN0IE5PT1AgPSAoKSA9PiB7DQogIH07DQogIGNvbnN0IE5PID0gKCkgPT4gZmFsc2U7DQogIGNvbnN0IGlzT24gPSAoa2V5KSA9PiBrZXkuY2hhckNvZGVBdCgwKSA9PT0gMTExICYmIGtleS5jaGFyQ29kZUF0KDEpID09PSAxMTAgJiYgLy8gdXBwZXJjYXNlIGxldHRlcg0KICAoa2V5LmNoYXJDb2RlQXQoMikgPiAxMjIgfHwga2V5LmNoYXJDb2RlQXQoMikgPCA5Nyk7DQogIGNvbnN0IGlzTW9kZWxMaXN0ZW5lciA9IChrZXkpID0+IGtleS5zdGFydHNXaXRoKCJvblVwZGF0ZToiKTsNCiAgY29uc3QgZXh0ZW5kID0gT2JqZWN0LmFzc2lnbjsNCiAgY29uc3QgcmVtb3ZlID0gKGFyciwgZWwpID0+IHsNCiAgICBjb25zdCBpID0gYXJyLmluZGV4T2YoZWwpOw0KICAgIGlmIChpID4gLTEpIHsNCiAgICAgIGFyci5zcGxpY2UoaSwgMSk7DQogICAgfQ0KICB9Ow0KICBjb25zdCBoYXNPd25Qcm9wZXJ0eSQxID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsNCiAgY29uc3QgaGFzT3duID0gKHZhbCwga2V5KSA9PiBoYXNPd25Qcm9wZXJ0eSQxLmNhbGwodmFsLCBrZXkpOw0KICBjb25zdCBpc0FycmF5ID0gQXJyYXkuaXNBcnJheTsNCiAgY29uc3QgaXNNYXAgPSAodmFsKSA9PiB0b1R5cGVTdHJpbmcodmFsKSA9PT0gIltvYmplY3QgTWFwXSI7DQogIGNvbnN0IGlzU2V0ID0gKHZhbCkgPT4gdG9UeXBlU3RyaW5nKHZhbCkgPT09ICJbb2JqZWN0IFNldF0iOw0KICBjb25zdCBpc0RhdGUgPSAodmFsKSA9PiB0b1R5cGVTdHJpbmcodmFsKSA9PT0gIltvYmplY3QgRGF0ZV0iOw0KICBjb25zdCBpc1JlZ0V4cCA9ICh2YWwpID0+IHRvVHlwZVN0cmluZyh2YWwpID09PSAiW29iamVjdCBSZWdFeHBdIjsNCiAgY29uc3QgaXNGdW5jdGlvbiA9ICh2YWwpID0+IHR5cGVvZiB2YWwgPT09ICJmdW5jdGlvbiI7DQogIGNvbnN0IGlzU3RyaW5nID0gKHZhbCkgPT4gdHlwZW9mIHZhbCA9PT0gInN0cmluZyI7DQogIGNvbnN0IGlzU3ltYm9sID0gKHZhbCkgPT4gdHlwZW9mIHZhbCA9PT0gInN5bWJvbCI7DQogIGNvbnN0IGlzT2JqZWN0ID0gKHZhbCkgPT4gdmFsICE9PSBudWxsICYmIHR5cGVvZiB2YWwgPT09ICJvYmplY3QiOw0KICBjb25zdCBpc1Byb21pc2UgPSAodmFsKSA9PiB7DQogICAgcmV0dXJuIChpc09iamVjdCh2YWwpIHx8IGlzRnVuY3Rpb24odmFsKSkgJiYgaXNGdW5jdGlvbih2YWwudGhlbikgJiYgaXNGdW5jdGlvbih2YWwuY2F0Y2gpOw0KICB9Ow0KICBjb25zdCBvYmplY3RUb1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7DQogIGNvbnN0IHRvVHlwZVN0cmluZyA9ICh2YWx1ZSkgPT4gb2JqZWN0VG9TdHJpbmcuY2FsbCh2YWx1ZSk7DQogIGNvbnN0IHRvUmF3VHlwZSA9ICh2YWx1ZSkgPT4gew0KICAgIHJldHVybiB0b1R5cGVTdHJpbmcodmFsdWUpLnNsaWNlKDgsIC0xKTsNCiAgfTsNCiAgY29uc3QgaXNQbGFpbk9iamVjdCA9ICh2YWwpID0+IHRvVHlwZVN0cmluZyh2YWwpID09PSAiW29iamVjdCBPYmplY3RdIjsNCiAgY29uc3QgaXNJbnRlZ2VyS2V5ID0gKGtleSkgPT4gaXNTdHJpbmcoa2V5KSAmJiBrZXkgIT09ICJOYU4iICYmIGtleVswXSAhPT0gIi0iICYmICIiICsgcGFyc2VJbnQoa2V5LCAxMCkgPT09IGtleTsNCiAgY29uc3QgaXNSZXNlcnZlZFByb3AgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcCgNCiAgICAvLyB0aGUgbGVhZGluZyBjb21tYSBpcyBpbnRlbnRpb25hbCBzbyBlbXB0eSBzdHJpbmcgIiIgaXMgYWxzbyBpbmNsdWRlZA0KICAgICIsa2V5LHJlZixyZWZfZm9yLHJlZl9rZXksb25Wbm9kZUJlZm9yZU1vdW50LG9uVm5vZGVNb3VudGVkLG9uVm5vZGVCZWZvcmVVcGRhdGUsb25Wbm9kZVVwZGF0ZWQsb25Wbm9kZUJlZm9yZVVubW91bnQsb25Wbm9kZVVubW91bnRlZCINCiAgKTsNCiAgY29uc3QgaXNCdWlsdEluRGlyZWN0aXZlID0gLyogQF9fUFVSRV9fICovIG1ha2VNYXAoDQogICAgImJpbmQsY2xvYWssZWxzZS1pZixlbHNlLGZvcixodG1sLGlmLG1vZGVsLG9uLG9uY2UscHJlLHNob3csc2xvdCx0ZXh0LG1lbW8iDQogICk7DQogIGNvbnN0IGNhY2hlU3RyaW5nRnVuY3Rpb24gPSAoZm4pID0+IHsNCiAgICBjb25zdCBjYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOw0KICAgIHJldHVybiAoc3RyKSA9PiB7DQogICAgICBjb25zdCBoaXQgPSBjYWNoZVtzdHJdOw0KICAgICAgcmV0dXJuIGhpdCB8fCAoY2FjaGVbc3RyXSA9IGZuKHN0cikpOw0KICAgIH07DQogIH07DQogIGNvbnN0IGNhbWVsaXplUkUgPSAvLShcdykvZzsNCiAgY29uc3QgY2FtZWxpemUgPSBjYWNoZVN0cmluZ0Z1bmN0aW9uKA0KICAgIChzdHIpID0+IHsNCiAgICAgIHJldHVybiBzdHIucmVwbGFjZShjYW1lbGl6ZVJFLCAoXywgYykgPT4gYyA/IGMudG9VcHBlckNhc2UoKSA6ICIiKTsNCiAgICB9DQogICk7DQogIGNvbnN0IGh5cGhlbmF0ZVJFID0gL1xCKFtBLVpdKS9nOw0KICBjb25zdCBoeXBoZW5hdGUgPSBjYWNoZVN0cmluZ0Z1bmN0aW9uKA0KICAgIChzdHIpID0+IHN0ci5yZXBsYWNlKGh5cGhlbmF0ZVJFLCAiLSQxIikudG9Mb3dlckNhc2UoKQ0KICApOw0KICBjb25zdCBjYXBpdGFsaXplID0gY2FjaGVTdHJpbmdGdW5jdGlvbigoc3RyKSA9PiB7DQogICAgcmV0dXJuIHN0ci5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHN0ci5zbGljZSgxKTsNCiAgfSk7DQogIGNvbnN0IHRvSGFuZGxlcktleSA9IGNhY2hlU3RyaW5nRnVuY3Rpb24oDQogICAgKHN0cikgPT4gew0KICAgICAgY29uc3QgcyA9IHN0ciA/IGBvbiR7Y2FwaXRhbGl6ZShzdHIpfWAgOiBgYDsNCiAgICAgIHJldHVybiBzOw0KICAgIH0NCiAgKTsNCiAgY29uc3QgaGFzQ2hhbmdlZCA9ICh2YWx1ZSwgb2xkVmFsdWUpID0+ICFPYmplY3QuaXModmFsdWUsIG9sZFZhbHVlKTsNCiAgY29uc3QgaW52b2tlQXJyYXlGbnMgPSAoZm5zLCAuLi5hcmcpID0+IHsNCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZucy5sZW5ndGg7IGkrKykgew0KICAgICAgZm5zW2ldKC4uLmFyZyk7DQogICAgfQ0KICB9Ow0KICBjb25zdCBkZWYgPSAob2JqLCBrZXksIHZhbHVlLCB3cml0YWJsZSA9IGZhbHNlKSA9PiB7DQogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7DQogICAgICBjb25maWd1cmFibGU6IHRydWUsDQogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwNCiAgICAgIHdyaXRhYmxlLA0KICAgICAgdmFsdWUNCiAgICB9KTsNCiAgfTsNCiAgY29uc3QgbG9vc2VUb051bWJlciA9ICh2YWwpID0+IHsNCiAgICBjb25zdCBuID0gcGFyc2VGbG9hdCh2YWwpOw0KICAgIHJldHVybiBpc05hTihuKSA/IHZhbCA6IG47DQogIH07DQogIGNvbnN0IHRvTnVtYmVyID0gKHZhbCkgPT4gew0KICAgIGNvbnN0IG4gPSBpc1N0cmluZyh2YWwpID8gTnVtYmVyKHZhbCkgOiBOYU47DQogICAgcmV0dXJuIGlzTmFOKG4pID8gdmFsIDogbjsNCiAgfTsNCiAgbGV0IF9nbG9iYWxUaGlzOw0KICBjb25zdCBnZXRHbG9iYWxUaGlzID0gKCkgPT4gew0KICAgIHJldHVybiBfZ2xvYmFsVGhpcyB8fCAoX2dsb2JhbFRoaXMgPSB0eXBlb2YgZ2xvYmFsVGhpcyAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWxUaGlzIDogdHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDogdHlwZW9mIGdsb2JhbCAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWwgOiB7fSk7DQogIH07DQogIGZ1bmN0aW9uIGdlbkNhY2hlS2V5KHNvdXJjZSwgb3B0aW9ucykgew0KICAgIHJldHVybiBzb3VyY2UgKyBKU09OLnN0cmluZ2lmeSgNCiAgICAgIG9wdGlvbnMsDQogICAgICAoXywgdmFsKSA9PiB0eXBlb2YgdmFsID09PSAiZnVuY3Rpb24iID8gdmFsLnRvU3RyaW5nKCkgOiB2YWwNCiAgICApOw0KICB9DQoNCiAgY29uc3QgUGF0Y2hGbGFnTmFtZXMgPSB7DQogICAgWzFdOiBgVEVYVGAsDQogICAgWzJdOiBgQ0xBU1NgLA0KICAgIFs0XTogYFNUWUxFYCwNCiAgICBbOF06IGBQUk9QU2AsDQogICAgWzE2XTogYEZVTExfUFJPUFNgLA0KICAgIFszMl06IGBORUVEX0hZRFJBVElPTmAsDQogICAgWzY0XTogYFNUQUJMRV9GUkFHTUVOVGAsDQogICAgWzEyOF06IGBLRVlFRF9GUkFHTUVOVGAsDQogICAgWzI1Nl06IGBVTktFWUVEX0ZSQUdNRU5UYCwNCiAgICBbNTEyXTogYE5FRURfUEFUQ0hgLA0KICAgIFsxMDI0XTogYERZTkFNSUNfU0xPVFNgLA0KICAgIFsyMDQ4XTogYERFVl9ST09UX0ZSQUdNRU5UYCwNCiAgICBbLTFdOiBgQ0FDSEVEYCwNCiAgICBbLTJdOiBgQkFJTGANCiAgfTsNCg0KICBjb25zdCBzbG90RmxhZ3NUZXh0ID0gew0KICAgIFsxXTogIlNUQUJMRSIsDQogICAgWzJdOiAiRFlOQU1JQyIsDQogICAgWzNdOiAiRk9SV0FSREVEIg0KICB9Ow0KDQogIGNvbnN0IEdMT0JBTFNfQUxMT1dFRCA9ICJJbmZpbml0eSx1bmRlZmluZWQsTmFOLGlzRmluaXRlLGlzTmFOLHBhcnNlRmxvYXQscGFyc2VJbnQsZGVjb2RlVVJJLGRlY29kZVVSSUNvbXBvbmVudCxlbmNvZGVVUkksZW5jb2RlVVJJQ29tcG9uZW50LE1hdGgsTnVtYmVyLERhdGUsQXJyYXksT2JqZWN0LEJvb2xlYW4sU3RyaW5nLFJlZ0V4cCxNYXAsU2V0LEpTT04sSW50bCxCaWdJbnQsY29uc29sZSxFcnJvcixTeW1ib2wiOw0KICBjb25zdCBpc0dsb2JhbGx5QWxsb3dlZCA9IC8qIEBfX1BVUkVfXyAqLyBtYWtlTWFwKEdMT0JBTFNfQUxMT1dFRCk7DQoNCiAgY29uc3QgcmFuZ2UgPSAyOw0KICBmdW5jdGlvbiBnZW5lcmF0ZUNvZGVGcmFtZShzb3VyY2UsIHN0YXJ0ID0gMCwgZW5kID0gc291cmNlLmxlbmd0aCkgew0KICAgIHN0YXJ0ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oc3RhcnQsIHNvdXJjZS5sZW5ndGgpKTsNCiAgICBlbmQgPSBNYXRoLm1heCgwLCBNYXRoLm1pbihlbmQsIHNvdXJjZS5sZW5ndGgpKTsNCiAgICBpZiAoc3RhcnQgPiBlbmQpIHJldHVybiAiIjsNCiAgICBsZXQgbGluZXMgPSBzb3VyY2Uuc3BsaXQoLyhccj9cbikvKTsNCiAgICBjb25zdCBuZXdsaW5lU2VxdWVuY2VzID0gbGluZXMuZmlsdGVyKChfLCBpZHgpID0+IGlkeCAlIDIgPT09IDEpOw0KICAgIGxpbmVzID0gbGluZXMuZmlsdGVyKChfLCBpZHgpID0+IGlkeCAlIDIgPT09IDApOw0KICAgIGxldCBjb3VudCA9IDA7DQogICAgY29uc3QgcmVzID0gW107DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykgew0KICAgICAgY291bnQgKz0gbGluZXNbaV0ubGVuZ3RoICsgKG5ld2xpbmVTZXF1ZW5jZXNbaV0gJiYgbmV3bGluZVNlcXVlbmNlc1tpXS5sZW5ndGggfHwgMCk7DQogICAgICBpZiAoY291bnQgPj0gc3RhcnQpIHsNCiAgICAgICAgZm9yIChsZXQgaiA9IGkgLSByYW5nZTsgaiA8PSBpICsgcmFuZ2UgfHwgZW5kID4gY291bnQ7IGorKykgew0KICAgICAgICAgIGlmIChqIDwgMCB8fCBqID49IGxpbmVzLmxlbmd0aCkgY29udGludWU7DQogICAgICAgICAgY29uc3QgbGluZSA9IGogKyAxOw0KICAgICAgICAgIHJlcy5wdXNoKA0KICAgICAgICAgICAgYCR7bGluZX0keyIgIi5yZXBlYXQoTWF0aC5tYXgoMyAtIFN0cmluZyhsaW5lKS5sZW5ndGgsIDApKX18ICAke2xpbmVzW2pdfWANCiAgICAgICAgICApOw0KICAgICAgICAgIGNvbnN0IGxpbmVMZW5ndGggPSBsaW5lc1tqXS5sZW5ndGg7DQogICAgICAgICAgY29uc3QgbmV3TGluZVNlcUxlbmd0aCA9IG5ld2xpbmVTZXF1ZW5jZXNbal0gJiYgbmV3bGluZVNlcXVlbmNlc1tqXS5sZW5ndGggfHwgMDsNCiAgICAgICAgICBpZiAoaiA9PT0gaSkgew0KICAgICAgICAgICAgY29uc3QgcGFkID0gc3RhcnQgLSAoY291bnQgLSAobGluZUxlbmd0aCArIG5ld0xpbmVTZXFMZW5ndGgpKTsNCiAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IE1hdGgubWF4KA0KICAgICAgICAgICAgICAxLA0KICAgICAgICAgICAgICBlbmQgPiBjb3VudCA/IGxpbmVMZW5ndGggLSBwYWQgOiBlbmQgLSBzdGFydA0KICAgICAgICAgICAgKTsNCiAgICAgICAgICAgIHJlcy5wdXNoKGAgICB8ICBgICsgIiAiLnJlcGVhdChwYWQpICsgIl4iLnJlcGVhdChsZW5ndGgpKTsNCiAgICAgICAgICB9IGVsc2UgaWYgKGogPiBpKSB7DQogICAgICAgICAgICBpZiAoZW5kID4gY291bnQpIHsNCiAgICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gTWF0aC5tYXgoTWF0aC5taW4oZW5kIC0gY291bnQsIGxpbmVMZW5ndGgpLCAxKTsNCiAgICAgICAgICAgICAgcmVzLnB1c2goYCAgIHwgIGAgKyAiXiIucmVwZWF0KGxlbmd0aCkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY291bnQgKz0gbGluZUxlbmd0aCArIG5ld0xpbmVTZXFMZW5ndGg7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGJyZWFrOw0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gcmVzLmpvaW4oIlxuIik7DQogIH0NCg0KICBmdW5jdGlvbiBub3JtYWxpemVTdHlsZSh2YWx1ZSkgew0KICAgIGlmIChpc0FycmF5KHZhbHVlKSkgew0KICAgICAgY29uc3QgcmVzID0ge307DQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGNvbnN0IGl0ZW0gPSB2YWx1ZVtpXTsNCiAgICAgICAgY29uc3Qgbm9ybWFsaXplZCA9IGlzU3RyaW5nKGl0ZW0pID8gcGFyc2VTdHJpbmdTdHlsZShpdGVtKSA6IG5vcm1hbGl6ZVN0eWxlKGl0ZW0pOw0KICAgICAgICBpZiAobm9ybWFsaXplZCkgew0KICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIG5vcm1hbGl6ZWQpIHsNCiAgICAgICAgICAgIHJlc1trZXldID0gbm9ybWFsaXplZFtrZXldOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcmV0dXJuIHJlczsNCiAgICB9IGVsc2UgaWYgKGlzU3RyaW5nKHZhbHVlKSB8fCBpc09iamVjdCh2YWx1ZSkpIHsNCiAgICAgIHJldHVybiB2YWx1ZTsNCiAgICB9DQogIH0NCiAgY29uc3QgbGlzdERlbGltaXRlclJFID0gLzsoPyFbXihdKlwpKS9nOw0KICBjb25zdCBwcm9wZXJ0eURlbGltaXRlclJFID0gLzooW15dKykvOw0KICBjb25zdCBzdHlsZUNvbW1lbnRSRSA9IC9cL1wqW15dKj9cKlwvL2c7DQogIGZ1bmN0aW9uIHBhcnNlU3RyaW5nU3R5bGUoY3NzVGV4dCkgew0KICAgIGNvbnN0IHJldCA9IHt9Ow0KICAgIGNzc1RleHQucmVwbGFjZShzdHlsZUNvbW1lbnRSRSwgIiIpLnNwbGl0KGxpc3REZWxpbWl0ZXJSRSkuZm9yRWFjaCgoaXRlbSkgPT4gew0KICAgICAgaWYgKGl0ZW0pIHsNCiAgICAgICAgY29uc3QgdG1wID0gaXRlbS5zcGxpdChwcm9wZXJ0eURlbGltaXRlclJFKTsNCiAgICAgICAgdG1wLmxlbmd0aCA+IDEgJiYgKHJldFt0bXBbMF0udHJpbSgpXSA9IHRtcFsxXS50cmltKCkpOw0KICAgICAgfQ0KICAgIH0pOw0KICAgIHJldHVybiByZXQ7DQogIH0NCiAgZnVuY3Rpb24gc3RyaW5naWZ5U3R5bGUoc3R5bGVzKSB7DQogICAgaWYgKCFzdHlsZXMpIHJldHVybiAiIjsNCiAgICBpZiAoaXNTdHJpbmcoc3R5bGVzKSkgcmV0dXJuIHN0eWxlczsNCiAgICBsZXQgcmV0ID0gIiI7DQogICAgZm9yIChjb25zdCBrZXkgaW4gc3R5bGVzKSB7DQogICAgICBjb25zdCB2YWx1ZSA9IHN0eWxlc1trZXldOw0KICAgICAgaWYgKGlzU3RyaW5nKHZhbHVlKSB8fCB0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7DQogICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRLZXkgPSBrZXkuc3RhcnRzV2l0aChgLS1gKSA/IGtleSA6IGh5cGhlbmF0ZShrZXkpOw0KICAgICAgICByZXQgKz0gYCR7bm9ybWFsaXplZEtleX06JHt2YWx1ZX07YDsNCiAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHJldDsNCiAgfQ0KICBmdW5jdGlvbiBub3JtYWxpemVDbGFzcyh2YWx1ZSkgew0KICAgIGxldCByZXMgPSAiIjsNCiAgICBpZiAoaXNTdHJpbmcodmFsdWUpKSB7DQogICAgICByZXMgPSB2YWx1ZTsNCiAgICB9IGVsc2UgaWYgKGlzQXJyYXkodmFsdWUpKSB7DQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGNvbnN0IG5vcm1hbGl6ZWQgPSBub3JtYWxpemVDbGFzcyh2YWx1ZVtpXSk7DQogICAgICAgIGlmIChub3JtYWxpemVkKSB7DQogICAgICAgICAgcmVzICs9IG5vcm1hbGl6ZWQgKyAiICI7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHZhbHVlKSkgew0KICAgICAgZm9yIChjb25zdCBuYW1lIGluIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZVtuYW1lXSkgew0KICAgICAgICAgIHJlcyArPSBuYW1lICsgIiAiOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiByZXMudHJpbSgpOw0KICB9DQogIGZ1bmN0aW9uIG5vcm1hbGl6ZVByb3BzKHByb3BzKSB7DQogICAgaWYgKCFwcm9wcykgcmV0dXJuIG51bGw7DQogICAgbGV0IHsgY2xhc3M6IGtsYXNzLCBzdHlsZSB9ID0gcHJvcHM7DQogICAgaWYgKGtsYXNzICYmICFpc1N0cmluZyhrbGFzcykpIHsNCiAgICAgIHByb3BzLmNsYXNzID0gbm9ybWFsaXplQ2xhc3Moa2xhc3MpOw0KICAgIH0NCiAgICBpZiAoc3R5bGUpIHsNCiAgICAgIHByb3BzLnN0eWxlID0gbm9ybWFsaXplU3R5bGUoc3R5bGUpOw0KICAgIH0NCiAgICByZXR1cm4gcHJvcHM7DQogIH0NCg0KICBjb25zdCBIVE1MX1RBR1MgPSAiaHRtbCxib2R5LGJhc2UsaGVhZCxsaW5rLG1ldGEsc3R5bGUsdGl0bGUsYWRkcmVzcyxhcnRpY2xlLGFzaWRlLGZvb3RlcixoZWFkZXIsaGdyb3VwLGgxLGgyLGgzLGg0LGg1LGg2LG5hdixzZWN0aW9uLGRpdixkZCxkbCxkdCxmaWdjYXB0aW9uLGZpZ3VyZSxwaWN0dXJlLGhyLGltZyxsaSxtYWluLG9sLHAscHJlLHVsLGEsYixhYmJyLGJkaSxiZG8sYnIsY2l0ZSxjb2RlLGRhdGEsZGZuLGVtLGksa2JkLG1hcmsscSxycCxydCxydWJ5LHMsc2FtcCxzbWFsbCxzcGFuLHN0cm9uZyxzdWIsc3VwLHRpbWUsdSx2YXIsd2JyLGFyZWEsYXVkaW8sbWFwLHRyYWNrLHZpZGVvLGVtYmVkLG9iamVjdCxwYXJhbSxzb3VyY2UsY2FudmFzLHNjcmlwdCxub3NjcmlwdCxkZWwsaW5zLGNhcHRpb24sY29sLGNvbGdyb3VwLHRhYmxlLHRoZWFkLHRib2R5LHRkLHRoLHRyLGJ1dHRvbixkYXRhbGlzdCxmaWVsZHNldCxmb3JtLGlucHV0LGxhYmVsLGxlZ2VuZCxtZXRlcixvcHRncm91cCxvcHRpb24sb3V0cHV0LHByb2dyZXNzLHNlbGVjdCx0ZXh0YXJlYSxkZXRhaWxzLGRpYWxvZyxtZW51LHN1bW1hcnksdGVtcGxhdGUsYmxvY2txdW90ZSxpZnJhbWUsdGZvb3QiOw0KICBjb25zdCBTVkdfVEFHUyA9ICJzdmcsYW5pbWF0ZSxhbmltYXRlTW90aW9uLGFuaW1hdGVUcmFuc2Zvcm0sY2lyY2xlLGNsaXBQYXRoLGNvbG9yLXByb2ZpbGUsZGVmcyxkZXNjLGRpc2NhcmQsZWxsaXBzZSxmZUJsZW5kLGZlQ29sb3JNYXRyaXgsZmVDb21wb25lbnRUcmFuc2ZlcixmZUNvbXBvc2l0ZSxmZUNvbnZvbHZlTWF0cml4LGZlRGlmZnVzZUxpZ2h0aW5nLGZlRGlzcGxhY2VtZW50TWFwLGZlRGlzdGFudExpZ2h0LGZlRHJvcFNoYWRvdyxmZUZsb29kLGZlRnVuY0EsZmVGdW5jQixmZUZ1bmNHLGZlRnVuY1IsZmVHYXVzc2lhbkJsdXIsZmVJbWFnZSxmZU1lcmdlLGZlTWVyZ2VOb2RlLGZlTW9ycGhvbG9neSxmZU9mZnNldCxmZVBvaW50TGlnaHQsZmVTcGVjdWxhckxpZ2h0aW5nLGZlU3BvdExpZ2h0LGZlVGlsZSxmZVR1cmJ1bGVuY2UsZmlsdGVyLGZvcmVpZ25PYmplY3QsZyxoYXRjaCxoYXRjaHBhdGgsaW1hZ2UsbGluZSxsaW5lYXJHcmFkaWVudCxtYXJrZXIsbWFzayxtZXNoLG1lc2hncmFkaWVudCxtZXNocGF0Y2gsbWVzaHJvdyxtZXRhZGF0YSxtcGF0aCxwYXRoLHBhdHRlcm4scG9seWdvbixwb2x5bGluZSxyYWRpYWxHcmFkaWVudCxyZWN0LHNldCxzb2xpZGNvbG9yLHN0b3Asc3dpdGNoLHN5bWJvbCx0ZXh0LHRleHRQYXRoLHRpdGxlLHRzcGFuLHVua25vd24sdXNlLHZpZXciOw0KICBjb25zdCBNQVRIX1RBR1MgPSAiYW5ub3RhdGlvbixhbm5vdGF0aW9uLXhtbCxtYWN0aW9uLG1hbGlnbmdyb3VwLG1hbGlnbm1hcmssbWF0aCxtZW5jbG9zZSxtZXJyb3IsbWZlbmNlZCxtZnJhYyxtZnJhY3Rpb24sbWdseXBoLG1pLG1sYWJlbGVkdHIsbWxvbmdkaXYsbW11bHRpc2NyaXB0cyxtbixtbyxtb3ZlcixtcGFkZGVkLG1waGFudG9tLG1wcmVzY3JpcHRzLG1yb290LG1yb3csbXMsbXNjYXJyaWVzLG1zY2FycnksbXNncm91cCxtc2xpbmUsbXNwYWNlLG1zcXJ0LG1zcm93LG1zdGFjayxtc3R5bGUsbXN1Yixtc3Vic3VwLG1zdXAsbXRhYmxlLG10ZCxtdGV4dCxtdHIsbXVuZGVyLG11bmRlcm92ZXIsbm9uZSxzZW1hbnRpY3MiOw0KICBjb25zdCBWT0lEX1RBR1MgPSAiYXJlYSxiYXNlLGJyLGNvbCxlbWJlZCxocixpbWcsaW5wdXQsbGluayxtZXRhLHBhcmFtLHNvdXJjZSx0cmFjayx3YnIiOw0KICBjb25zdCBpc0hUTUxUYWcgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcChIVE1MX1RBR1MpOw0KICBjb25zdCBpc1NWR1RhZyA9IC8qIEBfX1BVUkVfXyAqLyBtYWtlTWFwKFNWR19UQUdTKTsNCiAgY29uc3QgaXNNYXRoTUxUYWcgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcChNQVRIX1RBR1MpOw0KICBjb25zdCBpc1ZvaWRUYWcgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcChWT0lEX1RBR1MpOw0KDQogIGNvbnN0IHNwZWNpYWxCb29sZWFuQXR0cnMgPSBgaXRlbXNjb3BlLGFsbG93ZnVsbHNjcmVlbixmb3Jtbm92YWxpZGF0ZSxpc21hcCxub21vZHVsZSxub3ZhbGlkYXRlLHJlYWRvbmx5YDsNCiAgY29uc3QgaXNTcGVjaWFsQm9vbGVhbkF0dHIgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcChzcGVjaWFsQm9vbGVhbkF0dHJzKTsNCiAgY29uc3QgaXNCb29sZWFuQXR0ciA9IC8qIEBfX1BVUkVfXyAqLyBtYWtlTWFwKA0KICAgIHNwZWNpYWxCb29sZWFuQXR0cnMgKyBgLGFzeW5jLGF1dG9mb2N1cyxhdXRvcGxheSxjb250cm9scyxkZWZhdWx0LGRlZmVyLGRpc2FibGVkLGhpZGRlbixpbmVydCxsb29wLG9wZW4scmVxdWlyZWQscmV2ZXJzZWQsc2NvcGVkLHNlYW1sZXNzLGNoZWNrZWQsbXV0ZWQsbXVsdGlwbGUsc2VsZWN0ZWRgDQogICk7DQogIGZ1bmN0aW9uIGluY2x1ZGVCb29sZWFuQXR0cih2YWx1ZSkgew0KICAgIHJldHVybiAhIXZhbHVlIHx8IHZhbHVlID09PSAiIjsNCiAgfQ0KICBjb25zdCBpc0tub3duSHRtbEF0dHIgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcCgNCiAgICBgYWNjZXB0LGFjY2VwdC1jaGFyc2V0LGFjY2Vzc2tleSxhY3Rpb24sYWxpZ24sYWxsb3csYWx0LGFzeW5jLGF1dG9jYXBpdGFsaXplLGF1dG9jb21wbGV0ZSxhdXRvZm9jdXMsYXV0b3BsYXksYmFja2dyb3VuZCxiZ2NvbG9yLGJvcmRlcixidWZmZXJlZCxjYXB0dXJlLGNoYWxsZW5nZSxjaGFyc2V0LGNoZWNrZWQsY2l0ZSxjbGFzcyxjb2RlLGNvZGViYXNlLGNvbG9yLGNvbHMsY29sc3Bhbixjb250ZW50LGNvbnRlbnRlZGl0YWJsZSxjb250ZXh0bWVudSxjb250cm9scyxjb29yZHMsY3Jvc3NvcmlnaW4sY3NwLGRhdGEsZGF0ZXRpbWUsZGVjb2RpbmcsZGVmYXVsdCxkZWZlcixkaXIsZGlybmFtZSxkaXNhYmxlZCxkb3dubG9hZCxkcmFnZ2FibGUsZHJvcHpvbmUsZW5jdHlwZSxlbnRlcmtleWhpbnQsZm9yLGZvcm0sZm9ybWFjdGlvbixmb3JtZW5jdHlwZSxmb3JtbWV0aG9kLGZvcm1ub3ZhbGlkYXRlLGZvcm10YXJnZXQsaGVhZGVycyxoZWlnaHQsaGlkZGVuLGhpZ2gsaHJlZixocmVmbGFuZyxodHRwLWVxdWl2LGljb24saWQsaW1wb3J0YW5jZSxpbmVydCxpbnRlZ3JpdHksaXNtYXAsaXRlbXByb3Asa2V5dHlwZSxraW5kLGxhYmVsLGxhbmcsbGFuZ3VhZ2UsbG9hZGluZyxsaXN0LGxvb3AsbG93LG1hbmlmZXN0LG1heCxtYXhsZW5ndGgsbWlubGVuZ3RoLG1lZGlhLG1pbixtdWx0aXBsZSxtdXRlZCxuYW1lLG5vdmFsaWRhdGUsb3BlbixvcHRpbXVtLHBhdHRlcm4scGluZyxwbGFjZWhvbGRlcixwb3N0ZXIscHJlbG9hZCxyYWRpb2dyb3VwLHJlYWRvbmx5LHJlZmVycmVycG9saWN5LHJlbCxyZXF1aXJlZCxyZXZlcnNlZCxyb3dzLHJvd3NwYW4sc2FuZGJveCxzY29wZSxzY29wZWQsc2VsZWN0ZWQsc2hhcGUsc2l6ZSxzaXplcyxzbG90LHNwYW4sc3BlbGxjaGVjayxzcmMsc3JjZG9jLHNyY2xhbmcsc3Jjc2V0LHN0YXJ0LHN0ZXAsc3R5bGUsc3VtbWFyeSx0YWJpbmRleCx0YXJnZXQsdGl0bGUsdHJhbnNsYXRlLHR5cGUsdXNlbWFwLHZhbHVlLHdpZHRoLHdyYXBgDQogICk7DQogIGNvbnN0IGlzS25vd25TdmdBdHRyID0gLyogQF9fUFVSRV9fICovIG1ha2VNYXAoDQogICAgYHhtbG5zLGFjY2VudC1oZWlnaHQsYWNjdW11bGF0ZSxhZGRpdGl2ZSxhbGlnbm1lbnQtYmFzZWxpbmUsYWxwaGFiZXRpYyxhbXBsaXR1ZGUsYXJhYmljLWZvcm0sYXNjZW50LGF0dHJpYnV0ZU5hbWUsYXR0cmlidXRlVHlwZSxhemltdXRoLGJhc2VGcmVxdWVuY3ksYmFzZWxpbmUtc2hpZnQsYmFzZVByb2ZpbGUsYmJveCxiZWdpbixiaWFzLGJ5LGNhbGNNb2RlLGNhcC1oZWlnaHQsY2xhc3MsY2xpcCxjbGlwUGF0aFVuaXRzLGNsaXAtcGF0aCxjbGlwLXJ1bGUsY29sb3IsY29sb3ItaW50ZXJwb2xhdGlvbixjb2xvci1pbnRlcnBvbGF0aW9uLWZpbHRlcnMsY29sb3ItcHJvZmlsZSxjb2xvci1yZW5kZXJpbmcsY29udGVudFNjcmlwdFR5cGUsY29udGVudFN0eWxlVHlwZSxjcm9zc29yaWdpbixjdXJzb3IsY3gsY3ksZCxkZWNlbGVyYXRlLGRlc2NlbnQsZGlmZnVzZUNvbnN0YW50LGRpcmVjdGlvbixkaXNwbGF5LGRpdmlzb3IsZG9taW5hbnQtYmFzZWxpbmUsZHVyLGR4LGR5LGVkZ2VNb2RlLGVsZXZhdGlvbixlbmFibGUtYmFja2dyb3VuZCxlbmQsZXhwb25lbnQsZmlsbCxmaWxsLW9wYWNpdHksZmlsbC1ydWxlLGZpbHRlcixmaWx0ZXJSZXMsZmlsdGVyVW5pdHMsZmxvb2QtY29sb3IsZmxvb2Qtb3BhY2l0eSxmb250LWZhbWlseSxmb250LXNpemUsZm9udC1zaXplLWFkanVzdCxmb250LXN0cmV0Y2gsZm9udC1zdHlsZSxmb250LXZhcmlhbnQsZm9udC13ZWlnaHQsZm9ybWF0LGZyb20sZnIsZngsZnksZzEsZzIsZ2x5cGgtbmFtZSxnbHlwaC1vcmllbnRhdGlvbi1ob3Jpem9udGFsLGdseXBoLW9yaWVudGF0aW9uLXZlcnRpY2FsLGdseXBoUmVmLGdyYWRpZW50VHJhbnNmb3JtLGdyYWRpZW50VW5pdHMsaGFuZ2luZyxoZWlnaHQsaHJlZixocmVmbGFuZyxob3Jpei1hZHYteCxob3Jpei1vcmlnaW4teCxpZCxpZGVvZ3JhcGhpYyxpbWFnZS1yZW5kZXJpbmcsaW4saW4yLGludGVyY2VwdCxrLGsxLGsyLGszLGs0LGtlcm5lbE1hdHJpeCxrZXJuZWxVbml0TGVuZ3RoLGtlcm5pbmcsa2V5UG9pbnRzLGtleVNwbGluZXMsa2V5VGltZXMsbGFuZyxsZW5ndGhBZGp1c3QsbGV0dGVyLXNwYWNpbmcsbGlnaHRpbmctY29sb3IsbGltaXRpbmdDb25lQW5nbGUsbG9jYWwsbWFya2VyLWVuZCxtYXJrZXItbWlkLG1hcmtlci1zdGFydCxtYXJrZXJIZWlnaHQsbWFya2VyVW5pdHMsbWFya2VyV2lkdGgsbWFzayxtYXNrQ29udGVudFVuaXRzLG1hc2tVbml0cyxtYXRoZW1hdGljYWwsbWF4LG1lZGlhLG1ldGhvZCxtaW4sbW9kZSxuYW1lLG51bU9jdGF2ZXMsb2Zmc2V0LG9wYWNpdHksb3BlcmF0b3Isb3JkZXIsb3JpZW50LG9yaWVudGF0aW9uLG9yaWdpbixvdmVyZmxvdyxvdmVybGluZS1wb3NpdGlvbixvdmVybGluZS10aGlja25lc3MscGFub3NlLTEscGFpbnQtb3JkZXIscGF0aCxwYXRoTGVuZ3RoLHBhdHRlcm5Db250ZW50VW5pdHMscGF0dGVyblRyYW5zZm9ybSxwYXR0ZXJuVW5pdHMscGluZyxwb2ludGVyLWV2ZW50cyxwb2ludHMscG9pbnRzQXRYLHBvaW50c0F0WSxwb2ludHNBdFoscHJlc2VydmVBbHBoYSxwcmVzZXJ2ZUFzcGVjdFJhdGlvLHByaW1pdGl2ZVVuaXRzLHIscmFkaXVzLHJlZmVycmVyUG9saWN5LHJlZlgscmVmWSxyZWwscmVuZGVyaW5nLWludGVudCxyZXBlYXRDb3VudCxyZXBlYXREdXIscmVxdWlyZWRFeHRlbnNpb25zLHJlcXVpcmVkRmVhdHVyZXMscmVzdGFydCxyZXN1bHQscm90YXRlLHJ4LHJ5LHNjYWxlLHNlZWQsc2hhcGUtcmVuZGVyaW5nLHNsb3BlLHNwYWNpbmcsc3BlY3VsYXJDb25zdGFudCxzcGVjdWxhckV4cG9uZW50LHNwZWVkLHNwcmVhZE1ldGhvZCxzdGFydE9mZnNldCxzdGREZXZpYXRpb24sc3RlbWgsc3RlbXYsc3RpdGNoVGlsZXMsc3RvcC1jb2xvcixzdG9wLW9wYWNpdHksc3RyaWtldGhyb3VnaC1wb3NpdGlvbixzdHJpa2V0aHJvdWdoLXRoaWNrbmVzcyxzdHJpbmcsc3Ryb2tlLHN0cm9rZS1kYXNoYXJyYXksc3Ryb2tlLWRhc2hvZmZzZXQsc3Ryb2tlLWxpbmVjYXAsc3Ryb2tlLWxpbmVqb2luLHN0cm9rZS1taXRlcmxpbWl0LHN0cm9rZS1vcGFjaXR5LHN0cm9rZS13aWR0aCxzdHlsZSxzdXJmYWNlU2NhbGUsc3lzdGVtTGFuZ3VhZ2UsdGFiaW5kZXgsdGFibGVWYWx1ZXMsdGFyZ2V0LHRhcmdldFgsdGFyZ2V0WSx0ZXh0LWFuY2hvcix0ZXh0LWRlY29yYXRpb24sdGV4dC1yZW5kZXJpbmcsdGV4dExlbmd0aCx0byx0cmFuc2Zvcm0sdHJhbnNmb3JtLW9yaWdpbix0eXBlLHUxLHUyLHVuZGVybGluZS1wb3NpdGlvbix1bmRlcmxpbmUtdGhpY2tuZXNzLHVuaWNvZGUsdW5pY29kZS1iaWRpLHVuaWNvZGUtcmFuZ2UsdW5pdHMtcGVyLWVtLHYtYWxwaGFiZXRpYyx2LWhhbmdpbmcsdi1pZGVvZ3JhcGhpYyx2LW1hdGhlbWF0aWNhbCx2YWx1ZXMsdmVjdG9yLWVmZmVjdCx2ZXJzaW9uLHZlcnQtYWR2LXksdmVydC1vcmlnaW4teCx2ZXJ0LW9yaWdpbi15LHZpZXdCb3gsdmlld1RhcmdldCx2aXNpYmlsaXR5LHdpZHRoLHdpZHRocyx3b3JkLXNwYWNpbmcsd3JpdGluZy1tb2RlLHgseC1oZWlnaHQseDEseDIseENoYW5uZWxTZWxlY3Rvcix4bGluazphY3R1YXRlLHhsaW5rOmFyY3JvbGUseGxpbms6aHJlZix4bGluazpyb2xlLHhsaW5rOnNob3cseGxpbms6dGl0bGUseGxpbms6dHlwZSx4bWxuczp4bGluayx4bWw6YmFzZSx4bWw6bGFuZyx4bWw6c3BhY2UseSx5MSx5Mix5Q2hhbm5lbFNlbGVjdG9yLHosem9vbUFuZFBhbmANCiAgKTsNCiAgZnVuY3Rpb24gaXNSZW5kZXJhYmxlQXR0clZhbHVlKHZhbHVlKSB7DQogICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQogICAgY29uc3QgdHlwZSA9IHR5cGVvZiB2YWx1ZTsNCiAgICByZXR1cm4gdHlwZSA9PT0gInN0cmluZyIgfHwgdHlwZSA9PT0gIm51bWJlciIgfHwgdHlwZSA9PT0gImJvb2xlYW4iOw0KICB9DQoNCiAgY29uc3QgY3NzVmFyTmFtZUVzY2FwZVN5bWJvbHNSRSA9IC9bICEiIyQlJicoKSorLC4vOjs8PT4/QFtcXFxdXmB7fH1+XS9nOw0KICBmdW5jdGlvbiBnZXRFc2NhcGVkQ3NzVmFyTmFtZShrZXksIGRvdWJsZUVzY2FwZSkgew0KICAgIHJldHVybiBrZXkucmVwbGFjZSgNCiAgICAgIGNzc1Zhck5hbWVFc2NhcGVTeW1ib2xzUkUsDQogICAgICAocykgPT4gYFxcJHtzfWANCiAgICApOw0KICB9DQoNCiAgZnVuY3Rpb24gbG9vc2VDb21wYXJlQXJyYXlzKGEsIGIpIHsNCiAgICBpZiAoYS5sZW5ndGggIT09IGIubGVuZ3RoKSByZXR1cm4gZmFsc2U7DQogICAgbGV0IGVxdWFsID0gdHJ1ZTsNCiAgICBmb3IgKGxldCBpID0gMDsgZXF1YWwgJiYgaSA8IGEubGVuZ3RoOyBpKyspIHsNCiAgICAgIGVxdWFsID0gbG9vc2VFcXVhbChhW2ldLCBiW2ldKTsNCiAgICB9DQogICAgcmV0dXJuIGVxdWFsOw0KICB9DQogIGZ1bmN0aW9uIGxvb3NlRXF1YWwoYSwgYikgew0KICAgIGlmIChhID09PSBiKSByZXR1cm4gdHJ1ZTsNCiAgICBsZXQgYVZhbGlkVHlwZSA9IGlzRGF0ZShhKTsNCiAgICBsZXQgYlZhbGlkVHlwZSA9IGlzRGF0ZShiKTsNCiAgICBpZiAoYVZhbGlkVHlwZSB8fCBiVmFsaWRUeXBlKSB7DQogICAgICByZXR1cm4gYVZhbGlkVHlwZSAmJiBiVmFsaWRUeXBlID8gYS5nZXRUaW1lKCkgPT09IGIuZ2V0VGltZSgpIDogZmFsc2U7DQogICAgfQ0KICAgIGFWYWxpZFR5cGUgPSBpc1N5bWJvbChhKTsNCiAgICBiVmFsaWRUeXBlID0gaXNTeW1ib2woYik7DQogICAgaWYgKGFWYWxpZFR5cGUgfHwgYlZhbGlkVHlwZSkgew0KICAgICAgcmV0dXJuIGEgPT09IGI7DQogICAgfQ0KICAgIGFWYWxpZFR5cGUgPSBpc0FycmF5KGEpOw0KICAgIGJWYWxpZFR5cGUgPSBpc0FycmF5KGIpOw0KICAgIGlmIChhVmFsaWRUeXBlIHx8IGJWYWxpZFR5cGUpIHsNCiAgICAgIHJldHVybiBhVmFsaWRUeXBlICYmIGJWYWxpZFR5cGUgPyBsb29zZUNvbXBhcmVBcnJheXMoYSwgYikgOiBmYWxzZTsNCiAgICB9DQogICAgYVZhbGlkVHlwZSA9IGlzT2JqZWN0KGEpOw0KICAgIGJWYWxpZFR5cGUgPSBpc09iamVjdChiKTsNCiAgICBpZiAoYVZhbGlkVHlwZSB8fCBiVmFsaWRUeXBlKSB7DQogICAgICBpZiAoIWFWYWxpZFR5cGUgfHwgIWJWYWxpZFR5cGUpIHsNCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgfQ0KICAgICAgY29uc3QgYUtleXNDb3VudCA9IE9iamVjdC5rZXlzKGEpLmxlbmd0aDsNCiAgICAgIGNvbnN0IGJLZXlzQ291bnQgPSBPYmplY3Qua2V5cyhiKS5sZW5ndGg7DQogICAgICBpZiAoYUtleXNDb3VudCAhPT0gYktleXNDb3VudCkgew0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICB9DQogICAgICBmb3IgKGNvbnN0IGtleSBpbiBhKSB7DQogICAgICAgIGNvbnN0IGFIYXNLZXkgPSBhLmhhc093blByb3BlcnR5KGtleSk7DQogICAgICAgIGNvbnN0IGJIYXNLZXkgPSBiLmhhc093blByb3BlcnR5KGtleSk7DQogICAgICAgIGlmIChhSGFzS2V5ICYmICFiSGFzS2V5IHx8ICFhSGFzS2V5ICYmIGJIYXNLZXkgfHwgIWxvb3NlRXF1YWwoYVtrZXldLCBiW2tleV0pKSB7DQogICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiBTdHJpbmcoYSkgPT09IFN0cmluZyhiKTsNCiAgfQ0KICBmdW5jdGlvbiBsb29zZUluZGV4T2YoYXJyLCB2YWwpIHsNCiAgICByZXR1cm4gYXJyLmZpbmRJbmRleCgoaXRlbSkgPT4gbG9vc2VFcXVhbChpdGVtLCB2YWwpKTsNCiAgfQ0KDQogIGNvbnN0IGlzUmVmJDEgPSAodmFsKSA9PiB7DQogICAgcmV0dXJuICEhKHZhbCAmJiB2YWxbIl9fdl9pc1JlZiJdID09PSB0cnVlKTsNCiAgfTsNCiAgY29uc3QgdG9EaXNwbGF5U3RyaW5nID0gKHZhbCkgPT4gew0KICAgIHJldHVybiBpc1N0cmluZyh2YWwpID8gdmFsIDogdmFsID09IG51bGwgPyAiIiA6IGlzQXJyYXkodmFsKSB8fCBpc09iamVjdCh2YWwpICYmICh2YWwudG9TdHJpbmcgPT09IG9iamVjdFRvU3RyaW5nIHx8ICFpc0Z1bmN0aW9uKHZhbC50b1N0cmluZykpID8gaXNSZWYkMSh2YWwpID8gdG9EaXNwbGF5U3RyaW5nKHZhbC52YWx1ZSkgOiBKU09OLnN0cmluZ2lmeSh2YWwsIHJlcGxhY2VyLCAyKSA6IFN0cmluZyh2YWwpOw0KICB9Ow0KICBjb25zdCByZXBsYWNlciA9IChfa2V5LCB2YWwpID0+IHsNCiAgICBpZiAoaXNSZWYkMSh2YWwpKSB7DQogICAgICByZXR1cm4gcmVwbGFjZXIoX2tleSwgdmFsLnZhbHVlKTsNCiAgICB9IGVsc2UgaWYgKGlzTWFwKHZhbCkpIHsNCiAgICAgIHJldHVybiB7DQogICAgICAgIFtgTWFwKCR7dmFsLnNpemV9KWBdOiBbLi4udmFsLmVudHJpZXMoKV0ucmVkdWNlKA0KICAgICAgICAgIChlbnRyaWVzLCBba2V5LCB2YWwyXSwgaSkgPT4gew0KICAgICAgICAgICAgZW50cmllc1tzdHJpbmdpZnlTeW1ib2woa2V5LCBpKSArICIgPT4iXSA9IHZhbDI7DQogICAgICAgICAgICByZXR1cm4gZW50cmllczsNCiAgICAgICAgICB9LA0KICAgICAgICAgIHt9DQogICAgICAgICkNCiAgICAgIH07DQogICAgfSBlbHNlIGlmIChpc1NldCh2YWwpKSB7DQogICAgICByZXR1cm4gew0KICAgICAgICBbYFNldCgke3ZhbC5zaXplfSlgXTogWy4uLnZhbC52YWx1ZXMoKV0ubWFwKCh2KSA9PiBzdHJpbmdpZnlTeW1ib2wodikpDQogICAgICB9Ow0KICAgIH0gZWxzZSBpZiAoaXNTeW1ib2wodmFsKSkgew0KICAgICAgcmV0dXJuIHN0cmluZ2lmeVN5bWJvbCh2YWwpOw0KICAgIH0gZWxzZSBpZiAoaXNPYmplY3QodmFsKSAmJiAhaXNBcnJheSh2YWwpICYmICFpc1BsYWluT2JqZWN0KHZhbCkpIHsNCiAgICAgIHJldHVybiBTdHJpbmcodmFsKTsNCiAgICB9DQogICAgcmV0dXJuIHZhbDsNCiAgfTsNCiAgY29uc3Qgc3RyaW5naWZ5U3ltYm9sID0gKHYsIGkgPSAiIikgPT4gew0KICAgIHZhciBfYTsNCiAgICByZXR1cm4gKA0KICAgICAgLy8gU3ltYm9sLmRlc2NyaXB0aW9uIGluIGVzMjAxOSsgc28gd2UgbmVlZCB0byBjYXN0IGhlcmUgdG8gcGFzcw0KICAgICAgLy8gdGhlIGxpYjogZXMyMDE2IGNoZWNrDQogICAgICBpc1N5bWJvbCh2KSA/IGBTeW1ib2woJHsoX2EgPSB2LmRlc2NyaXB0aW9uKSAhPSBudWxsID8gX2EgOiBpfSlgIDogdg0KICAgICk7DQogIH07DQoNCiAgZnVuY3Rpb24gd2FybiQyKG1zZywgLi4uYXJncykgew0KICAgIGNvbnNvbGUud2FybihgW1Z1ZSB3YXJuXSAke21zZ31gLCAuLi5hcmdzKTsNCiAgfQ0KDQogIGxldCBhY3RpdmVFZmZlY3RTY29wZTsNCiAgY2xhc3MgRWZmZWN0U2NvcGUgew0KICAgIGNvbnN0cnVjdG9yKGRldGFjaGVkID0gZmFsc2UpIHsNCiAgICAgIHRoaXMuZGV0YWNoZWQgPSBkZXRhY2hlZDsNCiAgICAgIC8qKg0KICAgICAgICogQGludGVybmFsDQogICAgICAgKi8NCiAgICAgIHRoaXMuX2FjdGl2ZSA9IHRydWU7DQogICAgICAvKioNCiAgICAgICAqIEBpbnRlcm5hbCB0cmFjayBgb25gIGNhbGxzLCBhbGxvdyBgb25gIGNhbGwgbXVsdGlwbGUgdGltZXMNCiAgICAgICAqLw0KICAgICAgdGhpcy5fb24gPSAwOw0KICAgICAgLyoqDQogICAgICAgKiBAaW50ZXJuYWwNCiAgICAgICAqLw0KICAgICAgdGhpcy5lZmZlY3RzID0gW107DQogICAgICAvKioNCiAgICAgICAqIEBpbnRlcm5hbA0KICAgICAgICovDQogICAgICB0aGlzLmNsZWFudXBzID0gW107DQogICAgICB0aGlzLl9pc1BhdXNlZCA9IGZhbHNlOw0KICAgICAgdGhpcy5wYXJlbnQgPSBhY3RpdmVFZmZlY3RTY29wZTsNCiAgICAgIGlmICghZGV0YWNoZWQgJiYgYWN0aXZlRWZmZWN0U2NvcGUpIHsNCiAgICAgICAgdGhpcy5pbmRleCA9IChhY3RpdmVFZmZlY3RTY29wZS5zY29wZXMgfHwgKGFjdGl2ZUVmZmVjdFNjb3BlLnNjb3BlcyA9IFtdKSkucHVzaCgNCiAgICAgICAgICB0aGlzDQogICAgICAgICkgLSAxOw0KICAgICAgfQ0KICAgIH0NCiAgICBnZXQgYWN0aXZlKCkgew0KICAgICAgcmV0dXJuIHRoaXMuX2FjdGl2ZTsNCiAgICB9DQogICAgcGF1c2UoKSB7DQogICAgICBpZiAodGhpcy5fYWN0aXZlKSB7DQogICAgICAgIHRoaXMuX2lzUGF1c2VkID0gdHJ1ZTsNCiAgICAgICAgbGV0IGksIGw7DQogICAgICAgIGlmICh0aGlzLnNjb3Blcykgew0KICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLnNjb3Blcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsNCiAgICAgICAgICAgIHRoaXMuc2NvcGVzW2ldLnBhdXNlKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLmVmZmVjdHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7DQogICAgICAgICAgdGhpcy5lZmZlY3RzW2ldLnBhdXNlKCk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogUmVzdW1lcyB0aGUgZWZmZWN0IHNjb3BlLCBpbmNsdWRpbmcgYWxsIGNoaWxkIHNjb3BlcyBhbmQgZWZmZWN0cy4NCiAgICAgKi8NCiAgICByZXN1bWUoKSB7DQogICAgICBpZiAodGhpcy5fYWN0aXZlKSB7DQogICAgICAgIGlmICh0aGlzLl9pc1BhdXNlZCkgew0KICAgICAgICAgIHRoaXMuX2lzUGF1c2VkID0gZmFsc2U7DQogICAgICAgICAgbGV0IGksIGw7DQogICAgICAgICAgaWYgKHRoaXMuc2NvcGVzKSB7DQogICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5zY29wZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7DQogICAgICAgICAgICAgIHRoaXMuc2NvcGVzW2ldLnJlc3VtZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5lZmZlY3RzLmxlbmd0aDsgaSA8IGw7IGkrKykgew0KICAgICAgICAgICAgdGhpcy5lZmZlY3RzW2ldLnJlc3VtZSgpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICBydW4oZm4pIHsNCiAgICAgIGlmICh0aGlzLl9hY3RpdmUpIHsNCiAgICAgICAgY29uc3QgY3VycmVudEVmZmVjdFNjb3BlID0gYWN0aXZlRWZmZWN0U2NvcGU7DQogICAgICAgIHRyeSB7DQogICAgICAgICAgYWN0aXZlRWZmZWN0U2NvcGUgPSB0aGlzOw0KICAgICAgICAgIHJldHVybiBmbigpOw0KICAgICAgICB9IGZpbmFsbHkgew0KICAgICAgICAgIGFjdGl2ZUVmZmVjdFNjb3BlID0gY3VycmVudEVmZmVjdFNjb3BlOw0KICAgICAgICB9DQogICAgICB9IGVsc2Ugew0KICAgICAgICB3YXJuJDIoYGNhbm5vdCBydW4gYW4gaW5hY3RpdmUgZWZmZWN0IHNjb3BlLmApOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiBUaGlzIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbiBub24tZGV0YWNoZWQgc2NvcGVzDQogICAgICogQGludGVybmFsDQogICAgICovDQogICAgb24oKSB7DQogICAgICBpZiAoKyt0aGlzLl9vbiA9PT0gMSkgew0KICAgICAgICB0aGlzLnByZXZTY29wZSA9IGFjdGl2ZUVmZmVjdFNjb3BlOw0KICAgICAgICBhY3RpdmVFZmZlY3RTY29wZSA9IHRoaXM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIFRoaXMgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uIG5vbi1kZXRhY2hlZCBzY29wZXMNCiAgICAgKiBAaW50ZXJuYWwNCiAgICAgKi8NCiAgICBvZmYoKSB7DQogICAgICBpZiAodGhpcy5fb24gPiAwICYmIC0tdGhpcy5fb24gPT09IDApIHsNCiAgICAgICAgYWN0aXZlRWZmZWN0U2NvcGUgPSB0aGlzLnByZXZTY29wZTsNCiAgICAgICAgdGhpcy5wcmV2U2NvcGUgPSB2b2lkIDA7DQogICAgICB9DQogICAgfQ0KICAgIHN0b3AoZnJvbVBhcmVudCkgew0KICAgICAgaWYgKHRoaXMuX2FjdGl2ZSkgew0KICAgICAgICB0aGlzLl9hY3RpdmUgPSBmYWxzZTsNCiAgICAgICAgbGV0IGksIGw7DQogICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLmVmZmVjdHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7DQogICAgICAgICAgdGhpcy5lZmZlY3RzW2ldLnN0b3AoKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmVmZmVjdHMubGVuZ3RoID0gMDsNCiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMuY2xlYW51cHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7DQogICAgICAgICAgdGhpcy5jbGVhbnVwc1tpXSgpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuY2xlYW51cHMubGVuZ3RoID0gMDsNCiAgICAgICAgaWYgKHRoaXMuc2NvcGVzKSB7DQogICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMuc2NvcGVzLmxlbmd0aDsgaSA8IGw7IGkrKykgew0KICAgICAgICAgICAgdGhpcy5zY29wZXNbaV0uc3RvcCh0cnVlKTsNCiAgICAgICAgICB9DQogICAgICAgICAgdGhpcy5zY29wZXMubGVuZ3RoID0gMDsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIXRoaXMuZGV0YWNoZWQgJiYgdGhpcy5wYXJlbnQgJiYgIWZyb21QYXJlbnQpIHsNCiAgICAgICAgICBjb25zdCBsYXN0ID0gdGhpcy5wYXJlbnQuc2NvcGVzLnBvcCgpOw0KICAgICAgICAgIGlmIChsYXN0ICYmIGxhc3QgIT09IHRoaXMpIHsNCiAgICAgICAgICAgIHRoaXMucGFyZW50LnNjb3Blc1t0aGlzLmluZGV4XSA9IGxhc3Q7DQogICAgICAgICAgICBsYXN0LmluZGV4ID0gdGhpcy5pbmRleDsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5wYXJlbnQgPSB2b2lkIDA7DQogICAgICB9DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGVmZmVjdFNjb3BlKGRldGFjaGVkKSB7DQogICAgcmV0dXJuIG5ldyBFZmZlY3RTY29wZShkZXRhY2hlZCk7DQogIH0NCiAgZnVuY3Rpb24gZ2V0Q3VycmVudFNjb3BlKCkgew0KICAgIHJldHVybiBhY3RpdmVFZmZlY3RTY29wZTsNCiAgfQ0KICBmdW5jdGlvbiBvblNjb3BlRGlzcG9zZShmbiwgZmFpbFNpbGVudGx5ID0gZmFsc2UpIHsNCiAgICBpZiAoYWN0aXZlRWZmZWN0U2NvcGUpIHsNCiAgICAgIGFjdGl2ZUVmZmVjdFNjb3BlLmNsZWFudXBzLnB1c2goZm4pOw0KICAgIH0gZWxzZSBpZiAoIWZhaWxTaWxlbnRseSkgew0KICAgICAgd2FybiQyKA0KICAgICAgICBgb25TY29wZURpc3Bvc2UoKSBpcyBjYWxsZWQgd2hlbiB0aGVyZSBpcyBubyBhY3RpdmUgZWZmZWN0IHNjb3BlIHRvIGJlIGFzc29jaWF0ZWQgd2l0aC5gDQogICAgICApOw0KICAgIH0NCiAgfQ0KDQogIGxldCBhY3RpdmVTdWI7DQogIGNvbnN0IHBhdXNlZFF1ZXVlRWZmZWN0cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha1NldCgpOw0KICBjbGFzcyBSZWFjdGl2ZUVmZmVjdCB7DQogICAgY29uc3RydWN0b3IoZm4pIHsNCiAgICAgIHRoaXMuZm4gPSBmbjsNCiAgICAgIC8qKg0KICAgICAgICogQGludGVybmFsDQogICAgICAgKi8NCiAgICAgIHRoaXMuZGVwcyA9IHZvaWQgMDsNCiAgICAgIC8qKg0KICAgICAgICogQGludGVybmFsDQogICAgICAgKi8NCiAgICAgIHRoaXMuZGVwc1RhaWwgPSB2b2lkIDA7DQogICAgICAvKioNCiAgICAgICAqIEBpbnRlcm5hbA0KICAgICAgICovDQogICAgICB0aGlzLmZsYWdzID0gMSB8IDQ7DQogICAgICAvKioNCiAgICAgICAqIEBpbnRlcm5hbA0KICAgICAgICovDQogICAgICB0aGlzLm5leHQgPSB2b2lkIDA7DQogICAgICAvKioNCiAgICAgICAqIEBpbnRlcm5hbA0KICAgICAgICovDQogICAgICB0aGlzLmNsZWFudXAgPSB2b2lkIDA7DQogICAgICB0aGlzLnNjaGVkdWxlciA9IHZvaWQgMDsNCiAgICAgIGlmIChhY3RpdmVFZmZlY3RTY29wZSAmJiBhY3RpdmVFZmZlY3RTY29wZS5hY3RpdmUpIHsNCiAgICAgICAgYWN0aXZlRWZmZWN0U2NvcGUuZWZmZWN0cy5wdXNoKHRoaXMpOw0KICAgICAgfQ0KICAgIH0NCiAgICBwYXVzZSgpIHsNCiAgICAgIHRoaXMuZmxhZ3MgfD0gNjQ7DQogICAgfQ0KICAgIHJlc3VtZSgpIHsNCiAgICAgIGlmICh0aGlzLmZsYWdzICYgNjQpIHsNCiAgICAgICAgdGhpcy5mbGFncyAmPSAtNjU7DQogICAgICAgIGlmIChwYXVzZWRRdWV1ZUVmZmVjdHMuaGFzKHRoaXMpKSB7DQogICAgICAgICAgcGF1c2VkUXVldWVFZmZlY3RzLmRlbGV0ZSh0aGlzKTsNCiAgICAgICAgICB0aGlzLnRyaWdnZXIoKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiBAaW50ZXJuYWwNCiAgICAgKi8NCiAgICBub3RpZnkoKSB7DQogICAgICBpZiAodGhpcy5mbGFncyAmIDIgJiYgISh0aGlzLmZsYWdzICYgMzIpKSB7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIGlmICghKHRoaXMuZmxhZ3MgJiA4KSkgew0KICAgICAgICBiYXRjaCh0aGlzKTsNCiAgICAgIH0NCiAgICB9DQogICAgcnVuKCkgew0KICAgICAgaWYgKCEodGhpcy5mbGFncyAmIDEpKSB7DQogICAgICAgIHJldHVybiB0aGlzLmZuKCk7DQogICAgICB9DQogICAgICB0aGlzLmZsYWdzIHw9IDI7DQogICAgICBjbGVhbnVwRWZmZWN0KHRoaXMpOw0KICAgICAgcHJlcGFyZURlcHModGhpcyk7DQogICAgICBjb25zdCBwcmV2RWZmZWN0ID0gYWN0aXZlU3ViOw0KICAgICAgY29uc3QgcHJldlNob3VsZFRyYWNrID0gc2hvdWxkVHJhY2s7DQogICAgICBhY3RpdmVTdWIgPSB0aGlzOw0KICAgICAgc2hvdWxkVHJhY2sgPSB0cnVlOw0KICAgICAgdHJ5IHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZm4oKTsNCiAgICAgIH0gZmluYWxseSB7DQogICAgICAgIGlmIChhY3RpdmVTdWIgIT09IHRoaXMpIHsNCiAgICAgICAgICB3YXJuJDIoDQogICAgICAgICAgICAiQWN0aXZlIGVmZmVjdCB3YXMgbm90IHJlc3RvcmVkIGNvcnJlY3RseSAtIHRoaXMgaXMgbGlrZWx5IGEgVnVlIGludGVybmFsIGJ1Zy4iDQogICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgICAgICBjbGVhbnVwRGVwcyh0aGlzKTsNCiAgICAgICAgYWN0aXZlU3ViID0gcHJldkVmZmVjdDsNCiAgICAgICAgc2hvdWxkVHJhY2sgPSBwcmV2U2hvdWxkVHJhY2s7DQogICAgICAgIHRoaXMuZmxhZ3MgJj0gLTM7DQogICAgICB9DQogICAgfQ0KICAgIHN0b3AoKSB7DQogICAgICBpZiAodGhpcy5mbGFncyAmIDEpIHsNCiAgICAgICAgZm9yIChsZXQgbGluayA9IHRoaXMuZGVwczsgbGluazsgbGluayA9IGxpbmsubmV4dERlcCkgew0KICAgICAgICAgIHJlbW92ZVN1YihsaW5rKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmRlcHMgPSB0aGlzLmRlcHNUYWlsID0gdm9pZCAwOw0KICAgICAgICBjbGVhbnVwRWZmZWN0KHRoaXMpOw0KICAgICAgICB0aGlzLm9uU3RvcCAmJiB0aGlzLm9uU3RvcCgpOw0KICAgICAgICB0aGlzLmZsYWdzICY9IC0yOw0KICAgICAgfQ0KICAgIH0NCiAgICB0cmlnZ2VyKCkgew0KICAgICAgaWYgKHRoaXMuZmxhZ3MgJiA2NCkgew0KICAgICAgICBwYXVzZWRRdWV1ZUVmZmVjdHMuYWRkKHRoaXMpOw0KICAgICAgfSBlbHNlIGlmICh0aGlzLnNjaGVkdWxlcikgew0KICAgICAgICB0aGlzLnNjaGVkdWxlcigpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdGhpcy5ydW5JZkRpcnR5KCk7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIEBpbnRlcm5hbA0KICAgICAqLw0KICAgIHJ1bklmRGlydHkoKSB7DQogICAgICBpZiAoaXNEaXJ0eSh0aGlzKSkgew0KICAgICAgICB0aGlzLnJ1bigpOw0KICAgICAgfQ0KICAgIH0NCiAgICBnZXQgZGlydHkoKSB7DQogICAgICByZXR1cm4gaXNEaXJ0eSh0aGlzKTsNCiAgICB9DQogIH0NCiAgbGV0IGJhdGNoRGVwdGggPSAwOw0KICBsZXQgYmF0Y2hlZFN1YjsNCiAgbGV0IGJhdGNoZWRDb21wdXRlZDsNCiAgZnVuY3Rpb24gYmF0Y2goc3ViLCBpc0NvbXB1dGVkID0gZmFsc2UpIHsNCiAgICBzdWIuZmxhZ3MgfD0gODsNCiAgICBpZiAoaXNDb21wdXRlZCkgew0KICAgICAgc3ViLm5leHQgPSBiYXRjaGVkQ29tcHV0ZWQ7DQogICAgICBiYXRjaGVkQ29tcHV0ZWQgPSBzdWI7DQogICAgICByZXR1cm47DQogICAgfQ0KICAgIHN1Yi5uZXh0ID0gYmF0Y2hlZFN1YjsNCiAgICBiYXRjaGVkU3ViID0gc3ViOw0KICB9DQogIGZ1bmN0aW9uIHN0YXJ0QmF0Y2goKSB7DQogICAgYmF0Y2hEZXB0aCsrOw0KICB9DQogIGZ1bmN0aW9uIGVuZEJhdGNoKCkgew0KICAgIGlmICgtLWJhdGNoRGVwdGggPiAwKSB7DQogICAgICByZXR1cm47DQogICAgfQ0KICAgIGlmIChiYXRjaGVkQ29tcHV0ZWQpIHsNCiAgICAgIGxldCBlID0gYmF0Y2hlZENvbXB1dGVkOw0KICAgICAgYmF0Y2hlZENvbXB1dGVkID0gdm9pZCAwOw0KICAgICAgd2hpbGUgKGUpIHsNCiAgICAgICAgY29uc3QgbmV4dCA9IGUubmV4dDsNCiAgICAgICAgZS5uZXh0ID0gdm9pZCAwOw0KICAgICAgICBlLmZsYWdzICY9IC05Ow0KICAgICAgICBlID0gbmV4dDsNCiAgICAgIH0NCiAgICB9DQogICAgbGV0IGVycm9yOw0KICAgIHdoaWxlIChiYXRjaGVkU3ViKSB7DQogICAgICBsZXQgZSA9IGJhdGNoZWRTdWI7DQogICAgICBiYXRjaGVkU3ViID0gdm9pZCAwOw0KICAgICAgd2hpbGUgKGUpIHsNCiAgICAgICAgY29uc3QgbmV4dCA9IGUubmV4dDsNCiAgICAgICAgZS5uZXh0ID0gdm9pZCAwOw0KICAgICAgICBlLmZsYWdzICY9IC05Ow0KICAgICAgICBpZiAoZS5mbGFncyAmIDEpIHsNCiAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgOw0KICAgICAgICAgICAgZS50cmlnZ2VyKCk7DQogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7DQogICAgICAgICAgICBpZiAoIWVycm9yKSBlcnJvciA9IGVycjsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgZSA9IG5leHQ7DQogICAgICB9DQogICAgfQ0KICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7DQogIH0NCiAgZnVuY3Rpb24gcHJlcGFyZURlcHMoc3ViKSB7DQogICAgZm9yIChsZXQgbGluayA9IHN1Yi5kZXBzOyBsaW5rOyBsaW5rID0gbGluay5uZXh0RGVwKSB7DQogICAgICBsaW5rLnZlcnNpb24gPSAtMTsNCiAgICAgIGxpbmsucHJldkFjdGl2ZUxpbmsgPSBsaW5rLmRlcC5hY3RpdmVMaW5rOw0KICAgICAgbGluay5kZXAuYWN0aXZlTGluayA9IGxpbms7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGNsZWFudXBEZXBzKHN1Yikgew0KICAgIGxldCBoZWFkOw0KICAgIGxldCB0YWlsID0gc3ViLmRlcHNUYWlsOw0KICAgIGxldCBsaW5rID0gdGFpbDsNCiAgICB3aGlsZSAobGluaykgew0KICAgICAgY29uc3QgcHJldiA9IGxpbmsucHJldkRlcDsNCiAgICAgIGlmIChsaW5rLnZlcnNpb24gPT09IC0xKSB7DQogICAgICAgIGlmIChsaW5rID09PSB0YWlsKSB0YWlsID0gcHJldjsNCiAgICAgICAgcmVtb3ZlU3ViKGxpbmspOw0KICAgICAgICByZW1vdmVEZXAobGluayk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBoZWFkID0gbGluazsNCiAgICAgIH0NCiAgICAgIGxpbmsuZGVwLmFjdGl2ZUxpbmsgPSBsaW5rLnByZXZBY3RpdmVMaW5rOw0KICAgICAgbGluay5wcmV2QWN0aXZlTGluayA9IHZvaWQgMDsNCiAgICAgIGxpbmsgPSBwcmV2Ow0KICAgIH0NCiAgICBzdWIuZGVwcyA9IGhlYWQ7DQogICAgc3ViLmRlcHNUYWlsID0gdGFpbDsNCiAgfQ0KICBmdW5jdGlvbiBpc0RpcnR5KHN1Yikgew0KICAgIGZvciAobGV0IGxpbmsgPSBzdWIuZGVwczsgbGluazsgbGluayA9IGxpbmsubmV4dERlcCkgew0KICAgICAgaWYgKGxpbmsuZGVwLnZlcnNpb24gIT09IGxpbmsudmVyc2lvbiB8fCBsaW5rLmRlcC5jb21wdXRlZCAmJiAocmVmcmVzaENvbXB1dGVkKGxpbmsuZGVwLmNvbXB1dGVkKSB8fCBsaW5rLmRlcC52ZXJzaW9uICE9PSBsaW5rLnZlcnNpb24pKSB7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAoc3ViLl9kaXJ0eSkgew0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KICAgIHJldHVybiBmYWxzZTsNCiAgfQ0KICBmdW5jdGlvbiByZWZyZXNoQ29tcHV0ZWQoY29tcHV0ZWQpIHsNCiAgICBpZiAoY29tcHV0ZWQuZmxhZ3MgJiA0ICYmICEoY29tcHV0ZWQuZmxhZ3MgJiAxNikpIHsNCiAgICAgIHJldHVybjsNCiAgICB9DQogICAgY29tcHV0ZWQuZmxhZ3MgJj0gLTE3Ow0KICAgIGlmIChjb21wdXRlZC5nbG9iYWxWZXJzaW9uID09PSBnbG9iYWxWZXJzaW9uKSB7DQogICAgICByZXR1cm47DQogICAgfQ0KICAgIGNvbXB1dGVkLmdsb2JhbFZlcnNpb24gPSBnbG9iYWxWZXJzaW9uOw0KICAgIGlmICghY29tcHV0ZWQuaXNTU1IgJiYgY29tcHV0ZWQuZmxhZ3MgJiAxMjggJiYgKCFjb21wdXRlZC5kZXBzICYmICFjb21wdXRlZC5fZGlydHkgfHwgIWlzRGlydHkoY29tcHV0ZWQpKSkgew0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBjb21wdXRlZC5mbGFncyB8PSAyOw0KICAgIGNvbnN0IGRlcCA9IGNvbXB1dGVkLmRlcDsNCiAgICBjb25zdCBwcmV2U3ViID0gYWN0aXZlU3ViOw0KICAgIGNvbnN0IHByZXZTaG91bGRUcmFjayA9IHNob3VsZFRyYWNrOw0KICAgIGFjdGl2ZVN1YiA9IGNvbXB1dGVkOw0KICAgIHNob3VsZFRyYWNrID0gdHJ1ZTsNCiAgICB0cnkgew0KICAgICAgcHJlcGFyZURlcHMoY29tcHV0ZWQpOw0KICAgICAgY29uc3QgdmFsdWUgPSBjb21wdXRlZC5mbihjb21wdXRlZC5fdmFsdWUpOw0KICAgICAgaWYgKGRlcC52ZXJzaW9uID09PSAwIHx8IGhhc0NoYW5nZWQodmFsdWUsIGNvbXB1dGVkLl92YWx1ZSkpIHsNCiAgICAgICAgY29tcHV0ZWQuZmxhZ3MgfD0gMTI4Ow0KICAgICAgICBjb21wdXRlZC5fdmFsdWUgPSB2YWx1ZTsNCiAgICAgICAgZGVwLnZlcnNpb24rKzsNCiAgICAgIH0NCiAgICB9IGNhdGNoIChlcnIpIHsNCiAgICAgIGRlcC52ZXJzaW9uKys7DQogICAgICB0aHJvdyBlcnI7DQogICAgfSBmaW5hbGx5IHsNCiAgICAgIGFjdGl2ZVN1YiA9IHByZXZTdWI7DQogICAgICBzaG91bGRUcmFjayA9IHByZXZTaG91bGRUcmFjazsNCiAgICAgIGNsZWFudXBEZXBzKGNvbXB1dGVkKTsNCiAgICAgIGNvbXB1dGVkLmZsYWdzICY9IC0zOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiByZW1vdmVTdWIobGluaywgc29mdCA9IGZhbHNlKSB7DQogICAgY29uc3QgeyBkZXAsIHByZXZTdWIsIG5leHRTdWIgfSA9IGxpbms7DQogICAgaWYgKHByZXZTdWIpIHsNCiAgICAgIHByZXZTdWIubmV4dFN1YiA9IG5leHRTdWI7DQogICAgICBsaW5rLnByZXZTdWIgPSB2b2lkIDA7DQogICAgfQ0KICAgIGlmIChuZXh0U3ViKSB7DQogICAgICBuZXh0U3ViLnByZXZTdWIgPSBwcmV2U3ViOw0KICAgICAgbGluay5uZXh0U3ViID0gdm9pZCAwOw0KICAgIH0NCiAgICBpZiAoZGVwLnN1YnNIZWFkID09PSBsaW5rKSB7DQogICAgICBkZXAuc3Vic0hlYWQgPSBuZXh0U3ViOw0KICAgIH0NCiAgICBpZiAoZGVwLnN1YnMgPT09IGxpbmspIHsNCiAgICAgIGRlcC5zdWJzID0gcHJldlN1YjsNCiAgICAgIGlmICghcHJldlN1YiAmJiBkZXAuY29tcHV0ZWQpIHsNCiAgICAgICAgZGVwLmNvbXB1dGVkLmZsYWdzICY9IC01Ow0KICAgICAgICBmb3IgKGxldCBsID0gZGVwLmNvbXB1dGVkLmRlcHM7IGw7IGwgPSBsLm5leHREZXApIHsNCiAgICAgICAgICByZW1vdmVTdWIobCwgdHJ1ZSk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogICAgaWYgKCFzb2Z0ICYmICEtLWRlcC5zYyAmJiBkZXAubWFwKSB7DQogICAgICBkZXAubWFwLmRlbGV0ZShkZXAua2V5KTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gcmVtb3ZlRGVwKGxpbmspIHsNCiAgICBjb25zdCB7IHByZXZEZXAsIG5leHREZXAgfSA9IGxpbms7DQogICAgaWYgKHByZXZEZXApIHsNCiAgICAgIHByZXZEZXAubmV4dERlcCA9IG5leHREZXA7DQogICAgICBsaW5rLnByZXZEZXAgPSB2b2lkIDA7DQogICAgfQ0KICAgIGlmIChuZXh0RGVwKSB7DQogICAgICBuZXh0RGVwLnByZXZEZXAgPSBwcmV2RGVwOw0KICAgICAgbGluay5uZXh0RGVwID0gdm9pZCAwOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBlZmZlY3QoZm4sIG9wdGlvbnMpIHsNCiAgICBpZiAoZm4uZWZmZWN0IGluc3RhbmNlb2YgUmVhY3RpdmVFZmZlY3QpIHsNCiAgICAgIGZuID0gZm4uZWZmZWN0LmZuOw0KICAgIH0NCiAgICBjb25zdCBlID0gbmV3IFJlYWN0aXZlRWZmZWN0KGZuKTsNCiAgICBpZiAob3B0aW9ucykgew0KICAgICAgZXh0ZW5kKGUsIG9wdGlvbnMpOw0KICAgIH0NCiAgICB0cnkgew0KICAgICAgZS5ydW4oKTsNCiAgICB9IGNhdGNoIChlcnIpIHsNCiAgICAgIGUuc3RvcCgpOw0KICAgICAgdGhyb3cgZXJyOw0KICAgIH0NCiAgICBjb25zdCBydW5uZXIgPSBlLnJ1bi5iaW5kKGUpOw0KICAgIHJ1bm5lci5lZmZlY3QgPSBlOw0KICAgIHJldHVybiBydW5uZXI7DQogIH0NCiAgZnVuY3Rpb24gc3RvcChydW5uZXIpIHsNCiAgICBydW5uZXIuZWZmZWN0LnN0b3AoKTsNCiAgfQ0KICBsZXQgc2hvdWxkVHJhY2sgPSB0cnVlOw0KICBjb25zdCB0cmFja1N0YWNrID0gW107DQogIGZ1bmN0aW9uIHBhdXNlVHJhY2tpbmcoKSB7DQogICAgdHJhY2tTdGFjay5wdXNoKHNob3VsZFRyYWNrKTsNCiAgICBzaG91bGRUcmFjayA9IGZhbHNlOw0KICB9DQogIGZ1bmN0aW9uIHJlc2V0VHJhY2tpbmcoKSB7DQogICAgY29uc3QgbGFzdCA9IHRyYWNrU3RhY2sucG9wKCk7DQogICAgc2hvdWxkVHJhY2sgPSBsYXN0ID09PSB2b2lkIDAgPyB0cnVlIDogbGFzdDsNCiAgfQ0KICBmdW5jdGlvbiBjbGVhbnVwRWZmZWN0KGUpIHsNCiAgICBjb25zdCB7IGNsZWFudXAgfSA9IGU7DQogICAgZS5jbGVhbnVwID0gdm9pZCAwOw0KICAgIGlmIChjbGVhbnVwKSB7DQogICAgICBjb25zdCBwcmV2U3ViID0gYWN0aXZlU3ViOw0KICAgICAgYWN0aXZlU3ViID0gdm9pZCAwOw0KICAgICAgdHJ5IHsNCiAgICAgICAgY2xlYW51cCgpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgYWN0aXZlU3ViID0gcHJldlN1YjsNCiAgICAgIH0NCiAgICB9DQogIH0NCg0KICBsZXQgZ2xvYmFsVmVyc2lvbiA9IDA7DQogIGNsYXNzIExpbmsgew0KICAgIGNvbnN0cnVjdG9yKHN1YiwgZGVwKSB7DQogICAgICB0aGlzLnN1YiA9IHN1YjsNCiAgICAgIHRoaXMuZGVwID0gZGVwOw0KICAgICAgdGhpcy52ZXJzaW9uID0gZGVwLnZlcnNpb247DQogICAgICB0aGlzLm5leHREZXAgPSB0aGlzLnByZXZEZXAgPSB0aGlzLm5leHRTdWIgPSB0aGlzLnByZXZTdWIgPSB0aGlzLnByZXZBY3RpdmVMaW5rID0gdm9pZCAwOw0KICAgIH0NCiAgfQ0KICBjbGFzcyBEZXAgew0KICAgIC8vIFRPRE8gaXNvbGF0ZWREZWNsYXJhdGlvbnMgIl9fdl9za2lwIg0KICAgIGNvbnN0cnVjdG9yKGNvbXB1dGVkKSB7DQogICAgICB0aGlzLmNvbXB1dGVkID0gY29tcHV0ZWQ7DQogICAgICB0aGlzLnZlcnNpb24gPSAwOw0KICAgICAgLyoqDQogICAgICAgKiBMaW5rIGJldHdlZW4gdGhpcyBkZXAgYW5kIHRoZSBjdXJyZW50IGFjdGl2ZSBlZmZlY3QNCiAgICAgICAqLw0KICAgICAgdGhpcy5hY3RpdmVMaW5rID0gdm9pZCAwOw0KICAgICAgLyoqDQogICAgICAgKiBEb3VibHkgbGlua2VkIGxpc3QgcmVwcmVzZW50aW5nIHRoZSBzdWJzY3JpYmluZyBlZmZlY3RzICh0YWlsKQ0KICAgICAgICovDQogICAgICB0aGlzLnN1YnMgPSB2b2lkIDA7DQogICAgICAvKioNCiAgICAgICAqIEZvciBvYmplY3QgcHJvcGVydHkgZGVwcyBjbGVhbnVwDQogICAgICAgKi8NCiAgICAgIHRoaXMubWFwID0gdm9pZCAwOw0KICAgICAgdGhpcy5rZXkgPSB2b2lkIDA7DQogICAgICAvKioNCiAgICAgICAqIFN1YnNjcmliZXIgY291bnRlcg0KICAgICAgICovDQogICAgICB0aGlzLnNjID0gMDsNCiAgICAgIC8qKg0KICAgICAgICogQGludGVybmFsDQogICAgICAgKi8NCiAgICAgIHRoaXMuX192X3NraXAgPSB0cnVlOw0KICAgICAgew0KICAgICAgICB0aGlzLnN1YnNIZWFkID0gdm9pZCAwOw0KICAgICAgfQ0KICAgIH0NCiAgICB0cmFjayhkZWJ1Z0luZm8pIHsNCiAgICAgIGlmICghYWN0aXZlU3ViIHx8ICFzaG91bGRUcmFjayB8fCBhY3RpdmVTdWIgPT09IHRoaXMuY29tcHV0ZWQpIHsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgbGV0IGxpbmsgPSB0aGlzLmFjdGl2ZUxpbms7DQogICAgICBpZiAobGluayA9PT0gdm9pZCAwIHx8IGxpbmsuc3ViICE9PSBhY3RpdmVTdWIpIHsNCiAgICAgICAgbGluayA9IHRoaXMuYWN0aXZlTGluayA9IG5ldyBMaW5rKGFjdGl2ZVN1YiwgdGhpcyk7DQogICAgICAgIGlmICghYWN0aXZlU3ViLmRlcHMpIHsNCiAgICAgICAgICBhY3RpdmVTdWIuZGVwcyA9IGFjdGl2ZVN1Yi5kZXBzVGFpbCA9IGxpbms7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgbGluay5wcmV2RGVwID0gYWN0aXZlU3ViLmRlcHNUYWlsOw0KICAgICAgICAgIGFjdGl2ZVN1Yi5kZXBzVGFpbC5uZXh0RGVwID0gbGluazsNCiAgICAgICAgICBhY3RpdmVTdWIuZGVwc1RhaWwgPSBsaW5rOw0KICAgICAgICB9DQogICAgICAgIGFkZFN1YihsaW5rKTsNCiAgICAgIH0gZWxzZSBpZiAobGluay52ZXJzaW9uID09PSAtMSkgew0KICAgICAgICBsaW5rLnZlcnNpb24gPSB0aGlzLnZlcnNpb247DQogICAgICAgIGlmIChsaW5rLm5leHREZXApIHsNCiAgICAgICAgICBjb25zdCBuZXh0ID0gbGluay5uZXh0RGVwOw0KICAgICAgICAgIG5leHQucHJldkRlcCA9IGxpbmsucHJldkRlcDsNCiAgICAgICAgICBpZiAobGluay5wcmV2RGVwKSB7DQogICAgICAgICAgICBsaW5rLnByZXZEZXAubmV4dERlcCA9IG5leHQ7DQogICAgICAgICAgfQ0KICAgICAgICAgIGxpbmsucHJldkRlcCA9IGFjdGl2ZVN1Yi5kZXBzVGFpbDsNCiAgICAgICAgICBsaW5rLm5leHREZXAgPSB2b2lkIDA7DQogICAgICAgICAgYWN0aXZlU3ViLmRlcHNUYWlsLm5leHREZXAgPSBsaW5rOw0KICAgICAgICAgIGFjdGl2ZVN1Yi5kZXBzVGFpbCA9IGxpbms7DQogICAgICAgICAgaWYgKGFjdGl2ZVN1Yi5kZXBzID09PSBsaW5rKSB7DQogICAgICAgICAgICBhY3RpdmVTdWIuZGVwcyA9IG5leHQ7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgICBpZiAoYWN0aXZlU3ViLm9uVHJhY2spIHsNCiAgICAgICAgYWN0aXZlU3ViLm9uVHJhY2soDQogICAgICAgICAgZXh0ZW5kKA0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICBlZmZlY3Q6IGFjdGl2ZVN1Yg0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGRlYnVnSW5mbw0KICAgICAgICAgICkNCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBsaW5rOw0KICAgIH0NCiAgICB0cmlnZ2VyKGRlYnVnSW5mbykgew0KICAgICAgdGhpcy52ZXJzaW9uKys7DQogICAgICBnbG9iYWxWZXJzaW9uKys7DQogICAgICB0aGlzLm5vdGlmeShkZWJ1Z0luZm8pOw0KICAgIH0NCiAgICBub3RpZnkoZGVidWdJbmZvKSB7DQogICAgICBzdGFydEJhdGNoKCk7DQogICAgICB0cnkgew0KICAgICAgICBpZiAodHJ1ZSkgew0KICAgICAgICAgIGZvciAobGV0IGhlYWQgPSB0aGlzLnN1YnNIZWFkOyBoZWFkOyBoZWFkID0gaGVhZC5uZXh0U3ViKSB7DQogICAgICAgICAgICBpZiAoaGVhZC5zdWIub25UcmlnZ2VyICYmICEoaGVhZC5zdWIuZmxhZ3MgJiA4KSkgew0KICAgICAgICAgICAgICBoZWFkLnN1Yi5vblRyaWdnZXIoDQogICAgICAgICAgICAgICAgZXh0ZW5kKA0KICAgICAgICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgICAgICBlZmZlY3Q6IGhlYWQuc3ViDQogICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgZGVidWdJbmZvDQogICAgICAgICAgICAgICAgKQ0KICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBmb3IgKGxldCBsaW5rID0gdGhpcy5zdWJzOyBsaW5rOyBsaW5rID0gbGluay5wcmV2U3ViKSB7DQogICAgICAgICAgaWYgKGxpbmsuc3ViLm5vdGlmeSgpKSB7DQogICAgICAgICAgICA7DQogICAgICAgICAgICBsaW5rLnN1Yi5kZXAubm90aWZ5KCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9IGZpbmFsbHkgew0KICAgICAgICBlbmRCYXRjaCgpOw0KICAgICAgfQ0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBhZGRTdWIobGluaykgew0KICAgIGxpbmsuZGVwLnNjKys7DQogICAgaWYgKGxpbmsuc3ViLmZsYWdzICYgNCkgew0KICAgICAgY29uc3QgY29tcHV0ZWQgPSBsaW5rLmRlcC5jb21wdXRlZDsNCiAgICAgIGlmIChjb21wdXRlZCAmJiAhbGluay5kZXAuc3Vicykgew0KICAgICAgICBjb21wdXRlZC5mbGFncyB8PSA0IHwgMTY7DQogICAgICAgIGZvciAobGV0IGwgPSBjb21wdXRlZC5kZXBzOyBsOyBsID0gbC5uZXh0RGVwKSB7DQogICAgICAgICAgYWRkU3ViKGwpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICBjb25zdCBjdXJyZW50VGFpbCA9IGxpbmsuZGVwLnN1YnM7DQogICAgICBpZiAoY3VycmVudFRhaWwgIT09IGxpbmspIHsNCiAgICAgICAgbGluay5wcmV2U3ViID0gY3VycmVudFRhaWw7DQogICAgICAgIGlmIChjdXJyZW50VGFpbCkgY3VycmVudFRhaWwubmV4dFN1YiA9IGxpbms7DQogICAgICB9DQogICAgICBpZiAobGluay5kZXAuc3Vic0hlYWQgPT09IHZvaWQgMCkgew0KICAgICAgICBsaW5rLmRlcC5zdWJzSGVhZCA9IGxpbms7DQogICAgICB9DQogICAgICBsaW5rLmRlcC5zdWJzID0gbGluazsNCiAgICB9DQogIH0NCiAgY29uc3QgdGFyZ2V0TWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7DQogIGNvbnN0IElURVJBVEVfS0VZID0gU3ltYm9sKA0KICAgICJPYmplY3QgaXRlcmF0ZSIgDQogICk7DQogIGNvbnN0IE1BUF9LRVlfSVRFUkFURV9LRVkgPSBTeW1ib2woDQogICAgIk1hcCBrZXlzIGl0ZXJhdGUiIA0KICApOw0KICBjb25zdCBBUlJBWV9JVEVSQVRFX0tFWSA9IFN5bWJvbCgNCiAgICAiQXJyYXkgaXRlcmF0ZSIgDQogICk7DQogIGZ1bmN0aW9uIHRyYWNrKHRhcmdldCwgdHlwZSwga2V5KSB7DQogICAgaWYgKHNob3VsZFRyYWNrICYmIGFjdGl2ZVN1Yikgew0KICAgICAgbGV0IGRlcHNNYXAgPSB0YXJnZXRNYXAuZ2V0KHRhcmdldCk7DQogICAgICBpZiAoIWRlcHNNYXApIHsNCiAgICAgICAgdGFyZ2V0TWFwLnNldCh0YXJnZXQsIGRlcHNNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpKTsNCiAgICAgIH0NCiAgICAgIGxldCBkZXAgPSBkZXBzTWFwLmdldChrZXkpOw0KICAgICAgaWYgKCFkZXApIHsNCiAgICAgICAgZGVwc01hcC5zZXQoa2V5LCBkZXAgPSBuZXcgRGVwKCkpOw0KICAgICAgICBkZXAubWFwID0gZGVwc01hcDsNCiAgICAgICAgZGVwLmtleSA9IGtleTsNCiAgICAgIH0NCiAgICAgIHsNCiAgICAgICAgZGVwLnRyYWNrKHsNCiAgICAgICAgICB0YXJnZXQsDQogICAgICAgICAgdHlwZSwNCiAgICAgICAgICBrZXkNCiAgICAgICAgfSk7DQogICAgICB9DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIHRyaWdnZXIodGFyZ2V0LCB0eXBlLCBrZXksIG5ld1ZhbHVlLCBvbGRWYWx1ZSwgb2xkVGFyZ2V0KSB7DQogICAgY29uc3QgZGVwc01hcCA9IHRhcmdldE1hcC5nZXQodGFyZ2V0KTsNCiAgICBpZiAoIWRlcHNNYXApIHsNCiAgICAgIGdsb2JhbFZlcnNpb24rKzsNCiAgICAgIHJldHVybjsNCiAgICB9DQogICAgY29uc3QgcnVuID0gKGRlcCkgPT4gew0KICAgICAgaWYgKGRlcCkgew0KICAgICAgICB7DQogICAgICAgICAgZGVwLnRyaWdnZXIoew0KICAgICAgICAgICAgdGFyZ2V0LA0KICAgICAgICAgICAgdHlwZSwNCiAgICAgICAgICAgIGtleSwNCiAgICAgICAgICAgIG5ld1ZhbHVlLA0KICAgICAgICAgICAgb2xkVmFsdWUsDQogICAgICAgICAgICBvbGRUYXJnZXQNCiAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH07DQogICAgc3RhcnRCYXRjaCgpOw0KICAgIGlmICh0eXBlID09PSAiY2xlYXIiKSB7DQogICAgICBkZXBzTWFwLmZvckVhY2gocnVuKTsNCiAgICB9IGVsc2Ugew0KICAgICAgY29uc3QgdGFyZ2V0SXNBcnJheSA9IGlzQXJyYXkodGFyZ2V0KTsNCiAgICAgIGNvbnN0IGlzQXJyYXlJbmRleCA9IHRhcmdldElzQXJyYXkgJiYgaXNJbnRlZ2VyS2V5KGtleSk7DQogICAgICBpZiAodGFyZ2V0SXNBcnJheSAmJiBrZXkgPT09ICJsZW5ndGgiKSB7DQogICAgICAgIGNvbnN0IG5ld0xlbmd0aCA9IE51bWJlcihuZXdWYWx1ZSk7DQogICAgICAgIGRlcHNNYXAuZm9yRWFjaCgoZGVwLCBrZXkyKSA9PiB7DQogICAgICAgICAgaWYgKGtleTIgPT09ICJsZW5ndGgiIHx8IGtleTIgPT09IEFSUkFZX0lURVJBVEVfS0VZIHx8ICFpc1N5bWJvbChrZXkyKSAmJiBrZXkyID49IG5ld0xlbmd0aCkgew0KICAgICAgICAgICAgcnVuKGRlcCk7DQogICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGlmIChrZXkgIT09IHZvaWQgMCB8fCBkZXBzTWFwLmhhcyh2b2lkIDApKSB7DQogICAgICAgICAgcnVuKGRlcHNNYXAuZ2V0KGtleSkpOw0KICAgICAgICB9DQogICAgICAgIGlmIChpc0FycmF5SW5kZXgpIHsNCiAgICAgICAgICBydW4oZGVwc01hcC5nZXQoQVJSQVlfSVRFUkFURV9LRVkpKTsNCiAgICAgICAgfQ0KICAgICAgICBzd2l0Y2ggKHR5cGUpIHsNCiAgICAgICAgICBjYXNlICJhZGQiOg0KICAgICAgICAgICAgaWYgKCF0YXJnZXRJc0FycmF5KSB7DQogICAgICAgICAgICAgIHJ1bihkZXBzTWFwLmdldChJVEVSQVRFX0tFWSkpOw0KICAgICAgICAgICAgICBpZiAoaXNNYXAodGFyZ2V0KSkgew0KICAgICAgICAgICAgICAgIHJ1bihkZXBzTWFwLmdldChNQVBfS0VZX0lURVJBVEVfS0VZKSk7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheUluZGV4KSB7DQogICAgICAgICAgICAgIHJ1bihkZXBzTWFwLmdldCgibGVuZ3RoIikpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgY2FzZSAiZGVsZXRlIjoNCiAgICAgICAgICAgIGlmICghdGFyZ2V0SXNBcnJheSkgew0KICAgICAgICAgICAgICBydW4oZGVwc01hcC5nZXQoSVRFUkFURV9LRVkpKTsNCiAgICAgICAgICAgICAgaWYgKGlzTWFwKHRhcmdldCkpIHsNCiAgICAgICAgICAgICAgICBydW4oZGVwc01hcC5nZXQoTUFQX0tFWV9JVEVSQVRFX0tFWSkpOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICBjYXNlICJzZXQiOg0KICAgICAgICAgICAgaWYgKGlzTWFwKHRhcmdldCkpIHsNCiAgICAgICAgICAgICAgcnVuKGRlcHNNYXAuZ2V0KElURVJBVEVfS0VZKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICBlbmRCYXRjaCgpOw0KICB9DQogIGZ1bmN0aW9uIGdldERlcEZyb21SZWFjdGl2ZShvYmplY3QsIGtleSkgew0KICAgIGNvbnN0IGRlcE1hcCA9IHRhcmdldE1hcC5nZXQob2JqZWN0KTsNCiAgICByZXR1cm4gZGVwTWFwICYmIGRlcE1hcC5nZXQoa2V5KTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHJlYWN0aXZlUmVhZEFycmF5KGFycmF5KSB7DQogICAgY29uc3QgcmF3ID0gdG9SYXcoYXJyYXkpOw0KICAgIGlmIChyYXcgPT09IGFycmF5KSByZXR1cm4gcmF3Ow0KICAgIHRyYWNrKHJhdywgIml0ZXJhdGUiLCBBUlJBWV9JVEVSQVRFX0tFWSk7DQogICAgcmV0dXJuIGlzU2hhbGxvdyhhcnJheSkgPyByYXcgOiByYXcubWFwKHRvUmVhY3RpdmUpOw0KICB9DQogIGZ1bmN0aW9uIHNoYWxsb3dSZWFkQXJyYXkoYXJyKSB7DQogICAgdHJhY2soYXJyID0gdG9SYXcoYXJyKSwgIml0ZXJhdGUiLCBBUlJBWV9JVEVSQVRFX0tFWSk7DQogICAgcmV0dXJuIGFycjsNCiAgfQ0KICBjb25zdCBhcnJheUluc3RydW1lbnRhdGlvbnMgPSB7DQogICAgX19wcm90b19fOiBudWxsLA0KICAgIFtTeW1ib2wuaXRlcmF0b3JdKCkgew0KICAgICAgcmV0dXJuIGl0ZXJhdG9yKHRoaXMsIFN5bWJvbC5pdGVyYXRvciwgdG9SZWFjdGl2ZSk7DQogICAgfSwNCiAgICBjb25jYXQoLi4uYXJncykgew0KICAgICAgcmV0dXJuIHJlYWN0aXZlUmVhZEFycmF5KHRoaXMpLmNvbmNhdCgNCiAgICAgICAgLi4uYXJncy5tYXAoKHgpID0+IGlzQXJyYXkoeCkgPyByZWFjdGl2ZVJlYWRBcnJheSh4KSA6IHgpDQogICAgICApOw0KICAgIH0sDQogICAgZW50cmllcygpIHsNCiAgICAgIHJldHVybiBpdGVyYXRvcih0aGlzLCAiZW50cmllcyIsICh2YWx1ZSkgPT4gew0KICAgICAgICB2YWx1ZVsxXSA9IHRvUmVhY3RpdmUodmFsdWVbMV0pOw0KICAgICAgICByZXR1cm4gdmFsdWU7DQogICAgICB9KTsNCiAgICB9LA0KICAgIGV2ZXJ5KGZuLCB0aGlzQXJnKSB7DQogICAgICByZXR1cm4gYXBwbHkodGhpcywgImV2ZXJ5IiwgZm4sIHRoaXNBcmcsIHZvaWQgMCwgYXJndW1lbnRzKTsNCiAgICB9LA0KICAgIGZpbHRlcihmbiwgdGhpc0FyZykgew0KICAgICAgcmV0dXJuIGFwcGx5KHRoaXMsICJmaWx0ZXIiLCBmbiwgdGhpc0FyZywgKHYpID0+IHYubWFwKHRvUmVhY3RpdmUpLCBhcmd1bWVudHMpOw0KICAgIH0sDQogICAgZmluZChmbiwgdGhpc0FyZykgew0KICAgICAgcmV0dXJuIGFwcGx5KHRoaXMsICJmaW5kIiwgZm4sIHRoaXNBcmcsIHRvUmVhY3RpdmUsIGFyZ3VtZW50cyk7DQogICAgfSwNCiAgICBmaW5kSW5kZXgoZm4sIHRoaXNBcmcpIHsNCiAgICAgIHJldHVybiBhcHBseSh0aGlzLCAiZmluZEluZGV4IiwgZm4sIHRoaXNBcmcsIHZvaWQgMCwgYXJndW1lbnRzKTsNCiAgICB9LA0KICAgIGZpbmRMYXN0KGZuLCB0aGlzQXJnKSB7DQogICAgICByZXR1cm4gYXBwbHkodGhpcywgImZpbmRMYXN0IiwgZm4sIHRoaXNBcmcsIHRvUmVhY3RpdmUsIGFyZ3VtZW50cyk7DQogICAgfSwNCiAgICBmaW5kTGFzdEluZGV4KGZuLCB0aGlzQXJnKSB7DQogICAgICByZXR1cm4gYXBwbHkodGhpcywgImZpbmRMYXN0SW5kZXgiLCBmbiwgdGhpc0FyZywgdm9pZCAwLCBhcmd1bWVudHMpOw0KICAgIH0sDQogICAgLy8gZmxhdCwgZmxhdE1hcCBjb3VsZCBiZW5lZml0IGZyb20gQVJSQVlfSVRFUkFURSBidXQgYXJlIG5vdCBzdHJhaWdodC1mb3J3YXJkIHRvIGltcGxlbWVudA0KICAgIGZvckVhY2goZm4sIHRoaXNBcmcpIHsNCiAgICAgIHJldHVybiBhcHBseSh0aGlzLCAiZm9yRWFjaCIsIGZuLCB0aGlzQXJnLCB2b2lkIDAsIGFyZ3VtZW50cyk7DQogICAgfSwNCiAgICBpbmNsdWRlcyguLi5hcmdzKSB7DQogICAgICByZXR1cm4gc2VhcmNoUHJveHkodGhpcywgImluY2x1ZGVzIiwgYXJncyk7DQogICAgfSwNCiAgICBpbmRleE9mKC4uLmFyZ3MpIHsNCiAgICAgIHJldHVybiBzZWFyY2hQcm94eSh0aGlzLCAiaW5kZXhPZiIsIGFyZ3MpOw0KICAgIH0sDQogICAgam9pbihzZXBhcmF0b3IpIHsNCiAgICAgIHJldHVybiByZWFjdGl2ZVJlYWRBcnJheSh0aGlzKS5qb2luKHNlcGFyYXRvcik7DQogICAgfSwNCiAgICAvLyBrZXlzKCkgaXRlcmF0b3Igb25seSByZWFkcyBgbGVuZ3RoYCwgbm8gb3B0aW1pc2F0aW9uIHJlcXVpcmVkDQogICAgbGFzdEluZGV4T2YoLi4uYXJncykgew0KICAgICAgcmV0dXJuIHNlYXJjaFByb3h5KHRoaXMsICJsYXN0SW5kZXhPZiIsIGFyZ3MpOw0KICAgIH0sDQogICAgbWFwKGZuLCB0aGlzQXJnKSB7DQogICAgICByZXR1cm4gYXBwbHkodGhpcywgIm1hcCIsIGZuLCB0aGlzQXJnLCB2b2lkIDAsIGFyZ3VtZW50cyk7DQogICAgfSwNCiAgICBwb3AoKSB7DQogICAgICByZXR1cm4gbm9UcmFja2luZyh0aGlzLCAicG9wIik7DQogICAgfSwNCiAgICBwdXNoKC4uLmFyZ3MpIHsNCiAgICAgIHJldHVybiBub1RyYWNraW5nKHRoaXMsICJwdXNoIiwgYXJncyk7DQogICAgfSwNCiAgICByZWR1Y2UoZm4sIC4uLmFyZ3MpIHsNCiAgICAgIHJldHVybiByZWR1Y2UodGhpcywgInJlZHVjZSIsIGZuLCBhcmdzKTsNCiAgICB9LA0KICAgIHJlZHVjZVJpZ2h0KGZuLCAuLi5hcmdzKSB7DQogICAgICByZXR1cm4gcmVkdWNlKHRoaXMsICJyZWR1Y2VSaWdodCIsIGZuLCBhcmdzKTsNCiAgICB9LA0KICAgIHNoaWZ0KCkgew0KICAgICAgcmV0dXJuIG5vVHJhY2tpbmcodGhpcywgInNoaWZ0Iik7DQogICAgfSwNCiAgICAvLyBzbGljZSBjb3VsZCB1c2UgQVJSQVlfSVRFUkFURSBidXQgYWxzbyBzZWVtcyB0byBiZWcgZm9yIHJhbmdlIHRyYWNraW5nDQogICAgc29tZShmbiwgdGhpc0FyZykgew0KICAgICAgcmV0dXJuIGFwcGx5KHRoaXMsICJzb21lIiwgZm4sIHRoaXNBcmcsIHZvaWQgMCwgYXJndW1lbnRzKTsNCiAgICB9LA0KICAgIHNwbGljZSguLi5hcmdzKSB7DQogICAgICByZXR1cm4gbm9UcmFja2luZyh0aGlzLCAic3BsaWNlIiwgYXJncyk7DQogICAgfSwNCiAgICB0b1JldmVyc2VkKCkgew0KICAgICAgcmV0dXJuIHJlYWN0aXZlUmVhZEFycmF5KHRoaXMpLnRvUmV2ZXJzZWQoKTsNCiAgICB9LA0KICAgIHRvU29ydGVkKGNvbXBhcmVyKSB7DQogICAgICByZXR1cm4gcmVhY3RpdmVSZWFkQXJyYXkodGhpcykudG9Tb3J0ZWQoY29tcGFyZXIpOw0KICAgIH0sDQogICAgdG9TcGxpY2VkKC4uLmFyZ3MpIHsNCiAgICAgIHJldHVybiByZWFjdGl2ZVJlYWRBcnJheSh0aGlzKS50b1NwbGljZWQoLi4uYXJncyk7DQogICAgfSwNCiAgICB1bnNoaWZ0KC4uLmFyZ3MpIHsNCiAgICAgIHJldHVybiBub1RyYWNraW5nKHRoaXMsICJ1bnNoaWZ0IiwgYXJncyk7DQogICAgfSwNCiAgICB2YWx1ZXMoKSB7DQogICAgICByZXR1cm4gaXRlcmF0b3IodGhpcywgInZhbHVlcyIsIHRvUmVhY3RpdmUpOw0KICAgIH0NCiAgfTsNCiAgZnVuY3Rpb24gaXRlcmF0b3Ioc2VsZiwgbWV0aG9kLCB3cmFwVmFsdWUpIHsNCiAgICBjb25zdCBhcnIgPSBzaGFsbG93UmVhZEFycmF5KHNlbGYpOw0KICAgIGNvbnN0IGl0ZXIgPSBhcnJbbWV0aG9kXSgpOw0KICAgIGlmIChhcnIgIT09IHNlbGYgJiYgIWlzU2hhbGxvdyhzZWxmKSkgew0KICAgICAgaXRlci5fbmV4dCA9IGl0ZXIubmV4dDsNCiAgICAgIGl0ZXIubmV4dCA9ICgpID0+IHsNCiAgICAgICAgY29uc3QgcmVzdWx0ID0gaXRlci5fbmV4dCgpOw0KICAgICAgICBpZiAocmVzdWx0LnZhbHVlKSB7DQogICAgICAgICAgcmVzdWx0LnZhbHVlID0gd3JhcFZhbHVlKHJlc3VsdC52YWx1ZSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgIH07DQogICAgfQ0KICAgIHJldHVybiBpdGVyOw0KICB9DQogIGNvbnN0IGFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGU7DQogIGZ1bmN0aW9uIGFwcGx5KHNlbGYsIG1ldGhvZCwgZm4sIHRoaXNBcmcsIHdyYXBwZWRSZXRGbiwgYXJncykgew0KICAgIGNvbnN0IGFyciA9IHNoYWxsb3dSZWFkQXJyYXkoc2VsZik7DQogICAgY29uc3QgbmVlZHNXcmFwID0gYXJyICE9PSBzZWxmICYmICFpc1NoYWxsb3coc2VsZik7DQogICAgY29uc3QgbWV0aG9kRm4gPSBhcnJbbWV0aG9kXTsNCiAgICBpZiAobWV0aG9kRm4gIT09IGFycmF5UHJvdG9bbWV0aG9kXSkgew0KICAgICAgY29uc3QgcmVzdWx0MiA9IG1ldGhvZEZuLmFwcGx5KHNlbGYsIGFyZ3MpOw0KICAgICAgcmV0dXJuIG5lZWRzV3JhcCA/IHRvUmVhY3RpdmUocmVzdWx0MikgOiByZXN1bHQyOw0KICAgIH0NCiAgICBsZXQgd3JhcHBlZEZuID0gZm47DQogICAgaWYgKGFyciAhPT0gc2VsZikgew0KICAgICAgaWYgKG5lZWRzV3JhcCkgew0KICAgICAgICB3cmFwcGVkRm4gPSBmdW5jdGlvbihpdGVtLCBpbmRleCkgew0KICAgICAgICAgIHJldHVybiBmbi5jYWxsKHRoaXMsIHRvUmVhY3RpdmUoaXRlbSksIGluZGV4LCBzZWxmKTsNCiAgICAgICAgfTsNCiAgICAgIH0gZWxzZSBpZiAoZm4ubGVuZ3RoID4gMikgew0KICAgICAgICB3cmFwcGVkRm4gPSBmdW5jdGlvbihpdGVtLCBpbmRleCkgew0KICAgICAgICAgIHJldHVybiBmbi5jYWxsKHRoaXMsIGl0ZW0sIGluZGV4LCBzZWxmKTsNCiAgICAgICAgfTsNCiAgICAgIH0NCiAgICB9DQogICAgY29uc3QgcmVzdWx0ID0gbWV0aG9kRm4uY2FsbChhcnIsIHdyYXBwZWRGbiwgdGhpc0FyZyk7DQogICAgcmV0dXJuIG5lZWRzV3JhcCAmJiB3cmFwcGVkUmV0Rm4gPyB3cmFwcGVkUmV0Rm4ocmVzdWx0KSA6IHJlc3VsdDsNCiAgfQ0KICBmdW5jdGlvbiByZWR1Y2Uoc2VsZiwgbWV0aG9kLCBmbiwgYXJncykgew0KICAgIGNvbnN0IGFyciA9IHNoYWxsb3dSZWFkQXJyYXkoc2VsZik7DQogICAgbGV0IHdyYXBwZWRGbiA9IGZuOw0KICAgIGlmIChhcnIgIT09IHNlbGYpIHsNCiAgICAgIGlmICghaXNTaGFsbG93KHNlbGYpKSB7DQogICAgICAgIHdyYXBwZWRGbiA9IGZ1bmN0aW9uKGFjYywgaXRlbSwgaW5kZXgpIHsNCiAgICAgICAgICByZXR1cm4gZm4uY2FsbCh0aGlzLCBhY2MsIHRvUmVhY3RpdmUoaXRlbSksIGluZGV4LCBzZWxmKTsNCiAgICAgICAgfTsNCiAgICAgIH0gZWxzZSBpZiAoZm4ubGVuZ3RoID4gMykgew0KICAgICAgICB3cmFwcGVkRm4gPSBmdW5jdGlvbihhY2MsIGl0ZW0sIGluZGV4KSB7DQogICAgICAgICAgcmV0dXJuIGZuLmNhbGwodGhpcywgYWNjLCBpdGVtLCBpbmRleCwgc2VsZik7DQogICAgICAgIH07DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiBhcnJbbWV0aG9kXSh3cmFwcGVkRm4sIC4uLmFyZ3MpOw0KICB9DQogIGZ1bmN0aW9uIHNlYXJjaFByb3h5KHNlbGYsIG1ldGhvZCwgYXJncykgew0KICAgIGNvbnN0IGFyciA9IHRvUmF3KHNlbGYpOw0KICAgIHRyYWNrKGFyciwgIml0ZXJhdGUiLCBBUlJBWV9JVEVSQVRFX0tFWSk7DQogICAgY29uc3QgcmVzID0gYXJyW21ldGhvZF0oLi4uYXJncyk7DQogICAgaWYgKChyZXMgPT09IC0xIHx8IHJlcyA9PT0gZmFsc2UpICYmIGlzUHJveHkoYXJnc1swXSkpIHsNCiAgICAgIGFyZ3NbMF0gPSB0b1JhdyhhcmdzWzBdKTsNCiAgICAgIHJldHVybiBhcnJbbWV0aG9kXSguLi5hcmdzKTsNCiAgICB9DQogICAgcmV0dXJuIHJlczsNCiAgfQ0KICBmdW5jdGlvbiBub1RyYWNraW5nKHNlbGYsIG1ldGhvZCwgYXJncyA9IFtdKSB7DQogICAgcGF1c2VUcmFja2luZygpOw0KICAgIHN0YXJ0QmF0Y2goKTsNCiAgICBjb25zdCByZXMgPSB0b1JhdyhzZWxmKVttZXRob2RdLmFwcGx5KHNlbGYsIGFyZ3MpOw0KICAgIGVuZEJhdGNoKCk7DQogICAgcmVzZXRUcmFja2luZygpOw0KICAgIHJldHVybiByZXM7DQogIH0NCg0KICBjb25zdCBpc05vblRyYWNrYWJsZUtleXMgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcChgX19wcm90b19fLF9fdl9pc1JlZixfX2lzVnVlYCk7DQogIGNvbnN0IGJ1aWx0SW5TeW1ib2xzID0gbmV3IFNldCgNCiAgICAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoU3ltYm9sKS5maWx0ZXIoKGtleSkgPT4ga2V5ICE9PSAiYXJndW1lbnRzIiAmJiBrZXkgIT09ICJjYWxsZXIiKS5tYXAoKGtleSkgPT4gU3ltYm9sW2tleV0pLmZpbHRlcihpc1N5bWJvbCkNCiAgKTsNCiAgZnVuY3Rpb24gaGFzT3duUHJvcGVydHkoa2V5KSB7DQogICAgaWYgKCFpc1N5bWJvbChrZXkpKSBrZXkgPSBTdHJpbmcoa2V5KTsNCiAgICBjb25zdCBvYmogPSB0b1Jhdyh0aGlzKTsNCiAgICB0cmFjayhvYmosICJoYXMiLCBrZXkpOw0KICAgIHJldHVybiBvYmouaGFzT3duUHJvcGVydHkoa2V5KTsNCiAgfQ0KICBjbGFzcyBCYXNlUmVhY3RpdmVIYW5kbGVyIHsNCiAgICBjb25zdHJ1Y3RvcihfaXNSZWFkb25seSA9IGZhbHNlLCBfaXNTaGFsbG93ID0gZmFsc2UpIHsNCiAgICAgIHRoaXMuX2lzUmVhZG9ubHkgPSBfaXNSZWFkb25seTsNCiAgICAgIHRoaXMuX2lzU2hhbGxvdyA9IF9pc1NoYWxsb3c7DQogICAgfQ0KICAgIGdldCh0YXJnZXQsIGtleSwgcmVjZWl2ZXIpIHsNCiAgICAgIGlmIChrZXkgPT09ICJfX3Zfc2tpcCIpIHJldHVybiB0YXJnZXRbIl9fdl9za2lwIl07DQogICAgICBjb25zdCBpc1JlYWRvbmx5MiA9IHRoaXMuX2lzUmVhZG9ubHksIGlzU2hhbGxvdzIgPSB0aGlzLl9pc1NoYWxsb3c7DQogICAgICBpZiAoa2V5ID09PSAiX192X2lzUmVhY3RpdmUiKSB7DQogICAgICAgIHJldHVybiAhaXNSZWFkb25seTI7DQogICAgICB9IGVsc2UgaWYgKGtleSA9PT0gIl9fdl9pc1JlYWRvbmx5Iikgew0KICAgICAgICByZXR1cm4gaXNSZWFkb25seTI7DQogICAgICB9IGVsc2UgaWYgKGtleSA9PT0gIl9fdl9pc1NoYWxsb3ciKSB7DQogICAgICAgIHJldHVybiBpc1NoYWxsb3cyOw0KICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICJfX3ZfcmF3Iikgew0KICAgICAgICBpZiAocmVjZWl2ZXIgPT09IChpc1JlYWRvbmx5MiA/IGlzU2hhbGxvdzIgPyBzaGFsbG93UmVhZG9ubHlNYXAgOiByZWFkb25seU1hcCA6IGlzU2hhbGxvdzIgPyBzaGFsbG93UmVhY3RpdmVNYXAgOiByZWFjdGl2ZU1hcCkuZ2V0KHRhcmdldCkgfHwgLy8gcmVjZWl2ZXIgaXMgbm90IHRoZSByZWFjdGl2ZSBwcm94eSwgYnV0IGhhcyB0aGUgc2FtZSBwcm90b3R5cGUNCiAgICAgICAgLy8gdGhpcyBtZWFucyB0aGUgcmVjZWl2ZXIgaXMgYSB1c2VyIHByb3h5IG9mIHRoZSByZWFjdGl2ZSBwcm94eQ0KICAgICAgICBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGFyZ2V0KSA9PT0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHJlY2VpdmVyKSkgew0KICAgICAgICAgIHJldHVybiB0YXJnZXQ7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgY29uc3QgdGFyZ2V0SXNBcnJheSA9IGlzQXJyYXkodGFyZ2V0KTsNCiAgICAgIGlmICghaXNSZWFkb25seTIpIHsNCiAgICAgICAgbGV0IGZuOw0KICAgICAgICBpZiAodGFyZ2V0SXNBcnJheSAmJiAoZm4gPSBhcnJheUluc3RydW1lbnRhdGlvbnNba2V5XSkpIHsNCiAgICAgICAgICByZXR1cm4gZm47DQogICAgICAgIH0NCiAgICAgICAgaWYgKGtleSA9PT0gImhhc093blByb3BlcnR5Iikgew0KICAgICAgICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgY29uc3QgcmVzID0gUmVmbGVjdC5nZXQoDQogICAgICAgIHRhcmdldCwNCiAgICAgICAga2V5LA0KICAgICAgICAvLyBpZiB0aGlzIGlzIGEgcHJveHkgd3JhcHBpbmcgYSByZWYsIHJldHVybiBtZXRob2RzIHVzaW5nIHRoZSByYXcgcmVmDQogICAgICAgIC8vIGFzIHJlY2VpdmVyIHNvIHRoYXQgd2UgZG9uJ3QgaGF2ZSB0byBjYWxsIGB0b1Jhd2Agb24gdGhlIHJlZiBpbiBhbGwNCiAgICAgICAgLy8gaXRzIGNsYXNzIG1ldGhvZHMNCiAgICAgICAgaXNSZWYodGFyZ2V0KSA/IHRhcmdldCA6IHJlY2VpdmVyDQogICAgICApOw0KICAgICAgaWYgKGlzU3ltYm9sKGtleSkgPyBidWlsdEluU3ltYm9scy5oYXMoa2V5KSA6IGlzTm9uVHJhY2thYmxlS2V5cyhrZXkpKSB7DQogICAgICAgIHJldHVybiByZXM7DQogICAgICB9DQogICAgICBpZiAoIWlzUmVhZG9ubHkyKSB7DQogICAgICAgIHRyYWNrKHRhcmdldCwgImdldCIsIGtleSk7DQogICAgICB9DQogICAgICBpZiAoaXNTaGFsbG93Mikgew0KICAgICAgICByZXR1cm4gcmVzOw0KICAgICAgfQ0KICAgICAgaWYgKGlzUmVmKHJlcykpIHsNCiAgICAgICAgcmV0dXJuIHRhcmdldElzQXJyYXkgJiYgaXNJbnRlZ2VyS2V5KGtleSkgPyByZXMgOiByZXMudmFsdWU7DQogICAgICB9DQogICAgICBpZiAoaXNPYmplY3QocmVzKSkgew0KICAgICAgICByZXR1cm4gaXNSZWFkb25seTIgPyByZWFkb25seShyZXMpIDogcmVhY3RpdmUocmVzKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiByZXM7DQogICAgfQ0KICB9DQogIGNsYXNzIE11dGFibGVSZWFjdGl2ZUhhbmRsZXIgZXh0ZW5kcyBCYXNlUmVhY3RpdmVIYW5kbGVyIHsNCiAgICBjb25zdHJ1Y3Rvcihpc1NoYWxsb3cyID0gZmFsc2UpIHsNCiAgICAgIHN1cGVyKGZhbHNlLCBpc1NoYWxsb3cyKTsNCiAgICB9DQogICAgc2V0KHRhcmdldCwga2V5LCB2YWx1ZSwgcmVjZWl2ZXIpIHsNCiAgICAgIGxldCBvbGRWYWx1ZSA9IHRhcmdldFtrZXldOw0KICAgICAgaWYgKCF0aGlzLl9pc1NoYWxsb3cpIHsNCiAgICAgICAgY29uc3QgaXNPbGRWYWx1ZVJlYWRvbmx5ID0gaXNSZWFkb25seShvbGRWYWx1ZSk7DQogICAgICAgIGlmICghaXNTaGFsbG93KHZhbHVlKSAmJiAhaXNSZWFkb25seSh2YWx1ZSkpIHsNCiAgICAgICAgICBvbGRWYWx1ZSA9IHRvUmF3KG9sZFZhbHVlKTsNCiAgICAgICAgICB2YWx1ZSA9IHRvUmF3KHZhbHVlKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIWlzQXJyYXkodGFyZ2V0KSAmJiBpc1JlZihvbGRWYWx1ZSkgJiYgIWlzUmVmKHZhbHVlKSkgew0KICAgICAgICAgIGlmIChpc09sZFZhbHVlUmVhZG9ubHkpIHsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgb2xkVmFsdWUudmFsdWUgPSB2YWx1ZTsNCiAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgY29uc3QgaGFkS2V5ID0gaXNBcnJheSh0YXJnZXQpICYmIGlzSW50ZWdlcktleShrZXkpID8gTnVtYmVyKGtleSkgPCB0YXJnZXQubGVuZ3RoIDogaGFzT3duKHRhcmdldCwga2V5KTsNCiAgICAgIGNvbnN0IHJlc3VsdCA9IFJlZmxlY3Quc2V0KA0KICAgICAgICB0YXJnZXQsDQogICAgICAgIGtleSwNCiAgICAgICAgdmFsdWUsDQogICAgICAgIGlzUmVmKHRhcmdldCkgPyB0YXJnZXQgOiByZWNlaXZlcg0KICAgICAgKTsNCiAgICAgIGlmICh0YXJnZXQgPT09IHRvUmF3KHJlY2VpdmVyKSkgew0KICAgICAgICBpZiAoIWhhZEtleSkgew0KICAgICAgICAgIHRyaWdnZXIodGFyZ2V0LCAiYWRkIiwga2V5LCB2YWx1ZSk7DQogICAgICAgIH0gZWxzZSBpZiAoaGFzQ2hhbmdlZCh2YWx1ZSwgb2xkVmFsdWUpKSB7DQogICAgICAgICAgdHJpZ2dlcih0YXJnZXQsICJzZXQiLCBrZXksIHZhbHVlLCBvbGRWYWx1ZSk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHJldHVybiByZXN1bHQ7DQogICAgfQ0KICAgIGRlbGV0ZVByb3BlcnR5KHRhcmdldCwga2V5KSB7DQogICAgICBjb25zdCBoYWRLZXkgPSBoYXNPd24odGFyZ2V0LCBrZXkpOw0KICAgICAgY29uc3Qgb2xkVmFsdWUgPSB0YXJnZXRba2V5XTsNCiAgICAgIGNvbnN0IHJlc3VsdCA9IFJlZmxlY3QuZGVsZXRlUHJvcGVydHkodGFyZ2V0LCBrZXkpOw0KICAgICAgaWYgKHJlc3VsdCAmJiBoYWRLZXkpIHsNCiAgICAgICAgdHJpZ2dlcih0YXJnZXQsICJkZWxldGUiLCBrZXksIHZvaWQgMCwgb2xkVmFsdWUpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICB9DQogICAgaGFzKHRhcmdldCwga2V5KSB7DQogICAgICBjb25zdCByZXN1bHQgPSBSZWZsZWN0Lmhhcyh0YXJnZXQsIGtleSk7DQogICAgICBpZiAoIWlzU3ltYm9sKGtleSkgfHwgIWJ1aWx0SW5TeW1ib2xzLmhhcyhrZXkpKSB7DQogICAgICAgIHRyYWNrKHRhcmdldCwgImhhcyIsIGtleSk7DQogICAgICB9DQogICAgICByZXR1cm4gcmVzdWx0Ow0KICAgIH0NCiAgICBvd25LZXlzKHRhcmdldCkgew0KICAgICAgdHJhY2soDQogICAgICAgIHRhcmdldCwNCiAgICAgICAgIml0ZXJhdGUiLA0KICAgICAgICBpc0FycmF5KHRhcmdldCkgPyAibGVuZ3RoIiA6IElURVJBVEVfS0VZDQogICAgICApOw0KICAgICAgcmV0dXJuIFJlZmxlY3Qub3duS2V5cyh0YXJnZXQpOw0KICAgIH0NCiAgfQ0KICBjbGFzcyBSZWFkb25seVJlYWN0aXZlSGFuZGxlciBleHRlbmRzIEJhc2VSZWFjdGl2ZUhhbmRsZXIgew0KICAgIGNvbnN0cnVjdG9yKGlzU2hhbGxvdzIgPSBmYWxzZSkgew0KICAgICAgc3VwZXIodHJ1ZSwgaXNTaGFsbG93Mik7DQogICAgfQ0KICAgIHNldCh0YXJnZXQsIGtleSkgew0KICAgICAgew0KICAgICAgICB3YXJuJDIoDQogICAgICAgICAgYFNldCBvcGVyYXRpb24gb24ga2V5ICIke1N0cmluZyhrZXkpfSIgZmFpbGVkOiB0YXJnZXQgaXMgcmVhZG9ubHkuYCwNCiAgICAgICAgICB0YXJnZXQNCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgICBkZWxldGVQcm9wZXJ0eSh0YXJnZXQsIGtleSkgew0KICAgICAgew0KICAgICAgICB3YXJuJDIoDQogICAgICAgICAgYERlbGV0ZSBvcGVyYXRpb24gb24ga2V5ICIke1N0cmluZyhrZXkpfSIgZmFpbGVkOiB0YXJnZXQgaXMgcmVhZG9ubHkuYCwNCiAgICAgICAgICB0YXJnZXQNCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgfQ0KICBjb25zdCBtdXRhYmxlSGFuZGxlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE11dGFibGVSZWFjdGl2ZUhhbmRsZXIoKTsNCiAgY29uc3QgcmVhZG9ubHlIYW5kbGVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgUmVhZG9ubHlSZWFjdGl2ZUhhbmRsZXIoKTsNCiAgY29uc3Qgc2hhbGxvd1JlYWN0aXZlSGFuZGxlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE11dGFibGVSZWFjdGl2ZUhhbmRsZXIodHJ1ZSk7DQogIGNvbnN0IHNoYWxsb3dSZWFkb25seUhhbmRsZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBSZWFkb25seVJlYWN0aXZlSGFuZGxlcih0cnVlKTsNCg0KICBjb25zdCB0b1NoYWxsb3cgPSAodmFsdWUpID0+IHZhbHVlOw0KICBjb25zdCBnZXRQcm90byA9ICh2KSA9PiBSZWZsZWN0LmdldFByb3RvdHlwZU9mKHYpOw0KICBmdW5jdGlvbiBjcmVhdGVJdGVyYWJsZU1ldGhvZChtZXRob2QsIGlzUmVhZG9ubHkyLCBpc1NoYWxsb3cyKSB7DQogICAgcmV0dXJuIGZ1bmN0aW9uKC4uLmFyZ3MpIHsNCiAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXNbIl9fdl9yYXciXTsNCiAgICAgIGNvbnN0IHJhd1RhcmdldCA9IHRvUmF3KHRhcmdldCk7DQogICAgICBjb25zdCB0YXJnZXRJc01hcCA9IGlzTWFwKHJhd1RhcmdldCk7DQogICAgICBjb25zdCBpc1BhaXIgPSBtZXRob2QgPT09ICJlbnRyaWVzIiB8fCBtZXRob2QgPT09IFN5bWJvbC5pdGVyYXRvciAmJiB0YXJnZXRJc01hcDsNCiAgICAgIGNvbnN0IGlzS2V5T25seSA9IG1ldGhvZCA9PT0gImtleXMiICYmIHRhcmdldElzTWFwOw0KICAgICAgY29uc3QgaW5uZXJJdGVyYXRvciA9IHRhcmdldFttZXRob2RdKC4uLmFyZ3MpOw0KICAgICAgY29uc3Qgd3JhcCA9IGlzU2hhbGxvdzIgPyB0b1NoYWxsb3cgOiBpc1JlYWRvbmx5MiA/IHRvUmVhZG9ubHkgOiB0b1JlYWN0aXZlOw0KICAgICAgIWlzUmVhZG9ubHkyICYmIHRyYWNrKA0KICAgICAgICByYXdUYXJnZXQsDQogICAgICAgICJpdGVyYXRlIiwNCiAgICAgICAgaXNLZXlPbmx5ID8gTUFQX0tFWV9JVEVSQVRFX0tFWSA6IElURVJBVEVfS0VZDQogICAgICApOw0KICAgICAgcmV0dXJuIHsNCiAgICAgICAgLy8gaXRlcmF0b3IgcHJvdG9jb2wNCiAgICAgICAgbmV4dCgpIHsNCiAgICAgICAgICBjb25zdCB7IHZhbHVlLCBkb25lIH0gPSBpbm5lckl0ZXJhdG9yLm5leHQoKTsNCiAgICAgICAgICByZXR1cm4gZG9uZSA/IHsgdmFsdWUsIGRvbmUgfSA6IHsNCiAgICAgICAgICAgIHZhbHVlOiBpc1BhaXIgPyBbd3JhcCh2YWx1ZVswXSksIHdyYXAodmFsdWVbMV0pXSA6IHdyYXAodmFsdWUpLA0KICAgICAgICAgICAgZG9uZQ0KICAgICAgICAgIH07DQogICAgICAgIH0sDQogICAgICAgIC8vIGl0ZXJhYmxlIHByb3RvY29sDQogICAgICAgIFtTeW1ib2wuaXRlcmF0b3JdKCkgew0KICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQogICAgICB9Ow0KICAgIH07DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlUmVhZG9ubHlNZXRob2QodHlwZSkgew0KICAgIHJldHVybiBmdW5jdGlvbiguLi5hcmdzKSB7DQogICAgICB7DQogICAgICAgIGNvbnN0IGtleSA9IGFyZ3NbMF0gPyBgb24ga2V5ICIke2FyZ3NbMF19IiBgIDogYGA7DQogICAgICAgIHdhcm4kMigNCiAgICAgICAgICBgJHtjYXBpdGFsaXplKHR5cGUpfSBvcGVyYXRpb24gJHtrZXl9ZmFpbGVkOiB0YXJnZXQgaXMgcmVhZG9ubHkuYCwNCiAgICAgICAgICB0b1Jhdyh0aGlzKQ0KICAgICAgICApOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIHR5cGUgPT09ICJkZWxldGUiID8gZmFsc2UgOiB0eXBlID09PSAiY2xlYXIiID8gdm9pZCAwIDogdGhpczsNCiAgICB9Ow0KICB9DQogIGZ1bmN0aW9uIGNyZWF0ZUluc3RydW1lbnRhdGlvbnMocmVhZG9ubHksIHNoYWxsb3cpIHsNCiAgICBjb25zdCBpbnN0cnVtZW50YXRpb25zID0gew0KICAgICAgZ2V0KGtleSkgew0KICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzWyJfX3ZfcmF3Il07DQogICAgICAgIGNvbnN0IHJhd1RhcmdldCA9IHRvUmF3KHRhcmdldCk7DQogICAgICAgIGNvbnN0IHJhd0tleSA9IHRvUmF3KGtleSk7DQogICAgICAgIGlmICghcmVhZG9ubHkpIHsNCiAgICAgICAgICBpZiAoaGFzQ2hhbmdlZChrZXksIHJhd0tleSkpIHsNCiAgICAgICAgICAgIHRyYWNrKHJhd1RhcmdldCwgImdldCIsIGtleSk7DQogICAgICAgICAgfQ0KICAgICAgICAgIHRyYWNrKHJhd1RhcmdldCwgImdldCIsIHJhd0tleSk7DQogICAgICAgIH0NCiAgICAgICAgY29uc3QgeyBoYXMgfSA9IGdldFByb3RvKHJhd1RhcmdldCk7DQogICAgICAgIGNvbnN0IHdyYXAgPSBzaGFsbG93ID8gdG9TaGFsbG93IDogcmVhZG9ubHkgPyB0b1JlYWRvbmx5IDogdG9SZWFjdGl2ZTsNCiAgICAgICAgaWYgKGhhcy5jYWxsKHJhd1RhcmdldCwga2V5KSkgew0KICAgICAgICAgIHJldHVybiB3cmFwKHRhcmdldC5nZXQoa2V5KSk7DQogICAgICAgIH0gZWxzZSBpZiAoaGFzLmNhbGwocmF3VGFyZ2V0LCByYXdLZXkpKSB7DQogICAgICAgICAgcmV0dXJuIHdyYXAodGFyZ2V0LmdldChyYXdLZXkpKTsNCiAgICAgICAgfSBlbHNlIGlmICh0YXJnZXQgIT09IHJhd1RhcmdldCkgew0KICAgICAgICAgIHRhcmdldC5nZXQoa2V5KTsNCiAgICAgICAgfQ0KICAgICAgfSwNCiAgICAgIGdldCBzaXplKCkgew0KICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzWyJfX3ZfcmF3Il07DQogICAgICAgICFyZWFkb25seSAmJiB0cmFjayh0b1Jhdyh0YXJnZXQpLCAiaXRlcmF0ZSIsIElURVJBVEVfS0VZKTsNCiAgICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0KHRhcmdldCwgInNpemUiLCB0YXJnZXQpOw0KICAgICAgfSwNCiAgICAgIGhhcyhrZXkpIHsNCiAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpc1siX192X3JhdyJdOw0KICAgICAgICBjb25zdCByYXdUYXJnZXQgPSB0b1Jhdyh0YXJnZXQpOw0KICAgICAgICBjb25zdCByYXdLZXkgPSB0b1JhdyhrZXkpOw0KICAgICAgICBpZiAoIXJlYWRvbmx5KSB7DQogICAgICAgICAgaWYgKGhhc0NoYW5nZWQoa2V5LCByYXdLZXkpKSB7DQogICAgICAgICAgICB0cmFjayhyYXdUYXJnZXQsICJoYXMiLCBrZXkpOw0KICAgICAgICAgIH0NCiAgICAgICAgICB0cmFjayhyYXdUYXJnZXQsICJoYXMiLCByYXdLZXkpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBrZXkgPT09IHJhd0tleSA/IHRhcmdldC5oYXMoa2V5KSA6IHRhcmdldC5oYXMoa2V5KSB8fCB0YXJnZXQuaGFzKHJhd0tleSk7DQogICAgICB9LA0KICAgICAgZm9yRWFjaChjYWxsYmFjaywgdGhpc0FyZykgew0KICAgICAgICBjb25zdCBvYnNlcnZlZCA9IHRoaXM7DQogICAgICAgIGNvbnN0IHRhcmdldCA9IG9ic2VydmVkWyJfX3ZfcmF3Il07DQogICAgICAgIGNvbnN0IHJhd1RhcmdldCA9IHRvUmF3KHRhcmdldCk7DQogICAgICAgIGNvbnN0IHdyYXAgPSBzaGFsbG93ID8gdG9TaGFsbG93IDogcmVhZG9ubHkgPyB0b1JlYWRvbmx5IDogdG9SZWFjdGl2ZTsNCiAgICAgICAgIXJlYWRvbmx5ICYmIHRyYWNrKHJhd1RhcmdldCwgIml0ZXJhdGUiLCBJVEVSQVRFX0tFWSk7DQogICAgICAgIHJldHVybiB0YXJnZXQuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4gew0KICAgICAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKHRoaXNBcmcsIHdyYXAodmFsdWUpLCB3cmFwKGtleSksIG9ic2VydmVkKTsNCiAgICAgICAgfSk7DQogICAgICB9DQogICAgfTsNCiAgICBleHRlbmQoDQogICAgICBpbnN0cnVtZW50YXRpb25zLA0KICAgICAgcmVhZG9ubHkgPyB7DQogICAgICAgIGFkZDogY3JlYXRlUmVhZG9ubHlNZXRob2QoImFkZCIpLA0KICAgICAgICBzZXQ6IGNyZWF0ZVJlYWRvbmx5TWV0aG9kKCJzZXQiKSwNCiAgICAgICAgZGVsZXRlOiBjcmVhdGVSZWFkb25seU1ldGhvZCgiZGVsZXRlIiksDQogICAgICAgIGNsZWFyOiBjcmVhdGVSZWFkb25seU1ldGhvZCgiY2xlYXIiKQ0KICAgICAgfSA6IHsNCiAgICAgICAgYWRkKHZhbHVlKSB7DQogICAgICAgICAgaWYgKCFzaGFsbG93ICYmICFpc1NoYWxsb3codmFsdWUpICYmICFpc1JlYWRvbmx5KHZhbHVlKSkgew0KICAgICAgICAgICAgdmFsdWUgPSB0b1Jhdyh2YWx1ZSk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRvUmF3KHRoaXMpOw0KICAgICAgICAgIGNvbnN0IHByb3RvID0gZ2V0UHJvdG8odGFyZ2V0KTsNCiAgICAgICAgICBjb25zdCBoYWRLZXkgPSBwcm90by5oYXMuY2FsbCh0YXJnZXQsIHZhbHVlKTsNCiAgICAgICAgICBpZiAoIWhhZEtleSkgew0KICAgICAgICAgICAgdGFyZ2V0LmFkZCh2YWx1ZSk7DQogICAgICAgICAgICB0cmlnZ2VyKHRhcmdldCwgImFkZCIsIHZhbHVlLCB2YWx1ZSk7DQogICAgICAgICAgfQ0KICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9LA0KICAgICAgICBzZXQoa2V5LCB2YWx1ZSkgew0KICAgICAgICAgIGlmICghc2hhbGxvdyAmJiAhaXNTaGFsbG93KHZhbHVlKSAmJiAhaXNSZWFkb25seSh2YWx1ZSkpIHsNCiAgICAgICAgICAgIHZhbHVlID0gdG9SYXcodmFsdWUpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0b1Jhdyh0aGlzKTsNCiAgICAgICAgICBjb25zdCB7IGhhcywgZ2V0IH0gPSBnZXRQcm90byh0YXJnZXQpOw0KICAgICAgICAgIGxldCBoYWRLZXkgPSBoYXMuY2FsbCh0YXJnZXQsIGtleSk7DQogICAgICAgICAgaWYgKCFoYWRLZXkpIHsNCiAgICAgICAgICAgIGtleSA9IHRvUmF3KGtleSk7DQogICAgICAgICAgICBoYWRLZXkgPSBoYXMuY2FsbCh0YXJnZXQsIGtleSk7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGNoZWNrSWRlbnRpdHlLZXlzKHRhcmdldCwgaGFzLCBrZXkpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IGdldC5jYWxsKHRhcmdldCwga2V5KTsNCiAgICAgICAgICB0YXJnZXQuc2V0KGtleSwgdmFsdWUpOw0KICAgICAgICAgIGlmICghaGFkS2V5KSB7DQogICAgICAgICAgICB0cmlnZ2VyKHRhcmdldCwgImFkZCIsIGtleSwgdmFsdWUpOw0KICAgICAgICAgIH0gZWxzZSBpZiAoaGFzQ2hhbmdlZCh2YWx1ZSwgb2xkVmFsdWUpKSB7DQogICAgICAgICAgICB0cmlnZ2VyKHRhcmdldCwgInNldCIsIGtleSwgdmFsdWUsIG9sZFZhbHVlKTsNCiAgICAgICAgICB9DQogICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0sDQogICAgICAgIGRlbGV0ZShrZXkpIHsNCiAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0b1Jhdyh0aGlzKTsNCiAgICAgICAgICBjb25zdCB7IGhhcywgZ2V0IH0gPSBnZXRQcm90byh0YXJnZXQpOw0KICAgICAgICAgIGxldCBoYWRLZXkgPSBoYXMuY2FsbCh0YXJnZXQsIGtleSk7DQogICAgICAgICAgaWYgKCFoYWRLZXkpIHsNCiAgICAgICAgICAgIGtleSA9IHRvUmF3KGtleSk7DQogICAgICAgICAgICBoYWRLZXkgPSBoYXMuY2FsbCh0YXJnZXQsIGtleSk7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGNoZWNrSWRlbnRpdHlLZXlzKHRhcmdldCwgaGFzLCBrZXkpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IGdldCA/IGdldC5jYWxsKHRhcmdldCwga2V5KSA6IHZvaWQgMDsNCiAgICAgICAgICBjb25zdCByZXN1bHQgPSB0YXJnZXQuZGVsZXRlKGtleSk7DQogICAgICAgICAgaWYgKGhhZEtleSkgew0KICAgICAgICAgICAgdHJpZ2dlcih0YXJnZXQsICJkZWxldGUiLCBrZXksIHZvaWQgMCwgb2xkVmFsdWUpOw0KICAgICAgICAgIH0NCiAgICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgICB9LA0KICAgICAgICBjbGVhcigpIHsNCiAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0b1Jhdyh0aGlzKTsNCiAgICAgICAgICBjb25zdCBoYWRJdGVtcyA9IHRhcmdldC5zaXplICE9PSAwOw0KICAgICAgICAgIGNvbnN0IG9sZFRhcmdldCA9IGlzTWFwKHRhcmdldCkgPyBuZXcgTWFwKHRhcmdldCkgOiBuZXcgU2V0KHRhcmdldCkgOw0KICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHRhcmdldC5jbGVhcigpOw0KICAgICAgICAgIGlmIChoYWRJdGVtcykgew0KICAgICAgICAgICAgdHJpZ2dlcigNCiAgICAgICAgICAgICAgdGFyZ2V0LA0KICAgICAgICAgICAgICAiY2xlYXIiLA0KICAgICAgICAgICAgICB2b2lkIDAsDQogICAgICAgICAgICAgIHZvaWQgMCwNCiAgICAgICAgICAgICAgb2xkVGFyZ2V0DQogICAgICAgICAgICApOw0KICAgICAgICAgIH0NCiAgICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgICB9DQogICAgICB9DQogICAgKTsNCiAgICBjb25zdCBpdGVyYXRvck1ldGhvZHMgPSBbDQogICAgICAia2V5cyIsDQogICAgICAidmFsdWVzIiwNCiAgICAgICJlbnRyaWVzIiwNCiAgICAgIFN5bWJvbC5pdGVyYXRvcg0KICAgIF07DQogICAgaXRlcmF0b3JNZXRob2RzLmZvckVhY2goKG1ldGhvZCkgPT4gew0KICAgICAgaW5zdHJ1bWVudGF0aW9uc1ttZXRob2RdID0gY3JlYXRlSXRlcmFibGVNZXRob2QobWV0aG9kLCByZWFkb25seSwgc2hhbGxvdyk7DQogICAgfSk7DQogICAgcmV0dXJuIGluc3RydW1lbnRhdGlvbnM7DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlSW5zdHJ1bWVudGF0aW9uR2V0dGVyKGlzUmVhZG9ubHkyLCBzaGFsbG93KSB7DQogICAgY29uc3QgaW5zdHJ1bWVudGF0aW9ucyA9IGNyZWF0ZUluc3RydW1lbnRhdGlvbnMoaXNSZWFkb25seTIsIHNoYWxsb3cpOw0KICAgIHJldHVybiAodGFyZ2V0LCBrZXksIHJlY2VpdmVyKSA9PiB7DQogICAgICBpZiAoa2V5ID09PSAiX192X2lzUmVhY3RpdmUiKSB7DQogICAgICAgIHJldHVybiAhaXNSZWFkb25seTI7DQogICAgICB9IGVsc2UgaWYgKGtleSA9PT0gIl9fdl9pc1JlYWRvbmx5Iikgew0KICAgICAgICByZXR1cm4gaXNSZWFkb25seTI7DQogICAgICB9IGVsc2UgaWYgKGtleSA9PT0gIl9fdl9yYXciKSB7DQogICAgICAgIHJldHVybiB0YXJnZXQ7DQogICAgICB9DQogICAgICByZXR1cm4gUmVmbGVjdC5nZXQoDQogICAgICAgIGhhc093bihpbnN0cnVtZW50YXRpb25zLCBrZXkpICYmIGtleSBpbiB0YXJnZXQgPyBpbnN0cnVtZW50YXRpb25zIDogdGFyZ2V0LA0KICAgICAgICBrZXksDQogICAgICAgIHJlY2VpdmVyDQogICAgICApOw0KICAgIH07DQogIH0NCiAgY29uc3QgbXV0YWJsZUNvbGxlY3Rpb25IYW5kbGVycyA9IHsNCiAgICBnZXQ6IC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVJbnN0cnVtZW50YXRpb25HZXR0ZXIoZmFsc2UsIGZhbHNlKQ0KICB9Ow0KICBjb25zdCBzaGFsbG93Q29sbGVjdGlvbkhhbmRsZXJzID0gew0KICAgIGdldDogLyogQF9fUFVSRV9fICovIGNyZWF0ZUluc3RydW1lbnRhdGlvbkdldHRlcihmYWxzZSwgdHJ1ZSkNCiAgfTsNCiAgY29uc3QgcmVhZG9ubHlDb2xsZWN0aW9uSGFuZGxlcnMgPSB7DQogICAgZ2V0OiAvKiBAX19QVVJFX18gKi8gY3JlYXRlSW5zdHJ1bWVudGF0aW9uR2V0dGVyKHRydWUsIGZhbHNlKQ0KICB9Ow0KICBjb25zdCBzaGFsbG93UmVhZG9ubHlDb2xsZWN0aW9uSGFuZGxlcnMgPSB7DQogICAgZ2V0OiAvKiBAX19QVVJFX18gKi8gY3JlYXRlSW5zdHJ1bWVudGF0aW9uR2V0dGVyKHRydWUsIHRydWUpDQogIH07DQogIGZ1bmN0aW9uIGNoZWNrSWRlbnRpdHlLZXlzKHRhcmdldCwgaGFzLCBrZXkpIHsNCiAgICBjb25zdCByYXdLZXkgPSB0b1JhdyhrZXkpOw0KICAgIGlmIChyYXdLZXkgIT09IGtleSAmJiBoYXMuY2FsbCh0YXJnZXQsIHJhd0tleSkpIHsNCiAgICAgIGNvbnN0IHR5cGUgPSB0b1Jhd1R5cGUodGFyZ2V0KTsNCiAgICAgIHdhcm4kMigNCiAgICAgICAgYFJlYWN0aXZlICR7dHlwZX0gY29udGFpbnMgYm90aCB0aGUgcmF3IGFuZCByZWFjdGl2ZSB2ZXJzaW9ucyBvZiB0aGUgc2FtZSBvYmplY3Qke3R5cGUgPT09IGBNYXBgID8gYCBhcyBrZXlzYCA6IGBgfSwgd2hpY2ggY2FuIGxlYWQgdG8gaW5jb25zaXN0ZW5jaWVzLiBBdm9pZCBkaWZmZXJlbnRpYXRpbmcgYmV0d2VlbiB0aGUgcmF3IGFuZCByZWFjdGl2ZSB2ZXJzaW9ucyBvZiBhbiBvYmplY3QgYW5kIG9ubHkgdXNlIHRoZSByZWFjdGl2ZSB2ZXJzaW9uIGlmIHBvc3NpYmxlLmANCiAgICAgICk7DQogICAgfQ0KICB9DQoNCiAgY29uc3QgcmVhY3RpdmVNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsNCiAgY29uc3Qgc2hhbGxvd1JlYWN0aXZlTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7DQogIGNvbnN0IHJlYWRvbmx5TWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7DQogIGNvbnN0IHNoYWxsb3dSZWFkb25seU1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOw0KICBmdW5jdGlvbiB0YXJnZXRUeXBlTWFwKHJhd1R5cGUpIHsNCiAgICBzd2l0Y2ggKHJhd1R5cGUpIHsNCiAgICAgIGNhc2UgIk9iamVjdCI6DQogICAgICBjYXNlICJBcnJheSI6DQogICAgICAgIHJldHVybiAxIC8qIENPTU1PTiAqLzsNCiAgICAgIGNhc2UgIk1hcCI6DQogICAgICBjYXNlICJTZXQiOg0KICAgICAgY2FzZSAiV2Vha01hcCI6DQogICAgICBjYXNlICJXZWFrU2V0IjoNCiAgICAgICAgcmV0dXJuIDIgLyogQ09MTEVDVElPTiAqLzsNCiAgICAgIGRlZmF1bHQ6DQogICAgICAgIHJldHVybiAwIC8qIElOVkFMSUQgKi87DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGdldFRhcmdldFR5cGUodmFsdWUpIHsNCiAgICByZXR1cm4gdmFsdWVbIl9fdl9za2lwIl0gfHwgIU9iamVjdC5pc0V4dGVuc2libGUodmFsdWUpID8gMCAvKiBJTlZBTElEICovIDogdGFyZ2V0VHlwZU1hcCh0b1Jhd1R5cGUodmFsdWUpKTsNCiAgfQ0KICBmdW5jdGlvbiByZWFjdGl2ZSh0YXJnZXQpIHsNCiAgICBpZiAoaXNSZWFkb25seSh0YXJnZXQpKSB7DQogICAgICByZXR1cm4gdGFyZ2V0Ow0KICAgIH0NCiAgICByZXR1cm4gY3JlYXRlUmVhY3RpdmVPYmplY3QoDQogICAgICB0YXJnZXQsDQogICAgICBmYWxzZSwNCiAgICAgIG11dGFibGVIYW5kbGVycywNCiAgICAgIG11dGFibGVDb2xsZWN0aW9uSGFuZGxlcnMsDQogICAgICByZWFjdGl2ZU1hcA0KICAgICk7DQogIH0NCiAgZnVuY3Rpb24gc2hhbGxvd1JlYWN0aXZlKHRhcmdldCkgew0KICAgIHJldHVybiBjcmVhdGVSZWFjdGl2ZU9iamVjdCgNCiAgICAgIHRhcmdldCwNCiAgICAgIGZhbHNlLA0KICAgICAgc2hhbGxvd1JlYWN0aXZlSGFuZGxlcnMsDQogICAgICBzaGFsbG93Q29sbGVjdGlvbkhhbmRsZXJzLA0KICAgICAgc2hhbGxvd1JlYWN0aXZlTWFwDQogICAgKTsNCiAgfQ0KICBmdW5jdGlvbiByZWFkb25seSh0YXJnZXQpIHsNCiAgICByZXR1cm4gY3JlYXRlUmVhY3RpdmVPYmplY3QoDQogICAgICB0YXJnZXQsDQogICAgICB0cnVlLA0KICAgICAgcmVhZG9ubHlIYW5kbGVycywNCiAgICAgIHJlYWRvbmx5Q29sbGVjdGlvbkhhbmRsZXJzLA0KICAgICAgcmVhZG9ubHlNYXANCiAgICApOw0KICB9DQogIGZ1bmN0aW9uIHNoYWxsb3dSZWFkb25seSh0YXJnZXQpIHsNCiAgICByZXR1cm4gY3JlYXRlUmVhY3RpdmVPYmplY3QoDQogICAgICB0YXJnZXQsDQogICAgICB0cnVlLA0KICAgICAgc2hhbGxvd1JlYWRvbmx5SGFuZGxlcnMsDQogICAgICBzaGFsbG93UmVhZG9ubHlDb2xsZWN0aW9uSGFuZGxlcnMsDQogICAgICBzaGFsbG93UmVhZG9ubHlNYXANCiAgICApOw0KICB9DQogIGZ1bmN0aW9uIGNyZWF0ZVJlYWN0aXZlT2JqZWN0KHRhcmdldCwgaXNSZWFkb25seTIsIGJhc2VIYW5kbGVycywgY29sbGVjdGlvbkhhbmRsZXJzLCBwcm94eU1hcCkgew0KICAgIGlmICghaXNPYmplY3QodGFyZ2V0KSkgew0KICAgICAgew0KICAgICAgICB3YXJuJDIoDQogICAgICAgICAgYHZhbHVlIGNhbm5vdCBiZSBtYWRlICR7aXNSZWFkb25seTIgPyAicmVhZG9ubHkiIDogInJlYWN0aXZlIn06ICR7U3RyaW5nKA0KICAgICAgICAgIHRhcmdldA0KICAgICAgICApfWANCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiB0YXJnZXQ7DQogICAgfQ0KICAgIGlmICh0YXJnZXRbIl9fdl9yYXciXSAmJiAhKGlzUmVhZG9ubHkyICYmIHRhcmdldFsiX192X2lzUmVhY3RpdmUiXSkpIHsNCiAgICAgIHJldHVybiB0YXJnZXQ7DQogICAgfQ0KICAgIGNvbnN0IHRhcmdldFR5cGUgPSBnZXRUYXJnZXRUeXBlKHRhcmdldCk7DQogICAgaWYgKHRhcmdldFR5cGUgPT09IDAgLyogSU5WQUxJRCAqLykgew0KICAgICAgcmV0dXJuIHRhcmdldDsNCiAgICB9DQogICAgY29uc3QgZXhpc3RpbmdQcm94eSA9IHByb3h5TWFwLmdldCh0YXJnZXQpOw0KICAgIGlmIChleGlzdGluZ1Byb3h5KSB7DQogICAgICByZXR1cm4gZXhpc3RpbmdQcm94eTsNCiAgICB9DQogICAgY29uc3QgcHJveHkgPSBuZXcgUHJveHkoDQogICAgICB0YXJnZXQsDQogICAgICB0YXJnZXRUeXBlID09PSAyIC8qIENPTExFQ1RJT04gKi8gPyBjb2xsZWN0aW9uSGFuZGxlcnMgOiBiYXNlSGFuZGxlcnMNCiAgICApOw0KICAgIHByb3h5TWFwLnNldCh0YXJnZXQsIHByb3h5KTsNCiAgICByZXR1cm4gcHJveHk7DQogIH0NCiAgZnVuY3Rpb24gaXNSZWFjdGl2ZSh2YWx1ZSkgew0KICAgIGlmIChpc1JlYWRvbmx5KHZhbHVlKSkgew0KICAgICAgcmV0dXJuIGlzUmVhY3RpdmUodmFsdWVbIl9fdl9yYXciXSk7DQogICAgfQ0KICAgIHJldHVybiAhISh2YWx1ZSAmJiB2YWx1ZVsiX192X2lzUmVhY3RpdmUiXSk7DQogIH0NCiAgZnVuY3Rpb24gaXNSZWFkb25seSh2YWx1ZSkgew0KICAgIHJldHVybiAhISh2YWx1ZSAmJiB2YWx1ZVsiX192X2lzUmVhZG9ubHkiXSk7DQogIH0NCiAgZnVuY3Rpb24gaXNTaGFsbG93KHZhbHVlKSB7DQogICAgcmV0dXJuICEhKHZhbHVlICYmIHZhbHVlWyJfX3ZfaXNTaGFsbG93Il0pOw0KICB9DQogIGZ1bmN0aW9uIGlzUHJveHkodmFsdWUpIHsNCiAgICByZXR1cm4gdmFsdWUgPyAhIXZhbHVlWyJfX3ZfcmF3Il0gOiBmYWxzZTsNCiAgfQ0KICBmdW5jdGlvbiB0b1JhdyhvYnNlcnZlZCkgew0KICAgIGNvbnN0IHJhdyA9IG9ic2VydmVkICYmIG9ic2VydmVkWyJfX3ZfcmF3Il07DQogICAgcmV0dXJuIHJhdyA/IHRvUmF3KHJhdykgOiBvYnNlcnZlZDsNCiAgfQ0KICBmdW5jdGlvbiBtYXJrUmF3KHZhbHVlKSB7DQogICAgaWYgKCFoYXNPd24odmFsdWUsICJfX3Zfc2tpcCIpICYmIE9iamVjdC5pc0V4dGVuc2libGUodmFsdWUpKSB7DQogICAgICBkZWYodmFsdWUsICJfX3Zfc2tpcCIsIHRydWUpOw0KICAgIH0NCiAgICByZXR1cm4gdmFsdWU7DQogIH0NCiAgY29uc3QgdG9SZWFjdGl2ZSA9ICh2YWx1ZSkgPT4gaXNPYmplY3QodmFsdWUpID8gcmVhY3RpdmUodmFsdWUpIDogdmFsdWU7DQogIGNvbnN0IHRvUmVhZG9ubHkgPSAodmFsdWUpID0+IGlzT2JqZWN0KHZhbHVlKSA/IHJlYWRvbmx5KHZhbHVlKSA6IHZhbHVlOw0KDQogIGZ1bmN0aW9uIGlzUmVmKHIpIHsNCiAgICByZXR1cm4gciA/IHJbIl9fdl9pc1JlZiJdID09PSB0cnVlIDogZmFsc2U7DQogIH0NCiAgZnVuY3Rpb24gcmVmKHZhbHVlKSB7DQogICAgcmV0dXJuIGNyZWF0ZVJlZih2YWx1ZSwgZmFsc2UpOw0KICB9DQogIGZ1bmN0aW9uIHNoYWxsb3dSZWYodmFsdWUpIHsNCiAgICByZXR1cm4gY3JlYXRlUmVmKHZhbHVlLCB0cnVlKTsNCiAgfQ0KICBmdW5jdGlvbiBjcmVhdGVSZWYocmF3VmFsdWUsIHNoYWxsb3cpIHsNCiAgICBpZiAoaXNSZWYocmF3VmFsdWUpKSB7DQogICAgICByZXR1cm4gcmF3VmFsdWU7DQogICAgfQ0KICAgIHJldHVybiBuZXcgUmVmSW1wbChyYXdWYWx1ZSwgc2hhbGxvdyk7DQogIH0NCiAgY2xhc3MgUmVmSW1wbCB7DQogICAgY29uc3RydWN0b3IodmFsdWUsIGlzU2hhbGxvdzIpIHsNCiAgICAgIHRoaXMuZGVwID0gbmV3IERlcCgpOw0KICAgICAgdGhpc1siX192X2lzUmVmIl0gPSB0cnVlOw0KICAgICAgdGhpc1siX192X2lzU2hhbGxvdyJdID0gZmFsc2U7DQogICAgICB0aGlzLl9yYXdWYWx1ZSA9IGlzU2hhbGxvdzIgPyB2YWx1ZSA6IHRvUmF3KHZhbHVlKTsNCiAgICAgIHRoaXMuX3ZhbHVlID0gaXNTaGFsbG93MiA/IHZhbHVlIDogdG9SZWFjdGl2ZSh2YWx1ZSk7DQogICAgICB0aGlzWyJfX3ZfaXNTaGFsbG93Il0gPSBpc1NoYWxsb3cyOw0KICAgIH0NCiAgICBnZXQgdmFsdWUoKSB7DQogICAgICB7DQogICAgICAgIHRoaXMuZGVwLnRyYWNrKHsNCiAgICAgICAgICB0YXJnZXQ6IHRoaXMsDQogICAgICAgICAgdHlwZTogImdldCIsDQogICAgICAgICAga2V5OiAidmFsdWUiDQogICAgICAgIH0pOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIHRoaXMuX3ZhbHVlOw0KICAgIH0NCiAgICBzZXQgdmFsdWUobmV3VmFsdWUpIHsNCiAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpcy5fcmF3VmFsdWU7DQogICAgICBjb25zdCB1c2VEaXJlY3RWYWx1ZSA9IHRoaXNbIl9fdl9pc1NoYWxsb3ciXSB8fCBpc1NoYWxsb3cobmV3VmFsdWUpIHx8IGlzUmVhZG9ubHkobmV3VmFsdWUpOw0KICAgICAgbmV3VmFsdWUgPSB1c2VEaXJlY3RWYWx1ZSA/IG5ld1ZhbHVlIDogdG9SYXcobmV3VmFsdWUpOw0KICAgICAgaWYgKGhhc0NoYW5nZWQobmV3VmFsdWUsIG9sZFZhbHVlKSkgew0KICAgICAgICB0aGlzLl9yYXdWYWx1ZSA9IG5ld1ZhbHVlOw0KICAgICAgICB0aGlzLl92YWx1ZSA9IHVzZURpcmVjdFZhbHVlID8gbmV3VmFsdWUgOiB0b1JlYWN0aXZlKG5ld1ZhbHVlKTsNCiAgICAgICAgew0KICAgICAgICAgIHRoaXMuZGVwLnRyaWdnZXIoew0KICAgICAgICAgICAgdGFyZ2V0OiB0aGlzLA0KICAgICAgICAgICAgdHlwZTogInNldCIsDQogICAgICAgICAgICBrZXk6ICJ2YWx1ZSIsDQogICAgICAgICAgICBuZXdWYWx1ZSwNCiAgICAgICAgICAgIG9sZFZhbHVlDQogICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gdHJpZ2dlclJlZihyZWYyKSB7DQogICAgaWYgKHJlZjIuZGVwKSB7DQogICAgICB7DQogICAgICAgIHJlZjIuZGVwLnRyaWdnZXIoew0KICAgICAgICAgIHRhcmdldDogcmVmMiwNCiAgICAgICAgICB0eXBlOiAic2V0IiwNCiAgICAgICAgICBrZXk6ICJ2YWx1ZSIsDQogICAgICAgICAgbmV3VmFsdWU6IHJlZjIuX3ZhbHVlDQogICAgICAgIH0pOw0KICAgICAgfQ0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiB1bnJlZihyZWYyKSB7DQogICAgcmV0dXJuIGlzUmVmKHJlZjIpID8gcmVmMi52YWx1ZSA6IHJlZjI7DQogIH0NCiAgZnVuY3Rpb24gdG9WYWx1ZShzb3VyY2UpIHsNCiAgICByZXR1cm4gaXNGdW5jdGlvbihzb3VyY2UpID8gc291cmNlKCkgOiB1bnJlZihzb3VyY2UpOw0KICB9DQogIGNvbnN0IHNoYWxsb3dVbndyYXBIYW5kbGVycyA9IHsNCiAgICBnZXQ6ICh0YXJnZXQsIGtleSwgcmVjZWl2ZXIpID0+IGtleSA9PT0gIl9fdl9yYXciID8gdGFyZ2V0IDogdW5yZWYoUmVmbGVjdC5nZXQodGFyZ2V0LCBrZXksIHJlY2VpdmVyKSksDQogICAgc2V0OiAodGFyZ2V0LCBrZXksIHZhbHVlLCByZWNlaXZlcikgPT4gew0KICAgICAgY29uc3Qgb2xkVmFsdWUgPSB0YXJnZXRba2V5XTsNCiAgICAgIGlmIChpc1JlZihvbGRWYWx1ZSkgJiYgIWlzUmVmKHZhbHVlKSkgew0KICAgICAgICBvbGRWYWx1ZS52YWx1ZSA9IHZhbHVlOw0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiBSZWZsZWN0LnNldCh0YXJnZXQsIGtleSwgdmFsdWUsIHJlY2VpdmVyKTsNCiAgICAgIH0NCiAgICB9DQogIH07DQogIGZ1bmN0aW9uIHByb3h5UmVmcyhvYmplY3RXaXRoUmVmcykgew0KICAgIHJldHVybiBpc1JlYWN0aXZlKG9iamVjdFdpdGhSZWZzKSA/IG9iamVjdFdpdGhSZWZzIDogbmV3IFByb3h5KG9iamVjdFdpdGhSZWZzLCBzaGFsbG93VW53cmFwSGFuZGxlcnMpOw0KICB9DQogIGNsYXNzIEN1c3RvbVJlZkltcGwgew0KICAgIGNvbnN0cnVjdG9yKGZhY3RvcnkpIHsNCiAgICAgIHRoaXNbIl9fdl9pc1JlZiJdID0gdHJ1ZTsNCiAgICAgIHRoaXMuX3ZhbHVlID0gdm9pZCAwOw0KICAgICAgY29uc3QgZGVwID0gdGhpcy5kZXAgPSBuZXcgRGVwKCk7DQogICAgICBjb25zdCB7IGdldCwgc2V0IH0gPSBmYWN0b3J5KGRlcC50cmFjay5iaW5kKGRlcCksIGRlcC50cmlnZ2VyLmJpbmQoZGVwKSk7DQogICAgICB0aGlzLl9nZXQgPSBnZXQ7DQogICAgICB0aGlzLl9zZXQgPSBzZXQ7DQogICAgfQ0KICAgIGdldCB2YWx1ZSgpIHsNCiAgICAgIHJldHVybiB0aGlzLl92YWx1ZSA9IHRoaXMuX2dldCgpOw0KICAgIH0NCiAgICBzZXQgdmFsdWUobmV3VmFsKSB7DQogICAgICB0aGlzLl9zZXQobmV3VmFsKTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gY3VzdG9tUmVmKGZhY3RvcnkpIHsNCiAgICByZXR1cm4gbmV3IEN1c3RvbVJlZkltcGwoZmFjdG9yeSk7DQogIH0NCiAgZnVuY3Rpb24gdG9SZWZzKG9iamVjdCkgew0KICAgIGlmICghaXNQcm94eShvYmplY3QpKSB7DQogICAgICB3YXJuJDIoYHRvUmVmcygpIGV4cGVjdHMgYSByZWFjdGl2ZSBvYmplY3QgYnV0IHJlY2VpdmVkIGEgcGxhaW4gb25lLmApOw0KICAgIH0NCiAgICBjb25zdCByZXQgPSBpc0FycmF5KG9iamVjdCkgPyBuZXcgQXJyYXkob2JqZWN0Lmxlbmd0aCkgOiB7fTsNCiAgICBmb3IgKGNvbnN0IGtleSBpbiBvYmplY3QpIHsNCiAgICAgIHJldFtrZXldID0gcHJvcGVydHlUb1JlZihvYmplY3QsIGtleSk7DQogICAgfQ0KICAgIHJldHVybiByZXQ7DQogIH0NCiAgY2xhc3MgT2JqZWN0UmVmSW1wbCB7DQogICAgY29uc3RydWN0b3IoX29iamVjdCwgX2tleSwgX2RlZmF1bHRWYWx1ZSkgew0KICAgICAgdGhpcy5fb2JqZWN0ID0gX29iamVjdDsNCiAgICAgIHRoaXMuX2tleSA9IF9rZXk7DQogICAgICB0aGlzLl9kZWZhdWx0VmFsdWUgPSBfZGVmYXVsdFZhbHVlOw0KICAgICAgdGhpc1siX192X2lzUmVmIl0gPSB0cnVlOw0KICAgICAgdGhpcy5fdmFsdWUgPSB2b2lkIDA7DQogICAgfQ0KICAgIGdldCB2YWx1ZSgpIHsNCiAgICAgIGNvbnN0IHZhbCA9IHRoaXMuX29iamVjdFt0aGlzLl9rZXldOw0KICAgICAgcmV0dXJuIHRoaXMuX3ZhbHVlID0gdmFsID09PSB2b2lkIDAgPyB0aGlzLl9kZWZhdWx0VmFsdWUgOiB2YWw7DQogICAgfQ0KICAgIHNldCB2YWx1ZShuZXdWYWwpIHsNCiAgICAgIHRoaXMuX29iamVjdFt0aGlzLl9rZXldID0gbmV3VmFsOw0KICAgIH0NCiAgICBnZXQgZGVwKCkgew0KICAgICAgcmV0dXJuIGdldERlcEZyb21SZWFjdGl2ZSh0b1Jhdyh0aGlzLl9vYmplY3QpLCB0aGlzLl9rZXkpOw0KICAgIH0NCiAgfQ0KICBjbGFzcyBHZXR0ZXJSZWZJbXBsIHsNCiAgICBjb25zdHJ1Y3RvcihfZ2V0dGVyKSB7DQogICAgICB0aGlzLl9nZXR0ZXIgPSBfZ2V0dGVyOw0KICAgICAgdGhpc1siX192X2lzUmVmIl0gPSB0cnVlOw0KICAgICAgdGhpc1siX192X2lzUmVhZG9ubHkiXSA9IHRydWU7DQogICAgICB0aGlzLl92YWx1ZSA9IHZvaWQgMDsNCiAgICB9DQogICAgZ2V0IHZhbHVlKCkgew0KICAgICAgcmV0dXJuIHRoaXMuX3ZhbHVlID0gdGhpcy5fZ2V0dGVyKCk7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIHRvUmVmKHNvdXJjZSwga2V5LCBkZWZhdWx0VmFsdWUpIHsNCiAgICBpZiAoaXNSZWYoc291cmNlKSkgew0KICAgICAgcmV0dXJuIHNvdXJjZTsNCiAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24oc291cmNlKSkgew0KICAgICAgcmV0dXJuIG5ldyBHZXR0ZXJSZWZJbXBsKHNvdXJjZSk7DQogICAgfSBlbHNlIGlmIChpc09iamVjdChzb3VyY2UpICYmIGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7DQogICAgICByZXR1cm4gcHJvcGVydHlUb1JlZihzb3VyY2UsIGtleSwgZGVmYXVsdFZhbHVlKTsNCiAgICB9IGVsc2Ugew0KICAgICAgcmV0dXJuIHJlZihzb3VyY2UpOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBwcm9wZXJ0eVRvUmVmKHNvdXJjZSwga2V5LCBkZWZhdWx0VmFsdWUpIHsNCiAgICBjb25zdCB2YWwgPSBzb3VyY2Vba2V5XTsNCiAgICByZXR1cm4gaXNSZWYodmFsKSA/IHZhbCA6IG5ldyBPYmplY3RSZWZJbXBsKHNvdXJjZSwga2V5LCBkZWZhdWx0VmFsdWUpOw0KICB9DQoNCiAgY2xhc3MgQ29tcHV0ZWRSZWZJbXBsIHsNCiAgICBjb25zdHJ1Y3Rvcihmbiwgc2V0dGVyLCBpc1NTUikgew0KICAgICAgdGhpcy5mbiA9IGZuOw0KICAgICAgdGhpcy5zZXR0ZXIgPSBzZXR0ZXI7DQogICAgICAvKioNCiAgICAgICAqIEBpbnRlcm5hbA0KICAgICAgICovDQogICAgICB0aGlzLl92YWx1ZSA9IHZvaWQgMDsNCiAgICAgIC8qKg0KICAgICAgICogQGludGVybmFsDQogICAgICAgKi8NCiAgICAgIHRoaXMuZGVwID0gbmV3IERlcCh0aGlzKTsNCiAgICAgIC8qKg0KICAgICAgICogQGludGVybmFsDQogICAgICAgKi8NCiAgICAgIHRoaXMuX192X2lzUmVmID0gdHJ1ZTsNCiAgICAgIC8vIFRPRE8gaXNvbGF0ZWREZWNsYXJhdGlvbnMgIl9fdl9pc1JlYWRvbmx5Ig0KICAgICAgLy8gQSBjb21wdXRlZCBpcyBhbHNvIGEgc3Vic2NyaWJlciB0aGF0IHRyYWNrcyBvdGhlciBkZXBzDQogICAgICAvKioNCiAgICAgICAqIEBpbnRlcm5hbA0KICAgICAgICovDQogICAgICB0aGlzLmRlcHMgPSB2b2lkIDA7DQogICAgICAvKioNCiAgICAgICAqIEBpbnRlcm5hbA0KICAgICAgICovDQogICAgICB0aGlzLmRlcHNUYWlsID0gdm9pZCAwOw0KICAgICAgLyoqDQogICAgICAgKiBAaW50ZXJuYWwNCiAgICAgICAqLw0KICAgICAgdGhpcy5mbGFncyA9IDE2Ow0KICAgICAgLyoqDQogICAgICAgKiBAaW50ZXJuYWwNCiAgICAgICAqLw0KICAgICAgdGhpcy5nbG9iYWxWZXJzaW9uID0gZ2xvYmFsVmVyc2lvbiAtIDE7DQogICAgICAvKioNCiAgICAgICAqIEBpbnRlcm5hbA0KICAgICAgICovDQogICAgICB0aGlzLm5leHQgPSB2b2lkIDA7DQogICAgICAvLyBmb3IgYmFja3dhcmRzIGNvbXBhdA0KICAgICAgdGhpcy5lZmZlY3QgPSB0aGlzOw0KICAgICAgdGhpc1siX192X2lzUmVhZG9ubHkiXSA9ICFzZXR0ZXI7DQogICAgICB0aGlzLmlzU1NSID0gaXNTU1I7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIEBpbnRlcm5hbA0KICAgICAqLw0KICAgIG5vdGlmeSgpIHsNCiAgICAgIHRoaXMuZmxhZ3MgfD0gMTY7DQogICAgICBpZiAoISh0aGlzLmZsYWdzICYgOCkgJiYgLy8gYXZvaWQgaW5maW5pdGUgc2VsZiByZWN1cnNpb24NCiAgICAgIGFjdGl2ZVN1YiAhPT0gdGhpcykgew0KICAgICAgICBiYXRjaCh0aGlzLCB0cnVlKTsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgfQ0KICAgIGdldCB2YWx1ZSgpIHsNCiAgICAgIGNvbnN0IGxpbmsgPSB0aGlzLmRlcC50cmFjayh7DQogICAgICAgIHRhcmdldDogdGhpcywNCiAgICAgICAgdHlwZTogImdldCIsDQogICAgICAgIGtleTogInZhbHVlIg0KICAgICAgfSkgOw0KICAgICAgcmVmcmVzaENvbXB1dGVkKHRoaXMpOw0KICAgICAgaWYgKGxpbmspIHsNCiAgICAgICAgbGluay52ZXJzaW9uID0gdGhpcy5kZXAudmVyc2lvbjsNCiAgICAgIH0NCiAgICAgIHJldHVybiB0aGlzLl92YWx1ZTsNCiAgICB9DQogICAgc2V0IHZhbHVlKG5ld1ZhbHVlKSB7DQogICAgICBpZiAodGhpcy5zZXR0ZXIpIHsNCiAgICAgICAgdGhpcy5zZXR0ZXIobmV3VmFsdWUpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgd2FybiQyKCJXcml0ZSBvcGVyYXRpb24gZmFpbGVkOiBjb21wdXRlZCB2YWx1ZSBpcyByZWFkb25seSIpOw0KICAgICAgfQ0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBjb21wdXRlZCQxKGdldHRlck9yT3B0aW9ucywgZGVidWdPcHRpb25zLCBpc1NTUiA9IGZhbHNlKSB7DQogICAgbGV0IGdldHRlcjsNCiAgICBsZXQgc2V0dGVyOw0KICAgIGlmIChpc0Z1bmN0aW9uKGdldHRlck9yT3B0aW9ucykpIHsNCiAgICAgIGdldHRlciA9IGdldHRlck9yT3B0aW9uczsNCiAgICB9IGVsc2Ugew0KICAgICAgZ2V0dGVyID0gZ2V0dGVyT3JPcHRpb25zLmdldDsNCiAgICAgIHNldHRlciA9IGdldHRlck9yT3B0aW9ucy5zZXQ7DQogICAgfQ0KICAgIGNvbnN0IGNSZWYgPSBuZXcgQ29tcHV0ZWRSZWZJbXBsKGdldHRlciwgc2V0dGVyLCBpc1NTUik7DQogICAgaWYgKGRlYnVnT3B0aW9ucyAmJiAhaXNTU1IpIHsNCiAgICAgIGNSZWYub25UcmFjayA9IGRlYnVnT3B0aW9ucy5vblRyYWNrOw0KICAgICAgY1JlZi5vblRyaWdnZXIgPSBkZWJ1Z09wdGlvbnMub25UcmlnZ2VyOw0KICAgIH0NCiAgICByZXR1cm4gY1JlZjsNCiAgfQ0KDQogIGNvbnN0IFRyYWNrT3BUeXBlcyA9IHsNCiAgICAiR0VUIjogImdldCIsDQogICAgIkhBUyI6ICJoYXMiLA0KICAgICJJVEVSQVRFIjogIml0ZXJhdGUiDQogIH07DQogIGNvbnN0IFRyaWdnZXJPcFR5cGVzID0gew0KICAgICJTRVQiOiAic2V0IiwNCiAgICAiQUREIjogImFkZCIsDQogICAgIkRFTEVURSI6ICJkZWxldGUiLA0KICAgICJDTEVBUiI6ICJjbGVhciINCiAgfTsNCg0KICBjb25zdCBJTklUSUFMX1dBVENIRVJfVkFMVUUgPSB7fTsNCiAgY29uc3QgY2xlYW51cE1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOw0KICBsZXQgYWN0aXZlV2F0Y2hlciA9IHZvaWQgMDsNCiAgZnVuY3Rpb24gZ2V0Q3VycmVudFdhdGNoZXIoKSB7DQogICAgcmV0dXJuIGFjdGl2ZVdhdGNoZXI7DQogIH0NCiAgZnVuY3Rpb24gb25XYXRjaGVyQ2xlYW51cChjbGVhbnVwRm4sIGZhaWxTaWxlbnRseSA9IGZhbHNlLCBvd25lciA9IGFjdGl2ZVdhdGNoZXIpIHsNCiAgICBpZiAob3duZXIpIHsNCiAgICAgIGxldCBjbGVhbnVwcyA9IGNsZWFudXBNYXAuZ2V0KG93bmVyKTsNCiAgICAgIGlmICghY2xlYW51cHMpIGNsZWFudXBNYXAuc2V0KG93bmVyLCBjbGVhbnVwcyA9IFtdKTsNCiAgICAgIGNsZWFudXBzLnB1c2goY2xlYW51cEZuKTsNCiAgICB9IGVsc2UgaWYgKCFmYWlsU2lsZW50bHkpIHsNCiAgICAgIHdhcm4kMigNCiAgICAgICAgYG9uV2F0Y2hlckNsZWFudXAoKSB3YXMgY2FsbGVkIHdoZW4gdGhlcmUgd2FzIG5vIGFjdGl2ZSB3YXRjaGVyIHRvIGFzc29jaWF0ZSB3aXRoLmANCiAgICAgICk7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIHdhdGNoJDEoc291cmNlLCBjYiwgb3B0aW9ucyA9IEVNUFRZX09CSikgew0KICAgIGNvbnN0IHsgaW1tZWRpYXRlLCBkZWVwLCBvbmNlLCBzY2hlZHVsZXIsIGF1Z21lbnRKb2IsIGNhbGwgfSA9IG9wdGlvbnM7DQogICAgY29uc3Qgd2FybkludmFsaWRTb3VyY2UgPSAocykgPT4gew0KICAgICAgKG9wdGlvbnMub25XYXJuIHx8IHdhcm4kMikoDQogICAgICAgIGBJbnZhbGlkIHdhdGNoIHNvdXJjZTogYCwNCiAgICAgICAgcywNCiAgICAgICAgYEEgd2F0Y2ggc291cmNlIGNhbiBvbmx5IGJlIGEgZ2V0dGVyL2VmZmVjdCBmdW5jdGlvbiwgYSByZWYsIGEgcmVhY3RpdmUgb2JqZWN0LCBvciBhbiBhcnJheSBvZiB0aGVzZSB0eXBlcy5gDQogICAgICApOw0KICAgIH07DQogICAgY29uc3QgcmVhY3RpdmVHZXR0ZXIgPSAoc291cmNlMikgPT4gew0KICAgICAgaWYgKGRlZXApIHJldHVybiBzb3VyY2UyOw0KICAgICAgaWYgKGlzU2hhbGxvdyhzb3VyY2UyKSB8fCBkZWVwID09PSBmYWxzZSB8fCBkZWVwID09PSAwKQ0KICAgICAgICByZXR1cm4gdHJhdmVyc2Uoc291cmNlMiwgMSk7DQogICAgICByZXR1cm4gdHJhdmVyc2Uoc291cmNlMik7DQogICAgfTsNCiAgICBsZXQgZWZmZWN0Ow0KICAgIGxldCBnZXR0ZXI7DQogICAgbGV0IGNsZWFudXA7DQogICAgbGV0IGJvdW5kQ2xlYW51cDsNCiAgICBsZXQgZm9yY2VUcmlnZ2VyID0gZmFsc2U7DQogICAgbGV0IGlzTXVsdGlTb3VyY2UgPSBmYWxzZTsNCiAgICBpZiAoaXNSZWYoc291cmNlKSkgew0KICAgICAgZ2V0dGVyID0gKCkgPT4gc291cmNlLnZhbHVlOw0KICAgICAgZm9yY2VUcmlnZ2VyID0gaXNTaGFsbG93KHNvdXJjZSk7DQogICAgfSBlbHNlIGlmIChpc1JlYWN0aXZlKHNvdXJjZSkpIHsNCiAgICAgIGdldHRlciA9ICgpID0+IHJlYWN0aXZlR2V0dGVyKHNvdXJjZSk7DQogICAgICBmb3JjZVRyaWdnZXIgPSB0cnVlOw0KICAgIH0gZWxzZSBpZiAoaXNBcnJheShzb3VyY2UpKSB7DQogICAgICBpc011bHRpU291cmNlID0gdHJ1ZTsNCiAgICAgIGZvcmNlVHJpZ2dlciA9IHNvdXJjZS5zb21lKChzKSA9PiBpc1JlYWN0aXZlKHMpIHx8IGlzU2hhbGxvdyhzKSk7DQogICAgICBnZXR0ZXIgPSAoKSA9PiBzb3VyY2UubWFwKChzKSA9PiB7DQogICAgICAgIGlmIChpc1JlZihzKSkgew0KICAgICAgICAgIHJldHVybiBzLnZhbHVlOw0KICAgICAgICB9IGVsc2UgaWYgKGlzUmVhY3RpdmUocykpIHsNCiAgICAgICAgICByZXR1cm4gcmVhY3RpdmVHZXR0ZXIocyk7DQogICAgICAgIH0gZWxzZSBpZiAoaXNGdW5jdGlvbihzKSkgew0KICAgICAgICAgIHJldHVybiBjYWxsID8gY2FsbChzLCAyKSA6IHMoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICB3YXJuSW52YWxpZFNvdXJjZShzKTsNCiAgICAgICAgfQ0KICAgICAgfSk7DQogICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKHNvdXJjZSkpIHsNCiAgICAgIGlmIChjYikgew0KICAgICAgICBnZXR0ZXIgPSBjYWxsID8gKCkgPT4gY2FsbChzb3VyY2UsIDIpIDogc291cmNlOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgZ2V0dGVyID0gKCkgPT4gew0KICAgICAgICAgIGlmIChjbGVhbnVwKSB7DQogICAgICAgICAgICBwYXVzZVRyYWNraW5nKCk7DQogICAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICBjbGVhbnVwKCk7DQogICAgICAgICAgICB9IGZpbmFsbHkgew0KICAgICAgICAgICAgICByZXNldFRyYWNraW5nKCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICAgIGNvbnN0IGN1cnJlbnRFZmZlY3QgPSBhY3RpdmVXYXRjaGVyOw0KICAgICAgICAgIGFjdGl2ZVdhdGNoZXIgPSBlZmZlY3Q7DQogICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgIHJldHVybiBjYWxsID8gY2FsbChzb3VyY2UsIDMsIFtib3VuZENsZWFudXBdKSA6IHNvdXJjZShib3VuZENsZWFudXApOw0KICAgICAgICAgIH0gZmluYWxseSB7DQogICAgICAgICAgICBhY3RpdmVXYXRjaGVyID0gY3VycmVudEVmZmVjdDsNCiAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIGdldHRlciA9IE5PT1A7DQogICAgICB3YXJuSW52YWxpZFNvdXJjZShzb3VyY2UpOw0KICAgIH0NCiAgICBpZiAoY2IgJiYgZGVlcCkgew0KICAgICAgY29uc3QgYmFzZUdldHRlciA9IGdldHRlcjsNCiAgICAgIGNvbnN0IGRlcHRoID0gZGVlcCA9PT0gdHJ1ZSA/IEluZmluaXR5IDogZGVlcDsNCiAgICAgIGdldHRlciA9ICgpID0+IHRyYXZlcnNlKGJhc2VHZXR0ZXIoKSwgZGVwdGgpOw0KICAgIH0NCiAgICBjb25zdCBzY29wZSA9IGdldEN1cnJlbnRTY29wZSgpOw0KICAgIGNvbnN0IHdhdGNoSGFuZGxlID0gKCkgPT4gew0KICAgICAgZWZmZWN0LnN0b3AoKTsNCiAgICAgIGlmIChzY29wZSAmJiBzY29wZS5hY3RpdmUpIHsNCiAgICAgICAgcmVtb3ZlKHNjb3BlLmVmZmVjdHMsIGVmZmVjdCk7DQogICAgICB9DQogICAgfTsNCiAgICBpZiAob25jZSAmJiBjYikgew0KICAgICAgY29uc3QgX2NiID0gY2I7DQogICAgICBjYiA9ICguLi5hcmdzKSA9PiB7DQogICAgICAgIF9jYiguLi5hcmdzKTsNCiAgICAgICAgd2F0Y2hIYW5kbGUoKTsNCiAgICAgIH07DQogICAgfQ0KICAgIGxldCBvbGRWYWx1ZSA9IGlzTXVsdGlTb3VyY2UgPyBuZXcgQXJyYXkoc291cmNlLmxlbmd0aCkuZmlsbChJTklUSUFMX1dBVENIRVJfVkFMVUUpIDogSU5JVElBTF9XQVRDSEVSX1ZBTFVFOw0KICAgIGNvbnN0IGpvYiA9IChpbW1lZGlhdGVGaXJzdFJ1bikgPT4gew0KICAgICAgaWYgKCEoZWZmZWN0LmZsYWdzICYgMSkgfHwgIWVmZmVjdC5kaXJ0eSAmJiAhaW1tZWRpYXRlRmlyc3RSdW4pIHsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgaWYgKGNiKSB7DQogICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gZWZmZWN0LnJ1bigpOw0KICAgICAgICBpZiAoZGVlcCB8fCBmb3JjZVRyaWdnZXIgfHwgKGlzTXVsdGlTb3VyY2UgPyBuZXdWYWx1ZS5zb21lKCh2LCBpKSA9PiBoYXNDaGFuZ2VkKHYsIG9sZFZhbHVlW2ldKSkgOiBoYXNDaGFuZ2VkKG5ld1ZhbHVlLCBvbGRWYWx1ZSkpKSB7DQogICAgICAgICAgaWYgKGNsZWFudXApIHsNCiAgICAgICAgICAgIGNsZWFudXAoKTsNCiAgICAgICAgICB9DQogICAgICAgICAgY29uc3QgY3VycmVudFdhdGNoZXIgPSBhY3RpdmVXYXRjaGVyOw0KICAgICAgICAgIGFjdGl2ZVdhdGNoZXIgPSBlZmZlY3Q7DQogICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgIGNvbnN0IGFyZ3MgPSBbDQogICAgICAgICAgICAgIG5ld1ZhbHVlLA0KICAgICAgICAgICAgICAvLyBwYXNzIHVuZGVmaW5lZCBhcyB0aGUgb2xkIHZhbHVlIHdoZW4gaXQncyBjaGFuZ2VkIGZvciB0aGUgZmlyc3QgdGltZQ0KICAgICAgICAgICAgICBvbGRWYWx1ZSA9PT0gSU5JVElBTF9XQVRDSEVSX1ZBTFVFID8gdm9pZCAwIDogaXNNdWx0aVNvdXJjZSAmJiBvbGRWYWx1ZVswXSA9PT0gSU5JVElBTF9XQVRDSEVSX1ZBTFVFID8gW10gOiBvbGRWYWx1ZSwNCiAgICAgICAgICAgICAgYm91bmRDbGVhbnVwDQogICAgICAgICAgICBdOw0KICAgICAgICAgICAgb2xkVmFsdWUgPSBuZXdWYWx1ZTsNCiAgICAgICAgICAgIGNhbGwgPyBjYWxsKGNiLCAzLCBhcmdzKSA6ICgNCiAgICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvcg0KICAgICAgICAgICAgICBjYiguLi5hcmdzKQ0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9IGZpbmFsbHkgew0KICAgICAgICAgICAgYWN0aXZlV2F0Y2hlciA9IGN1cnJlbnRXYXRjaGVyOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgZWZmZWN0LnJ1bigpOw0KICAgICAgfQ0KICAgIH07DQogICAgaWYgKGF1Z21lbnRKb2IpIHsNCiAgICAgIGF1Z21lbnRKb2Ioam9iKTsNCiAgICB9DQogICAgZWZmZWN0ID0gbmV3IFJlYWN0aXZlRWZmZWN0KGdldHRlcik7DQogICAgZWZmZWN0LnNjaGVkdWxlciA9IHNjaGVkdWxlciA/ICgpID0+IHNjaGVkdWxlcihqb2IsIGZhbHNlKSA6IGpvYjsNCiAgICBib3VuZENsZWFudXAgPSAoZm4pID0+IG9uV2F0Y2hlckNsZWFudXAoZm4sIGZhbHNlLCBlZmZlY3QpOw0KICAgIGNsZWFudXAgPSBlZmZlY3Qub25TdG9wID0gKCkgPT4gew0KICAgICAgY29uc3QgY2xlYW51cHMgPSBjbGVhbnVwTWFwLmdldChlZmZlY3QpOw0KICAgICAgaWYgKGNsZWFudXBzKSB7DQogICAgICAgIGlmIChjYWxsKSB7DQogICAgICAgICAgY2FsbChjbGVhbnVwcywgNCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgZm9yIChjb25zdCBjbGVhbnVwMiBvZiBjbGVhbnVwcykgY2xlYW51cDIoKTsNCiAgICAgICAgfQ0KICAgICAgICBjbGVhbnVwTWFwLmRlbGV0ZShlZmZlY3QpOw0KICAgICAgfQ0KICAgIH07DQogICAgew0KICAgICAgZWZmZWN0Lm9uVHJhY2sgPSBvcHRpb25zLm9uVHJhY2s7DQogICAgICBlZmZlY3Qub25UcmlnZ2VyID0gb3B0aW9ucy5vblRyaWdnZXI7DQogICAgfQ0KICAgIGlmIChjYikgew0KICAgICAgaWYgKGltbWVkaWF0ZSkgew0KICAgICAgICBqb2IodHJ1ZSk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBvbGRWYWx1ZSA9IGVmZmVjdC5ydW4oKTsNCiAgICAgIH0NCiAgICB9IGVsc2UgaWYgKHNjaGVkdWxlcikgew0KICAgICAgc2NoZWR1bGVyKGpvYi5iaW5kKG51bGwsIHRydWUpLCB0cnVlKTsNCiAgICB9IGVsc2Ugew0KICAgICAgZWZmZWN0LnJ1bigpOw0KICAgIH0NCiAgICB3YXRjaEhhbmRsZS5wYXVzZSA9IGVmZmVjdC5wYXVzZS5iaW5kKGVmZmVjdCk7DQogICAgd2F0Y2hIYW5kbGUucmVzdW1lID0gZWZmZWN0LnJlc3VtZS5iaW5kKGVmZmVjdCk7DQogICAgd2F0Y2hIYW5kbGUuc3RvcCA9IHdhdGNoSGFuZGxlOw0KICAgIHJldHVybiB3YXRjaEhhbmRsZTsNCiAgfQ0KICBmdW5jdGlvbiB0cmF2ZXJzZSh2YWx1ZSwgZGVwdGggPSBJbmZpbml0eSwgc2Vlbikgew0KICAgIGlmIChkZXB0aCA8PSAwIHx8ICFpc09iamVjdCh2YWx1ZSkgfHwgdmFsdWVbIl9fdl9za2lwIl0pIHsNCiAgICAgIHJldHVybiB2YWx1ZTsNCiAgICB9DQogICAgc2VlbiA9IHNlZW4gfHwgLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsNCiAgICBpZiAoc2Vlbi5oYXModmFsdWUpKSB7DQogICAgICByZXR1cm4gdmFsdWU7DQogICAgfQ0KICAgIHNlZW4uYWRkKHZhbHVlKTsNCiAgICBkZXB0aC0tOw0KICAgIGlmIChpc1JlZih2YWx1ZSkpIHsNCiAgICAgIHRyYXZlcnNlKHZhbHVlLnZhbHVlLCBkZXB0aCwgc2Vlbik7DQogICAgfSBlbHNlIGlmIChpc0FycmF5KHZhbHVlKSkgew0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZS5sZW5ndGg7IGkrKykgew0KICAgICAgICB0cmF2ZXJzZSh2YWx1ZVtpXSwgZGVwdGgsIHNlZW4pOw0KICAgICAgfQ0KICAgIH0gZWxzZSBpZiAoaXNTZXQodmFsdWUpIHx8IGlzTWFwKHZhbHVlKSkgew0KICAgICAgdmFsdWUuZm9yRWFjaCgodikgPT4gew0KICAgICAgICB0cmF2ZXJzZSh2LCBkZXB0aCwgc2Vlbik7DQogICAgICB9KTsNCiAgICB9IGVsc2UgaWYgKGlzUGxhaW5PYmplY3QodmFsdWUpKSB7DQogICAgICBmb3IgKGNvbnN0IGtleSBpbiB2YWx1ZSkgew0KICAgICAgICB0cmF2ZXJzZSh2YWx1ZVtrZXldLCBkZXB0aCwgc2Vlbik7DQogICAgICB9DQogICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKHZhbHVlKSkgew0KICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKHZhbHVlLCBrZXkpKSB7DQogICAgICAgICAgdHJhdmVyc2UodmFsdWVba2V5XSwgZGVwdGgsIHNlZW4pOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiB2YWx1ZTsNCiAgfQ0KDQogIGNvbnN0IHN0YWNrJDEgPSBbXTsNCiAgZnVuY3Rpb24gcHVzaFdhcm5pbmdDb250ZXh0KHZub2RlKSB7DQogICAgc3RhY2skMS5wdXNoKHZub2RlKTsNCiAgfQ0KICBmdW5jdGlvbiBwb3BXYXJuaW5nQ29udGV4dCgpIHsNCiAgICBzdGFjayQxLnBvcCgpOw0KICB9DQogIGxldCBpc1dhcm5pbmcgPSBmYWxzZTsNCiAgZnVuY3Rpb24gd2FybiQxKG1zZywgLi4uYXJncykgew0KICAgIGlmIChpc1dhcm5pbmcpIHJldHVybjsNCiAgICBpc1dhcm5pbmcgPSB0cnVlOw0KICAgIHBhdXNlVHJhY2tpbmcoKTsNCiAgICBjb25zdCBpbnN0YW5jZSA9IHN0YWNrJDEubGVuZ3RoID8gc3RhY2skMVtzdGFjayQxLmxlbmd0aCAtIDFdLmNvbXBvbmVudCA6IG51bGw7DQogICAgY29uc3QgYXBwV2FybkhhbmRsZXIgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS5hcHBDb250ZXh0LmNvbmZpZy53YXJuSGFuZGxlcjsNCiAgICBjb25zdCB0cmFjZSA9IGdldENvbXBvbmVudFRyYWNlKCk7DQogICAgaWYgKGFwcFdhcm5IYW5kbGVyKSB7DQogICAgICBjYWxsV2l0aEVycm9ySGFuZGxpbmcoDQogICAgICAgIGFwcFdhcm5IYW5kbGVyLA0KICAgICAgICBpbnN0YW5jZSwNCiAgICAgICAgMTEsDQogICAgICAgIFsNCiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcmVzdHJpY3RlZC1zeW50YXgNCiAgICAgICAgICBtc2cgKyBhcmdzLm1hcCgoYSkgPT4gew0KICAgICAgICAgICAgdmFyIF9hLCBfYjsNCiAgICAgICAgICAgIHJldHVybiAoX2IgPSAoX2EgPSBhLnRvU3RyaW5nKSA9PSBudWxsID8gdm9pZCAwIDogX2EuY2FsbChhKSkgIT0gbnVsbCA/IF9iIDogSlNPTi5zdHJpbmdpZnkoYSk7DQogICAgICAgICAgfSkuam9pbigiIiksDQogICAgICAgICAgaW5zdGFuY2UgJiYgaW5zdGFuY2UucHJveHksDQogICAgICAgICAgdHJhY2UubWFwKA0KICAgICAgICAgICAgKHsgdm5vZGUgfSkgPT4gYGF0IDwke2Zvcm1hdENvbXBvbmVudE5hbWUoaW5zdGFuY2UsIHZub2RlLnR5cGUpfT5gDQogICAgICAgICAgKS5qb2luKCJcbiIpLA0KICAgICAgICAgIHRyYWNlDQogICAgICAgIF0NCiAgICAgICk7DQogICAgfSBlbHNlIHsNCiAgICAgIGNvbnN0IHdhcm5BcmdzID0gW2BbVnVlIHdhcm5dOiAke21zZ31gLCAuLi5hcmdzXTsNCiAgICAgIGlmICh0cmFjZS5sZW5ndGggJiYgLy8gYXZvaWQgc3BhbW1pbmcgY29uc29sZSBkdXJpbmcgdGVzdHMNCiAgICAgIHRydWUpIHsNCiAgICAgICAgd2FybkFyZ3MucHVzaChgDQpgLCAuLi5mb3JtYXRUcmFjZSh0cmFjZSkpOw0KICAgICAgfQ0KICAgICAgY29uc29sZS53YXJuKC4uLndhcm5BcmdzKTsNCiAgICB9DQogICAgcmVzZXRUcmFja2luZygpOw0KICAgIGlzV2FybmluZyA9IGZhbHNlOw0KICB9DQogIGZ1bmN0aW9uIGdldENvbXBvbmVudFRyYWNlKCkgew0KICAgIGxldCBjdXJyZW50Vk5vZGUgPSBzdGFjayQxW3N0YWNrJDEubGVuZ3RoIC0gMV07DQogICAgaWYgKCFjdXJyZW50Vk5vZGUpIHsNCiAgICAgIHJldHVybiBbXTsNCiAgICB9DQogICAgY29uc3Qgbm9ybWFsaXplZFN0YWNrID0gW107DQogICAgd2hpbGUgKGN1cnJlbnRWTm9kZSkgew0KICAgICAgY29uc3QgbGFzdCA9IG5vcm1hbGl6ZWRTdGFja1swXTsNCiAgICAgIGlmIChsYXN0ICYmIGxhc3Qudm5vZGUgPT09IGN1cnJlbnRWTm9kZSkgew0KICAgICAgICBsYXN0LnJlY3Vyc2VDb3VudCsrOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgbm9ybWFsaXplZFN0YWNrLnB1c2goew0KICAgICAgICAgIHZub2RlOiBjdXJyZW50Vk5vZGUsDQogICAgICAgICAgcmVjdXJzZUNvdW50OiAwDQogICAgICAgIH0pOw0KICAgICAgfQ0KICAgICAgY29uc3QgcGFyZW50SW5zdGFuY2UgPSBjdXJyZW50Vk5vZGUuY29tcG9uZW50ICYmIGN1cnJlbnRWTm9kZS5jb21wb25lbnQucGFyZW50Ow0KICAgICAgY3VycmVudFZOb2RlID0gcGFyZW50SW5zdGFuY2UgJiYgcGFyZW50SW5zdGFuY2Uudm5vZGU7DQogICAgfQ0KICAgIHJldHVybiBub3JtYWxpemVkU3RhY2s7DQogIH0NCiAgZnVuY3Rpb24gZm9ybWF0VHJhY2UodHJhY2UpIHsNCiAgICBjb25zdCBsb2dzID0gW107DQogICAgdHJhY2UuZm9yRWFjaCgoZW50cnksIGkpID0+IHsNCiAgICAgIGxvZ3MucHVzaCguLi5pID09PSAwID8gW10gOiBbYA0KYF0sIC4uLmZvcm1hdFRyYWNlRW50cnkoZW50cnkpKTsNCiAgICB9KTsNCiAgICByZXR1cm4gbG9nczsNCiAgfQ0KICBmdW5jdGlvbiBmb3JtYXRUcmFjZUVudHJ5KHsgdm5vZGUsIHJlY3Vyc2VDb3VudCB9KSB7DQogICAgY29uc3QgcG9zdGZpeCA9IHJlY3Vyc2VDb3VudCA+IDAgPyBgLi4uICgke3JlY3Vyc2VDb3VudH0gcmVjdXJzaXZlIGNhbGxzKWAgOiBgYDsNCiAgICBjb25zdCBpc1Jvb3QgPSB2bm9kZS5jb21wb25lbnQgPyB2bm9kZS5jb21wb25lbnQucGFyZW50ID09IG51bGwgOiBmYWxzZTsNCiAgICBjb25zdCBvcGVuID0gYCBhdCA8JHtmb3JtYXRDb21wb25lbnROYW1lKA0KICAgIHZub2RlLmNvbXBvbmVudCwNCiAgICB2bm9kZS50eXBlLA0KICAgIGlzUm9vdA0KICApfWA7DQogICAgY29uc3QgY2xvc2UgPSBgPmAgKyBwb3N0Zml4Ow0KICAgIHJldHVybiB2bm9kZS5wcm9wcyA/IFtvcGVuLCAuLi5mb3JtYXRQcm9wcyh2bm9kZS5wcm9wcyksIGNsb3NlXSA6IFtvcGVuICsgY2xvc2VdOw0KICB9DQogIGZ1bmN0aW9uIGZvcm1hdFByb3BzKHByb3BzKSB7DQogICAgY29uc3QgcmVzID0gW107DQogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHByb3BzKTsNCiAgICBrZXlzLnNsaWNlKDAsIDMpLmZvckVhY2goKGtleSkgPT4gew0KICAgICAgcmVzLnB1c2goLi4uZm9ybWF0UHJvcChrZXksIHByb3BzW2tleV0pKTsNCiAgICB9KTsNCiAgICBpZiAoa2V5cy5sZW5ndGggPiAzKSB7DQogICAgICByZXMucHVzaChgIC4uLmApOw0KICAgIH0NCiAgICByZXR1cm4gcmVzOw0KICB9DQogIGZ1bmN0aW9uIGZvcm1hdFByb3Aoa2V5LCB2YWx1ZSwgcmF3KSB7DQogICAgaWYgKGlzU3RyaW5nKHZhbHVlKSkgew0KICAgICAgdmFsdWUgPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7DQogICAgICByZXR1cm4gcmF3ID8gdmFsdWUgOiBbYCR7a2V5fT0ke3ZhbHVlfWBdOw0KICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiB8fCB2YWx1ZSA9PSBudWxsKSB7DQogICAgICByZXR1cm4gcmF3ID8gdmFsdWUgOiBbYCR7a2V5fT0ke3ZhbHVlfWBdOw0KICAgIH0gZWxzZSBpZiAoaXNSZWYodmFsdWUpKSB7DQogICAgICB2YWx1ZSA9IGZvcm1hdFByb3Aoa2V5LCB0b1Jhdyh2YWx1ZS52YWx1ZSksIHRydWUpOw0KICAgICAgcmV0dXJuIHJhdyA/IHZhbHVlIDogW2Ake2tleX09UmVmPGAsIHZhbHVlLCBgPmBdOw0KICAgIH0gZWxzZSBpZiAoaXNGdW5jdGlvbih2YWx1ZSkpIHsNCiAgICAgIHJldHVybiBbYCR7a2V5fT1mbiR7dmFsdWUubmFtZSA/IGA8JHt2YWx1ZS5uYW1lfT5gIDogYGB9YF07DQogICAgfSBlbHNlIHsNCiAgICAgIHZhbHVlID0gdG9SYXcodmFsdWUpOw0KICAgICAgcmV0dXJuIHJhdyA/IHZhbHVlIDogW2Ake2tleX09YCwgdmFsdWVdOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBhc3NlcnROdW1iZXIodmFsLCB0eXBlKSB7DQogICAgaWYgKHZhbCA9PT0gdm9pZCAwKSB7DQogICAgICByZXR1cm47DQogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsICE9PSAibnVtYmVyIikgew0KICAgICAgd2FybiQxKGAke3R5cGV9IGlzIG5vdCBhIHZhbGlkIG51bWJlciAtIGdvdCAke0pTT04uc3RyaW5naWZ5KHZhbCl9LmApOw0KICAgIH0gZWxzZSBpZiAoaXNOYU4odmFsKSkgew0KICAgICAgd2FybiQxKGAke3R5cGV9IGlzIE5hTiAtIHRoZSBkdXJhdGlvbiBleHByZXNzaW9uIG1pZ2h0IGJlIGluY29ycmVjdC5gKTsNCiAgICB9DQogIH0NCg0KICBjb25zdCBFcnJvckNvZGVzID0gew0KICAgICJTRVRVUF9GVU5DVElPTiI6IDAsDQogICAgIjAiOiAiU0VUVVBfRlVOQ1RJT04iLA0KICAgICJSRU5ERVJfRlVOQ1RJT04iOiAxLA0KICAgICIxIjogIlJFTkRFUl9GVU5DVElPTiIsDQogICAgIk5BVElWRV9FVkVOVF9IQU5ETEVSIjogNSwNCiAgICAiNSI6ICJOQVRJVkVfRVZFTlRfSEFORExFUiIsDQogICAgIkNPTVBPTkVOVF9FVkVOVF9IQU5ETEVSIjogNiwNCiAgICAiNiI6ICJDT01QT05FTlRfRVZFTlRfSEFORExFUiIsDQogICAgIlZOT0RFX0hPT0siOiA3LA0KICAgICI3IjogIlZOT0RFX0hPT0siLA0KICAgICJESVJFQ1RJVkVfSE9PSyI6IDgsDQogICAgIjgiOiAiRElSRUNUSVZFX0hPT0siLA0KICAgICJUUkFOU0lUSU9OX0hPT0siOiA5LA0KICAgICI5IjogIlRSQU5TSVRJT05fSE9PSyIsDQogICAgIkFQUF9FUlJPUl9IQU5ETEVSIjogMTAsDQogICAgIjEwIjogIkFQUF9FUlJPUl9IQU5ETEVSIiwNCiAgICAiQVBQX1dBUk5fSEFORExFUiI6IDExLA0KICAgICIxMSI6ICJBUFBfV0FSTl9IQU5ETEVSIiwNCiAgICAiRlVOQ1RJT05fUkVGIjogMTIsDQogICAgIjEyIjogIkZVTkNUSU9OX1JFRiIsDQogICAgIkFTWU5DX0NPTVBPTkVOVF9MT0FERVIiOiAxMywNCiAgICAiMTMiOiAiQVNZTkNfQ09NUE9ORU5UX0xPQURFUiIsDQogICAgIlNDSEVEVUxFUiI6IDE0LA0KICAgICIxNCI6ICJTQ0hFRFVMRVIiLA0KICAgICJDT01QT05FTlRfVVBEQVRFIjogMTUsDQogICAgIjE1IjogIkNPTVBPTkVOVF9VUERBVEUiLA0KICAgICJBUFBfVU5NT1VOVF9DTEVBTlVQIjogMTYsDQogICAgIjE2IjogIkFQUF9VTk1PVU5UX0NMRUFOVVAiDQogIH07DQogIGNvbnN0IEVycm9yVHlwZVN0cmluZ3MkMSA9IHsNCiAgICBbInNwIl06ICJzZXJ2ZXJQcmVmZXRjaCBob29rIiwNCiAgICBbImJjIl06ICJiZWZvcmVDcmVhdGUgaG9vayIsDQogICAgWyJjIl06ICJjcmVhdGVkIGhvb2siLA0KICAgIFsiYm0iXTogImJlZm9yZU1vdW50IGhvb2siLA0KICAgIFsibSJdOiAibW91bnRlZCBob29rIiwNCiAgICBbImJ1Il06ICJiZWZvcmVVcGRhdGUgaG9vayIsDQogICAgWyJ1Il06ICJ1cGRhdGVkIiwNCiAgICBbImJ1bSJdOiAiYmVmb3JlVW5tb3VudCBob29rIiwNCiAgICBbInVtIl06ICJ1bm1vdW50ZWQgaG9vayIsDQogICAgWyJhIl06ICJhY3RpdmF0ZWQgaG9vayIsDQogICAgWyJkYSJdOiAiZGVhY3RpdmF0ZWQgaG9vayIsDQogICAgWyJlYyJdOiAiZXJyb3JDYXB0dXJlZCBob29rIiwNCiAgICBbInJ0YyJdOiAicmVuZGVyVHJhY2tlZCBob29rIiwNCiAgICBbInJ0ZyJdOiAicmVuZGVyVHJpZ2dlcmVkIGhvb2siLA0KICAgIFswXTogInNldHVwIGZ1bmN0aW9uIiwNCiAgICBbMV06ICJyZW5kZXIgZnVuY3Rpb24iLA0KICAgIFsyXTogIndhdGNoZXIgZ2V0dGVyIiwNCiAgICBbM106ICJ3YXRjaGVyIGNhbGxiYWNrIiwNCiAgICBbNF06ICJ3YXRjaGVyIGNsZWFudXAgZnVuY3Rpb24iLA0KICAgIFs1XTogIm5hdGl2ZSBldmVudCBoYW5kbGVyIiwNCiAgICBbNl06ICJjb21wb25lbnQgZXZlbnQgaGFuZGxlciIsDQogICAgWzddOiAidm5vZGUgaG9vayIsDQogICAgWzhdOiAiZGlyZWN0aXZlIGhvb2siLA0KICAgIFs5XTogInRyYW5zaXRpb24gaG9vayIsDQogICAgWzEwXTogImFwcCBlcnJvckhhbmRsZXIiLA0KICAgIFsxMV06ICJhcHAgd2FybkhhbmRsZXIiLA0KICAgIFsxMl06ICJyZWYgZnVuY3Rpb24iLA0KICAgIFsxM106ICJhc3luYyBjb21wb25lbnQgbG9hZGVyIiwNCiAgICBbMTRdOiAic2NoZWR1bGVyIGZsdXNoIiwNCiAgICBbMTVdOiAiY29tcG9uZW50IHVwZGF0ZSIsDQogICAgWzE2XTogImFwcCB1bm1vdW50IGNsZWFudXAgZnVuY3Rpb24iDQogIH07DQogIGZ1bmN0aW9uIGNhbGxXaXRoRXJyb3JIYW5kbGluZyhmbiwgaW5zdGFuY2UsIHR5cGUsIGFyZ3MpIHsNCiAgICB0cnkgew0KICAgICAgcmV0dXJuIGFyZ3MgPyBmbiguLi5hcmdzKSA6IGZuKCk7DQogICAgfSBjYXRjaCAoZXJyKSB7DQogICAgICBoYW5kbGVFcnJvcihlcnIsIGluc3RhbmNlLCB0eXBlKTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoZm4sIGluc3RhbmNlLCB0eXBlLCBhcmdzKSB7DQogICAgaWYgKGlzRnVuY3Rpb24oZm4pKSB7DQogICAgICBjb25zdCByZXMgPSBjYWxsV2l0aEVycm9ySGFuZGxpbmcoZm4sIGluc3RhbmNlLCB0eXBlLCBhcmdzKTsNCiAgICAgIGlmIChyZXMgJiYgaXNQcm9taXNlKHJlcykpIHsNCiAgICAgICAgcmVzLmNhdGNoKChlcnIpID0+IHsNCiAgICAgICAgICBoYW5kbGVFcnJvcihlcnIsIGluc3RhbmNlLCB0eXBlKTsNCiAgICAgICAgfSk7DQogICAgICB9DQogICAgICByZXR1cm4gcmVzOw0KICAgIH0NCiAgICBpZiAoaXNBcnJheShmbikpIHsNCiAgICAgIGNvbnN0IHZhbHVlcyA9IFtdOw0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmbi5sZW5ndGg7IGkrKykgew0KICAgICAgICB2YWx1ZXMucHVzaChjYWxsV2l0aEFzeW5jRXJyb3JIYW5kbGluZyhmbltpXSwgaW5zdGFuY2UsIHR5cGUsIGFyZ3MpKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiB2YWx1ZXM7DQogICAgfSBlbHNlIHsNCiAgICAgIHdhcm4kMSgNCiAgICAgICAgYEludmFsaWQgdmFsdWUgdHlwZSBwYXNzZWQgdG8gY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoKTogJHt0eXBlb2YgZm59YA0KICAgICAgKTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gaGFuZGxlRXJyb3IoZXJyLCBpbnN0YW5jZSwgdHlwZSwgdGhyb3dJbkRldiA9IHRydWUpIHsNCiAgICBjb25zdCBjb250ZXh0Vk5vZGUgPSBpbnN0YW5jZSA/IGluc3RhbmNlLnZub2RlIDogbnVsbDsNCiAgICBjb25zdCB7IGVycm9ySGFuZGxlciwgdGhyb3dVbmhhbmRsZWRFcnJvckluUHJvZHVjdGlvbiB9ID0gaW5zdGFuY2UgJiYgaW5zdGFuY2UuYXBwQ29udGV4dC5jb25maWcgfHwgRU1QVFlfT0JKOw0KICAgIGlmIChpbnN0YW5jZSkgew0KICAgICAgbGV0IGN1ciA9IGluc3RhbmNlLnBhcmVudDsNCiAgICAgIGNvbnN0IGV4cG9zZWRJbnN0YW5jZSA9IGluc3RhbmNlLnByb3h5Ow0KICAgICAgY29uc3QgZXJyb3JJbmZvID0gRXJyb3JUeXBlU3RyaW5ncyQxW3R5cGVdIDsNCiAgICAgIHdoaWxlIChjdXIpIHsNCiAgICAgICAgY29uc3QgZXJyb3JDYXB0dXJlZEhvb2tzID0gY3VyLmVjOw0KICAgICAgICBpZiAoZXJyb3JDYXB0dXJlZEhvb2tzKSB7DQogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlcnJvckNhcHR1cmVkSG9va3MubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIGlmIChlcnJvckNhcHR1cmVkSG9va3NbaV0oZXJyLCBleHBvc2VkSW5zdGFuY2UsIGVycm9ySW5mbykgPT09IGZhbHNlKSB7DQogICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgY3VyID0gY3VyLnBhcmVudDsNCiAgICAgIH0NCiAgICAgIGlmIChlcnJvckhhbmRsZXIpIHsNCiAgICAgICAgcGF1c2VUcmFja2luZygpOw0KICAgICAgICBjYWxsV2l0aEVycm9ySGFuZGxpbmcoZXJyb3JIYW5kbGVyLCBudWxsLCAxMCwgWw0KICAgICAgICAgIGVyciwNCiAgICAgICAgICBleHBvc2VkSW5zdGFuY2UsDQogICAgICAgICAgZXJyb3JJbmZvDQogICAgICAgIF0pOw0KICAgICAgICByZXNldFRyYWNraW5nKCk7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICB9DQogICAgbG9nRXJyb3IoZXJyLCB0eXBlLCBjb250ZXh0Vk5vZGUsIHRocm93SW5EZXYsIHRocm93VW5oYW5kbGVkRXJyb3JJblByb2R1Y3Rpb24pOw0KICB9DQogIGZ1bmN0aW9uIGxvZ0Vycm9yKGVyciwgdHlwZSwgY29udGV4dFZOb2RlLCB0aHJvd0luRGV2ID0gdHJ1ZSwgdGhyb3dJblByb2QgPSBmYWxzZSkgew0KICAgIHsNCiAgICAgIGNvbnN0IGluZm8gPSBFcnJvclR5cGVTdHJpbmdzJDFbdHlwZV07DQogICAgICBpZiAoY29udGV4dFZOb2RlKSB7DQogICAgICAgIHB1c2hXYXJuaW5nQ29udGV4dChjb250ZXh0Vk5vZGUpOw0KICAgICAgfQ0KICAgICAgd2FybiQxKGBVbmhhbmRsZWQgZXJyb3Ike2luZm8gPyBgIGR1cmluZyBleGVjdXRpb24gb2YgJHtpbmZvfWAgOiBgYH1gKTsNCiAgICAgIGlmIChjb250ZXh0Vk5vZGUpIHsNCiAgICAgICAgcG9wV2FybmluZ0NvbnRleHQoKTsNCiAgICAgIH0NCiAgICAgIGlmICh0aHJvd0luRGV2KSB7DQogICAgICAgIHRocm93IGVycjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTsNCiAgICAgIH0NCiAgICB9DQogIH0NCg0KICBjb25zdCBxdWV1ZSA9IFtdOw0KICBsZXQgZmx1c2hJbmRleCA9IC0xOw0KICBjb25zdCBwZW5kaW5nUG9zdEZsdXNoQ2JzID0gW107DQogIGxldCBhY3RpdmVQb3N0Rmx1c2hDYnMgPSBudWxsOw0KICBsZXQgcG9zdEZsdXNoSW5kZXggPSAwOw0KICBjb25zdCByZXNvbHZlZFByb21pc2UgPSAvKiBAX19QVVJFX18gKi8gUHJvbWlzZS5yZXNvbHZlKCk7DQogIGxldCBjdXJyZW50Rmx1c2hQcm9taXNlID0gbnVsbDsNCiAgY29uc3QgUkVDVVJTSU9OX0xJTUlUID0gMTAwOw0KICBmdW5jdGlvbiBuZXh0VGljayhmbikgew0KICAgIGNvbnN0IHAgPSBjdXJyZW50Rmx1c2hQcm9taXNlIHx8IHJlc29sdmVkUHJvbWlzZTsNCiAgICByZXR1cm4gZm4gPyBwLnRoZW4odGhpcyA/IGZuLmJpbmQodGhpcykgOiBmbikgOiBwOw0KICB9DQogIGZ1bmN0aW9uIGZpbmRJbnNlcnRpb25JbmRleChpZCkgew0KICAgIGxldCBzdGFydCA9IGZsdXNoSW5kZXggKyAxOw0KICAgIGxldCBlbmQgPSBxdWV1ZS5sZW5ndGg7DQogICAgd2hpbGUgKHN0YXJ0IDwgZW5kKSB7DQogICAgICBjb25zdCBtaWRkbGUgPSBzdGFydCArIGVuZCA+Pj4gMTsNCiAgICAgIGNvbnN0IG1pZGRsZUpvYiA9IHF1ZXVlW21pZGRsZV07DQogICAgICBjb25zdCBtaWRkbGVKb2JJZCA9IGdldElkKG1pZGRsZUpvYik7DQogICAgICBpZiAobWlkZGxlSm9iSWQgPCBpZCB8fCBtaWRkbGVKb2JJZCA9PT0gaWQgJiYgbWlkZGxlSm9iLmZsYWdzICYgMikgew0KICAgICAgICBzdGFydCA9IG1pZGRsZSArIDE7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBlbmQgPSBtaWRkbGU7DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiBzdGFydDsNCiAgfQ0KICBmdW5jdGlvbiBxdWV1ZUpvYihqb2IpIHsNCiAgICBpZiAoIShqb2IuZmxhZ3MgJiAxKSkgew0KICAgICAgY29uc3Qgam9iSWQgPSBnZXRJZChqb2IpOw0KICAgICAgY29uc3QgbGFzdEpvYiA9IHF1ZXVlW3F1ZXVlLmxlbmd0aCAtIDFdOw0KICAgICAgaWYgKCFsYXN0Sm9iIHx8IC8vIGZhc3QgcGF0aCB3aGVuIHRoZSBqb2IgaWQgaXMgbGFyZ2VyIHRoYW4gdGhlIHRhaWwNCiAgICAgICEoam9iLmZsYWdzICYgMikgJiYgam9iSWQgPj0gZ2V0SWQobGFzdEpvYikpIHsNCiAgICAgICAgcXVldWUucHVzaChqb2IpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcXVldWUuc3BsaWNlKGZpbmRJbnNlcnRpb25JbmRleChqb2JJZCksIDAsIGpvYik7DQogICAgICB9DQogICAgICBqb2IuZmxhZ3MgfD0gMTsNCiAgICAgIHF1ZXVlRmx1c2goKTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gcXVldWVGbHVzaCgpIHsNCiAgICBpZiAoIWN1cnJlbnRGbHVzaFByb21pc2UpIHsNCiAgICAgIGN1cnJlbnRGbHVzaFByb21pc2UgPSByZXNvbHZlZFByb21pc2UudGhlbihmbHVzaEpvYnMpOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBxdWV1ZVBvc3RGbHVzaENiKGNiKSB7DQogICAgaWYgKCFpc0FycmF5KGNiKSkgew0KICAgICAgaWYgKGFjdGl2ZVBvc3RGbHVzaENicyAmJiBjYi5pZCA9PT0gLTEpIHsNCiAgICAgICAgYWN0aXZlUG9zdEZsdXNoQ2JzLnNwbGljZShwb3N0Rmx1c2hJbmRleCArIDEsIDAsIGNiKTsNCiAgICAgIH0gZWxzZSBpZiAoIShjYi5mbGFncyAmIDEpKSB7DQogICAgICAgIHBlbmRpbmdQb3N0Rmx1c2hDYnMucHVzaChjYik7DQogICAgICAgIGNiLmZsYWdzIHw9IDE7DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIHBlbmRpbmdQb3N0Rmx1c2hDYnMucHVzaCguLi5jYik7DQogICAgfQ0KICAgIHF1ZXVlRmx1c2goKTsNCiAgfQ0KICBmdW5jdGlvbiBmbHVzaFByZUZsdXNoQ2JzKGluc3RhbmNlLCBzZWVuLCBpID0gZmx1c2hJbmRleCArIDEpIHsNCiAgICB7DQogICAgICBzZWVuID0gc2VlbiB8fCAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOw0KICAgIH0NCiAgICBmb3IgKDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7DQogICAgICBjb25zdCBjYiA9IHF1ZXVlW2ldOw0KICAgICAgaWYgKGNiICYmIGNiLmZsYWdzICYgMikgew0KICAgICAgICBpZiAoaW5zdGFuY2UgJiYgY2IuaWQgIT09IGluc3RhbmNlLnVpZCkgew0KICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICB9DQogICAgICAgIGlmIChjaGVja1JlY3Vyc2l2ZVVwZGF0ZXMoc2VlbiwgY2IpKSB7DQogICAgICAgICAgY29udGludWU7DQogICAgICAgIH0NCiAgICAgICAgcXVldWUuc3BsaWNlKGksIDEpOw0KICAgICAgICBpLS07DQogICAgICAgIGlmIChjYi5mbGFncyAmIDQpIHsNCiAgICAgICAgICBjYi5mbGFncyAmPSAtMjsNCiAgICAgICAgfQ0KICAgICAgICBjYigpOw0KICAgICAgICBpZiAoIShjYi5mbGFncyAmIDQpKSB7DQogICAgICAgICAgY2IuZmxhZ3MgJj0gLTI7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gZmx1c2hQb3N0Rmx1c2hDYnMoc2Vlbikgew0KICAgIGlmIChwZW5kaW5nUG9zdEZsdXNoQ2JzLmxlbmd0aCkgew0KICAgICAgY29uc3QgZGVkdXBlZCA9IFsuLi5uZXcgU2V0KHBlbmRpbmdQb3N0Rmx1c2hDYnMpXS5zb3J0KA0KICAgICAgICAoYSwgYikgPT4gZ2V0SWQoYSkgLSBnZXRJZChiKQ0KICAgICAgKTsNCiAgICAgIHBlbmRpbmdQb3N0Rmx1c2hDYnMubGVuZ3RoID0gMDsNCiAgICAgIGlmIChhY3RpdmVQb3N0Rmx1c2hDYnMpIHsNCiAgICAgICAgYWN0aXZlUG9zdEZsdXNoQ2JzLnB1c2goLi4uZGVkdXBlZCk7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIGFjdGl2ZVBvc3RGbHVzaENicyA9IGRlZHVwZWQ7DQogICAgICB7DQogICAgICAgIHNlZW4gPSBzZWVuIHx8IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7DQogICAgICB9DQogICAgICBmb3IgKHBvc3RGbHVzaEluZGV4ID0gMDsgcG9zdEZsdXNoSW5kZXggPCBhY3RpdmVQb3N0Rmx1c2hDYnMubGVuZ3RoOyBwb3N0Rmx1c2hJbmRleCsrKSB7DQogICAgICAgIGNvbnN0IGNiID0gYWN0aXZlUG9zdEZsdXNoQ2JzW3Bvc3RGbHVzaEluZGV4XTsNCiAgICAgICAgaWYgKGNoZWNrUmVjdXJzaXZlVXBkYXRlcyhzZWVuLCBjYikpIHsNCiAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoY2IuZmxhZ3MgJiA0KSB7DQogICAgICAgICAgY2IuZmxhZ3MgJj0gLTI7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCEoY2IuZmxhZ3MgJiA4KSkgY2IoKTsNCiAgICAgICAgY2IuZmxhZ3MgJj0gLTI7DQogICAgICB9DQogICAgICBhY3RpdmVQb3N0Rmx1c2hDYnMgPSBudWxsOw0KICAgICAgcG9zdEZsdXNoSW5kZXggPSAwOw0KICAgIH0NCiAgfQ0KICBjb25zdCBnZXRJZCA9IChqb2IpID0+IGpvYi5pZCA9PSBudWxsID8gam9iLmZsYWdzICYgMiA/IC0xIDogSW5maW5pdHkgOiBqb2IuaWQ7DQogIGZ1bmN0aW9uIGZsdXNoSm9icyhzZWVuKSB7DQogICAgew0KICAgICAgc2VlbiA9IHNlZW4gfHwgLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsNCiAgICB9DQogICAgY29uc3QgY2hlY2sgPSAoam9iKSA9PiBjaGVja1JlY3Vyc2l2ZVVwZGF0ZXMoc2Vlbiwgam9iKSA7DQogICAgdHJ5IHsNCiAgICAgIGZvciAoZmx1c2hJbmRleCA9IDA7IGZsdXNoSW5kZXggPCBxdWV1ZS5sZW5ndGg7IGZsdXNoSW5kZXgrKykgew0KICAgICAgICBjb25zdCBqb2IgPSBxdWV1ZVtmbHVzaEluZGV4XTsNCiAgICAgICAgaWYgKGpvYiAmJiAhKGpvYi5mbGFncyAmIDgpKSB7DQogICAgICAgICAgaWYgKGNoZWNrKGpvYikpIHsNCiAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpZiAoam9iLmZsYWdzICYgNCkgew0KICAgICAgICAgICAgam9iLmZsYWdzICY9IH4xOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjYWxsV2l0aEVycm9ySGFuZGxpbmcoDQogICAgICAgICAgICBqb2IsDQogICAgICAgICAgICBqb2IuaSwNCiAgICAgICAgICAgIGpvYi5pID8gMTUgOiAxNA0KICAgICAgICAgICk7DQogICAgICAgICAgaWYgKCEoam9iLmZsYWdzICYgNCkpIHsNCiAgICAgICAgICAgIGpvYi5mbGFncyAmPSB+MTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9IGZpbmFsbHkgew0KICAgICAgZm9yICg7IGZsdXNoSW5kZXggPCBxdWV1ZS5sZW5ndGg7IGZsdXNoSW5kZXgrKykgew0KICAgICAgICBjb25zdCBqb2IgPSBxdWV1ZVtmbHVzaEluZGV4XTsNCiAgICAgICAgaWYgKGpvYikgew0KICAgICAgICAgIGpvYi5mbGFncyAmPSAtMjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgZmx1c2hJbmRleCA9IC0xOw0KICAgICAgcXVldWUubGVuZ3RoID0gMDsNCiAgICAgIGZsdXNoUG9zdEZsdXNoQ2JzKHNlZW4pOw0KICAgICAgY3VycmVudEZsdXNoUHJvbWlzZSA9IG51bGw7DQogICAgICBpZiAocXVldWUubGVuZ3RoIHx8IHBlbmRpbmdQb3N0Rmx1c2hDYnMubGVuZ3RoKSB7DQogICAgICAgIGZsdXNoSm9icyhzZWVuKTsNCiAgICAgIH0NCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gY2hlY2tSZWN1cnNpdmVVcGRhdGVzKHNlZW4sIGZuKSB7DQogICAgY29uc3QgY291bnQgPSBzZWVuLmdldChmbikgfHwgMDsNCiAgICBpZiAoY291bnQgPiBSRUNVUlNJT05fTElNSVQpIHsNCiAgICAgIGNvbnN0IGluc3RhbmNlID0gZm4uaTsNCiAgICAgIGNvbnN0IGNvbXBvbmVudE5hbWUgPSBpbnN0YW5jZSAmJiBnZXRDb21wb25lbnROYW1lKGluc3RhbmNlLnR5cGUpOw0KICAgICAgaGFuZGxlRXJyb3IoDQogICAgICAgIGBNYXhpbXVtIHJlY3Vyc2l2ZSB1cGRhdGVzIGV4Y2VlZGVkJHtjb21wb25lbnROYW1lID8gYCBpbiBjb21wb25lbnQgPCR7Y29tcG9uZW50TmFtZX0+YCA6IGBgfS4gVGhpcyBtZWFucyB5b3UgaGF2ZSBhIHJlYWN0aXZlIGVmZmVjdCB0aGF0IGlzIG11dGF0aW5nIGl0cyBvd24gZGVwZW5kZW5jaWVzIGFuZCB0aHVzIHJlY3Vyc2l2ZWx5IHRyaWdnZXJpbmcgaXRzZWxmLiBQb3NzaWJsZSBzb3VyY2VzIGluY2x1ZGUgY29tcG9uZW50IHRlbXBsYXRlLCByZW5kZXIgZnVuY3Rpb24sIHVwZGF0ZWQgaG9vayBvciB3YXRjaGVyIHNvdXJjZSBmdW5jdGlvbi5gLA0KICAgICAgICBudWxsLA0KICAgICAgICAxMA0KICAgICAgKTsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgICBzZWVuLnNldChmbiwgY291bnQgKyAxKTsNCiAgICByZXR1cm4gZmFsc2U7DQogIH0NCg0KICBsZXQgaXNIbXJVcGRhdGluZyA9IGZhbHNlOw0KICBjb25zdCBobXJEaXJ0eUNvbXBvbmVudHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOw0KICB7DQogICAgZ2V0R2xvYmFsVGhpcygpLl9fVlVFX0hNUl9SVU5USU1FX18gPSB7DQogICAgICBjcmVhdGVSZWNvcmQ6IHRyeVdyYXAoY3JlYXRlUmVjb3JkKSwNCiAgICAgIHJlcmVuZGVyOiB0cnlXcmFwKHJlcmVuZGVyKSwNCiAgICAgIHJlbG9hZDogdHJ5V3JhcChyZWxvYWQpDQogICAgfTsNCiAgfQ0KICBjb25zdCBtYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOw0KICBmdW5jdGlvbiByZWdpc3RlckhNUihpbnN0YW5jZSkgew0KICAgIGNvbnN0IGlkID0gaW5zdGFuY2UudHlwZS5fX2htcklkOw0KICAgIGxldCByZWNvcmQgPSBtYXAuZ2V0KGlkKTsNCiAgICBpZiAoIXJlY29yZCkgew0KICAgICAgY3JlYXRlUmVjb3JkKGlkLCBpbnN0YW5jZS50eXBlKTsNCiAgICAgIHJlY29yZCA9IG1hcC5nZXQoaWQpOw0KICAgIH0NCiAgICByZWNvcmQuaW5zdGFuY2VzLmFkZChpbnN0YW5jZSk7DQogIH0NCiAgZnVuY3Rpb24gdW5yZWdpc3RlckhNUihpbnN0YW5jZSkgew0KICAgIG1hcC5nZXQoaW5zdGFuY2UudHlwZS5fX2htcklkKS5pbnN0YW5jZXMuZGVsZXRlKGluc3RhbmNlKTsNCiAgfQ0KICBmdW5jdGlvbiBjcmVhdGVSZWNvcmQoaWQsIGluaXRpYWxEZWYpIHsNCiAgICBpZiAobWFwLmhhcyhpZCkpIHsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQogICAgbWFwLnNldChpZCwgew0KICAgICAgaW5pdGlhbERlZjogbm9ybWFsaXplQ2xhc3NDb21wb25lbnQoaW5pdGlhbERlZiksDQogICAgICBpbnN0YW5jZXM6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCkNCiAgICB9KTsNCiAgICByZXR1cm4gdHJ1ZTsNCiAgfQ0KICBmdW5jdGlvbiBub3JtYWxpemVDbGFzc0NvbXBvbmVudChjb21wb25lbnQpIHsNCiAgICByZXR1cm4gaXNDbGFzc0NvbXBvbmVudChjb21wb25lbnQpID8gY29tcG9uZW50Ll9fdmNjT3B0cyA6IGNvbXBvbmVudDsNCiAgfQ0KICBmdW5jdGlvbiByZXJlbmRlcihpZCwgbmV3UmVuZGVyKSB7DQogICAgY29uc3QgcmVjb3JkID0gbWFwLmdldChpZCk7DQogICAgaWYgKCFyZWNvcmQpIHsNCiAgICAgIHJldHVybjsNCiAgICB9DQogICAgcmVjb3JkLmluaXRpYWxEZWYucmVuZGVyID0gbmV3UmVuZGVyOw0KICAgIFsuLi5yZWNvcmQuaW5zdGFuY2VzXS5mb3JFYWNoKChpbnN0YW5jZSkgPT4gew0KICAgICAgaWYgKG5ld1JlbmRlcikgew0KICAgICAgICBpbnN0YW5jZS5yZW5kZXIgPSBuZXdSZW5kZXI7DQogICAgICAgIG5vcm1hbGl6ZUNsYXNzQ29tcG9uZW50KGluc3RhbmNlLnR5cGUpLnJlbmRlciA9IG5ld1JlbmRlcjsNCiAgICAgIH0NCiAgICAgIGluc3RhbmNlLnJlbmRlckNhY2hlID0gW107DQogICAgICBpc0htclVwZGF0aW5nID0gdHJ1ZTsNCiAgICAgIGluc3RhbmNlLnVwZGF0ZSgpOw0KICAgICAgaXNIbXJVcGRhdGluZyA9IGZhbHNlOw0KICAgIH0pOw0KICB9DQogIGZ1bmN0aW9uIHJlbG9hZChpZCwgbmV3Q29tcCkgew0KICAgIGNvbnN0IHJlY29yZCA9IG1hcC5nZXQoaWQpOw0KICAgIGlmICghcmVjb3JkKSByZXR1cm47DQogICAgbmV3Q29tcCA9IG5vcm1hbGl6ZUNsYXNzQ29tcG9uZW50KG5ld0NvbXApOw0KICAgIHVwZGF0ZUNvbXBvbmVudERlZihyZWNvcmQuaW5pdGlhbERlZiwgbmV3Q29tcCk7DQogICAgY29uc3QgaW5zdGFuY2VzID0gWy4uLnJlY29yZC5pbnN0YW5jZXNdOw0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5zdGFuY2VzLmxlbmd0aDsgaSsrKSB7DQogICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpXTsNCiAgICAgIGNvbnN0IG9sZENvbXAgPSBub3JtYWxpemVDbGFzc0NvbXBvbmVudChpbnN0YW5jZS50eXBlKTsNCiAgICAgIGxldCBkaXJ0eUluc3RhbmNlcyA9IGhtckRpcnR5Q29tcG9uZW50cy5nZXQob2xkQ29tcCk7DQogICAgICBpZiAoIWRpcnR5SW5zdGFuY2VzKSB7DQogICAgICAgIGlmIChvbGRDb21wICE9PSByZWNvcmQuaW5pdGlhbERlZikgew0KICAgICAgICAgIHVwZGF0ZUNvbXBvbmVudERlZihvbGRDb21wLCBuZXdDb21wKTsNCiAgICAgICAgfQ0KICAgICAgICBobXJEaXJ0eUNvbXBvbmVudHMuc2V0KG9sZENvbXAsIGRpcnR5SW5zdGFuY2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSk7DQogICAgICB9DQogICAgICBkaXJ0eUluc3RhbmNlcy5hZGQoaW5zdGFuY2UpOw0KICAgICAgaW5zdGFuY2UuYXBwQ29udGV4dC5wcm9wc0NhY2hlLmRlbGV0ZShpbnN0YW5jZS50eXBlKTsNCiAgICAgIGluc3RhbmNlLmFwcENvbnRleHQuZW1pdHNDYWNoZS5kZWxldGUoaW5zdGFuY2UudHlwZSk7DQogICAgICBpbnN0YW5jZS5hcHBDb250ZXh0Lm9wdGlvbnNDYWNoZS5kZWxldGUoaW5zdGFuY2UudHlwZSk7DQogICAgICBpZiAoaW5zdGFuY2UuY2VSZWxvYWQpIHsNCiAgICAgICAgZGlydHlJbnN0YW5jZXMuYWRkKGluc3RhbmNlKTsNCiAgICAgICAgaW5zdGFuY2UuY2VSZWxvYWQobmV3Q29tcC5zdHlsZXMpOw0KICAgICAgICBkaXJ0eUluc3RhbmNlcy5kZWxldGUoaW5zdGFuY2UpOw0KICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5wYXJlbnQpIHsNCiAgICAgICAgcXVldWVKb2IoKCkgPT4gew0KICAgICAgICAgIGlzSG1yVXBkYXRpbmcgPSB0cnVlOw0KICAgICAgICAgIGluc3RhbmNlLnBhcmVudC51cGRhdGUoKTsNCiAgICAgICAgICBpc0htclVwZGF0aW5nID0gZmFsc2U7DQogICAgICAgICAgZGlydHlJbnN0YW5jZXMuZGVsZXRlKGluc3RhbmNlKTsNCiAgICAgICAgfSk7DQogICAgICB9IGVsc2UgaWYgKGluc3RhbmNlLmFwcENvbnRleHQucmVsb2FkKSB7DQogICAgICAgIGluc3RhbmNlLmFwcENvbnRleHQucmVsb2FkKCk7DQogICAgICB9IGVsc2UgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiKSB7DQogICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbnNvbGUud2FybigNCiAgICAgICAgICAiW0hNUl0gUm9vdCBvciBtYW51YWxseSBtb3VudGVkIGluc3RhbmNlIG1vZGlmaWVkLiBGdWxsIHJlbG9hZCByZXF1aXJlZC4iDQogICAgICAgICk7DQogICAgICB9DQogICAgICBpZiAoaW5zdGFuY2Uucm9vdC5jZSAmJiBpbnN0YW5jZSAhPT0gaW5zdGFuY2Uucm9vdCkgew0KICAgICAgICBpbnN0YW5jZS5yb290LmNlLl9yZW1vdmVDaGlsZFN0eWxlKG9sZENvbXApOw0KICAgICAgfQ0KICAgIH0NCiAgICBxdWV1ZVBvc3RGbHVzaENiKCgpID0+IHsNCiAgICAgIGhtckRpcnR5Q29tcG9uZW50cy5jbGVhcigpOw0KICAgIH0pOw0KICB9DQogIGZ1bmN0aW9uIHVwZGF0ZUNvbXBvbmVudERlZihvbGRDb21wLCBuZXdDb21wKSB7DQogICAgZXh0ZW5kKG9sZENvbXAsIG5ld0NvbXApOw0KICAgIGZvciAoY29uc3Qga2V5IGluIG9sZENvbXApIHsNCiAgICAgIGlmIChrZXkgIT09ICJfX2ZpbGUiICYmICEoa2V5IGluIG5ld0NvbXApKSB7DQogICAgICAgIGRlbGV0ZSBvbGRDb21wW2tleV07DQogICAgICB9DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIHRyeVdyYXAoZm4pIHsNCiAgICByZXR1cm4gKGlkLCBhcmcpID0+IHsNCiAgICAgIHRyeSB7DQogICAgICAgIHJldHVybiBmbihpZCwgYXJnKTsNCiAgICAgIH0gY2F0Y2ggKGUpIHsNCiAgICAgICAgY29uc29sZS5lcnJvcihlKTsNCiAgICAgICAgY29uc29sZS53YXJuKA0KICAgICAgICAgIGBbSE1SXSBTb21ldGhpbmcgd2VudCB3cm9uZyBkdXJpbmcgVnVlIGNvbXBvbmVudCBob3QtcmVsb2FkLiBGdWxsIHJlbG9hZCByZXF1aXJlZC5gDQogICAgICAgICk7DQogICAgICB9DQogICAgfTsNCiAgfQ0KDQogIGxldCBkZXZ0b29scyQxOw0KICBsZXQgYnVmZmVyID0gW107DQogIGxldCBkZXZ0b29sc05vdEluc3RhbGxlZCA9IGZhbHNlOw0KICBmdW5jdGlvbiBlbWl0JDEoZXZlbnQsIC4uLmFyZ3MpIHsNCiAgICBpZiAoZGV2dG9vbHMkMSkgew0KICAgICAgZGV2dG9vbHMkMS5lbWl0KGV2ZW50LCAuLi5hcmdzKTsNCiAgICB9IGVsc2UgaWYgKCFkZXZ0b29sc05vdEluc3RhbGxlZCkgew0KICAgICAgYnVmZmVyLnB1c2goeyBldmVudCwgYXJncyB9KTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gc2V0RGV2dG9vbHNIb29rJDEoaG9vaywgdGFyZ2V0KSB7DQogICAgdmFyIF9hLCBfYjsNCiAgICBkZXZ0b29scyQxID0gaG9vazsNCiAgICBpZiAoZGV2dG9vbHMkMSkgew0KICAgICAgZGV2dG9vbHMkMS5lbmFibGVkID0gdHJ1ZTsNCiAgICAgIGJ1ZmZlci5mb3JFYWNoKCh7IGV2ZW50LCBhcmdzIH0pID0+IGRldnRvb2xzJDEuZW1pdChldmVudCwgLi4uYXJncykpOw0KICAgICAgYnVmZmVyID0gW107DQogICAgfSBlbHNlIGlmICgNCiAgICAgIC8vIGhhbmRsZSBsYXRlIGRldnRvb2xzIGluamVjdGlvbiAtIG9ubHkgZG8gdGhpcyBpZiB3ZSBhcmUgaW4gYW4gYWN0dWFsDQogICAgICAvLyBicm93c2VyIGVudmlyb25tZW50IHRvIGF2b2lkIHRoZSB0aW1lciBoYW5kbGUgc3RhbGxpbmcgdGVzdCBydW5uZXIgZXhpdA0KICAgICAgLy8gKCM0ODE1KQ0KICAgICAgdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgLy8gc29tZSBlbnZzIG1vY2sgd2luZG93IGJ1dCBub3QgZnVsbHkNCiAgICAgIHdpbmRvdy5IVE1MRWxlbWVudCAmJiAvLyBhbHNvIGV4Y2x1ZGUganNkb20NCiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1yZXN0cmljdGVkLXN5bnRheA0KICAgICAgISgoX2IgPSAoX2EgPSB3aW5kb3cubmF2aWdhdG9yKSA9PSBudWxsID8gdm9pZCAwIDogX2EudXNlckFnZW50KSA9PSBudWxsID8gdm9pZCAwIDogX2IuaW5jbHVkZXMoImpzZG9tIikpDQogICAgKSB7DQogICAgICBjb25zdCByZXBsYXkgPSB0YXJnZXQuX19WVUVfREVWVE9PTFNfSE9PS19SRVBMQVlfXyA9IHRhcmdldC5fX1ZVRV9ERVZUT09MU19IT09LX1JFUExBWV9fIHx8IFtdOw0KICAgICAgcmVwbGF5LnB1c2goKG5ld0hvb2spID0+IHsNCiAgICAgICAgc2V0RGV2dG9vbHNIb29rJDEobmV3SG9vaywgdGFyZ2V0KTsNCiAgICAgIH0pOw0KICAgICAgc2V0VGltZW91dCgoKSA9PiB7DQogICAgICAgIGlmICghZGV2dG9vbHMkMSkgew0KICAgICAgICAgIHRhcmdldC5fX1ZVRV9ERVZUT09MU19IT09LX1JFUExBWV9fID0gbnVsbDsNCiAgICAgICAgICBkZXZ0b29sc05vdEluc3RhbGxlZCA9IHRydWU7DQogICAgICAgICAgYnVmZmVyID0gW107DQogICAgICAgIH0NCiAgICAgIH0sIDNlMyk7DQogICAgfSBlbHNlIHsNCiAgICAgIGRldnRvb2xzTm90SW5zdGFsbGVkID0gdHJ1ZTsNCiAgICAgIGJ1ZmZlciA9IFtdOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBkZXZ0b29sc0luaXRBcHAoYXBwLCB2ZXJzaW9uKSB7DQogICAgZW1pdCQxKCJhcHA6aW5pdCIgLyogQVBQX0lOSVQgKi8sIGFwcCwgdmVyc2lvbiwgew0KICAgICAgRnJhZ21lbnQsDQogICAgICBUZXh0LA0KICAgICAgQ29tbWVudCwNCiAgICAgIFN0YXRpYw0KICAgIH0pOw0KICB9DQogIGZ1bmN0aW9uIGRldnRvb2xzVW5tb3VudEFwcChhcHApIHsNCiAgICBlbWl0JDEoImFwcDp1bm1vdW50IiAvKiBBUFBfVU5NT1VOVCAqLywgYXBwKTsNCiAgfQ0KICBjb25zdCBkZXZ0b29sc0NvbXBvbmVudEFkZGVkID0gLyogQF9fUFVSRV9fICovIGNyZWF0ZURldnRvb2xzQ29tcG9uZW50SG9vaygiY29tcG9uZW50OmFkZGVkIiAvKiBDT01QT05FTlRfQURERUQgKi8pOw0KICBjb25zdCBkZXZ0b29sc0NvbXBvbmVudFVwZGF0ZWQgPSAvKiBAX19QVVJFX18gKi8gY3JlYXRlRGV2dG9vbHNDb21wb25lbnRIb29rKCJjb21wb25lbnQ6dXBkYXRlZCIgLyogQ09NUE9ORU5UX1VQREFURUQgKi8pOw0KICBjb25zdCBfZGV2dG9vbHNDb21wb25lbnRSZW1vdmVkID0gLyogQF9fUFVSRV9fICovIGNyZWF0ZURldnRvb2xzQ29tcG9uZW50SG9vaygNCiAgICAiY29tcG9uZW50OnJlbW92ZWQiIC8qIENPTVBPTkVOVF9SRU1PVkVEICovDQogICk7DQogIGNvbnN0IGRldnRvb2xzQ29tcG9uZW50UmVtb3ZlZCA9IChjb21wb25lbnQpID0+IHsNCiAgICBpZiAoZGV2dG9vbHMkMSAmJiB0eXBlb2YgZGV2dG9vbHMkMS5jbGVhbnVwQnVmZmVyID09PSAiZnVuY3Rpb24iICYmIC8vIHJlbW92ZSB0aGUgY29tcG9uZW50IGlmIGl0IHdhc24ndCBidWZmZXJlZA0KICAgICFkZXZ0b29scyQxLmNsZWFudXBCdWZmZXIoY29tcG9uZW50KSkgew0KICAgICAgX2RldnRvb2xzQ29tcG9uZW50UmVtb3ZlZChjb21wb25lbnQpOw0KICAgIH0NCiAgfTsNCiAgLyohICNfX05PX1NJREVfRUZGRUNUU19fICovDQogIC8vIEBfX05PX1NJREVfRUZGRUNUU19fDQogIGZ1bmN0aW9uIGNyZWF0ZURldnRvb2xzQ29tcG9uZW50SG9vayhob29rKSB7DQogICAgcmV0dXJuIChjb21wb25lbnQpID0+IHsNCiAgICAgIGVtaXQkMSgNCiAgICAgICAgaG9vaywNCiAgICAgICAgY29tcG9uZW50LmFwcENvbnRleHQuYXBwLA0KICAgICAgICBjb21wb25lbnQudWlkLA0KICAgICAgICBjb21wb25lbnQucGFyZW50ID8gY29tcG9uZW50LnBhcmVudC51aWQgOiB2b2lkIDAsDQogICAgICAgIGNvbXBvbmVudA0KICAgICAgKTsNCiAgICB9Ow0KICB9DQogIGNvbnN0IGRldnRvb2xzUGVyZlN0YXJ0ID0gLyogQF9fUFVSRV9fICovIGNyZWF0ZURldnRvb2xzUGVyZm9ybWFuY2VIb29rKCJwZXJmOnN0YXJ0IiAvKiBQRVJGT1JNQU5DRV9TVEFSVCAqLyk7DQogIGNvbnN0IGRldnRvb2xzUGVyZkVuZCA9IC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVEZXZ0b29sc1BlcmZvcm1hbmNlSG9vaygicGVyZjplbmQiIC8qIFBFUkZPUk1BTkNFX0VORCAqLyk7DQogIGZ1bmN0aW9uIGNyZWF0ZURldnRvb2xzUGVyZm9ybWFuY2VIb29rKGhvb2spIHsNCiAgICByZXR1cm4gKGNvbXBvbmVudCwgdHlwZSwgdGltZSkgPT4gew0KICAgICAgZW1pdCQxKGhvb2ssIGNvbXBvbmVudC5hcHBDb250ZXh0LmFwcCwgY29tcG9uZW50LnVpZCwgY29tcG9uZW50LCB0eXBlLCB0aW1lKTsNCiAgICB9Ow0KICB9DQogIGZ1bmN0aW9uIGRldnRvb2xzQ29tcG9uZW50RW1pdChjb21wb25lbnQsIGV2ZW50LCBwYXJhbXMpIHsNCiAgICBlbWl0JDEoDQogICAgICAiY29tcG9uZW50OmVtaXQiIC8qIENPTVBPTkVOVF9FTUlUICovLA0KICAgICAgY29tcG9uZW50LmFwcENvbnRleHQuYXBwLA0KICAgICAgY29tcG9uZW50LA0KICAgICAgZXZlbnQsDQogICAgICBwYXJhbXMNCiAgICApOw0KICB9DQoNCiAgbGV0IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSA9IG51bGw7DQogIGxldCBjdXJyZW50U2NvcGVJZCA9IG51bGw7DQogIGZ1bmN0aW9uIHNldEN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZShpbnN0YW5jZSkgew0KICAgIGNvbnN0IHByZXYgPSBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2U7DQogICAgY3VycmVudFJlbmRlcmluZ0luc3RhbmNlID0gaW5zdGFuY2U7DQogICAgY3VycmVudFNjb3BlSWQgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS50eXBlLl9fc2NvcGVJZCB8fCBudWxsOw0KICAgIHJldHVybiBwcmV2Ow0KICB9DQogIGZ1bmN0aW9uIHB1c2hTY29wZUlkKGlkKSB7DQogICAgY3VycmVudFNjb3BlSWQgPSBpZDsNCiAgfQ0KICBmdW5jdGlvbiBwb3BTY29wZUlkKCkgew0KICAgIGN1cnJlbnRTY29wZUlkID0gbnVsbDsNCiAgfQ0KICBjb25zdCB3aXRoU2NvcGVJZCA9IChfaWQpID0+IHdpdGhDdHg7DQogIGZ1bmN0aW9uIHdpdGhDdHgoZm4sIGN0eCA9IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSwgaXNOb25TY29wZWRTbG90KSB7DQogICAgaWYgKCFjdHgpIHJldHVybiBmbjsNCiAgICBpZiAoZm4uX24pIHsNCiAgICAgIHJldHVybiBmbjsNCiAgICB9DQogICAgY29uc3QgcmVuZGVyRm5XaXRoQ29udGV4dCA9ICguLi5hcmdzKSA9PiB7DQogICAgICBpZiAocmVuZGVyRm5XaXRoQ29udGV4dC5fZCkgew0KICAgICAgICBzZXRCbG9ja1RyYWNraW5nKC0xKTsNCiAgICAgIH0NCiAgICAgIGNvbnN0IHByZXZJbnN0YW5jZSA9IHNldEN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZShjdHgpOw0KICAgICAgbGV0IHJlczsNCiAgICAgIHRyeSB7DQogICAgICAgIHJlcyA9IGZuKC4uLmFyZ3MpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgc2V0Q3VycmVudFJlbmRlcmluZ0luc3RhbmNlKHByZXZJbnN0YW5jZSk7DQogICAgICAgIGlmIChyZW5kZXJGbldpdGhDb250ZXh0Ll9kKSB7DQogICAgICAgICAgc2V0QmxvY2tUcmFja2luZygxKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgew0KICAgICAgICBkZXZ0b29sc0NvbXBvbmVudFVwZGF0ZWQoY3R4KTsNCiAgICAgIH0NCiAgICAgIHJldHVybiByZXM7DQogICAgfTsNCiAgICByZW5kZXJGbldpdGhDb250ZXh0Ll9uID0gdHJ1ZTsNCiAgICByZW5kZXJGbldpdGhDb250ZXh0Ll9jID0gdHJ1ZTsNCiAgICByZW5kZXJGbldpdGhDb250ZXh0Ll9kID0gdHJ1ZTsNCiAgICByZXR1cm4gcmVuZGVyRm5XaXRoQ29udGV4dDsNCiAgfQ0KDQogIGZ1bmN0aW9uIHZhbGlkYXRlRGlyZWN0aXZlTmFtZShuYW1lKSB7DQogICAgaWYgKGlzQnVpbHRJbkRpcmVjdGl2ZShuYW1lKSkgew0KICAgICAgd2FybiQxKCJEbyBub3QgdXNlIGJ1aWx0LWluIGRpcmVjdGl2ZSBpZHMgYXMgY3VzdG9tIGRpcmVjdGl2ZSBpZDogIiArIG5hbWUpOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiB3aXRoRGlyZWN0aXZlcyh2bm9kZSwgZGlyZWN0aXZlcykgew0KICAgIGlmIChjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UgPT09IG51bGwpIHsNCiAgICAgIHdhcm4kMShgd2l0aERpcmVjdGl2ZXMgY2FuIG9ubHkgYmUgdXNlZCBpbnNpZGUgcmVuZGVyIGZ1bmN0aW9ucy5gKTsNCiAgICAgIHJldHVybiB2bm9kZTsNCiAgICB9DQogICAgY29uc3QgaW5zdGFuY2UgPSBnZXRDb21wb25lbnRQdWJsaWNJbnN0YW5jZShjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UpOw0KICAgIGNvbnN0IGJpbmRpbmdzID0gdm5vZGUuZGlycyB8fCAodm5vZGUuZGlycyA9IFtdKTsNCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRpcmVjdGl2ZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgIGxldCBbZGlyLCB2YWx1ZSwgYXJnLCBtb2RpZmllcnMgPSBFTVBUWV9PQkpdID0gZGlyZWN0aXZlc1tpXTsNCiAgICAgIGlmIChkaXIpIHsNCiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZGlyKSkgew0KICAgICAgICAgIGRpciA9IHsNCiAgICAgICAgICAgIG1vdW50ZWQ6IGRpciwNCiAgICAgICAgICAgIHVwZGF0ZWQ6IGRpcg0KICAgICAgICAgIH07DQogICAgICAgIH0NCiAgICAgICAgaWYgKGRpci5kZWVwKSB7DQogICAgICAgICAgdHJhdmVyc2UodmFsdWUpOw0KICAgICAgICB9DQogICAgICAgIGJpbmRpbmdzLnB1c2goew0KICAgICAgICAgIGRpciwNCiAgICAgICAgICBpbnN0YW5jZSwNCiAgICAgICAgICB2YWx1ZSwNCiAgICAgICAgICBvbGRWYWx1ZTogdm9pZCAwLA0KICAgICAgICAgIGFyZywNCiAgICAgICAgICBtb2RpZmllcnMNCiAgICAgICAgfSk7DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiB2bm9kZTsNCiAgfQ0KICBmdW5jdGlvbiBpbnZva2VEaXJlY3RpdmVIb29rKHZub2RlLCBwcmV2Vk5vZGUsIGluc3RhbmNlLCBuYW1lKSB7DQogICAgY29uc3QgYmluZGluZ3MgPSB2bm9kZS5kaXJzOw0KICAgIGNvbnN0IG9sZEJpbmRpbmdzID0gcHJldlZOb2RlICYmIHByZXZWTm9kZS5kaXJzOw0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmluZGluZ3MubGVuZ3RoOyBpKyspIHsNCiAgICAgIGNvbnN0IGJpbmRpbmcgPSBiaW5kaW5nc1tpXTsNCiAgICAgIGlmIChvbGRCaW5kaW5ncykgew0KICAgICAgICBiaW5kaW5nLm9sZFZhbHVlID0gb2xkQmluZGluZ3NbaV0udmFsdWU7DQogICAgICB9DQogICAgICBsZXQgaG9vayA9IGJpbmRpbmcuZGlyW25hbWVdOw0KICAgICAgaWYgKGhvb2spIHsNCiAgICAgICAgcGF1c2VUcmFja2luZygpOw0KICAgICAgICBjYWxsV2l0aEFzeW5jRXJyb3JIYW5kbGluZyhob29rLCBpbnN0YW5jZSwgOCwgWw0KICAgICAgICAgIHZub2RlLmVsLA0KICAgICAgICAgIGJpbmRpbmcsDQogICAgICAgICAgdm5vZGUsDQogICAgICAgICAgcHJldlZOb2RlDQogICAgICAgIF0pOw0KICAgICAgICByZXNldFRyYWNraW5nKCk7DQogICAgICB9DQogICAgfQ0KICB9DQoNCiAgY29uc3QgVGVsZXBvcnRFbmRLZXkgPSBTeW1ib2woIl92dGUiKTsNCiAgY29uc3QgaXNUZWxlcG9ydCA9ICh0eXBlKSA9PiB0eXBlLl9faXNUZWxlcG9ydDsNCiAgY29uc3QgaXNUZWxlcG9ydERpc2FibGVkID0gKHByb3BzKSA9PiBwcm9wcyAmJiAocHJvcHMuZGlzYWJsZWQgfHwgcHJvcHMuZGlzYWJsZWQgPT09ICIiKTsNCiAgY29uc3QgaXNUZWxlcG9ydERlZmVycmVkID0gKHByb3BzKSA9PiBwcm9wcyAmJiAocHJvcHMuZGVmZXIgfHwgcHJvcHMuZGVmZXIgPT09ICIiKTsNCiAgY29uc3QgaXNUYXJnZXRTVkcgPSAodGFyZ2V0KSA9PiB0eXBlb2YgU1ZHRWxlbWVudCAhPT0gInVuZGVmaW5lZCIgJiYgdGFyZ2V0IGluc3RhbmNlb2YgU1ZHRWxlbWVudDsNCiAgY29uc3QgaXNUYXJnZXRNYXRoTUwgPSAodGFyZ2V0KSA9PiB0eXBlb2YgTWF0aE1MRWxlbWVudCA9PT0gImZ1bmN0aW9uIiAmJiB0YXJnZXQgaW5zdGFuY2VvZiBNYXRoTUxFbGVtZW50Ow0KICBjb25zdCByZXNvbHZlVGFyZ2V0ID0gKHByb3BzLCBzZWxlY3QpID0+IHsNCiAgICBjb25zdCB0YXJnZXRTZWxlY3RvciA9IHByb3BzICYmIHByb3BzLnRvOw0KICAgIGlmIChpc1N0cmluZyh0YXJnZXRTZWxlY3RvcikpIHsNCiAgICAgIGlmICghc2VsZWN0KSB7DQogICAgICAgIHdhcm4kMSgNCiAgICAgICAgICBgQ3VycmVudCByZW5kZXJlciBkb2VzIG5vdCBzdXBwb3J0IHN0cmluZyB0YXJnZXQgZm9yIFRlbGVwb3J0cy4gKG1pc3NpbmcgcXVlcnlTZWxlY3RvciByZW5kZXJlciBvcHRpb24pYA0KICAgICAgICApOw0KICAgICAgICByZXR1cm4gbnVsbDsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbnN0IHRhcmdldCA9IHNlbGVjdCh0YXJnZXRTZWxlY3Rvcik7DQogICAgICAgIGlmICghdGFyZ2V0ICYmICFpc1RlbGVwb3J0RGlzYWJsZWQocHJvcHMpKSB7DQogICAgICAgICAgd2FybiQxKA0KICAgICAgICAgICAgYEZhaWxlZCB0byBsb2NhdGUgVGVsZXBvcnQgdGFyZ2V0IHdpdGggc2VsZWN0b3IgIiR7dGFyZ2V0U2VsZWN0b3J9Ii4gTm90ZSB0aGUgdGFyZ2V0IGVsZW1lbnQgbXVzdCBleGlzdCBiZWZvcmUgdGhlIGNvbXBvbmVudCBpcyBtb3VudGVkIC0gaS5lLiB0aGUgdGFyZ2V0IGNhbm5vdCBiZSByZW5kZXJlZCBieSB0aGUgY29tcG9uZW50IGl0c2VsZiwgYW5kIGlkZWFsbHkgc2hvdWxkIGJlIG91dHNpZGUgb2YgdGhlIGVudGlyZSBWdWUgY29tcG9uZW50IHRyZWUuYA0KICAgICAgICAgICk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRhcmdldDsNCiAgICAgIH0NCiAgICB9IGVsc2Ugew0KICAgICAgaWYgKCF0YXJnZXRTZWxlY3RvciAmJiAhaXNUZWxlcG9ydERpc2FibGVkKHByb3BzKSkgew0KICAgICAgICB3YXJuJDEoYEludmFsaWQgVGVsZXBvcnQgdGFyZ2V0OiAke3RhcmdldFNlbGVjdG9yfWApOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIHRhcmdldFNlbGVjdG9yOw0KICAgIH0NCiAgfTsNCiAgY29uc3QgVGVsZXBvcnRJbXBsID0gew0KICAgIG5hbWU6ICJUZWxlcG9ydCIsDQogICAgX19pc1RlbGVwb3J0OiB0cnVlLA0KICAgIHByb2Nlc3MobjEsIG4yLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCwgaW50ZXJuYWxzKSB7DQogICAgICBjb25zdCB7DQogICAgICAgIG1jOiBtb3VudENoaWxkcmVuLA0KICAgICAgICBwYzogcGF0Y2hDaGlsZHJlbiwNCiAgICAgICAgcGJjOiBwYXRjaEJsb2NrQ2hpbGRyZW4sDQogICAgICAgIG86IHsgaW5zZXJ0LCBxdWVyeVNlbGVjdG9yLCBjcmVhdGVUZXh0LCBjcmVhdGVDb21tZW50IH0NCiAgICAgIH0gPSBpbnRlcm5hbHM7DQogICAgICBjb25zdCBkaXNhYmxlZCA9IGlzVGVsZXBvcnREaXNhYmxlZChuMi5wcm9wcyk7DQogICAgICBsZXQgeyBzaGFwZUZsYWcsIGNoaWxkcmVuLCBkeW5hbWljQ2hpbGRyZW4gfSA9IG4yOw0KICAgICAgaWYgKGlzSG1yVXBkYXRpbmcpIHsNCiAgICAgICAgb3B0aW1pemVkID0gZmFsc2U7DQogICAgICAgIGR5bmFtaWNDaGlsZHJlbiA9IG51bGw7DQogICAgICB9DQogICAgICBpZiAobjEgPT0gbnVsbCkgew0KICAgICAgICBjb25zdCBwbGFjZWhvbGRlciA9IG4yLmVsID0gY3JlYXRlQ29tbWVudCgidGVsZXBvcnQgc3RhcnQiKSA7DQogICAgICAgIGNvbnN0IG1haW5BbmNob3IgPSBuMi5hbmNob3IgPSBjcmVhdGVDb21tZW50KCJ0ZWxlcG9ydCBlbmQiKSA7DQogICAgICAgIGluc2VydChwbGFjZWhvbGRlciwgY29udGFpbmVyLCBhbmNob3IpOw0KICAgICAgICBpbnNlcnQobWFpbkFuY2hvciwgY29udGFpbmVyLCBhbmNob3IpOw0KICAgICAgICBjb25zdCBtb3VudCA9IChjb250YWluZXIyLCBhbmNob3IyKSA9PiB7DQogICAgICAgICAgaWYgKHNoYXBlRmxhZyAmIDE2KSB7DQogICAgICAgICAgICBpZiAocGFyZW50Q29tcG9uZW50ICYmIHBhcmVudENvbXBvbmVudC5pc0NFKSB7DQogICAgICAgICAgICAgIHBhcmVudENvbXBvbmVudC5jZS5fdGVsZXBvcnRUYXJnZXQgPSBjb250YWluZXIyOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgbW91bnRDaGlsZHJlbigNCiAgICAgICAgICAgICAgY2hpbGRyZW4sDQogICAgICAgICAgICAgIGNvbnRhaW5lcjIsDQogICAgICAgICAgICAgIGFuY2hvcjIsDQogICAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgICAgICBvcHRpbWl6ZWQNCiAgICAgICAgICAgICk7DQogICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICBjb25zdCBtb3VudFRvVGFyZ2V0ID0gKCkgPT4gew0KICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG4yLnRhcmdldCA9IHJlc29sdmVUYXJnZXQobjIucHJvcHMsIHF1ZXJ5U2VsZWN0b3IpOw0KICAgICAgICAgIGNvbnN0IHRhcmdldEFuY2hvciA9IHByZXBhcmVBbmNob3IodGFyZ2V0LCBuMiwgY3JlYXRlVGV4dCwgaW5zZXJ0KTsNCiAgICAgICAgICBpZiAodGFyZ2V0KSB7DQogICAgICAgICAgICBpZiAobmFtZXNwYWNlICE9PSAic3ZnIiAmJiBpc1RhcmdldFNWRyh0YXJnZXQpKSB7DQogICAgICAgICAgICAgIG5hbWVzcGFjZSA9ICJzdmciOw0KICAgICAgICAgICAgfSBlbHNlIGlmIChuYW1lc3BhY2UgIT09ICJtYXRobWwiICYmIGlzVGFyZ2V0TWF0aE1MKHRhcmdldCkpIHsNCiAgICAgICAgICAgICAgbmFtZXNwYWNlID0gIm1hdGhtbCI7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoIWRpc2FibGVkKSB7DQogICAgICAgICAgICAgIG1vdW50KHRhcmdldCwgdGFyZ2V0QW5jaG9yKTsNCiAgICAgICAgICAgICAgdXBkYXRlQ3NzVmFycyhuMiwgZmFsc2UpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0gZWxzZSBpZiAoIWRpc2FibGVkKSB7DQogICAgICAgICAgICB3YXJuJDEoDQogICAgICAgICAgICAgICJJbnZhbGlkIFRlbGVwb3J0IHRhcmdldCBvbiBtb3VudDoiLA0KICAgICAgICAgICAgICB0YXJnZXQsDQogICAgICAgICAgICAgIGAoJHt0eXBlb2YgdGFyZ2V0fSlgDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICAgICAgaWYgKGRpc2FibGVkKSB7DQogICAgICAgICAgbW91bnQoY29udGFpbmVyLCBtYWluQW5jaG9yKTsNCiAgICAgICAgICB1cGRhdGVDc3NWYXJzKG4yLCB0cnVlKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoaXNUZWxlcG9ydERlZmVycmVkKG4yLnByb3BzKSkgew0KICAgICAgICAgIG4yLmVsLl9faXNNb3VudGVkID0gZmFsc2U7DQogICAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KCgpID0+IHsNCiAgICAgICAgICAgIG1vdW50VG9UYXJnZXQoKTsNCiAgICAgICAgICAgIGRlbGV0ZSBuMi5lbC5fX2lzTW91bnRlZDsNCiAgICAgICAgICB9LCBwYXJlbnRTdXNwZW5zZSk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgbW91bnRUb1RhcmdldCgpOw0KICAgICAgICB9DQogICAgICB9IGVsc2Ugew0KICAgICAgICBpZiAoaXNUZWxlcG9ydERlZmVycmVkKG4yLnByb3BzKSAmJiBuMS5lbC5fX2lzTW91bnRlZCA9PT0gZmFsc2UpIHsNCiAgICAgICAgICBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QoKCkgPT4gew0KICAgICAgICAgICAgVGVsZXBvcnRJbXBsLnByb2Nlc3MoDQogICAgICAgICAgICAgIG4xLA0KICAgICAgICAgICAgICBuMiwNCiAgICAgICAgICAgICAgY29udGFpbmVyLA0KICAgICAgICAgICAgICBhbmNob3IsDQogICAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgICAgICBvcHRpbWl6ZWQsDQogICAgICAgICAgICAgIGludGVybmFscw0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9LCBwYXJlbnRTdXNwZW5zZSk7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIG4yLmVsID0gbjEuZWw7DQogICAgICAgIG4yLnRhcmdldFN0YXJ0ID0gbjEudGFyZ2V0U3RhcnQ7DQogICAgICAgIGNvbnN0IG1haW5BbmNob3IgPSBuMi5hbmNob3IgPSBuMS5hbmNob3I7DQogICAgICAgIGNvbnN0IHRhcmdldCA9IG4yLnRhcmdldCA9IG4xLnRhcmdldDsNCiAgICAgICAgY29uc3QgdGFyZ2V0QW5jaG9yID0gbjIudGFyZ2V0QW5jaG9yID0gbjEudGFyZ2V0QW5jaG9yOw0KICAgICAgICBjb25zdCB3YXNEaXNhYmxlZCA9IGlzVGVsZXBvcnREaXNhYmxlZChuMS5wcm9wcyk7DQogICAgICAgIGNvbnN0IGN1cnJlbnRDb250YWluZXIgPSB3YXNEaXNhYmxlZCA/IGNvbnRhaW5lciA6IHRhcmdldDsNCiAgICAgICAgY29uc3QgY3VycmVudEFuY2hvciA9IHdhc0Rpc2FibGVkID8gbWFpbkFuY2hvciA6IHRhcmdldEFuY2hvcjsNCiAgICAgICAgaWYgKG5hbWVzcGFjZSA9PT0gInN2ZyIgfHwgaXNUYXJnZXRTVkcodGFyZ2V0KSkgew0KICAgICAgICAgIG5hbWVzcGFjZSA9ICJzdmciOw0KICAgICAgICB9IGVsc2UgaWYgKG5hbWVzcGFjZSA9PT0gIm1hdGhtbCIgfHwgaXNUYXJnZXRNYXRoTUwodGFyZ2V0KSkgew0KICAgICAgICAgIG5hbWVzcGFjZSA9ICJtYXRobWwiOw0KICAgICAgICB9DQogICAgICAgIGlmIChkeW5hbWljQ2hpbGRyZW4pIHsNCiAgICAgICAgICBwYXRjaEJsb2NrQ2hpbGRyZW4oDQogICAgICAgICAgICBuMS5keW5hbWljQ2hpbGRyZW4sDQogICAgICAgICAgICBkeW5hbWljQ2hpbGRyZW4sDQogICAgICAgICAgICBjdXJyZW50Q29udGFpbmVyLA0KICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgICBzbG90U2NvcGVJZHMNCiAgICAgICAgICApOw0KICAgICAgICAgIHRyYXZlcnNlU3RhdGljQ2hpbGRyZW4objEsIG4yLCBmYWxzZSk7DQogICAgICAgIH0gZWxzZSBpZiAoIW9wdGltaXplZCkgew0KICAgICAgICAgIHBhdGNoQ2hpbGRyZW4oDQogICAgICAgICAgICBuMSwNCiAgICAgICAgICAgIG4yLA0KICAgICAgICAgICAgY3VycmVudENvbnRhaW5lciwNCiAgICAgICAgICAgIGN1cnJlbnRBbmNob3IsDQogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICAgIGZhbHNlDQogICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoZGlzYWJsZWQpIHsNCiAgICAgICAgICBpZiAoIXdhc0Rpc2FibGVkKSB7DQogICAgICAgICAgICBtb3ZlVGVsZXBvcnQoDQogICAgICAgICAgICAgIG4yLA0KICAgICAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgICAgIG1haW5BbmNob3IsDQogICAgICAgICAgICAgIGludGVybmFscywNCiAgICAgICAgICAgICAgMQ0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgaWYgKG4yLnByb3BzICYmIG4xLnByb3BzICYmIG4yLnByb3BzLnRvICE9PSBuMS5wcm9wcy50bykgew0KICAgICAgICAgICAgICBuMi5wcm9wcy50byA9IG4xLnByb3BzLnRvOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBpZiAoKG4yLnByb3BzICYmIG4yLnByb3BzLnRvKSAhPT0gKG4xLnByb3BzICYmIG4xLnByb3BzLnRvKSkgew0KICAgICAgICAgICAgY29uc3QgbmV4dFRhcmdldCA9IG4yLnRhcmdldCA9IHJlc29sdmVUYXJnZXQoDQogICAgICAgICAgICAgIG4yLnByb3BzLA0KICAgICAgICAgICAgICBxdWVyeVNlbGVjdG9yDQogICAgICAgICAgICApOw0KICAgICAgICAgICAgaWYgKG5leHRUYXJnZXQpIHsNCiAgICAgICAgICAgICAgbW92ZVRlbGVwb3J0KA0KICAgICAgICAgICAgICAgIG4yLA0KICAgICAgICAgICAgICAgIG5leHRUYXJnZXQsDQogICAgICAgICAgICAgICAgbnVsbCwNCiAgICAgICAgICAgICAgICBpbnRlcm5hbHMsDQogICAgICAgICAgICAgICAgMA0KICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgd2FybiQxKA0KICAgICAgICAgICAgICAgICJJbnZhbGlkIFRlbGVwb3J0IHRhcmdldCBvbiB1cGRhdGU6IiwNCiAgICAgICAgICAgICAgICB0YXJnZXQsDQogICAgICAgICAgICAgICAgYCgke3R5cGVvZiB0YXJnZXR9KWANCiAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9IGVsc2UgaWYgKHdhc0Rpc2FibGVkKSB7DQogICAgICAgICAgICBtb3ZlVGVsZXBvcnQoDQogICAgICAgICAgICAgIG4yLA0KICAgICAgICAgICAgICB0YXJnZXQsDQogICAgICAgICAgICAgIHRhcmdldEFuY2hvciwNCiAgICAgICAgICAgICAgaW50ZXJuYWxzLA0KICAgICAgICAgICAgICAxDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICB1cGRhdGVDc3NWYXJzKG4yLCBkaXNhYmxlZCk7DQogICAgICB9DQogICAgfSwNCiAgICByZW1vdmUodm5vZGUsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHsgdW06IHVubW91bnQsIG86IHsgcmVtb3ZlOiBob3N0UmVtb3ZlIH0gfSwgZG9SZW1vdmUpIHsNCiAgICAgIGNvbnN0IHsNCiAgICAgICAgc2hhcGVGbGFnLA0KICAgICAgICBjaGlsZHJlbiwNCiAgICAgICAgYW5jaG9yLA0KICAgICAgICB0YXJnZXRTdGFydCwNCiAgICAgICAgdGFyZ2V0QW5jaG9yLA0KICAgICAgICB0YXJnZXQsDQogICAgICAgIHByb3BzDQogICAgICB9ID0gdm5vZGU7DQogICAgICBpZiAodGFyZ2V0KSB7DQogICAgICAgIGhvc3RSZW1vdmUodGFyZ2V0U3RhcnQpOw0KICAgICAgICBob3N0UmVtb3ZlKHRhcmdldEFuY2hvcik7DQogICAgICB9DQogICAgICBkb1JlbW92ZSAmJiBob3N0UmVtb3ZlKGFuY2hvcik7DQogICAgICBpZiAoc2hhcGVGbGFnICYgMTYpIHsNCiAgICAgICAgY29uc3Qgc2hvdWxkUmVtb3ZlID0gZG9SZW1vdmUgfHwgIWlzVGVsZXBvcnREaXNhYmxlZChwcm9wcyk7DQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICBjb25zdCBjaGlsZCA9IGNoaWxkcmVuW2ldOw0KICAgICAgICAgIHVubW91bnQoDQogICAgICAgICAgICBjaGlsZCwNCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLA0KICAgICAgICAgICAgc2hvdWxkUmVtb3ZlLA0KICAgICAgICAgICAgISFjaGlsZC5keW5hbWljQ2hpbGRyZW4NCiAgICAgICAgICApOw0KICAgICAgICB9DQogICAgICB9DQogICAgfSwNCiAgICBtb3ZlOiBtb3ZlVGVsZXBvcnQsDQogICAgaHlkcmF0ZTogaHlkcmF0ZVRlbGVwb3J0DQogIH07DQogIGZ1bmN0aW9uIG1vdmVUZWxlcG9ydCh2bm9kZSwgY29udGFpbmVyLCBwYXJlbnRBbmNob3IsIHsgbzogeyBpbnNlcnQgfSwgbTogbW92ZSB9LCBtb3ZlVHlwZSA9IDIpIHsNCiAgICBpZiAobW92ZVR5cGUgPT09IDApIHsNCiAgICAgIGluc2VydCh2bm9kZS50YXJnZXRBbmNob3IsIGNvbnRhaW5lciwgcGFyZW50QW5jaG9yKTsNCiAgICB9DQogICAgY29uc3QgeyBlbCwgYW5jaG9yLCBzaGFwZUZsYWcsIGNoaWxkcmVuLCBwcm9wcyB9ID0gdm5vZGU7DQogICAgY29uc3QgaXNSZW9yZGVyID0gbW92ZVR5cGUgPT09IDI7DQogICAgaWYgKGlzUmVvcmRlcikgew0KICAgICAgaW5zZXJ0KGVsLCBjb250YWluZXIsIHBhcmVudEFuY2hvcik7DQogICAgfQ0KICAgIGlmICghaXNSZW9yZGVyIHx8IGlzVGVsZXBvcnREaXNhYmxlZChwcm9wcykpIHsNCiAgICAgIGlmIChzaGFwZUZsYWcgJiAxNikgew0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgbW92ZSgNCiAgICAgICAgICAgIGNoaWxkcmVuW2ldLA0KICAgICAgICAgICAgY29udGFpbmVyLA0KICAgICAgICAgICAgcGFyZW50QW5jaG9yLA0KICAgICAgICAgICAgMg0KICAgICAgICAgICk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogICAgaWYgKGlzUmVvcmRlcikgew0KICAgICAgaW5zZXJ0KGFuY2hvciwgY29udGFpbmVyLCBwYXJlbnRBbmNob3IpOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBoeWRyYXRlVGVsZXBvcnQobm9kZSwgdm5vZGUsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCB7DQogICAgbzogeyBuZXh0U2libGluZywgcGFyZW50Tm9kZSwgcXVlcnlTZWxlY3RvciwgaW5zZXJ0LCBjcmVhdGVUZXh0IH0NCiAgfSwgaHlkcmF0ZUNoaWxkcmVuKSB7DQogICAgY29uc3QgdGFyZ2V0ID0gdm5vZGUudGFyZ2V0ID0gcmVzb2x2ZVRhcmdldCgNCiAgICAgIHZub2RlLnByb3BzLA0KICAgICAgcXVlcnlTZWxlY3Rvcg0KICAgICk7DQogICAgaWYgKHRhcmdldCkgew0KICAgICAgY29uc3QgZGlzYWJsZWQgPSBpc1RlbGVwb3J0RGlzYWJsZWQodm5vZGUucHJvcHMpOw0KICAgICAgY29uc3QgdGFyZ2V0Tm9kZSA9IHRhcmdldC5fbHBhIHx8IHRhcmdldC5maXJzdENoaWxkOw0KICAgICAgaWYgKHZub2RlLnNoYXBlRmxhZyAmIDE2KSB7DQogICAgICAgIGlmIChkaXNhYmxlZCkgew0KICAgICAgICAgIHZub2RlLmFuY2hvciA9IGh5ZHJhdGVDaGlsZHJlbigNCiAgICAgICAgICAgIG5leHRTaWJsaW5nKG5vZGUpLA0KICAgICAgICAgICAgdm5vZGUsDQogICAgICAgICAgICBwYXJlbnROb2RlKG5vZGUpLA0KICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICBzbG90U2NvcGVJZHMsDQogICAgICAgICAgICBvcHRpbWl6ZWQNCiAgICAgICAgICApOw0KICAgICAgICAgIHZub2RlLnRhcmdldFN0YXJ0ID0gdGFyZ2V0Tm9kZTsNCiAgICAgICAgICB2bm9kZS50YXJnZXRBbmNob3IgPSB0YXJnZXROb2RlICYmIG5leHRTaWJsaW5nKHRhcmdldE5vZGUpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHZub2RlLmFuY2hvciA9IG5leHRTaWJsaW5nKG5vZGUpOw0KICAgICAgICAgIGxldCB0YXJnZXRBbmNob3IgPSB0YXJnZXROb2RlOw0KICAgICAgICAgIHdoaWxlICh0YXJnZXRBbmNob3IpIHsNCiAgICAgICAgICAgIGlmICh0YXJnZXRBbmNob3IgJiYgdGFyZ2V0QW5jaG9yLm5vZGVUeXBlID09PSA4KSB7DQogICAgICAgICAgICAgIGlmICh0YXJnZXRBbmNob3IuZGF0YSA9PT0gInRlbGVwb3J0IHN0YXJ0IGFuY2hvciIpIHsNCiAgICAgICAgICAgICAgICB2bm9kZS50YXJnZXRTdGFydCA9IHRhcmdldEFuY2hvcjsNCiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0YXJnZXRBbmNob3IuZGF0YSA9PT0gInRlbGVwb3J0IGFuY2hvciIpIHsNCiAgICAgICAgICAgICAgICB2bm9kZS50YXJnZXRBbmNob3IgPSB0YXJnZXRBbmNob3I7DQogICAgICAgICAgICAgICAgdGFyZ2V0Ll9scGEgPSB2bm9kZS50YXJnZXRBbmNob3IgJiYgbmV4dFNpYmxpbmcodm5vZGUudGFyZ2V0QW5jaG9yKTsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdGFyZ2V0QW5jaG9yID0gbmV4dFNpYmxpbmcodGFyZ2V0QW5jaG9yKTsNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKCF2bm9kZS50YXJnZXRBbmNob3IpIHsNCiAgICAgICAgICAgIHByZXBhcmVBbmNob3IodGFyZ2V0LCB2bm9kZSwgY3JlYXRlVGV4dCwgaW5zZXJ0KTsNCiAgICAgICAgICB9DQogICAgICAgICAgaHlkcmF0ZUNoaWxkcmVuKA0KICAgICAgICAgICAgdGFyZ2V0Tm9kZSAmJiBuZXh0U2libGluZyh0YXJnZXROb2RlKSwNCiAgICAgICAgICAgIHZub2RlLA0KICAgICAgICAgICAgdGFyZ2V0LA0KICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICBzbG90U2NvcGVJZHMsDQogICAgICAgICAgICBvcHRpbWl6ZWQNCiAgICAgICAgICApOw0KICAgICAgICB9DQogICAgICB9DQogICAgICB1cGRhdGVDc3NWYXJzKHZub2RlLCBkaXNhYmxlZCk7DQogICAgfQ0KICAgIHJldHVybiB2bm9kZS5hbmNob3IgJiYgbmV4dFNpYmxpbmcodm5vZGUuYW5jaG9yKTsNCiAgfQ0KICBjb25zdCBUZWxlcG9ydCA9IFRlbGVwb3J0SW1wbDsNCiAgZnVuY3Rpb24gdXBkYXRlQ3NzVmFycyh2bm9kZSwgaXNEaXNhYmxlZCkgew0KICAgIGNvbnN0IGN0eCA9IHZub2RlLmN0eDsNCiAgICBpZiAoY3R4ICYmIGN0eC51dCkgew0KICAgICAgbGV0IG5vZGUsIGFuY2hvcjsNCiAgICAgIGlmIChpc0Rpc2FibGVkKSB7DQogICAgICAgIG5vZGUgPSB2bm9kZS5lbDsNCiAgICAgICAgYW5jaG9yID0gdm5vZGUuYW5jaG9yOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgbm9kZSA9IHZub2RlLnRhcmdldFN0YXJ0Ow0KICAgICAgICBhbmNob3IgPSB2bm9kZS50YXJnZXRBbmNob3I7DQogICAgICB9DQogICAgICB3aGlsZSAobm9kZSAmJiBub2RlICE9PSBhbmNob3IpIHsNCiAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIG5vZGUuc2V0QXR0cmlidXRlKCJkYXRhLXYtb3duZXIiLCBjdHgudWlkKTsNCiAgICAgICAgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7DQogICAgICB9DQogICAgICBjdHgudXQoKTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gcHJlcGFyZUFuY2hvcih0YXJnZXQsIHZub2RlLCBjcmVhdGVUZXh0LCBpbnNlcnQpIHsNCiAgICBjb25zdCB0YXJnZXRTdGFydCA9IHZub2RlLnRhcmdldFN0YXJ0ID0gY3JlYXRlVGV4dCgiIik7DQogICAgY29uc3QgdGFyZ2V0QW5jaG9yID0gdm5vZGUudGFyZ2V0QW5jaG9yID0gY3JlYXRlVGV4dCgiIik7DQogICAgdGFyZ2V0U3RhcnRbVGVsZXBvcnRFbmRLZXldID0gdGFyZ2V0QW5jaG9yOw0KICAgIGlmICh0YXJnZXQpIHsNCiAgICAgIGluc2VydCh0YXJnZXRTdGFydCwgdGFyZ2V0KTsNCiAgICAgIGluc2VydCh0YXJnZXRBbmNob3IsIHRhcmdldCk7DQogICAgfQ0KICAgIHJldHVybiB0YXJnZXRBbmNob3I7DQogIH0NCg0KICBjb25zdCBsZWF2ZUNiS2V5ID0gU3ltYm9sKCJfbGVhdmVDYiIpOw0KICBjb25zdCBlbnRlckNiS2V5JDEgPSBTeW1ib2woIl9lbnRlckNiIik7DQogIGZ1bmN0aW9uIHVzZVRyYW5zaXRpb25TdGF0ZSgpIHsNCiAgICBjb25zdCBzdGF0ZSA9IHsNCiAgICAgIGlzTW91bnRlZDogZmFsc2UsDQogICAgICBpc0xlYXZpbmc6IGZhbHNlLA0KICAgICAgaXNVbm1vdW50aW5nOiBmYWxzZSwNCiAgICAgIGxlYXZpbmdWTm9kZXM6IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkNCiAgICB9Ow0KICAgIG9uTW91bnRlZCgoKSA9PiB7DQogICAgICBzdGF0ZS5pc01vdW50ZWQgPSB0cnVlOw0KICAgIH0pOw0KICAgIG9uQmVmb3JlVW5tb3VudCgoKSA9PiB7DQogICAgICBzdGF0ZS5pc1VubW91bnRpbmcgPSB0cnVlOw0KICAgIH0pOw0KICAgIHJldHVybiBzdGF0ZTsNCiAgfQ0KICBjb25zdCBUcmFuc2l0aW9uSG9va1ZhbGlkYXRvciA9IFtGdW5jdGlvbiwgQXJyYXldOw0KICBjb25zdCBCYXNlVHJhbnNpdGlvblByb3BzVmFsaWRhdG9ycyA9IHsNCiAgICBtb2RlOiBTdHJpbmcsDQogICAgYXBwZWFyOiBCb29sZWFuLA0KICAgIHBlcnNpc3RlZDogQm9vbGVhbiwNCiAgICAvLyBlbnRlcg0KICAgIG9uQmVmb3JlRW50ZXI6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yLA0KICAgIG9uRW50ZXI6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yLA0KICAgIG9uQWZ0ZXJFbnRlcjogVHJhbnNpdGlvbkhvb2tWYWxpZGF0b3IsDQogICAgb25FbnRlckNhbmNlbGxlZDogVHJhbnNpdGlvbkhvb2tWYWxpZGF0b3IsDQogICAgLy8gbGVhdmUNCiAgICBvbkJlZm9yZUxlYXZlOiBUcmFuc2l0aW9uSG9va1ZhbGlkYXRvciwNCiAgICBvbkxlYXZlOiBUcmFuc2l0aW9uSG9va1ZhbGlkYXRvciwNCiAgICBvbkFmdGVyTGVhdmU6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yLA0KICAgIG9uTGVhdmVDYW5jZWxsZWQ6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yLA0KICAgIC8vIGFwcGVhcg0KICAgIG9uQmVmb3JlQXBwZWFyOiBUcmFuc2l0aW9uSG9va1ZhbGlkYXRvciwNCiAgICBvbkFwcGVhcjogVHJhbnNpdGlvbkhvb2tWYWxpZGF0b3IsDQogICAgb25BZnRlckFwcGVhcjogVHJhbnNpdGlvbkhvb2tWYWxpZGF0b3IsDQogICAgb25BcHBlYXJDYW5jZWxsZWQ6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yDQogIH07DQogIGNvbnN0IHJlY3Vyc2l2ZUdldFN1YnRyZWUgPSAoaW5zdGFuY2UpID0+IHsNCiAgICBjb25zdCBzdWJUcmVlID0gaW5zdGFuY2Uuc3ViVHJlZTsNCiAgICByZXR1cm4gc3ViVHJlZS5jb21wb25lbnQgPyByZWN1cnNpdmVHZXRTdWJ0cmVlKHN1YlRyZWUuY29tcG9uZW50KSA6IHN1YlRyZWU7DQogIH07DQogIGNvbnN0IEJhc2VUcmFuc2l0aW9uSW1wbCA9IHsNCiAgICBuYW1lOiBgQmFzZVRyYW5zaXRpb25gLA0KICAgIHByb3BzOiBCYXNlVHJhbnNpdGlvblByb3BzVmFsaWRhdG9ycywNCiAgICBzZXR1cChwcm9wcywgeyBzbG90cyB9KSB7DQogICAgICBjb25zdCBpbnN0YW5jZSA9IGdldEN1cnJlbnRJbnN0YW5jZSgpOw0KICAgICAgY29uc3Qgc3RhdGUgPSB1c2VUcmFuc2l0aW9uU3RhdGUoKTsNCiAgICAgIHJldHVybiAoKSA9PiB7DQogICAgICAgIGNvbnN0IGNoaWxkcmVuID0gc2xvdHMuZGVmYXVsdCAmJiBnZXRUcmFuc2l0aW9uUmF3Q2hpbGRyZW4oc2xvdHMuZGVmYXVsdCgpLCB0cnVlKTsNCiAgICAgICAgaWYgKCFjaGlsZHJlbiB8fCAhY2hpbGRyZW4ubGVuZ3RoKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIGNvbnN0IGNoaWxkID0gZmluZE5vbkNvbW1lbnRDaGlsZChjaGlsZHJlbik7DQogICAgICAgIGNvbnN0IHJhd1Byb3BzID0gdG9SYXcocHJvcHMpOw0KICAgICAgICBjb25zdCB7IG1vZGUgfSA9IHJhd1Byb3BzOw0KICAgICAgICBpZiAobW9kZSAmJiBtb2RlICE9PSAiaW4tb3V0IiAmJiBtb2RlICE9PSAib3V0LWluIiAmJiBtb2RlICE9PSAiZGVmYXVsdCIpIHsNCiAgICAgICAgICB3YXJuJDEoYGludmFsaWQgPHRyYW5zaXRpb24+IG1vZGU6ICR7bW9kZX1gKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoc3RhdGUuaXNMZWF2aW5nKSB7DQogICAgICAgICAgcmV0dXJuIGVtcHR5UGxhY2Vob2xkZXIoY2hpbGQpOw0KICAgICAgICB9DQogICAgICAgIGNvbnN0IGlubmVyQ2hpbGQgPSBnZXRJbm5lckNoaWxkJDEoY2hpbGQpOw0KICAgICAgICBpZiAoIWlubmVyQ2hpbGQpIHsNCiAgICAgICAgICByZXR1cm4gZW1wdHlQbGFjZWhvbGRlcihjaGlsZCk7DQogICAgICAgIH0NCiAgICAgICAgbGV0IGVudGVySG9va3MgPSByZXNvbHZlVHJhbnNpdGlvbkhvb2tzKA0KICAgICAgICAgIGlubmVyQ2hpbGQsDQogICAgICAgICAgcmF3UHJvcHMsDQogICAgICAgICAgc3RhdGUsDQogICAgICAgICAgaW5zdGFuY2UsDQogICAgICAgICAgLy8gIzExMDYxLCBlbnN1cmUgZW50ZXJIb29rcyBpcyBmcmVzaCBhZnRlciBjbG9uZQ0KICAgICAgICAgIChob29rcykgPT4gZW50ZXJIb29rcyA9IGhvb2tzDQogICAgICAgICk7DQogICAgICAgIGlmIChpbm5lckNoaWxkLnR5cGUgIT09IENvbW1lbnQpIHsNCiAgICAgICAgICBzZXRUcmFuc2l0aW9uSG9va3MoaW5uZXJDaGlsZCwgZW50ZXJIb29rcyk7DQogICAgICAgIH0NCiAgICAgICAgbGV0IG9sZElubmVyQ2hpbGQgPSBpbnN0YW5jZS5zdWJUcmVlICYmIGdldElubmVyQ2hpbGQkMShpbnN0YW5jZS5zdWJUcmVlKTsNCiAgICAgICAgaWYgKG9sZElubmVyQ2hpbGQgJiYgb2xkSW5uZXJDaGlsZC50eXBlICE9PSBDb21tZW50ICYmICFpc1NhbWVWTm9kZVR5cGUoaW5uZXJDaGlsZCwgb2xkSW5uZXJDaGlsZCkgJiYgcmVjdXJzaXZlR2V0U3VidHJlZShpbnN0YW5jZSkudHlwZSAhPT0gQ29tbWVudCkgew0KICAgICAgICAgIGxldCBsZWF2aW5nSG9va3MgPSByZXNvbHZlVHJhbnNpdGlvbkhvb2tzKA0KICAgICAgICAgICAgb2xkSW5uZXJDaGlsZCwNCiAgICAgICAgICAgIHJhd1Byb3BzLA0KICAgICAgICAgICAgc3RhdGUsDQogICAgICAgICAgICBpbnN0YW5jZQ0KICAgICAgICAgICk7DQogICAgICAgICAgc2V0VHJhbnNpdGlvbkhvb2tzKG9sZElubmVyQ2hpbGQsIGxlYXZpbmdIb29rcyk7DQogICAgICAgICAgaWYgKG1vZGUgPT09ICJvdXQtaW4iICYmIGlubmVyQ2hpbGQudHlwZSAhPT0gQ29tbWVudCkgew0KICAgICAgICAgICAgc3RhdGUuaXNMZWF2aW5nID0gdHJ1ZTsNCiAgICAgICAgICAgIGxlYXZpbmdIb29rcy5hZnRlckxlYXZlID0gKCkgPT4gew0KICAgICAgICAgICAgICBzdGF0ZS5pc0xlYXZpbmcgPSBmYWxzZTsNCiAgICAgICAgICAgICAgaWYgKCEoaW5zdGFuY2Uuam9iLmZsYWdzICYgOCkpIHsNCiAgICAgICAgICAgICAgICBpbnN0YW5jZS51cGRhdGUoKTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICBkZWxldGUgbGVhdmluZ0hvb2tzLmFmdGVyTGVhdmU7DQogICAgICAgICAgICAgIG9sZElubmVyQ2hpbGQgPSB2b2lkIDA7DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgcmV0dXJuIGVtcHR5UGxhY2Vob2xkZXIoY2hpbGQpOw0KICAgICAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gImluLW91dCIgJiYgaW5uZXJDaGlsZC50eXBlICE9PSBDb21tZW50KSB7DQogICAgICAgICAgICBsZWF2aW5nSG9va3MuZGVsYXlMZWF2ZSA9IChlbCwgZWFybHlSZW1vdmUsIGRlbGF5ZWRMZWF2ZSkgPT4gew0KICAgICAgICAgICAgICBjb25zdCBsZWF2aW5nVk5vZGVzQ2FjaGUgPSBnZXRMZWF2aW5nTm9kZXNGb3JUeXBlKA0KICAgICAgICAgICAgICAgIHN0YXRlLA0KICAgICAgICAgICAgICAgIG9sZElubmVyQ2hpbGQNCiAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgbGVhdmluZ1ZOb2Rlc0NhY2hlW1N0cmluZyhvbGRJbm5lckNoaWxkLmtleSldID0gb2xkSW5uZXJDaGlsZDsNCiAgICAgICAgICAgICAgZWxbbGVhdmVDYktleV0gPSAoKSA9PiB7DQogICAgICAgICAgICAgICAgZWFybHlSZW1vdmUoKTsNCiAgICAgICAgICAgICAgICBlbFtsZWF2ZUNiS2V5XSA9IHZvaWQgMDsNCiAgICAgICAgICAgICAgICBkZWxldGUgZW50ZXJIb29rcy5kZWxheWVkTGVhdmU7DQogICAgICAgICAgICAgICAgb2xkSW5uZXJDaGlsZCA9IHZvaWQgMDsNCiAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgZW50ZXJIb29rcy5kZWxheWVkTGVhdmUgPSAoKSA9PiB7DQogICAgICAgICAgICAgICAgZGVsYXllZExlYXZlKCk7DQogICAgICAgICAgICAgICAgZGVsZXRlIGVudGVySG9va3MuZGVsYXllZExlYXZlOw0KICAgICAgICAgICAgICAgIG9sZElubmVyQ2hpbGQgPSB2b2lkIDA7DQogICAgICAgICAgICAgIH07DQogICAgICAgICAgICB9Ow0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBvbGRJbm5lckNoaWxkID0gdm9pZCAwOw0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIGlmIChvbGRJbm5lckNoaWxkKSB7DQogICAgICAgICAgb2xkSW5uZXJDaGlsZCA9IHZvaWQgMDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gY2hpbGQ7DQogICAgICB9Ow0KICAgIH0NCiAgfTsNCiAgZnVuY3Rpb24gZmluZE5vbkNvbW1lbnRDaGlsZChjaGlsZHJlbikgew0KICAgIGxldCBjaGlsZCA9IGNoaWxkcmVuWzBdOw0KICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPiAxKSB7DQogICAgICBsZXQgaGFzRm91bmQgPSBmYWxzZTsNCiAgICAgIGZvciAoY29uc3QgYyBvZiBjaGlsZHJlbikgew0KICAgICAgICBpZiAoYy50eXBlICE9PSBDb21tZW50KSB7DQogICAgICAgICAgaWYgKGhhc0ZvdW5kKSB7DQogICAgICAgICAgICB3YXJuJDEoDQogICAgICAgICAgICAgICI8dHJhbnNpdGlvbj4gY2FuIG9ubHkgYmUgdXNlZCBvbiBhIHNpbmdsZSBlbGVtZW50IG9yIGNvbXBvbmVudC4gVXNlIDx0cmFuc2l0aW9uLWdyb3VwPiBmb3IgbGlzdHMuIg0KICAgICAgICAgICAgKTsNCiAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjaGlsZCA9IGM7DQogICAgICAgICAgaGFzRm91bmQgPSB0cnVlOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiBjaGlsZDsNCiAgfQ0KICBjb25zdCBCYXNlVHJhbnNpdGlvbiA9IEJhc2VUcmFuc2l0aW9uSW1wbDsNCiAgZnVuY3Rpb24gZ2V0TGVhdmluZ05vZGVzRm9yVHlwZShzdGF0ZSwgdm5vZGUpIHsNCiAgICBjb25zdCB7IGxlYXZpbmdWTm9kZXMgfSA9IHN0YXRlOw0KICAgIGxldCBsZWF2aW5nVk5vZGVzQ2FjaGUgPSBsZWF2aW5nVk5vZGVzLmdldCh2bm9kZS50eXBlKTsNCiAgICBpZiAoIWxlYXZpbmdWTm9kZXNDYWNoZSkgew0KICAgICAgbGVhdmluZ1ZOb2Rlc0NhY2hlID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7DQogICAgICBsZWF2aW5nVk5vZGVzLnNldCh2bm9kZS50eXBlLCBsZWF2aW5nVk5vZGVzQ2FjaGUpOw0KICAgIH0NCiAgICByZXR1cm4gbGVhdmluZ1ZOb2Rlc0NhY2hlOw0KICB9DQogIGZ1bmN0aW9uIHJlc29sdmVUcmFuc2l0aW9uSG9va3Modm5vZGUsIHByb3BzLCBzdGF0ZSwgaW5zdGFuY2UsIHBvc3RDbG9uZSkgew0KICAgIGNvbnN0IHsNCiAgICAgIGFwcGVhciwNCiAgICAgIG1vZGUsDQogICAgICBwZXJzaXN0ZWQgPSBmYWxzZSwNCiAgICAgIG9uQmVmb3JlRW50ZXIsDQogICAgICBvbkVudGVyLA0KICAgICAgb25BZnRlckVudGVyLA0KICAgICAgb25FbnRlckNhbmNlbGxlZCwNCiAgICAgIG9uQmVmb3JlTGVhdmUsDQogICAgICBvbkxlYXZlLA0KICAgICAgb25BZnRlckxlYXZlLA0KICAgICAgb25MZWF2ZUNhbmNlbGxlZCwNCiAgICAgIG9uQmVmb3JlQXBwZWFyLA0KICAgICAgb25BcHBlYXIsDQogICAgICBvbkFmdGVyQXBwZWFyLA0KICAgICAgb25BcHBlYXJDYW5jZWxsZWQNCiAgICB9ID0gcHJvcHM7DQogICAgY29uc3Qga2V5ID0gU3RyaW5nKHZub2RlLmtleSk7DQogICAgY29uc3QgbGVhdmluZ1ZOb2Rlc0NhY2hlID0gZ2V0TGVhdmluZ05vZGVzRm9yVHlwZShzdGF0ZSwgdm5vZGUpOw0KICAgIGNvbnN0IGNhbGxIb29rID0gKGhvb2ssIGFyZ3MpID0+IHsNCiAgICAgIGhvb2sgJiYgY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoDQogICAgICAgIGhvb2ssDQogICAgICAgIGluc3RhbmNlLA0KICAgICAgICA5LA0KICAgICAgICBhcmdzDQogICAgICApOw0KICAgIH07DQogICAgY29uc3QgY2FsbEFzeW5jSG9vayA9IChob29rLCBhcmdzKSA9PiB7DQogICAgICBjb25zdCBkb25lID0gYXJnc1sxXTsNCiAgICAgIGNhbGxIb29rKGhvb2ssIGFyZ3MpOw0KICAgICAgaWYgKGlzQXJyYXkoaG9vaykpIHsNCiAgICAgICAgaWYgKGhvb2suZXZlcnkoKGhvb2syKSA9PiBob29rMi5sZW5ndGggPD0gMSkpIGRvbmUoKTsNCiAgICAgIH0gZWxzZSBpZiAoaG9vay5sZW5ndGggPD0gMSkgew0KICAgICAgICBkb25lKCk7DQogICAgICB9DQogICAgfTsNCiAgICBjb25zdCBob29rcyA9IHsNCiAgICAgIG1vZGUsDQogICAgICBwZXJzaXN0ZWQsDQogICAgICBiZWZvcmVFbnRlcihlbCkgew0KICAgICAgICBsZXQgaG9vayA9IG9uQmVmb3JlRW50ZXI7DQogICAgICAgIGlmICghc3RhdGUuaXNNb3VudGVkKSB7DQogICAgICAgICAgaWYgKGFwcGVhcikgew0KICAgICAgICAgICAgaG9vayA9IG9uQmVmb3JlQXBwZWFyIHx8IG9uQmVmb3JlRW50ZXI7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgaWYgKGVsW2xlYXZlQ2JLZXldKSB7DQogICAgICAgICAgZWxbbGVhdmVDYktleV0oDQogICAgICAgICAgICB0cnVlDQogICAgICAgICAgICAvKiBjYW5jZWxsZWQgKi8NCiAgICAgICAgICApOw0KICAgICAgICB9DQogICAgICAgIGNvbnN0IGxlYXZpbmdWTm9kZSA9IGxlYXZpbmdWTm9kZXNDYWNoZVtrZXldOw0KICAgICAgICBpZiAobGVhdmluZ1ZOb2RlICYmIGlzU2FtZVZOb2RlVHlwZSh2bm9kZSwgbGVhdmluZ1ZOb2RlKSAmJiBsZWF2aW5nVk5vZGUuZWxbbGVhdmVDYktleV0pIHsNCiAgICAgICAgICBsZWF2aW5nVk5vZGUuZWxbbGVhdmVDYktleV0oKTsNCiAgICAgICAgfQ0KICAgICAgICBjYWxsSG9vayhob29rLCBbZWxdKTsNCiAgICAgIH0sDQogICAgICBlbnRlcihlbCkgew0KICAgICAgICBsZXQgaG9vayA9IG9uRW50ZXI7DQogICAgICAgIGxldCBhZnRlckhvb2sgPSBvbkFmdGVyRW50ZXI7DQogICAgICAgIGxldCBjYW5jZWxIb29rID0gb25FbnRlckNhbmNlbGxlZDsNCiAgICAgICAgaWYgKCFzdGF0ZS5pc01vdW50ZWQpIHsNCiAgICAgICAgICBpZiAoYXBwZWFyKSB7DQogICAgICAgICAgICBob29rID0gb25BcHBlYXIgfHwgb25FbnRlcjsNCiAgICAgICAgICAgIGFmdGVySG9vayA9IG9uQWZ0ZXJBcHBlYXIgfHwgb25BZnRlckVudGVyOw0KICAgICAgICAgICAgY2FuY2VsSG9vayA9IG9uQXBwZWFyQ2FuY2VsbGVkIHx8IG9uRW50ZXJDYW5jZWxsZWQ7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgbGV0IGNhbGxlZCA9IGZhbHNlOw0KICAgICAgICBjb25zdCBkb25lID0gZWxbZW50ZXJDYktleSQxXSA9IChjYW5jZWxsZWQpID0+IHsNCiAgICAgICAgICBpZiAoY2FsbGVkKSByZXR1cm47DQogICAgICAgICAgY2FsbGVkID0gdHJ1ZTsNCiAgICAgICAgICBpZiAoY2FuY2VsbGVkKSB7DQogICAgICAgICAgICBjYWxsSG9vayhjYW5jZWxIb29rLCBbZWxdKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgY2FsbEhvb2soYWZ0ZXJIb29rLCBbZWxdKTsNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKGhvb2tzLmRlbGF5ZWRMZWF2ZSkgew0KICAgICAgICAgICAgaG9va3MuZGVsYXllZExlYXZlKCk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGVsW2VudGVyQ2JLZXkkMV0gPSB2b2lkIDA7DQogICAgICAgIH07DQogICAgICAgIGlmIChob29rKSB7DQogICAgICAgICAgY2FsbEFzeW5jSG9vayhob29rLCBbZWwsIGRvbmVdKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBkb25lKCk7DQogICAgICAgIH0NCiAgICAgIH0sDQogICAgICBsZWF2ZShlbCwgcmVtb3ZlKSB7DQogICAgICAgIGNvbnN0IGtleTIgPSBTdHJpbmcodm5vZGUua2V5KTsNCiAgICAgICAgaWYgKGVsW2VudGVyQ2JLZXkkMV0pIHsNCiAgICAgICAgICBlbFtlbnRlckNiS2V5JDFdKA0KICAgICAgICAgICAgdHJ1ZQ0KICAgICAgICAgICAgLyogY2FuY2VsbGVkICovDQogICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoc3RhdGUuaXNVbm1vdW50aW5nKSB7DQogICAgICAgICAgcmV0dXJuIHJlbW92ZSgpOw0KICAgICAgICB9DQogICAgICAgIGNhbGxIb29rKG9uQmVmb3JlTGVhdmUsIFtlbF0pOw0KICAgICAgICBsZXQgY2FsbGVkID0gZmFsc2U7DQogICAgICAgIGNvbnN0IGRvbmUgPSBlbFtsZWF2ZUNiS2V5XSA9IChjYW5jZWxsZWQpID0+IHsNCiAgICAgICAgICBpZiAoY2FsbGVkKSByZXR1cm47DQogICAgICAgICAgY2FsbGVkID0gdHJ1ZTsNCiAgICAgICAgICByZW1vdmUoKTsNCiAgICAgICAgICBpZiAoY2FuY2VsbGVkKSB7DQogICAgICAgICAgICBjYWxsSG9vayhvbkxlYXZlQ2FuY2VsbGVkLCBbZWxdKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgY2FsbEhvb2sob25BZnRlckxlYXZlLCBbZWxdKTsNCiAgICAgICAgICB9DQogICAgICAgICAgZWxbbGVhdmVDYktleV0gPSB2b2lkIDA7DQogICAgICAgICAgaWYgKGxlYXZpbmdWTm9kZXNDYWNoZVtrZXkyXSA9PT0gdm5vZGUpIHsNCiAgICAgICAgICAgIGRlbGV0ZSBsZWF2aW5nVk5vZGVzQ2FjaGVba2V5Ml07DQogICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICBsZWF2aW5nVk5vZGVzQ2FjaGVba2V5Ml0gPSB2bm9kZTsNCiAgICAgICAgaWYgKG9uTGVhdmUpIHsNCiAgICAgICAgICBjYWxsQXN5bmNIb29rKG9uTGVhdmUsIFtlbCwgZG9uZV0pOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGRvbmUoKTsNCiAgICAgICAgfQ0KICAgICAgfSwNCiAgICAgIGNsb25lKHZub2RlMikgew0KICAgICAgICBjb25zdCBob29rczIgPSByZXNvbHZlVHJhbnNpdGlvbkhvb2tzKA0KICAgICAgICAgIHZub2RlMiwNCiAgICAgICAgICBwcm9wcywNCiAgICAgICAgICBzdGF0ZSwNCiAgICAgICAgICBpbnN0YW5jZSwNCiAgICAgICAgICBwb3N0Q2xvbmUNCiAgICAgICAgKTsNCiAgICAgICAgaWYgKHBvc3RDbG9uZSkgcG9zdENsb25lKGhvb2tzMik7DQogICAgICAgIHJldHVybiBob29rczI7DQogICAgICB9DQogICAgfTsNCiAgICByZXR1cm4gaG9va3M7DQogIH0NCiAgZnVuY3Rpb24gZW1wdHlQbGFjZWhvbGRlcih2bm9kZSkgew0KICAgIGlmIChpc0tlZXBBbGl2ZSh2bm9kZSkpIHsNCiAgICAgIHZub2RlID0gY2xvbmVWTm9kZSh2bm9kZSk7DQogICAgICB2bm9kZS5jaGlsZHJlbiA9IG51bGw7DQogICAgICByZXR1cm4gdm5vZGU7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGdldElubmVyQ2hpbGQkMSh2bm9kZSkgew0KICAgIGlmICghaXNLZWVwQWxpdmUodm5vZGUpKSB7DQogICAgICBpZiAoaXNUZWxlcG9ydCh2bm9kZS50eXBlKSAmJiB2bm9kZS5jaGlsZHJlbikgew0KICAgICAgICByZXR1cm4gZmluZE5vbkNvbW1lbnRDaGlsZCh2bm9kZS5jaGlsZHJlbik7DQogICAgICB9DQogICAgICByZXR1cm4gdm5vZGU7DQogICAgfQ0KICAgIGlmICh2bm9kZS5jb21wb25lbnQpIHsNCiAgICAgIHJldHVybiB2bm9kZS5jb21wb25lbnQuc3ViVHJlZTsNCiAgICB9DQogICAgY29uc3QgeyBzaGFwZUZsYWcsIGNoaWxkcmVuIH0gPSB2bm9kZTsNCiAgICBpZiAoY2hpbGRyZW4pIHsNCiAgICAgIGlmIChzaGFwZUZsYWcgJiAxNikgew0KICAgICAgICByZXR1cm4gY2hpbGRyZW5bMF07DQogICAgICB9DQogICAgICBpZiAoc2hhcGVGbGFnICYgMzIgJiYgaXNGdW5jdGlvbihjaGlsZHJlbi5kZWZhdWx0KSkgew0KICAgICAgICByZXR1cm4gY2hpbGRyZW4uZGVmYXVsdCgpOw0KICAgICAgfQ0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBzZXRUcmFuc2l0aW9uSG9va3Modm5vZGUsIGhvb2tzKSB7DQogICAgaWYgKHZub2RlLnNoYXBlRmxhZyAmIDYgJiYgdm5vZGUuY29tcG9uZW50KSB7DQogICAgICB2bm9kZS50cmFuc2l0aW9uID0gaG9va3M7DQogICAgICBzZXRUcmFuc2l0aW9uSG9va3Modm5vZGUuY29tcG9uZW50LnN1YlRyZWUsIGhvb2tzKTsNCiAgICB9IGVsc2UgaWYgKHZub2RlLnNoYXBlRmxhZyAmIDEyOCkgew0KICAgICAgdm5vZGUuc3NDb250ZW50LnRyYW5zaXRpb24gPSBob29rcy5jbG9uZSh2bm9kZS5zc0NvbnRlbnQpOw0KICAgICAgdm5vZGUuc3NGYWxsYmFjay50cmFuc2l0aW9uID0gaG9va3MuY2xvbmUodm5vZGUuc3NGYWxsYmFjayk7DQogICAgfSBlbHNlIHsNCiAgICAgIHZub2RlLnRyYW5zaXRpb24gPSBob29rczsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gZ2V0VHJhbnNpdGlvblJhd0NoaWxkcmVuKGNoaWxkcmVuLCBrZWVwQ29tbWVudCA9IGZhbHNlLCBwYXJlbnRLZXkpIHsNCiAgICBsZXQgcmV0ID0gW107DQogICAgbGV0IGtleWVkRnJhZ21lbnRDb3VudCA9IDA7DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgew0KICAgICAgbGV0IGNoaWxkID0gY2hpbGRyZW5baV07DQogICAgICBjb25zdCBrZXkgPSBwYXJlbnRLZXkgPT0gbnVsbCA/IGNoaWxkLmtleSA6IFN0cmluZyhwYXJlbnRLZXkpICsgU3RyaW5nKGNoaWxkLmtleSAhPSBudWxsID8gY2hpbGQua2V5IDogaSk7DQogICAgICBpZiAoY2hpbGQudHlwZSA9PT0gRnJhZ21lbnQpIHsNCiAgICAgICAgaWYgKGNoaWxkLnBhdGNoRmxhZyAmIDEyOCkga2V5ZWRGcmFnbWVudENvdW50Kys7DQogICAgICAgIHJldCA9IHJldC5jb25jYXQoDQogICAgICAgICAgZ2V0VHJhbnNpdGlvblJhd0NoaWxkcmVuKGNoaWxkLmNoaWxkcmVuLCBrZWVwQ29tbWVudCwga2V5KQ0KICAgICAgICApOw0KICAgICAgfSBlbHNlIGlmIChrZWVwQ29tbWVudCB8fCBjaGlsZC50eXBlICE9PSBDb21tZW50KSB7DQogICAgICAgIHJldC5wdXNoKGtleSAhPSBudWxsID8gY2xvbmVWTm9kZShjaGlsZCwgeyBrZXkgfSkgOiBjaGlsZCk7DQogICAgICB9DQogICAgfQ0KICAgIGlmIChrZXllZEZyYWdtZW50Q291bnQgPiAxKSB7DQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJldC5sZW5ndGg7IGkrKykgew0KICAgICAgICByZXRbaV0ucGF0Y2hGbGFnID0gLTI7DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiByZXQ7DQogIH0NCg0KICAvKiEgI19fTk9fU0lERV9FRkZFQ1RTX18gKi8NCiAgLy8gQF9fTk9fU0lERV9FRkZFQ1RTX18NCiAgZnVuY3Rpb24gZGVmaW5lQ29tcG9uZW50KG9wdGlvbnMsIGV4dHJhT3B0aW9ucykgew0KICAgIHJldHVybiBpc0Z1bmN0aW9uKG9wdGlvbnMpID8gKA0KICAgICAgLy8gIzgyMzY6IGV4dGVuZCBjYWxsIGFuZCBvcHRpb25zLm5hbWUgYWNjZXNzIGFyZSBjb25zaWRlcmVkIHNpZGUtZWZmZWN0cw0KICAgICAgLy8gYnkgUm9sbHVwLCBzbyB3ZSBoYXZlIHRvIHdyYXAgaXQgaW4gYSBwdXJlLWFubm90YXRlZCBJSUZFLg0KICAgICAgLyogQF9fUFVSRV9fICovICgoKSA9PiBleHRlbmQoeyBuYW1lOiBvcHRpb25zLm5hbWUgfSwgZXh0cmFPcHRpb25zLCB7IHNldHVwOiBvcHRpb25zIH0pKSgpDQogICAgKSA6IG9wdGlvbnM7DQogIH0NCg0KICBmdW5jdGlvbiB1c2VJZCgpIHsNCiAgICBjb25zdCBpID0gZ2V0Q3VycmVudEluc3RhbmNlKCk7DQogICAgaWYgKGkpIHsNCiAgICAgIHJldHVybiAoaS5hcHBDb250ZXh0LmNvbmZpZy5pZFByZWZpeCB8fCAidiIpICsgIi0iICsgaS5pZHNbMF0gKyBpLmlkc1sxXSsrOw0KICAgIH0gZWxzZSB7DQogICAgICB3YXJuJDEoDQogICAgICAgIGB1c2VJZCgpIGlzIGNhbGxlZCB3aGVuIHRoZXJlIGlzIG5vIGFjdGl2ZSBjb21wb25lbnQgaW5zdGFuY2UgdG8gYmUgYXNzb2NpYXRlZCB3aXRoLmANCiAgICAgICk7DQogICAgfQ0KICAgIHJldHVybiAiIjsNCiAgfQ0KICBmdW5jdGlvbiBtYXJrQXN5bmNCb3VuZGFyeShpbnN0YW5jZSkgew0KICAgIGluc3RhbmNlLmlkcyA9IFtpbnN0YW5jZS5pZHNbMF0gKyBpbnN0YW5jZS5pZHNbMl0rKyArICItIiwgMCwgMF07DQogIH0NCg0KICBjb25zdCBrbm93blRlbXBsYXRlUmVmcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha1NldCgpOw0KICBmdW5jdGlvbiB1c2VUZW1wbGF0ZVJlZihrZXkpIHsNCiAgICBjb25zdCBpID0gZ2V0Q3VycmVudEluc3RhbmNlKCk7DQogICAgY29uc3QgciA9IHNoYWxsb3dSZWYobnVsbCk7DQogICAgaWYgKGkpIHsNCiAgICAgIGNvbnN0IHJlZnMgPSBpLnJlZnMgPT09IEVNUFRZX09CSiA/IGkucmVmcyA9IHt9IDogaS5yZWZzOw0KICAgICAgbGV0IGRlc2M7DQogICAgICBpZiAoKGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHJlZnMsIGtleSkpICYmICFkZXNjLmNvbmZpZ3VyYWJsZSkgew0KICAgICAgICB3YXJuJDEoYHVzZVRlbXBsYXRlUmVmKCcke2tleX0nKSBhbHJlYWR5IGV4aXN0cy5gKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShyZWZzLCBrZXksIHsNCiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLA0KICAgICAgICAgIGdldDogKCkgPT4gci52YWx1ZSwNCiAgICAgICAgICBzZXQ6ICh2YWwpID0+IHIudmFsdWUgPSB2YWwNCiAgICAgICAgfSk7DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIHdhcm4kMSgNCiAgICAgICAgYHVzZVRlbXBsYXRlUmVmKCkgaXMgY2FsbGVkIHdoZW4gdGhlcmUgaXMgbm8gYWN0aXZlIGNvbXBvbmVudCBpbnN0YW5jZSB0byBiZSBhc3NvY2lhdGVkIHdpdGguYA0KICAgICAgKTsNCiAgICB9DQogICAgY29uc3QgcmV0ID0gcmVhZG9ubHkocikgOw0KICAgIHsNCiAgICAgIGtub3duVGVtcGxhdGVSZWZzLmFkZChyZXQpOw0KICAgIH0NCiAgICByZXR1cm4gcmV0Ow0KICB9DQoNCiAgZnVuY3Rpb24gc2V0UmVmKHJhd1JlZiwgb2xkUmF3UmVmLCBwYXJlbnRTdXNwZW5zZSwgdm5vZGUsIGlzVW5tb3VudCA9IGZhbHNlKSB7DQogICAgaWYgKGlzQXJyYXkocmF3UmVmKSkgew0KICAgICAgcmF3UmVmLmZvckVhY2goDQogICAgICAgIChyLCBpKSA9PiBzZXRSZWYoDQogICAgICAgICAgciwNCiAgICAgICAgICBvbGRSYXdSZWYgJiYgKGlzQXJyYXkob2xkUmF3UmVmKSA/IG9sZFJhd1JlZltpXSA6IG9sZFJhd1JlZiksDQogICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgdm5vZGUsDQogICAgICAgICAgaXNVbm1vdW50DQogICAgICAgICkNCiAgICAgICk7DQogICAgICByZXR1cm47DQogICAgfQ0KICAgIGlmIChpc0FzeW5jV3JhcHBlcih2bm9kZSkgJiYgIWlzVW5tb3VudCkgew0KICAgICAgaWYgKHZub2RlLnNoYXBlRmxhZyAmIDUxMiAmJiB2bm9kZS50eXBlLl9fYXN5bmNSZXNvbHZlZCAmJiB2bm9kZS5jb21wb25lbnQuc3ViVHJlZS5jb21wb25lbnQpIHsNCiAgICAgICAgc2V0UmVmKHJhd1JlZiwgb2xkUmF3UmVmLCBwYXJlbnRTdXNwZW5zZSwgdm5vZGUuY29tcG9uZW50LnN1YlRyZWUpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBjb25zdCByZWZWYWx1ZSA9IHZub2RlLnNoYXBlRmxhZyAmIDQgPyBnZXRDb21wb25lbnRQdWJsaWNJbnN0YW5jZSh2bm9kZS5jb21wb25lbnQpIDogdm5vZGUuZWw7DQogICAgY29uc3QgdmFsdWUgPSBpc1VubW91bnQgPyBudWxsIDogcmVmVmFsdWU7DQogICAgY29uc3QgeyBpOiBvd25lciwgcjogcmVmIH0gPSByYXdSZWY7DQogICAgaWYgKCFvd25lcikgew0KICAgICAgd2FybiQxKA0KICAgICAgICBgTWlzc2luZyByZWYgb3duZXIgY29udGV4dC4gcmVmIGNhbm5vdCBiZSB1c2VkIG9uIGhvaXN0ZWQgdm5vZGVzLiBBIHZub2RlIHdpdGggcmVmIG11c3QgYmUgY3JlYXRlZCBpbnNpZGUgdGhlIHJlbmRlciBmdW5jdGlvbi5gDQogICAgICApOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBjb25zdCBvbGRSZWYgPSBvbGRSYXdSZWYgJiYgb2xkUmF3UmVmLnI7DQogICAgY29uc3QgcmVmcyA9IG93bmVyLnJlZnMgPT09IEVNUFRZX09CSiA/IG93bmVyLnJlZnMgPSB7fSA6IG93bmVyLnJlZnM7DQogICAgY29uc3Qgc2V0dXBTdGF0ZSA9IG93bmVyLnNldHVwU3RhdGU7DQogICAgY29uc3QgcmF3U2V0dXBTdGF0ZSA9IHRvUmF3KHNldHVwU3RhdGUpOw0KICAgIGNvbnN0IGNhblNldFNldHVwUmVmID0gc2V0dXBTdGF0ZSA9PT0gRU1QVFlfT0JKID8gKCkgPT4gZmFsc2UgOiAoa2V5KSA9PiB7DQogICAgICB7DQogICAgICAgIGlmIChoYXNPd24ocmF3U2V0dXBTdGF0ZSwga2V5KSAmJiAhaXNSZWYocmF3U2V0dXBTdGF0ZVtrZXldKSkgew0KICAgICAgICAgIHdhcm4kMSgNCiAgICAgICAgICAgIGBUZW1wbGF0ZSByZWYgIiR7a2V5fSIgdXNlZCBvbiBhIG5vbi1yZWYgdmFsdWUuIEl0IHdpbGwgbm90IHdvcmsgaW4gdGhlIHByb2R1Y3Rpb24gYnVpbGQuYA0KICAgICAgICAgICk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKGtub3duVGVtcGxhdGVSZWZzLmhhcyhyYXdTZXR1cFN0YXRlW2tleV0pKSB7DQogICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICB9DQogICAgICB9DQogICAgICByZXR1cm4gaGFzT3duKHJhd1NldHVwU3RhdGUsIGtleSk7DQogICAgfTsNCiAgICBpZiAob2xkUmVmICE9IG51bGwgJiYgb2xkUmVmICE9PSByZWYpIHsNCiAgICAgIGlmIChpc1N0cmluZyhvbGRSZWYpKSB7DQogICAgICAgIHJlZnNbb2xkUmVmXSA9IG51bGw7DQogICAgICAgIGlmIChjYW5TZXRTZXR1cFJlZihvbGRSZWYpKSB7DQogICAgICAgICAgc2V0dXBTdGF0ZVtvbGRSZWZdID0gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIGlmIChpc1JlZihvbGRSZWYpKSB7DQogICAgICAgIG9sZFJlZi52YWx1ZSA9IG51bGw7DQogICAgICB9DQogICAgfQ0KICAgIGlmIChpc0Z1bmN0aW9uKHJlZikpIHsNCiAgICAgIGNhbGxXaXRoRXJyb3JIYW5kbGluZyhyZWYsIG93bmVyLCAxMiwgW3ZhbHVlLCByZWZzXSk7DQogICAgfSBlbHNlIHsNCiAgICAgIGNvbnN0IF9pc1N0cmluZyA9IGlzU3RyaW5nKHJlZik7DQogICAgICBjb25zdCBfaXNSZWYgPSBpc1JlZihyZWYpOw0KICAgICAgaWYgKF9pc1N0cmluZyB8fCBfaXNSZWYpIHsNCiAgICAgICAgY29uc3QgZG9TZXQgPSAoKSA9PiB7DQogICAgICAgICAgaWYgKHJhd1JlZi5mKSB7DQogICAgICAgICAgICBjb25zdCBleGlzdGluZyA9IF9pc1N0cmluZyA/IGNhblNldFNldHVwUmVmKHJlZikgPyBzZXR1cFN0YXRlW3JlZl0gOiByZWZzW3JlZl0gOiByZWYudmFsdWU7DQogICAgICAgICAgICBpZiAoaXNVbm1vdW50KSB7DQogICAgICAgICAgICAgIGlzQXJyYXkoZXhpc3RpbmcpICYmIHJlbW92ZShleGlzdGluZywgcmVmVmFsdWUpOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGV4aXN0aW5nKSkgew0KICAgICAgICAgICAgICAgIGlmIChfaXNTdHJpbmcpIHsNCiAgICAgICAgICAgICAgICAgIHJlZnNbcmVmXSA9IFtyZWZWYWx1ZV07DQogICAgICAgICAgICAgICAgICBpZiAoY2FuU2V0U2V0dXBSZWYocmVmKSkgew0KICAgICAgICAgICAgICAgICAgICBzZXR1cFN0YXRlW3JlZl0gPSByZWZzW3JlZl07DQogICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgIHJlZi52YWx1ZSA9IFtyZWZWYWx1ZV07DQogICAgICAgICAgICAgICAgICBpZiAocmF3UmVmLmspIHJlZnNbcmF3UmVmLmtdID0gcmVmLnZhbHVlOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgfSBlbHNlIGlmICghZXhpc3RpbmcuaW5jbHVkZXMocmVmVmFsdWUpKSB7DQogICAgICAgICAgICAgICAgZXhpc3RpbmcucHVzaChyZWZWYWx1ZSk7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9IGVsc2UgaWYgKF9pc1N0cmluZykgew0KICAgICAgICAgICAgcmVmc1tyZWZdID0gdmFsdWU7DQogICAgICAgICAgICBpZiAoY2FuU2V0U2V0dXBSZWYocmVmKSkgew0KICAgICAgICAgICAgICBzZXR1cFN0YXRlW3JlZl0gPSB2YWx1ZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9IGVsc2UgaWYgKF9pc1JlZikgew0KICAgICAgICAgICAgcmVmLnZhbHVlID0gdmFsdWU7DQogICAgICAgICAgICBpZiAocmF3UmVmLmspIHJlZnNbcmF3UmVmLmtdID0gdmFsdWU7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHdhcm4kMSgiSW52YWxpZCB0ZW1wbGF0ZSByZWYgdHlwZToiLCByZWYsIGAoJHt0eXBlb2YgcmVmfSlgKTsNCiAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIGlmICh2YWx1ZSkgew0KICAgICAgICAgIGRvU2V0LmlkID0gLTE7DQogICAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KGRvU2V0LCBwYXJlbnRTdXNwZW5zZSk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgZG9TZXQoKTsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgd2FybiQxKCJJbnZhbGlkIHRlbXBsYXRlIHJlZiB0eXBlOiIsIHJlZiwgYCgke3R5cGVvZiByZWZ9KWApOw0KICAgICAgfQ0KICAgIH0NCiAgfQ0KDQogIGxldCBoYXNMb2dnZWRNaXNtYXRjaEVycm9yID0gZmFsc2U7DQogIGNvbnN0IGxvZ01pc21hdGNoRXJyb3IgPSAoKSA9PiB7DQogICAgaWYgKGhhc0xvZ2dlZE1pc21hdGNoRXJyb3IpIHsNCiAgICAgIHJldHVybjsNCiAgICB9DQogICAgY29uc29sZS5lcnJvcigiSHlkcmF0aW9uIGNvbXBsZXRlZCBidXQgY29udGFpbnMgbWlzbWF0Y2hlcy4iKTsNCiAgICBoYXNMb2dnZWRNaXNtYXRjaEVycm9yID0gdHJ1ZTsNCiAgfTsNCiAgY29uc3QgaXNTVkdDb250YWluZXIgPSAoY29udGFpbmVyKSA9PiBjb250YWluZXIubmFtZXNwYWNlVVJJLmluY2x1ZGVzKCJzdmciKSAmJiBjb250YWluZXIudGFnTmFtZSAhPT0gImZvcmVpZ25PYmplY3QiOw0KICBjb25zdCBpc01hdGhNTENvbnRhaW5lciA9IChjb250YWluZXIpID0+IGNvbnRhaW5lci5uYW1lc3BhY2VVUkkuaW5jbHVkZXMoIk1hdGhNTCIpOw0KICBjb25zdCBnZXRDb250YWluZXJUeXBlID0gKGNvbnRhaW5lcikgPT4gew0KICAgIGlmIChjb250YWluZXIubm9kZVR5cGUgIT09IDEpIHJldHVybiB2b2lkIDA7DQogICAgaWYgKGlzU1ZHQ29udGFpbmVyKGNvbnRhaW5lcikpIHJldHVybiAic3ZnIjsNCiAgICBpZiAoaXNNYXRoTUxDb250YWluZXIoY29udGFpbmVyKSkgcmV0dXJuICJtYXRobWwiOw0KICAgIHJldHVybiB2b2lkIDA7DQogIH07DQogIGNvbnN0IGlzQ29tbWVudCA9IChub2RlKSA9PiBub2RlLm5vZGVUeXBlID09PSA4Ow0KICBmdW5jdGlvbiBjcmVhdGVIeWRyYXRpb25GdW5jdGlvbnMocmVuZGVyZXJJbnRlcm5hbHMpIHsNCiAgICBjb25zdCB7DQogICAgICBtdDogbW91bnRDb21wb25lbnQsDQogICAgICBwOiBwYXRjaCwNCiAgICAgIG86IHsNCiAgICAgICAgcGF0Y2hQcm9wLA0KICAgICAgICBjcmVhdGVUZXh0LA0KICAgICAgICBuZXh0U2libGluZywNCiAgICAgICAgcGFyZW50Tm9kZSwNCiAgICAgICAgcmVtb3ZlLA0KICAgICAgICBpbnNlcnQsDQogICAgICAgIGNyZWF0ZUNvbW1lbnQNCiAgICAgIH0NCiAgICB9ID0gcmVuZGVyZXJJbnRlcm5hbHM7DQogICAgY29uc3QgaHlkcmF0ZSA9ICh2bm9kZSwgY29udGFpbmVyKSA9PiB7DQogICAgICBpZiAoIWNvbnRhaW5lci5oYXNDaGlsZE5vZGVzKCkpIHsNCiAgICAgICAgd2FybiQxKA0KICAgICAgICAgIGBBdHRlbXB0aW5nIHRvIGh5ZHJhdGUgZXhpc3RpbmcgbWFya3VwIGJ1dCBjb250YWluZXIgaXMgZW1wdHkuIFBlcmZvcm1pbmcgZnVsbCBtb3VudCBpbnN0ZWFkLmANCiAgICAgICAgKTsNCiAgICAgICAgcGF0Y2gobnVsbCwgdm5vZGUsIGNvbnRhaW5lcik7DQogICAgICAgIGZsdXNoUG9zdEZsdXNoQ2JzKCk7DQogICAgICAgIGNvbnRhaW5lci5fdm5vZGUgPSB2bm9kZTsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgaHlkcmF0ZU5vZGUoY29udGFpbmVyLmZpcnN0Q2hpbGQsIHZub2RlLCBudWxsLCBudWxsLCBudWxsKTsNCiAgICAgIGZsdXNoUG9zdEZsdXNoQ2JzKCk7DQogICAgICBjb250YWluZXIuX3Zub2RlID0gdm5vZGU7DQogICAgfTsNCiAgICBjb25zdCBoeWRyYXRlTm9kZSA9IChub2RlLCB2bm9kZSwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQgPSBmYWxzZSkgPT4gew0KICAgICAgb3B0aW1pemVkID0gb3B0aW1pemVkIHx8ICEhdm5vZGUuZHluYW1pY0NoaWxkcmVuOw0KICAgICAgY29uc3QgaXNGcmFnbWVudFN0YXJ0ID0gaXNDb21tZW50KG5vZGUpICYmIG5vZGUuZGF0YSA9PT0gIlsiOw0KICAgICAgY29uc3Qgb25NaXNtYXRjaCA9ICgpID0+IGhhbmRsZU1pc21hdGNoKA0KICAgICAgICBub2RlLA0KICAgICAgICB2bm9kZSwNCiAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICBpc0ZyYWdtZW50U3RhcnQNCiAgICAgICk7DQogICAgICBjb25zdCB7IHR5cGUsIHJlZiwgc2hhcGVGbGFnLCBwYXRjaEZsYWcgfSA9IHZub2RlOw0KICAgICAgbGV0IGRvbVR5cGUgPSBub2RlLm5vZGVUeXBlOw0KICAgICAgdm5vZGUuZWwgPSBub2RlOw0KICAgICAgew0KICAgICAgICBkZWYobm9kZSwgIl9fdm5vZGUiLCB2bm9kZSwgdHJ1ZSk7DQogICAgICAgIGRlZihub2RlLCAiX192dWVQYXJlbnRDb21wb25lbnQiLCBwYXJlbnRDb21wb25lbnQsIHRydWUpOw0KICAgICAgfQ0KICAgICAgaWYgKHBhdGNoRmxhZyA9PT0gLTIpIHsNCiAgICAgICAgb3B0aW1pemVkID0gZmFsc2U7DQogICAgICAgIHZub2RlLmR5bmFtaWNDaGlsZHJlbiA9IG51bGw7DQogICAgICB9DQogICAgICBsZXQgbmV4dE5vZGUgPSBudWxsOw0KICAgICAgc3dpdGNoICh0eXBlKSB7DQogICAgICAgIGNhc2UgVGV4dDoNCiAgICAgICAgICBpZiAoZG9tVHlwZSAhPT0gMykgew0KICAgICAgICAgICAgaWYgKHZub2RlLmNoaWxkcmVuID09PSAiIikgew0KICAgICAgICAgICAgICBpbnNlcnQodm5vZGUuZWwgPSBjcmVhdGVUZXh0KCIiKSwgcGFyZW50Tm9kZShub2RlKSwgbm9kZSk7DQogICAgICAgICAgICAgIG5leHROb2RlID0gbm9kZTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgIG5leHROb2RlID0gb25NaXNtYXRjaCgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBpZiAobm9kZS5kYXRhICE9PSB2bm9kZS5jaGlsZHJlbikgew0KICAgICAgICAgICAgICB3YXJuJDEoDQogICAgICAgICAgICAgICAgYEh5ZHJhdGlvbiB0ZXh0IG1pc21hdGNoIGluYCwNCiAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUsDQogICAgICAgICAgICAgICAgYA0KICAtIHJlbmRlcmVkIG9uIHNlcnZlcjogJHtKU09OLnN0cmluZ2lmeSgNCiAgICAgICAgICAgICAgICBub2RlLmRhdGENCiAgICAgICAgICAgICAgKX0NCiAgLSBleHBlY3RlZCBvbiBjbGllbnQ6ICR7SlNPTi5zdHJpbmdpZnkodm5vZGUuY2hpbGRyZW4pfWANCiAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgbG9nTWlzbWF0Y2hFcnJvcigpOw0KICAgICAgICAgICAgICBub2RlLmRhdGEgPSB2bm9kZS5jaGlsZHJlbjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIG5leHROb2RlID0gbmV4dFNpYmxpbmcobm9kZSk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGJyZWFrOw0KICAgICAgICBjYXNlIENvbW1lbnQ6DQogICAgICAgICAgaWYgKGlzVGVtcGxhdGVOb2RlKG5vZGUpKSB7DQogICAgICAgICAgICBuZXh0Tm9kZSA9IG5leHRTaWJsaW5nKG5vZGUpOw0KICAgICAgICAgICAgcmVwbGFjZU5vZGUoDQogICAgICAgICAgICAgIHZub2RlLmVsID0gbm9kZS5jb250ZW50LmZpcnN0Q2hpbGQsDQogICAgICAgICAgICAgIG5vZGUsDQogICAgICAgICAgICAgIHBhcmVudENvbXBvbmVudA0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9IGVsc2UgaWYgKGRvbVR5cGUgIT09IDggfHwgaXNGcmFnbWVudFN0YXJ0KSB7DQogICAgICAgICAgICBuZXh0Tm9kZSA9IG9uTWlzbWF0Y2goKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgbmV4dE5vZGUgPSBuZXh0U2libGluZyhub2RlKTsNCiAgICAgICAgICB9DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIGNhc2UgU3RhdGljOg0KICAgICAgICAgIGlmIChpc0ZyYWdtZW50U3RhcnQpIHsNCiAgICAgICAgICAgIG5vZGUgPSBuZXh0U2libGluZyhub2RlKTsNCiAgICAgICAgICAgIGRvbVR5cGUgPSBub2RlLm5vZGVUeXBlOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpZiAoZG9tVHlwZSA9PT0gMSB8fCBkb21UeXBlID09PSAzKSB7DQogICAgICAgICAgICBuZXh0Tm9kZSA9IG5vZGU7DQogICAgICAgICAgICBjb25zdCBuZWVkVG9BZG9wdENvbnRlbnQgPSAhdm5vZGUuY2hpbGRyZW4ubGVuZ3RoOw0KICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2bm9kZS5zdGF0aWNDb3VudDsgaSsrKSB7DQogICAgICAgICAgICAgIGlmIChuZWVkVG9BZG9wdENvbnRlbnQpDQogICAgICAgICAgICAgICAgdm5vZGUuY2hpbGRyZW4gKz0gbmV4dE5vZGUubm9kZVR5cGUgPT09IDEgPyBuZXh0Tm9kZS5vdXRlckhUTUwgOiBuZXh0Tm9kZS5kYXRhOw0KICAgICAgICAgICAgICBpZiAoaSA9PT0gdm5vZGUuc3RhdGljQ291bnQgLSAxKSB7DQogICAgICAgICAgICAgICAgdm5vZGUuYW5jaG9yID0gbmV4dE5vZGU7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgbmV4dE5vZGUgPSBuZXh0U2libGluZyhuZXh0Tm9kZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gaXNGcmFnbWVudFN0YXJ0ID8gbmV4dFNpYmxpbmcobmV4dE5vZGUpIDogbmV4dE5vZGU7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIG9uTWlzbWF0Y2goKTsNCiAgICAgICAgICB9DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIGNhc2UgRnJhZ21lbnQ6DQogICAgICAgICAgaWYgKCFpc0ZyYWdtZW50U3RhcnQpIHsNCiAgICAgICAgICAgIG5leHROb2RlID0gb25NaXNtYXRjaCgpOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBuZXh0Tm9kZSA9IGh5ZHJhdGVGcmFnbWVudCgNCiAgICAgICAgICAgICAgbm9kZSwNCiAgICAgICAgICAgICAgdm5vZGUsDQogICAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICAgICAgb3B0aW1pemVkDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0NCiAgICAgICAgICBicmVhazsNCiAgICAgICAgZGVmYXVsdDoNCiAgICAgICAgICBpZiAoc2hhcGVGbGFnICYgMSkgew0KICAgICAgICAgICAgaWYgKChkb21UeXBlICE9PSAxIHx8IHZub2RlLnR5cGUudG9Mb3dlckNhc2UoKSAhPT0gbm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCkpICYmICFpc1RlbXBsYXRlTm9kZShub2RlKSkgew0KICAgICAgICAgICAgICBuZXh0Tm9kZSA9IG9uTWlzbWF0Y2goKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgIG5leHROb2RlID0gaHlkcmF0ZUVsZW1lbnQoDQogICAgICAgICAgICAgICAgbm9kZSwNCiAgICAgICAgICAgICAgICB2bm9kZSwNCiAgICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0gZWxzZSBpZiAoc2hhcGVGbGFnICYgNikgew0KICAgICAgICAgICAgdm5vZGUuc2xvdFNjb3BlSWRzID0gc2xvdFNjb3BlSWRzOw0KICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gcGFyZW50Tm9kZShub2RlKTsNCiAgICAgICAgICAgIGlmIChpc0ZyYWdtZW50U3RhcnQpIHsNCiAgICAgICAgICAgICAgbmV4dE5vZGUgPSBsb2NhdGVDbG9zaW5nQW5jaG9yKG5vZGUpOw0KICAgICAgICAgICAgfSBlbHNlIGlmIChpc0NvbW1lbnQobm9kZSkgJiYgbm9kZS5kYXRhID09PSAidGVsZXBvcnQgc3RhcnQiKSB7DQogICAgICAgICAgICAgIG5leHROb2RlID0gbG9jYXRlQ2xvc2luZ0FuY2hvcihub2RlLCBub2RlLmRhdGEsICJ0ZWxlcG9ydCBlbmQiKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgIG5leHROb2RlID0gbmV4dFNpYmxpbmcobm9kZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBtb3VudENvbXBvbmVudCgNCiAgICAgICAgICAgICAgdm5vZGUsDQogICAgICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICAgICAgbnVsbCwNCiAgICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgICAgZ2V0Q29udGFpbmVyVHlwZShjb250YWluZXIpLA0KICAgICAgICAgICAgICBvcHRpbWl6ZWQNCiAgICAgICAgICAgICk7DQogICAgICAgICAgICBpZiAoaXNBc3luY1dyYXBwZXIodm5vZGUpICYmICF2bm9kZS50eXBlLl9fYXN5bmNSZXNvbHZlZCkgew0KICAgICAgICAgICAgICBsZXQgc3ViVHJlZTsNCiAgICAgICAgICAgICAgaWYgKGlzRnJhZ21lbnRTdGFydCkgew0KICAgICAgICAgICAgICAgIHN1YlRyZWUgPSBjcmVhdGVWTm9kZShGcmFnbWVudCk7DQogICAgICAgICAgICAgICAgc3ViVHJlZS5hbmNob3IgPSBuZXh0Tm9kZSA/IG5leHROb2RlLnByZXZpb3VzU2libGluZyA6IGNvbnRhaW5lci5sYXN0Q2hpbGQ7DQogICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgc3ViVHJlZSA9IG5vZGUubm9kZVR5cGUgPT09IDMgPyBjcmVhdGVUZXh0Vk5vZGUoIiIpIDogY3JlYXRlVk5vZGUoImRpdiIpOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIHN1YlRyZWUuZWwgPSBub2RlOw0KICAgICAgICAgICAgICB2bm9kZS5jb21wb25lbnQuc3ViVHJlZSA9IHN1YlRyZWU7DQogICAgICAgICAgICB9DQogICAgICAgICAgfSBlbHNlIGlmIChzaGFwZUZsYWcgJiA2NCkgew0KICAgICAgICAgICAgaWYgKGRvbVR5cGUgIT09IDgpIHsNCiAgICAgICAgICAgICAgbmV4dE5vZGUgPSBvbk1pc21hdGNoKCk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICBuZXh0Tm9kZSA9IHZub2RlLnR5cGUuaHlkcmF0ZSgNCiAgICAgICAgICAgICAgICBub2RlLA0KICAgICAgICAgICAgICAgIHZub2RlLA0KICAgICAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgICAgICBzbG90U2NvcGVJZHMsDQogICAgICAgICAgICAgICAgb3B0aW1pemVkLA0KICAgICAgICAgICAgICAgIHJlbmRlcmVySW50ZXJuYWxzLA0KICAgICAgICAgICAgICAgIGh5ZHJhdGVDaGlsZHJlbg0KICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0gZWxzZSBpZiAoc2hhcGVGbGFnICYgMTI4KSB7DQogICAgICAgICAgICBuZXh0Tm9kZSA9IHZub2RlLnR5cGUuaHlkcmF0ZSgNCiAgICAgICAgICAgICAgbm9kZSwNCiAgICAgICAgICAgICAgdm5vZGUsDQogICAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICAgIGdldENvbnRhaW5lclR5cGUocGFyZW50Tm9kZShub2RlKSksDQogICAgICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICAgICAgb3B0aW1pemVkLA0KICAgICAgICAgICAgICByZW5kZXJlckludGVybmFscywNCiAgICAgICAgICAgICAgaHlkcmF0ZU5vZGUNCiAgICAgICAgICAgICk7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHdhcm4kMSgiSW52YWxpZCBIb3N0Vk5vZGUgdHlwZToiLCB0eXBlLCBgKCR7dHlwZW9mIHR5cGV9KWApOw0KICAgICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmIChyZWYgIT0gbnVsbCkgew0KICAgICAgICBzZXRSZWYocmVmLCBudWxsLCBwYXJlbnRTdXNwZW5zZSwgdm5vZGUpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIG5leHROb2RlOw0KICAgIH07DQogICAgY29uc3QgaHlkcmF0ZUVsZW1lbnQgPSAoZWwsIHZub2RlLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCkgPT4gew0KICAgICAgb3B0aW1pemVkID0gb3B0aW1pemVkIHx8ICEhdm5vZGUuZHluYW1pY0NoaWxkcmVuOw0KICAgICAgY29uc3QgeyB0eXBlLCBwcm9wcywgcGF0Y2hGbGFnLCBzaGFwZUZsYWcsIGRpcnMsIHRyYW5zaXRpb24gfSA9IHZub2RlOw0KICAgICAgY29uc3QgZm9yY2VQYXRjaCA9IHR5cGUgPT09ICJpbnB1dCIgfHwgdHlwZSA9PT0gIm9wdGlvbiI7DQogICAgICB7DQogICAgICAgIGlmIChkaXJzKSB7DQogICAgICAgICAgaW52b2tlRGlyZWN0aXZlSG9vayh2bm9kZSwgbnVsbCwgcGFyZW50Q29tcG9uZW50LCAiY3JlYXRlZCIpOw0KICAgICAgICB9DQogICAgICAgIGxldCBuZWVkQ2FsbFRyYW5zaXRpb25Ib29rcyA9IGZhbHNlOw0KICAgICAgICBpZiAoaXNUZW1wbGF0ZU5vZGUoZWwpKSB7DQogICAgICAgICAgbmVlZENhbGxUcmFuc2l0aW9uSG9va3MgPSBuZWVkVHJhbnNpdGlvbigNCiAgICAgICAgICAgIG51bGwsDQogICAgICAgICAgICAvLyBubyBuZWVkIGNoZWNrIHBhcmVudFN1c3BlbnNlIGluIGh5ZHJhdGlvbg0KICAgICAgICAgICAgdHJhbnNpdGlvbg0KICAgICAgICAgICkgJiYgcGFyZW50Q29tcG9uZW50ICYmIHBhcmVudENvbXBvbmVudC52bm9kZS5wcm9wcyAmJiBwYXJlbnRDb21wb25lbnQudm5vZGUucHJvcHMuYXBwZWFyOw0KICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBlbC5jb250ZW50LmZpcnN0Q2hpbGQ7DQogICAgICAgICAgaWYgKG5lZWRDYWxsVHJhbnNpdGlvbkhvb2tzKSB7DQogICAgICAgICAgICBjb25zdCBjbHMgPSBjb250ZW50LmdldEF0dHJpYnV0ZSgiY2xhc3MiKTsNCiAgICAgICAgICAgIGlmIChjbHMpIGNvbnRlbnQuJGNscyA9IGNsczsNCiAgICAgICAgICAgIHRyYW5zaXRpb24uYmVmb3JlRW50ZXIoY29udGVudCk7DQogICAgICAgICAgfQ0KICAgICAgICAgIHJlcGxhY2VOb2RlKGNvbnRlbnQsIGVsLCBwYXJlbnRDb21wb25lbnQpOw0KICAgICAgICAgIHZub2RlLmVsID0gZWwgPSBjb250ZW50Ow0KICAgICAgICB9DQogICAgICAgIGlmIChzaGFwZUZsYWcgJiAxNiAmJiAvLyBza2lwIGlmIGVsZW1lbnQgaGFzIGlubmVySFRNTCAvIHRleHRDb250ZW50DQogICAgICAgICEocHJvcHMgJiYgKHByb3BzLmlubmVySFRNTCB8fCBwcm9wcy50ZXh0Q29udGVudCkpKSB7DQogICAgICAgICAgbGV0IG5leHQgPSBoeWRyYXRlQ2hpbGRyZW4oDQogICAgICAgICAgICBlbC5maXJzdENoaWxkLA0KICAgICAgICAgICAgdm5vZGUsDQogICAgICAgICAgICBlbCwNCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLA0KICAgICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgICAgb3B0aW1pemVkDQogICAgICAgICAgKTsNCiAgICAgICAgICBsZXQgaGFzV2FybmVkID0gZmFsc2U7DQogICAgICAgICAgd2hpbGUgKG5leHQpIHsNCiAgICAgICAgICAgIGlmICghaXNNaXNtYXRjaEFsbG93ZWQoZWwsIDEgLyogQ0hJTERSRU4gKi8pKSB7DQogICAgICAgICAgICAgIGlmICghaGFzV2FybmVkKSB7DQogICAgICAgICAgICAgICAgd2FybiQxKA0KICAgICAgICAgICAgICAgICAgYEh5ZHJhdGlvbiBjaGlsZHJlbiBtaXNtYXRjaCBvbmAsDQogICAgICAgICAgICAgICAgICBlbCwNCiAgICAgICAgICAgICAgICAgIGANClNlcnZlciByZW5kZXJlZCBlbGVtZW50IGNvbnRhaW5zIG1vcmUgY2hpbGQgbm9kZXMgdGhhbiBjbGllbnQgdmRvbS5gDQogICAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgICBoYXNXYXJuZWQgPSB0cnVlOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGxvZ01pc21hdGNoRXJyb3IoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNvbnN0IGN1ciA9IG5leHQ7DQogICAgICAgICAgICBuZXh0ID0gbmV4dC5uZXh0U2libGluZzsNCiAgICAgICAgICAgIHJlbW92ZShjdXIpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIGlmIChzaGFwZUZsYWcgJiA4KSB7DQogICAgICAgICAgbGV0IGNsaWVudFRleHQgPSB2bm9kZS5jaGlsZHJlbjsNCiAgICAgICAgICBpZiAoY2xpZW50VGV4dFswXSA9PT0gIlxuIiAmJiAoZWwudGFnTmFtZSA9PT0gIlBSRSIgfHwgZWwudGFnTmFtZSA9PT0gIlRFWFRBUkVBIikpIHsNCiAgICAgICAgICAgIGNsaWVudFRleHQgPSBjbGllbnRUZXh0LnNsaWNlKDEpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpZiAoZWwudGV4dENvbnRlbnQgIT09IGNsaWVudFRleHQpIHsNCiAgICAgICAgICAgIGlmICghaXNNaXNtYXRjaEFsbG93ZWQoZWwsIDAgLyogVEVYVCAqLykpIHsNCiAgICAgICAgICAgICAgd2FybiQxKA0KICAgICAgICAgICAgICAgIGBIeWRyYXRpb24gdGV4dCBjb250ZW50IG1pc21hdGNoIG9uYCwNCiAgICAgICAgICAgICAgICBlbCwNCiAgICAgICAgICAgICAgICBgDQogIC0gcmVuZGVyZWQgb24gc2VydmVyOiAke2VsLnRleHRDb250ZW50fQ0KICAtIGV4cGVjdGVkIG9uIGNsaWVudDogJHt2bm9kZS5jaGlsZHJlbn1gDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICAgIGxvZ01pc21hdGNoRXJyb3IoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsLnRleHRDb250ZW50ID0gdm5vZGUuY2hpbGRyZW47DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGlmIChwcm9wcykgew0KICAgICAgICAgIHsNCiAgICAgICAgICAgIGNvbnN0IGlzQ3VzdG9tRWxlbWVudCA9IGVsLnRhZ05hbWUuaW5jbHVkZXMoIi0iKTsNCiAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIHByb3BzKSB7DQogICAgICAgICAgICAgIGlmICgvLyAjMTExODkgc2tpcCBpZiB0aGlzIG5vZGUgaGFzIGRpcmVjdGl2ZXMgdGhhdCBoYXZlIGNyZWF0ZWQgaG9va3MNCiAgICAgICAgICAgICAgLy8gYXMgaXQgY291bGQgaGF2ZSBtdXRhdGVkIHRoZSBET00gaW4gYW55IHBvc3NpYmxlIHdheQ0KICAgICAgICAgICAgICAhKGRpcnMgJiYgZGlycy5zb21lKChkKSA9PiBkLmRpci5jcmVhdGVkKSkgJiYgcHJvcEhhc01pc21hdGNoKGVsLCBrZXksIHByb3BzW2tleV0sIHZub2RlLCBwYXJlbnRDb21wb25lbnQpKSB7DQogICAgICAgICAgICAgICAgbG9nTWlzbWF0Y2hFcnJvcigpOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGlmIChmb3JjZVBhdGNoICYmIChrZXkuZW5kc1dpdGgoInZhbHVlIikgfHwga2V5ID09PSAiaW5kZXRlcm1pbmF0ZSIpIHx8IGlzT24oa2V5KSAmJiAhaXNSZXNlcnZlZFByb3Aoa2V5KSB8fCAvLyBmb3JjZSBoeWRyYXRlIHYtYmluZCB3aXRoIC5wcm9wIG1vZGlmaWVycw0KICAgICAgICAgICAgICBrZXlbMF0gPT09ICIuIiB8fCBpc0N1c3RvbUVsZW1lbnQpIHsNCiAgICAgICAgICAgICAgICBwYXRjaFByb3AoZWwsIGtleSwgbnVsbCwgcHJvcHNba2V5XSwgdm9pZCAwLCBwYXJlbnRDb21wb25lbnQpOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGxldCB2bm9kZUhvb2tzOw0KICAgICAgICBpZiAodm5vZGVIb29rcyA9IHByb3BzICYmIHByb3BzLm9uVm5vZGVCZWZvcmVNb3VudCkgew0KICAgICAgICAgIGludm9rZVZOb2RlSG9vayh2bm9kZUhvb2tzLCBwYXJlbnRDb21wb25lbnQsIHZub2RlKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoZGlycykgew0KICAgICAgICAgIGludm9rZURpcmVjdGl2ZUhvb2sodm5vZGUsIG51bGwsIHBhcmVudENvbXBvbmVudCwgImJlZm9yZU1vdW50Iik7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCh2bm9kZUhvb2tzID0gcHJvcHMgJiYgcHJvcHMub25Wbm9kZU1vdW50ZWQpIHx8IGRpcnMgfHwgbmVlZENhbGxUcmFuc2l0aW9uSG9va3MpIHsNCiAgICAgICAgICBxdWV1ZUVmZmVjdFdpdGhTdXNwZW5zZSgoKSA9PiB7DQogICAgICAgICAgICB2bm9kZUhvb2tzICYmIGludm9rZVZOb2RlSG9vayh2bm9kZUhvb2tzLCBwYXJlbnRDb21wb25lbnQsIHZub2RlKTsNCiAgICAgICAgICAgIG5lZWRDYWxsVHJhbnNpdGlvbkhvb2tzICYmIHRyYW5zaXRpb24uZW50ZXIoZWwpOw0KICAgICAgICAgICAgZGlycyAmJiBpbnZva2VEaXJlY3RpdmVIb29rKHZub2RlLCBudWxsLCBwYXJlbnRDb21wb25lbnQsICJtb3VudGVkIik7DQogICAgICAgICAgfSwgcGFyZW50U3VzcGVuc2UpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICByZXR1cm4gZWwubmV4dFNpYmxpbmc7DQogICAgfTsNCiAgICBjb25zdCBoeWRyYXRlQ2hpbGRyZW4gPSAobm9kZSwgcGFyZW50Vk5vZGUsIGNvbnRhaW5lciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpID0+IHsNCiAgICAgIG9wdGltaXplZCA9IG9wdGltaXplZCB8fCAhIXBhcmVudFZOb2RlLmR5bmFtaWNDaGlsZHJlbjsNCiAgICAgIGNvbnN0IGNoaWxkcmVuID0gcGFyZW50Vk5vZGUuY2hpbGRyZW47DQogICAgICBjb25zdCBsID0gY2hpbGRyZW4ubGVuZ3RoOw0KICAgICAgbGV0IGhhc1dhcm5lZCA9IGZhbHNlOw0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsOyBpKyspIHsNCiAgICAgICAgY29uc3Qgdm5vZGUgPSBvcHRpbWl6ZWQgPyBjaGlsZHJlbltpXSA6IGNoaWxkcmVuW2ldID0gbm9ybWFsaXplVk5vZGUoY2hpbGRyZW5baV0pOw0KICAgICAgICBjb25zdCBpc1RleHQgPSB2bm9kZS50eXBlID09PSBUZXh0Ow0KICAgICAgICBpZiAobm9kZSkgew0KICAgICAgICAgIGlmIChpc1RleHQgJiYgIW9wdGltaXplZCkgew0KICAgICAgICAgICAgaWYgKGkgKyAxIDwgbCAmJiBub3JtYWxpemVWTm9kZShjaGlsZHJlbltpICsgMV0pLnR5cGUgPT09IFRleHQpIHsNCiAgICAgICAgICAgICAgaW5zZXJ0KA0KICAgICAgICAgICAgICAgIGNyZWF0ZVRleHQoDQogICAgICAgICAgICAgICAgICBub2RlLmRhdGEuc2xpY2Uodm5vZGUuY2hpbGRyZW4ubGVuZ3RoKQ0KICAgICAgICAgICAgICAgICksDQogICAgICAgICAgICAgICAgY29udGFpbmVyLA0KICAgICAgICAgICAgICAgIG5leHRTaWJsaW5nKG5vZGUpDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICAgIG5vZGUuZGF0YSA9IHZub2RlLmNoaWxkcmVuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgICBub2RlID0gaHlkcmF0ZU5vZGUoDQogICAgICAgICAgICBub2RlLA0KICAgICAgICAgICAgdm5vZGUsDQogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICAgICk7DQogICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0ICYmICF2bm9kZS5jaGlsZHJlbikgew0KICAgICAgICAgIGluc2VydCh2bm9kZS5lbCA9IGNyZWF0ZVRleHQoIiIpLCBjb250YWluZXIpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGlmICghaXNNaXNtYXRjaEFsbG93ZWQoY29udGFpbmVyLCAxIC8qIENISUxEUkVOICovKSkgew0KICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWQpIHsNCiAgICAgICAgICAgICAgd2FybiQxKA0KICAgICAgICAgICAgICAgIGBIeWRyYXRpb24gY2hpbGRyZW4gbWlzbWF0Y2ggb25gLA0KICAgICAgICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICAgICAgICBgDQpTZXJ2ZXIgcmVuZGVyZWQgZWxlbWVudCBjb250YWlucyBmZXdlciBjaGlsZCBub2RlcyB0aGFuIGNsaWVudCB2ZG9tLmANCiAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgaGFzV2FybmVkID0gdHJ1ZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGxvZ01pc21hdGNoRXJyb3IoKTsNCiAgICAgICAgICB9DQogICAgICAgICAgcGF0Y2goDQogICAgICAgICAgICBudWxsLA0KICAgICAgICAgICAgdm5vZGUsDQogICAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgICBudWxsLA0KICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICBnZXRDb250YWluZXJUeXBlKGNvbnRhaW5lciksDQogICAgICAgICAgICBzbG90U2NvcGVJZHMNCiAgICAgICAgICApOw0KICAgICAgICB9DQogICAgICB9DQogICAgICByZXR1cm4gbm9kZTsNCiAgICB9Ow0KICAgIGNvbnN0IGh5ZHJhdGVGcmFnbWVudCA9IChub2RlLCB2bm9kZSwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpID0+IHsNCiAgICAgIGNvbnN0IHsgc2xvdFNjb3BlSWRzOiBmcmFnbWVudFNsb3RTY29wZUlkcyB9ID0gdm5vZGU7DQogICAgICBpZiAoZnJhZ21lbnRTbG90U2NvcGVJZHMpIHsNCiAgICAgICAgc2xvdFNjb3BlSWRzID0gc2xvdFNjb3BlSWRzID8gc2xvdFNjb3BlSWRzLmNvbmNhdChmcmFnbWVudFNsb3RTY29wZUlkcykgOiBmcmFnbWVudFNsb3RTY29wZUlkczsNCiAgICAgIH0NCiAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHBhcmVudE5vZGUobm9kZSk7DQogICAgICBjb25zdCBuZXh0ID0gaHlkcmF0ZUNoaWxkcmVuKA0KICAgICAgICBuZXh0U2libGluZyhub2RlKSwNCiAgICAgICAgdm5vZGUsDQogICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICBvcHRpbWl6ZWQNCiAgICAgICk7DQogICAgICBpZiAobmV4dCAmJiBpc0NvbW1lbnQobmV4dCkgJiYgbmV4dC5kYXRhID09PSAiXSIpIHsNCiAgICAgICAgcmV0dXJuIG5leHRTaWJsaW5nKHZub2RlLmFuY2hvciA9IG5leHQpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgbG9nTWlzbWF0Y2hFcnJvcigpOw0KICAgICAgICBpbnNlcnQodm5vZGUuYW5jaG9yID0gY3JlYXRlQ29tbWVudChgXWApLCBjb250YWluZXIsIG5leHQpOw0KICAgICAgICByZXR1cm4gbmV4dDsNCiAgICAgIH0NCiAgICB9Ow0KICAgIGNvbnN0IGhhbmRsZU1pc21hdGNoID0gKG5vZGUsIHZub2RlLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBzbG90U2NvcGVJZHMsIGlzRnJhZ21lbnQpID0+IHsNCiAgICAgIGlmICghaXNNaXNtYXRjaEFsbG93ZWQobm9kZS5wYXJlbnRFbGVtZW50LCAxIC8qIENISUxEUkVOICovKSkgew0KICAgICAgICB3YXJuJDEoDQogICAgICAgICAgYEh5ZHJhdGlvbiBub2RlIG1pc21hdGNoOg0KLSByZW5kZXJlZCBvbiBzZXJ2ZXI6YCwNCiAgICAgICAgICBub2RlLA0KICAgICAgICAgIG5vZGUubm9kZVR5cGUgPT09IDMgPyBgKHRleHQpYCA6IGlzQ29tbWVudChub2RlKSAmJiBub2RlLmRhdGEgPT09ICJbIiA/IGAoc3RhcnQgb2YgZnJhZ21lbnQpYCA6IGBgLA0KICAgICAgICAgIGANCi0gZXhwZWN0ZWQgb24gY2xpZW50OmAsDQogICAgICAgICAgdm5vZGUudHlwZQ0KICAgICAgICApOw0KICAgICAgICBsb2dNaXNtYXRjaEVycm9yKCk7DQogICAgICB9DQogICAgICB2bm9kZS5lbCA9IG51bGw7DQogICAgICBpZiAoaXNGcmFnbWVudCkgew0KICAgICAgICBjb25zdCBlbmQgPSBsb2NhdGVDbG9zaW5nQW5jaG9yKG5vZGUpOw0KICAgICAgICB3aGlsZSAodHJ1ZSkgew0KICAgICAgICAgIGNvbnN0IG5leHQyID0gbmV4dFNpYmxpbmcobm9kZSk7DQogICAgICAgICAgaWYgKG5leHQyICYmIG5leHQyICE9PSBlbmQpIHsNCiAgICAgICAgICAgIHJlbW92ZShuZXh0Mik7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgY29uc3QgbmV4dCA9IG5leHRTaWJsaW5nKG5vZGUpOw0KICAgICAgY29uc3QgY29udGFpbmVyID0gcGFyZW50Tm9kZShub2RlKTsNCiAgICAgIHJlbW92ZShub2RlKTsNCiAgICAgIHBhdGNoKA0KICAgICAgICBudWxsLA0KICAgICAgICB2bm9kZSwNCiAgICAgICAgY29udGFpbmVyLA0KICAgICAgICBuZXh0LA0KICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgIHBhcmVudFN1c3BlbnNlLA0KICAgICAgICBnZXRDb250YWluZXJUeXBlKGNvbnRhaW5lciksDQogICAgICAgIHNsb3RTY29wZUlkcw0KICAgICAgKTsNCiAgICAgIGlmIChwYXJlbnRDb21wb25lbnQpIHsNCiAgICAgICAgcGFyZW50Q29tcG9uZW50LnZub2RlLmVsID0gdm5vZGUuZWw7DQogICAgICAgIHVwZGF0ZUhPQ0hvc3RFbChwYXJlbnRDb21wb25lbnQsIHZub2RlLmVsKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBuZXh0Ow0KICAgIH07DQogICAgY29uc3QgbG9jYXRlQ2xvc2luZ0FuY2hvciA9IChub2RlLCBvcGVuID0gIlsiLCBjbG9zZSA9ICJdIikgPT4gew0KICAgICAgbGV0IG1hdGNoID0gMDsNCiAgICAgIHdoaWxlIChub2RlKSB7DQogICAgICAgIG5vZGUgPSBuZXh0U2libGluZyhub2RlKTsNCiAgICAgICAgaWYgKG5vZGUgJiYgaXNDb21tZW50KG5vZGUpKSB7DQogICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gb3BlbikgbWF0Y2grKzsNCiAgICAgICAgICBpZiAobm9kZS5kYXRhID09PSBjbG9zZSkgew0KICAgICAgICAgICAgaWYgKG1hdGNoID09PSAwKSB7DQogICAgICAgICAgICAgIHJldHVybiBuZXh0U2libGluZyhub2RlKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgIG1hdGNoLS07DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgICByZXR1cm4gbm9kZTsNCiAgICB9Ow0KICAgIGNvbnN0IHJlcGxhY2VOb2RlID0gKG5ld05vZGUsIG9sZE5vZGUsIHBhcmVudENvbXBvbmVudCkgPT4gew0KICAgICAgY29uc3QgcGFyZW50Tm9kZTIgPSBvbGROb2RlLnBhcmVudE5vZGU7DQogICAgICBpZiAocGFyZW50Tm9kZTIpIHsNCiAgICAgICAgcGFyZW50Tm9kZTIucmVwbGFjZUNoaWxkKG5ld05vZGUsIG9sZE5vZGUpOw0KICAgICAgfQ0KICAgICAgbGV0IHBhcmVudCA9IHBhcmVudENvbXBvbmVudDsNCiAgICAgIHdoaWxlIChwYXJlbnQpIHsNCiAgICAgICAgaWYgKHBhcmVudC52bm9kZS5lbCA9PT0gb2xkTm9kZSkgew0KICAgICAgICAgIHBhcmVudC52bm9kZS5lbCA9IHBhcmVudC5zdWJUcmVlLmVsID0gbmV3Tm9kZTsNCiAgICAgICAgfQ0KICAgICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50Ow0KICAgICAgfQ0KICAgIH07DQogICAgY29uc3QgaXNUZW1wbGF0ZU5vZGUgPSAobm9kZSkgPT4gew0KICAgICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT09IDEgJiYgbm9kZS50YWdOYW1lID09PSAiVEVNUExBVEUiOw0KICAgIH07DQogICAgcmV0dXJuIFtoeWRyYXRlLCBoeWRyYXRlTm9kZV07DQogIH0NCiAgZnVuY3Rpb24gcHJvcEhhc01pc21hdGNoKGVsLCBrZXksIGNsaWVudFZhbHVlLCB2bm9kZSwgaW5zdGFuY2UpIHsNCiAgICBsZXQgbWlzbWF0Y2hUeXBlOw0KICAgIGxldCBtaXNtYXRjaEtleTsNCiAgICBsZXQgYWN0dWFsOw0KICAgIGxldCBleHBlY3RlZDsNCiAgICBpZiAoa2V5ID09PSAiY2xhc3MiKSB7DQogICAgICBpZiAoZWwuJGNscykgew0KICAgICAgICBhY3R1YWwgPSBlbC4kY2xzOw0KICAgICAgICBkZWxldGUgZWwuJGNsczsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGFjdHVhbCA9IGVsLmdldEF0dHJpYnV0ZSgiY2xhc3MiKTsNCiAgICAgIH0NCiAgICAgIGV4cGVjdGVkID0gbm9ybWFsaXplQ2xhc3MoY2xpZW50VmFsdWUpOw0KICAgICAgaWYgKCFpc1NldEVxdWFsKHRvQ2xhc3NTZXQoYWN0dWFsIHx8ICIiKSwgdG9DbGFzc1NldChleHBlY3RlZCkpKSB7DQogICAgICAgIG1pc21hdGNoVHlwZSA9IDIgLyogQ0xBU1MgKi87DQogICAgICAgIG1pc21hdGNoS2V5ID0gYGNsYXNzYDsNCiAgICAgIH0NCiAgICB9IGVsc2UgaWYgKGtleSA9PT0gInN0eWxlIikgew0KICAgICAgYWN0dWFsID0gZWwuZ2V0QXR0cmlidXRlKCJzdHlsZSIpIHx8ICIiOw0KICAgICAgZXhwZWN0ZWQgPSBpc1N0cmluZyhjbGllbnRWYWx1ZSkgPyBjbGllbnRWYWx1ZSA6IHN0cmluZ2lmeVN0eWxlKG5vcm1hbGl6ZVN0eWxlKGNsaWVudFZhbHVlKSk7DQogICAgICBjb25zdCBhY3R1YWxNYXAgPSB0b1N0eWxlTWFwKGFjdHVhbCk7DQogICAgICBjb25zdCBleHBlY3RlZE1hcCA9IHRvU3R5bGVNYXAoZXhwZWN0ZWQpOw0KICAgICAgaWYgKHZub2RlLmRpcnMpIHsNCiAgICAgICAgZm9yIChjb25zdCB7IGRpciwgdmFsdWUgfSBvZiB2bm9kZS5kaXJzKSB7DQogICAgICAgICAgaWYgKGRpci5uYW1lID09PSAic2hvdyIgJiYgIXZhbHVlKSB7DQogICAgICAgICAgICBleHBlY3RlZE1hcC5zZXQoImRpc3BsYXkiLCAibm9uZSIpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgaWYgKGluc3RhbmNlKSB7DQogICAgICAgIHJlc29sdmVDc3NWYXJzKGluc3RhbmNlLCB2bm9kZSwgZXhwZWN0ZWRNYXApOw0KICAgICAgfQ0KICAgICAgaWYgKCFpc01hcEVxdWFsKGFjdHVhbE1hcCwgZXhwZWN0ZWRNYXApKSB7DQogICAgICAgIG1pc21hdGNoVHlwZSA9IDMgLyogU1RZTEUgKi87DQogICAgICAgIG1pc21hdGNoS2V5ID0gInN0eWxlIjsNCiAgICAgIH0NCiAgICB9IGVsc2UgaWYgKGVsIGluc3RhbmNlb2YgU1ZHRWxlbWVudCAmJiBpc0tub3duU3ZnQXR0cihrZXkpIHx8IGVsIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgJiYgKGlzQm9vbGVhbkF0dHIoa2V5KSB8fCBpc0tub3duSHRtbEF0dHIoa2V5KSkpIHsNCiAgICAgIGlmIChpc0Jvb2xlYW5BdHRyKGtleSkpIHsNCiAgICAgICAgYWN0dWFsID0gZWwuaGFzQXR0cmlidXRlKGtleSk7DQogICAgICAgIGV4cGVjdGVkID0gaW5jbHVkZUJvb2xlYW5BdHRyKGNsaWVudFZhbHVlKTsNCiAgICAgIH0gZWxzZSBpZiAoY2xpZW50VmFsdWUgPT0gbnVsbCkgew0KICAgICAgICBhY3R1YWwgPSBlbC5oYXNBdHRyaWJ1dGUoa2V5KTsNCiAgICAgICAgZXhwZWN0ZWQgPSBmYWxzZTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGlmIChlbC5oYXNBdHRyaWJ1dGUoa2V5KSkgew0KICAgICAgICAgIGFjdHVhbCA9IGVsLmdldEF0dHJpYnV0ZShrZXkpOw0KICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gInZhbHVlIiAmJiBlbC50YWdOYW1lID09PSAiVEVYVEFSRUEiKSB7DQogICAgICAgICAgYWN0dWFsID0gZWwudmFsdWU7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgYWN0dWFsID0gZmFsc2U7DQogICAgICAgIH0NCiAgICAgICAgZXhwZWN0ZWQgPSBpc1JlbmRlcmFibGVBdHRyVmFsdWUoY2xpZW50VmFsdWUpID8gU3RyaW5nKGNsaWVudFZhbHVlKSA6IGZhbHNlOw0KICAgICAgfQ0KICAgICAgaWYgKGFjdHVhbCAhPT0gZXhwZWN0ZWQpIHsNCiAgICAgICAgbWlzbWF0Y2hUeXBlID0gNCAvKiBBVFRSSUJVVEUgKi87DQogICAgICAgIG1pc21hdGNoS2V5ID0ga2V5Ow0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAobWlzbWF0Y2hUeXBlICE9IG51bGwgJiYgIWlzTWlzbWF0Y2hBbGxvd2VkKGVsLCBtaXNtYXRjaFR5cGUpKSB7DQogICAgICBjb25zdCBmb3JtYXQgPSAodikgPT4gdiA9PT0gZmFsc2UgPyBgKG5vdCByZW5kZXJlZClgIDogYCR7bWlzbWF0Y2hLZXl9PSIke3Z9ImA7DQogICAgICBjb25zdCBwcmVTZWdtZW50ID0gYEh5ZHJhdGlvbiAke01pc21hdGNoVHlwZVN0cmluZ1ttaXNtYXRjaFR5cGVdfSBtaXNtYXRjaCBvbmA7DQogICAgICBjb25zdCBwb3N0U2VnbWVudCA9IGANCiAgLSByZW5kZXJlZCBvbiBzZXJ2ZXI6ICR7Zm9ybWF0KGFjdHVhbCl9DQogIC0gZXhwZWN0ZWQgb24gY2xpZW50OiAke2Zvcm1hdChleHBlY3RlZCl9DQogIE5vdGU6IHRoaXMgbWlzbWF0Y2ggaXMgY2hlY2stb25seS4gVGhlIERPTSB3aWxsIG5vdCBiZSByZWN0aWZpZWQgaW4gcHJvZHVjdGlvbiBkdWUgdG8gcGVyZm9ybWFuY2Ugb3ZlcmhlYWQuDQogIFlvdSBzaG91bGQgZml4IHRoZSBzb3VyY2Ugb2YgdGhlIG1pc21hdGNoLmA7DQogICAgICB7DQogICAgICAgIHdhcm4kMShwcmVTZWdtZW50LCBlbCwgcG9zdFNlZ21lbnQpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KICAgIHJldHVybiBmYWxzZTsNCiAgfQ0KICBmdW5jdGlvbiB0b0NsYXNzU2V0KHN0cikgew0KICAgIHJldHVybiBuZXcgU2V0KHN0ci50cmltKCkuc3BsaXQoL1xzKy8pKTsNCiAgfQ0KICBmdW5jdGlvbiBpc1NldEVxdWFsKGEsIGIpIHsNCiAgICBpZiAoYS5zaXplICE9PSBiLnNpemUpIHsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQogICAgZm9yIChjb25zdCBzIG9mIGEpIHsNCiAgICAgIGlmICghYi5oYXMocykpIHsNCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gdHJ1ZTsNCiAgfQ0KICBmdW5jdGlvbiB0b1N0eWxlTWFwKHN0cikgew0KICAgIGNvbnN0IHN0eWxlTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsNCiAgICBmb3IgKGNvbnN0IGl0ZW0gb2Ygc3RyLnNwbGl0KCI7IikpIHsNCiAgICAgIGxldCBba2V5LCB2YWx1ZV0gPSBpdGVtLnNwbGl0KCI6Iik7DQogICAgICBrZXkgPSBrZXkudHJpbSgpOw0KICAgICAgdmFsdWUgPSB2YWx1ZSAmJiB2YWx1ZS50cmltKCk7DQogICAgICBpZiAoa2V5ICYmIHZhbHVlKSB7DQogICAgICAgIHN0eWxlTWFwLnNldChrZXksIHZhbHVlKTsNCiAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHN0eWxlTWFwOw0KICB9DQogIGZ1bmN0aW9uIGlzTWFwRXF1YWwoYSwgYikgew0KICAgIGlmIChhLnNpemUgIT09IGIuc2l6ZSkgew0KICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH0NCiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBhKSB7DQogICAgICBpZiAodmFsdWUgIT09IGIuZ2V0KGtleSkpIHsNCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gdHJ1ZTsNCiAgfQ0KICBmdW5jdGlvbiByZXNvbHZlQ3NzVmFycyhpbnN0YW5jZSwgdm5vZGUsIGV4cGVjdGVkTWFwKSB7DQogICAgY29uc3Qgcm9vdCA9IGluc3RhbmNlLnN1YlRyZWU7DQogICAgaWYgKGluc3RhbmNlLmdldENzc1ZhcnMgJiYgKHZub2RlID09PSByb290IHx8IHJvb3QgJiYgcm9vdC50eXBlID09PSBGcmFnbWVudCAmJiByb290LmNoaWxkcmVuLmluY2x1ZGVzKHZub2RlKSkpIHsNCiAgICAgIGNvbnN0IGNzc1ZhcnMgPSBpbnN0YW5jZS5nZXRDc3NWYXJzKCk7DQogICAgICBmb3IgKGNvbnN0IGtleSBpbiBjc3NWYXJzKSB7DQogICAgICAgIGV4cGVjdGVkTWFwLnNldCgNCiAgICAgICAgICBgLS0ke2dldEVzY2FwZWRDc3NWYXJOYW1lKGtleSl9YCwNCiAgICAgICAgICBTdHJpbmcoY3NzVmFyc1trZXldKQ0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAodm5vZGUgPT09IHJvb3QgJiYgaW5zdGFuY2UucGFyZW50KSB7DQogICAgICByZXNvbHZlQ3NzVmFycyhpbnN0YW5jZS5wYXJlbnQsIGluc3RhbmNlLnZub2RlLCBleHBlY3RlZE1hcCk7DQogICAgfQ0KICB9DQogIGNvbnN0IGFsbG93TWlzbWF0Y2hBdHRyID0gImRhdGEtYWxsb3ctbWlzbWF0Y2giOw0KICBjb25zdCBNaXNtYXRjaFR5cGVTdHJpbmcgPSB7DQogICAgWzAgLyogVEVYVCAqL106ICJ0ZXh0IiwNCiAgICBbMSAvKiBDSElMRFJFTiAqL106ICJjaGlsZHJlbiIsDQogICAgWzIgLyogQ0xBU1MgKi9dOiAiY2xhc3MiLA0KICAgIFszIC8qIFNUWUxFICovXTogInN0eWxlIiwNCiAgICBbNCAvKiBBVFRSSUJVVEUgKi9dOiAiYXR0cmlidXRlIg0KICB9Ow0KICBmdW5jdGlvbiBpc01pc21hdGNoQWxsb3dlZChlbCwgYWxsb3dlZFR5cGUpIHsNCiAgICBpZiAoYWxsb3dlZFR5cGUgPT09IDAgLyogVEVYVCAqLyB8fCBhbGxvd2VkVHlwZSA9PT0gMSAvKiBDSElMRFJFTiAqLykgew0KICAgICAgd2hpbGUgKGVsICYmICFlbC5oYXNBdHRyaWJ1dGUoYWxsb3dNaXNtYXRjaEF0dHIpKSB7DQogICAgICAgIGVsID0gZWwucGFyZW50RWxlbWVudDsNCiAgICAgIH0NCiAgICB9DQogICAgY29uc3QgYWxsb3dlZEF0dHIgPSBlbCAmJiBlbC5nZXRBdHRyaWJ1dGUoYWxsb3dNaXNtYXRjaEF0dHIpOw0KICAgIGlmIChhbGxvd2VkQXR0ciA9PSBudWxsKSB7DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfSBlbHNlIGlmIChhbGxvd2VkQXR0ciA9PT0gIiIpIHsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0gZWxzZSB7DQogICAgICBjb25zdCBsaXN0ID0gYWxsb3dlZEF0dHIuc3BsaXQoIiwiKTsNCiAgICAgIGlmIChhbGxvd2VkVHlwZSA9PT0gMCAvKiBURVhUICovICYmIGxpc3QuaW5jbHVkZXMoImNoaWxkcmVuIikpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgICByZXR1cm4gbGlzdC5pbmNsdWRlcyhNaXNtYXRjaFR5cGVTdHJpbmdbYWxsb3dlZFR5cGVdKTsNCiAgICB9DQogIH0NCg0KICBjb25zdCByZXF1ZXN0SWRsZUNhbGxiYWNrID0gZ2V0R2xvYmFsVGhpcygpLnJlcXVlc3RJZGxlQ2FsbGJhY2sgfHwgKChjYikgPT4gc2V0VGltZW91dChjYiwgMSkpOw0KICBjb25zdCBjYW5jZWxJZGxlQ2FsbGJhY2sgPSBnZXRHbG9iYWxUaGlzKCkuY2FuY2VsSWRsZUNhbGxiYWNrIHx8ICgoaWQpID0+IGNsZWFyVGltZW91dChpZCkpOw0KICBjb25zdCBoeWRyYXRlT25JZGxlID0gKHRpbWVvdXQgPSAxZTQpID0+IChoeWRyYXRlKSA9PiB7DQogICAgY29uc3QgaWQgPSByZXF1ZXN0SWRsZUNhbGxiYWNrKGh5ZHJhdGUsIHsgdGltZW91dCB9KTsNCiAgICByZXR1cm4gKCkgPT4gY2FuY2VsSWRsZUNhbGxiYWNrKGlkKTsNCiAgfTsNCiAgZnVuY3Rpb24gZWxlbWVudElzVmlzaWJsZUluVmlld3BvcnQoZWwpIHsNCiAgICBjb25zdCB7IHRvcCwgbGVmdCwgYm90dG9tLCByaWdodCB9ID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7DQogICAgY29uc3QgeyBpbm5lckhlaWdodCwgaW5uZXJXaWR0aCB9ID0gd2luZG93Ow0KICAgIHJldHVybiAodG9wID4gMCAmJiB0b3AgPCBpbm5lckhlaWdodCB8fCBib3R0b20gPiAwICYmIGJvdHRvbSA8IGlubmVySGVpZ2h0KSAmJiAobGVmdCA+IDAgJiYgbGVmdCA8IGlubmVyV2lkdGggfHwgcmlnaHQgPiAwICYmIHJpZ2h0IDwgaW5uZXJXaWR0aCk7DQogIH0NCiAgY29uc3QgaHlkcmF0ZU9uVmlzaWJsZSA9IChvcHRzKSA9PiAoaHlkcmF0ZSwgZm9yRWFjaCkgPT4gew0KICAgIGNvbnN0IG9iID0gbmV3IEludGVyc2VjdGlvbk9ic2VydmVyKChlbnRyaWVzKSA9PiB7DQogICAgICBmb3IgKGNvbnN0IGUgb2YgZW50cmllcykgew0KICAgICAgICBpZiAoIWUuaXNJbnRlcnNlY3RpbmcpIGNvbnRpbnVlOw0KICAgICAgICBvYi5kaXNjb25uZWN0KCk7DQogICAgICAgIGh5ZHJhdGUoKTsNCiAgICAgICAgYnJlYWs7DQogICAgICB9DQogICAgfSwgb3B0cyk7DQogICAgZm9yRWFjaCgoZWwpID0+IHsNCiAgICAgIGlmICghKGVsIGluc3RhbmNlb2YgRWxlbWVudCkpIHJldHVybjsNCiAgICAgIGlmIChlbGVtZW50SXNWaXNpYmxlSW5WaWV3cG9ydChlbCkpIHsNCiAgICAgICAgaHlkcmF0ZSgpOw0KICAgICAgICBvYi5kaXNjb25uZWN0KCk7DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgIH0NCiAgICAgIG9iLm9ic2VydmUoZWwpOw0KICAgIH0pOw0KICAgIHJldHVybiAoKSA9PiBvYi5kaXNjb25uZWN0KCk7DQogIH07DQogIGNvbnN0IGh5ZHJhdGVPbk1lZGlhUXVlcnkgPSAocXVlcnkpID0+IChoeWRyYXRlKSA9PiB7DQogICAgaWYgKHF1ZXJ5KSB7DQogICAgICBjb25zdCBtcWwgPSBtYXRjaE1lZGlhKHF1ZXJ5KTsNCiAgICAgIGlmIChtcWwubWF0Y2hlcykgew0KICAgICAgICBoeWRyYXRlKCk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBtcWwuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgaHlkcmF0ZSwgeyBvbmNlOiB0cnVlIH0pOw0KICAgICAgICByZXR1cm4gKCkgPT4gbXFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoImNoYW5nZSIsIGh5ZHJhdGUpOw0KICAgICAgfQ0KICAgIH0NCiAgfTsNCiAgY29uc3QgaHlkcmF0ZU9uSW50ZXJhY3Rpb24gPSAoaW50ZXJhY3Rpb25zID0gW10pID0+IChoeWRyYXRlLCBmb3JFYWNoKSA9PiB7DQogICAgaWYgKGlzU3RyaW5nKGludGVyYWN0aW9ucykpIGludGVyYWN0aW9ucyA9IFtpbnRlcmFjdGlvbnNdOw0KICAgIGxldCBoYXNIeWRyYXRlZCA9IGZhbHNlOw0KICAgIGNvbnN0IGRvSHlkcmF0ZSA9IChlKSA9PiB7DQogICAgICBpZiAoIWhhc0h5ZHJhdGVkKSB7DQogICAgICAgIGhhc0h5ZHJhdGVkID0gdHJ1ZTsNCiAgICAgICAgdGVhcmRvd24oKTsNCiAgICAgICAgaHlkcmF0ZSgpOw0KICAgICAgICBlLnRhcmdldC5kaXNwYXRjaEV2ZW50KG5ldyBlLmNvbnN0cnVjdG9yKGUudHlwZSwgZSkpOw0KICAgICAgfQ0KICAgIH07DQogICAgY29uc3QgdGVhcmRvd24gPSAoKSA9PiB7DQogICAgICBmb3JFYWNoKChlbCkgPT4gew0KICAgICAgICBmb3IgKGNvbnN0IGkgb2YgaW50ZXJhY3Rpb25zKSB7DQogICAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcihpLCBkb0h5ZHJhdGUpOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICB9Ow0KICAgIGZvckVhY2goKGVsKSA9PiB7DQogICAgICBmb3IgKGNvbnN0IGkgb2YgaW50ZXJhY3Rpb25zKSB7DQogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoaSwgZG9IeWRyYXRlLCB7IG9uY2U6IHRydWUgfSk7DQogICAgICB9DQogICAgfSk7DQogICAgcmV0dXJuIHRlYXJkb3duOw0KICB9Ow0KICBmdW5jdGlvbiBmb3JFYWNoRWxlbWVudChub2RlLCBjYikgew0KICAgIGlmIChpc0NvbW1lbnQobm9kZSkgJiYgbm9kZS5kYXRhID09PSAiWyIpIHsNCiAgICAgIGxldCBkZXB0aCA9IDE7DQogICAgICBsZXQgbmV4dCA9IG5vZGUubmV4dFNpYmxpbmc7DQogICAgICB3aGlsZSAobmV4dCkgew0KICAgICAgICBpZiAobmV4dC5ub2RlVHlwZSA9PT0gMSkgew0KICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNiKG5leHQpOw0KICAgICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSB7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSBpZiAoaXNDb21tZW50KG5leHQpKSB7DQogICAgICAgICAgaWYgKG5leHQuZGF0YSA9PT0gIl0iKSB7DQogICAgICAgICAgICBpZiAoLS1kZXB0aCA9PT0gMCkgYnJlYWs7DQogICAgICAgICAgfSBlbHNlIGlmIChuZXh0LmRhdGEgPT09ICJbIikgew0KICAgICAgICAgICAgZGVwdGgrKzsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgbmV4dCA9IG5leHQubmV4dFNpYmxpbmc7DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIGNiKG5vZGUpOw0KICAgIH0NCiAgfQ0KDQogIGNvbnN0IGlzQXN5bmNXcmFwcGVyID0gKGkpID0+ICEhaS50eXBlLl9fYXN5bmNMb2FkZXI7DQogIC8qISAjX19OT19TSURFX0VGRkVDVFNfXyAqLw0KICAvLyBAX19OT19TSURFX0VGRkVDVFNfXw0KICBmdW5jdGlvbiBkZWZpbmVBc3luY0NvbXBvbmVudChzb3VyY2UpIHsNCiAgICBpZiAoaXNGdW5jdGlvbihzb3VyY2UpKSB7DQogICAgICBzb3VyY2UgPSB7IGxvYWRlcjogc291cmNlIH07DQogICAgfQ0KICAgIGNvbnN0IHsNCiAgICAgIGxvYWRlciwNCiAgICAgIGxvYWRpbmdDb21wb25lbnQsDQogICAgICBlcnJvckNvbXBvbmVudCwNCiAgICAgIGRlbGF5ID0gMjAwLA0KICAgICAgaHlkcmF0ZTogaHlkcmF0ZVN0cmF0ZWd5LA0KICAgICAgdGltZW91dCwNCiAgICAgIC8vIHVuZGVmaW5lZCA9IG5ldmVyIHRpbWVzIG91dA0KICAgICAgc3VzcGVuc2libGUgPSB0cnVlLA0KICAgICAgb25FcnJvcjogdXNlck9uRXJyb3INCiAgICB9ID0gc291cmNlOw0KICAgIGxldCBwZW5kaW5nUmVxdWVzdCA9IG51bGw7DQogICAgbGV0IHJlc29sdmVkQ29tcDsNCiAgICBsZXQgcmV0cmllcyA9IDA7DQogICAgY29uc3QgcmV0cnkgPSAoKSA9PiB7DQogICAgICByZXRyaWVzKys7DQogICAgICBwZW5kaW5nUmVxdWVzdCA9IG51bGw7DQogICAgICByZXR1cm4gbG9hZCgpOw0KICAgIH07DQogICAgY29uc3QgbG9hZCA9ICgpID0+IHsNCiAgICAgIGxldCB0aGlzUmVxdWVzdDsNCiAgICAgIHJldHVybiBwZW5kaW5nUmVxdWVzdCB8fCAodGhpc1JlcXVlc3QgPSBwZW5kaW5nUmVxdWVzdCA9IGxvYWRlcigpLmNhdGNoKChlcnIpID0+IHsNCiAgICAgICAgZXJyID0gZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIgOiBuZXcgRXJyb3IoU3RyaW5nKGVycikpOw0KICAgICAgICBpZiAodXNlck9uRXJyb3IpIHsNCiAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gew0KICAgICAgICAgICAgY29uc3QgdXNlclJldHJ5ID0gKCkgPT4gcmVzb2x2ZShyZXRyeSgpKTsNCiAgICAgICAgICAgIGNvbnN0IHVzZXJGYWlsID0gKCkgPT4gcmVqZWN0KGVycik7DQogICAgICAgICAgICB1c2VyT25FcnJvcihlcnIsIHVzZXJSZXRyeSwgdXNlckZhaWwsIHJldHJpZXMgKyAxKTsNCiAgICAgICAgICB9KTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICB0aHJvdyBlcnI7DQogICAgICAgIH0NCiAgICAgIH0pLnRoZW4oKGNvbXApID0+IHsNCiAgICAgICAgaWYgKHRoaXNSZXF1ZXN0ICE9PSBwZW5kaW5nUmVxdWVzdCAmJiBwZW5kaW5nUmVxdWVzdCkgew0KICAgICAgICAgIHJldHVybiBwZW5kaW5nUmVxdWVzdDsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIWNvbXApIHsNCiAgICAgICAgICB3YXJuJDEoDQogICAgICAgICAgICBgQXN5bmMgY29tcG9uZW50IGxvYWRlciByZXNvbHZlZCB0byB1bmRlZmluZWQuIElmIHlvdSBhcmUgdXNpbmcgcmV0cnkoKSwgbWFrZSBzdXJlIHRvIHJldHVybiBpdHMgcmV0dXJuIHZhbHVlLmANCiAgICAgICAgICApOw0KICAgICAgICB9DQogICAgICAgIGlmIChjb21wICYmIChjb21wLl9fZXNNb2R1bGUgfHwgY29tcFtTeW1ib2wudG9TdHJpbmdUYWddID09PSAiTW9kdWxlIikpIHsNCiAgICAgICAgICBjb21wID0gY29tcC5kZWZhdWx0Ow0KICAgICAgICB9DQogICAgICAgIGlmIChjb21wICYmICFpc09iamVjdChjb21wKSAmJiAhaXNGdW5jdGlvbihjb21wKSkgew0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBhc3luYyBjb21wb25lbnQgbG9hZCByZXN1bHQ6ICR7Y29tcH1gKTsNCiAgICAgICAgfQ0KICAgICAgICByZXNvbHZlZENvbXAgPSBjb21wOw0KICAgICAgICByZXR1cm4gY29tcDsNCiAgICAgIH0pKTsNCiAgICB9Ow0KICAgIHJldHVybiBkZWZpbmVDb21wb25lbnQoew0KICAgICAgbmFtZTogIkFzeW5jQ29tcG9uZW50V3JhcHBlciIsDQogICAgICBfX2FzeW5jTG9hZGVyOiBsb2FkLA0KICAgICAgX19hc3luY0h5ZHJhdGUoZWwsIGluc3RhbmNlLCBoeWRyYXRlKSB7DQogICAgICAgIGxldCBwYXRjaGVkID0gZmFsc2U7DQogICAgICAgIGNvbnN0IGRvSHlkcmF0ZSA9IGh5ZHJhdGVTdHJhdGVneSA/ICgpID0+IHsNCiAgICAgICAgICBjb25zdCBwZXJmb3JtSHlkcmF0ZSA9ICgpID0+IHsNCiAgICAgICAgICAgIGlmIChwYXRjaGVkKSB7DQogICAgICAgICAgICAgIHdhcm4kMSgNCiAgICAgICAgICAgICAgICBgU2tpcHBpbmcgbGF6eSBoeWRyYXRpb24gZm9yIGNvbXBvbmVudCAnJHtnZXRDb21wb25lbnROYW1lKHJlc29sdmVkQ29tcCl9JzogaXQgd2FzIHVwZGF0ZWQgYmVmb3JlIGxhenkgaHlkcmF0aW9uIHBlcmZvcm1lZC5gDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGh5ZHJhdGUoKTsNCiAgICAgICAgICB9Ow0KICAgICAgICAgIGNvbnN0IHRlYXJkb3duID0gaHlkcmF0ZVN0cmF0ZWd5KA0KICAgICAgICAgICAgcGVyZm9ybUh5ZHJhdGUsDQogICAgICAgICAgICAoY2IpID0+IGZvckVhY2hFbGVtZW50KGVsLCBjYikNCiAgICAgICAgICApOw0KICAgICAgICAgIGlmICh0ZWFyZG93bikgew0KICAgICAgICAgICAgKGluc3RhbmNlLmJ1bSB8fCAoaW5zdGFuY2UuYnVtID0gW10pKS5wdXNoKHRlYXJkb3duKTsNCiAgICAgICAgICB9DQogICAgICAgICAgKGluc3RhbmNlLnUgfHwgKGluc3RhbmNlLnUgPSBbXSkpLnB1c2goKCkgPT4gcGF0Y2hlZCA9IHRydWUpOw0KICAgICAgICB9IDogaHlkcmF0ZTsNCiAgICAgICAgaWYgKHJlc29sdmVkQ29tcCkgew0KICAgICAgICAgIGRvSHlkcmF0ZSgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGxvYWQoKS50aGVuKCgpID0+ICFpbnN0YW5jZS5pc1VubW91bnRlZCAmJiBkb0h5ZHJhdGUoKSk7DQogICAgICAgIH0NCiAgICAgIH0sDQogICAgICBnZXQgX19hc3luY1Jlc29sdmVkKCkgew0KICAgICAgICByZXR1cm4gcmVzb2x2ZWRDb21wOw0KICAgICAgfSwNCiAgICAgIHNldHVwKCkgew0KICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGN1cnJlbnRJbnN0YW5jZTsNCiAgICAgICAgbWFya0FzeW5jQm91bmRhcnkoaW5zdGFuY2UpOw0KICAgICAgICBpZiAocmVzb2x2ZWRDb21wKSB7DQogICAgICAgICAgcmV0dXJuICgpID0+IGNyZWF0ZUlubmVyQ29tcChyZXNvbHZlZENvbXAsIGluc3RhbmNlKTsNCiAgICAgICAgfQ0KICAgICAgICBjb25zdCBvbkVycm9yID0gKGVycikgPT4gew0KICAgICAgICAgIHBlbmRpbmdSZXF1ZXN0ID0gbnVsbDsNCiAgICAgICAgICBoYW5kbGVFcnJvcigNCiAgICAgICAgICAgIGVyciwNCiAgICAgICAgICAgIGluc3RhbmNlLA0KICAgICAgICAgICAgMTMsDQogICAgICAgICAgICAhZXJyb3JDb21wb25lbnQNCiAgICAgICAgICApOw0KICAgICAgICB9Ow0KICAgICAgICBpZiAoc3VzcGVuc2libGUgJiYgaW5zdGFuY2Uuc3VzcGVuc2UgfHwgZmFsc2UpIHsNCiAgICAgICAgICByZXR1cm4gbG9hZCgpLnRoZW4oKGNvbXApID0+IHsNCiAgICAgICAgICAgIHJldHVybiAoKSA9PiBjcmVhdGVJbm5lckNvbXAoY29tcCwgaW5zdGFuY2UpOw0KICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHsNCiAgICAgICAgICAgIG9uRXJyb3IoZXJyKTsNCiAgICAgICAgICAgIHJldHVybiAoKSA9PiBlcnJvckNvbXBvbmVudCA/IGNyZWF0ZVZOb2RlKGVycm9yQ29tcG9uZW50LCB7DQogICAgICAgICAgICAgIGVycm9yOiBlcnINCiAgICAgICAgICAgIH0pIDogbnVsbDsNCiAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgICAgICBjb25zdCBsb2FkZWQgPSByZWYoZmFsc2UpOw0KICAgICAgICBjb25zdCBlcnJvciA9IHJlZigpOw0KICAgICAgICBjb25zdCBkZWxheWVkID0gcmVmKCEhZGVsYXkpOw0KICAgICAgICBpZiAoZGVsYXkpIHsNCiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsNCiAgICAgICAgICAgIGRlbGF5ZWQudmFsdWUgPSBmYWxzZTsNCiAgICAgICAgICB9LCBkZWxheSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHRpbWVvdXQgIT0gbnVsbCkgew0KICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gew0KICAgICAgICAgICAgaWYgKCFsb2FkZWQudmFsdWUgJiYgIWVycm9yLnZhbHVlKSB7DQogICAgICAgICAgICAgIGNvbnN0IGVyciA9IG5ldyBFcnJvcigNCiAgICAgICAgICAgICAgICBgQXN5bmMgY29tcG9uZW50IHRpbWVkIG91dCBhZnRlciAke3RpbWVvdXR9bXMuYA0KICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgICBvbkVycm9yKGVycik7DQogICAgICAgICAgICAgIGVycm9yLnZhbHVlID0gZXJyOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0sIHRpbWVvdXQpOw0KICAgICAgICB9DQogICAgICAgIGxvYWQoKS50aGVuKCgpID0+IHsNCiAgICAgICAgICBsb2FkZWQudmFsdWUgPSB0cnVlOw0KICAgICAgICAgIGlmIChpbnN0YW5jZS5wYXJlbnQgJiYgaXNLZWVwQWxpdmUoaW5zdGFuY2UucGFyZW50LnZub2RlKSkgew0KICAgICAgICAgICAgaW5zdGFuY2UucGFyZW50LnVwZGF0ZSgpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4gew0KICAgICAgICAgIG9uRXJyb3IoZXJyKTsNCiAgICAgICAgICBlcnJvci52YWx1ZSA9IGVycjsNCiAgICAgICAgfSk7DQogICAgICAgIHJldHVybiAoKSA9PiB7DQogICAgICAgICAgaWYgKGxvYWRlZC52YWx1ZSAmJiByZXNvbHZlZENvbXApIHsNCiAgICAgICAgICAgIHJldHVybiBjcmVhdGVJbm5lckNvbXAocmVzb2x2ZWRDb21wLCBpbnN0YW5jZSk7DQogICAgICAgICAgfSBlbHNlIGlmIChlcnJvci52YWx1ZSAmJiBlcnJvckNvbXBvbmVudCkgew0KICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZVZOb2RlKGVycm9yQ29tcG9uZW50LCB7DQogICAgICAgICAgICAgIGVycm9yOiBlcnJvci52YWx1ZQ0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgfSBlbHNlIGlmIChsb2FkaW5nQ29tcG9uZW50ICYmICFkZWxheWVkLnZhbHVlKSB7DQogICAgICAgICAgICByZXR1cm4gY3JlYXRlVk5vZGUobG9hZGluZ0NvbXBvbmVudCk7DQogICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgfQ0KICAgIH0pOw0KICB9DQogIGZ1bmN0aW9uIGNyZWF0ZUlubmVyQ29tcChjb21wLCBwYXJlbnQpIHsNCiAgICBjb25zdCB7IHJlZjogcmVmMiwgcHJvcHMsIGNoaWxkcmVuLCBjZSB9ID0gcGFyZW50LnZub2RlOw0KICAgIGNvbnN0IHZub2RlID0gY3JlYXRlVk5vZGUoY29tcCwgcHJvcHMsIGNoaWxkcmVuKTsNCiAgICB2bm9kZS5yZWYgPSByZWYyOw0KICAgIHZub2RlLmNlID0gY2U7DQogICAgZGVsZXRlIHBhcmVudC52bm9kZS5jZTsNCiAgICByZXR1cm4gdm5vZGU7DQogIH0NCg0KICBjb25zdCBpc0tlZXBBbGl2ZSA9ICh2bm9kZSkgPT4gdm5vZGUudHlwZS5fX2lzS2VlcEFsaXZlOw0KICBjb25zdCBLZWVwQWxpdmVJbXBsID0gew0KICAgIG5hbWU6IGBLZWVwQWxpdmVgLA0KICAgIC8vIE1hcmtlciBmb3Igc3BlY2lhbCBoYW5kbGluZyBpbnNpZGUgdGhlIHJlbmRlcmVyLiBXZSBhcmUgbm90IHVzaW5nIGEgPT09DQogICAgLy8gY2hlY2sgZGlyZWN0bHkgb24gS2VlcEFsaXZlIGluIHRoZSByZW5kZXJlciwgYmVjYXVzZSBpbXBvcnRpbmcgaXQgZGlyZWN0bHkNCiAgICAvLyB3b3VsZCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgdHJlZS1zaGFrZW4uDQogICAgX19pc0tlZXBBbGl2ZTogdHJ1ZSwNCiAgICBwcm9wczogew0KICAgICAgaW5jbHVkZTogW1N0cmluZywgUmVnRXhwLCBBcnJheV0sDQogICAgICBleGNsdWRlOiBbU3RyaW5nLCBSZWdFeHAsIEFycmF5XSwNCiAgICAgIG1heDogW1N0cmluZywgTnVtYmVyXQ0KICAgIH0sDQogICAgc2V0dXAocHJvcHMsIHsgc2xvdHMgfSkgew0KICAgICAgY29uc3QgaW5zdGFuY2UgPSBnZXRDdXJyZW50SW5zdGFuY2UoKTsNCiAgICAgIGNvbnN0IHNoYXJlZENvbnRleHQgPSBpbnN0YW5jZS5jdHg7DQogICAgICBjb25zdCBjYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7DQogICAgICBjb25zdCBrZXlzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsNCiAgICAgIGxldCBjdXJyZW50ID0gbnVsbDsNCiAgICAgIHsNCiAgICAgICAgaW5zdGFuY2UuX192X2NhY2hlID0gY2FjaGU7DQogICAgICB9DQogICAgICBjb25zdCBwYXJlbnRTdXNwZW5zZSA9IGluc3RhbmNlLnN1c3BlbnNlOw0KICAgICAgY29uc3Qgew0KICAgICAgICByZW5kZXJlcjogew0KICAgICAgICAgIHA6IHBhdGNoLA0KICAgICAgICAgIG06IG1vdmUsDQogICAgICAgICAgdW06IF91bm1vdW50LA0KICAgICAgICAgIG86IHsgY3JlYXRlRWxlbWVudCB9DQogICAgICAgIH0NCiAgICAgIH0gPSBzaGFyZWRDb250ZXh0Ow0KICAgICAgY29uc3Qgc3RvcmFnZUNvbnRhaW5lciA9IGNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgICAgc2hhcmVkQ29udGV4dC5hY3RpdmF0ZSA9ICh2bm9kZSwgY29udGFpbmVyLCBhbmNob3IsIG5hbWVzcGFjZSwgb3B0aW1pemVkKSA9PiB7DQogICAgICAgIGNvbnN0IGluc3RhbmNlMiA9IHZub2RlLmNvbXBvbmVudDsNCiAgICAgICAgbW92ZSh2bm9kZSwgY29udGFpbmVyLCBhbmNob3IsIDAsIHBhcmVudFN1c3BlbnNlKTsNCiAgICAgICAgcGF0Y2goDQogICAgICAgICAgaW5zdGFuY2UyLnZub2RlLA0KICAgICAgICAgIHZub2RlLA0KICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICBhbmNob3IsDQogICAgICAgICAgaW5zdGFuY2UyLA0KICAgICAgICAgIHBhcmVudFN1c3BlbnNlLA0KICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICB2bm9kZS5zbG90U2NvcGVJZHMsDQogICAgICAgICAgb3B0aW1pemVkDQogICAgICAgICk7DQogICAgICAgIHF1ZXVlUG9zdFJlbmRlckVmZmVjdCgoKSA9PiB7DQogICAgICAgICAgaW5zdGFuY2UyLmlzRGVhY3RpdmF0ZWQgPSBmYWxzZTsNCiAgICAgICAgICBpZiAoaW5zdGFuY2UyLmEpIHsNCiAgICAgICAgICAgIGludm9rZUFycmF5Rm5zKGluc3RhbmNlMi5hKTsNCiAgICAgICAgICB9DQogICAgICAgICAgY29uc3Qgdm5vZGVIb29rID0gdm5vZGUucHJvcHMgJiYgdm5vZGUucHJvcHMub25Wbm9kZU1vdW50ZWQ7DQogICAgICAgICAgaWYgKHZub2RlSG9vaykgew0KICAgICAgICAgICAgaW52b2tlVk5vZGVIb29rKHZub2RlSG9vaywgaW5zdGFuY2UyLnBhcmVudCwgdm5vZGUpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSwgcGFyZW50U3VzcGVuc2UpOw0KICAgICAgICB7DQogICAgICAgICAgZGV2dG9vbHNDb21wb25lbnRBZGRlZChpbnN0YW5jZTIpOw0KICAgICAgICB9DQogICAgICB9Ow0KICAgICAgc2hhcmVkQ29udGV4dC5kZWFjdGl2YXRlID0gKHZub2RlKSA9PiB7DQogICAgICAgIGNvbnN0IGluc3RhbmNlMiA9IHZub2RlLmNvbXBvbmVudDsNCiAgICAgICAgaW52YWxpZGF0ZU1vdW50KGluc3RhbmNlMi5tKTsNCiAgICAgICAgaW52YWxpZGF0ZU1vdW50KGluc3RhbmNlMi5hKTsNCiAgICAgICAgbW92ZSh2bm9kZSwgc3RvcmFnZUNvbnRhaW5lciwgbnVsbCwgMSwgcGFyZW50U3VzcGVuc2UpOw0KICAgICAgICBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QoKCkgPT4gew0KICAgICAgICAgIGlmIChpbnN0YW5jZTIuZGEpIHsNCiAgICAgICAgICAgIGludm9rZUFycmF5Rm5zKGluc3RhbmNlMi5kYSk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNvbnN0IHZub2RlSG9vayA9IHZub2RlLnByb3BzICYmIHZub2RlLnByb3BzLm9uVm5vZGVVbm1vdW50ZWQ7DQogICAgICAgICAgaWYgKHZub2RlSG9vaykgew0KICAgICAgICAgICAgaW52b2tlVk5vZGVIb29rKHZub2RlSG9vaywgaW5zdGFuY2UyLnBhcmVudCwgdm5vZGUpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpbnN0YW5jZTIuaXNEZWFjdGl2YXRlZCA9IHRydWU7DQogICAgICAgIH0sIHBhcmVudFN1c3BlbnNlKTsNCiAgICAgICAgew0KICAgICAgICAgIGRldnRvb2xzQ29tcG9uZW50QWRkZWQoaW5zdGFuY2UyKTsNCiAgICAgICAgfQ0KICAgICAgICB7DQogICAgICAgICAgaW5zdGFuY2UyLl9fa2VlcEFsaXZlU3RvcmFnZUNvbnRhaW5lciA9IHN0b3JhZ2VDb250YWluZXI7DQogICAgICAgIH0NCiAgICAgIH07DQogICAgICBmdW5jdGlvbiB1bm1vdW50KHZub2RlKSB7DQogICAgICAgIHJlc2V0U2hhcGVGbGFnKHZub2RlKTsNCiAgICAgICAgX3VubW91bnQodm5vZGUsIGluc3RhbmNlLCBwYXJlbnRTdXNwZW5zZSwgdHJ1ZSk7DQogICAgICB9DQogICAgICBmdW5jdGlvbiBwcnVuZUNhY2hlKGZpbHRlcikgew0KICAgICAgICBjYWNoZS5mb3JFYWNoKCh2bm9kZSwga2V5KSA9PiB7DQogICAgICAgICAgY29uc3QgbmFtZSA9IGdldENvbXBvbmVudE5hbWUodm5vZGUudHlwZSk7DQogICAgICAgICAgaWYgKG5hbWUgJiYgIWZpbHRlcihuYW1lKSkgew0KICAgICAgICAgICAgcHJ1bmVDYWNoZUVudHJ5KGtleSk7DQogICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgIH0NCiAgICAgIGZ1bmN0aW9uIHBydW5lQ2FjaGVFbnRyeShrZXkpIHsNCiAgICAgICAgY29uc3QgY2FjaGVkID0gY2FjaGUuZ2V0KGtleSk7DQogICAgICAgIGlmIChjYWNoZWQgJiYgKCFjdXJyZW50IHx8ICFpc1NhbWVWTm9kZVR5cGUoY2FjaGVkLCBjdXJyZW50KSkpIHsNCiAgICAgICAgICB1bm1vdW50KGNhY2hlZCk7DQogICAgICAgIH0gZWxzZSBpZiAoY3VycmVudCkgew0KICAgICAgICAgIHJlc2V0U2hhcGVGbGFnKGN1cnJlbnQpOw0KICAgICAgICB9DQogICAgICAgIGNhY2hlLmRlbGV0ZShrZXkpOw0KICAgICAgICBrZXlzLmRlbGV0ZShrZXkpOw0KICAgICAgfQ0KICAgICAgd2F0Y2goDQogICAgICAgICgpID0+IFtwcm9wcy5pbmNsdWRlLCBwcm9wcy5leGNsdWRlXSwNCiAgICAgICAgKFtpbmNsdWRlLCBleGNsdWRlXSkgPT4gew0KICAgICAgICAgIGluY2x1ZGUgJiYgcHJ1bmVDYWNoZSgobmFtZSkgPT4gbWF0Y2hlcyhpbmNsdWRlLCBuYW1lKSk7DQogICAgICAgICAgZXhjbHVkZSAmJiBwcnVuZUNhY2hlKChuYW1lKSA9PiAhbWF0Y2hlcyhleGNsdWRlLCBuYW1lKSk7DQogICAgICAgIH0sDQogICAgICAgIC8vIHBydW5lIHBvc3QtcmVuZGVyIGFmdGVyIGBjdXJyZW50YCBoYXMgYmVlbiB1cGRhdGVkDQogICAgICAgIHsgZmx1c2g6ICJwb3N0IiwgZGVlcDogdHJ1ZSB9DQogICAgICApOw0KICAgICAgbGV0IHBlbmRpbmdDYWNoZUtleSA9IG51bGw7DQogICAgICBjb25zdCBjYWNoZVN1YnRyZWUgPSAoKSA9PiB7DQogICAgICAgIGlmIChwZW5kaW5nQ2FjaGVLZXkgIT0gbnVsbCkgew0KICAgICAgICAgIGlmIChpc1N1c3BlbnNlKGluc3RhbmNlLnN1YlRyZWUudHlwZSkpIHsNCiAgICAgICAgICAgIHF1ZXVlUG9zdFJlbmRlckVmZmVjdCgoKSA9PiB7DQogICAgICAgICAgICAgIGNhY2hlLnNldChwZW5kaW5nQ2FjaGVLZXksIGdldElubmVyQ2hpbGQoaW5zdGFuY2Uuc3ViVHJlZSkpOw0KICAgICAgICAgICAgfSwgaW5zdGFuY2Uuc3ViVHJlZS5zdXNwZW5zZSk7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGNhY2hlLnNldChwZW5kaW5nQ2FjaGVLZXksIGdldElubmVyQ2hpbGQoaW5zdGFuY2Uuc3ViVHJlZSkpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfTsNCiAgICAgIG9uTW91bnRlZChjYWNoZVN1YnRyZWUpOw0KICAgICAgb25VcGRhdGVkKGNhY2hlU3VidHJlZSk7DQogICAgICBvbkJlZm9yZVVubW91bnQoKCkgPT4gew0KICAgICAgICBjYWNoZS5mb3JFYWNoKChjYWNoZWQpID0+IHsNCiAgICAgICAgICBjb25zdCB7IHN1YlRyZWUsIHN1c3BlbnNlIH0gPSBpbnN0YW5jZTsNCiAgICAgICAgICBjb25zdCB2bm9kZSA9IGdldElubmVyQ2hpbGQoc3ViVHJlZSk7DQogICAgICAgICAgaWYgKGNhY2hlZC50eXBlID09PSB2bm9kZS50eXBlICYmIGNhY2hlZC5rZXkgPT09IHZub2RlLmtleSkgew0KICAgICAgICAgICAgcmVzZXRTaGFwZUZsYWcodm5vZGUpOw0KICAgICAgICAgICAgY29uc3QgZGEgPSB2bm9kZS5jb21wb25lbnQuZGE7DQogICAgICAgICAgICBkYSAmJiBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QoZGEsIHN1c3BlbnNlKTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICB9DQogICAgICAgICAgdW5tb3VudChjYWNoZWQpOw0KICAgICAgICB9KTsNCiAgICAgIH0pOw0KICAgICAgcmV0dXJuICgpID0+IHsNCiAgICAgICAgcGVuZGluZ0NhY2hlS2V5ID0gbnVsbDsNCiAgICAgICAgaWYgKCFzbG90cy5kZWZhdWx0KSB7DQogICAgICAgICAgcmV0dXJuIGN1cnJlbnQgPSBudWxsOw0KICAgICAgICB9DQogICAgICAgIGNvbnN0IGNoaWxkcmVuID0gc2xvdHMuZGVmYXVsdCgpOw0KICAgICAgICBjb25zdCByYXdWTm9kZSA9IGNoaWxkcmVuWzBdOw0KICAgICAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoID4gMSkgew0KICAgICAgICAgIHsNCiAgICAgICAgICAgIHdhcm4kMShgS2VlcEFsaXZlIHNob3VsZCBjb250YWluIGV4YWN0bHkgb25lIGNvbXBvbmVudCBjaGlsZC5gKTsNCiAgICAgICAgICB9DQogICAgICAgICAgY3VycmVudCA9IG51bGw7DQogICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOw0KICAgICAgICB9IGVsc2UgaWYgKCFpc1ZOb2RlKHJhd1ZOb2RlKSB8fCAhKHJhd1ZOb2RlLnNoYXBlRmxhZyAmIDQpICYmICEocmF3Vk5vZGUuc2hhcGVGbGFnICYgMTI4KSkgew0KICAgICAgICAgIGN1cnJlbnQgPSBudWxsOw0KICAgICAgICAgIHJldHVybiByYXdWTm9kZTsNCiAgICAgICAgfQ0KICAgICAgICBsZXQgdm5vZGUgPSBnZXRJbm5lckNoaWxkKHJhd1ZOb2RlKTsNCiAgICAgICAgaWYgKHZub2RlLnR5cGUgPT09IENvbW1lbnQpIHsNCiAgICAgICAgICBjdXJyZW50ID0gbnVsbDsNCiAgICAgICAgICByZXR1cm4gdm5vZGU7DQogICAgICAgIH0NCiAgICAgICAgY29uc3QgY29tcCA9IHZub2RlLnR5cGU7DQogICAgICAgIGNvbnN0IG5hbWUgPSBnZXRDb21wb25lbnROYW1lKA0KICAgICAgICAgIGlzQXN5bmNXcmFwcGVyKHZub2RlKSA/IHZub2RlLnR5cGUuX19hc3luY1Jlc29sdmVkIHx8IHt9IDogY29tcA0KICAgICAgICApOw0KICAgICAgICBjb25zdCB7IGluY2x1ZGUsIGV4Y2x1ZGUsIG1heCB9ID0gcHJvcHM7DQogICAgICAgIGlmIChpbmNsdWRlICYmICghbmFtZSB8fCAhbWF0Y2hlcyhpbmNsdWRlLCBuYW1lKSkgfHwgZXhjbHVkZSAmJiBuYW1lICYmIG1hdGNoZXMoZXhjbHVkZSwgbmFtZSkpIHsNCiAgICAgICAgICB2bm9kZS5zaGFwZUZsYWcgJj0gLTI1NzsNCiAgICAgICAgICBjdXJyZW50ID0gdm5vZGU7DQogICAgICAgICAgcmV0dXJuIHJhd1ZOb2RlOw0KICAgICAgICB9DQogICAgICAgIGNvbnN0IGtleSA9IHZub2RlLmtleSA9PSBudWxsID8gY29tcCA6IHZub2RlLmtleTsNCiAgICAgICAgY29uc3QgY2FjaGVkVk5vZGUgPSBjYWNoZS5nZXQoa2V5KTsNCiAgICAgICAgaWYgKHZub2RlLmVsKSB7DQogICAgICAgICAgdm5vZGUgPSBjbG9uZVZOb2RlKHZub2RlKTsNCiAgICAgICAgICBpZiAocmF3Vk5vZGUuc2hhcGVGbGFnICYgMTI4KSB7DQogICAgICAgICAgICByYXdWTm9kZS5zc0NvbnRlbnQgPSB2bm9kZTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcGVuZGluZ0NhY2hlS2V5ID0ga2V5Ow0KICAgICAgICBpZiAoY2FjaGVkVk5vZGUpIHsNCiAgICAgICAgICB2bm9kZS5lbCA9IGNhY2hlZFZOb2RlLmVsOw0KICAgICAgICAgIHZub2RlLmNvbXBvbmVudCA9IGNhY2hlZFZOb2RlLmNvbXBvbmVudDsNCiAgICAgICAgICBpZiAodm5vZGUudHJhbnNpdGlvbikgew0KICAgICAgICAgICAgc2V0VHJhbnNpdGlvbkhvb2tzKHZub2RlLCB2bm9kZS50cmFuc2l0aW9uKTsNCiAgICAgICAgICB9DQogICAgICAgICAgdm5vZGUuc2hhcGVGbGFnIHw9IDUxMjsNCiAgICAgICAgICBrZXlzLmRlbGV0ZShrZXkpOw0KICAgICAgICAgIGtleXMuYWRkKGtleSk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAga2V5cy5hZGQoa2V5KTsNCiAgICAgICAgICBpZiAobWF4ICYmIGtleXMuc2l6ZSA+IHBhcnNlSW50KG1heCwgMTApKSB7DQogICAgICAgICAgICBwcnVuZUNhY2hlRW50cnkoa2V5cy52YWx1ZXMoKS5uZXh0KCkudmFsdWUpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICB2bm9kZS5zaGFwZUZsYWcgfD0gMjU2Ow0KICAgICAgICBjdXJyZW50ID0gdm5vZGU7DQogICAgICAgIHJldHVybiBpc1N1c3BlbnNlKHJhd1ZOb2RlLnR5cGUpID8gcmF3Vk5vZGUgOiB2bm9kZTsNCiAgICAgIH07DQogICAgfQ0KICB9Ow0KICBjb25zdCBLZWVwQWxpdmUgPSBLZWVwQWxpdmVJbXBsOw0KICBmdW5jdGlvbiBtYXRjaGVzKHBhdHRlcm4sIG5hbWUpIHsNCiAgICBpZiAoaXNBcnJheShwYXR0ZXJuKSkgew0KICAgICAgcmV0dXJuIHBhdHRlcm4uc29tZSgocCkgPT4gbWF0Y2hlcyhwLCBuYW1lKSk7DQogICAgfSBlbHNlIGlmIChpc1N0cmluZyhwYXR0ZXJuKSkgew0KICAgICAgcmV0dXJuIHBhdHRlcm4uc3BsaXQoIiwiKS5pbmNsdWRlcyhuYW1lKTsNCiAgICB9IGVsc2UgaWYgKGlzUmVnRXhwKHBhdHRlcm4pKSB7DQogICAgICBwYXR0ZXJuLmxhc3RJbmRleCA9IDA7DQogICAgICByZXR1cm4gcGF0dGVybi50ZXN0KG5hbWUpOw0KICAgIH0NCiAgICByZXR1cm4gZmFsc2U7DQogIH0NCiAgZnVuY3Rpb24gb25BY3RpdmF0ZWQoaG9vaywgdGFyZ2V0KSB7DQogICAgcmVnaXN0ZXJLZWVwQWxpdmVIb29rKGhvb2ssICJhIiwgdGFyZ2V0KTsNCiAgfQ0KICBmdW5jdGlvbiBvbkRlYWN0aXZhdGVkKGhvb2ssIHRhcmdldCkgew0KICAgIHJlZ2lzdGVyS2VlcEFsaXZlSG9vayhob29rLCAiZGEiLCB0YXJnZXQpOw0KICB9DQogIGZ1bmN0aW9uIHJlZ2lzdGVyS2VlcEFsaXZlSG9vayhob29rLCB0eXBlLCB0YXJnZXQgPSBjdXJyZW50SW5zdGFuY2UpIHsNCiAgICBjb25zdCB3cmFwcGVkSG9vayA9IGhvb2suX193ZGMgfHwgKGhvb2suX193ZGMgPSAoKSA9PiB7DQogICAgICBsZXQgY3VycmVudCA9IHRhcmdldDsNCiAgICAgIHdoaWxlIChjdXJyZW50KSB7DQogICAgICAgIGlmIChjdXJyZW50LmlzRGVhY3RpdmF0ZWQpIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucGFyZW50Ow0KICAgICAgfQ0KICAgICAgcmV0dXJuIGhvb2soKTsNCiAgICB9KTsNCiAgICBpbmplY3RIb29rKHR5cGUsIHdyYXBwZWRIb29rLCB0YXJnZXQpOw0KICAgIGlmICh0YXJnZXQpIHsNCiAgICAgIGxldCBjdXJyZW50ID0gdGFyZ2V0LnBhcmVudDsNCiAgICAgIHdoaWxlIChjdXJyZW50ICYmIGN1cnJlbnQucGFyZW50KSB7DQogICAgICAgIGlmIChpc0tlZXBBbGl2ZShjdXJyZW50LnBhcmVudC52bm9kZSkpIHsNCiAgICAgICAgICBpbmplY3RUb0tlZXBBbGl2ZVJvb3Qod3JhcHBlZEhvb2ssIHR5cGUsIHRhcmdldCwgY3VycmVudCk7DQogICAgICAgIH0NCiAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucGFyZW50Ow0KICAgICAgfQ0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBpbmplY3RUb0tlZXBBbGl2ZVJvb3QoaG9vaywgdHlwZSwgdGFyZ2V0LCBrZWVwQWxpdmVSb290KSB7DQogICAgY29uc3QgaW5qZWN0ZWQgPSBpbmplY3RIb29rKA0KICAgICAgdHlwZSwNCiAgICAgIGhvb2ssDQogICAgICBrZWVwQWxpdmVSb290LA0KICAgICAgdHJ1ZQ0KICAgICAgLyogcHJlcGVuZCAqLw0KICAgICk7DQogICAgb25Vbm1vdW50ZWQoKCkgPT4gew0KICAgICAgcmVtb3ZlKGtlZXBBbGl2ZVJvb3RbdHlwZV0sIGluamVjdGVkKTsNCiAgICB9LCB0YXJnZXQpOw0KICB9DQogIGZ1bmN0aW9uIHJlc2V0U2hhcGVGbGFnKHZub2RlKSB7DQogICAgdm5vZGUuc2hhcGVGbGFnICY9IC0yNTc7DQogICAgdm5vZGUuc2hhcGVGbGFnICY9IC01MTM7DQogIH0NCiAgZnVuY3Rpb24gZ2V0SW5uZXJDaGlsZCh2bm9kZSkgew0KICAgIHJldHVybiB2bm9kZS5zaGFwZUZsYWcgJiAxMjggPyB2bm9kZS5zc0NvbnRlbnQgOiB2bm9kZTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGluamVjdEhvb2sodHlwZSwgaG9vaywgdGFyZ2V0ID0gY3VycmVudEluc3RhbmNlLCBwcmVwZW5kID0gZmFsc2UpIHsNCiAgICBpZiAodGFyZ2V0KSB7DQogICAgICBjb25zdCBob29rcyA9IHRhcmdldFt0eXBlXSB8fCAodGFyZ2V0W3R5cGVdID0gW10pOw0KICAgICAgY29uc3Qgd3JhcHBlZEhvb2sgPSBob29rLl9fd2VoIHx8IChob29rLl9fd2VoID0gKC4uLmFyZ3MpID0+IHsNCiAgICAgICAgcGF1c2VUcmFja2luZygpOw0KICAgICAgICBjb25zdCByZXNldCA9IHNldEN1cnJlbnRJbnN0YW5jZSh0YXJnZXQpOw0KICAgICAgICBjb25zdCByZXMgPSBjYWxsV2l0aEFzeW5jRXJyb3JIYW5kbGluZyhob29rLCB0YXJnZXQsIHR5cGUsIGFyZ3MpOw0KICAgICAgICByZXNldCgpOw0KICAgICAgICByZXNldFRyYWNraW5nKCk7DQogICAgICAgIHJldHVybiByZXM7DQogICAgICB9KTsNCiAgICAgIGlmIChwcmVwZW5kKSB7DQogICAgICAgIGhvb2tzLnVuc2hpZnQod3JhcHBlZEhvb2spOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgaG9va3MucHVzaCh3cmFwcGVkSG9vayk7DQogICAgICB9DQogICAgICByZXR1cm4gd3JhcHBlZEhvb2s7DQogICAgfSBlbHNlIHsNCiAgICAgIGNvbnN0IGFwaU5hbWUgPSB0b0hhbmRsZXJLZXkoRXJyb3JUeXBlU3RyaW5ncyQxW3R5cGVdLnJlcGxhY2UoLyBob29rJC8sICIiKSk7DQogICAgICB3YXJuJDEoDQogICAgICAgIGAke2FwaU5hbWV9IGlzIGNhbGxlZCB3aGVuIHRoZXJlIGlzIG5vIGFjdGl2ZSBjb21wb25lbnQgaW5zdGFuY2UgdG8gYmUgYXNzb2NpYXRlZCB3aXRoLiBMaWZlY3ljbGUgaW5qZWN0aW9uIEFQSXMgY2FuIG9ubHkgYmUgdXNlZCBkdXJpbmcgZXhlY3V0aW9uIG9mIHNldHVwKCkuYCArIChgIElmIHlvdSBhcmUgdXNpbmcgYXN5bmMgc2V0dXAoKSwgbWFrZSBzdXJlIHRvIHJlZ2lzdGVyIGxpZmVjeWNsZSBob29rcyBiZWZvcmUgdGhlIGZpcnN0IGF3YWl0IHN0YXRlbWVudC5gICkNCiAgICAgICk7DQogICAgfQ0KICB9DQogIGNvbnN0IGNyZWF0ZUhvb2sgPSAobGlmZWN5Y2xlKSA9PiAoaG9vaywgdGFyZ2V0ID0gY3VycmVudEluc3RhbmNlKSA9PiB7DQogICAgaWYgKCFpc0luU1NSQ29tcG9uZW50U2V0dXAgfHwgbGlmZWN5Y2xlID09PSAic3AiKSB7DQogICAgICBpbmplY3RIb29rKGxpZmVjeWNsZSwgKC4uLmFyZ3MpID0+IGhvb2soLi4uYXJncyksIHRhcmdldCk7DQogICAgfQ0KICB9Ow0KICBjb25zdCBvbkJlZm9yZU1vdW50ID0gY3JlYXRlSG9vaygiYm0iKTsNCiAgY29uc3Qgb25Nb3VudGVkID0gY3JlYXRlSG9vaygibSIpOw0KICBjb25zdCBvbkJlZm9yZVVwZGF0ZSA9IGNyZWF0ZUhvb2soDQogICAgImJ1Ig0KICApOw0KICBjb25zdCBvblVwZGF0ZWQgPSBjcmVhdGVIb29rKCJ1Iik7DQogIGNvbnN0IG9uQmVmb3JlVW5tb3VudCA9IGNyZWF0ZUhvb2soDQogICAgImJ1bSINCiAgKTsNCiAgY29uc3Qgb25Vbm1vdW50ZWQgPSBjcmVhdGVIb29rKCJ1bSIpOw0KICBjb25zdCBvblNlcnZlclByZWZldGNoID0gY3JlYXRlSG9vaygNCiAgICAic3AiDQogICk7DQogIGNvbnN0IG9uUmVuZGVyVHJpZ2dlcmVkID0gY3JlYXRlSG9vaygicnRnIik7DQogIGNvbnN0IG9uUmVuZGVyVHJhY2tlZCA9IGNyZWF0ZUhvb2soInJ0YyIpOw0KICBmdW5jdGlvbiBvbkVycm9yQ2FwdHVyZWQoaG9vaywgdGFyZ2V0ID0gY3VycmVudEluc3RhbmNlKSB7DQogICAgaW5qZWN0SG9vaygiZWMiLCBob29rLCB0YXJnZXQpOw0KICB9DQoNCiAgY29uc3QgQ09NUE9ORU5UUyA9ICJjb21wb25lbnRzIjsNCiAgY29uc3QgRElSRUNUSVZFUyA9ICJkaXJlY3RpdmVzIjsNCiAgZnVuY3Rpb24gcmVzb2x2ZUNvbXBvbmVudChuYW1lLCBtYXliZVNlbGZSZWZlcmVuY2UpIHsNCiAgICByZXR1cm4gcmVzb2x2ZUFzc2V0KENPTVBPTkVOVFMsIG5hbWUsIHRydWUsIG1heWJlU2VsZlJlZmVyZW5jZSkgfHwgbmFtZTsNCiAgfQ0KICBjb25zdCBOVUxMX0RZTkFNSUNfQ09NUE9ORU5UID0gU3ltYm9sLmZvcigidi1uZGMiKTsNCiAgZnVuY3Rpb24gcmVzb2x2ZUR5bmFtaWNDb21wb25lbnQoY29tcG9uZW50KSB7DQogICAgaWYgKGlzU3RyaW5nKGNvbXBvbmVudCkpIHsNCiAgICAgIHJldHVybiByZXNvbHZlQXNzZXQoQ09NUE9ORU5UUywgY29tcG9uZW50LCBmYWxzZSkgfHwgY29tcG9uZW50Ow0KICAgIH0gZWxzZSB7DQogICAgICByZXR1cm4gY29tcG9uZW50IHx8IE5VTExfRFlOQU1JQ19DT01QT05FTlQ7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIHJlc29sdmVEaXJlY3RpdmUobmFtZSkgew0KICAgIHJldHVybiByZXNvbHZlQXNzZXQoRElSRUNUSVZFUywgbmFtZSk7DQogIH0NCiAgZnVuY3Rpb24gcmVzb2x2ZUFzc2V0KHR5cGUsIG5hbWUsIHdhcm5NaXNzaW5nID0gdHJ1ZSwgbWF5YmVTZWxmUmVmZXJlbmNlID0gZmFsc2UpIHsNCiAgICBjb25zdCBpbnN0YW5jZSA9IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSB8fCBjdXJyZW50SW5zdGFuY2U7DQogICAgaWYgKGluc3RhbmNlKSB7DQogICAgICBjb25zdCBDb21wb25lbnQgPSBpbnN0YW5jZS50eXBlOw0KICAgICAgaWYgKHR5cGUgPT09IENPTVBPTkVOVFMpIHsNCiAgICAgICAgY29uc3Qgc2VsZk5hbWUgPSBnZXRDb21wb25lbnROYW1lKA0KICAgICAgICAgIENvbXBvbmVudCwNCiAgICAgICAgICBmYWxzZQ0KICAgICAgICApOw0KICAgICAgICBpZiAoc2VsZk5hbWUgJiYgKHNlbGZOYW1lID09PSBuYW1lIHx8IHNlbGZOYW1lID09PSBjYW1lbGl6ZShuYW1lKSB8fCBzZWxmTmFtZSA9PT0gY2FwaXRhbGl6ZShjYW1lbGl6ZShuYW1lKSkpKSB7DQogICAgICAgICAgcmV0dXJuIENvbXBvbmVudDsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgY29uc3QgcmVzID0gKA0KICAgICAgICAvLyBsb2NhbCByZWdpc3RyYXRpb24NCiAgICAgICAgLy8gY2hlY2sgaW5zdGFuY2VbdHlwZV0gZmlyc3Qgd2hpY2ggaXMgcmVzb2x2ZWQgZm9yIG9wdGlvbnMgQVBJDQogICAgICAgIHJlc29sdmUoaW5zdGFuY2VbdHlwZV0gfHwgQ29tcG9uZW50W3R5cGVdLCBuYW1lKSB8fCAvLyBnbG9iYWwgcmVnaXN0cmF0aW9uDQogICAgICAgIHJlc29sdmUoaW5zdGFuY2UuYXBwQ29udGV4dFt0eXBlXSwgbmFtZSkNCiAgICAgICk7DQogICAgICBpZiAoIXJlcyAmJiBtYXliZVNlbGZSZWZlcmVuY2UpIHsNCiAgICAgICAgcmV0dXJuIENvbXBvbmVudDsNCiAgICAgIH0NCiAgICAgIGlmICh3YXJuTWlzc2luZyAmJiAhcmVzKSB7DQogICAgICAgIGNvbnN0IGV4dHJhID0gdHlwZSA9PT0gQ09NUE9ORU5UUyA/IGANCklmIHRoaXMgaXMgYSBuYXRpdmUgY3VzdG9tIGVsZW1lbnQsIG1ha2Ugc3VyZSB0byBleGNsdWRlIGl0IGZyb20gY29tcG9uZW50IHJlc29sdXRpb24gdmlhIGNvbXBpbGVyT3B0aW9ucy5pc0N1c3RvbUVsZW1lbnQuYCA6IGBgOw0KICAgICAgICB3YXJuJDEoYEZhaWxlZCB0byByZXNvbHZlICR7dHlwZS5zbGljZSgwLCAtMSl9OiAke25hbWV9JHtleHRyYX1gKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiByZXM7DQogICAgfSBlbHNlIHsNCiAgICAgIHdhcm4kMSgNCiAgICAgICAgYHJlc29sdmUke2NhcGl0YWxpemUodHlwZS5zbGljZSgwLCAtMSkpfSBjYW4gb25seSBiZSB1c2VkIGluIHJlbmRlcigpIG9yIHNldHVwKCkuYA0KICAgICAgKTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gcmVzb2x2ZShyZWdpc3RyeSwgbmFtZSkgew0KICAgIHJldHVybiByZWdpc3RyeSAmJiAocmVnaXN0cnlbbmFtZV0gfHwgcmVnaXN0cnlbY2FtZWxpemUobmFtZSldIHx8IHJlZ2lzdHJ5W2NhcGl0YWxpemUoY2FtZWxpemUobmFtZSkpXSk7DQogIH0NCg0KICBmdW5jdGlvbiByZW5kZXJMaXN0KHNvdXJjZSwgcmVuZGVySXRlbSwgY2FjaGUsIGluZGV4KSB7DQogICAgbGV0IHJldDsNCiAgICBjb25zdCBjYWNoZWQgPSBjYWNoZSAmJiBjYWNoZVtpbmRleF07DQogICAgY29uc3Qgc291cmNlSXNBcnJheSA9IGlzQXJyYXkoc291cmNlKTsNCiAgICBpZiAoc291cmNlSXNBcnJheSB8fCBpc1N0cmluZyhzb3VyY2UpKSB7DQogICAgICBjb25zdCBzb3VyY2VJc1JlYWN0aXZlQXJyYXkgPSBzb3VyY2VJc0FycmF5ICYmIGlzUmVhY3RpdmUoc291cmNlKTsNCiAgICAgIGxldCBuZWVkc1dyYXAgPSBmYWxzZTsNCiAgICAgIGxldCBpc1JlYWRvbmx5U291cmNlID0gZmFsc2U7DQogICAgICBpZiAoc291cmNlSXNSZWFjdGl2ZUFycmF5KSB7DQogICAgICAgIG5lZWRzV3JhcCA9ICFpc1NoYWxsb3coc291cmNlKTsNCiAgICAgICAgaXNSZWFkb25seVNvdXJjZSA9IGlzUmVhZG9ubHkoc291cmNlKTsNCiAgICAgICAgc291cmNlID0gc2hhbGxvd1JlYWRBcnJheShzb3VyY2UpOw0KICAgICAgfQ0KICAgICAgcmV0ID0gbmV3IEFycmF5KHNvdXJjZS5sZW5ndGgpOw0KICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBzb3VyY2UubGVuZ3RoOyBpIDwgbDsgaSsrKSB7DQogICAgICAgIHJldFtpXSA9IHJlbmRlckl0ZW0oDQogICAgICAgICAgbmVlZHNXcmFwID8gaXNSZWFkb25seVNvdXJjZSA/IHRvUmVhZG9ubHkodG9SZWFjdGl2ZShzb3VyY2VbaV0pKSA6IHRvUmVhY3RpdmUoc291cmNlW2ldKSA6IHNvdXJjZVtpXSwNCiAgICAgICAgICBpLA0KICAgICAgICAgIHZvaWQgMCwNCiAgICAgICAgICBjYWNoZWQgJiYgY2FjaGVkW2ldDQogICAgICAgICk7DQogICAgICB9DQogICAgfSBlbHNlIGlmICh0eXBlb2Ygc291cmNlID09PSAibnVtYmVyIikgew0KICAgICAgaWYgKCFOdW1iZXIuaXNJbnRlZ2VyKHNvdXJjZSkpIHsNCiAgICAgICAgd2FybiQxKGBUaGUgdi1mb3IgcmFuZ2UgZXhwZWN0IGFuIGludGVnZXIgdmFsdWUgYnV0IGdvdCAke3NvdXJjZX0uYCk7DQogICAgICB9DQogICAgICByZXQgPSBuZXcgQXJyYXkoc291cmNlKTsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc291cmNlOyBpKyspIHsNCiAgICAgICAgcmV0W2ldID0gcmVuZGVySXRlbShpICsgMSwgaSwgdm9pZCAwLCBjYWNoZWQgJiYgY2FjaGVkW2ldKTsNCiAgICAgIH0NCiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHNvdXJjZSkpIHsNCiAgICAgIGlmIChzb3VyY2VbU3ltYm9sLml0ZXJhdG9yXSkgew0KICAgICAgICByZXQgPSBBcnJheS5mcm9tKA0KICAgICAgICAgIHNvdXJjZSwNCiAgICAgICAgICAoaXRlbSwgaSkgPT4gcmVuZGVySXRlbShpdGVtLCBpLCB2b2lkIDAsIGNhY2hlZCAmJiBjYWNoZWRbaV0pDQogICAgICAgICk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoc291cmNlKTsNCiAgICAgICAgcmV0ID0gbmV3IEFycmF5KGtleXMubGVuZ3RoKTsNCiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKykgew0KICAgICAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07DQogICAgICAgICAgcmV0W2ldID0gcmVuZGVySXRlbShzb3VyY2Vba2V5XSwga2V5LCBpLCBjYWNoZWQgJiYgY2FjaGVkW2ldKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICByZXQgPSBbXTsNCiAgICB9DQogICAgaWYgKGNhY2hlKSB7DQogICAgICBjYWNoZVtpbmRleF0gPSByZXQ7DQogICAgfQ0KICAgIHJldHVybiByZXQ7DQogIH0NCg0KICBmdW5jdGlvbiBjcmVhdGVTbG90cyhzbG90cywgZHluYW1pY1Nsb3RzKSB7DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkeW5hbWljU2xvdHMubGVuZ3RoOyBpKyspIHsNCiAgICAgIGNvbnN0IHNsb3QgPSBkeW5hbWljU2xvdHNbaV07DQogICAgICBpZiAoaXNBcnJheShzbG90KSkgew0KICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHNsb3QubGVuZ3RoOyBqKyspIHsNCiAgICAgICAgICBzbG90c1tzbG90W2pdLm5hbWVdID0gc2xvdFtqXS5mbjsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIGlmIChzbG90KSB7DQogICAgICAgIHNsb3RzW3Nsb3QubmFtZV0gPSBzbG90LmtleSA/ICguLi5hcmdzKSA9PiB7DQogICAgICAgICAgY29uc3QgcmVzID0gc2xvdC5mbiguLi5hcmdzKTsNCiAgICAgICAgICBpZiAocmVzKSByZXMua2V5ID0gc2xvdC5rZXk7DQogICAgICAgICAgcmV0dXJuIHJlczsNCiAgICAgICAgfSA6IHNsb3QuZm47DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiBzbG90czsNCiAgfQ0KDQogIGZ1bmN0aW9uIHJlbmRlclNsb3Qoc2xvdHMsIG5hbWUsIHByb3BzID0ge30sIGZhbGxiYWNrLCBub1Nsb3R0ZWQpIHsNCiAgICBpZiAoY3VycmVudFJlbmRlcmluZ0luc3RhbmNlLmNlIHx8IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZS5wYXJlbnQgJiYgaXNBc3luY1dyYXBwZXIoY3VycmVudFJlbmRlcmluZ0luc3RhbmNlLnBhcmVudCkgJiYgY3VycmVudFJlbmRlcmluZ0luc3RhbmNlLnBhcmVudC5jZSkgew0KICAgICAgaWYgKG5hbWUgIT09ICJkZWZhdWx0IikgcHJvcHMubmFtZSA9IG5hbWU7DQogICAgICByZXR1cm4gb3BlbkJsb2NrKCksIGNyZWF0ZUJsb2NrKA0KICAgICAgICBGcmFnbWVudCwNCiAgICAgICAgbnVsbCwNCiAgICAgICAgW2NyZWF0ZVZOb2RlKCJzbG90IiwgcHJvcHMsIGZhbGxiYWNrICYmIGZhbGxiYWNrKCkpXSwNCiAgICAgICAgNjQNCiAgICAgICk7DQogICAgfQ0KICAgIGxldCBzbG90ID0gc2xvdHNbbmFtZV07DQogICAgaWYgKHNsb3QgJiYgc2xvdC5sZW5ndGggPiAxKSB7DQogICAgICB3YXJuJDEoDQogICAgICAgIGBTU1Itb3B0aW1pemVkIHNsb3QgZnVuY3Rpb24gZGV0ZWN0ZWQgaW4gYSBub24tU1NSLW9wdGltaXplZCByZW5kZXIgZnVuY3Rpb24uIFlvdSBuZWVkIHRvIG1hcmsgdGhpcyBjb21wb25lbnQgd2l0aCAkZHluYW1pYy1zbG90cyBpbiB0aGUgcGFyZW50IHRlbXBsYXRlLmANCiAgICAgICk7DQogICAgICBzbG90ID0gKCkgPT4gW107DQogICAgfQ0KICAgIGlmIChzbG90ICYmIHNsb3QuX2MpIHsNCiAgICAgIHNsb3QuX2QgPSBmYWxzZTsNCiAgICB9DQogICAgb3BlbkJsb2NrKCk7DQogICAgY29uc3QgdmFsaWRTbG90Q29udGVudCA9IHNsb3QgJiYgZW5zdXJlVmFsaWRWTm9kZShzbG90KHByb3BzKSk7DQogICAgY29uc3Qgc2xvdEtleSA9IHByb3BzLmtleSB8fCAvLyBzbG90IGNvbnRlbnQgYXJyYXkgb2YgYSBkeW5hbWljIGNvbmRpdGlvbmFsIHNsb3QgbWF5IGhhdmUgYSBicmFuY2gNCiAgICAvLyBrZXkgYXR0YWNoZWQgaW4gdGhlIGBjcmVhdGVTbG90c2AgaGVscGVyLCByZXNwZWN0IHRoYXQNCiAgICB2YWxpZFNsb3RDb250ZW50ICYmIHZhbGlkU2xvdENvbnRlbnQua2V5Ow0KICAgIGNvbnN0IHJlbmRlcmVkID0gY3JlYXRlQmxvY2soDQogICAgICBGcmFnbWVudCwNCiAgICAgIHsNCiAgICAgICAga2V5OiAoc2xvdEtleSAmJiAhaXNTeW1ib2woc2xvdEtleSkgPyBzbG90S2V5IDogYF8ke25hbWV9YCkgKyAvLyAjNzI1NiBmb3JjZSBkaWZmZXJlbnRpYXRlIGZhbGxiYWNrIGNvbnRlbnQgZnJvbSBhY3R1YWwgY29udGVudA0KICAgICAgICAoIXZhbGlkU2xvdENvbnRlbnQgJiYgZmFsbGJhY2sgPyAiX2ZiIiA6ICIiKQ0KICAgICAgfSwNCiAgICAgIHZhbGlkU2xvdENvbnRlbnQgfHwgKGZhbGxiYWNrID8gZmFsbGJhY2soKSA6IFtdKSwNCiAgICAgIHZhbGlkU2xvdENvbnRlbnQgJiYgc2xvdHMuXyA9PT0gMSA/IDY0IDogLTINCiAgICApOw0KICAgIGlmICghbm9TbG90dGVkICYmIHJlbmRlcmVkLnNjb3BlSWQpIHsNCiAgICAgIHJlbmRlcmVkLnNsb3RTY29wZUlkcyA9IFtyZW5kZXJlZC5zY29wZUlkICsgIi1zIl07DQogICAgfQ0KICAgIGlmIChzbG90ICYmIHNsb3QuX2MpIHsNCiAgICAgIHNsb3QuX2QgPSB0cnVlOw0KICAgIH0NCiAgICByZXR1cm4gcmVuZGVyZWQ7DQogIH0NCiAgZnVuY3Rpb24gZW5zdXJlVmFsaWRWTm9kZSh2bm9kZXMpIHsNCiAgICByZXR1cm4gdm5vZGVzLnNvbWUoKGNoaWxkKSA9PiB7DQogICAgICBpZiAoIWlzVk5vZGUoY2hpbGQpKSByZXR1cm4gdHJ1ZTsNCiAgICAgIGlmIChjaGlsZC50eXBlID09PSBDb21tZW50KSByZXR1cm4gZmFsc2U7DQogICAgICBpZiAoY2hpbGQudHlwZSA9PT0gRnJhZ21lbnQgJiYgIWVuc3VyZVZhbGlkVk5vZGUoY2hpbGQuY2hpbGRyZW4pKQ0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9KSA/IHZub2RlcyA6IG51bGw7DQogIH0NCg0KICBmdW5jdGlvbiB0b0hhbmRsZXJzKG9iaiwgcHJlc2VydmVDYXNlSWZOZWNlc3NhcnkpIHsNCiAgICBjb25zdCByZXQgPSB7fTsNCiAgICBpZiAoIWlzT2JqZWN0KG9iaikpIHsNCiAgICAgIHdhcm4kMShgdi1vbiB3aXRoIG5vIGFyZ3VtZW50IGV4cGVjdHMgYW4gb2JqZWN0IHZhbHVlLmApOw0KICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgZm9yIChjb25zdCBrZXkgaW4gb2JqKSB7DQogICAgICByZXRbcHJlc2VydmVDYXNlSWZOZWNlc3NhcnkgJiYgL1tBLVpdLy50ZXN0KGtleSkgPyBgb246JHtrZXl9YCA6IHRvSGFuZGxlcktleShrZXkpXSA9IG9ialtrZXldOw0KICAgIH0NCiAgICByZXR1cm4gcmV0Ow0KICB9DQoNCiAgY29uc3QgZ2V0UHVibGljSW5zdGFuY2UgPSAoaSkgPT4gew0KICAgIGlmICghaSkgcmV0dXJuIG51bGw7DQogICAgaWYgKGlzU3RhdGVmdWxDb21wb25lbnQoaSkpIHJldHVybiBnZXRDb21wb25lbnRQdWJsaWNJbnN0YW5jZShpKTsNCiAgICByZXR1cm4gZ2V0UHVibGljSW5zdGFuY2UoaS5wYXJlbnQpOw0KICB9Ow0KICBjb25zdCBwdWJsaWNQcm9wZXJ0aWVzTWFwID0gKA0KICAgIC8vIE1vdmUgUFVSRSBtYXJrZXIgdG8gbmV3IGxpbmUgdG8gd29ya2Fyb3VuZCBjb21waWxlciBkaXNjYXJkaW5nIGl0DQogICAgLy8gZHVlIHRvIHR5cGUgYW5ub3RhdGlvbg0KICAgIC8qIEBfX1BVUkVfXyAqLyBleHRlbmQoLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCksIHsNCiAgICAgICQ6IChpKSA9PiBpLA0KICAgICAgJGVsOiAoaSkgPT4gaS52bm9kZS5lbCwNCiAgICAgICRkYXRhOiAoaSkgPT4gaS5kYXRhLA0KICAgICAgJHByb3BzOiAoaSkgPT4gc2hhbGxvd1JlYWRvbmx5KGkucHJvcHMpICwNCiAgICAgICRhdHRyczogKGkpID0+IHNoYWxsb3dSZWFkb25seShpLmF0dHJzKSAsDQogICAgICAkc2xvdHM6IChpKSA9PiBzaGFsbG93UmVhZG9ubHkoaS5zbG90cykgLA0KICAgICAgJHJlZnM6IChpKSA9PiBzaGFsbG93UmVhZG9ubHkoaS5yZWZzKSAsDQogICAgICAkcGFyZW50OiAoaSkgPT4gZ2V0UHVibGljSW5zdGFuY2UoaS5wYXJlbnQpLA0KICAgICAgJHJvb3Q6IChpKSA9PiBnZXRQdWJsaWNJbnN0YW5jZShpLnJvb3QpLA0KICAgICAgJGhvc3Q6IChpKSA9PiBpLmNlLA0KICAgICAgJGVtaXQ6IChpKSA9PiBpLmVtaXQsDQogICAgICAkb3B0aW9uczogKGkpID0+IHJlc29sdmVNZXJnZWRPcHRpb25zKGkpICwNCiAgICAgICRmb3JjZVVwZGF0ZTogKGkpID0+IGkuZiB8fCAoaS5mID0gKCkgPT4gew0KICAgICAgICBxdWV1ZUpvYihpLnVwZGF0ZSk7DQogICAgICB9KSwNCiAgICAgICRuZXh0VGljazogKGkpID0+IGkubiB8fCAoaS5uID0gbmV4dFRpY2suYmluZChpLnByb3h5KSksDQogICAgICAkd2F0Y2g6IChpKSA9PiBpbnN0YW5jZVdhdGNoLmJpbmQoaSkgDQogICAgfSkNCiAgKTsNCiAgY29uc3QgaXNSZXNlcnZlZFByZWZpeCA9IChrZXkpID0+IGtleSA9PT0gIl8iIHx8IGtleSA9PT0gIiQiOw0KICBjb25zdCBoYXNTZXR1cEJpbmRpbmcgPSAoc3RhdGUsIGtleSkgPT4gc3RhdGUgIT09IEVNUFRZX09CSiAmJiAhc3RhdGUuX19pc1NjcmlwdFNldHVwICYmIGhhc093bihzdGF0ZSwga2V5KTsNCiAgY29uc3QgUHVibGljSW5zdGFuY2VQcm94eUhhbmRsZXJzID0gew0KICAgIGdldCh7IF86IGluc3RhbmNlIH0sIGtleSkgew0KICAgICAgaWYgKGtleSA9PT0gIl9fdl9za2lwIikgew0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIGNvbnN0IHsgY3R4LCBzZXR1cFN0YXRlLCBkYXRhLCBwcm9wcywgYWNjZXNzQ2FjaGUsIHR5cGUsIGFwcENvbnRleHQgfSA9IGluc3RhbmNlOw0KICAgICAgaWYgKGtleSA9PT0gIl9faXNWdWUiKSB7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfQ0KICAgICAgbGV0IG5vcm1hbGl6ZWRQcm9wczsNCiAgICAgIGlmIChrZXlbMF0gIT09ICIkIikgew0KICAgICAgICBjb25zdCBuID0gYWNjZXNzQ2FjaGVba2V5XTsNCiAgICAgICAgaWYgKG4gIT09IHZvaWQgMCkgew0KICAgICAgICAgIHN3aXRjaCAobikgew0KICAgICAgICAgICAgY2FzZSAxIC8qIFNFVFVQICovOg0KICAgICAgICAgICAgICByZXR1cm4gc2V0dXBTdGF0ZVtrZXldOw0KICAgICAgICAgICAgY2FzZSAyIC8qIERBVEEgKi86DQogICAgICAgICAgICAgIHJldHVybiBkYXRhW2tleV07DQogICAgICAgICAgICBjYXNlIDQgLyogQ09OVEVYVCAqLzoNCiAgICAgICAgICAgICAgcmV0dXJuIGN0eFtrZXldOw0KICAgICAgICAgICAgY2FzZSAzIC8qIFBST1BTICovOg0KICAgICAgICAgICAgICByZXR1cm4gcHJvcHNba2V5XTsNCiAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSBpZiAoaGFzU2V0dXBCaW5kaW5nKHNldHVwU3RhdGUsIGtleSkpIHsNCiAgICAgICAgICBhY2Nlc3NDYWNoZVtrZXldID0gMSAvKiBTRVRVUCAqLzsNCiAgICAgICAgICByZXR1cm4gc2V0dXBTdGF0ZVtrZXldOw0KICAgICAgICB9IGVsc2UgaWYgKGRhdGEgIT09IEVNUFRZX09CSiAmJiBoYXNPd24oZGF0YSwga2V5KSkgew0KICAgICAgICAgIGFjY2Vzc0NhY2hlW2tleV0gPSAyIC8qIERBVEEgKi87DQogICAgICAgICAgcmV0dXJuIGRhdGFba2V5XTsNCiAgICAgICAgfSBlbHNlIGlmICgNCiAgICAgICAgICAvLyBvbmx5IGNhY2hlIG90aGVyIHByb3BlcnRpZXMgd2hlbiBpbnN0YW5jZSBoYXMgZGVjbGFyZWQgKHRodXMgc3RhYmxlKQ0KICAgICAgICAgIC8vIHByb3BzDQogICAgICAgICAgKG5vcm1hbGl6ZWRQcm9wcyA9IGluc3RhbmNlLnByb3BzT3B0aW9uc1swXSkgJiYgaGFzT3duKG5vcm1hbGl6ZWRQcm9wcywga2V5KQ0KICAgICAgICApIHsNCiAgICAgICAgICBhY2Nlc3NDYWNoZVtrZXldID0gMyAvKiBQUk9QUyAqLzsNCiAgICAgICAgICByZXR1cm4gcHJvcHNba2V5XTsNCiAgICAgICAgfSBlbHNlIGlmIChjdHggIT09IEVNUFRZX09CSiAmJiBoYXNPd24oY3R4LCBrZXkpKSB7DQogICAgICAgICAgYWNjZXNzQ2FjaGVba2V5XSA9IDQgLyogQ09OVEVYVCAqLzsNCiAgICAgICAgICByZXR1cm4gY3R4W2tleV07DQogICAgICAgIH0gZWxzZSBpZiAoc2hvdWxkQ2FjaGVBY2Nlc3MpIHsNCiAgICAgICAgICBhY2Nlc3NDYWNoZVtrZXldID0gMCAvKiBPVEhFUiAqLzsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgY29uc3QgcHVibGljR2V0dGVyID0gcHVibGljUHJvcGVydGllc01hcFtrZXldOw0KICAgICAgbGV0IGNzc01vZHVsZSwgZ2xvYmFsUHJvcGVydGllczsNCiAgICAgIGlmIChwdWJsaWNHZXR0ZXIpIHsNCiAgICAgICAgaWYgKGtleSA9PT0gIiRhdHRycyIpIHsNCiAgICAgICAgICB0cmFjayhpbnN0YW5jZS5hdHRycywgImdldCIsICIiKTsNCiAgICAgICAgICBtYXJrQXR0cnNBY2Nlc3NlZCgpOw0KICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gIiRzbG90cyIpIHsNCiAgICAgICAgICB0cmFjayhpbnN0YW5jZSwgImdldCIsIGtleSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHB1YmxpY0dldHRlcihpbnN0YW5jZSk7DQogICAgICB9IGVsc2UgaWYgKA0KICAgICAgICAvLyBjc3MgbW9kdWxlIChpbmplY3RlZCBieSB2dWUtbG9hZGVyKQ0KICAgICAgICAoY3NzTW9kdWxlID0gdHlwZS5fX2Nzc01vZHVsZXMpICYmIChjc3NNb2R1bGUgPSBjc3NNb2R1bGVba2V5XSkNCiAgICAgICkgew0KICAgICAgICByZXR1cm4gY3NzTW9kdWxlOw0KICAgICAgfSBlbHNlIGlmIChjdHggIT09IEVNUFRZX09CSiAmJiBoYXNPd24oY3R4LCBrZXkpKSB7DQogICAgICAgIGFjY2Vzc0NhY2hlW2tleV0gPSA0IC8qIENPTlRFWFQgKi87DQogICAgICAgIHJldHVybiBjdHhba2V5XTsNCiAgICAgIH0gZWxzZSBpZiAoDQogICAgICAgIC8vIGdsb2JhbCBwcm9wZXJ0aWVzDQogICAgICAgIGdsb2JhbFByb3BlcnRpZXMgPSBhcHBDb250ZXh0LmNvbmZpZy5nbG9iYWxQcm9wZXJ0aWVzLCBoYXNPd24oZ2xvYmFsUHJvcGVydGllcywga2V5KQ0KICAgICAgKSB7DQogICAgICAgIHsNCiAgICAgICAgICByZXR1cm4gZ2xvYmFsUHJvcGVydGllc1trZXldOw0KICAgICAgICB9DQogICAgICB9IGVsc2UgaWYgKGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSAmJiAoIWlzU3RyaW5nKGtleSkgfHwgLy8gIzEwOTEgYXZvaWQgaW50ZXJuYWwgaXNSZWYvaXNWTm9kZSBjaGVja3Mgb24gY29tcG9uZW50IGluc3RhbmNlIGxlYWRpbmcNCiAgICAgIC8vIHRvIGluZmluaXRlIHdhcm5pbmcgbG9vcA0KICAgICAga2V5LmluZGV4T2YoIl9fdiIpICE9PSAwKSkgew0KICAgICAgICBpZiAoZGF0YSAhPT0gRU1QVFlfT0JKICYmIGlzUmVzZXJ2ZWRQcmVmaXgoa2V5WzBdKSAmJiBoYXNPd24oZGF0YSwga2V5KSkgew0KICAgICAgICAgIHdhcm4kMSgNCiAgICAgICAgICAgIGBQcm9wZXJ0eSAke0pTT04uc3RyaW5naWZ5KA0KICAgICAgICAgICAga2V5DQogICAgICAgICAgKX0gbXVzdCBiZSBhY2Nlc3NlZCB2aWEgJGRhdGEgYmVjYXVzZSBpdCBzdGFydHMgd2l0aCBhIHJlc2VydmVkIGNoYXJhY3RlciAoIiQiIG9yICJfIikgYW5kIGlzIG5vdCBwcm94aWVkIG9uIHRoZSByZW5kZXIgY29udGV4dC5gDQogICAgICAgICAgKTsNCiAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZSA9PT0gY3VycmVudFJlbmRlcmluZ0luc3RhbmNlKSB7DQogICAgICAgICAgd2FybiQxKA0KICAgICAgICAgICAgYFByb3BlcnR5ICR7SlNPTi5zdHJpbmdpZnkoa2V5KX0gd2FzIGFjY2Vzc2VkIGR1cmluZyByZW5kZXIgYnV0IGlzIG5vdCBkZWZpbmVkIG9uIGluc3RhbmNlLmANCiAgICAgICAgICApOw0KICAgICAgICB9DQogICAgICB9DQogICAgfSwNCiAgICBzZXQoeyBfOiBpbnN0YW5jZSB9LCBrZXksIHZhbHVlKSB7DQogICAgICBjb25zdCB7IGRhdGEsIHNldHVwU3RhdGUsIGN0eCB9ID0gaW5zdGFuY2U7DQogICAgICBpZiAoaGFzU2V0dXBCaW5kaW5nKHNldHVwU3RhdGUsIGtleSkpIHsNCiAgICAgICAgc2V0dXBTdGF0ZVtrZXldID0gdmFsdWU7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfSBlbHNlIGlmIChzZXR1cFN0YXRlLl9faXNTY3JpcHRTZXR1cCAmJiBoYXNPd24oc2V0dXBTdGF0ZSwga2V5KSkgew0KICAgICAgICB3YXJuJDEoYENhbm5vdCBtdXRhdGUgPHNjcmlwdCBzZXR1cD4gYmluZGluZyAiJHtrZXl9IiBmcm9tIE9wdGlvbnMgQVBJLmApOw0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICB9IGVsc2UgaWYgKGRhdGEgIT09IEVNUFRZX09CSiAmJiBoYXNPd24oZGF0YSwga2V5KSkgew0KICAgICAgICBkYXRhW2tleV0gPSB2YWx1ZTsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9IGVsc2UgaWYgKGhhc093bihpbnN0YW5jZS5wcm9wcywga2V5KSkgew0KICAgICAgICB3YXJuJDEoYEF0dGVtcHRpbmcgdG8gbXV0YXRlIHByb3AgIiR7a2V5fSIuIFByb3BzIGFyZSByZWFkb25seS5gKTsNCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgfQ0KICAgICAgaWYgKGtleVswXSA9PT0gIiQiICYmIGtleS5zbGljZSgxKSBpbiBpbnN0YW5jZSkgew0KICAgICAgICB3YXJuJDEoDQogICAgICAgICAgYEF0dGVtcHRpbmcgdG8gbXV0YXRlIHB1YmxpYyBwcm9wZXJ0eSAiJHtrZXl9Ii4gUHJvcGVydGllcyBzdGFydGluZyB3aXRoICQgYXJlIHJlc2VydmVkIGFuZCByZWFkb25seS5gDQogICAgICAgICk7DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGlmIChrZXkgaW4gaW5zdGFuY2UuYXBwQ29udGV4dC5jb25maWcuZ2xvYmFsUHJvcGVydGllcykgew0KICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjdHgsIGtleSwgew0KICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwNCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwNCiAgICAgICAgICAgIHZhbHVlDQogICAgICAgICAgfSk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgY3R4W2tleV0gPSB2YWx1ZTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfSwNCiAgICBoYXMoew0KICAgICAgXzogeyBkYXRhLCBzZXR1cFN0YXRlLCBhY2Nlc3NDYWNoZSwgY3R4LCBhcHBDb250ZXh0LCBwcm9wc09wdGlvbnMgfQ0KICAgIH0sIGtleSkgew0KICAgICAgbGV0IG5vcm1hbGl6ZWRQcm9wczsNCiAgICAgIHJldHVybiAhIWFjY2Vzc0NhY2hlW2tleV0gfHwgZGF0YSAhPT0gRU1QVFlfT0JKICYmIGhhc093bihkYXRhLCBrZXkpIHx8IGhhc1NldHVwQmluZGluZyhzZXR1cFN0YXRlLCBrZXkpIHx8IChub3JtYWxpemVkUHJvcHMgPSBwcm9wc09wdGlvbnNbMF0pICYmIGhhc093bihub3JtYWxpemVkUHJvcHMsIGtleSkgfHwgaGFzT3duKGN0eCwga2V5KSB8fCBoYXNPd24ocHVibGljUHJvcGVydGllc01hcCwga2V5KSB8fCBoYXNPd24oYXBwQ29udGV4dC5jb25maWcuZ2xvYmFsUHJvcGVydGllcywga2V5KTsNCiAgICB9LA0KICAgIGRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBkZXNjcmlwdG9yKSB7DQogICAgICBpZiAoZGVzY3JpcHRvci5nZXQgIT0gbnVsbCkgew0KICAgICAgICB0YXJnZXQuXy5hY2Nlc3NDYWNoZVtrZXldID0gMDsNCiAgICAgIH0gZWxzZSBpZiAoaGFzT3duKGRlc2NyaXB0b3IsICJ2YWx1ZSIpKSB7DQogICAgICAgIHRoaXMuc2V0KHRhcmdldCwga2V5LCBkZXNjcmlwdG9yLnZhbHVlLCBudWxsKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBSZWZsZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBkZXNjcmlwdG9yKTsNCiAgICB9DQogIH07DQogIHsNCiAgICBQdWJsaWNJbnN0YW5jZVByb3h5SGFuZGxlcnMub3duS2V5cyA9ICh0YXJnZXQpID0+IHsNCiAgICAgIHdhcm4kMSgNCiAgICAgICAgYEF2b2lkIGFwcCBsb2dpYyB0aGF0IHJlbGllcyBvbiBlbnVtZXJhdGluZyBrZXlzIG9uIGEgY29tcG9uZW50IGluc3RhbmNlLiBUaGUga2V5cyB3aWxsIGJlIGVtcHR5IGluIHByb2R1Y3Rpb24gbW9kZSB0byBhdm9pZCBwZXJmb3JtYW5jZSBvdmVyaGVhZC5gDQogICAgICApOw0KICAgICAgcmV0dXJuIFJlZmxlY3Qub3duS2V5cyh0YXJnZXQpOw0KICAgIH07DQogIH0NCiAgY29uc3QgUnVudGltZUNvbXBpbGVkUHVibGljSW5zdGFuY2VQcm94eUhhbmRsZXJzID0gLyogQF9fUFVSRV9fICovIGV4dGVuZCh7fSwgUHVibGljSW5zdGFuY2VQcm94eUhhbmRsZXJzLCB7DQogICAgZ2V0KHRhcmdldCwga2V5KSB7DQogICAgICBpZiAoa2V5ID09PSBTeW1ib2wudW5zY29wYWJsZXMpIHsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIFB1YmxpY0luc3RhbmNlUHJveHlIYW5kbGVycy5nZXQodGFyZ2V0LCBrZXksIHRhcmdldCk7DQogICAgfSwNCiAgICBoYXMoXywga2V5KSB7DQogICAgICBjb25zdCBoYXMgPSBrZXlbMF0gIT09ICJfIiAmJiAhaXNHbG9iYWxseUFsbG93ZWQoa2V5KTsNCiAgICAgIGlmICghaGFzICYmIFB1YmxpY0luc3RhbmNlUHJveHlIYW5kbGVycy5oYXMoXywga2V5KSkgew0KICAgICAgICB3YXJuJDEoDQogICAgICAgICAgYFByb3BlcnR5ICR7SlNPTi5zdHJpbmdpZnkoDQogICAgICAgICAga2V5DQogICAgICAgICl9IHNob3VsZCBub3Qgc3RhcnQgd2l0aCBfIHdoaWNoIGlzIGEgcmVzZXJ2ZWQgcHJlZml4IGZvciBWdWUgaW50ZXJuYWxzLmANCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBoYXM7DQogICAgfQ0KICB9KTsNCiAgZnVuY3Rpb24gY3JlYXRlRGV2UmVuZGVyQ29udGV4dChpbnN0YW5jZSkgew0KICAgIGNvbnN0IHRhcmdldCA9IHt9Ow0KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGBfYCwgew0KICAgICAgY29uZmlndXJhYmxlOiB0cnVlLA0KICAgICAgZW51bWVyYWJsZTogZmFsc2UsDQogICAgICBnZXQ6ICgpID0+IGluc3RhbmNlDQogICAgfSk7DQogICAgT2JqZWN0LmtleXMocHVibGljUHJvcGVydGllc01hcCkuZm9yRWFjaCgoa2V5KSA9PiB7DQogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHsNCiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLA0KICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwNCiAgICAgICAgZ2V0OiAoKSA9PiBwdWJsaWNQcm9wZXJ0aWVzTWFwW2tleV0oaW5zdGFuY2UpLA0KICAgICAgICAvLyBpbnRlcmNlcHRlZCBieSB0aGUgcHJveHkgc28gbm8gbmVlZCBmb3IgaW1wbGVtZW50YXRpb24sDQogICAgICAgIC8vIGJ1dCBuZWVkZWQgdG8gcHJldmVudCBzZXQgZXJyb3JzDQogICAgICAgIHNldDogTk9PUA0KICAgICAgfSk7DQogICAgfSk7DQogICAgcmV0dXJuIHRhcmdldDsNCiAgfQ0KICBmdW5jdGlvbiBleHBvc2VQcm9wc09uUmVuZGVyQ29udGV4dChpbnN0YW5jZSkgew0KICAgIGNvbnN0IHsNCiAgICAgIGN0eCwNCiAgICAgIHByb3BzT3B0aW9uczogW3Byb3BzT3B0aW9uc10NCiAgICB9ID0gaW5zdGFuY2U7DQogICAgaWYgKHByb3BzT3B0aW9ucykgew0KICAgICAgT2JqZWN0LmtleXMocHJvcHNPcHRpb25zKS5mb3JFYWNoKChrZXkpID0+IHsNCiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGN0eCwga2V5LCB7DQogICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwNCiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsDQogICAgICAgICAgZ2V0OiAoKSA9PiBpbnN0YW5jZS5wcm9wc1trZXldLA0KICAgICAgICAgIHNldDogTk9PUA0KICAgICAgICB9KTsNCiAgICAgIH0pOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBleHBvc2VTZXR1cFN0YXRlT25SZW5kZXJDb250ZXh0KGluc3RhbmNlKSB7DQogICAgY29uc3QgeyBjdHgsIHNldHVwU3RhdGUgfSA9IGluc3RhbmNlOw0KICAgIE9iamVjdC5rZXlzKHRvUmF3KHNldHVwU3RhdGUpKS5mb3JFYWNoKChrZXkpID0+IHsNCiAgICAgIGlmICghc2V0dXBTdGF0ZS5fX2lzU2NyaXB0U2V0dXApIHsNCiAgICAgICAgaWYgKGlzUmVzZXJ2ZWRQcmVmaXgoa2V5WzBdKSkgew0KICAgICAgICAgIHdhcm4kMSgNCiAgICAgICAgICAgIGBzZXR1cCgpIHJldHVybiBwcm9wZXJ0eSAke0pTT04uc3RyaW5naWZ5KA0KICAgICAgICAgICAga2V5DQogICAgICAgICAgKX0gc2hvdWxkIG5vdCBzdGFydCB3aXRoICIkIiBvciAiXyIgd2hpY2ggYXJlIHJlc2VydmVkIHByZWZpeGVzIGZvciBWdWUgaW50ZXJuYWxzLmANCiAgICAgICAgICApOw0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY3R4LCBrZXksIHsNCiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLA0KICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwNCiAgICAgICAgICBnZXQ6ICgpID0+IHNldHVwU3RhdGVba2V5XSwNCiAgICAgICAgICBzZXQ6IE5PT1ANCiAgICAgICAgfSk7DQogICAgICB9DQogICAgfSk7DQogIH0NCg0KICBjb25zdCB3YXJuUnVudGltZVVzYWdlID0gKG1ldGhvZCkgPT4gd2FybiQxKA0KICAgIGAke21ldGhvZH0oKSBpcyBhIGNvbXBpbGVyLWhpbnQgaGVscGVyIHRoYXQgaXMgb25seSB1c2FibGUgaW5zaWRlIDxzY3JpcHQgc2V0dXA+IG9mIGEgc2luZ2xlIGZpbGUgY29tcG9uZW50LiBJdHMgYXJndW1lbnRzIHNob3VsZCBiZSBjb21waWxlZCBhd2F5IGFuZCBwYXNzaW5nIGl0IGF0IHJ1bnRpbWUgaGFzIG5vIGVmZmVjdC5gDQogICk7DQogIGZ1bmN0aW9uIGRlZmluZVByb3BzKCkgew0KICAgIHsNCiAgICAgIHdhcm5SdW50aW1lVXNhZ2UoYGRlZmluZVByb3BzYCk7DQogICAgfQ0KICAgIHJldHVybiBudWxsOw0KICB9DQogIGZ1bmN0aW9uIGRlZmluZUVtaXRzKCkgew0KICAgIHsNCiAgICAgIHdhcm5SdW50aW1lVXNhZ2UoYGRlZmluZUVtaXRzYCk7DQogICAgfQ0KICAgIHJldHVybiBudWxsOw0KICB9DQogIGZ1bmN0aW9uIGRlZmluZUV4cG9zZShleHBvc2VkKSB7DQogICAgew0KICAgICAgd2FyblJ1bnRpbWVVc2FnZShgZGVmaW5lRXhwb3NlYCk7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGRlZmluZU9wdGlvbnMob3B0aW9ucykgew0KICAgIHsNCiAgICAgIHdhcm5SdW50aW1lVXNhZ2UoYGRlZmluZU9wdGlvbnNgKTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gZGVmaW5lU2xvdHMoKSB7DQogICAgew0KICAgICAgd2FyblJ1bnRpbWVVc2FnZShgZGVmaW5lU2xvdHNgKTsNCiAgICB9DQogICAgcmV0dXJuIG51bGw7DQogIH0NCiAgZnVuY3Rpb24gZGVmaW5lTW9kZWwoKSB7DQogICAgew0KICAgICAgd2FyblJ1bnRpbWVVc2FnZSgiZGVmaW5lTW9kZWwiKTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gd2l0aERlZmF1bHRzKHByb3BzLCBkZWZhdWx0cykgew0KICAgIHsNCiAgICAgIHdhcm5SdW50aW1lVXNhZ2UoYHdpdGhEZWZhdWx0c2ApOw0KICAgIH0NCiAgICByZXR1cm4gbnVsbDsNCiAgfQ0KICBmdW5jdGlvbiB1c2VTbG90cygpIHsNCiAgICByZXR1cm4gZ2V0Q29udGV4dCgpLnNsb3RzOw0KICB9DQogIGZ1bmN0aW9uIHVzZUF0dHJzKCkgew0KICAgIHJldHVybiBnZXRDb250ZXh0KCkuYXR0cnM7DQogIH0NCiAgZnVuY3Rpb24gZ2V0Q29udGV4dCgpIHsNCiAgICBjb25zdCBpID0gZ2V0Q3VycmVudEluc3RhbmNlKCk7DQogICAgaWYgKCFpKSB7DQogICAgICB3YXJuJDEoYHVzZUNvbnRleHQoKSBjYWxsZWQgd2l0aG91dCBhY3RpdmUgaW5zdGFuY2UuYCk7DQogICAgfQ0KICAgIHJldHVybiBpLnNldHVwQ29udGV4dCB8fCAoaS5zZXR1cENvbnRleHQgPSBjcmVhdGVTZXR1cENvbnRleHQoaSkpOw0KICB9DQogIGZ1bmN0aW9uIG5vcm1hbGl6ZVByb3BzT3JFbWl0cyhwcm9wcykgew0KICAgIHJldHVybiBpc0FycmF5KHByb3BzKSA/IHByb3BzLnJlZHVjZSgNCiAgICAgIChub3JtYWxpemVkLCBwKSA9PiAobm9ybWFsaXplZFtwXSA9IG51bGwsIG5vcm1hbGl6ZWQpLA0KICAgICAge30NCiAgICApIDogcHJvcHM7DQogIH0NCiAgZnVuY3Rpb24gbWVyZ2VEZWZhdWx0cyhyYXcsIGRlZmF1bHRzKSB7DQogICAgY29uc3QgcHJvcHMgPSBub3JtYWxpemVQcm9wc09yRW1pdHMocmF3KTsNCiAgICBmb3IgKGNvbnN0IGtleSBpbiBkZWZhdWx0cykgew0KICAgICAgaWYgKGtleS5zdGFydHNXaXRoKCJfX3NraXAiKSkgY29udGludWU7DQogICAgICBsZXQgb3B0ID0gcHJvcHNba2V5XTsNCiAgICAgIGlmIChvcHQpIHsNCiAgICAgICAgaWYgKGlzQXJyYXkob3B0KSB8fCBpc0Z1bmN0aW9uKG9wdCkpIHsNCiAgICAgICAgICBvcHQgPSBwcm9wc1trZXldID0geyB0eXBlOiBvcHQsIGRlZmF1bHQ6IGRlZmF1bHRzW2tleV0gfTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBvcHQuZGVmYXVsdCA9IGRlZmF1bHRzW2tleV07DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSBpZiAob3B0ID09PSBudWxsKSB7DQogICAgICAgIG9wdCA9IHByb3BzW2tleV0gPSB7IGRlZmF1bHQ6IGRlZmF1bHRzW2tleV0gfTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHdhcm4kMShgcHJvcHMgZGVmYXVsdCBrZXkgIiR7a2V5fSIgaGFzIG5vIGNvcnJlc3BvbmRpbmcgZGVjbGFyYXRpb24uYCk7DQogICAgICB9DQogICAgICBpZiAob3B0ICYmIGRlZmF1bHRzW2BfX3NraXBfJHtrZXl9YF0pIHsNCiAgICAgICAgb3B0LnNraXBGYWN0b3J5ID0gdHJ1ZTsNCiAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHByb3BzOw0KICB9DQogIGZ1bmN0aW9uIG1lcmdlTW9kZWxzKGEsIGIpIHsNCiAgICBpZiAoIWEgfHwgIWIpIHJldHVybiBhIHx8IGI7DQogICAgaWYgKGlzQXJyYXkoYSkgJiYgaXNBcnJheShiKSkgcmV0dXJuIGEuY29uY2F0KGIpOw0KICAgIHJldHVybiBleHRlbmQoe30sIG5vcm1hbGl6ZVByb3BzT3JFbWl0cyhhKSwgbm9ybWFsaXplUHJvcHNPckVtaXRzKGIpKTsNCiAgfQ0KICBmdW5jdGlvbiBjcmVhdGVQcm9wc1Jlc3RQcm94eShwcm9wcywgZXhjbHVkZWRLZXlzKSB7DQogICAgY29uc3QgcmV0ID0ge307DQogICAgZm9yIChjb25zdCBrZXkgaW4gcHJvcHMpIHsNCiAgICAgIGlmICghZXhjbHVkZWRLZXlzLmluY2x1ZGVzKGtleSkpIHsNCiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHJldCwga2V5LCB7DQogICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwNCiAgICAgICAgICBnZXQ6ICgpID0+IHByb3BzW2tleV0NCiAgICAgICAgfSk7DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiByZXQ7DQogIH0NCiAgZnVuY3Rpb24gd2l0aEFzeW5jQ29udGV4dChnZXRBd2FpdGFibGUpIHsNCiAgICBjb25zdCBjdHggPSBnZXRDdXJyZW50SW5zdGFuY2UoKTsNCiAgICBpZiAoIWN0eCkgew0KICAgICAgd2FybiQxKA0KICAgICAgICBgd2l0aEFzeW5jQ29udGV4dCBjYWxsZWQgd2l0aG91dCBhY3RpdmUgY3VycmVudCBpbnN0YW5jZS4gVGhpcyBpcyBsaWtlbHkgYSBidWcuYA0KICAgICAgKTsNCiAgICB9DQogICAgbGV0IGF3YWl0YWJsZSA9IGdldEF3YWl0YWJsZSgpOw0KICAgIHVuc2V0Q3VycmVudEluc3RhbmNlKCk7DQogICAgaWYgKGlzUHJvbWlzZShhd2FpdGFibGUpKSB7DQogICAgICBhd2FpdGFibGUgPSBhd2FpdGFibGUuY2F0Y2goKGUpID0+IHsNCiAgICAgICAgc2V0Q3VycmVudEluc3RhbmNlKGN0eCk7DQogICAgICAgIHRocm93IGU7DQogICAgICB9KTsNCiAgICB9DQogICAgcmV0dXJuIFthd2FpdGFibGUsICgpID0+IHNldEN1cnJlbnRJbnN0YW5jZShjdHgpXTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGNyZWF0ZUR1cGxpY2F0ZUNoZWNrZXIoKSB7DQogICAgY29uc3QgY2FjaGUgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsNCiAgICByZXR1cm4gKHR5cGUsIGtleSkgPT4gew0KICAgICAgaWYgKGNhY2hlW2tleV0pIHsNCiAgICAgICAgd2FybiQxKGAke3R5cGV9IHByb3BlcnR5ICIke2tleX0iIGlzIGFscmVhZHkgZGVmaW5lZCBpbiAke2NhY2hlW2tleV19LmApOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY2FjaGVba2V5XSA9IHR5cGU7DQogICAgICB9DQogICAgfTsNCiAgfQ0KICBsZXQgc2hvdWxkQ2FjaGVBY2Nlc3MgPSB0cnVlOw0KICBmdW5jdGlvbiBhcHBseU9wdGlvbnMoaW5zdGFuY2UpIHsNCiAgICBjb25zdCBvcHRpb25zID0gcmVzb2x2ZU1lcmdlZE9wdGlvbnMoaW5zdGFuY2UpOw0KICAgIGNvbnN0IHB1YmxpY1RoaXMgPSBpbnN0YW5jZS5wcm94eTsNCiAgICBjb25zdCBjdHggPSBpbnN0YW5jZS5jdHg7DQogICAgc2hvdWxkQ2FjaGVBY2Nlc3MgPSBmYWxzZTsNCiAgICBpZiAob3B0aW9ucy5iZWZvcmVDcmVhdGUpIHsNCiAgICAgIGNhbGxIb29rJDEob3B0aW9ucy5iZWZvcmVDcmVhdGUsIGluc3RhbmNlLCAiYmMiKTsNCiAgICB9DQogICAgY29uc3Qgew0KICAgICAgLy8gc3RhdGUNCiAgICAgIGRhdGE6IGRhdGFPcHRpb25zLA0KICAgICAgY29tcHV0ZWQ6IGNvbXB1dGVkT3B0aW9ucywNCiAgICAgIG1ldGhvZHMsDQogICAgICB3YXRjaDogd2F0Y2hPcHRpb25zLA0KICAgICAgcHJvdmlkZTogcHJvdmlkZU9wdGlvbnMsDQogICAgICBpbmplY3Q6IGluamVjdE9wdGlvbnMsDQogICAgICAvLyBsaWZlY3ljbGUNCiAgICAgIGNyZWF0ZWQsDQogICAgICBiZWZvcmVNb3VudCwNCiAgICAgIG1vdW50ZWQsDQogICAgICBiZWZvcmVVcGRhdGUsDQogICAgICB1cGRhdGVkLA0KICAgICAgYWN0aXZhdGVkLA0KICAgICAgZGVhY3RpdmF0ZWQsDQogICAgICBiZWZvcmVEZXN0cm95LA0KICAgICAgYmVmb3JlVW5tb3VudCwNCiAgICAgIGRlc3Ryb3llZCwNCiAgICAgIHVubW91bnRlZCwNCiAgICAgIHJlbmRlciwNCiAgICAgIHJlbmRlclRyYWNrZWQsDQogICAgICByZW5kZXJUcmlnZ2VyZWQsDQogICAgICBlcnJvckNhcHR1cmVkLA0KICAgICAgc2VydmVyUHJlZmV0Y2gsDQogICAgICAvLyBwdWJsaWMgQVBJDQogICAgICBleHBvc2UsDQogICAgICBpbmhlcml0QXR0cnMsDQogICAgICAvLyBhc3NldHMNCiAgICAgIGNvbXBvbmVudHMsDQogICAgICBkaXJlY3RpdmVzLA0KICAgICAgZmlsdGVycw0KICAgIH0gPSBvcHRpb25zOw0KICAgIGNvbnN0IGNoZWNrRHVwbGljYXRlUHJvcGVydGllcyA9IGNyZWF0ZUR1cGxpY2F0ZUNoZWNrZXIoKSA7DQogICAgew0KICAgICAgY29uc3QgW3Byb3BzT3B0aW9uc10gPSBpbnN0YW5jZS5wcm9wc09wdGlvbnM7DQogICAgICBpZiAocHJvcHNPcHRpb25zKSB7DQogICAgICAgIGZvciAoY29uc3Qga2V5IGluIHByb3BzT3B0aW9ucykgew0KICAgICAgICAgIGNoZWNrRHVwbGljYXRlUHJvcGVydGllcygiUHJvcHMiIC8qIFBST1BTICovLCBrZXkpOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIGlmIChpbmplY3RPcHRpb25zKSB7DQogICAgICByZXNvbHZlSW5qZWN0aW9ucyhpbmplY3RPcHRpb25zLCBjdHgsIGNoZWNrRHVwbGljYXRlUHJvcGVydGllcyk7DQogICAgfQ0KICAgIGlmIChtZXRob2RzKSB7DQogICAgICBmb3IgKGNvbnN0IGtleSBpbiBtZXRob2RzKSB7DQogICAgICAgIGNvbnN0IG1ldGhvZEhhbmRsZXIgPSBtZXRob2RzW2tleV07DQogICAgICAgIGlmIChpc0Z1bmN0aW9uKG1ldGhvZEhhbmRsZXIpKSB7DQogICAgICAgICAgew0KICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGN0eCwga2V5LCB7DQogICAgICAgICAgICAgIHZhbHVlOiBtZXRob2RIYW5kbGVyLmJpbmQocHVibGljVGhpcyksDQogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwNCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwNCiAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgIH0NCiAgICAgICAgICB7DQogICAgICAgICAgICBjaGVja0R1cGxpY2F0ZVByb3BlcnRpZXMoIk1ldGhvZHMiIC8qIE1FVEhPRFMgKi8sIGtleSk7DQogICAgICAgICAgfQ0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHdhcm4kMSgNCiAgICAgICAgICAgIGBNZXRob2QgIiR7a2V5fSIgaGFzIHR5cGUgIiR7dHlwZW9mIG1ldGhvZEhhbmRsZXJ9IiBpbiB0aGUgY29tcG9uZW50IGRlZmluaXRpb24uIERpZCB5b3UgcmVmZXJlbmNlIHRoZSBmdW5jdGlvbiBjb3JyZWN0bHk/YA0KICAgICAgICAgICk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogICAgaWYgKGRhdGFPcHRpb25zKSB7DQogICAgICBpZiAoIWlzRnVuY3Rpb24oZGF0YU9wdGlvbnMpKSB7DQogICAgICAgIHdhcm4kMSgNCiAgICAgICAgICBgVGhlIGRhdGEgb3B0aW9uIG11c3QgYmUgYSBmdW5jdGlvbi4gUGxhaW4gb2JqZWN0IHVzYWdlIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQuYA0KICAgICAgICApOw0KICAgICAgfQ0KICAgICAgY29uc3QgZGF0YSA9IGRhdGFPcHRpb25zLmNhbGwocHVibGljVGhpcywgcHVibGljVGhpcyk7DQogICAgICBpZiAoaXNQcm9taXNlKGRhdGEpKSB7DQogICAgICAgIHdhcm4kMSgNCiAgICAgICAgICBgZGF0YSgpIHJldHVybmVkIGEgUHJvbWlzZSAtIG5vdGUgZGF0YSgpIGNhbm5vdCBiZSBhc3luYzsgSWYgeW91IGludGVuZCB0byBwZXJmb3JtIGRhdGEgZmV0Y2hpbmcgYmVmb3JlIGNvbXBvbmVudCByZW5kZXJzLCB1c2UgYXN5bmMgc2V0dXAoKSArIDxTdXNwZW5zZT4uYA0KICAgICAgICApOw0KICAgICAgfQ0KICAgICAgaWYgKCFpc09iamVjdChkYXRhKSkgew0KICAgICAgICB3YXJuJDEoYGRhdGEoKSBzaG91bGQgcmV0dXJuIGFuIG9iamVjdC5gKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGluc3RhbmNlLmRhdGEgPSByZWFjdGl2ZShkYXRhKTsNCiAgICAgICAgew0KICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIGRhdGEpIHsNCiAgICAgICAgICAgIGNoZWNrRHVwbGljYXRlUHJvcGVydGllcygiRGF0YSIgLyogREFUQSAqLywga2V5KTsNCiAgICAgICAgICAgIGlmICghaXNSZXNlcnZlZFByZWZpeChrZXlbMF0pKSB7DQogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjdHgsIGtleSwgew0KICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLA0KICAgICAgICAgICAgICAgIGdldDogKCkgPT4gZGF0YVtrZXldLA0KICAgICAgICAgICAgICAgIHNldDogTk9PUA0KICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogICAgc2hvdWxkQ2FjaGVBY2Nlc3MgPSB0cnVlOw0KICAgIGlmIChjb21wdXRlZE9wdGlvbnMpIHsNCiAgICAgIGZvciAoY29uc3Qga2V5IGluIGNvbXB1dGVkT3B0aW9ucykgew0KICAgICAgICBjb25zdCBvcHQgPSBjb21wdXRlZE9wdGlvbnNba2V5XTsNCiAgICAgICAgY29uc3QgZ2V0ID0gaXNGdW5jdGlvbihvcHQpID8gb3B0LmJpbmQocHVibGljVGhpcywgcHVibGljVGhpcykgOiBpc0Z1bmN0aW9uKG9wdC5nZXQpID8gb3B0LmdldC5iaW5kKHB1YmxpY1RoaXMsIHB1YmxpY1RoaXMpIDogTk9PUDsNCiAgICAgICAgaWYgKGdldCA9PT0gTk9PUCkgew0KICAgICAgICAgIHdhcm4kMShgQ29tcHV0ZWQgcHJvcGVydHkgIiR7a2V5fSIgaGFzIG5vIGdldHRlci5gKTsNCiAgICAgICAgfQ0KICAgICAgICBjb25zdCBzZXQgPSAhaXNGdW5jdGlvbihvcHQpICYmIGlzRnVuY3Rpb24ob3B0LnNldCkgPyBvcHQuc2V0LmJpbmQocHVibGljVGhpcykgOiAoKSA9PiB7DQogICAgICAgICAgd2FybiQxKA0KICAgICAgICAgICAgYFdyaXRlIG9wZXJhdGlvbiBmYWlsZWQ6IGNvbXB1dGVkIHByb3BlcnR5ICIke2tleX0iIGlzIHJlYWRvbmx5LmANCiAgICAgICAgICApOw0KICAgICAgICB9IDsNCiAgICAgICAgY29uc3QgYyA9IGNvbXB1dGVkKHsNCiAgICAgICAgICBnZXQsDQogICAgICAgICAgc2V0DQogICAgICAgIH0pOw0KICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY3R4LCBrZXksIHsNCiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLA0KICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwNCiAgICAgICAgICBnZXQ6ICgpID0+IGMudmFsdWUsDQogICAgICAgICAgc2V0OiAodikgPT4gYy52YWx1ZSA9IHYNCiAgICAgICAgfSk7DQogICAgICAgIHsNCiAgICAgICAgICBjaGVja0R1cGxpY2F0ZVByb3BlcnRpZXMoIkNvbXB1dGVkIiAvKiBDT01QVVRFRCAqLywga2V5KTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAod2F0Y2hPcHRpb25zKSB7DQogICAgICBmb3IgKGNvbnN0IGtleSBpbiB3YXRjaE9wdGlvbnMpIHsNCiAgICAgICAgY3JlYXRlV2F0Y2hlcih3YXRjaE9wdGlvbnNba2V5XSwgY3R4LCBwdWJsaWNUaGlzLCBrZXkpOw0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAocHJvdmlkZU9wdGlvbnMpIHsNCiAgICAgIGNvbnN0IHByb3ZpZGVzID0gaXNGdW5jdGlvbihwcm92aWRlT3B0aW9ucykgPyBwcm92aWRlT3B0aW9ucy5jYWxsKHB1YmxpY1RoaXMpIDogcHJvdmlkZU9wdGlvbnM7DQogICAgICBSZWZsZWN0Lm93bktleXMocHJvdmlkZXMpLmZvckVhY2goKGtleSkgPT4gew0KICAgICAgICBwcm92aWRlKGtleSwgcHJvdmlkZXNba2V5XSk7DQogICAgICB9KTsNCiAgICB9DQogICAgaWYgKGNyZWF0ZWQpIHsNCiAgICAgIGNhbGxIb29rJDEoY3JlYXRlZCwgaW5zdGFuY2UsICJjIik7DQogICAgfQ0KICAgIGZ1bmN0aW9uIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhyZWdpc3RlciwgaG9vaykgew0KICAgICAgaWYgKGlzQXJyYXkoaG9vaykpIHsNCiAgICAgICAgaG9vay5mb3JFYWNoKChfaG9vaykgPT4gcmVnaXN0ZXIoX2hvb2suYmluZChwdWJsaWNUaGlzKSkpOw0KICAgICAgfSBlbHNlIGlmIChob29rKSB7DQogICAgICAgIHJlZ2lzdGVyKGhvb2suYmluZChwdWJsaWNUaGlzKSk7DQogICAgICB9DQogICAgfQ0KICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvbkJlZm9yZU1vdW50LCBiZWZvcmVNb3VudCk7DQogICAgcmVnaXN0ZXJMaWZlY3ljbGVIb29rKG9uTW91bnRlZCwgbW91bnRlZCk7DQogICAgcmVnaXN0ZXJMaWZlY3ljbGVIb29rKG9uQmVmb3JlVXBkYXRlLCBiZWZvcmVVcGRhdGUpOw0KICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvblVwZGF0ZWQsIHVwZGF0ZWQpOw0KICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvbkFjdGl2YXRlZCwgYWN0aXZhdGVkKTsNCiAgICByZWdpc3RlckxpZmVjeWNsZUhvb2sob25EZWFjdGl2YXRlZCwgZGVhY3RpdmF0ZWQpOw0KICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvbkVycm9yQ2FwdHVyZWQsIGVycm9yQ2FwdHVyZWQpOw0KICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvblJlbmRlclRyYWNrZWQsIHJlbmRlclRyYWNrZWQpOw0KICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvblJlbmRlclRyaWdnZXJlZCwgcmVuZGVyVHJpZ2dlcmVkKTsNCiAgICByZWdpc3RlckxpZmVjeWNsZUhvb2sob25CZWZvcmVVbm1vdW50LCBiZWZvcmVVbm1vdW50KTsNCiAgICByZWdpc3RlckxpZmVjeWNsZUhvb2sob25Vbm1vdW50ZWQsIHVubW91bnRlZCk7DQogICAgcmVnaXN0ZXJMaWZlY3ljbGVIb29rKG9uU2VydmVyUHJlZmV0Y2gsIHNlcnZlclByZWZldGNoKTsNCiAgICBpZiAoaXNBcnJheShleHBvc2UpKSB7DQogICAgICBpZiAoZXhwb3NlLmxlbmd0aCkgew0KICAgICAgICBjb25zdCBleHBvc2VkID0gaW5zdGFuY2UuZXhwb3NlZCB8fCAoaW5zdGFuY2UuZXhwb3NlZCA9IHt9KTsNCiAgICAgICAgZXhwb3NlLmZvckVhY2goKGtleSkgPT4gew0KICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvc2VkLCBrZXksIHsNCiAgICAgICAgICAgIGdldDogKCkgPT4gcHVibGljVGhpc1trZXldLA0KICAgICAgICAgICAgc2V0OiAodmFsKSA9PiBwdWJsaWNUaGlzW2tleV0gPSB2YWwNCiAgICAgICAgICB9KTsNCiAgICAgICAgfSk7DQogICAgICB9IGVsc2UgaWYgKCFpbnN0YW5jZS5leHBvc2VkKSB7DQogICAgICAgIGluc3RhbmNlLmV4cG9zZWQgPSB7fTsNCiAgICAgIH0NCiAgICB9DQogICAgaWYgKHJlbmRlciAmJiBpbnN0YW5jZS5yZW5kZXIgPT09IE5PT1ApIHsNCiAgICAgIGluc3RhbmNlLnJlbmRlciA9IHJlbmRlcjsNCiAgICB9DQogICAgaWYgKGluaGVyaXRBdHRycyAhPSBudWxsKSB7DQogICAgICBpbnN0YW5jZS5pbmhlcml0QXR0cnMgPSBpbmhlcml0QXR0cnM7DQogICAgfQ0KICAgIGlmIChjb21wb25lbnRzKSBpbnN0YW5jZS5jb21wb25lbnRzID0gY29tcG9uZW50czsNCiAgICBpZiAoZGlyZWN0aXZlcykgaW5zdGFuY2UuZGlyZWN0aXZlcyA9IGRpcmVjdGl2ZXM7DQogIH0NCiAgZnVuY3Rpb24gcmVzb2x2ZUluamVjdGlvbnMoaW5qZWN0T3B0aW9ucywgY3R4LCBjaGVja0R1cGxpY2F0ZVByb3BlcnRpZXMgPSBOT09QKSB7DQogICAgaWYgKGlzQXJyYXkoaW5qZWN0T3B0aW9ucykpIHsNCiAgICAgIGluamVjdE9wdGlvbnMgPSBub3JtYWxpemVJbmplY3QoaW5qZWN0T3B0aW9ucyk7DQogICAgfQ0KICAgIGZvciAoY29uc3Qga2V5IGluIGluamVjdE9wdGlvbnMpIHsNCiAgICAgIGNvbnN0IG9wdCA9IGluamVjdE9wdGlvbnNba2V5XTsNCiAgICAgIGxldCBpbmplY3RlZDsNCiAgICAgIGlmIChpc09iamVjdChvcHQpKSB7DQogICAgICAgIGlmICgiZGVmYXVsdCIgaW4gb3B0KSB7DQogICAgICAgICAgaW5qZWN0ZWQgPSBpbmplY3QoDQogICAgICAgICAgICBvcHQuZnJvbSB8fCBrZXksDQogICAgICAgICAgICBvcHQuZGVmYXVsdCwNCiAgICAgICAgICAgIHRydWUNCiAgICAgICAgICApOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGluamVjdGVkID0gaW5qZWN0KG9wdC5mcm9tIHx8IGtleSk7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGluamVjdGVkID0gaW5qZWN0KG9wdCk7DQogICAgICB9DQogICAgICBpZiAoaXNSZWYoaW5qZWN0ZWQpKSB7DQogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjdHgsIGtleSwgew0KICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsDQogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLA0KICAgICAgICAgIGdldDogKCkgPT4gaW5qZWN0ZWQudmFsdWUsDQogICAgICAgICAgc2V0OiAodikgPT4gaW5qZWN0ZWQudmFsdWUgPSB2DQogICAgICAgIH0pOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY3R4W2tleV0gPSBpbmplY3RlZDsNCiAgICAgIH0NCiAgICAgIHsNCiAgICAgICAgY2hlY2tEdXBsaWNhdGVQcm9wZXJ0aWVzKCJJbmplY3QiIC8qIElOSkVDVCAqLywga2V5KTsNCiAgICAgIH0NCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gY2FsbEhvb2skMShob29rLCBpbnN0YW5jZSwgdHlwZSkgew0KICAgIGNhbGxXaXRoQXN5bmNFcnJvckhhbmRsaW5nKA0KICAgICAgaXNBcnJheShob29rKSA/IGhvb2subWFwKChoKSA9PiBoLmJpbmQoaW5zdGFuY2UucHJveHkpKSA6IGhvb2suYmluZChpbnN0YW5jZS5wcm94eSksDQogICAgICBpbnN0YW5jZSwNCiAgICAgIHR5cGUNCiAgICApOw0KICB9DQogIGZ1bmN0aW9uIGNyZWF0ZVdhdGNoZXIocmF3LCBjdHgsIHB1YmxpY1RoaXMsIGtleSkgew0KICAgIGxldCBnZXR0ZXIgPSBrZXkuaW5jbHVkZXMoIi4iKSA/IGNyZWF0ZVBhdGhHZXR0ZXIocHVibGljVGhpcywga2V5KSA6ICgpID0+IHB1YmxpY1RoaXNba2V5XTsNCiAgICBpZiAoaXNTdHJpbmcocmF3KSkgew0KICAgICAgY29uc3QgaGFuZGxlciA9IGN0eFtyYXddOw0KICAgICAgaWYgKGlzRnVuY3Rpb24oaGFuZGxlcikpIHsNCiAgICAgICAgew0KICAgICAgICAgIHdhdGNoKGdldHRlciwgaGFuZGxlcik7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHdhcm4kMShgSW52YWxpZCB3YXRjaCBoYW5kbGVyIHNwZWNpZmllZCBieSBrZXkgIiR7cmF3fSJgLCBoYW5kbGVyKTsNCiAgICAgIH0NCiAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24ocmF3KSkgew0KICAgICAgew0KICAgICAgICB3YXRjaChnZXR0ZXIsIHJhdy5iaW5kKHB1YmxpY1RoaXMpKTsNCiAgICAgIH0NCiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHJhdykpIHsNCiAgICAgIGlmIChpc0FycmF5KHJhdykpIHsNCiAgICAgICAgcmF3LmZvckVhY2goKHIpID0+IGNyZWF0ZVdhdGNoZXIociwgY3R4LCBwdWJsaWNUaGlzLCBrZXkpKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbnN0IGhhbmRsZXIgPSBpc0Z1bmN0aW9uKHJhdy5oYW5kbGVyKSA/IHJhdy5oYW5kbGVyLmJpbmQocHVibGljVGhpcykgOiBjdHhbcmF3LmhhbmRsZXJdOw0KICAgICAgICBpZiAoaXNGdW5jdGlvbihoYW5kbGVyKSkgew0KICAgICAgICAgIHdhdGNoKGdldHRlciwgaGFuZGxlciwgcmF3KTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICB3YXJuJDEoYEludmFsaWQgd2F0Y2ggaGFuZGxlciBzcGVjaWZpZWQgYnkga2V5ICIke3Jhdy5oYW5kbGVyfSJgLCBoYW5kbGVyKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICB3YXJuJDEoYEludmFsaWQgd2F0Y2ggb3B0aW9uOiAiJHtrZXl9ImAsIHJhdyk7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIHJlc29sdmVNZXJnZWRPcHRpb25zKGluc3RhbmNlKSB7DQogICAgY29uc3QgYmFzZSA9IGluc3RhbmNlLnR5cGU7DQogICAgY29uc3QgeyBtaXhpbnMsIGV4dGVuZHM6IGV4dGVuZHNPcHRpb25zIH0gPSBiYXNlOw0KICAgIGNvbnN0IHsNCiAgICAgIG1peGluczogZ2xvYmFsTWl4aW5zLA0KICAgICAgb3B0aW9uc0NhY2hlOiBjYWNoZSwNCiAgICAgIGNvbmZpZzogeyBvcHRpb25NZXJnZVN0cmF0ZWdpZXMgfQ0KICAgIH0gPSBpbnN0YW5jZS5hcHBDb250ZXh0Ow0KICAgIGNvbnN0IGNhY2hlZCA9IGNhY2hlLmdldChiYXNlKTsNCiAgICBsZXQgcmVzb2x2ZWQ7DQogICAgaWYgKGNhY2hlZCkgew0KICAgICAgcmVzb2x2ZWQgPSBjYWNoZWQ7DQogICAgfSBlbHNlIGlmICghZ2xvYmFsTWl4aW5zLmxlbmd0aCAmJiAhbWl4aW5zICYmICFleHRlbmRzT3B0aW9ucykgew0KICAgICAgew0KICAgICAgICByZXNvbHZlZCA9IGJhc2U7DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIHJlc29sdmVkID0ge307DQogICAgICBpZiAoZ2xvYmFsTWl4aW5zLmxlbmd0aCkgew0KICAgICAgICBnbG9iYWxNaXhpbnMuZm9yRWFjaCgNCiAgICAgICAgICAobSkgPT4gbWVyZ2VPcHRpb25zKHJlc29sdmVkLCBtLCBvcHRpb25NZXJnZVN0cmF0ZWdpZXMsIHRydWUpDQogICAgICAgICk7DQogICAgICB9DQogICAgICBtZXJnZU9wdGlvbnMocmVzb2x2ZWQsIGJhc2UsIG9wdGlvbk1lcmdlU3RyYXRlZ2llcyk7DQogICAgfQ0KICAgIGlmIChpc09iamVjdChiYXNlKSkgew0KICAgICAgY2FjaGUuc2V0KGJhc2UsIHJlc29sdmVkKTsNCiAgICB9DQogICAgcmV0dXJuIHJlc29sdmVkOw0KICB9DQogIGZ1bmN0aW9uIG1lcmdlT3B0aW9ucyh0bywgZnJvbSwgc3RyYXRzLCBhc01peGluID0gZmFsc2UpIHsNCiAgICBjb25zdCB7IG1peGlucywgZXh0ZW5kczogZXh0ZW5kc09wdGlvbnMgfSA9IGZyb207DQogICAgaWYgKGV4dGVuZHNPcHRpb25zKSB7DQogICAgICBtZXJnZU9wdGlvbnModG8sIGV4dGVuZHNPcHRpb25zLCBzdHJhdHMsIHRydWUpOw0KICAgIH0NCiAgICBpZiAobWl4aW5zKSB7DQogICAgICBtaXhpbnMuZm9yRWFjaCgNCiAgICAgICAgKG0pID0+IG1lcmdlT3B0aW9ucyh0bywgbSwgc3RyYXRzLCB0cnVlKQ0KICAgICAgKTsNCiAgICB9DQogICAgZm9yIChjb25zdCBrZXkgaW4gZnJvbSkgew0KICAgICAgaWYgKGFzTWl4aW4gJiYga2V5ID09PSAiZXhwb3NlIikgew0KICAgICAgICB3YXJuJDEoDQogICAgICAgICAgYCJleHBvc2UiIG9wdGlvbiBpcyBpZ25vcmVkIHdoZW4gZGVjbGFyZWQgaW4gbWl4aW5zIG9yIGV4dGVuZHMuIEl0IHNob3VsZCBvbmx5IGJlIGRlY2xhcmVkIGluIHRoZSBiYXNlIGNvbXBvbmVudCBpdHNlbGYuYA0KICAgICAgICApOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29uc3Qgc3RyYXQgPSBpbnRlcm5hbE9wdGlvbk1lcmdlU3RyYXRzW2tleV0gfHwgc3RyYXRzICYmIHN0cmF0c1trZXldOw0KICAgICAgICB0b1trZXldID0gc3RyYXQgPyBzdHJhdCh0b1trZXldLCBmcm9tW2tleV0pIDogZnJvbVtrZXldOw0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gdG87DQogIH0NCiAgY29uc3QgaW50ZXJuYWxPcHRpb25NZXJnZVN0cmF0cyA9IHsNCiAgICBkYXRhOiBtZXJnZURhdGFGbiwNCiAgICBwcm9wczogbWVyZ2VFbWl0c09yUHJvcHNPcHRpb25zLA0KICAgIGVtaXRzOiBtZXJnZUVtaXRzT3JQcm9wc09wdGlvbnMsDQogICAgLy8gb2JqZWN0cw0KICAgIG1ldGhvZHM6IG1lcmdlT2JqZWN0T3B0aW9ucywNCiAgICBjb21wdXRlZDogbWVyZ2VPYmplY3RPcHRpb25zLA0KICAgIC8vIGxpZmVjeWNsZQ0KICAgIGJlZm9yZUNyZWF0ZTogbWVyZ2VBc0FycmF5JDEsDQogICAgY3JlYXRlZDogbWVyZ2VBc0FycmF5JDEsDQogICAgYmVmb3JlTW91bnQ6IG1lcmdlQXNBcnJheSQxLA0KICAgIG1vdW50ZWQ6IG1lcmdlQXNBcnJheSQxLA0KICAgIGJlZm9yZVVwZGF0ZTogbWVyZ2VBc0FycmF5JDEsDQogICAgdXBkYXRlZDogbWVyZ2VBc0FycmF5JDEsDQogICAgYmVmb3JlRGVzdHJveTogbWVyZ2VBc0FycmF5JDEsDQogICAgYmVmb3JlVW5tb3VudDogbWVyZ2VBc0FycmF5JDEsDQogICAgZGVzdHJveWVkOiBtZXJnZUFzQXJyYXkkMSwNCiAgICB1bm1vdW50ZWQ6IG1lcmdlQXNBcnJheSQxLA0KICAgIGFjdGl2YXRlZDogbWVyZ2VBc0FycmF5JDEsDQogICAgZGVhY3RpdmF0ZWQ6IG1lcmdlQXNBcnJheSQxLA0KICAgIGVycm9yQ2FwdHVyZWQ6IG1lcmdlQXNBcnJheSQxLA0KICAgIHNlcnZlclByZWZldGNoOiBtZXJnZUFzQXJyYXkkMSwNCiAgICAvLyBhc3NldHMNCiAgICBjb21wb25lbnRzOiBtZXJnZU9iamVjdE9wdGlvbnMsDQogICAgZGlyZWN0aXZlczogbWVyZ2VPYmplY3RPcHRpb25zLA0KICAgIC8vIHdhdGNoDQogICAgd2F0Y2g6IG1lcmdlV2F0Y2hPcHRpb25zLA0KICAgIC8vIHByb3ZpZGUgLyBpbmplY3QNCiAgICBwcm92aWRlOiBtZXJnZURhdGFGbiwNCiAgICBpbmplY3Q6IG1lcmdlSW5qZWN0DQogIH07DQogIGZ1bmN0aW9uIG1lcmdlRGF0YUZuKHRvLCBmcm9tKSB7DQogICAgaWYgKCFmcm9tKSB7DQogICAgICByZXR1cm4gdG87DQogICAgfQ0KICAgIGlmICghdG8pIHsNCiAgICAgIHJldHVybiBmcm9tOw0KICAgIH0NCiAgICByZXR1cm4gZnVuY3Rpb24gbWVyZ2VkRGF0YUZuKCkgew0KICAgICAgcmV0dXJuIChleHRlbmQpKA0KICAgICAgICBpc0Z1bmN0aW9uKHRvKSA/IHRvLmNhbGwodGhpcywgdGhpcykgOiB0bywNCiAgICAgICAgaXNGdW5jdGlvbihmcm9tKSA/IGZyb20uY2FsbCh0aGlzLCB0aGlzKSA6IGZyb20NCiAgICAgICk7DQogICAgfTsNCiAgfQ0KICBmdW5jdGlvbiBtZXJnZUluamVjdCh0bywgZnJvbSkgew0KICAgIHJldHVybiBtZXJnZU9iamVjdE9wdGlvbnMobm9ybWFsaXplSW5qZWN0KHRvKSwgbm9ybWFsaXplSW5qZWN0KGZyb20pKTsNCiAgfQ0KICBmdW5jdGlvbiBub3JtYWxpemVJbmplY3QocmF3KSB7DQogICAgaWYgKGlzQXJyYXkocmF3KSkgew0KICAgICAgY29uc3QgcmVzID0ge307DQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJhdy5sZW5ndGg7IGkrKykgew0KICAgICAgICByZXNbcmF3W2ldXSA9IHJhd1tpXTsNCiAgICAgIH0NCiAgICAgIHJldHVybiByZXM7DQogICAgfQ0KICAgIHJldHVybiByYXc7DQogIH0NCiAgZnVuY3Rpb24gbWVyZ2VBc0FycmF5JDEodG8sIGZyb20pIHsNCiAgICByZXR1cm4gdG8gPyBbLi4ubmV3IFNldChbXS5jb25jYXQodG8sIGZyb20pKV0gOiBmcm9tOw0KICB9DQogIGZ1bmN0aW9uIG1lcmdlT2JqZWN0T3B0aW9ucyh0bywgZnJvbSkgew0KICAgIHJldHVybiB0byA/IGV4dGVuZCgvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKSwgdG8sIGZyb20pIDogZnJvbTsNCiAgfQ0KICBmdW5jdGlvbiBtZXJnZUVtaXRzT3JQcm9wc09wdGlvbnModG8sIGZyb20pIHsNCiAgICBpZiAodG8pIHsNCiAgICAgIGlmIChpc0FycmF5KHRvKSAmJiBpc0FycmF5KGZyb20pKSB7DQogICAgICAgIHJldHVybiBbLi4uLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWy4uLnRvLCAuLi5mcm9tXSldOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIGV4dGVuZCgNCiAgICAgICAgLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCksDQogICAgICAgIG5vcm1hbGl6ZVByb3BzT3JFbWl0cyh0byksDQogICAgICAgIG5vcm1hbGl6ZVByb3BzT3JFbWl0cyhmcm9tICE9IG51bGwgPyBmcm9tIDoge30pDQogICAgICApOw0KICAgIH0gZWxzZSB7DQogICAgICByZXR1cm4gZnJvbTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gbWVyZ2VXYXRjaE9wdGlvbnModG8sIGZyb20pIHsNCiAgICBpZiAoIXRvKSByZXR1cm4gZnJvbTsNCiAgICBpZiAoIWZyb20pIHJldHVybiB0bzsNCiAgICBjb25zdCBtZXJnZWQgPSBleHRlbmQoLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCksIHRvKTsNCiAgICBmb3IgKGNvbnN0IGtleSBpbiBmcm9tKSB7DQogICAgICBtZXJnZWRba2V5XSA9IG1lcmdlQXNBcnJheSQxKHRvW2tleV0sIGZyb21ba2V5XSk7DQogICAgfQ0KICAgIHJldHVybiBtZXJnZWQ7DQogIH0NCg0KICBmdW5jdGlvbiBjcmVhdGVBcHBDb250ZXh0KCkgew0KICAgIHJldHVybiB7DQogICAgICBhcHA6IG51bGwsDQogICAgICBjb25maWc6IHsNCiAgICAgICAgaXNOYXRpdmVUYWc6IE5PLA0KICAgICAgICBwZXJmb3JtYW5jZTogZmFsc2UsDQogICAgICAgIGdsb2JhbFByb3BlcnRpZXM6IHt9LA0KICAgICAgICBvcHRpb25NZXJnZVN0cmF0ZWdpZXM6IHt9LA0KICAgICAgICBlcnJvckhhbmRsZXI6IHZvaWQgMCwNCiAgICAgICAgd2FybkhhbmRsZXI6IHZvaWQgMCwNCiAgICAgICAgY29tcGlsZXJPcHRpb25zOiB7fQ0KICAgICAgfSwNCiAgICAgIG1peGluczogW10sDQogICAgICBjb21wb25lbnRzOiB7fSwNCiAgICAgIGRpcmVjdGl2ZXM6IHt9LA0KICAgICAgcHJvdmlkZXM6IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpLA0KICAgICAgb3B0aW9uc0NhY2hlOiAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKSwNCiAgICAgIHByb3BzQ2FjaGU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpLA0KICAgICAgZW1pdHNDYWNoZTogLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCkNCiAgICB9Ow0KICB9DQogIGxldCB1aWQkMSA9IDA7DQogIGZ1bmN0aW9uIGNyZWF0ZUFwcEFQSShyZW5kZXIsIGh5ZHJhdGUpIHsNCiAgICByZXR1cm4gZnVuY3Rpb24gY3JlYXRlQXBwKHJvb3RDb21wb25lbnQsIHJvb3RQcm9wcyA9IG51bGwpIHsNCiAgICAgIGlmICghaXNGdW5jdGlvbihyb290Q29tcG9uZW50KSkgew0KICAgICAgICByb290Q29tcG9uZW50ID0gZXh0ZW5kKHt9LCByb290Q29tcG9uZW50KTsNCiAgICAgIH0NCiAgICAgIGlmIChyb290UHJvcHMgIT0gbnVsbCAmJiAhaXNPYmplY3Qocm9vdFByb3BzKSkgew0KICAgICAgICB3YXJuJDEoYHJvb3QgcHJvcHMgcGFzc2VkIHRvIGFwcC5tb3VudCgpIG11c3QgYmUgYW4gb2JqZWN0LmApOw0KICAgICAgICByb290UHJvcHMgPSBudWxsOw0KICAgICAgfQ0KICAgICAgY29uc3QgY29udGV4dCA9IGNyZWF0ZUFwcENvbnRleHQoKTsNCiAgICAgIGNvbnN0IGluc3RhbGxlZFBsdWdpbnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKTsNCiAgICAgIGNvbnN0IHBsdWdpbkNsZWFudXBGbnMgPSBbXTsNCiAgICAgIGxldCBpc01vdW50ZWQgPSBmYWxzZTsNCiAgICAgIGNvbnN0IGFwcCA9IGNvbnRleHQuYXBwID0gew0KICAgICAgICBfdWlkOiB1aWQkMSsrLA0KICAgICAgICBfY29tcG9uZW50OiByb290Q29tcG9uZW50LA0KICAgICAgICBfcHJvcHM6IHJvb3RQcm9wcywNCiAgICAgICAgX2NvbnRhaW5lcjogbnVsbCwNCiAgICAgICAgX2NvbnRleHQ6IGNvbnRleHQsDQogICAgICAgIF9pbnN0YW5jZTogbnVsbCwNCiAgICAgICAgdmVyc2lvbiwNCiAgICAgICAgZ2V0IGNvbmZpZygpIHsNCiAgICAgICAgICByZXR1cm4gY29udGV4dC5jb25maWc7DQogICAgICAgIH0sDQogICAgICAgIHNldCBjb25maWcodikgew0KICAgICAgICAgIHsNCiAgICAgICAgICAgIHdhcm4kMSgNCiAgICAgICAgICAgICAgYGFwcC5jb25maWcgY2Fubm90IGJlIHJlcGxhY2VkLiBNb2RpZnkgaW5kaXZpZHVhbCBvcHRpb25zIGluc3RlYWQuYA0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9DQogICAgICAgIH0sDQogICAgICAgIHVzZShwbHVnaW4sIC4uLm9wdGlvbnMpIHsNCiAgICAgICAgICBpZiAoaW5zdGFsbGVkUGx1Z2lucy5oYXMocGx1Z2luKSkgew0KICAgICAgICAgICAgd2FybiQxKGBQbHVnaW4gaGFzIGFscmVhZHkgYmVlbiBhcHBsaWVkIHRvIHRhcmdldCBhcHAuYCk7DQogICAgICAgICAgfSBlbHNlIGlmIChwbHVnaW4gJiYgaXNGdW5jdGlvbihwbHVnaW4uaW5zdGFsbCkpIHsNCiAgICAgICAgICAgIGluc3RhbGxlZFBsdWdpbnMuYWRkKHBsdWdpbik7DQogICAgICAgICAgICBwbHVnaW4uaW5zdGFsbChhcHAsIC4uLm9wdGlvbnMpOw0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNGdW5jdGlvbihwbHVnaW4pKSB7DQogICAgICAgICAgICBpbnN0YWxsZWRQbHVnaW5zLmFkZChwbHVnaW4pOw0KICAgICAgICAgICAgcGx1Z2luKGFwcCwgLi4ub3B0aW9ucyk7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHdhcm4kMSgNCiAgICAgICAgICAgICAgYEEgcGx1Z2luIG11c3QgZWl0aGVyIGJlIGEgZnVuY3Rpb24gb3IgYW4gb2JqZWN0IHdpdGggYW4gImluc3RhbGwiIGZ1bmN0aW9uLmANCiAgICAgICAgICAgICk7DQogICAgICAgICAgfQ0KICAgICAgICAgIHJldHVybiBhcHA7DQogICAgICAgIH0sDQogICAgICAgIG1peGluKG1peGluKSB7DQogICAgICAgICAgew0KICAgICAgICAgICAgaWYgKCFjb250ZXh0Lm1peGlucy5pbmNsdWRlcyhtaXhpbikpIHsNCiAgICAgICAgICAgICAgY29udGV4dC5taXhpbnMucHVzaChtaXhpbik7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICB3YXJuJDEoDQogICAgICAgICAgICAgICAgIk1peGluIGhhcyBhbHJlYWR5IGJlZW4gYXBwbGllZCB0byB0YXJnZXQgYXBwIiArIChtaXhpbi5uYW1lID8gYDogJHttaXhpbi5uYW1lfWAgOiAiIikNCiAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgICAgcmV0dXJuIGFwcDsNCiAgICAgICAgfSwNCiAgICAgICAgY29tcG9uZW50KG5hbWUsIGNvbXBvbmVudCkgew0KICAgICAgICAgIHsNCiAgICAgICAgICAgIHZhbGlkYXRlQ29tcG9uZW50TmFtZShuYW1lLCBjb250ZXh0LmNvbmZpZyk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmICghY29tcG9uZW50KSB7DQogICAgICAgICAgICByZXR1cm4gY29udGV4dC5jb21wb25lbnRzW25hbWVdOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpZiAoY29udGV4dC5jb21wb25lbnRzW25hbWVdKSB7DQogICAgICAgICAgICB3YXJuJDEoYENvbXBvbmVudCAiJHtuYW1lfSIgaGFzIGFscmVhZHkgYmVlbiByZWdpc3RlcmVkIGluIHRhcmdldCBhcHAuYCk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNvbnRleHQuY29tcG9uZW50c1tuYW1lXSA9IGNvbXBvbmVudDsNCiAgICAgICAgICByZXR1cm4gYXBwOw0KICAgICAgICB9LA0KICAgICAgICBkaXJlY3RpdmUobmFtZSwgZGlyZWN0aXZlKSB7DQogICAgICAgICAgew0KICAgICAgICAgICAgdmFsaWRhdGVEaXJlY3RpdmVOYW1lKG5hbWUpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpZiAoIWRpcmVjdGl2ZSkgew0KICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuZGlyZWN0aXZlc1tuYW1lXTsNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKGNvbnRleHQuZGlyZWN0aXZlc1tuYW1lXSkgew0KICAgICAgICAgICAgd2FybiQxKGBEaXJlY3RpdmUgIiR7bmFtZX0iIGhhcyBhbHJlYWR5IGJlZW4gcmVnaXN0ZXJlZCBpbiB0YXJnZXQgYXBwLmApOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjb250ZXh0LmRpcmVjdGl2ZXNbbmFtZV0gPSBkaXJlY3RpdmU7DQogICAgICAgICAgcmV0dXJuIGFwcDsNCiAgICAgICAgfSwNCiAgICAgICAgbW91bnQocm9vdENvbnRhaW5lciwgaXNIeWRyYXRlLCBuYW1lc3BhY2UpIHsNCiAgICAgICAgICBpZiAoIWlzTW91bnRlZCkgew0KICAgICAgICAgICAgaWYgKHJvb3RDb250YWluZXIuX192dWVfYXBwX18pIHsNCiAgICAgICAgICAgICAgd2FybiQxKA0KICAgICAgICAgICAgICAgIGBUaGVyZSBpcyBhbHJlYWR5IGFuIGFwcCBpbnN0YW5jZSBtb3VudGVkIG9uIHRoZSBob3N0IGNvbnRhaW5lci4NCiBJZiB5b3Ugd2FudCB0byBtb3VudCBhbm90aGVyIGFwcCBvbiB0aGUgc2FtZSBob3N0IGNvbnRhaW5lciwgeW91IG5lZWQgdG8gdW5tb3VudCB0aGUgcHJldmlvdXMgYXBwIGJ5IGNhbGxpbmcgXGBhcHAudW5tb3VudCgpXGAgZmlyc3QuYA0KICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY29uc3Qgdm5vZGUgPSBhcHAuX2NlVk5vZGUgfHwgY3JlYXRlVk5vZGUocm9vdENvbXBvbmVudCwgcm9vdFByb3BzKTsNCiAgICAgICAgICAgIHZub2RlLmFwcENvbnRleHQgPSBjb250ZXh0Ow0KICAgICAgICAgICAgaWYgKG5hbWVzcGFjZSA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgICBuYW1lc3BhY2UgPSAic3ZnIjsNCiAgICAgICAgICAgIH0gZWxzZSBpZiAobmFtZXNwYWNlID09PSBmYWxzZSkgew0KICAgICAgICAgICAgICBuYW1lc3BhY2UgPSB2b2lkIDA7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB7DQogICAgICAgICAgICAgIGNvbnRleHQucmVsb2FkID0gKCkgPT4gew0KICAgICAgICAgICAgICAgIGNvbnN0IGNsb25lZCA9IGNsb25lVk5vZGUodm5vZGUpOw0KICAgICAgICAgICAgICAgIGNsb25lZC5lbCA9IG51bGw7DQogICAgICAgICAgICAgICAgcmVuZGVyKGNsb25lZCwgcm9vdENvbnRhaW5lciwgbmFtZXNwYWNlKTsNCiAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChpc0h5ZHJhdGUgJiYgaHlkcmF0ZSkgew0KICAgICAgICAgICAgICBoeWRyYXRlKHZub2RlLCByb290Q29udGFpbmVyKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgIHJlbmRlcih2bm9kZSwgcm9vdENvbnRhaW5lciwgbmFtZXNwYWNlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlzTW91bnRlZCA9IHRydWU7DQogICAgICAgICAgICBhcHAuX2NvbnRhaW5lciA9IHJvb3RDb250YWluZXI7DQogICAgICAgICAgICByb290Q29udGFpbmVyLl9fdnVlX2FwcF9fID0gYXBwOw0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICBhcHAuX2luc3RhbmNlID0gdm5vZGUuY29tcG9uZW50Ow0KICAgICAgICAgICAgICBkZXZ0b29sc0luaXRBcHAoYXBwLCB2ZXJzaW9uKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnRQdWJsaWNJbnN0YW5jZSh2bm9kZS5jb21wb25lbnQpOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICB3YXJuJDEoDQogICAgICAgICAgICAgIGBBcHAgaGFzIGFscmVhZHkgYmVlbiBtb3VudGVkLg0KSWYgeW91IHdhbnQgdG8gcmVtb3VudCB0aGUgc2FtZSBhcHAsIG1vdmUgeW91ciBhcHAgY3JlYXRpb24gbG9naWMgaW50byBhIGZhY3RvcnkgZnVuY3Rpb24gYW5kIGNyZWF0ZSBmcmVzaCBhcHAgaW5zdGFuY2VzIGZvciBlYWNoIG1vdW50IC0gZS5nLiBcYGNvbnN0IGNyZWF0ZU15QXBwID0gKCkgPT4gY3JlYXRlQXBwKEFwcClcYGANCiAgICAgICAgICAgICk7DQogICAgICAgICAgfQ0KICAgICAgICB9LA0KICAgICAgICBvblVubW91bnQoY2xlYW51cEZuKSB7DQogICAgICAgICAgaWYgKHR5cGVvZiBjbGVhbnVwRm4gIT09ICJmdW5jdGlvbiIpIHsNCiAgICAgICAgICAgIHdhcm4kMSgNCiAgICAgICAgICAgICAgYEV4cGVjdGVkIGZ1bmN0aW9uIGFzIGZpcnN0IGFyZ3VtZW50IHRvIGFwcC5vblVubW91bnQoKSwgYnV0IGdvdCAke3R5cGVvZiBjbGVhbnVwRm59YA0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9DQogICAgICAgICAgcGx1Z2luQ2xlYW51cEZucy5wdXNoKGNsZWFudXBGbik7DQogICAgICAgIH0sDQogICAgICAgIHVubW91bnQoKSB7DQogICAgICAgICAgaWYgKGlzTW91bnRlZCkgew0KICAgICAgICAgICAgY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoDQogICAgICAgICAgICAgIHBsdWdpbkNsZWFudXBGbnMsDQogICAgICAgICAgICAgIGFwcC5faW5zdGFuY2UsDQogICAgICAgICAgICAgIDE2DQogICAgICAgICAgICApOw0KICAgICAgICAgICAgcmVuZGVyKG51bGwsIGFwcC5fY29udGFpbmVyKTsNCiAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgYXBwLl9pbnN0YW5jZSA9IG51bGw7DQogICAgICAgICAgICAgIGRldnRvb2xzVW5tb3VudEFwcChhcHApOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZGVsZXRlIGFwcC5fY29udGFpbmVyLl9fdnVlX2FwcF9fOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICB3YXJuJDEoYENhbm5vdCB1bm1vdW50IGFuIGFwcCB0aGF0IGlzIG5vdCBtb3VudGVkLmApOw0KICAgICAgICAgIH0NCiAgICAgICAgfSwNCiAgICAgICAgcHJvdmlkZShrZXksIHZhbHVlKSB7DQogICAgICAgICAgaWYgKGtleSBpbiBjb250ZXh0LnByb3ZpZGVzKSB7DQogICAgICAgICAgICBpZiAoaGFzT3duKGNvbnRleHQucHJvdmlkZXMsIGtleSkpIHsNCiAgICAgICAgICAgICAgd2FybiQxKA0KICAgICAgICAgICAgICAgIGBBcHAgYWxyZWFkeSBwcm92aWRlcyBwcm9wZXJ0eSB3aXRoIGtleSAiJHtTdHJpbmcoa2V5KX0iLiBJdCB3aWxsIGJlIG92ZXJ3cml0dGVuIHdpdGggdGhlIG5ldyB2YWx1ZS5gDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICB3YXJuJDEoDQogICAgICAgICAgICAgICAgYEFwcCBhbHJlYWR5IHByb3ZpZGVzIHByb3BlcnR5IHdpdGgga2V5ICIke1N0cmluZyhrZXkpfSIgaW5oZXJpdGVkIGZyb20gaXRzIHBhcmVudCBlbGVtZW50LiBJdCB3aWxsIGJlIG92ZXJ3cml0dGVuIHdpdGggdGhlIG5ldyB2YWx1ZS5gDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICAgIGNvbnRleHQucHJvdmlkZXNba2V5XSA9IHZhbHVlOw0KICAgICAgICAgIHJldHVybiBhcHA7DQogICAgICAgIH0sDQogICAgICAgIHJ1bldpdGhDb250ZXh0KGZuKSB7DQogICAgICAgICAgY29uc3QgbGFzdEFwcCA9IGN1cnJlbnRBcHA7DQogICAgICAgICAgY3VycmVudEFwcCA9IGFwcDsNCiAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgcmV0dXJuIGZuKCk7DQogICAgICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgICAgIGN1cnJlbnRBcHAgPSBsYXN0QXBwOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfTsNCiAgICAgIHJldHVybiBhcHA7DQogICAgfTsNCiAgfQ0KICBsZXQgY3VycmVudEFwcCA9IG51bGw7DQoNCiAgZnVuY3Rpb24gcHJvdmlkZShrZXksIHZhbHVlKSB7DQogICAgaWYgKCFjdXJyZW50SW5zdGFuY2UpIHsNCiAgICAgIHsNCiAgICAgICAgd2FybiQxKGBwcm92aWRlKCkgY2FuIG9ubHkgYmUgdXNlZCBpbnNpZGUgc2V0dXAoKS5gKTsNCiAgICAgIH0NCiAgICB9IGVsc2Ugew0KICAgICAgbGV0IHByb3ZpZGVzID0gY3VycmVudEluc3RhbmNlLnByb3ZpZGVzOw0KICAgICAgY29uc3QgcGFyZW50UHJvdmlkZXMgPSBjdXJyZW50SW5zdGFuY2UucGFyZW50ICYmIGN1cnJlbnRJbnN0YW5jZS5wYXJlbnQucHJvdmlkZXM7DQogICAgICBpZiAocGFyZW50UHJvdmlkZXMgPT09IHByb3ZpZGVzKSB7DQogICAgICAgIHByb3ZpZGVzID0gY3VycmVudEluc3RhbmNlLnByb3ZpZGVzID0gT2JqZWN0LmNyZWF0ZShwYXJlbnRQcm92aWRlcyk7DQogICAgICB9DQogICAgICBwcm92aWRlc1trZXldID0gdmFsdWU7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGluamVjdChrZXksIGRlZmF1bHRWYWx1ZSwgdHJlYXREZWZhdWx0QXNGYWN0b3J5ID0gZmFsc2UpIHsNCiAgICBjb25zdCBpbnN0YW5jZSA9IGN1cnJlbnRJbnN0YW5jZSB8fCBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2U7DQogICAgaWYgKGluc3RhbmNlIHx8IGN1cnJlbnRBcHApIHsNCiAgICAgIGxldCBwcm92aWRlcyA9IGN1cnJlbnRBcHAgPyBjdXJyZW50QXBwLl9jb250ZXh0LnByb3ZpZGVzIDogaW5zdGFuY2UgPyBpbnN0YW5jZS5wYXJlbnQgPT0gbnVsbCB8fCBpbnN0YW5jZS5jZSA/IGluc3RhbmNlLnZub2RlLmFwcENvbnRleHQgJiYgaW5zdGFuY2Uudm5vZGUuYXBwQ29udGV4dC5wcm92aWRlcyA6IGluc3RhbmNlLnBhcmVudC5wcm92aWRlcyA6IHZvaWQgMDsNCiAgICAgIGlmIChwcm92aWRlcyAmJiBrZXkgaW4gcHJvdmlkZXMpIHsNCiAgICAgICAgcmV0dXJuIHByb3ZpZGVzW2tleV07DQogICAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7DQogICAgICAgIHJldHVybiB0cmVhdERlZmF1bHRBc0ZhY3RvcnkgJiYgaXNGdW5jdGlvbihkZWZhdWx0VmFsdWUpID8gZGVmYXVsdFZhbHVlLmNhbGwoaW5zdGFuY2UgJiYgaW5zdGFuY2UucHJveHkpIDogZGVmYXVsdFZhbHVlOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgd2FybiQxKGBpbmplY3Rpb24gIiR7U3RyaW5nKGtleSl9IiBub3QgZm91bmQuYCk7DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIHdhcm4kMShgaW5qZWN0KCkgY2FuIG9ubHkgYmUgdXNlZCBpbnNpZGUgc2V0dXAoKSBvciBmdW5jdGlvbmFsIGNvbXBvbmVudHMuYCk7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGhhc0luamVjdGlvbkNvbnRleHQoKSB7DQogICAgcmV0dXJuICEhKGN1cnJlbnRJbnN0YW5jZSB8fCBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UgfHwgY3VycmVudEFwcCk7DQogIH0NCg0KICBjb25zdCBpbnRlcm5hbE9iamVjdFByb3RvID0ge307DQogIGNvbnN0IGNyZWF0ZUludGVybmFsT2JqZWN0ID0gKCkgPT4gT2JqZWN0LmNyZWF0ZShpbnRlcm5hbE9iamVjdFByb3RvKTsNCiAgY29uc3QgaXNJbnRlcm5hbE9iamVjdCA9IChvYmopID0+IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmopID09PSBpbnRlcm5hbE9iamVjdFByb3RvOw0KDQogIGZ1bmN0aW9uIGluaXRQcm9wcyhpbnN0YW5jZSwgcmF3UHJvcHMsIGlzU3RhdGVmdWwsIGlzU1NSID0gZmFsc2UpIHsNCiAgICBjb25zdCBwcm9wcyA9IHt9Ow0KICAgIGNvbnN0IGF0dHJzID0gY3JlYXRlSW50ZXJuYWxPYmplY3QoKTsNCiAgICBpbnN0YW5jZS5wcm9wc0RlZmF1bHRzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7DQogICAgc2V0RnVsbFByb3BzKGluc3RhbmNlLCByYXdQcm9wcywgcHJvcHMsIGF0dHJzKTsNCiAgICBmb3IgKGNvbnN0IGtleSBpbiBpbnN0YW5jZS5wcm9wc09wdGlvbnNbMF0pIHsNCiAgICAgIGlmICghKGtleSBpbiBwcm9wcykpIHsNCiAgICAgICAgcHJvcHNba2V5XSA9IHZvaWQgMDsNCiAgICAgIH0NCiAgICB9DQogICAgew0KICAgICAgdmFsaWRhdGVQcm9wcyhyYXdQcm9wcyB8fCB7fSwgcHJvcHMsIGluc3RhbmNlKTsNCiAgICB9DQogICAgaWYgKGlzU3RhdGVmdWwpIHsNCiAgICAgIGluc3RhbmNlLnByb3BzID0gaXNTU1IgPyBwcm9wcyA6IHNoYWxsb3dSZWFjdGl2ZShwcm9wcyk7DQogICAgfSBlbHNlIHsNCiAgICAgIGlmICghaW5zdGFuY2UudHlwZS5wcm9wcykgew0KICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IGF0dHJzOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBwcm9wczsNCiAgICAgIH0NCiAgICB9DQogICAgaW5zdGFuY2UuYXR0cnMgPSBhdHRyczsNCiAgfQ0KICBmdW5jdGlvbiBpc0luSG1yQ29udGV4dChpbnN0YW5jZSkgew0KICAgIHdoaWxlIChpbnN0YW5jZSkgew0KICAgICAgaWYgKGluc3RhbmNlLnR5cGUuX19obXJJZCkgcmV0dXJuIHRydWU7DQogICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLnBhcmVudDsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gdXBkYXRlUHJvcHMoaW5zdGFuY2UsIHJhd1Byb3BzLCByYXdQcmV2UHJvcHMsIG9wdGltaXplZCkgew0KICAgIGNvbnN0IHsNCiAgICAgIHByb3BzLA0KICAgICAgYXR0cnMsDQogICAgICB2bm9kZTogeyBwYXRjaEZsYWcgfQ0KICAgIH0gPSBpbnN0YW5jZTsNCiAgICBjb25zdCByYXdDdXJyZW50UHJvcHMgPSB0b1Jhdyhwcm9wcyk7DQogICAgY29uc3QgW29wdGlvbnNdID0gaW5zdGFuY2UucHJvcHNPcHRpb25zOw0KICAgIGxldCBoYXNBdHRyc0NoYW5nZWQgPSBmYWxzZTsNCiAgICBpZiAoDQogICAgICAvLyBhbHdheXMgZm9yY2UgZnVsbCBkaWZmIGluIGRldg0KICAgICAgLy8gLSAjMTk0MiBpZiBobXIgaXMgZW5hYmxlZCB3aXRoIHNmYyBjb21wb25lbnQNCiAgICAgIC8vIC0gdml0ZSM4NzIgbm9uLXNmYyBjb21wb25lbnQgdXNlZCBieSBzZmMgY29tcG9uZW50DQogICAgICAhaXNJbkhtckNvbnRleHQoaW5zdGFuY2UpICYmIChvcHRpbWl6ZWQgfHwgcGF0Y2hGbGFnID4gMCkgJiYgIShwYXRjaEZsYWcgJiAxNikNCiAgICApIHsNCiAgICAgIGlmIChwYXRjaEZsYWcgJiA4KSB7DQogICAgICAgIGNvbnN0IHByb3BzVG9VcGRhdGUgPSBpbnN0YW5jZS52bm9kZS5keW5hbWljUHJvcHM7DQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcHNUb1VwZGF0ZS5sZW5ndGg7IGkrKykgew0KICAgICAgICAgIGxldCBrZXkgPSBwcm9wc1RvVXBkYXRlW2ldOw0KICAgICAgICAgIGlmIChpc0VtaXRMaXN0ZW5lcihpbnN0YW5jZS5lbWl0c09wdGlvbnMsIGtleSkpIHsNCiAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHJhd1Byb3BzW2tleV07DQogICAgICAgICAgaWYgKG9wdGlvbnMpIHsNCiAgICAgICAgICAgIGlmIChoYXNPd24oYXR0cnMsIGtleSkpIHsNCiAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSBhdHRyc1trZXldKSB7DQogICAgICAgICAgICAgICAgYXR0cnNba2V5XSA9IHZhbHVlOw0KICAgICAgICAgICAgICAgIGhhc0F0dHJzQ2hhbmdlZCA9IHRydWU7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgIGNvbnN0IGNhbWVsaXplZEtleSA9IGNhbWVsaXplKGtleSk7DQogICAgICAgICAgICAgIHByb3BzW2NhbWVsaXplZEtleV0gPSByZXNvbHZlUHJvcFZhbHVlKA0KICAgICAgICAgICAgICAgIG9wdGlvbnMsDQogICAgICAgICAgICAgICAgcmF3Q3VycmVudFByb3BzLA0KICAgICAgICAgICAgICAgIGNhbWVsaXplZEtleSwNCiAgICAgICAgICAgICAgICB2YWx1ZSwNCiAgICAgICAgICAgICAgICBpbnN0YW5jZSwNCiAgICAgICAgICAgICAgICBmYWxzZQ0KICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBpZiAodmFsdWUgIT09IGF0dHJzW2tleV0pIHsNCiAgICAgICAgICAgICAgYXR0cnNba2V5XSA9IHZhbHVlOw0KICAgICAgICAgICAgICBoYXNBdHRyc0NoYW5nZWQgPSB0cnVlOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICBpZiAoc2V0RnVsbFByb3BzKGluc3RhbmNlLCByYXdQcm9wcywgcHJvcHMsIGF0dHJzKSkgew0KICAgICAgICBoYXNBdHRyc0NoYW5nZWQgPSB0cnVlOw0KICAgICAgfQ0KICAgICAgbGV0IGtlYmFiS2V5Ow0KICAgICAgZm9yIChjb25zdCBrZXkgaW4gcmF3Q3VycmVudFByb3BzKSB7DQogICAgICAgIGlmICghcmF3UHJvcHMgfHwgLy8gZm9yIGNhbWVsQ2FzZQ0KICAgICAgICAhaGFzT3duKHJhd1Byb3BzLCBrZXkpICYmIC8vIGl0J3MgcG9zc2libGUgdGhlIG9yaWdpbmFsIHByb3BzIHdhcyBwYXNzZWQgaW4gYXMga2ViYWItY2FzZQ0KICAgICAgICAvLyBhbmQgY29udmVydGVkIHRvIGNhbWVsQ2FzZSAoIzk1NSkNCiAgICAgICAgKChrZWJhYktleSA9IGh5cGhlbmF0ZShrZXkpKSA9PT0ga2V5IHx8ICFoYXNPd24ocmF3UHJvcHMsIGtlYmFiS2V5KSkpIHsNCiAgICAgICAgICBpZiAob3B0aW9ucykgew0KICAgICAgICAgICAgaWYgKHJhd1ByZXZQcm9wcyAmJiAvLyBmb3IgY2FtZWxDYXNlDQogICAgICAgICAgICAocmF3UHJldlByb3BzW2tleV0gIT09IHZvaWQgMCB8fCAvLyBmb3Iga2ViYWItY2FzZQ0KICAgICAgICAgICAgcmF3UHJldlByb3BzW2tlYmFiS2V5XSAhPT0gdm9pZCAwKSkgew0KICAgICAgICAgICAgICBwcm9wc1trZXldID0gcmVzb2x2ZVByb3BWYWx1ZSgNCiAgICAgICAgICAgICAgICBvcHRpb25zLA0KICAgICAgICAgICAgICAgIHJhd0N1cnJlbnRQcm9wcywNCiAgICAgICAgICAgICAgICBrZXksDQogICAgICAgICAgICAgICAgdm9pZCAwLA0KICAgICAgICAgICAgICAgIGluc3RhbmNlLA0KICAgICAgICAgICAgICAgIHRydWUNCiAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgZGVsZXRlIHByb3BzW2tleV07DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgICBpZiAoYXR0cnMgIT09IHJhd0N1cnJlbnRQcm9wcykgew0KICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBhdHRycykgew0KICAgICAgICAgIGlmICghcmF3UHJvcHMgfHwgIWhhc093bihyYXdQcm9wcywga2V5KSAmJiB0cnVlKSB7DQogICAgICAgICAgICBkZWxldGUgYXR0cnNba2V5XTsNCiAgICAgICAgICAgIGhhc0F0dHJzQ2hhbmdlZCA9IHRydWU7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIGlmIChoYXNBdHRyc0NoYW5nZWQpIHsNCiAgICAgIHRyaWdnZXIoaW5zdGFuY2UuYXR0cnMsICJzZXQiLCAiIik7DQogICAgfQ0KICAgIHsNCiAgICAgIHZhbGlkYXRlUHJvcHMocmF3UHJvcHMgfHwge30sIHByb3BzLCBpbnN0YW5jZSk7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIHNldEZ1bGxQcm9wcyhpbnN0YW5jZSwgcmF3UHJvcHMsIHByb3BzLCBhdHRycykgew0KICAgIGNvbnN0IFtvcHRpb25zLCBuZWVkQ2FzdEtleXNdID0gaW5zdGFuY2UucHJvcHNPcHRpb25zOw0KICAgIGxldCBoYXNBdHRyc0NoYW5nZWQgPSBmYWxzZTsNCiAgICBsZXQgcmF3Q2FzdFZhbHVlczsNCiAgICBpZiAocmF3UHJvcHMpIHsNCiAgICAgIGZvciAobGV0IGtleSBpbiByYXdQcm9wcykgew0KICAgICAgICBpZiAoaXNSZXNlcnZlZFByb3Aoa2V5KSkgew0KICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICB9DQogICAgICAgIGNvbnN0IHZhbHVlID0gcmF3UHJvcHNba2V5XTsNCiAgICAgICAgbGV0IGNhbWVsS2V5Ow0KICAgICAgICBpZiAob3B0aW9ucyAmJiBoYXNPd24ob3B0aW9ucywgY2FtZWxLZXkgPSBjYW1lbGl6ZShrZXkpKSkgew0KICAgICAgICAgIGlmICghbmVlZENhc3RLZXlzIHx8ICFuZWVkQ2FzdEtleXMuaW5jbHVkZXMoY2FtZWxLZXkpKSB7DQogICAgICAgICAgICBwcm9wc1tjYW1lbEtleV0gPSB2YWx1ZTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgKHJhd0Nhc3RWYWx1ZXMgfHwgKHJhd0Nhc3RWYWx1ZXMgPSB7fSkpW2NhbWVsS2V5XSA9IHZhbHVlOw0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIGlmICghaXNFbWl0TGlzdGVuZXIoaW5zdGFuY2UuZW1pdHNPcHRpb25zLCBrZXkpKSB7DQogICAgICAgICAgaWYgKCEoa2V5IGluIGF0dHJzKSB8fCB2YWx1ZSAhPT0gYXR0cnNba2V5XSkgew0KICAgICAgICAgICAgYXR0cnNba2V5XSA9IHZhbHVlOw0KICAgICAgICAgICAgaGFzQXR0cnNDaGFuZ2VkID0gdHJ1ZTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogICAgaWYgKG5lZWRDYXN0S2V5cykgew0KICAgICAgY29uc3QgcmF3Q3VycmVudFByb3BzID0gdG9SYXcocHJvcHMpOw0KICAgICAgY29uc3QgY2FzdFZhbHVlcyA9IHJhd0Nhc3RWYWx1ZXMgfHwgRU1QVFlfT0JKOw0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuZWVkQ2FzdEtleXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgY29uc3Qga2V5ID0gbmVlZENhc3RLZXlzW2ldOw0KICAgICAgICBwcm9wc1trZXldID0gcmVzb2x2ZVByb3BWYWx1ZSgNCiAgICAgICAgICBvcHRpb25zLA0KICAgICAgICAgIHJhd0N1cnJlbnRQcm9wcywNCiAgICAgICAgICBrZXksDQogICAgICAgICAgY2FzdFZhbHVlc1trZXldLA0KICAgICAgICAgIGluc3RhbmNlLA0KICAgICAgICAgICFoYXNPd24oY2FzdFZhbHVlcywga2V5KQ0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gaGFzQXR0cnNDaGFuZ2VkOw0KICB9DQogIGZ1bmN0aW9uIHJlc29sdmVQcm9wVmFsdWUob3B0aW9ucywgcHJvcHMsIGtleSwgdmFsdWUsIGluc3RhbmNlLCBpc0Fic2VudCkgew0KICAgIGNvbnN0IG9wdCA9IG9wdGlvbnNba2V5XTsNCiAgICBpZiAob3B0ICE9IG51bGwpIHsNCiAgICAgIGNvbnN0IGhhc0RlZmF1bHQgPSBoYXNPd24ob3B0LCAiZGVmYXVsdCIpOw0KICAgICAgaWYgKGhhc0RlZmF1bHQgJiYgdmFsdWUgPT09IHZvaWQgMCkgew0KICAgICAgICBjb25zdCBkZWZhdWx0VmFsdWUgPSBvcHQuZGVmYXVsdDsNCiAgICAgICAgaWYgKG9wdC50eXBlICE9PSBGdW5jdGlvbiAmJiAhb3B0LnNraXBGYWN0b3J5ICYmIGlzRnVuY3Rpb24oZGVmYXVsdFZhbHVlKSkgew0KICAgICAgICAgIGNvbnN0IHsgcHJvcHNEZWZhdWx0cyB9ID0gaW5zdGFuY2U7DQogICAgICAgICAgaWYgKGtleSBpbiBwcm9wc0RlZmF1bHRzKSB7DQogICAgICAgICAgICB2YWx1ZSA9IHByb3BzRGVmYXVsdHNba2V5XTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgY29uc3QgcmVzZXQgPSBzZXRDdXJyZW50SW5zdGFuY2UoaW5zdGFuY2UpOw0KICAgICAgICAgICAgdmFsdWUgPSBwcm9wc0RlZmF1bHRzW2tleV0gPSBkZWZhdWx0VmFsdWUuY2FsbCgNCiAgICAgICAgICAgICAgbnVsbCwNCiAgICAgICAgICAgICAgcHJvcHMNCiAgICAgICAgICAgICk7DQogICAgICAgICAgICByZXNldCgpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICB2YWx1ZSA9IGRlZmF1bHRWYWx1ZTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoaW5zdGFuY2UuY2UpIHsNCiAgICAgICAgICBpbnN0YW5jZS5jZS5fc2V0UHJvcChrZXksIHZhbHVlKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgaWYgKG9wdFswIC8qIHNob3VsZENhc3QgKi9dKSB7DQogICAgICAgIGlmIChpc0Fic2VudCAmJiAhaGFzRGVmYXVsdCkgew0KICAgICAgICAgIHZhbHVlID0gZmFsc2U7DQogICAgICAgIH0gZWxzZSBpZiAob3B0WzEgLyogc2hvdWxkQ2FzdFRydWUgKi9dICYmICh2YWx1ZSA9PT0gIiIgfHwgdmFsdWUgPT09IGh5cGhlbmF0ZShrZXkpKSkgew0KICAgICAgICAgIHZhbHVlID0gdHJ1ZTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gdmFsdWU7DQogIH0NCiAgY29uc3QgbWl4aW5Qcm9wc0NhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7DQogIGZ1bmN0aW9uIG5vcm1hbGl6ZVByb3BzT3B0aW9ucyhjb21wLCBhcHBDb250ZXh0LCBhc01peGluID0gZmFsc2UpIHsNCiAgICBjb25zdCBjYWNoZSA9IGFzTWl4aW4gPyBtaXhpblByb3BzQ2FjaGUgOiBhcHBDb250ZXh0LnByb3BzQ2FjaGU7DQogICAgY29uc3QgY2FjaGVkID0gY2FjaGUuZ2V0KGNvbXApOw0KICAgIGlmIChjYWNoZWQpIHsNCiAgICAgIHJldHVybiBjYWNoZWQ7DQogICAgfQ0KICAgIGNvbnN0IHJhdyA9IGNvbXAucHJvcHM7DQogICAgY29uc3Qgbm9ybWFsaXplZCA9IHt9Ow0KICAgIGNvbnN0IG5lZWRDYXN0S2V5cyA9IFtdOw0KICAgIGxldCBoYXNFeHRlbmRzID0gZmFsc2U7DQogICAgaWYgKCFpc0Z1bmN0aW9uKGNvbXApKSB7DQogICAgICBjb25zdCBleHRlbmRQcm9wcyA9IChyYXcyKSA9PiB7DQogICAgICAgIGhhc0V4dGVuZHMgPSB0cnVlOw0KICAgICAgICBjb25zdCBbcHJvcHMsIGtleXNdID0gbm9ybWFsaXplUHJvcHNPcHRpb25zKHJhdzIsIGFwcENvbnRleHQsIHRydWUpOw0KICAgICAgICBleHRlbmQobm9ybWFsaXplZCwgcHJvcHMpOw0KICAgICAgICBpZiAoa2V5cykgbmVlZENhc3RLZXlzLnB1c2goLi4ua2V5cyk7DQogICAgICB9Ow0KICAgICAgaWYgKCFhc01peGluICYmIGFwcENvbnRleHQubWl4aW5zLmxlbmd0aCkgew0KICAgICAgICBhcHBDb250ZXh0Lm1peGlucy5mb3JFYWNoKGV4dGVuZFByb3BzKTsNCiAgICAgIH0NCiAgICAgIGlmIChjb21wLmV4dGVuZHMpIHsNCiAgICAgICAgZXh0ZW5kUHJvcHMoY29tcC5leHRlbmRzKTsNCiAgICAgIH0NCiAgICAgIGlmIChjb21wLm1peGlucykgew0KICAgICAgICBjb21wLm1peGlucy5mb3JFYWNoKGV4dGVuZFByb3BzKTsNCiAgICAgIH0NCiAgICB9DQogICAgaWYgKCFyYXcgJiYgIWhhc0V4dGVuZHMpIHsNCiAgICAgIGlmIChpc09iamVjdChjb21wKSkgew0KICAgICAgICBjYWNoZS5zZXQoY29tcCwgRU1QVFlfQVJSKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBFTVBUWV9BUlI7DQogICAgfQ0KICAgIGlmIChpc0FycmF5KHJhdykpIHsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmF3Lmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGlmICghaXNTdHJpbmcocmF3W2ldKSkgew0KICAgICAgICAgIHdhcm4kMShgcHJvcHMgbXVzdCBiZSBzdHJpbmdzIHdoZW4gdXNpbmcgYXJyYXkgc3ludGF4LmAsIHJhd1tpXSk7DQogICAgICAgIH0NCiAgICAgICAgY29uc3Qgbm9ybWFsaXplZEtleSA9IGNhbWVsaXplKHJhd1tpXSk7DQogICAgICAgIGlmICh2YWxpZGF0ZVByb3BOYW1lKG5vcm1hbGl6ZWRLZXkpKSB7DQogICAgICAgICAgbm9ybWFsaXplZFtub3JtYWxpemVkS2V5XSA9IEVNUFRZX09CSjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0gZWxzZSBpZiAocmF3KSB7DQogICAgICBpZiAoIWlzT2JqZWN0KHJhdykpIHsNCiAgICAgICAgd2FybiQxKGBpbnZhbGlkIHByb3BzIG9wdGlvbnNgLCByYXcpOw0KICAgICAgfQ0KICAgICAgZm9yIChjb25zdCBrZXkgaW4gcmF3KSB7DQogICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRLZXkgPSBjYW1lbGl6ZShrZXkpOw0KICAgICAgICBpZiAodmFsaWRhdGVQcm9wTmFtZShub3JtYWxpemVkS2V5KSkgew0KICAgICAgICAgIGNvbnN0IG9wdCA9IHJhd1trZXldOw0KICAgICAgICAgIGNvbnN0IHByb3AgPSBub3JtYWxpemVkW25vcm1hbGl6ZWRLZXldID0gaXNBcnJheShvcHQpIHx8IGlzRnVuY3Rpb24ob3B0KSA/IHsgdHlwZTogb3B0IH0gOiBleHRlbmQoe30sIG9wdCk7DQogICAgICAgICAgY29uc3QgcHJvcFR5cGUgPSBwcm9wLnR5cGU7DQogICAgICAgICAgbGV0IHNob3VsZENhc3QgPSBmYWxzZTsNCiAgICAgICAgICBsZXQgc2hvdWxkQ2FzdFRydWUgPSB0cnVlOw0KICAgICAgICAgIGlmIChpc0FycmF5KHByb3BUeXBlKSkgew0KICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHByb3BUeXBlLmxlbmd0aDsgKytpbmRleCkgew0KICAgICAgICAgICAgICBjb25zdCB0eXBlID0gcHJvcFR5cGVbaW5kZXhdOw0KICAgICAgICAgICAgICBjb25zdCB0eXBlTmFtZSA9IGlzRnVuY3Rpb24odHlwZSkgJiYgdHlwZS5uYW1lOw0KICAgICAgICAgICAgICBpZiAodHlwZU5hbWUgPT09ICJCb29sZWFuIikgew0KICAgICAgICAgICAgICAgIHNob3VsZENhc3QgPSB0cnVlOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVOYW1lID09PSAiU3RyaW5nIikgew0KICAgICAgICAgICAgICAgIHNob3VsZENhc3RUcnVlID0gZmFsc2U7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgc2hvdWxkQ2FzdCA9IGlzRnVuY3Rpb24ocHJvcFR5cGUpICYmIHByb3BUeXBlLm5hbWUgPT09ICJCb29sZWFuIjsNCiAgICAgICAgICB9DQogICAgICAgICAgcHJvcFswIC8qIHNob3VsZENhc3QgKi9dID0gc2hvdWxkQ2FzdDsNCiAgICAgICAgICBwcm9wWzEgLyogc2hvdWxkQ2FzdFRydWUgKi9dID0gc2hvdWxkQ2FzdFRydWU7DQogICAgICAgICAgaWYgKHNob3VsZENhc3QgfHwgaGFzT3duKHByb3AsICJkZWZhdWx0IikpIHsNCiAgICAgICAgICAgIG5lZWRDYXN0S2V5cy5wdXNoKG5vcm1hbGl6ZWRLZXkpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICBjb25zdCByZXMgPSBbbm9ybWFsaXplZCwgbmVlZENhc3RLZXlzXTsNCiAgICBpZiAoaXNPYmplY3QoY29tcCkpIHsNCiAgICAgIGNhY2hlLnNldChjb21wLCByZXMpOw0KICAgIH0NCiAgICByZXR1cm4gcmVzOw0KICB9DQogIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcE5hbWUoa2V5KSB7DQogICAgaWYgKGtleVswXSAhPT0gIiQiICYmICFpc1Jlc2VydmVkUHJvcChrZXkpKSB7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9IGVsc2Ugew0KICAgICAgd2FybiQxKGBJbnZhbGlkIHByb3AgbmFtZTogIiR7a2V5fSIgaXMgYSByZXNlcnZlZCBwcm9wZXJ0eS5gKTsNCiAgICB9DQogICAgcmV0dXJuIGZhbHNlOw0KICB9DQogIGZ1bmN0aW9uIGdldFR5cGUoY3Rvcikgew0KICAgIGlmIChjdG9yID09PSBudWxsKSB7DQogICAgICByZXR1cm4gIm51bGwiOw0KICAgIH0NCiAgICBpZiAodHlwZW9mIGN0b3IgPT09ICJmdW5jdGlvbiIpIHsNCiAgICAgIHJldHVybiBjdG9yLm5hbWUgfHwgIiI7DQogICAgfSBlbHNlIGlmICh0eXBlb2YgY3RvciA9PT0gIm9iamVjdCIpIHsNCiAgICAgIGNvbnN0IG5hbWUgPSBjdG9yLmNvbnN0cnVjdG9yICYmIGN0b3IuY29uc3RydWN0b3IubmFtZTsNCiAgICAgIHJldHVybiBuYW1lIHx8ICIiOw0KICAgIH0NCiAgICByZXR1cm4gIiI7DQogIH0NCiAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wcyhyYXdQcm9wcywgcHJvcHMsIGluc3RhbmNlKSB7DQogICAgY29uc3QgcmVzb2x2ZWRWYWx1ZXMgPSB0b1Jhdyhwcm9wcyk7DQogICAgY29uc3Qgb3B0aW9ucyA9IGluc3RhbmNlLnByb3BzT3B0aW9uc1swXTsNCiAgICBjb25zdCBjYW1lbGl6ZVByb3BzS2V5ID0gT2JqZWN0LmtleXMocmF3UHJvcHMpLm1hcCgoa2V5KSA9PiBjYW1lbGl6ZShrZXkpKTsNCiAgICBmb3IgKGNvbnN0IGtleSBpbiBvcHRpb25zKSB7DQogICAgICBsZXQgb3B0ID0gb3B0aW9uc1trZXldOw0KICAgICAgaWYgKG9wdCA9PSBudWxsKSBjb250aW51ZTsNCiAgICAgIHZhbGlkYXRlUHJvcCgNCiAgICAgICAga2V5LA0KICAgICAgICByZXNvbHZlZFZhbHVlc1trZXldLA0KICAgICAgICBvcHQsDQogICAgICAgIHNoYWxsb3dSZWFkb25seShyZXNvbHZlZFZhbHVlcykgLA0KICAgICAgICAhY2FtZWxpemVQcm9wc0tleS5pbmNsdWRlcyhrZXkpDQogICAgICApOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiB2YWxpZGF0ZVByb3AobmFtZSwgdmFsdWUsIHByb3AsIHByb3BzLCBpc0Fic2VudCkgew0KICAgIGNvbnN0IHsgdHlwZSwgcmVxdWlyZWQsIHZhbGlkYXRvciwgc2tpcENoZWNrIH0gPSBwcm9wOw0KICAgIGlmIChyZXF1aXJlZCAmJiBpc0Fic2VudCkgew0KICAgICAgd2FybiQxKCdNaXNzaW5nIHJlcXVpcmVkIHByb3A6ICInICsgbmFtZSArICciJyk7DQogICAgICByZXR1cm47DQogICAgfQ0KICAgIGlmICh2YWx1ZSA9PSBudWxsICYmICFyZXF1aXJlZCkgew0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBpZiAodHlwZSAhPSBudWxsICYmIHR5cGUgIT09IHRydWUgJiYgIXNraXBDaGVjaykgew0KICAgICAgbGV0IGlzVmFsaWQgPSBmYWxzZTsNCiAgICAgIGNvbnN0IHR5cGVzID0gaXNBcnJheSh0eXBlKSA/IHR5cGUgOiBbdHlwZV07DQogICAgICBjb25zdCBleHBlY3RlZFR5cGVzID0gW107DQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHR5cGVzLmxlbmd0aCAmJiAhaXNWYWxpZDsgaSsrKSB7DQogICAgICAgIGNvbnN0IHsgdmFsaWQsIGV4cGVjdGVkVHlwZSB9ID0gYXNzZXJ0VHlwZSh2YWx1ZSwgdHlwZXNbaV0pOw0KICAgICAgICBleHBlY3RlZFR5cGVzLnB1c2goZXhwZWN0ZWRUeXBlIHx8ICIiKTsNCiAgICAgICAgaXNWYWxpZCA9IHZhbGlkOw0KICAgICAgfQ0KICAgICAgaWYgKCFpc1ZhbGlkKSB7DQogICAgICAgIHdhcm4kMShnZXRJbnZhbGlkVHlwZU1lc3NhZ2UobmFtZSwgdmFsdWUsIGV4cGVjdGVkVHlwZXMpKTsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAodmFsaWRhdG9yICYmICF2YWxpZGF0b3IodmFsdWUsIHByb3BzKSkgew0KICAgICAgd2FybiQxKCdJbnZhbGlkIHByb3A6IGN1c3RvbSB2YWxpZGF0b3IgY2hlY2sgZmFpbGVkIGZvciBwcm9wICInICsgbmFtZSArICciLicpOw0KICAgIH0NCiAgfQ0KICBjb25zdCBpc1NpbXBsZVR5cGUgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcCgNCiAgICAiU3RyaW5nLE51bWJlcixCb29sZWFuLEZ1bmN0aW9uLFN5bWJvbCxCaWdJbnQiDQogICk7DQogIGZ1bmN0aW9uIGFzc2VydFR5cGUodmFsdWUsIHR5cGUpIHsNCiAgICBsZXQgdmFsaWQ7DQogICAgY29uc3QgZXhwZWN0ZWRUeXBlID0gZ2V0VHlwZSh0eXBlKTsNCiAgICBpZiAoZXhwZWN0ZWRUeXBlID09PSAibnVsbCIpIHsNCiAgICAgIHZhbGlkID0gdmFsdWUgPT09IG51bGw7DQogICAgfSBlbHNlIGlmIChpc1NpbXBsZVR5cGUoZXhwZWN0ZWRUeXBlKSkgew0KICAgICAgY29uc3QgdCA9IHR5cGVvZiB2YWx1ZTsNCiAgICAgIHZhbGlkID0gdCA9PT0gZXhwZWN0ZWRUeXBlLnRvTG93ZXJDYXNlKCk7DQogICAgICBpZiAoIXZhbGlkICYmIHQgPT09ICJvYmplY3QiKSB7DQogICAgICAgIHZhbGlkID0gdmFsdWUgaW5zdGFuY2VvZiB0eXBlOw0KICAgICAgfQ0KICAgIH0gZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSAiT2JqZWN0Iikgew0KICAgICAgdmFsaWQgPSBpc09iamVjdCh2YWx1ZSk7DQogICAgfSBlbHNlIGlmIChleHBlY3RlZFR5cGUgPT09ICJBcnJheSIpIHsNCiAgICAgIHZhbGlkID0gaXNBcnJheSh2YWx1ZSk7DQogICAgfSBlbHNlIHsNCiAgICAgIHZhbGlkID0gdmFsdWUgaW5zdGFuY2VvZiB0eXBlOw0KICAgIH0NCiAgICByZXR1cm4gew0KICAgICAgdmFsaWQsDQogICAgICBleHBlY3RlZFR5cGUNCiAgICB9Ow0KICB9DQogIGZ1bmN0aW9uIGdldEludmFsaWRUeXBlTWVzc2FnZShuYW1lLCB2YWx1ZSwgZXhwZWN0ZWRUeXBlcykgew0KICAgIGlmIChleHBlY3RlZFR5cGVzLmxlbmd0aCA9PT0gMCkgew0KICAgICAgcmV0dXJuIGBQcm9wIHR5cGUgW10gZm9yIHByb3AgIiR7bmFtZX0iIHdvbid0IG1hdGNoIGFueXRoaW5nLiBEaWQgeW91IG1lYW4gdG8gdXNlIHR5cGUgQXJyYXkgaW5zdGVhZD9gOw0KICAgIH0NCiAgICBsZXQgbWVzc2FnZSA9IGBJbnZhbGlkIHByb3A6IHR5cGUgY2hlY2sgZmFpbGVkIGZvciBwcm9wICIke25hbWV9Ii4gRXhwZWN0ZWQgJHtleHBlY3RlZFR5cGVzLm1hcChjYXBpdGFsaXplKS5qb2luKCIgfCAiKX1gOw0KICAgIGNvbnN0IGV4cGVjdGVkVHlwZSA9IGV4cGVjdGVkVHlwZXNbMF07DQogICAgY29uc3QgcmVjZWl2ZWRUeXBlID0gdG9SYXdUeXBlKHZhbHVlKTsNCiAgICBjb25zdCBleHBlY3RlZFZhbHVlID0gc3R5bGVWYWx1ZSh2YWx1ZSwgZXhwZWN0ZWRUeXBlKTsNCiAgICBjb25zdCByZWNlaXZlZFZhbHVlID0gc3R5bGVWYWx1ZSh2YWx1ZSwgcmVjZWl2ZWRUeXBlKTsNCiAgICBpZiAoZXhwZWN0ZWRUeXBlcy5sZW5ndGggPT09IDEgJiYgaXNFeHBsaWNhYmxlKGV4cGVjdGVkVHlwZSkgJiYgIWlzQm9vbGVhbihleHBlY3RlZFR5cGUsIHJlY2VpdmVkVHlwZSkpIHsNCiAgICAgIG1lc3NhZ2UgKz0gYCB3aXRoIHZhbHVlICR7ZXhwZWN0ZWRWYWx1ZX1gOw0KICAgIH0NCiAgICBtZXNzYWdlICs9IGAsIGdvdCAke3JlY2VpdmVkVHlwZX0gYDsNCiAgICBpZiAoaXNFeHBsaWNhYmxlKHJlY2VpdmVkVHlwZSkpIHsNCiAgICAgIG1lc3NhZ2UgKz0gYHdpdGggdmFsdWUgJHtyZWNlaXZlZFZhbHVlfS5gOw0KICAgIH0NCiAgICByZXR1cm4gbWVzc2FnZTsNCiAgfQ0KICBmdW5jdGlvbiBzdHlsZVZhbHVlKHZhbHVlLCB0eXBlKSB7DQogICAgaWYgKHR5cGUgPT09ICJTdHJpbmciKSB7DQogICAgICByZXR1cm4gYCIke3ZhbHVlfSJgOw0KICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gIk51bWJlciIpIHsNCiAgICAgIHJldHVybiBgJHtOdW1iZXIodmFsdWUpfWA7DQogICAgfSBlbHNlIHsNCiAgICAgIHJldHVybiBgJHt2YWx1ZX1gOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBpc0V4cGxpY2FibGUodHlwZSkgew0KICAgIGNvbnN0IGV4cGxpY2l0VHlwZXMgPSBbInN0cmluZyIsICJudW1iZXIiLCAiYm9vbGVhbiJdOw0KICAgIHJldHVybiBleHBsaWNpdFR5cGVzLnNvbWUoKGVsZW0pID0+IHR5cGUudG9Mb3dlckNhc2UoKSA9PT0gZWxlbSk7DQogIH0NCiAgZnVuY3Rpb24gaXNCb29sZWFuKC4uLmFyZ3MpIHsNCiAgICByZXR1cm4gYXJncy5zb21lKChlbGVtKSA9PiBlbGVtLnRvTG93ZXJDYXNlKCkgPT09ICJib29sZWFuIik7DQogIH0NCg0KICBjb25zdCBpc0ludGVybmFsS2V5ID0gKGtleSkgPT4ga2V5WzBdID09PSAiXyIgfHwga2V5ID09PSAiJHN0YWJsZSI7DQogIGNvbnN0IG5vcm1hbGl6ZVNsb3RWYWx1ZSA9ICh2YWx1ZSkgPT4gaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZS5tYXAobm9ybWFsaXplVk5vZGUpIDogW25vcm1hbGl6ZVZOb2RlKHZhbHVlKV07DQogIGNvbnN0IG5vcm1hbGl6ZVNsb3QgPSAoa2V5LCByYXdTbG90LCBjdHgpID0+IHsNCiAgICBpZiAocmF3U2xvdC5fbikgew0KICAgICAgcmV0dXJuIHJhd1Nsb3Q7DQogICAgfQ0KICAgIGNvbnN0IG5vcm1hbGl6ZWQgPSB3aXRoQ3R4KCguLi5hcmdzKSA9PiB7DQogICAgICBpZiAoY3VycmVudEluc3RhbmNlICYmICEoY3R4ID09PSBudWxsICYmIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSkgJiYgIShjdHggJiYgY3R4LnJvb3QgIT09IGN1cnJlbnRJbnN0YW5jZS5yb290KSkgew0KICAgICAgICB3YXJuJDEoDQogICAgICAgICAgYFNsb3QgIiR7a2V5fSIgaW52b2tlZCBvdXRzaWRlIG9mIHRoZSByZW5kZXIgZnVuY3Rpb246IHRoaXMgd2lsbCBub3QgdHJhY2sgZGVwZW5kZW5jaWVzIHVzZWQgaW4gdGhlIHNsb3QuIEludm9rZSB0aGUgc2xvdCBmdW5jdGlvbiBpbnNpZGUgdGhlIHJlbmRlciBmdW5jdGlvbiBpbnN0ZWFkLmANCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBub3JtYWxpemVTbG90VmFsdWUocmF3U2xvdCguLi5hcmdzKSk7DQogICAgfSwgY3R4KTsNCiAgICBub3JtYWxpemVkLl9jID0gZmFsc2U7DQogICAgcmV0dXJuIG5vcm1hbGl6ZWQ7DQogIH07DQogIGNvbnN0IG5vcm1hbGl6ZU9iamVjdFNsb3RzID0gKHJhd1Nsb3RzLCBzbG90cywgaW5zdGFuY2UpID0+IHsNCiAgICBjb25zdCBjdHggPSByYXdTbG90cy5fY3R4Ow0KICAgIGZvciAoY29uc3Qga2V5IGluIHJhd1Nsb3RzKSB7DQogICAgICBpZiAoaXNJbnRlcm5hbEtleShrZXkpKSBjb250aW51ZTsNCiAgICAgIGNvbnN0IHZhbHVlID0gcmF3U2xvdHNba2V5XTsNCiAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgew0KICAgICAgICBzbG90c1trZXldID0gbm9ybWFsaXplU2xvdChrZXksIHZhbHVlLCBjdHgpOw0KICAgICAgfSBlbHNlIGlmICh2YWx1ZSAhPSBudWxsKSB7DQogICAgICAgIHsNCiAgICAgICAgICB3YXJuJDEoDQogICAgICAgICAgICBgTm9uLWZ1bmN0aW9uIHZhbHVlIGVuY291bnRlcmVkIGZvciBzbG90ICIke2tleX0iLiBQcmVmZXIgZnVuY3Rpb24gc2xvdHMgZm9yIGJldHRlciBwZXJmb3JtYW5jZS5gDQogICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgICAgICBjb25zdCBub3JtYWxpemVkID0gbm9ybWFsaXplU2xvdFZhbHVlKHZhbHVlKTsNCiAgICAgICAgc2xvdHNba2V5XSA9ICgpID0+IG5vcm1hbGl6ZWQ7DQogICAgICB9DQogICAgfQ0KICB9Ow0KICBjb25zdCBub3JtYWxpemVWTm9kZVNsb3RzID0gKGluc3RhbmNlLCBjaGlsZHJlbikgPT4gew0KICAgIGlmICghaXNLZWVwQWxpdmUoaW5zdGFuY2Uudm5vZGUpICYmIHRydWUpIHsNCiAgICAgIHdhcm4kMSgNCiAgICAgICAgYE5vbi1mdW5jdGlvbiB2YWx1ZSBlbmNvdW50ZXJlZCBmb3IgZGVmYXVsdCBzbG90LiBQcmVmZXIgZnVuY3Rpb24gc2xvdHMgZm9yIGJldHRlciBwZXJmb3JtYW5jZS5gDQogICAgICApOw0KICAgIH0NCiAgICBjb25zdCBub3JtYWxpemVkID0gbm9ybWFsaXplU2xvdFZhbHVlKGNoaWxkcmVuKTsNCiAgICBpbnN0YW5jZS5zbG90cy5kZWZhdWx0ID0gKCkgPT4gbm9ybWFsaXplZDsNCiAgfTsNCiAgY29uc3QgYXNzaWduU2xvdHMgPSAoc2xvdHMsIGNoaWxkcmVuLCBvcHRpbWl6ZWQpID0+IHsNCiAgICBmb3IgKGNvbnN0IGtleSBpbiBjaGlsZHJlbikgew0KICAgICAgaWYgKG9wdGltaXplZCB8fCAhaXNJbnRlcm5hbEtleShrZXkpKSB7DQogICAgICAgIHNsb3RzW2tleV0gPSBjaGlsZHJlbltrZXldOw0KICAgICAgfQ0KICAgIH0NCiAgfTsNCiAgY29uc3QgaW5pdFNsb3RzID0gKGluc3RhbmNlLCBjaGlsZHJlbiwgb3B0aW1pemVkKSA9PiB7DQogICAgY29uc3Qgc2xvdHMgPSBpbnN0YW5jZS5zbG90cyA9IGNyZWF0ZUludGVybmFsT2JqZWN0KCk7DQogICAgaWYgKGluc3RhbmNlLnZub2RlLnNoYXBlRmxhZyAmIDMyKSB7DQogICAgICBjb25zdCBjYWNoZUluZGV4ZXMgPSBjaGlsZHJlbi5fXzsNCiAgICAgIGlmIChjYWNoZUluZGV4ZXMpIGRlZihzbG90cywgIl9fIiwgY2FjaGVJbmRleGVzLCB0cnVlKTsNCiAgICAgIGNvbnN0IHR5cGUgPSBjaGlsZHJlbi5fOw0KICAgICAgaWYgKHR5cGUpIHsNCiAgICAgICAgYXNzaWduU2xvdHMoc2xvdHMsIGNoaWxkcmVuLCBvcHRpbWl6ZWQpOw0KICAgICAgICBpZiAob3B0aW1pemVkKSB7DQogICAgICAgICAgZGVmKHNsb3RzLCAiXyIsIHR5cGUsIHRydWUpOw0KICAgICAgICB9DQogICAgICB9IGVsc2Ugew0KICAgICAgICBub3JtYWxpemVPYmplY3RTbG90cyhjaGlsZHJlbiwgc2xvdHMpOw0KICAgICAgfQ0KICAgIH0gZWxzZSBpZiAoY2hpbGRyZW4pIHsNCiAgICAgIG5vcm1hbGl6ZVZOb2RlU2xvdHMoaW5zdGFuY2UsIGNoaWxkcmVuKTsNCiAgICB9DQogIH07DQogIGNvbnN0IHVwZGF0ZVNsb3RzID0gKGluc3RhbmNlLCBjaGlsZHJlbiwgb3B0aW1pemVkKSA9PiB7DQogICAgY29uc3QgeyB2bm9kZSwgc2xvdHMgfSA9IGluc3RhbmNlOw0KICAgIGxldCBuZWVkRGVsZXRpb25DaGVjayA9IHRydWU7DQogICAgbGV0IGRlbGV0aW9uQ29tcGFyaXNvblRhcmdldCA9IEVNUFRZX09CSjsNCiAgICBpZiAodm5vZGUuc2hhcGVGbGFnICYgMzIpIHsNCiAgICAgIGNvbnN0IHR5cGUgPSBjaGlsZHJlbi5fOw0KICAgICAgaWYgKHR5cGUpIHsNCiAgICAgICAgaWYgKGlzSG1yVXBkYXRpbmcpIHsNCiAgICAgICAgICBhc3NpZ25TbG90cyhzbG90cywgY2hpbGRyZW4sIG9wdGltaXplZCk7DQogICAgICAgICAgdHJpZ2dlcihpbnN0YW5jZSwgInNldCIsICIkc2xvdHMiKTsNCiAgICAgICAgfSBlbHNlIGlmIChvcHRpbWl6ZWQgJiYgdHlwZSA9PT0gMSkgew0KICAgICAgICAgIG5lZWREZWxldGlvbkNoZWNrID0gZmFsc2U7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgYXNzaWduU2xvdHMoc2xvdHMsIGNoaWxkcmVuLCBvcHRpbWl6ZWQpOw0KICAgICAgICB9DQogICAgICB9IGVsc2Ugew0KICAgICAgICBuZWVkRGVsZXRpb25DaGVjayA9ICFjaGlsZHJlbi4kc3RhYmxlOw0KICAgICAgICBub3JtYWxpemVPYmplY3RTbG90cyhjaGlsZHJlbiwgc2xvdHMpOw0KICAgICAgfQ0KICAgICAgZGVsZXRpb25Db21wYXJpc29uVGFyZ2V0ID0gY2hpbGRyZW47DQogICAgfSBlbHNlIGlmIChjaGlsZHJlbikgew0KICAgICAgbm9ybWFsaXplVk5vZGVTbG90cyhpbnN0YW5jZSwgY2hpbGRyZW4pOw0KICAgICAgZGVsZXRpb25Db21wYXJpc29uVGFyZ2V0ID0geyBkZWZhdWx0OiAxIH07DQogICAgfQ0KICAgIGlmIChuZWVkRGVsZXRpb25DaGVjaykgew0KICAgICAgZm9yIChjb25zdCBrZXkgaW4gc2xvdHMpIHsNCiAgICAgICAgaWYgKCFpc0ludGVybmFsS2V5KGtleSkgJiYgZGVsZXRpb25Db21wYXJpc29uVGFyZ2V0W2tleV0gPT0gbnVsbCkgew0KICAgICAgICAgIGRlbGV0ZSBzbG90c1trZXldOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICB9Ow0KDQogIGxldCBzdXBwb3J0ZWQ7DQogIGxldCBwZXJmOw0KICBmdW5jdGlvbiBzdGFydE1lYXN1cmUoaW5zdGFuY2UsIHR5cGUpIHsNCiAgICBpZiAoaW5zdGFuY2UuYXBwQ29udGV4dC5jb25maWcucGVyZm9ybWFuY2UgJiYgaXNTdXBwb3J0ZWQoKSkgew0KICAgICAgcGVyZi5tYXJrKGB2dWUtJHt0eXBlfS0ke2luc3RhbmNlLnVpZH1gKTsNCiAgICB9DQogICAgew0KICAgICAgZGV2dG9vbHNQZXJmU3RhcnQoaW5zdGFuY2UsIHR5cGUsIGlzU3VwcG9ydGVkKCkgPyBwZXJmLm5vdygpIDogRGF0ZS5ub3coKSk7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGVuZE1lYXN1cmUoaW5zdGFuY2UsIHR5cGUpIHsNCiAgICBpZiAoaW5zdGFuY2UuYXBwQ29udGV4dC5jb25maWcucGVyZm9ybWFuY2UgJiYgaXNTdXBwb3J0ZWQoKSkgew0KICAgICAgY29uc3Qgc3RhcnRUYWcgPSBgdnVlLSR7dHlwZX0tJHtpbnN0YW5jZS51aWR9YDsNCiAgICAgIGNvbnN0IGVuZFRhZyA9IHN0YXJ0VGFnICsgYDplbmRgOw0KICAgICAgcGVyZi5tYXJrKGVuZFRhZyk7DQogICAgICBwZXJmLm1lYXN1cmUoDQogICAgICAgIGA8JHtmb3JtYXRDb21wb25lbnROYW1lKGluc3RhbmNlLCBpbnN0YW5jZS50eXBlKX0+ICR7dHlwZX1gLA0KICAgICAgICBzdGFydFRhZywNCiAgICAgICAgZW5kVGFnDQogICAgICApOw0KICAgICAgcGVyZi5jbGVhck1hcmtzKHN0YXJ0VGFnKTsNCiAgICAgIHBlcmYuY2xlYXJNYXJrcyhlbmRUYWcpOw0KICAgIH0NCiAgICB7DQogICAgICBkZXZ0b29sc1BlcmZFbmQoaW5zdGFuY2UsIHR5cGUsIGlzU3VwcG9ydGVkKCkgPyBwZXJmLm5vdygpIDogRGF0ZS5ub3coKSk7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGlzU3VwcG9ydGVkKCkgew0KICAgIGlmIChzdXBwb3J0ZWQgIT09IHZvaWQgMCkgew0KICAgICAgcmV0dXJuIHN1cHBvcnRlZDsNCiAgICB9DQogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5wZXJmb3JtYW5jZSkgew0KICAgICAgc3VwcG9ydGVkID0gdHJ1ZTsNCiAgICAgIHBlcmYgPSB3aW5kb3cucGVyZm9ybWFuY2U7DQogICAgfSBlbHNlIHsNCiAgICAgIHN1cHBvcnRlZCA9IGZhbHNlOw0KICAgIH0NCiAgICByZXR1cm4gc3VwcG9ydGVkOw0KICB9DQoNCiAgY29uc3QgcXVldWVQb3N0UmVuZGVyRWZmZWN0ID0gcXVldWVFZmZlY3RXaXRoU3VzcGVuc2UgOw0KICBmdW5jdGlvbiBjcmVhdGVSZW5kZXJlcihvcHRpb25zKSB7DQogICAgcmV0dXJuIGJhc2VDcmVhdGVSZW5kZXJlcihvcHRpb25zKTsNCiAgfQ0KICBmdW5jdGlvbiBjcmVhdGVIeWRyYXRpb25SZW5kZXJlcihvcHRpb25zKSB7DQogICAgcmV0dXJuIGJhc2VDcmVhdGVSZW5kZXJlcihvcHRpb25zLCBjcmVhdGVIeWRyYXRpb25GdW5jdGlvbnMpOw0KICB9DQogIGZ1bmN0aW9uIGJhc2VDcmVhdGVSZW5kZXJlcihvcHRpb25zLCBjcmVhdGVIeWRyYXRpb25GbnMpIHsNCiAgICBjb25zdCB0YXJnZXQgPSBnZXRHbG9iYWxUaGlzKCk7DQogICAgdGFyZ2V0Ll9fVlVFX18gPSB0cnVlOw0KICAgIHsNCiAgICAgIHNldERldnRvb2xzSG9vayQxKHRhcmdldC5fX1ZVRV9ERVZUT09MU19HTE9CQUxfSE9PS19fLCB0YXJnZXQpOw0KICAgIH0NCiAgICBjb25zdCB7DQogICAgICBpbnNlcnQ6IGhvc3RJbnNlcnQsDQogICAgICByZW1vdmU6IGhvc3RSZW1vdmUsDQogICAgICBwYXRjaFByb3A6IGhvc3RQYXRjaFByb3AsDQogICAgICBjcmVhdGVFbGVtZW50OiBob3N0Q3JlYXRlRWxlbWVudCwNCiAgICAgIGNyZWF0ZVRleHQ6IGhvc3RDcmVhdGVUZXh0LA0KICAgICAgY3JlYXRlQ29tbWVudDogaG9zdENyZWF0ZUNvbW1lbnQsDQogICAgICBzZXRUZXh0OiBob3N0U2V0VGV4dCwNCiAgICAgIHNldEVsZW1lbnRUZXh0OiBob3N0U2V0RWxlbWVudFRleHQsDQogICAgICBwYXJlbnROb2RlOiBob3N0UGFyZW50Tm9kZSwNCiAgICAgIG5leHRTaWJsaW5nOiBob3N0TmV4dFNpYmxpbmcsDQogICAgICBzZXRTY29wZUlkOiBob3N0U2V0U2NvcGVJZCA9IE5PT1AsDQogICAgICBpbnNlcnRTdGF0aWNDb250ZW50OiBob3N0SW5zZXJ0U3RhdGljQ29udGVudA0KICAgIH0gPSBvcHRpb25zOw0KICAgIGNvbnN0IHBhdGNoID0gKG4xLCBuMiwgY29udGFpbmVyLCBhbmNob3IgPSBudWxsLCBwYXJlbnRDb21wb25lbnQgPSBudWxsLCBwYXJlbnRTdXNwZW5zZSA9IG51bGwsIG5hbWVzcGFjZSA9IHZvaWQgMCwgc2xvdFNjb3BlSWRzID0gbnVsbCwgb3B0aW1pemVkID0gaXNIbXJVcGRhdGluZyA/IGZhbHNlIDogISFuMi5keW5hbWljQ2hpbGRyZW4pID0+IHsNCiAgICAgIGlmIChuMSA9PT0gbjIpIHsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgaWYgKG4xICYmICFpc1NhbWVWTm9kZVR5cGUobjEsIG4yKSkgew0KICAgICAgICBhbmNob3IgPSBnZXROZXh0SG9zdE5vZGUobjEpOw0KICAgICAgICB1bm1vdW50KG4xLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCB0cnVlKTsNCiAgICAgICAgbjEgPSBudWxsOw0KICAgICAgfQ0KICAgICAgaWYgKG4yLnBhdGNoRmxhZyA9PT0gLTIpIHsNCiAgICAgICAgb3B0aW1pemVkID0gZmFsc2U7DQogICAgICAgIG4yLmR5bmFtaWNDaGlsZHJlbiA9IG51bGw7DQogICAgICB9DQogICAgICBjb25zdCB7IHR5cGUsIHJlZiwgc2hhcGVGbGFnIH0gPSBuMjsNCiAgICAgIHN3aXRjaCAodHlwZSkgew0KICAgICAgICBjYXNlIFRleHQ6DQogICAgICAgICAgcHJvY2Vzc1RleHQobjEsIG4yLCBjb250YWluZXIsIGFuY2hvcik7DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIGNhc2UgQ29tbWVudDoNCiAgICAgICAgICBwcm9jZXNzQ29tbWVudE5vZGUobjEsIG4yLCBjb250YWluZXIsIGFuY2hvcik7DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIGNhc2UgU3RhdGljOg0KICAgICAgICAgIGlmIChuMSA9PSBudWxsKSB7DQogICAgICAgICAgICBtb3VudFN0YXRpY05vZGUobjIsIGNvbnRhaW5lciwgYW5jaG9yLCBuYW1lc3BhY2UpOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBwYXRjaFN0YXRpY05vZGUobjEsIG4yLCBjb250YWluZXIsIG5hbWVzcGFjZSk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGJyZWFrOw0KICAgICAgICBjYXNlIEZyYWdtZW50Og0KICAgICAgICAgIHByb2Nlc3NGcmFnbWVudCgNCiAgICAgICAgICAgIG4xLA0KICAgICAgICAgICAgbjIsDQogICAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgICBhbmNob3IsDQogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICAgICk7DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIGRlZmF1bHQ6DQogICAgICAgICAgaWYgKHNoYXBlRmxhZyAmIDEpIHsNCiAgICAgICAgICAgIHByb2Nlc3NFbGVtZW50KA0KICAgICAgICAgICAgICBuMSwNCiAgICAgICAgICAgICAgbjIsDQogICAgICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICAgICAgYW5jaG9yLA0KICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLA0KICAgICAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICAgICAgb3B0aW1pemVkDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0gZWxzZSBpZiAoc2hhcGVGbGFnICYgNikgew0KICAgICAgICAgICAgcHJvY2Vzc0NvbXBvbmVudCgNCiAgICAgICAgICAgICAgbjEsDQogICAgICAgICAgICAgIG4yLA0KICAgICAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgICAgIGFuY2hvciwNCiAgICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgICAgbmFtZXNwYWNlLA0KICAgICAgICAgICAgICBzbG90U2NvcGVJZHMsDQogICAgICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9IGVsc2UgaWYgKHNoYXBlRmxhZyAmIDY0KSB7DQogICAgICAgICAgICB0eXBlLnByb2Nlc3MoDQogICAgICAgICAgICAgIG4xLA0KICAgICAgICAgICAgICBuMiwNCiAgICAgICAgICAgICAgY29udGFpbmVyLA0KICAgICAgICAgICAgICBhbmNob3IsDQogICAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgICAgICBvcHRpbWl6ZWQsDQogICAgICAgICAgICAgIGludGVybmFscw0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9IGVsc2UgaWYgKHNoYXBlRmxhZyAmIDEyOCkgew0KICAgICAgICAgICAgdHlwZS5wcm9jZXNzKA0KICAgICAgICAgICAgICBuMSwNCiAgICAgICAgICAgICAgbjIsDQogICAgICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICAgICAgYW5jaG9yLA0KICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLA0KICAgICAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICAgICAgb3B0aW1pemVkLA0KICAgICAgICAgICAgICBpbnRlcm5hbHMNCiAgICAgICAgICAgICk7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHdhcm4kMSgiSW52YWxpZCBWTm9kZSB0eXBlOiIsIHR5cGUsIGAoJHt0eXBlb2YgdHlwZX0pYCk7DQogICAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgaWYgKHJlZiAhPSBudWxsICYmIHBhcmVudENvbXBvbmVudCkgew0KICAgICAgICBzZXRSZWYocmVmLCBuMSAmJiBuMS5yZWYsIHBhcmVudFN1c3BlbnNlLCBuMiB8fCBuMSwgIW4yKTsNCiAgICAgIH0gZWxzZSBpZiAocmVmID09IG51bGwgJiYgbjEgJiYgbjEucmVmICE9IG51bGwpIHsNCiAgICAgICAgc2V0UmVmKG4xLnJlZiwgbnVsbCwgcGFyZW50U3VzcGVuc2UsIG4xLCB0cnVlKTsNCiAgICAgIH0NCiAgICB9Ow0KICAgIGNvbnN0IHByb2Nlc3NUZXh0ID0gKG4xLCBuMiwgY29udGFpbmVyLCBhbmNob3IpID0+IHsNCiAgICAgIGlmIChuMSA9PSBudWxsKSB7DQogICAgICAgIGhvc3RJbnNlcnQoDQogICAgICAgICAgbjIuZWwgPSBob3N0Q3JlYXRlVGV4dChuMi5jaGlsZHJlbiksDQogICAgICAgICAgY29udGFpbmVyLA0KICAgICAgICAgIGFuY2hvcg0KICAgICAgICApOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29uc3QgZWwgPSBuMi5lbCA9IG4xLmVsOw0KICAgICAgICBpZiAobjIuY2hpbGRyZW4gIT09IG4xLmNoaWxkcmVuKSB7DQogICAgICAgICAgaG9zdFNldFRleHQoZWwsIG4yLmNoaWxkcmVuKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH07DQogICAgY29uc3QgcHJvY2Vzc0NvbW1lbnROb2RlID0gKG4xLCBuMiwgY29udGFpbmVyLCBhbmNob3IpID0+IHsNCiAgICAgIGlmIChuMSA9PSBudWxsKSB7DQogICAgICAgIGhvc3RJbnNlcnQoDQogICAgICAgICAgbjIuZWwgPSBob3N0Q3JlYXRlQ29tbWVudChuMi5jaGlsZHJlbiB8fCAiIiksDQogICAgICAgICAgY29udGFpbmVyLA0KICAgICAgICAgIGFuY2hvcg0KICAgICAgICApOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgbjIuZWwgPSBuMS5lbDsNCiAgICAgIH0NCiAgICB9Ow0KICAgIGNvbnN0IG1vdW50U3RhdGljTm9kZSA9IChuMiwgY29udGFpbmVyLCBhbmNob3IsIG5hbWVzcGFjZSkgPT4gew0KICAgICAgW24yLmVsLCBuMi5hbmNob3JdID0gaG9zdEluc2VydFN0YXRpY0NvbnRlbnQoDQogICAgICAgIG4yLmNoaWxkcmVuLA0KICAgICAgICBjb250YWluZXIsDQogICAgICAgIGFuY2hvciwNCiAgICAgICAgbmFtZXNwYWNlLA0KICAgICAgICBuMi5lbCwNCiAgICAgICAgbjIuYW5jaG9yDQogICAgICApOw0KICAgIH07DQogICAgY29uc3QgcGF0Y2hTdGF0aWNOb2RlID0gKG4xLCBuMiwgY29udGFpbmVyLCBuYW1lc3BhY2UpID0+IHsNCiAgICAgIGlmIChuMi5jaGlsZHJlbiAhPT0gbjEuY2hpbGRyZW4pIHsNCiAgICAgICAgY29uc3QgYW5jaG9yID0gaG9zdE5leHRTaWJsaW5nKG4xLmFuY2hvcik7DQogICAgICAgIHJlbW92ZVN0YXRpY05vZGUobjEpOw0KICAgICAgICBbbjIuZWwsIG4yLmFuY2hvcl0gPSBob3N0SW5zZXJ0U3RhdGljQ29udGVudCgNCiAgICAgICAgICBuMi5jaGlsZHJlbiwNCiAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgYW5jaG9yLA0KICAgICAgICAgIG5hbWVzcGFjZQ0KICAgICAgICApOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgbjIuZWwgPSBuMS5lbDsNCiAgICAgICAgbjIuYW5jaG9yID0gbjEuYW5jaG9yOw0KICAgICAgfQ0KICAgIH07DQogICAgY29uc3QgbW92ZVN0YXRpY05vZGUgPSAoeyBlbCwgYW5jaG9yIH0sIGNvbnRhaW5lciwgbmV4dFNpYmxpbmcpID0+IHsNCiAgICAgIGxldCBuZXh0Ow0KICAgICAgd2hpbGUgKGVsICYmIGVsICE9PSBhbmNob3IpIHsNCiAgICAgICAgbmV4dCA9IGhvc3ROZXh0U2libGluZyhlbCk7DQogICAgICAgIGhvc3RJbnNlcnQoZWwsIGNvbnRhaW5lciwgbmV4dFNpYmxpbmcpOw0KICAgICAgICBlbCA9IG5leHQ7DQogICAgICB9DQogICAgICBob3N0SW5zZXJ0KGFuY2hvciwgY29udGFpbmVyLCBuZXh0U2libGluZyk7DQogICAgfTsNCiAgICBjb25zdCByZW1vdmVTdGF0aWNOb2RlID0gKHsgZWwsIGFuY2hvciB9KSA9PiB7DQogICAgICBsZXQgbmV4dDsNCiAgICAgIHdoaWxlIChlbCAmJiBlbCAhPT0gYW5jaG9yKSB7DQogICAgICAgIG5leHQgPSBob3N0TmV4dFNpYmxpbmcoZWwpOw0KICAgICAgICBob3N0UmVtb3ZlKGVsKTsNCiAgICAgICAgZWwgPSBuZXh0Ow0KICAgICAgfQ0KICAgICAgaG9zdFJlbW92ZShhbmNob3IpOw0KICAgIH07DQogICAgY29uc3QgcHJvY2Vzc0VsZW1lbnQgPSAobjEsIG4yLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCkgPT4gew0KICAgICAgaWYgKG4yLnR5cGUgPT09ICJzdmciKSB7DQogICAgICAgIG5hbWVzcGFjZSA9ICJzdmciOw0KICAgICAgfSBlbHNlIGlmIChuMi50eXBlID09PSAibWF0aCIpIHsNCiAgICAgICAgbmFtZXNwYWNlID0gIm1hdGhtbCI7DQogICAgICB9DQogICAgICBpZiAobjEgPT0gbnVsbCkgew0KICAgICAgICBtb3VudEVsZW1lbnQoDQogICAgICAgICAgbjIsDQogICAgICAgICAgY29udGFpbmVyLA0KICAgICAgICAgIGFuY2hvciwNCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgbmFtZXNwYWNlLA0KICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICBvcHRpbWl6ZWQNCiAgICAgICAgKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHBhdGNoRWxlbWVudCgNCiAgICAgICAgICBuMSwNCiAgICAgICAgICBuMiwNCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgbmFtZXNwYWNlLA0KICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICBvcHRpbWl6ZWQNCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICB9Ow0KICAgIGNvbnN0IG1vdW50RWxlbWVudCA9ICh2bm9kZSwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIG5hbWVzcGFjZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpID0+IHsNCiAgICAgIGxldCBlbDsNCiAgICAgIGxldCB2bm9kZUhvb2s7DQogICAgICBjb25zdCB7IHByb3BzLCBzaGFwZUZsYWcsIHRyYW5zaXRpb24sIGRpcnMgfSA9IHZub2RlOw0KICAgICAgZWwgPSB2bm9kZS5lbCA9IGhvc3RDcmVhdGVFbGVtZW50KA0KICAgICAgICB2bm9kZS50eXBlLA0KICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgIHByb3BzICYmIHByb3BzLmlzLA0KICAgICAgICBwcm9wcw0KICAgICAgKTsNCiAgICAgIGlmIChzaGFwZUZsYWcgJiA4KSB7DQogICAgICAgIGhvc3RTZXRFbGVtZW50VGV4dChlbCwgdm5vZGUuY2hpbGRyZW4pOw0KICAgICAgfSBlbHNlIGlmIChzaGFwZUZsYWcgJiAxNikgew0KICAgICAgICBtb3VudENoaWxkcmVuKA0KICAgICAgICAgIHZub2RlLmNoaWxkcmVuLA0KICAgICAgICAgIGVsLA0KICAgICAgICAgIG51bGwsDQogICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgIHBhcmVudFN1c3BlbnNlLA0KICAgICAgICAgIHJlc29sdmVDaGlsZHJlbk5hbWVzcGFjZSh2bm9kZSwgbmFtZXNwYWNlKSwNCiAgICAgICAgICBzbG90U2NvcGVJZHMsDQogICAgICAgICAgb3B0aW1pemVkDQogICAgICAgICk7DQogICAgICB9DQogICAgICBpZiAoZGlycykgew0KICAgICAgICBpbnZva2VEaXJlY3RpdmVIb29rKHZub2RlLCBudWxsLCBwYXJlbnRDb21wb25lbnQsICJjcmVhdGVkIik7DQogICAgICB9DQogICAgICBzZXRTY29wZUlkKGVsLCB2bm9kZSwgdm5vZGUuc2NvcGVJZCwgc2xvdFNjb3BlSWRzLCBwYXJlbnRDb21wb25lbnQpOw0KICAgICAgaWYgKHByb3BzKSB7DQogICAgICAgIGZvciAoY29uc3Qga2V5IGluIHByb3BzKSB7DQogICAgICAgICAgaWYgKGtleSAhPT0gInZhbHVlIiAmJiAhaXNSZXNlcnZlZFByb3Aoa2V5KSkgew0KICAgICAgICAgICAgaG9zdFBhdGNoUHJvcChlbCwga2V5LCBudWxsLCBwcm9wc1trZXldLCBuYW1lc3BhY2UsIHBhcmVudENvbXBvbmVudCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGlmICgidmFsdWUiIGluIHByb3BzKSB7DQogICAgICAgICAgaG9zdFBhdGNoUHJvcChlbCwgInZhbHVlIiwgbnVsbCwgcHJvcHMudmFsdWUsIG5hbWVzcGFjZSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHZub2RlSG9vayA9IHByb3BzLm9uVm5vZGVCZWZvcmVNb3VudCkgew0KICAgICAgICAgIGludm9rZVZOb2RlSG9vayh2bm9kZUhvb2ssIHBhcmVudENvbXBvbmVudCwgdm5vZGUpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICB7DQogICAgICAgIGRlZihlbCwgIl9fdm5vZGUiLCB2bm9kZSwgdHJ1ZSk7DQogICAgICAgIGRlZihlbCwgIl9fdnVlUGFyZW50Q29tcG9uZW50IiwgcGFyZW50Q29tcG9uZW50LCB0cnVlKTsNCiAgICAgIH0NCiAgICAgIGlmIChkaXJzKSB7DQogICAgICAgIGludm9rZURpcmVjdGl2ZUhvb2sodm5vZGUsIG51bGwsIHBhcmVudENvbXBvbmVudCwgImJlZm9yZU1vdW50Iik7DQogICAgICB9DQogICAgICBjb25zdCBuZWVkQ2FsbFRyYW5zaXRpb25Ib29rcyA9IG5lZWRUcmFuc2l0aW9uKHBhcmVudFN1c3BlbnNlLCB0cmFuc2l0aW9uKTsNCiAgICAgIGlmIChuZWVkQ2FsbFRyYW5zaXRpb25Ib29rcykgew0KICAgICAgICB0cmFuc2l0aW9uLmJlZm9yZUVudGVyKGVsKTsNCiAgICAgIH0NCiAgICAgIGhvc3RJbnNlcnQoZWwsIGNvbnRhaW5lciwgYW5jaG9yKTsNCiAgICAgIGlmICgodm5vZGVIb29rID0gcHJvcHMgJiYgcHJvcHMub25Wbm9kZU1vdW50ZWQpIHx8IG5lZWRDYWxsVHJhbnNpdGlvbkhvb2tzIHx8IGRpcnMpIHsNCiAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KCgpID0+IHsNCiAgICAgICAgICB2bm9kZUhvb2sgJiYgaW52b2tlVk5vZGVIb29rKHZub2RlSG9vaywgcGFyZW50Q29tcG9uZW50LCB2bm9kZSk7DQogICAgICAgICAgbmVlZENhbGxUcmFuc2l0aW9uSG9va3MgJiYgdHJhbnNpdGlvbi5lbnRlcihlbCk7DQogICAgICAgICAgZGlycyAmJiBpbnZva2VEaXJlY3RpdmVIb29rKHZub2RlLCBudWxsLCBwYXJlbnRDb21wb25lbnQsICJtb3VudGVkIik7DQogICAgICAgIH0sIHBhcmVudFN1c3BlbnNlKTsNCiAgICAgIH0NCiAgICB9Ow0KICAgIGNvbnN0IHNldFNjb3BlSWQgPSAoZWwsIHZub2RlLCBzY29wZUlkLCBzbG90U2NvcGVJZHMsIHBhcmVudENvbXBvbmVudCkgPT4gew0KICAgICAgaWYgKHNjb3BlSWQpIHsNCiAgICAgICAgaG9zdFNldFNjb3BlSWQoZWwsIHNjb3BlSWQpOw0KICAgICAgfQ0KICAgICAgaWYgKHNsb3RTY29wZUlkcykgew0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNsb3RTY29wZUlkcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgIGhvc3RTZXRTY29wZUlkKGVsLCBzbG90U2NvcGVJZHNbaV0pOw0KICAgICAgICB9DQogICAgICB9DQogICAgICBpZiAocGFyZW50Q29tcG9uZW50KSB7DQogICAgICAgIGxldCBzdWJUcmVlID0gcGFyZW50Q29tcG9uZW50LnN1YlRyZWU7DQogICAgICAgIGlmIChzdWJUcmVlLnBhdGNoRmxhZyA+IDAgJiYgc3ViVHJlZS5wYXRjaEZsYWcgJiAyMDQ4KSB7DQogICAgICAgICAgc3ViVHJlZSA9IGZpbHRlclNpbmdsZVJvb3Qoc3ViVHJlZS5jaGlsZHJlbikgfHwgc3ViVHJlZTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAodm5vZGUgPT09IHN1YlRyZWUgfHwgaXNTdXNwZW5zZShzdWJUcmVlLnR5cGUpICYmIChzdWJUcmVlLnNzQ29udGVudCA9PT0gdm5vZGUgfHwgc3ViVHJlZS5zc0ZhbGxiYWNrID09PSB2bm9kZSkpIHsNCiAgICAgICAgICBjb25zdCBwYXJlbnRWTm9kZSA9IHBhcmVudENvbXBvbmVudC52bm9kZTsNCiAgICAgICAgICBzZXRTY29wZUlkKA0KICAgICAgICAgICAgZWwsDQogICAgICAgICAgICBwYXJlbnRWTm9kZSwNCiAgICAgICAgICAgIHBhcmVudFZOb2RlLnNjb3BlSWQsDQogICAgICAgICAgICBwYXJlbnRWTm9kZS5zbG90U2NvcGVJZHMsDQogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQucGFyZW50DQogICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH07DQogICAgY29uc3QgbW91bnRDaGlsZHJlbiA9IChjaGlsZHJlbiwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIG5hbWVzcGFjZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQsIHN0YXJ0ID0gMCkgPT4gew0KICAgICAgZm9yIChsZXQgaSA9IHN0YXJ0OyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXSA9IG9wdGltaXplZCA/IGNsb25lSWZNb3VudGVkKGNoaWxkcmVuW2ldKSA6IG5vcm1hbGl6ZVZOb2RlKGNoaWxkcmVuW2ldKTsNCiAgICAgICAgcGF0Y2goDQogICAgICAgICAgbnVsbCwNCiAgICAgICAgICBjaGlsZCwNCiAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgYW5jaG9yLA0KICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH07DQogICAgY29uc3QgcGF0Y2hFbGVtZW50ID0gKG4xLCBuMiwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCkgPT4gew0KICAgICAgY29uc3QgZWwgPSBuMi5lbCA9IG4xLmVsOw0KICAgICAgew0KICAgICAgICBlbC5fX3Zub2RlID0gbjI7DQogICAgICB9DQogICAgICBsZXQgeyBwYXRjaEZsYWcsIGR5bmFtaWNDaGlsZHJlbiwgZGlycyB9ID0gbjI7DQogICAgICBwYXRjaEZsYWcgfD0gbjEucGF0Y2hGbGFnICYgMTY7DQogICAgICBjb25zdCBvbGRQcm9wcyA9IG4xLnByb3BzIHx8IEVNUFRZX09CSjsNCiAgICAgIGNvbnN0IG5ld1Byb3BzID0gbjIucHJvcHMgfHwgRU1QVFlfT0JKOw0KICAgICAgbGV0IHZub2RlSG9vazsNCiAgICAgIHBhcmVudENvbXBvbmVudCAmJiB0b2dnbGVSZWN1cnNlKHBhcmVudENvbXBvbmVudCwgZmFsc2UpOw0KICAgICAgaWYgKHZub2RlSG9vayA9IG5ld1Byb3BzLm9uVm5vZGVCZWZvcmVVcGRhdGUpIHsNCiAgICAgICAgaW52b2tlVk5vZGVIb29rKHZub2RlSG9vaywgcGFyZW50Q29tcG9uZW50LCBuMiwgbjEpOw0KICAgICAgfQ0KICAgICAgaWYgKGRpcnMpIHsNCiAgICAgICAgaW52b2tlRGlyZWN0aXZlSG9vayhuMiwgbjEsIHBhcmVudENvbXBvbmVudCwgImJlZm9yZVVwZGF0ZSIpOw0KICAgICAgfQ0KICAgICAgcGFyZW50Q29tcG9uZW50ICYmIHRvZ2dsZVJlY3Vyc2UocGFyZW50Q29tcG9uZW50LCB0cnVlKTsNCiAgICAgIGlmIChpc0htclVwZGF0aW5nKSB7DQogICAgICAgIHBhdGNoRmxhZyA9IDA7DQogICAgICAgIG9wdGltaXplZCA9IGZhbHNlOw0KICAgICAgICBkeW5hbWljQ2hpbGRyZW4gPSBudWxsOw0KICAgICAgfQ0KICAgICAgaWYgKG9sZFByb3BzLmlubmVySFRNTCAmJiBuZXdQcm9wcy5pbm5lckhUTUwgPT0gbnVsbCB8fCBvbGRQcm9wcy50ZXh0Q29udGVudCAmJiBuZXdQcm9wcy50ZXh0Q29udGVudCA9PSBudWxsKSB7DQogICAgICAgIGhvc3RTZXRFbGVtZW50VGV4dChlbCwgIiIpOw0KICAgICAgfQ0KICAgICAgaWYgKGR5bmFtaWNDaGlsZHJlbikgew0KICAgICAgICBwYXRjaEJsb2NrQ2hpbGRyZW4oDQogICAgICAgICAgbjEuZHluYW1pY0NoaWxkcmVuLA0KICAgICAgICAgIGR5bmFtaWNDaGlsZHJlbiwNCiAgICAgICAgICBlbCwNCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgcmVzb2x2ZUNoaWxkcmVuTmFtZXNwYWNlKG4yLCBuYW1lc3BhY2UpLA0KICAgICAgICAgIHNsb3RTY29wZUlkcw0KICAgICAgICApOw0KICAgICAgICB7DQogICAgICAgICAgdHJhdmVyc2VTdGF0aWNDaGlsZHJlbihuMSwgbjIpOw0KICAgICAgICB9DQogICAgICB9IGVsc2UgaWYgKCFvcHRpbWl6ZWQpIHsNCiAgICAgICAgcGF0Y2hDaGlsZHJlbigNCiAgICAgICAgICBuMSwNCiAgICAgICAgICBuMiwNCiAgICAgICAgICBlbCwNCiAgICAgICAgICBudWxsLA0KICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICByZXNvbHZlQ2hpbGRyZW5OYW1lc3BhY2UobjIsIG5hbWVzcGFjZSksDQogICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgIGZhbHNlDQogICAgICAgICk7DQogICAgICB9DQogICAgICBpZiAocGF0Y2hGbGFnID4gMCkgew0KICAgICAgICBpZiAocGF0Y2hGbGFnICYgMTYpIHsNCiAgICAgICAgICBwYXRjaFByb3BzKGVsLCBvbGRQcm9wcywgbmV3UHJvcHMsIHBhcmVudENvbXBvbmVudCwgbmFtZXNwYWNlKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBpZiAocGF0Y2hGbGFnICYgMikgew0KICAgICAgICAgICAgaWYgKG9sZFByb3BzLmNsYXNzICE9PSBuZXdQcm9wcy5jbGFzcykgew0KICAgICAgICAgICAgICBob3N0UGF0Y2hQcm9wKGVsLCAiY2xhc3MiLCBudWxsLCBuZXdQcm9wcy5jbGFzcywgbmFtZXNwYWNlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKHBhdGNoRmxhZyAmIDQpIHsNCiAgICAgICAgICAgIGhvc3RQYXRjaFByb3AoZWwsICJzdHlsZSIsIG9sZFByb3BzLnN0eWxlLCBuZXdQcm9wcy5zdHlsZSwgbmFtZXNwYWNlKTsNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKHBhdGNoRmxhZyAmIDgpIHsNCiAgICAgICAgICAgIGNvbnN0IHByb3BzVG9VcGRhdGUgPSBuMi5keW5hbWljUHJvcHM7DQogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb3BzVG9VcGRhdGUubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgY29uc3Qga2V5ID0gcHJvcHNUb1VwZGF0ZVtpXTsNCiAgICAgICAgICAgICAgY29uc3QgcHJldiA9IG9sZFByb3BzW2tleV07DQogICAgICAgICAgICAgIGNvbnN0IG5leHQgPSBuZXdQcm9wc1trZXldOw0KICAgICAgICAgICAgICBpZiAobmV4dCAhPT0gcHJldiB8fCBrZXkgPT09ICJ2YWx1ZSIpIHsNCiAgICAgICAgICAgICAgICBob3N0UGF0Y2hQcm9wKGVsLCBrZXksIHByZXYsIG5leHQsIG5hbWVzcGFjZSwgcGFyZW50Q29tcG9uZW50KTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBpZiAocGF0Y2hGbGFnICYgMSkgew0KICAgICAgICAgIGlmIChuMS5jaGlsZHJlbiAhPT0gbjIuY2hpbGRyZW4pIHsNCiAgICAgICAgICAgIGhvc3RTZXRFbGVtZW50VGV4dChlbCwgbjIuY2hpbGRyZW4pOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIGlmICghb3B0aW1pemVkICYmIGR5bmFtaWNDaGlsZHJlbiA9PSBudWxsKSB7DQogICAgICAgIHBhdGNoUHJvcHMoZWwsIG9sZFByb3BzLCBuZXdQcm9wcywgcGFyZW50Q29tcG9uZW50LCBuYW1lc3BhY2UpOw0KICAgICAgfQ0KICAgICAgaWYgKCh2bm9kZUhvb2sgPSBuZXdQcm9wcy5vblZub2RlVXBkYXRlZCkgfHwgZGlycykgew0KICAgICAgICBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QoKCkgPT4gew0KICAgICAgICAgIHZub2RlSG9vayAmJiBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBwYXJlbnRDb21wb25lbnQsIG4yLCBuMSk7DQogICAgICAgICAgZGlycyAmJiBpbnZva2VEaXJlY3RpdmVIb29rKG4yLCBuMSwgcGFyZW50Q29tcG9uZW50LCAidXBkYXRlZCIpOw0KICAgICAgICB9LCBwYXJlbnRTdXNwZW5zZSk7DQogICAgICB9DQogICAgfTsNCiAgICBjb25zdCBwYXRjaEJsb2NrQ2hpbGRyZW4gPSAob2xkQ2hpbGRyZW4sIG5ld0NoaWxkcmVuLCBmYWxsYmFja0NvbnRhaW5lciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBzbG90U2NvcGVJZHMpID0+IHsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgY29uc3Qgb2xkVk5vZGUgPSBvbGRDaGlsZHJlbltpXTsNCiAgICAgICAgY29uc3QgbmV3Vk5vZGUgPSBuZXdDaGlsZHJlbltpXTsNCiAgICAgICAgY29uc3QgY29udGFpbmVyID0gKA0KICAgICAgICAgIC8vIG9sZFZOb2RlIG1heSBiZSBhbiBlcnJvcmVkIGFzeW5jIHNldHVwKCkgY29tcG9uZW50IGluc2lkZSBTdXNwZW5zZQ0KICAgICAgICAgIC8vIHdoaWNoIHdpbGwgbm90IGhhdmUgYSBtb3VudGVkIGVsZW1lbnQNCiAgICAgICAgICBvbGRWTm9kZS5lbCAmJiAvLyAtIEluIHRoZSBjYXNlIG9mIGEgRnJhZ21lbnQsIHdlIG5lZWQgdG8gcHJvdmlkZSB0aGUgYWN0dWFsIHBhcmVudA0KICAgICAgICAgIC8vIG9mIHRoZSBGcmFnbWVudCBpdHNlbGYgc28gaXQgY2FuIG1vdmUgaXRzIGNoaWxkcmVuLg0KICAgICAgICAgIChvbGRWTm9kZS50eXBlID09PSBGcmFnbWVudCB8fCAvLyAtIEluIHRoZSBjYXNlIG9mIGRpZmZlcmVudCBub2RlcywgdGhlcmUgaXMgZ29pbmcgdG8gYmUgYSByZXBsYWNlbWVudA0KICAgICAgICAgIC8vIHdoaWNoIGFsc28gcmVxdWlyZXMgdGhlIGNvcnJlY3QgcGFyZW50IGNvbnRhaW5lcg0KICAgICAgICAgICFpc1NhbWVWTm9kZVR5cGUob2xkVk5vZGUsIG5ld1ZOb2RlKSB8fCAvLyAtIEluIHRoZSBjYXNlIG9mIGEgY29tcG9uZW50LCBpdCBjb3VsZCBjb250YWluIGFueXRoaW5nLg0KICAgICAgICAgIG9sZFZOb2RlLnNoYXBlRmxhZyAmICg2IHwgNjQgfCAxMjgpKSA/IGhvc3RQYXJlbnROb2RlKG9sZFZOb2RlLmVsKSA6ICgNCiAgICAgICAgICAgIC8vIEluIG90aGVyIGNhc2VzLCB0aGUgcGFyZW50IGNvbnRhaW5lciBpcyBub3QgYWN0dWFsbHkgdXNlZCBzbyB3ZQ0KICAgICAgICAgICAgLy8ganVzdCBwYXNzIHRoZSBibG9jayBlbGVtZW50IGhlcmUgdG8gYXZvaWQgYSBET00gcGFyZW50Tm9kZSBjYWxsLg0KICAgICAgICAgICAgZmFsbGJhY2tDb250YWluZXINCiAgICAgICAgICApDQogICAgICAgICk7DQogICAgICAgIHBhdGNoKA0KICAgICAgICAgIG9sZFZOb2RlLA0KICAgICAgICAgIG5ld1ZOb2RlLA0KICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICBudWxsLA0KICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgIHRydWUNCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICB9Ow0KICAgIGNvbnN0IHBhdGNoUHJvcHMgPSAoZWwsIG9sZFByb3BzLCBuZXdQcm9wcywgcGFyZW50Q29tcG9uZW50LCBuYW1lc3BhY2UpID0+IHsNCiAgICAgIGlmIChvbGRQcm9wcyAhPT0gbmV3UHJvcHMpIHsNCiAgICAgICAgaWYgKG9sZFByb3BzICE9PSBFTVBUWV9PQkopIHsNCiAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBvbGRQcm9wcykgew0KICAgICAgICAgICAgaWYgKCFpc1Jlc2VydmVkUHJvcChrZXkpICYmICEoa2V5IGluIG5ld1Byb3BzKSkgew0KICAgICAgICAgICAgICBob3N0UGF0Y2hQcm9wKA0KICAgICAgICAgICAgICAgIGVsLA0KICAgICAgICAgICAgICAgIGtleSwNCiAgICAgICAgICAgICAgICBvbGRQcm9wc1trZXldLA0KICAgICAgICAgICAgICAgIG51bGwsDQogICAgICAgICAgICAgICAgbmFtZXNwYWNlLA0KICAgICAgICAgICAgICAgIHBhcmVudENvbXBvbmVudA0KICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBuZXdQcm9wcykgew0KICAgICAgICAgIGlmIChpc1Jlc2VydmVkUHJvcChrZXkpKSBjb250aW51ZTsNCiAgICAgICAgICBjb25zdCBuZXh0ID0gbmV3UHJvcHNba2V5XTsNCiAgICAgICAgICBjb25zdCBwcmV2ID0gb2xkUHJvcHNba2V5XTsNCiAgICAgICAgICBpZiAobmV4dCAhPT0gcHJldiAmJiBrZXkgIT09ICJ2YWx1ZSIpIHsNCiAgICAgICAgICAgIGhvc3RQYXRjaFByb3AoZWwsIGtleSwgcHJldiwgbmV4dCwgbmFtZXNwYWNlLCBwYXJlbnRDb21wb25lbnQpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBpZiAoInZhbHVlIiBpbiBuZXdQcm9wcykgew0KICAgICAgICAgIGhvc3RQYXRjaFByb3AoZWwsICJ2YWx1ZSIsIG9sZFByb3BzLnZhbHVlLCBuZXdQcm9wcy52YWx1ZSwgbmFtZXNwYWNlKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH07DQogICAgY29uc3QgcHJvY2Vzc0ZyYWdtZW50ID0gKG4xLCBuMiwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIG5hbWVzcGFjZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpID0+IHsNCiAgICAgIGNvbnN0IGZyYWdtZW50U3RhcnRBbmNob3IgPSBuMi5lbCA9IG4xID8gbjEuZWwgOiBob3N0Q3JlYXRlVGV4dCgiIik7DQogICAgICBjb25zdCBmcmFnbWVudEVuZEFuY2hvciA9IG4yLmFuY2hvciA9IG4xID8gbjEuYW5jaG9yIDogaG9zdENyZWF0ZVRleHQoIiIpOw0KICAgICAgbGV0IHsgcGF0Y2hGbGFnLCBkeW5hbWljQ2hpbGRyZW4sIHNsb3RTY29wZUlkczogZnJhZ21lbnRTbG90U2NvcGVJZHMgfSA9IG4yOw0KICAgICAgaWYgKA0KICAgICAgICAvLyAjNTUyMyBkZXYgcm9vdCBmcmFnbWVudCBtYXkgaW5oZXJpdCBkaXJlY3RpdmVzDQogICAgICAgIGlzSG1yVXBkYXRpbmcgfHwgcGF0Y2hGbGFnICYgMjA0OA0KICAgICAgKSB7DQogICAgICAgIHBhdGNoRmxhZyA9IDA7DQogICAgICAgIG9wdGltaXplZCA9IGZhbHNlOw0KICAgICAgICBkeW5hbWljQ2hpbGRyZW4gPSBudWxsOw0KICAgICAgfQ0KICAgICAgaWYgKGZyYWdtZW50U2xvdFNjb3BlSWRzKSB7DQogICAgICAgIHNsb3RTY29wZUlkcyA9IHNsb3RTY29wZUlkcyA/IHNsb3RTY29wZUlkcy5jb25jYXQoZnJhZ21lbnRTbG90U2NvcGVJZHMpIDogZnJhZ21lbnRTbG90U2NvcGVJZHM7DQogICAgICB9DQogICAgICBpZiAobjEgPT0gbnVsbCkgew0KICAgICAgICBob3N0SW5zZXJ0KGZyYWdtZW50U3RhcnRBbmNob3IsIGNvbnRhaW5lciwgYW5jaG9yKTsNCiAgICAgICAgaG9zdEluc2VydChmcmFnbWVudEVuZEFuY2hvciwgY29udGFpbmVyLCBhbmNob3IpOw0KICAgICAgICBtb3VudENoaWxkcmVuKA0KICAgICAgICAgIC8vICMxMDAwNw0KICAgICAgICAgIC8vIHN1Y2ggZnJhZ21lbnQgbGlrZSBgPD48Lz5gIHdpbGwgYmUgY29tcGlsZWQgaW50bw0KICAgICAgICAgIC8vIGEgZnJhZ21lbnQgd2hpY2ggZG9lc24ndCBoYXZlIGEgY2hpbGRyZW4uDQogICAgICAgICAgLy8gSW4gdGhpcyBjYXNlIGZhbGxiYWNrIHRvIGFuIGVtcHR5IGFycmF5DQogICAgICAgICAgbjIuY2hpbGRyZW4gfHwgW10sDQogICAgICAgICAgY29udGFpbmVyLA0KICAgICAgICAgIGZyYWdtZW50RW5kQW5jaG9yLA0KICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICApOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgaWYgKHBhdGNoRmxhZyA+IDAgJiYgcGF0Y2hGbGFnICYgNjQgJiYgZHluYW1pY0NoaWxkcmVuICYmIC8vICMyNzE1IHRoZSBwcmV2aW91cyBmcmFnbWVudCBjb3VsZCd2ZSBiZWVuIGEgQkFJTGVkIG9uZSBhcyBhIHJlc3VsdA0KICAgICAgICAvLyBvZiByZW5kZXJTbG90KCkgd2l0aCBubyB2YWxpZCBjaGlsZHJlbg0KICAgICAgICBuMS5keW5hbWljQ2hpbGRyZW4pIHsNCiAgICAgICAgICBwYXRjaEJsb2NrQ2hpbGRyZW4oDQogICAgICAgICAgICBuMS5keW5hbWljQ2hpbGRyZW4sDQogICAgICAgICAgICBkeW5hbWljQ2hpbGRyZW4sDQogICAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICAgIHNsb3RTY29wZUlkcw0KICAgICAgICAgICk7DQogICAgICAgICAgew0KICAgICAgICAgICAgdHJhdmVyc2VTdGF0aWNDaGlsZHJlbihuMSwgbjIpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBwYXRjaENoaWxkcmVuKA0KICAgICAgICAgICAgbjEsDQogICAgICAgICAgICBuMiwNCiAgICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICAgIGZyYWdtZW50RW5kQW5jaG9yLA0KICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgICBzbG90U2NvcGVJZHMsDQogICAgICAgICAgICBvcHRpbWl6ZWQNCiAgICAgICAgICApOw0KICAgICAgICB9DQogICAgICB9DQogICAgfTsNCiAgICBjb25zdCBwcm9jZXNzQ29tcG9uZW50ID0gKG4xLCBuMiwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIG5hbWVzcGFjZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpID0+IHsNCiAgICAgIG4yLnNsb3RTY29wZUlkcyA9IHNsb3RTY29wZUlkczsNCiAgICAgIGlmIChuMSA9PSBudWxsKSB7DQogICAgICAgIGlmIChuMi5zaGFwZUZsYWcgJiA1MTIpIHsNCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQuY3R4LmFjdGl2YXRlKA0KICAgICAgICAgICAgbjIsDQogICAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgICBhbmNob3IsDQogICAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgICBvcHRpbWl6ZWQNCiAgICAgICAgICApOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIG1vdW50Q29tcG9uZW50KA0KICAgICAgICAgICAgbjIsDQogICAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgICBhbmNob3IsDQogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICAgICk7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHVwZGF0ZUNvbXBvbmVudChuMSwgbjIsIG9wdGltaXplZCk7DQogICAgICB9DQogICAgfTsNCiAgICBjb25zdCBtb3VudENvbXBvbmVudCA9IChpbml0aWFsVk5vZGUsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBuYW1lc3BhY2UsIG9wdGltaXplZCkgPT4gew0KICAgICAgY29uc3QgaW5zdGFuY2UgPSAoaW5pdGlhbFZOb2RlLmNvbXBvbmVudCA9IGNyZWF0ZUNvbXBvbmVudEluc3RhbmNlKA0KICAgICAgICBpbml0aWFsVk5vZGUsDQogICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgcGFyZW50U3VzcGVuc2UNCiAgICAgICkpOw0KICAgICAgaWYgKGluc3RhbmNlLnR5cGUuX19obXJJZCkgew0KICAgICAgICByZWdpc3RlckhNUihpbnN0YW5jZSk7DQogICAgICB9DQogICAgICB7DQogICAgICAgIHB1c2hXYXJuaW5nQ29udGV4dChpbml0aWFsVk5vZGUpOw0KICAgICAgICBzdGFydE1lYXN1cmUoaW5zdGFuY2UsIGBtb3VudGApOw0KICAgICAgfQ0KICAgICAgaWYgKGlzS2VlcEFsaXZlKGluaXRpYWxWTm9kZSkpIHsNCiAgICAgICAgaW5zdGFuY2UuY3R4LnJlbmRlcmVyID0gaW50ZXJuYWxzOw0KICAgICAgfQ0KICAgICAgew0KICAgICAgICB7DQogICAgICAgICAgc3RhcnRNZWFzdXJlKGluc3RhbmNlLCBgaW5pdGApOw0KICAgICAgICB9DQogICAgICAgIHNldHVwQ29tcG9uZW50KGluc3RhbmNlLCBmYWxzZSwgb3B0aW1pemVkKTsNCiAgICAgICAgew0KICAgICAgICAgIGVuZE1lYXN1cmUoaW5zdGFuY2UsIGBpbml0YCk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmIChpc0htclVwZGF0aW5nKSBpbml0aWFsVk5vZGUuZWwgPSBudWxsOw0KICAgICAgaWYgKGluc3RhbmNlLmFzeW5jRGVwKSB7DQogICAgICAgIHBhcmVudFN1c3BlbnNlICYmIHBhcmVudFN1c3BlbnNlLnJlZ2lzdGVyRGVwKGluc3RhbmNlLCBzZXR1cFJlbmRlckVmZmVjdCwgb3B0aW1pemVkKTsNCiAgICAgICAgaWYgKCFpbml0aWFsVk5vZGUuZWwpIHsNCiAgICAgICAgICBjb25zdCBwbGFjZWhvbGRlciA9IGluc3RhbmNlLnN1YlRyZWUgPSBjcmVhdGVWTm9kZShDb21tZW50KTsNCiAgICAgICAgICBwcm9jZXNzQ29tbWVudE5vZGUobnVsbCwgcGxhY2Vob2xkZXIsIGNvbnRhaW5lciwgYW5jaG9yKTsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgc2V0dXBSZW5kZXJFZmZlY3QoDQogICAgICAgICAgaW5zdGFuY2UsDQogICAgICAgICAgaW5pdGlhbFZOb2RlLA0KICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICBhbmNob3IsDQogICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgbmFtZXNwYWNlLA0KICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICApOw0KICAgICAgfQ0KICAgICAgew0KICAgICAgICBwb3BXYXJuaW5nQ29udGV4dCgpOw0KICAgICAgICBlbmRNZWFzdXJlKGluc3RhbmNlLCBgbW91bnRgKTsNCiAgICAgIH0NCiAgICB9Ow0KICAgIGNvbnN0IHVwZGF0ZUNvbXBvbmVudCA9IChuMSwgbjIsIG9wdGltaXplZCkgPT4gew0KICAgICAgY29uc3QgaW5zdGFuY2UgPSBuMi5jb21wb25lbnQgPSBuMS5jb21wb25lbnQ7DQogICAgICBpZiAoc2hvdWxkVXBkYXRlQ29tcG9uZW50KG4xLCBuMiwgb3B0aW1pemVkKSkgew0KICAgICAgICBpZiAoaW5zdGFuY2UuYXN5bmNEZXAgJiYgIWluc3RhbmNlLmFzeW5jUmVzb2x2ZWQpIHsNCiAgICAgICAgICB7DQogICAgICAgICAgICBwdXNoV2FybmluZ0NvbnRleHQobjIpOw0KICAgICAgICAgIH0NCiAgICAgICAgICB1cGRhdGVDb21wb25lbnRQcmVSZW5kZXIoaW5zdGFuY2UsIG4yLCBvcHRpbWl6ZWQpOw0KICAgICAgICAgIHsNCiAgICAgICAgICAgIHBvcFdhcm5pbmdDb250ZXh0KCk7DQogICAgICAgICAgfQ0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBpbnN0YW5jZS5uZXh0ID0gbjI7DQogICAgICAgICAgaW5zdGFuY2UudXBkYXRlKCk7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIG4yLmVsID0gbjEuZWw7DQogICAgICAgIGluc3RhbmNlLnZub2RlID0gbjI7DQogICAgICB9DQogICAgfTsNCiAgICBjb25zdCBzZXR1cFJlbmRlckVmZmVjdCA9IChpbnN0YW5jZSwgaW5pdGlhbFZOb2RlLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50U3VzcGVuc2UsIG5hbWVzcGFjZSwgb3B0aW1pemVkKSA9PiB7DQogICAgICBjb25zdCBjb21wb25lbnRVcGRhdGVGbiA9ICgpID0+IHsNCiAgICAgICAgaWYgKCFpbnN0YW5jZS5pc01vdW50ZWQpIHsNCiAgICAgICAgICBsZXQgdm5vZGVIb29rOw0KICAgICAgICAgIGNvbnN0IHsgZWwsIHByb3BzIH0gPSBpbml0aWFsVk5vZGU7DQogICAgICAgICAgY29uc3QgeyBibSwgbSwgcGFyZW50LCByb290LCB0eXBlIH0gPSBpbnN0YW5jZTsNCiAgICAgICAgICBjb25zdCBpc0FzeW5jV3JhcHBlclZOb2RlID0gaXNBc3luY1dyYXBwZXIoaW5pdGlhbFZOb2RlKTsNCiAgICAgICAgICB0b2dnbGVSZWN1cnNlKGluc3RhbmNlLCBmYWxzZSk7DQogICAgICAgICAgaWYgKGJtKSB7DQogICAgICAgICAgICBpbnZva2VBcnJheUZucyhibSk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmICghaXNBc3luY1dyYXBwZXJWTm9kZSAmJiAodm5vZGVIb29rID0gcHJvcHMgJiYgcHJvcHMub25Wbm9kZUJlZm9yZU1vdW50KSkgew0KICAgICAgICAgICAgaW52b2tlVk5vZGVIb29rKHZub2RlSG9vaywgcGFyZW50LCBpbml0aWFsVk5vZGUpOw0KICAgICAgICAgIH0NCiAgICAgICAgICB0b2dnbGVSZWN1cnNlKGluc3RhbmNlLCB0cnVlKTsNCiAgICAgICAgICBpZiAoZWwgJiYgaHlkcmF0ZU5vZGUpIHsNCiAgICAgICAgICAgIGNvbnN0IGh5ZHJhdGVTdWJUcmVlID0gKCkgPT4gew0KICAgICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgc3RhcnRNZWFzdXJlKGluc3RhbmNlLCBgcmVuZGVyYCk7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgaW5zdGFuY2Uuc3ViVHJlZSA9IHJlbmRlckNvbXBvbmVudFJvb3QoaW5zdGFuY2UpOw0KICAgICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgZW5kTWVhc3VyZShpbnN0YW5jZSwgYHJlbmRlcmApOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgICBzdGFydE1lYXN1cmUoaW5zdGFuY2UsIGBoeWRyYXRlYCk7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgaHlkcmF0ZU5vZGUoDQogICAgICAgICAgICAgICAgZWwsDQogICAgICAgICAgICAgICAgaW5zdGFuY2Uuc3ViVHJlZSwNCiAgICAgICAgICAgICAgICBpbnN0YW5jZSwNCiAgICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgICAgICBudWxsDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgICBlbmRNZWFzdXJlKGluc3RhbmNlLCBgaHlkcmF0ZWApOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgaWYgKGlzQXN5bmNXcmFwcGVyVk5vZGUgJiYgdHlwZS5fX2FzeW5jSHlkcmF0ZSkgew0KICAgICAgICAgICAgICB0eXBlLl9fYXN5bmNIeWRyYXRlKA0KICAgICAgICAgICAgICAgIGVsLA0KICAgICAgICAgICAgICAgIGluc3RhbmNlLA0KICAgICAgICAgICAgICAgIGh5ZHJhdGVTdWJUcmVlDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICBoeWRyYXRlU3ViVHJlZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBpZiAocm9vdC5jZSAmJiAvLyBAdHMtZXhwZWN0LWVycm9yIF9kZWYgaXMgcHJpdmF0ZQ0KICAgICAgICAgICAgcm9vdC5jZS5fZGVmLnNoYWRvd1Jvb3QgIT09IGZhbHNlKSB7DQogICAgICAgICAgICAgIHJvb3QuY2UuX2luamVjdENoaWxkU3R5bGUodHlwZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB7DQogICAgICAgICAgICAgIHN0YXJ0TWVhc3VyZShpbnN0YW5jZSwgYHJlbmRlcmApOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY29uc3Qgc3ViVHJlZSA9IGluc3RhbmNlLnN1YlRyZWUgPSByZW5kZXJDb21wb25lbnRSb290KGluc3RhbmNlKTsNCiAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgZW5kTWVhc3VyZShpbnN0YW5jZSwgYHJlbmRlcmApOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICBzdGFydE1lYXN1cmUoaW5zdGFuY2UsIGBwYXRjaGApOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcGF0Y2goDQogICAgICAgICAgICAgIG51bGwsDQogICAgICAgICAgICAgIHN1YlRyZWUsDQogICAgICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICAgICAgYW5jaG9yLA0KICAgICAgICAgICAgICBpbnN0YW5jZSwNCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICAgIG5hbWVzcGFjZQ0KICAgICAgICAgICAgKTsNCiAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgZW5kTWVhc3VyZShpbnN0YW5jZSwgYHBhdGNoYCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpbml0aWFsVk5vZGUuZWwgPSBzdWJUcmVlLmVsOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpZiAobSkgew0KICAgICAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KG0sIHBhcmVudFN1c3BlbnNlKTsNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKCFpc0FzeW5jV3JhcHBlclZOb2RlICYmICh2bm9kZUhvb2sgPSBwcm9wcyAmJiBwcm9wcy5vblZub2RlTW91bnRlZCkpIHsNCiAgICAgICAgICAgIGNvbnN0IHNjb3BlZEluaXRpYWxWTm9kZSA9IGluaXRpYWxWTm9kZTsNCiAgICAgICAgICAgIHF1ZXVlUG9zdFJlbmRlckVmZmVjdCgNCiAgICAgICAgICAgICAgKCkgPT4gaW52b2tlVk5vZGVIb29rKHZub2RlSG9vaywgcGFyZW50LCBzY29wZWRJbml0aWFsVk5vZGUpLA0KICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZQ0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKGluaXRpYWxWTm9kZS5zaGFwZUZsYWcgJiAyNTYgfHwgcGFyZW50ICYmIGlzQXN5bmNXcmFwcGVyKHBhcmVudC52bm9kZSkgJiYgcGFyZW50LnZub2RlLnNoYXBlRmxhZyAmIDI1Nikgew0KICAgICAgICAgICAgaW5zdGFuY2UuYSAmJiBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QoaW5zdGFuY2UuYSwgcGFyZW50U3VzcGVuc2UpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpbnN0YW5jZS5pc01vdW50ZWQgPSB0cnVlOw0KICAgICAgICAgIHsNCiAgICAgICAgICAgIGRldnRvb2xzQ29tcG9uZW50QWRkZWQoaW5zdGFuY2UpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpbml0aWFsVk5vZGUgPSBjb250YWluZXIgPSBhbmNob3IgPSBudWxsOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGxldCB7IG5leHQsIGJ1LCB1LCBwYXJlbnQsIHZub2RlIH0gPSBpbnN0YW5jZTsNCiAgICAgICAgICB7DQogICAgICAgICAgICBjb25zdCBub25IeWRyYXRlZEFzeW5jUm9vdCA9IGxvY2F0ZU5vbkh5ZHJhdGVkQXN5bmNSb290KGluc3RhbmNlKTsNCiAgICAgICAgICAgIGlmIChub25IeWRyYXRlZEFzeW5jUm9vdCkgew0KICAgICAgICAgICAgICBpZiAobmV4dCkgew0KICAgICAgICAgICAgICAgIG5leHQuZWwgPSB2bm9kZS5lbDsNCiAgICAgICAgICAgICAgICB1cGRhdGVDb21wb25lbnRQcmVSZW5kZXIoaW5zdGFuY2UsIG5leHQsIG9wdGltaXplZCk7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgbm9uSHlkcmF0ZWRBc3luY1Jvb3QuYXN5bmNEZXAudGhlbigoKSA9PiB7DQogICAgICAgICAgICAgICAgaWYgKCFpbnN0YW5jZS5pc1VubW91bnRlZCkgew0KICAgICAgICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlRm4oKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICAgIGxldCBvcmlnaW5OZXh0ID0gbmV4dDsNCiAgICAgICAgICBsZXQgdm5vZGVIb29rOw0KICAgICAgICAgIHsNCiAgICAgICAgICAgIHB1c2hXYXJuaW5nQ29udGV4dChuZXh0IHx8IGluc3RhbmNlLnZub2RlKTsNCiAgICAgICAgICB9DQogICAgICAgICAgdG9nZ2xlUmVjdXJzZShpbnN0YW5jZSwgZmFsc2UpOw0KICAgICAgICAgIGlmIChuZXh0KSB7DQogICAgICAgICAgICBuZXh0LmVsID0gdm5vZGUuZWw7DQogICAgICAgICAgICB1cGRhdGVDb21wb25lbnRQcmVSZW5kZXIoaW5zdGFuY2UsIG5leHQsIG9wdGltaXplZCk7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIG5leHQgPSB2bm9kZTsNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKGJ1KSB7DQogICAgICAgICAgICBpbnZva2VBcnJheUZucyhidSk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmICh2bm9kZUhvb2sgPSBuZXh0LnByb3BzICYmIG5leHQucHJvcHMub25Wbm9kZUJlZm9yZVVwZGF0ZSkgew0KICAgICAgICAgICAgaW52b2tlVk5vZGVIb29rKHZub2RlSG9vaywgcGFyZW50LCBuZXh0LCB2bm9kZSk7DQogICAgICAgICAgfQ0KICAgICAgICAgIHRvZ2dsZVJlY3Vyc2UoaW5zdGFuY2UsIHRydWUpOw0KICAgICAgICAgIHsNCiAgICAgICAgICAgIHN0YXJ0TWVhc3VyZShpbnN0YW5jZSwgYHJlbmRlcmApOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjb25zdCBuZXh0VHJlZSA9IHJlbmRlckNvbXBvbmVudFJvb3QoaW5zdGFuY2UpOw0KICAgICAgICAgIHsNCiAgICAgICAgICAgIGVuZE1lYXN1cmUoaW5zdGFuY2UsIGByZW5kZXJgKTsNCiAgICAgICAgICB9DQogICAgICAgICAgY29uc3QgcHJldlRyZWUgPSBpbnN0YW5jZS5zdWJUcmVlOw0KICAgICAgICAgIGluc3RhbmNlLnN1YlRyZWUgPSBuZXh0VHJlZTsNCiAgICAgICAgICB7DQogICAgICAgICAgICBzdGFydE1lYXN1cmUoaW5zdGFuY2UsIGBwYXRjaGApOw0KICAgICAgICAgIH0NCiAgICAgICAgICBwYXRjaCgNCiAgICAgICAgICAgIHByZXZUcmVlLA0KICAgICAgICAgICAgbmV4dFRyZWUsDQogICAgICAgICAgICAvLyBwYXJlbnQgbWF5IGhhdmUgY2hhbmdlZCBpZiBpdCdzIGluIGEgdGVsZXBvcnQNCiAgICAgICAgICAgIGhvc3RQYXJlbnROb2RlKHByZXZUcmVlLmVsKSwNCiAgICAgICAgICAgIC8vIGFuY2hvciBtYXkgaGF2ZSBjaGFuZ2VkIGlmIGl0J3MgaW4gYSBmcmFnbWVudA0KICAgICAgICAgICAgZ2V0TmV4dEhvc3ROb2RlKHByZXZUcmVlKSwNCiAgICAgICAgICAgIGluc3RhbmNlLA0KICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICBuYW1lc3BhY2UNCiAgICAgICAgICApOw0KICAgICAgICAgIHsNCiAgICAgICAgICAgIGVuZE1lYXN1cmUoaW5zdGFuY2UsIGBwYXRjaGApOw0KICAgICAgICAgIH0NCiAgICAgICAgICBuZXh0LmVsID0gbmV4dFRyZWUuZWw7DQogICAgICAgICAgaWYgKG9yaWdpbk5leHQgPT09IG51bGwpIHsNCiAgICAgICAgICAgIHVwZGF0ZUhPQ0hvc3RFbChpbnN0YW5jZSwgbmV4dFRyZWUuZWwpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpZiAodSkgew0KICAgICAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KHUsIHBhcmVudFN1c3BlbnNlKTsNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKHZub2RlSG9vayA9IG5leHQucHJvcHMgJiYgbmV4dC5wcm9wcy5vblZub2RlVXBkYXRlZCkgew0KICAgICAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KA0KICAgICAgICAgICAgICAoKSA9PiBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBwYXJlbnQsIG5leHQsIHZub2RlKSwNCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UNCiAgICAgICAgICAgICk7DQogICAgICAgICAgfQ0KICAgICAgICAgIHsNCiAgICAgICAgICAgIGRldnRvb2xzQ29tcG9uZW50VXBkYXRlZChpbnN0YW5jZSk7DQogICAgICAgICAgfQ0KICAgICAgICAgIHsNCiAgICAgICAgICAgIHBvcFdhcm5pbmdDb250ZXh0KCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9Ow0KICAgICAgaW5zdGFuY2Uuc2NvcGUub24oKTsNCiAgICAgIGNvbnN0IGVmZmVjdCA9IGluc3RhbmNlLmVmZmVjdCA9IG5ldyBSZWFjdGl2ZUVmZmVjdChjb21wb25lbnRVcGRhdGVGbik7DQogICAgICBpbnN0YW5jZS5zY29wZS5vZmYoKTsNCiAgICAgIGNvbnN0IHVwZGF0ZSA9IGluc3RhbmNlLnVwZGF0ZSA9IGVmZmVjdC5ydW4uYmluZChlZmZlY3QpOw0KICAgICAgY29uc3Qgam9iID0gaW5zdGFuY2Uuam9iID0gZWZmZWN0LnJ1bklmRGlydHkuYmluZChlZmZlY3QpOw0KICAgICAgam9iLmkgPSBpbnN0YW5jZTsNCiAgICAgIGpvYi5pZCA9IGluc3RhbmNlLnVpZDsNCiAgICAgIGVmZmVjdC5zY2hlZHVsZXIgPSAoKSA9PiBxdWV1ZUpvYihqb2IpOw0KICAgICAgdG9nZ2xlUmVjdXJzZShpbnN0YW5jZSwgdHJ1ZSk7DQogICAgICB7DQogICAgICAgIGVmZmVjdC5vblRyYWNrID0gaW5zdGFuY2UucnRjID8gKGUpID0+IGludm9rZUFycmF5Rm5zKGluc3RhbmNlLnJ0YywgZSkgOiB2b2lkIDA7DQogICAgICAgIGVmZmVjdC5vblRyaWdnZXIgPSBpbnN0YW5jZS5ydGcgPyAoZSkgPT4gaW52b2tlQXJyYXlGbnMoaW5zdGFuY2UucnRnLCBlKSA6IHZvaWQgMDsNCiAgICAgIH0NCiAgICAgIHVwZGF0ZSgpOw0KICAgIH07DQogICAgY29uc3QgdXBkYXRlQ29tcG9uZW50UHJlUmVuZGVyID0gKGluc3RhbmNlLCBuZXh0Vk5vZGUsIG9wdGltaXplZCkgPT4gew0KICAgICAgbmV4dFZOb2RlLmNvbXBvbmVudCA9IGluc3RhbmNlOw0KICAgICAgY29uc3QgcHJldlByb3BzID0gaW5zdGFuY2Uudm5vZGUucHJvcHM7DQogICAgICBpbnN0YW5jZS52bm9kZSA9IG5leHRWTm9kZTsNCiAgICAgIGluc3RhbmNlLm5leHQgPSBudWxsOw0KICAgICAgdXBkYXRlUHJvcHMoaW5zdGFuY2UsIG5leHRWTm9kZS5wcm9wcywgcHJldlByb3BzLCBvcHRpbWl6ZWQpOw0KICAgICAgdXBkYXRlU2xvdHMoaW5zdGFuY2UsIG5leHRWTm9kZS5jaGlsZHJlbiwgb3B0aW1pemVkKTsNCiAgICAgIHBhdXNlVHJhY2tpbmcoKTsNCiAgICAgIGZsdXNoUHJlRmx1c2hDYnMoaW5zdGFuY2UpOw0KICAgICAgcmVzZXRUcmFja2luZygpOw0KICAgIH07DQogICAgY29uc3QgcGF0Y2hDaGlsZHJlbiA9IChuMSwgbjIsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBuYW1lc3BhY2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkID0gZmFsc2UpID0+IHsNCiAgICAgIGNvbnN0IGMxID0gbjEgJiYgbjEuY2hpbGRyZW47DQogICAgICBjb25zdCBwcmV2U2hhcGVGbGFnID0gbjEgPyBuMS5zaGFwZUZsYWcgOiAwOw0KICAgICAgY29uc3QgYzIgPSBuMi5jaGlsZHJlbjsNCiAgICAgIGNvbnN0IHsgcGF0Y2hGbGFnLCBzaGFwZUZsYWcgfSA9IG4yOw0KICAgICAgaWYgKHBhdGNoRmxhZyA+IDApIHsNCiAgICAgICAgaWYgKHBhdGNoRmxhZyAmIDEyOCkgew0KICAgICAgICAgIHBhdGNoS2V5ZWRDaGlsZHJlbigNCiAgICAgICAgICAgIGMxLA0KICAgICAgICAgICAgYzIsDQogICAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgICBhbmNob3IsDQogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICAgICk7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9IGVsc2UgaWYgKHBhdGNoRmxhZyAmIDI1Nikgew0KICAgICAgICAgIHBhdGNoVW5rZXllZENoaWxkcmVuKA0KICAgICAgICAgICAgYzEsDQogICAgICAgICAgICBjMiwNCiAgICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICAgIGFuY2hvciwNCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLA0KICAgICAgICAgICAgbmFtZXNwYWNlLA0KICAgICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgICAgb3B0aW1pemVkDQogICAgICAgICAgKTsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmIChzaGFwZUZsYWcgJiA4KSB7DQogICAgICAgIGlmIChwcmV2U2hhcGVGbGFnICYgMTYpIHsNCiAgICAgICAgICB1bm1vdW50Q2hpbGRyZW4oYzEsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UpOw0KICAgICAgICB9DQogICAgICAgIGlmIChjMiAhPT0gYzEpIHsNCiAgICAgICAgICBob3N0U2V0RWxlbWVudFRleHQoY29udGFpbmVyLCBjMik7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGlmIChwcmV2U2hhcGVGbGFnICYgMTYpIHsNCiAgICAgICAgICBpZiAoc2hhcGVGbGFnICYgMTYpIHsNCiAgICAgICAgICAgIHBhdGNoS2V5ZWRDaGlsZHJlbigNCiAgICAgICAgICAgICAgYzEsDQogICAgICAgICAgICAgIGMyLA0KICAgICAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgICAgIGFuY2hvciwNCiAgICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgICAgbmFtZXNwYWNlLA0KICAgICAgICAgICAgICBzbG90U2NvcGVJZHMsDQogICAgICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgdW5tb3VudENoaWxkcmVuKGMxLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCB0cnVlKTsNCiAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgaWYgKHByZXZTaGFwZUZsYWcgJiA4KSB7DQogICAgICAgICAgICBob3N0U2V0RWxlbWVudFRleHQoY29udGFpbmVyLCAiIik7DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmIChzaGFwZUZsYWcgJiAxNikgew0KICAgICAgICAgICAgbW91bnRDaGlsZHJlbigNCiAgICAgICAgICAgICAgYzIsDQogICAgICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICAgICAgYW5jaG9yLA0KICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLA0KICAgICAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICAgICAgb3B0aW1pemVkDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH07DQogICAgY29uc3QgcGF0Y2hVbmtleWVkQ2hpbGRyZW4gPSAoYzEsIGMyLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCkgPT4gew0KICAgICAgYzEgPSBjMSB8fCBFTVBUWV9BUlI7DQogICAgICBjMiA9IGMyIHx8IEVNUFRZX0FSUjsNCiAgICAgIGNvbnN0IG9sZExlbmd0aCA9IGMxLmxlbmd0aDsNCiAgICAgIGNvbnN0IG5ld0xlbmd0aCA9IGMyLmxlbmd0aDsNCiAgICAgIGNvbnN0IGNvbW1vbkxlbmd0aCA9IE1hdGgubWluKG9sZExlbmd0aCwgbmV3TGVuZ3RoKTsNCiAgICAgIGxldCBpOw0KICAgICAgZm9yIChpID0gMDsgaSA8IGNvbW1vbkxlbmd0aDsgaSsrKSB7DQogICAgICAgIGNvbnN0IG5leHRDaGlsZCA9IGMyW2ldID0gb3B0aW1pemVkID8gY2xvbmVJZk1vdW50ZWQoYzJbaV0pIDogbm9ybWFsaXplVk5vZGUoYzJbaV0pOw0KICAgICAgICBwYXRjaCgNCiAgICAgICAgICBjMVtpXSwNCiAgICAgICAgICBuZXh0Q2hpbGQsDQogICAgICAgICAgY29udGFpbmVyLA0KICAgICAgICAgIG51bGwsDQogICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgIHBhcmVudFN1c3BlbnNlLA0KICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICBzbG90U2NvcGVJZHMsDQogICAgICAgICAgb3B0aW1pemVkDQogICAgICAgICk7DQogICAgICB9DQogICAgICBpZiAob2xkTGVuZ3RoID4gbmV3TGVuZ3RoKSB7DQogICAgICAgIHVubW91bnRDaGlsZHJlbigNCiAgICAgICAgICBjMSwNCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgdHJ1ZSwNCiAgICAgICAgICBmYWxzZSwNCiAgICAgICAgICBjb21tb25MZW5ndGgNCiAgICAgICAgKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIG1vdW50Q2hpbGRyZW4oDQogICAgICAgICAgYzIsDQogICAgICAgICAgY29udGFpbmVyLA0KICAgICAgICAgIGFuY2hvciwNCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgbmFtZXNwYWNlLA0KICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICBvcHRpbWl6ZWQsDQogICAgICAgICAgY29tbW9uTGVuZ3RoDQogICAgICAgICk7DQogICAgICB9DQogICAgfTsNCiAgICBjb25zdCBwYXRjaEtleWVkQ2hpbGRyZW4gPSAoYzEsIGMyLCBjb250YWluZXIsIHBhcmVudEFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCkgPT4gew0KICAgICAgbGV0IGkgPSAwOw0KICAgICAgY29uc3QgbDIgPSBjMi5sZW5ndGg7DQogICAgICBsZXQgZTEgPSBjMS5sZW5ndGggLSAxOw0KICAgICAgbGV0IGUyID0gbDIgLSAxOw0KICAgICAgd2hpbGUgKGkgPD0gZTEgJiYgaSA8PSBlMikgew0KICAgICAgICBjb25zdCBuMSA9IGMxW2ldOw0KICAgICAgICBjb25zdCBuMiA9IGMyW2ldID0gb3B0aW1pemVkID8gY2xvbmVJZk1vdW50ZWQoYzJbaV0pIDogbm9ybWFsaXplVk5vZGUoYzJbaV0pOw0KICAgICAgICBpZiAoaXNTYW1lVk5vZGVUeXBlKG4xLCBuMikpIHsNCiAgICAgICAgICBwYXRjaCgNCiAgICAgICAgICAgIG4xLA0KICAgICAgICAgICAgbjIsDQogICAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgICBudWxsLA0KICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgICBzbG90U2NvcGVJZHMsDQogICAgICAgICAgICBvcHRpbWl6ZWQNCiAgICAgICAgICApOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGJyZWFrOw0KICAgICAgICB9DQogICAgICAgIGkrKzsNCiAgICAgIH0NCiAgICAgIHdoaWxlIChpIDw9IGUxICYmIGkgPD0gZTIpIHsNCiAgICAgICAgY29uc3QgbjEgPSBjMVtlMV07DQogICAgICAgIGNvbnN0IG4yID0gYzJbZTJdID0gb3B0aW1pemVkID8gY2xvbmVJZk1vdW50ZWQoYzJbZTJdKSA6IG5vcm1hbGl6ZVZOb2RlKGMyW2UyXSk7DQogICAgICAgIGlmIChpc1NhbWVWTm9kZVR5cGUobjEsIG4yKSkgew0KICAgICAgICAgIHBhdGNoKA0KICAgICAgICAgICAgbjEsDQogICAgICAgICAgICBuMiwNCiAgICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICAgIG51bGwsDQogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICAgICk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIH0NCiAgICAgICAgZTEtLTsNCiAgICAgICAgZTItLTsNCiAgICAgIH0NCiAgICAgIGlmIChpID4gZTEpIHsNCiAgICAgICAgaWYgKGkgPD0gZTIpIHsNCiAgICAgICAgICBjb25zdCBuZXh0UG9zID0gZTIgKyAxOw0KICAgICAgICAgIGNvbnN0IGFuY2hvciA9IG5leHRQb3MgPCBsMiA/IGMyW25leHRQb3NdLmVsIDogcGFyZW50QW5jaG9yOw0KICAgICAgICAgIHdoaWxlIChpIDw9IGUyKSB7DQogICAgICAgICAgICBwYXRjaCgNCiAgICAgICAgICAgICAgbnVsbCwNCiAgICAgICAgICAgICAgYzJbaV0gPSBvcHRpbWl6ZWQgPyBjbG9uZUlmTW91bnRlZChjMltpXSkgOiBub3JtYWxpemVWTm9kZShjMltpXSksDQogICAgICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICAgICAgYW5jaG9yLA0KICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLA0KICAgICAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICAgICAgb3B0aW1pemVkDQogICAgICAgICAgICApOw0KICAgICAgICAgICAgaSsrOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIGlmIChpID4gZTIpIHsNCiAgICAgICAgd2hpbGUgKGkgPD0gZTEpIHsNCiAgICAgICAgICB1bm1vdW50KGMxW2ldLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCB0cnVlKTsNCiAgICAgICAgICBpKys7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbnN0IHMxID0gaTsNCiAgICAgICAgY29uc3QgczIgPSBpOw0KICAgICAgICBjb25zdCBrZXlUb05ld0luZGV4TWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsNCiAgICAgICAgZm9yIChpID0gczI7IGkgPD0gZTI7IGkrKykgew0KICAgICAgICAgIGNvbnN0IG5leHRDaGlsZCA9IGMyW2ldID0gb3B0aW1pemVkID8gY2xvbmVJZk1vdW50ZWQoYzJbaV0pIDogbm9ybWFsaXplVk5vZGUoYzJbaV0pOw0KICAgICAgICAgIGlmIChuZXh0Q2hpbGQua2V5ICE9IG51bGwpIHsNCiAgICAgICAgICAgIGlmIChrZXlUb05ld0luZGV4TWFwLmhhcyhuZXh0Q2hpbGQua2V5KSkgew0KICAgICAgICAgICAgICB3YXJuJDEoDQogICAgICAgICAgICAgICAgYER1cGxpY2F0ZSBrZXlzIGZvdW5kIGR1cmluZyB1cGRhdGU6YCwNCiAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShuZXh0Q2hpbGQua2V5KSwNCiAgICAgICAgICAgICAgICBgTWFrZSBzdXJlIGtleXMgYXJlIHVuaXF1ZS5gDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBrZXlUb05ld0luZGV4TWFwLnNldChuZXh0Q2hpbGQua2V5LCBpKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgbGV0IGo7DQogICAgICAgIGxldCBwYXRjaGVkID0gMDsNCiAgICAgICAgY29uc3QgdG9CZVBhdGNoZWQgPSBlMiAtIHMyICsgMTsNCiAgICAgICAgbGV0IG1vdmVkID0gZmFsc2U7DQogICAgICAgIGxldCBtYXhOZXdJbmRleFNvRmFyID0gMDsNCiAgICAgICAgY29uc3QgbmV3SW5kZXhUb09sZEluZGV4TWFwID0gbmV3IEFycmF5KHRvQmVQYXRjaGVkKTsNCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRvQmVQYXRjaGVkOyBpKyspIG5ld0luZGV4VG9PbGRJbmRleE1hcFtpXSA9IDA7DQogICAgICAgIGZvciAoaSA9IHMxOyBpIDw9IGUxOyBpKyspIHsNCiAgICAgICAgICBjb25zdCBwcmV2Q2hpbGQgPSBjMVtpXTsNCiAgICAgICAgICBpZiAocGF0Y2hlZCA+PSB0b0JlUGF0Y2hlZCkgew0KICAgICAgICAgICAgdW5tb3VudChwcmV2Q2hpbGQsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHRydWUpOw0KICAgICAgICAgICAgY29udGludWU7DQogICAgICAgICAgfQ0KICAgICAgICAgIGxldCBuZXdJbmRleDsNCiAgICAgICAgICBpZiAocHJldkNoaWxkLmtleSAhPSBudWxsKSB7DQogICAgICAgICAgICBuZXdJbmRleCA9IGtleVRvTmV3SW5kZXhNYXAuZ2V0KHByZXZDaGlsZC5rZXkpOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBmb3IgKGogPSBzMjsgaiA8PSBlMjsgaisrKSB7DQogICAgICAgICAgICAgIGlmIChuZXdJbmRleFRvT2xkSW5kZXhNYXBbaiAtIHMyXSA9PT0gMCAmJiBpc1NhbWVWTm9kZVR5cGUocHJldkNoaWxkLCBjMltqXSkpIHsNCiAgICAgICAgICAgICAgICBuZXdJbmRleCA9IGo7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKG5ld0luZGV4ID09PSB2b2lkIDApIHsNCiAgICAgICAgICAgIHVubW91bnQocHJldkNoaWxkLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCB0cnVlKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgbmV3SW5kZXhUb09sZEluZGV4TWFwW25ld0luZGV4IC0gczJdID0gaSArIDE7DQogICAgICAgICAgICBpZiAobmV3SW5kZXggPj0gbWF4TmV3SW5kZXhTb0Zhcikgew0KICAgICAgICAgICAgICBtYXhOZXdJbmRleFNvRmFyID0gbmV3SW5kZXg7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICBtb3ZlZCA9IHRydWU7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBwYXRjaCgNCiAgICAgICAgICAgICAgcHJldkNoaWxkLA0KICAgICAgICAgICAgICBjMltuZXdJbmRleF0sDQogICAgICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICAgICAgbnVsbCwNCiAgICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgICAgbmFtZXNwYWNlLA0KICAgICAgICAgICAgICBzbG90U2NvcGVJZHMsDQogICAgICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICAgICAgKTsNCiAgICAgICAgICAgIHBhdGNoZWQrKzsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgY29uc3QgaW5jcmVhc2luZ05ld0luZGV4U2VxdWVuY2UgPSBtb3ZlZCA/IGdldFNlcXVlbmNlKG5ld0luZGV4VG9PbGRJbmRleE1hcCkgOiBFTVBUWV9BUlI7DQogICAgICAgIGogPSBpbmNyZWFzaW5nTmV3SW5kZXhTZXF1ZW5jZS5sZW5ndGggLSAxOw0KICAgICAgICBmb3IgKGkgPSB0b0JlUGF0Y2hlZCAtIDE7IGkgPj0gMDsgaS0tKSB7DQogICAgICAgICAgY29uc3QgbmV4dEluZGV4ID0gczIgKyBpOw0KICAgICAgICAgIGNvbnN0IG5leHRDaGlsZCA9IGMyW25leHRJbmRleF07DQogICAgICAgICAgY29uc3QgYW5jaG9yID0gbmV4dEluZGV4ICsgMSA8IGwyID8gYzJbbmV4dEluZGV4ICsgMV0uZWwgOiBwYXJlbnRBbmNob3I7DQogICAgICAgICAgaWYgKG5ld0luZGV4VG9PbGRJbmRleE1hcFtpXSA9PT0gMCkgew0KICAgICAgICAgICAgcGF0Y2goDQogICAgICAgICAgICAgIG51bGwsDQogICAgICAgICAgICAgIG5leHRDaGlsZCwNCiAgICAgICAgICAgICAgY29udGFpbmVyLA0KICAgICAgICAgICAgICBhbmNob3IsDQogICAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgICAgICBvcHRpbWl6ZWQNCiAgICAgICAgICAgICk7DQogICAgICAgICAgfSBlbHNlIGlmIChtb3ZlZCkgew0KICAgICAgICAgICAgaWYgKGogPCAwIHx8IGkgIT09IGluY3JlYXNpbmdOZXdJbmRleFNlcXVlbmNlW2pdKSB7DQogICAgICAgICAgICAgIG1vdmUobmV4dENoaWxkLCBjb250YWluZXIsIGFuY2hvciwgMik7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICBqLS07DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfTsNCiAgICBjb25zdCBtb3ZlID0gKHZub2RlLCBjb250YWluZXIsIGFuY2hvciwgbW92ZVR5cGUsIHBhcmVudFN1c3BlbnNlID0gbnVsbCkgPT4gew0KICAgICAgY29uc3QgeyBlbCwgdHlwZSwgdHJhbnNpdGlvbiwgY2hpbGRyZW4sIHNoYXBlRmxhZyB9ID0gdm5vZGU7DQogICAgICBpZiAoc2hhcGVGbGFnICYgNikgew0KICAgICAgICBtb3ZlKHZub2RlLmNvbXBvbmVudC5zdWJUcmVlLCBjb250YWluZXIsIGFuY2hvciwgbW92ZVR5cGUpOw0KICAgICAgICByZXR1cm47DQogICAgICB9DQogICAgICBpZiAoc2hhcGVGbGFnICYgMTI4KSB7DQogICAgICAgIHZub2RlLnN1c3BlbnNlLm1vdmUoY29udGFpbmVyLCBhbmNob3IsIG1vdmVUeXBlKTsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgaWYgKHNoYXBlRmxhZyAmIDY0KSB7DQogICAgICAgIHR5cGUubW92ZSh2bm9kZSwgY29udGFpbmVyLCBhbmNob3IsIGludGVybmFscyk7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIGlmICh0eXBlID09PSBGcmFnbWVudCkgew0KICAgICAgICBob3N0SW5zZXJ0KGVsLCBjb250YWluZXIsIGFuY2hvcik7DQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICBtb3ZlKGNoaWxkcmVuW2ldLCBjb250YWluZXIsIGFuY2hvciwgbW92ZVR5cGUpOw0KICAgICAgICB9DQogICAgICAgIGhvc3RJbnNlcnQodm5vZGUuYW5jaG9yLCBjb250YWluZXIsIGFuY2hvcik7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIGlmICh0eXBlID09PSBTdGF0aWMpIHsNCiAgICAgICAgbW92ZVN0YXRpY05vZGUodm5vZGUsIGNvbnRhaW5lciwgYW5jaG9yKTsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgY29uc3QgbmVlZFRyYW5zaXRpb24yID0gbW92ZVR5cGUgIT09IDIgJiYgc2hhcGVGbGFnICYgMSAmJiB0cmFuc2l0aW9uOw0KICAgICAgaWYgKG5lZWRUcmFuc2l0aW9uMikgew0KICAgICAgICBpZiAobW92ZVR5cGUgPT09IDApIHsNCiAgICAgICAgICB0cmFuc2l0aW9uLmJlZm9yZUVudGVyKGVsKTsNCiAgICAgICAgICBob3N0SW5zZXJ0KGVsLCBjb250YWluZXIsIGFuY2hvcik7DQogICAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KCgpID0+IHRyYW5zaXRpb24uZW50ZXIoZWwpLCBwYXJlbnRTdXNwZW5zZSk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgY29uc3QgeyBsZWF2ZSwgZGVsYXlMZWF2ZSwgYWZ0ZXJMZWF2ZSB9ID0gdHJhbnNpdGlvbjsNCiAgICAgICAgICBjb25zdCByZW1vdmUyID0gKCkgPT4gew0KICAgICAgICAgICAgaWYgKHZub2RlLmN0eC5pc1VubW91bnRlZCkgew0KICAgICAgICAgICAgICBob3N0UmVtb3ZlKGVsKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgIGhvc3RJbnNlcnQoZWwsIGNvbnRhaW5lciwgYW5jaG9yKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9Ow0KICAgICAgICAgIGNvbnN0IHBlcmZvcm1MZWF2ZSA9ICgpID0+IHsNCiAgICAgICAgICAgIGxlYXZlKGVsLCAoKSA9PiB7DQogICAgICAgICAgICAgIHJlbW92ZTIoKTsNCiAgICAgICAgICAgICAgYWZ0ZXJMZWF2ZSAmJiBhZnRlckxlYXZlKCk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICB9Ow0KICAgICAgICAgIGlmIChkZWxheUxlYXZlKSB7DQogICAgICAgICAgICBkZWxheUxlYXZlKGVsLCByZW1vdmUyLCBwZXJmb3JtTGVhdmUpOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBwZXJmb3JtTGVhdmUoKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGhvc3RJbnNlcnQoZWwsIGNvbnRhaW5lciwgYW5jaG9yKTsNCiAgICAgIH0NCiAgICB9Ow0KICAgIGNvbnN0IHVubW91bnQgPSAodm5vZGUsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGRvUmVtb3ZlID0gZmFsc2UsIG9wdGltaXplZCA9IGZhbHNlKSA9PiB7DQogICAgICBjb25zdCB7DQogICAgICAgIHR5cGUsDQogICAgICAgIHByb3BzLA0KICAgICAgICByZWYsDQogICAgICAgIGNoaWxkcmVuLA0KICAgICAgICBkeW5hbWljQ2hpbGRyZW4sDQogICAgICAgIHNoYXBlRmxhZywNCiAgICAgICAgcGF0Y2hGbGFnLA0KICAgICAgICBkaXJzLA0KICAgICAgICBjYWNoZUluZGV4DQogICAgICB9ID0gdm5vZGU7DQogICAgICBpZiAocGF0Y2hGbGFnID09PSAtMikgew0KICAgICAgICBvcHRpbWl6ZWQgPSBmYWxzZTsNCiAgICAgIH0NCiAgICAgIGlmIChyZWYgIT0gbnVsbCkgew0KICAgICAgICBwYXVzZVRyYWNraW5nKCk7DQogICAgICAgIHNldFJlZihyZWYsIG51bGwsIHBhcmVudFN1c3BlbnNlLCB2bm9kZSwgdHJ1ZSk7DQogICAgICAgIHJlc2V0VHJhY2tpbmcoKTsNCiAgICAgIH0NCiAgICAgIGlmIChjYWNoZUluZGV4ICE9IG51bGwpIHsNCiAgICAgICAgcGFyZW50Q29tcG9uZW50LnJlbmRlckNhY2hlW2NhY2hlSW5kZXhdID0gdm9pZCAwOw0KICAgICAgfQ0KICAgICAgaWYgKHNoYXBlRmxhZyAmIDI1Nikgew0KICAgICAgICBwYXJlbnRDb21wb25lbnQuY3R4LmRlYWN0aXZhdGUodm5vZGUpOw0KICAgICAgICByZXR1cm47DQogICAgICB9DQogICAgICBjb25zdCBzaG91bGRJbnZva2VEaXJzID0gc2hhcGVGbGFnICYgMSAmJiBkaXJzOw0KICAgICAgY29uc3Qgc2hvdWxkSW52b2tlVm5vZGVIb29rID0gIWlzQXN5bmNXcmFwcGVyKHZub2RlKTsNCiAgICAgIGxldCB2bm9kZUhvb2s7DQogICAgICBpZiAoc2hvdWxkSW52b2tlVm5vZGVIb29rICYmICh2bm9kZUhvb2sgPSBwcm9wcyAmJiBwcm9wcy5vblZub2RlQmVmb3JlVW5tb3VudCkpIHsNCiAgICAgICAgaW52b2tlVk5vZGVIb29rKHZub2RlSG9vaywgcGFyZW50Q29tcG9uZW50LCB2bm9kZSk7DQogICAgICB9DQogICAgICBpZiAoc2hhcGVGbGFnICYgNikgew0KICAgICAgICB1bm1vdW50Q29tcG9uZW50KHZub2RlLmNvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGRvUmVtb3ZlKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGlmIChzaGFwZUZsYWcgJiAxMjgpIHsNCiAgICAgICAgICB2bm9kZS5zdXNwZW5zZS51bm1vdW50KHBhcmVudFN1c3BlbnNlLCBkb1JlbW92ZSk7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIGlmIChzaG91bGRJbnZva2VEaXJzKSB7DQogICAgICAgICAgaW52b2tlRGlyZWN0aXZlSG9vayh2bm9kZSwgbnVsbCwgcGFyZW50Q29tcG9uZW50LCAiYmVmb3JlVW5tb3VudCIpOw0KICAgICAgICB9DQogICAgICAgIGlmIChzaGFwZUZsYWcgJiA2NCkgew0KICAgICAgICAgIHZub2RlLnR5cGUucmVtb3ZlKA0KICAgICAgICAgICAgdm5vZGUsDQogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgIGludGVybmFscywNCiAgICAgICAgICAgIGRvUmVtb3ZlDQogICAgICAgICAgKTsNCiAgICAgICAgfSBlbHNlIGlmIChkeW5hbWljQ2hpbGRyZW4gJiYgLy8gIzUxNTQNCiAgICAgICAgLy8gd2hlbiB2LW9uY2UgaXMgdXNlZCBpbnNpZGUgYSBibG9jaywgc2V0QmxvY2tUcmFja2luZygtMSkgbWFya3MgdGhlDQogICAgICAgIC8vIHBhcmVudCBibG9jayB3aXRoIGhhc09uY2U6IHRydWUNCiAgICAgICAgLy8gc28gdGhhdCBpdCBkb2Vzbid0IHRha2UgdGhlIGZhc3QgcGF0aCBkdXJpbmcgdW5tb3VudCAtIG90aGVyd2lzZQ0KICAgICAgICAvLyBjb21wb25lbnRzIG5lc3RlZCBpbiB2LW9uY2UgYXJlIG5ldmVyIHVubW91bnRlZC4NCiAgICAgICAgIWR5bmFtaWNDaGlsZHJlbi5oYXNPbmNlICYmIC8vICMxMTUzOiBmYXN0IHBhdGggc2hvdWxkIG5vdCBiZSB0YWtlbiBmb3Igbm9uLXN0YWJsZSAodi1mb3IpIGZyYWdtZW50cw0KICAgICAgICAodHlwZSAhPT0gRnJhZ21lbnQgfHwgcGF0Y2hGbGFnID4gMCAmJiBwYXRjaEZsYWcgJiA2NCkpIHsNCiAgICAgICAgICB1bm1vdW50Q2hpbGRyZW4oDQogICAgICAgICAgICBkeW5hbWljQ2hpbGRyZW4sDQogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICAgIGZhbHNlLA0KICAgICAgICAgICAgdHJ1ZQ0KICAgICAgICAgICk7DQogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gRnJhZ21lbnQgJiYgcGF0Y2hGbGFnICYgKDEyOCB8IDI1NikgfHwgIW9wdGltaXplZCAmJiBzaGFwZUZsYWcgJiAxNikgew0KICAgICAgICAgIHVubW91bnRDaGlsZHJlbihjaGlsZHJlbiwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKGRvUmVtb3ZlKSB7DQogICAgICAgICAgcmVtb3ZlKHZub2RlKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgaWYgKHNob3VsZEludm9rZVZub2RlSG9vayAmJiAodm5vZGVIb29rID0gcHJvcHMgJiYgcHJvcHMub25Wbm9kZVVubW91bnRlZCkgfHwgc2hvdWxkSW52b2tlRGlycykgew0KICAgICAgICBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QoKCkgPT4gew0KICAgICAgICAgIHZub2RlSG9vayAmJiBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBwYXJlbnRDb21wb25lbnQsIHZub2RlKTsNCiAgICAgICAgICBzaG91bGRJbnZva2VEaXJzICYmIGludm9rZURpcmVjdGl2ZUhvb2sodm5vZGUsIG51bGwsIHBhcmVudENvbXBvbmVudCwgInVubW91bnRlZCIpOw0KICAgICAgICB9LCBwYXJlbnRTdXNwZW5zZSk7DQogICAgICB9DQogICAgfTsNCiAgICBjb25zdCByZW1vdmUgPSAodm5vZGUpID0+IHsNCiAgICAgIGNvbnN0IHsgdHlwZSwgZWwsIGFuY2hvciwgdHJhbnNpdGlvbiB9ID0gdm5vZGU7DQogICAgICBpZiAodHlwZSA9PT0gRnJhZ21lbnQpIHsNCiAgICAgICAgaWYgKHZub2RlLnBhdGNoRmxhZyA+IDAgJiYgdm5vZGUucGF0Y2hGbGFnICYgMjA0OCAmJiB0cmFuc2l0aW9uICYmICF0cmFuc2l0aW9uLnBlcnNpc3RlZCkgew0KICAgICAgICAgIHZub2RlLmNoaWxkcmVuLmZvckVhY2goKGNoaWxkKSA9PiB7DQogICAgICAgICAgICBpZiAoY2hpbGQudHlwZSA9PT0gQ29tbWVudCkgew0KICAgICAgICAgICAgICBob3N0UmVtb3ZlKGNoaWxkLmVsKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgIHJlbW92ZShjaGlsZCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfSk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmVtb3ZlRnJhZ21lbnQoZWwsIGFuY2hvcik7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgaWYgKHR5cGUgPT09IFN0YXRpYykgew0KICAgICAgICByZW1vdmVTdGF0aWNOb2RlKHZub2RlKTsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgY29uc3QgcGVyZm9ybVJlbW92ZSA9ICgpID0+IHsNCiAgICAgICAgaG9zdFJlbW92ZShlbCk7DQogICAgICAgIGlmICh0cmFuc2l0aW9uICYmICF0cmFuc2l0aW9uLnBlcnNpc3RlZCAmJiB0cmFuc2l0aW9uLmFmdGVyTGVhdmUpIHsNCiAgICAgICAgICB0cmFuc2l0aW9uLmFmdGVyTGVhdmUoKTsNCiAgICAgICAgfQ0KICAgICAgfTsNCiAgICAgIGlmICh2bm9kZS5zaGFwZUZsYWcgJiAxICYmIHRyYW5zaXRpb24gJiYgIXRyYW5zaXRpb24ucGVyc2lzdGVkKSB7DQogICAgICAgIGNvbnN0IHsgbGVhdmUsIGRlbGF5TGVhdmUgfSA9IHRyYW5zaXRpb247DQogICAgICAgIGNvbnN0IHBlcmZvcm1MZWF2ZSA9ICgpID0+IGxlYXZlKGVsLCBwZXJmb3JtUmVtb3ZlKTsNCiAgICAgICAgaWYgKGRlbGF5TGVhdmUpIHsNCiAgICAgICAgICBkZWxheUxlYXZlKHZub2RlLmVsLCBwZXJmb3JtUmVtb3ZlLCBwZXJmb3JtTGVhdmUpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHBlcmZvcm1MZWF2ZSgpOw0KICAgICAgICB9DQogICAgICB9IGVsc2Ugew0KICAgICAgICBwZXJmb3JtUmVtb3ZlKCk7DQogICAgICB9DQogICAgfTsNCiAgICBjb25zdCByZW1vdmVGcmFnbWVudCA9IChjdXIsIGVuZCkgPT4gew0KICAgICAgbGV0IG5leHQ7DQogICAgICB3aGlsZSAoY3VyICE9PSBlbmQpIHsNCiAgICAgICAgbmV4dCA9IGhvc3ROZXh0U2libGluZyhjdXIpOw0KICAgICAgICBob3N0UmVtb3ZlKGN1cik7DQogICAgICAgIGN1ciA9IG5leHQ7DQogICAgICB9DQogICAgICBob3N0UmVtb3ZlKGVuZCk7DQogICAgfTsNCiAgICBjb25zdCB1bm1vdW50Q29tcG9uZW50ID0gKGluc3RhbmNlLCBwYXJlbnRTdXNwZW5zZSwgZG9SZW1vdmUpID0+IHsNCiAgICAgIGlmIChpbnN0YW5jZS50eXBlLl9faG1ySWQpIHsNCiAgICAgICAgdW5yZWdpc3RlckhNUihpbnN0YW5jZSk7DQogICAgICB9DQogICAgICBjb25zdCB7DQogICAgICAgIGJ1bSwNCiAgICAgICAgc2NvcGUsDQogICAgICAgIGpvYiwNCiAgICAgICAgc3ViVHJlZSwNCiAgICAgICAgdW0sDQogICAgICAgIG0sDQogICAgICAgIGEsDQogICAgICAgIHBhcmVudCwNCiAgICAgICAgc2xvdHM6IHsgX186IHNsb3RDYWNoZUtleXMgfQ0KICAgICAgfSA9IGluc3RhbmNlOw0KICAgICAgaW52YWxpZGF0ZU1vdW50KG0pOw0KICAgICAgaW52YWxpZGF0ZU1vdW50KGEpOw0KICAgICAgaWYgKGJ1bSkgew0KICAgICAgICBpbnZva2VBcnJheUZucyhidW0pOw0KICAgICAgfQ0KICAgICAgaWYgKHBhcmVudCAmJiBpc0FycmF5KHNsb3RDYWNoZUtleXMpKSB7DQogICAgICAgIHNsb3RDYWNoZUtleXMuZm9yRWFjaCgodikgPT4gew0KICAgICAgICAgIHBhcmVudC5yZW5kZXJDYWNoZVt2XSA9IHZvaWQgMDsNCiAgICAgICAgfSk7DQogICAgICB9DQogICAgICBzY29wZS5zdG9wKCk7DQogICAgICBpZiAoam9iKSB7DQogICAgICAgIGpvYi5mbGFncyB8PSA4Ow0KICAgICAgICB1bm1vdW50KHN1YlRyZWUsIGluc3RhbmNlLCBwYXJlbnRTdXNwZW5zZSwgZG9SZW1vdmUpOw0KICAgICAgfQ0KICAgICAgaWYgKHVtKSB7DQogICAgICAgIHF1ZXVlUG9zdFJlbmRlckVmZmVjdCh1bSwgcGFyZW50U3VzcGVuc2UpOw0KICAgICAgfQ0KICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KCgpID0+IHsNCiAgICAgICAgaW5zdGFuY2UuaXNVbm1vdW50ZWQgPSB0cnVlOw0KICAgICAgfSwgcGFyZW50U3VzcGVuc2UpOw0KICAgICAgaWYgKHBhcmVudFN1c3BlbnNlICYmIHBhcmVudFN1c3BlbnNlLnBlbmRpbmdCcmFuY2ggJiYgIXBhcmVudFN1c3BlbnNlLmlzVW5tb3VudGVkICYmIGluc3RhbmNlLmFzeW5jRGVwICYmICFpbnN0YW5jZS5hc3luY1Jlc29sdmVkICYmIGluc3RhbmNlLnN1c3BlbnNlSWQgPT09IHBhcmVudFN1c3BlbnNlLnBlbmRpbmdJZCkgew0KICAgICAgICBwYXJlbnRTdXNwZW5zZS5kZXBzLS07DQogICAgICAgIGlmIChwYXJlbnRTdXNwZW5zZS5kZXBzID09PSAwKSB7DQogICAgICAgICAgcGFyZW50U3VzcGVuc2UucmVzb2x2ZSgpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICB7DQogICAgICAgIGRldnRvb2xzQ29tcG9uZW50UmVtb3ZlZChpbnN0YW5jZSk7DQogICAgICB9DQogICAgfTsNCiAgICBjb25zdCB1bm1vdW50Q2hpbGRyZW4gPSAoY2hpbGRyZW4sIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGRvUmVtb3ZlID0gZmFsc2UsIG9wdGltaXplZCA9IGZhbHNlLCBzdGFydCA9IDApID0+IHsNCiAgICAgIGZvciAobGV0IGkgPSBzdGFydDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIHVubW91bnQoY2hpbGRyZW5baV0sIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGRvUmVtb3ZlLCBvcHRpbWl6ZWQpOw0KICAgICAgfQ0KICAgIH07DQogICAgY29uc3QgZ2V0TmV4dEhvc3ROb2RlID0gKHZub2RlKSA9PiB7DQogICAgICBpZiAodm5vZGUuc2hhcGVGbGFnICYgNikgew0KICAgICAgICByZXR1cm4gZ2V0TmV4dEhvc3ROb2RlKHZub2RlLmNvbXBvbmVudC5zdWJUcmVlKTsNCiAgICAgIH0NCiAgICAgIGlmICh2bm9kZS5zaGFwZUZsYWcgJiAxMjgpIHsNCiAgICAgICAgcmV0dXJuIHZub2RlLnN1c3BlbnNlLm5leHQoKTsNCiAgICAgIH0NCiAgICAgIGNvbnN0IGVsID0gaG9zdE5leHRTaWJsaW5nKHZub2RlLmFuY2hvciB8fCB2bm9kZS5lbCk7DQogICAgICBjb25zdCB0ZWxlcG9ydEVuZCA9IGVsICYmIGVsW1RlbGVwb3J0RW5kS2V5XTsNCiAgICAgIHJldHVybiB0ZWxlcG9ydEVuZCA/IGhvc3ROZXh0U2libGluZyh0ZWxlcG9ydEVuZCkgOiBlbDsNCiAgICB9Ow0KICAgIGxldCBpc0ZsdXNoaW5nID0gZmFsc2U7DQogICAgY29uc3QgcmVuZGVyID0gKHZub2RlLCBjb250YWluZXIsIG5hbWVzcGFjZSkgPT4gew0KICAgICAgaWYgKHZub2RlID09IG51bGwpIHsNCiAgICAgICAgaWYgKGNvbnRhaW5lci5fdm5vZGUpIHsNCiAgICAgICAgICB1bm1vdW50KGNvbnRhaW5lci5fdm5vZGUsIG51bGwsIG51bGwsIHRydWUpOw0KICAgICAgICB9DQogICAgICB9IGVsc2Ugew0KICAgICAgICBwYXRjaCgNCiAgICAgICAgICBjb250YWluZXIuX3Zub2RlIHx8IG51bGwsDQogICAgICAgICAgdm5vZGUsDQogICAgICAgICAgY29udGFpbmVyLA0KICAgICAgICAgIG51bGwsDQogICAgICAgICAgbnVsbCwNCiAgICAgICAgICBudWxsLA0KICAgICAgICAgIG5hbWVzcGFjZQ0KICAgICAgICApOw0KICAgICAgfQ0KICAgICAgY29udGFpbmVyLl92bm9kZSA9IHZub2RlOw0KICAgICAgaWYgKCFpc0ZsdXNoaW5nKSB7DQogICAgICAgIGlzRmx1c2hpbmcgPSB0cnVlOw0KICAgICAgICBmbHVzaFByZUZsdXNoQ2JzKCk7DQogICAgICAgIGZsdXNoUG9zdEZsdXNoQ2JzKCk7DQogICAgICAgIGlzRmx1c2hpbmcgPSBmYWxzZTsNCiAgICAgIH0NCiAgICB9Ow0KICAgIGNvbnN0IGludGVybmFscyA9IHsNCiAgICAgIHA6IHBhdGNoLA0KICAgICAgdW06IHVubW91bnQsDQogICAgICBtOiBtb3ZlLA0KICAgICAgcjogcmVtb3ZlLA0KICAgICAgbXQ6IG1vdW50Q29tcG9uZW50LA0KICAgICAgbWM6IG1vdW50Q2hpbGRyZW4sDQogICAgICBwYzogcGF0Y2hDaGlsZHJlbiwNCiAgICAgIHBiYzogcGF0Y2hCbG9ja0NoaWxkcmVuLA0KICAgICAgbjogZ2V0TmV4dEhvc3ROb2RlLA0KICAgICAgbzogb3B0aW9ucw0KICAgIH07DQogICAgbGV0IGh5ZHJhdGU7DQogICAgbGV0IGh5ZHJhdGVOb2RlOw0KICAgIGlmIChjcmVhdGVIeWRyYXRpb25GbnMpIHsNCiAgICAgIFtoeWRyYXRlLCBoeWRyYXRlTm9kZV0gPSBjcmVhdGVIeWRyYXRpb25GbnMoDQogICAgICAgIGludGVybmFscw0KICAgICAgKTsNCiAgICB9DQogICAgcmV0dXJuIHsNCiAgICAgIHJlbmRlciwNCiAgICAgIGh5ZHJhdGUsDQogICAgICBjcmVhdGVBcHA6IGNyZWF0ZUFwcEFQSShyZW5kZXIsIGh5ZHJhdGUpDQogICAgfTsNCiAgfQ0KICBmdW5jdGlvbiByZXNvbHZlQ2hpbGRyZW5OYW1lc3BhY2UoeyB0eXBlLCBwcm9wcyB9LCBjdXJyZW50TmFtZXNwYWNlKSB7DQogICAgcmV0dXJuIGN1cnJlbnROYW1lc3BhY2UgPT09ICJzdmciICYmIHR5cGUgPT09ICJmb3JlaWduT2JqZWN0IiB8fCBjdXJyZW50TmFtZXNwYWNlID09PSAibWF0aG1sIiAmJiB0eXBlID09PSAiYW5ub3RhdGlvbi14bWwiICYmIHByb3BzICYmIHByb3BzLmVuY29kaW5nICYmIHByb3BzLmVuY29kaW5nLmluY2x1ZGVzKCJodG1sIikgPyB2b2lkIDAgOiBjdXJyZW50TmFtZXNwYWNlOw0KICB9DQogIGZ1bmN0aW9uIHRvZ2dsZVJlY3Vyc2UoeyBlZmZlY3QsIGpvYiB9LCBhbGxvd2VkKSB7DQogICAgaWYgKGFsbG93ZWQpIHsNCiAgICAgIGVmZmVjdC5mbGFncyB8PSAzMjsNCiAgICAgIGpvYi5mbGFncyB8PSA0Ow0KICAgIH0gZWxzZSB7DQogICAgICBlZmZlY3QuZmxhZ3MgJj0gLTMzOw0KICAgICAgam9iLmZsYWdzICY9IC01Ow0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBuZWVkVHJhbnNpdGlvbihwYXJlbnRTdXNwZW5zZSwgdHJhbnNpdGlvbikgew0KICAgIHJldHVybiAoIXBhcmVudFN1c3BlbnNlIHx8IHBhcmVudFN1c3BlbnNlICYmICFwYXJlbnRTdXNwZW5zZS5wZW5kaW5nQnJhbmNoKSAmJiB0cmFuc2l0aW9uICYmICF0cmFuc2l0aW9uLnBlcnNpc3RlZDsNCiAgfQ0KICBmdW5jdGlvbiB0cmF2ZXJzZVN0YXRpY0NoaWxkcmVuKG4xLCBuMiwgc2hhbGxvdyA9IGZhbHNlKSB7DQogICAgY29uc3QgY2gxID0gbjEuY2hpbGRyZW47DQogICAgY29uc3QgY2gyID0gbjIuY2hpbGRyZW47DQogICAgaWYgKGlzQXJyYXkoY2gxKSAmJiBpc0FycmF5KGNoMikpIHsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2gxLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGNvbnN0IGMxID0gY2gxW2ldOw0KICAgICAgICBsZXQgYzIgPSBjaDJbaV07DQogICAgICAgIGlmIChjMi5zaGFwZUZsYWcgJiAxICYmICFjMi5keW5hbWljQ2hpbGRyZW4pIHsNCiAgICAgICAgICBpZiAoYzIucGF0Y2hGbGFnIDw9IDAgfHwgYzIucGF0Y2hGbGFnID09PSAzMikgew0KICAgICAgICAgICAgYzIgPSBjaDJbaV0gPSBjbG9uZUlmTW91bnRlZChjaDJbaV0pOw0KICAgICAgICAgICAgYzIuZWwgPSBjMS5lbDsNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKCFzaGFsbG93ICYmIGMyLnBhdGNoRmxhZyAhPT0gLTIpDQogICAgICAgICAgICB0cmF2ZXJzZVN0YXRpY0NoaWxkcmVuKGMxLCBjMik7DQogICAgICAgIH0NCiAgICAgICAgaWYgKGMyLnR5cGUgPT09IFRleHQpIHsNCiAgICAgICAgICBjMi5lbCA9IGMxLmVsOw0KICAgICAgICB9DQogICAgICAgIGlmIChjMi50eXBlID09PSBDb21tZW50ICYmICFjMi5lbCkgew0KICAgICAgICAgIGMyLmVsID0gYzEuZWw7DQogICAgICAgIH0NCiAgICAgICAgew0KICAgICAgICAgIGMyLmVsICYmIChjMi5lbC5fX3Zub2RlID0gYzIpOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGdldFNlcXVlbmNlKGFycikgew0KICAgIGNvbnN0IHAgPSBhcnIuc2xpY2UoKTsNCiAgICBjb25zdCByZXN1bHQgPSBbMF07DQogICAgbGV0IGksIGosIHUsIHYsIGM7DQogICAgY29uc3QgbGVuID0gYXJyLmxlbmd0aDsNCiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsNCiAgICAgIGNvbnN0IGFyckkgPSBhcnJbaV07DQogICAgICBpZiAoYXJySSAhPT0gMCkgew0KICAgICAgICBqID0gcmVzdWx0W3Jlc3VsdC5sZW5ndGggLSAxXTsNCiAgICAgICAgaWYgKGFycltqXSA8IGFyckkpIHsNCiAgICAgICAgICBwW2ldID0gajsNCiAgICAgICAgICByZXN1bHQucHVzaChpKTsNCiAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgfQ0KICAgICAgICB1ID0gMDsNCiAgICAgICAgdiA9IHJlc3VsdC5sZW5ndGggLSAxOw0KICAgICAgICB3aGlsZSAodSA8IHYpIHsNCiAgICAgICAgICBjID0gdSArIHYgPj4gMTsNCiAgICAgICAgICBpZiAoYXJyW3Jlc3VsdFtjXV0gPCBhcnJJKSB7DQogICAgICAgICAgICB1ID0gYyArIDE7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHYgPSBjOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBpZiAoYXJySSA8IGFycltyZXN1bHRbdV1dKSB7DQogICAgICAgICAgaWYgKHUgPiAwKSB7DQogICAgICAgICAgICBwW2ldID0gcmVzdWx0W3UgLSAxXTsNCiAgICAgICAgICB9DQogICAgICAgICAgcmVzdWx0W3VdID0gaTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICB1ID0gcmVzdWx0Lmxlbmd0aDsNCiAgICB2ID0gcmVzdWx0W3UgLSAxXTsNCiAgICB3aGlsZSAodS0tID4gMCkgew0KICAgICAgcmVzdWx0W3VdID0gdjsNCiAgICAgIHYgPSBwW3ZdOw0KICAgIH0NCiAgICByZXR1cm4gcmVzdWx0Ow0KICB9DQogIGZ1bmN0aW9uIGxvY2F0ZU5vbkh5ZHJhdGVkQXN5bmNSb290KGluc3RhbmNlKSB7DQogICAgY29uc3Qgc3ViQ29tcG9uZW50ID0gaW5zdGFuY2Uuc3ViVHJlZS5jb21wb25lbnQ7DQogICAgaWYgKHN1YkNvbXBvbmVudCkgew0KICAgICAgaWYgKHN1YkNvbXBvbmVudC5hc3luY0RlcCAmJiAhc3ViQ29tcG9uZW50LmFzeW5jUmVzb2x2ZWQpIHsNCiAgICAgICAgcmV0dXJuIHN1YkNvbXBvbmVudDsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiBsb2NhdGVOb25IeWRyYXRlZEFzeW5jUm9vdChzdWJDb21wb25lbnQpOw0KICAgICAgfQ0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBpbnZhbGlkYXRlTW91bnQoaG9va3MpIHsNCiAgICBpZiAoaG9va3MpIHsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaG9va3MubGVuZ3RoOyBpKyspDQogICAgICAgIGhvb2tzW2ldLmZsYWdzIHw9IDg7DQogICAgfQ0KICB9DQoNCiAgY29uc3Qgc3NyQ29udGV4dEtleSA9IFN5bWJvbC5mb3IoInYtc2N4Iik7DQogIGNvbnN0IHVzZVNTUkNvbnRleHQgPSAoKSA9PiB7DQogICAgew0KICAgICAgd2FybiQxKGB1c2VTU1JDb250ZXh0KCkgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgZ2xvYmFsIGJ1aWxkLmApOw0KICAgIH0NCiAgfTsNCg0KICBmdW5jdGlvbiB3YXRjaEVmZmVjdChlZmZlY3QsIG9wdGlvbnMpIHsNCiAgICByZXR1cm4gZG9XYXRjaChlZmZlY3QsIG51bGwsIG9wdGlvbnMpOw0KICB9DQogIGZ1bmN0aW9uIHdhdGNoUG9zdEVmZmVjdChlZmZlY3QsIG9wdGlvbnMpIHsNCiAgICByZXR1cm4gZG9XYXRjaCgNCiAgICAgIGVmZmVjdCwNCiAgICAgIG51bGwsDQogICAgICBleHRlbmQoe30sIG9wdGlvbnMsIHsgZmx1c2g6ICJwb3N0IiB9KSANCiAgICApOw0KICB9DQogIGZ1bmN0aW9uIHdhdGNoU3luY0VmZmVjdChlZmZlY3QsIG9wdGlvbnMpIHsNCiAgICByZXR1cm4gZG9XYXRjaCgNCiAgICAgIGVmZmVjdCwNCiAgICAgIG51bGwsDQogICAgICBleHRlbmQoe30sIG9wdGlvbnMsIHsgZmx1c2g6ICJzeW5jIiB9KSANCiAgICApOw0KICB9DQogIGZ1bmN0aW9uIHdhdGNoKHNvdXJjZSwgY2IsIG9wdGlvbnMpIHsNCiAgICBpZiAoIWlzRnVuY3Rpb24oY2IpKSB7DQogICAgICB3YXJuJDEoDQogICAgICAgIGBcYHdhdGNoKGZuLCBvcHRpb25zPylcYCBzaWduYXR1cmUgaGFzIGJlZW4gbW92ZWQgdG8gYSBzZXBhcmF0ZSBBUEkuIFVzZSBcYHdhdGNoRWZmZWN0KGZuLCBvcHRpb25zPylcYCBpbnN0ZWFkLiBcYHdhdGNoXGAgbm93IG9ubHkgc3VwcG9ydHMgXGB3YXRjaChzb3VyY2UsIGNiLCBvcHRpb25zPykgc2lnbmF0dXJlLmANCiAgICAgICk7DQogICAgfQ0KICAgIHJldHVybiBkb1dhdGNoKHNvdXJjZSwgY2IsIG9wdGlvbnMpOw0KICB9DQogIGZ1bmN0aW9uIGRvV2F0Y2goc291cmNlLCBjYiwgb3B0aW9ucyA9IEVNUFRZX09CSikgew0KICAgIGNvbnN0IHsgaW1tZWRpYXRlLCBkZWVwLCBmbHVzaCwgb25jZSB9ID0gb3B0aW9uczsNCiAgICBpZiAoIWNiKSB7DQogICAgICBpZiAoaW1tZWRpYXRlICE9PSB2b2lkIDApIHsNCiAgICAgICAgd2FybiQxKA0KICAgICAgICAgIGB3YXRjaCgpICJpbW1lZGlhdGUiIG9wdGlvbiBpcyBvbmx5IHJlc3BlY3RlZCB3aGVuIHVzaW5nIHRoZSB3YXRjaChzb3VyY2UsIGNhbGxiYWNrLCBvcHRpb25zPykgc2lnbmF0dXJlLmANCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICAgIGlmIChkZWVwICE9PSB2b2lkIDApIHsNCiAgICAgICAgd2FybiQxKA0KICAgICAgICAgIGB3YXRjaCgpICJkZWVwIiBvcHRpb24gaXMgb25seSByZXNwZWN0ZWQgd2hlbiB1c2luZyB0aGUgd2F0Y2goc291cmNlLCBjYWxsYmFjaywgb3B0aW9ucz8pIHNpZ25hdHVyZS5gDQogICAgICAgICk7DQogICAgICB9DQogICAgICBpZiAob25jZSAhPT0gdm9pZCAwKSB7DQogICAgICAgIHdhcm4kMSgNCiAgICAgICAgICBgd2F0Y2goKSAib25jZSIgb3B0aW9uIGlzIG9ubHkgcmVzcGVjdGVkIHdoZW4gdXNpbmcgdGhlIHdhdGNoKHNvdXJjZSwgY2FsbGJhY2ssIG9wdGlvbnM/KSBzaWduYXR1cmUuYA0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH0NCiAgICBjb25zdCBiYXNlV2F0Y2hPcHRpb25zID0gZXh0ZW5kKHt9LCBvcHRpb25zKTsNCiAgICBiYXNlV2F0Y2hPcHRpb25zLm9uV2FybiA9IHdhcm4kMTsNCiAgICBjb25zdCBpbnN0YW5jZSA9IGN1cnJlbnRJbnN0YW5jZTsNCiAgICBiYXNlV2F0Y2hPcHRpb25zLmNhbGwgPSAoZm4sIHR5cGUsIGFyZ3MpID0+IGNhbGxXaXRoQXN5bmNFcnJvckhhbmRsaW5nKGZuLCBpbnN0YW5jZSwgdHlwZSwgYXJncyk7DQogICAgbGV0IGlzUHJlID0gZmFsc2U7DQogICAgaWYgKGZsdXNoID09PSAicG9zdCIpIHsNCiAgICAgIGJhc2VXYXRjaE9wdGlvbnMuc2NoZWR1bGVyID0gKGpvYikgPT4gew0KICAgICAgICBxdWV1ZVBvc3RSZW5kZXJFZmZlY3Qoam9iLCBpbnN0YW5jZSAmJiBpbnN0YW5jZS5zdXNwZW5zZSk7DQogICAgICB9Ow0KICAgIH0gZWxzZSBpZiAoZmx1c2ggIT09ICJzeW5jIikgew0KICAgICAgaXNQcmUgPSB0cnVlOw0KICAgICAgYmFzZVdhdGNoT3B0aW9ucy5zY2hlZHVsZXIgPSAoam9iLCBpc0ZpcnN0UnVuKSA9PiB7DQogICAgICAgIGlmIChpc0ZpcnN0UnVuKSB7DQogICAgICAgICAgam9iKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcXVldWVKb2Ioam9iKTsNCiAgICAgICAgfQ0KICAgICAgfTsNCiAgICB9DQogICAgYmFzZVdhdGNoT3B0aW9ucy5hdWdtZW50Sm9iID0gKGpvYikgPT4gew0KICAgICAgaWYgKGNiKSB7DQogICAgICAgIGpvYi5mbGFncyB8PSA0Ow0KICAgICAgfQ0KICAgICAgaWYgKGlzUHJlKSB7DQogICAgICAgIGpvYi5mbGFncyB8PSAyOw0KICAgICAgICBpZiAoaW5zdGFuY2UpIHsNCiAgICAgICAgICBqb2IuaWQgPSBpbnN0YW5jZS51aWQ7DQogICAgICAgICAgam9iLmkgPSBpbnN0YW5jZTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH07DQogICAgY29uc3Qgd2F0Y2hIYW5kbGUgPSB3YXRjaCQxKHNvdXJjZSwgY2IsIGJhc2VXYXRjaE9wdGlvbnMpOw0KICAgIHJldHVybiB3YXRjaEhhbmRsZTsNCiAgfQ0KICBmdW5jdGlvbiBpbnN0YW5jZVdhdGNoKHNvdXJjZSwgdmFsdWUsIG9wdGlvbnMpIHsNCiAgICBjb25zdCBwdWJsaWNUaGlzID0gdGhpcy5wcm94eTsNCiAgICBjb25zdCBnZXR0ZXIgPSBpc1N0cmluZyhzb3VyY2UpID8gc291cmNlLmluY2x1ZGVzKCIuIikgPyBjcmVhdGVQYXRoR2V0dGVyKHB1YmxpY1RoaXMsIHNvdXJjZSkgOiAoKSA9PiBwdWJsaWNUaGlzW3NvdXJjZV0gOiBzb3VyY2UuYmluZChwdWJsaWNUaGlzLCBwdWJsaWNUaGlzKTsNCiAgICBsZXQgY2I7DQogICAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7DQogICAgICBjYiA9IHZhbHVlOw0KICAgIH0gZWxzZSB7DQogICAgICBjYiA9IHZhbHVlLmhhbmRsZXI7DQogICAgICBvcHRpb25zID0gdmFsdWU7DQogICAgfQ0KICAgIGNvbnN0IHJlc2V0ID0gc2V0Q3VycmVudEluc3RhbmNlKHRoaXMpOw0KICAgIGNvbnN0IHJlcyA9IGRvV2F0Y2goZ2V0dGVyLCBjYi5iaW5kKHB1YmxpY1RoaXMpLCBvcHRpb25zKTsNCiAgICByZXNldCgpOw0KICAgIHJldHVybiByZXM7DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlUGF0aEdldHRlcihjdHgsIHBhdGgpIHsNCiAgICBjb25zdCBzZWdtZW50cyA9IHBhdGguc3BsaXQoIi4iKTsNCiAgICByZXR1cm4gKCkgPT4gew0KICAgICAgbGV0IGN1ciA9IGN0eDsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2VnbWVudHMubGVuZ3RoICYmIGN1cjsgaSsrKSB7DQogICAgICAgIGN1ciA9IGN1cltzZWdtZW50c1tpXV07DQogICAgICB9DQogICAgICByZXR1cm4gY3VyOw0KICAgIH07DQogIH0NCg0KICBmdW5jdGlvbiB1c2VNb2RlbChwcm9wcywgbmFtZSwgb3B0aW9ucyA9IEVNUFRZX09CSikgew0KICAgIGNvbnN0IGkgPSBnZXRDdXJyZW50SW5zdGFuY2UoKTsNCiAgICBpZiAoIWkpIHsNCiAgICAgIHdhcm4kMShgdXNlTW9kZWwoKSBjYWxsZWQgd2l0aG91dCBhY3RpdmUgaW5zdGFuY2UuYCk7DQogICAgICByZXR1cm4gcmVmKCk7DQogICAgfQ0KICAgIGNvbnN0IGNhbWVsaXplZE5hbWUgPSBjYW1lbGl6ZShuYW1lKTsNCiAgICBpZiAoIWkucHJvcHNPcHRpb25zWzBdW2NhbWVsaXplZE5hbWVdKSB7DQogICAgICB3YXJuJDEoYHVzZU1vZGVsKCkgY2FsbGVkIHdpdGggcHJvcCAiJHtuYW1lfSIgd2hpY2ggaXMgbm90IGRlY2xhcmVkLmApOw0KICAgICAgcmV0dXJuIHJlZigpOw0KICAgIH0NCiAgICBjb25zdCBoeXBoZW5hdGVkTmFtZSA9IGh5cGhlbmF0ZShuYW1lKTsNCiAgICBjb25zdCBtb2RpZmllcnMgPSBnZXRNb2RlbE1vZGlmaWVycyhwcm9wcywgY2FtZWxpemVkTmFtZSk7DQogICAgY29uc3QgcmVzID0gY3VzdG9tUmVmKCh0cmFjaywgdHJpZ2dlcikgPT4gew0KICAgICAgbGV0IGxvY2FsVmFsdWU7DQogICAgICBsZXQgcHJldlNldFZhbHVlID0gRU1QVFlfT0JKOw0KICAgICAgbGV0IHByZXZFbWl0dGVkVmFsdWU7DQogICAgICB3YXRjaFN5bmNFZmZlY3QoKCkgPT4gew0KICAgICAgICBjb25zdCBwcm9wVmFsdWUgPSBwcm9wc1tjYW1lbGl6ZWROYW1lXTsNCiAgICAgICAgaWYgKGhhc0NoYW5nZWQobG9jYWxWYWx1ZSwgcHJvcFZhbHVlKSkgew0KICAgICAgICAgIGxvY2FsVmFsdWUgPSBwcm9wVmFsdWU7DQogICAgICAgICAgdHJpZ2dlcigpOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICAgIHJldHVybiB7DQogICAgICAgIGdldCgpIHsNCiAgICAgICAgICB0cmFjaygpOw0KICAgICAgICAgIHJldHVybiBvcHRpb25zLmdldCA/IG9wdGlvbnMuZ2V0KGxvY2FsVmFsdWUpIDogbG9jYWxWYWx1ZTsNCiAgICAgICAgfSwNCiAgICAgICAgc2V0KHZhbHVlKSB7DQogICAgICAgICAgY29uc3QgZW1pdHRlZFZhbHVlID0gb3B0aW9ucy5zZXQgPyBvcHRpb25zLnNldCh2YWx1ZSkgOiB2YWx1ZTsNCiAgICAgICAgICBpZiAoIWhhc0NoYW5nZWQoZW1pdHRlZFZhbHVlLCBsb2NhbFZhbHVlKSAmJiAhKHByZXZTZXRWYWx1ZSAhPT0gRU1QVFlfT0JKICYmIGhhc0NoYW5nZWQodmFsdWUsIHByZXZTZXRWYWx1ZSkpKSB7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgfQ0KICAgICAgICAgIGNvbnN0IHJhd1Byb3BzID0gaS52bm9kZS5wcm9wczsNCiAgICAgICAgICBpZiAoIShyYXdQcm9wcyAmJiAvLyBjaGVjayBpZiBwYXJlbnQgaGFzIHBhc3NlZCB2LW1vZGVsDQogICAgICAgICAgKG5hbWUgaW4gcmF3UHJvcHMgfHwgY2FtZWxpemVkTmFtZSBpbiByYXdQcm9wcyB8fCBoeXBoZW5hdGVkTmFtZSBpbiByYXdQcm9wcykgJiYgKGBvblVwZGF0ZToke25hbWV9YCBpbiByYXdQcm9wcyB8fCBgb25VcGRhdGU6JHtjYW1lbGl6ZWROYW1lfWAgaW4gcmF3UHJvcHMgfHwgYG9uVXBkYXRlOiR7aHlwaGVuYXRlZE5hbWV9YCBpbiByYXdQcm9wcykpKSB7DQogICAgICAgICAgICBsb2NhbFZhbHVlID0gdmFsdWU7DQogICAgICAgICAgICB0cmlnZ2VyKCk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGkuZW1pdChgdXBkYXRlOiR7bmFtZX1gLCBlbWl0dGVkVmFsdWUpOw0KICAgICAgICAgIGlmIChoYXNDaGFuZ2VkKHZhbHVlLCBlbWl0dGVkVmFsdWUpICYmIGhhc0NoYW5nZWQodmFsdWUsIHByZXZTZXRWYWx1ZSkgJiYgIWhhc0NoYW5nZWQoZW1pdHRlZFZhbHVlLCBwcmV2RW1pdHRlZFZhbHVlKSkgew0KICAgICAgICAgICAgdHJpZ2dlcigpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBwcmV2U2V0VmFsdWUgPSB2YWx1ZTsNCiAgICAgICAgICBwcmV2RW1pdHRlZFZhbHVlID0gZW1pdHRlZFZhbHVlOw0KICAgICAgICB9DQogICAgICB9Ow0KICAgIH0pOw0KICAgIHJlc1tTeW1ib2wuaXRlcmF0b3JdID0gKCkgPT4gew0KICAgICAgbGV0IGkyID0gMDsNCiAgICAgIHJldHVybiB7DQogICAgICAgIG5leHQoKSB7DQogICAgICAgICAgaWYgKGkyIDwgMikgew0KICAgICAgICAgICAgcmV0dXJuIHsgdmFsdWU6IGkyKysgPyBtb2RpZmllcnMgfHwgRU1QVFlfT0JKIDogcmVzLCBkb25lOiBmYWxzZSB9Ow0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICByZXR1cm4geyBkb25lOiB0cnVlIH07DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9Ow0KICAgIH07DQogICAgcmV0dXJuIHJlczsNCiAgfQ0KICBjb25zdCBnZXRNb2RlbE1vZGlmaWVycyA9IChwcm9wcywgbW9kZWxOYW1lKSA9PiB7DQogICAgcmV0dXJuIG1vZGVsTmFtZSA9PT0gIm1vZGVsVmFsdWUiIHx8IG1vZGVsTmFtZSA9PT0gIm1vZGVsLXZhbHVlIiA/IHByb3BzLm1vZGVsTW9kaWZpZXJzIDogcHJvcHNbYCR7bW9kZWxOYW1lfU1vZGlmaWVyc2BdIHx8IHByb3BzW2Ake2NhbWVsaXplKG1vZGVsTmFtZSl9TW9kaWZpZXJzYF0gfHwgcHJvcHNbYCR7aHlwaGVuYXRlKG1vZGVsTmFtZSl9TW9kaWZpZXJzYF07DQogIH07DQoNCiAgZnVuY3Rpb24gZW1pdChpbnN0YW5jZSwgZXZlbnQsIC4uLnJhd0FyZ3MpIHsNCiAgICBpZiAoaW5zdGFuY2UuaXNVbm1vdW50ZWQpIHJldHVybjsNCiAgICBjb25zdCBwcm9wcyA9IGluc3RhbmNlLnZub2RlLnByb3BzIHx8IEVNUFRZX09CSjsNCiAgICB7DQogICAgICBjb25zdCB7DQogICAgICAgIGVtaXRzT3B0aW9ucywNCiAgICAgICAgcHJvcHNPcHRpb25zOiBbcHJvcHNPcHRpb25zXQ0KICAgICAgfSA9IGluc3RhbmNlOw0KICAgICAgaWYgKGVtaXRzT3B0aW9ucykgew0KICAgICAgICBpZiAoIShldmVudCBpbiBlbWl0c09wdGlvbnMpICYmIHRydWUpIHsNCiAgICAgICAgICBpZiAoIXByb3BzT3B0aW9ucyB8fCAhKHRvSGFuZGxlcktleShjYW1lbGl6ZShldmVudCkpIGluIHByb3BzT3B0aW9ucykpIHsNCiAgICAgICAgICAgIHdhcm4kMSgNCiAgICAgICAgICAgICAgYENvbXBvbmVudCBlbWl0dGVkIGV2ZW50ICIke2V2ZW50fSIgYnV0IGl0IGlzIG5laXRoZXIgZGVjbGFyZWQgaW4gdGhlIGVtaXRzIG9wdGlvbiBub3IgYXMgYW4gIiR7dG9IYW5kbGVyS2V5KGNhbWVsaXplKGV2ZW50KSl9IiBwcm9wLmANCiAgICAgICAgICAgICk7DQogICAgICAgICAgfQ0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGNvbnN0IHZhbGlkYXRvciA9IGVtaXRzT3B0aW9uc1tldmVudF07DQogICAgICAgICAgaWYgKGlzRnVuY3Rpb24odmFsaWRhdG9yKSkgew0KICAgICAgICAgICAgY29uc3QgaXNWYWxpZCA9IHZhbGlkYXRvciguLi5yYXdBcmdzKTsNCiAgICAgICAgICAgIGlmICghaXNWYWxpZCkgew0KICAgICAgICAgICAgICB3YXJuJDEoDQogICAgICAgICAgICAgICAgYEludmFsaWQgZXZlbnQgYXJndW1lbnRzOiBldmVudCB2YWxpZGF0aW9uIGZhaWxlZCBmb3IgZXZlbnQgIiR7ZXZlbnR9Ii5gDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIGxldCBhcmdzID0gcmF3QXJnczsNCiAgICBjb25zdCBpc01vZGVsTGlzdGVuZXIgPSBldmVudC5zdGFydHNXaXRoKCJ1cGRhdGU6Iik7DQogICAgY29uc3QgbW9kaWZpZXJzID0gaXNNb2RlbExpc3RlbmVyICYmIGdldE1vZGVsTW9kaWZpZXJzKHByb3BzLCBldmVudC5zbGljZSg3KSk7DQogICAgaWYgKG1vZGlmaWVycykgew0KICAgICAgaWYgKG1vZGlmaWVycy50cmltKSB7DQogICAgICAgIGFyZ3MgPSByYXdBcmdzLm1hcCgoYSkgPT4gaXNTdHJpbmcoYSkgPyBhLnRyaW0oKSA6IGEpOw0KICAgICAgfQ0KICAgICAgaWYgKG1vZGlmaWVycy5udW1iZXIpIHsNCiAgICAgICAgYXJncyA9IHJhd0FyZ3MubWFwKGxvb3NlVG9OdW1iZXIpOw0KICAgICAgfQ0KICAgIH0NCiAgICB7DQogICAgICBkZXZ0b29sc0NvbXBvbmVudEVtaXQoaW5zdGFuY2UsIGV2ZW50LCBhcmdzKTsNCiAgICB9DQogICAgew0KICAgICAgY29uc3QgbG93ZXJDYXNlRXZlbnQgPSBldmVudC50b0xvd2VyQ2FzZSgpOw0KICAgICAgaWYgKGxvd2VyQ2FzZUV2ZW50ICE9PSBldmVudCAmJiBwcm9wc1t0b0hhbmRsZXJLZXkobG93ZXJDYXNlRXZlbnQpXSkgew0KICAgICAgICB3YXJuJDEoDQogICAgICAgICAgYEV2ZW50ICIke2xvd2VyQ2FzZUV2ZW50fSIgaXMgZW1pdHRlZCBpbiBjb21wb25lbnQgJHtmb3JtYXRDb21wb25lbnROYW1lKA0KICAgICAgICAgIGluc3RhbmNlLA0KICAgICAgICAgIGluc3RhbmNlLnR5cGUNCiAgICAgICAgKX0gYnV0IHRoZSBoYW5kbGVyIGlzIHJlZ2lzdGVyZWQgZm9yICIke2V2ZW50fSIuIE5vdGUgdGhhdCBIVE1MIGF0dHJpYnV0ZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUgYW5kIHlvdSBjYW5ub3QgdXNlIHYtb24gdG8gbGlzdGVuIHRvIGNhbWVsQ2FzZSBldmVudHMgd2hlbiB1c2luZyBpbi1ET00gdGVtcGxhdGVzLiBZb3Ugc2hvdWxkIHByb2JhYmx5IHVzZSAiJHtoeXBoZW5hdGUoDQogICAgICAgICAgZXZlbnQNCiAgICAgICAgKX0iIGluc3RlYWQgb2YgIiR7ZXZlbnR9Ii5gDQogICAgICAgICk7DQogICAgICB9DQogICAgfQ0KICAgIGxldCBoYW5kbGVyTmFtZTsNCiAgICBsZXQgaGFuZGxlciA9IHByb3BzW2hhbmRsZXJOYW1lID0gdG9IYW5kbGVyS2V5KGV2ZW50KV0gfHwgLy8gYWxzbyB0cnkgY2FtZWxDYXNlIGV2ZW50IGhhbmRsZXIgKCMyMjQ5KQ0KICAgIHByb3BzW2hhbmRsZXJOYW1lID0gdG9IYW5kbGVyS2V5KGNhbWVsaXplKGV2ZW50KSldOw0KICAgIGlmICghaGFuZGxlciAmJiBpc01vZGVsTGlzdGVuZXIpIHsNCiAgICAgIGhhbmRsZXIgPSBwcm9wc1toYW5kbGVyTmFtZSA9IHRvSGFuZGxlcktleShoeXBoZW5hdGUoZXZlbnQpKV07DQogICAgfQ0KICAgIGlmIChoYW5kbGVyKSB7DQogICAgICBjYWxsV2l0aEFzeW5jRXJyb3JIYW5kbGluZygNCiAgICAgICAgaGFuZGxlciwNCiAgICAgICAgaW5zdGFuY2UsDQogICAgICAgIDYsDQogICAgICAgIGFyZ3MNCiAgICAgICk7DQogICAgfQ0KICAgIGNvbnN0IG9uY2VIYW5kbGVyID0gcHJvcHNbaGFuZGxlck5hbWUgKyBgT25jZWBdOw0KICAgIGlmIChvbmNlSGFuZGxlcikgew0KICAgICAgaWYgKCFpbnN0YW5jZS5lbWl0dGVkKSB7DQogICAgICAgIGluc3RhbmNlLmVtaXR0ZWQgPSB7fTsNCiAgICAgIH0gZWxzZSBpZiAoaW5zdGFuY2UuZW1pdHRlZFtoYW5kbGVyTmFtZV0pIHsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgaW5zdGFuY2UuZW1pdHRlZFtoYW5kbGVyTmFtZV0gPSB0cnVlOw0KICAgICAgY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoDQogICAgICAgIG9uY2VIYW5kbGVyLA0KICAgICAgICBpbnN0YW5jZSwNCiAgICAgICAgNiwNCiAgICAgICAgYXJncw0KICAgICAgKTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gbm9ybWFsaXplRW1pdHNPcHRpb25zKGNvbXAsIGFwcENvbnRleHQsIGFzTWl4aW4gPSBmYWxzZSkgew0KICAgIGNvbnN0IGNhY2hlID0gYXBwQ29udGV4dC5lbWl0c0NhY2hlOw0KICAgIGNvbnN0IGNhY2hlZCA9IGNhY2hlLmdldChjb21wKTsNCiAgICBpZiAoY2FjaGVkICE9PSB2b2lkIDApIHsNCiAgICAgIHJldHVybiBjYWNoZWQ7DQogICAgfQ0KICAgIGNvbnN0IHJhdyA9IGNvbXAuZW1pdHM7DQogICAgbGV0IG5vcm1hbGl6ZWQgPSB7fTsNCiAgICBsZXQgaGFzRXh0ZW5kcyA9IGZhbHNlOw0KICAgIGlmICghaXNGdW5jdGlvbihjb21wKSkgew0KICAgICAgY29uc3QgZXh0ZW5kRW1pdHMgPSAocmF3MikgPT4gew0KICAgICAgICBjb25zdCBub3JtYWxpemVkRnJvbUV4dGVuZCA9IG5vcm1hbGl6ZUVtaXRzT3B0aW9ucyhyYXcyLCBhcHBDb250ZXh0LCB0cnVlKTsNCiAgICAgICAgaWYgKG5vcm1hbGl6ZWRGcm9tRXh0ZW5kKSB7DQogICAgICAgICAgaGFzRXh0ZW5kcyA9IHRydWU7DQogICAgICAgICAgZXh0ZW5kKG5vcm1hbGl6ZWQsIG5vcm1hbGl6ZWRGcm9tRXh0ZW5kKTsNCiAgICAgICAgfQ0KICAgICAgfTsNCiAgICAgIGlmICghYXNNaXhpbiAmJiBhcHBDb250ZXh0Lm1peGlucy5sZW5ndGgpIHsNCiAgICAgICAgYXBwQ29udGV4dC5taXhpbnMuZm9yRWFjaChleHRlbmRFbWl0cyk7DQogICAgICB9DQogICAgICBpZiAoY29tcC5leHRlbmRzKSB7DQogICAgICAgIGV4dGVuZEVtaXRzKGNvbXAuZXh0ZW5kcyk7DQogICAgICB9DQogICAgICBpZiAoY29tcC5taXhpbnMpIHsNCiAgICAgICAgY29tcC5taXhpbnMuZm9yRWFjaChleHRlbmRFbWl0cyk7DQogICAgICB9DQogICAgfQ0KICAgIGlmICghcmF3ICYmICFoYXNFeHRlbmRzKSB7DQogICAgICBpZiAoaXNPYmplY3QoY29tcCkpIHsNCiAgICAgICAgY2FjaGUuc2V0KGNvbXAsIG51bGwpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIG51bGw7DQogICAgfQ0KICAgIGlmIChpc0FycmF5KHJhdykpIHsNCiAgICAgIHJhdy5mb3JFYWNoKChrZXkpID0+IG5vcm1hbGl6ZWRba2V5XSA9IG51bGwpOw0KICAgIH0gZWxzZSB7DQogICAgICBleHRlbmQobm9ybWFsaXplZCwgcmF3KTsNCiAgICB9DQogICAgaWYgKGlzT2JqZWN0KGNvbXApKSB7DQogICAgICBjYWNoZS5zZXQoY29tcCwgbm9ybWFsaXplZCk7DQogICAgfQ0KICAgIHJldHVybiBub3JtYWxpemVkOw0KICB9DQogIGZ1bmN0aW9uIGlzRW1pdExpc3RlbmVyKG9wdGlvbnMsIGtleSkgew0KICAgIGlmICghb3B0aW9ucyB8fCAhaXNPbihrZXkpKSB7DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KICAgIGtleSA9IGtleS5zbGljZSgyKS5yZXBsYWNlKC9PbmNlJC8sICIiKTsNCiAgICByZXR1cm4gaGFzT3duKG9wdGlvbnMsIGtleVswXS50b0xvd2VyQ2FzZSgpICsga2V5LnNsaWNlKDEpKSB8fCBoYXNPd24ob3B0aW9ucywgaHlwaGVuYXRlKGtleSkpIHx8IGhhc093bihvcHRpb25zLCBrZXkpOw0KICB9DQoNCiAgbGV0IGFjY2Vzc2VkQXR0cnMgPSBmYWxzZTsNCiAgZnVuY3Rpb24gbWFya0F0dHJzQWNjZXNzZWQoKSB7DQogICAgYWNjZXNzZWRBdHRycyA9IHRydWU7DQogIH0NCiAgZnVuY3Rpb24gcmVuZGVyQ29tcG9uZW50Um9vdChpbnN0YW5jZSkgew0KICAgIGNvbnN0IHsNCiAgICAgIHR5cGU6IENvbXBvbmVudCwNCiAgICAgIHZub2RlLA0KICAgICAgcHJveHksDQogICAgICB3aXRoUHJveHksDQogICAgICBwcm9wc09wdGlvbnM6IFtwcm9wc09wdGlvbnNdLA0KICAgICAgc2xvdHMsDQogICAgICBhdHRycywNCiAgICAgIGVtaXQsDQogICAgICByZW5kZXIsDQogICAgICByZW5kZXJDYWNoZSwNCiAgICAgIHByb3BzLA0KICAgICAgZGF0YSwNCiAgICAgIHNldHVwU3RhdGUsDQogICAgICBjdHgsDQogICAgICBpbmhlcml0QXR0cnMNCiAgICB9ID0gaW5zdGFuY2U7DQogICAgY29uc3QgcHJldiA9IHNldEN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZShpbnN0YW5jZSk7DQogICAgbGV0IHJlc3VsdDsNCiAgICBsZXQgZmFsbHRocm91Z2hBdHRyczsNCiAgICB7DQogICAgICBhY2Nlc3NlZEF0dHJzID0gZmFsc2U7DQogICAgfQ0KICAgIHRyeSB7DQogICAgICBpZiAodm5vZGUuc2hhcGVGbGFnICYgNCkgew0KICAgICAgICBjb25zdCBwcm94eVRvVXNlID0gd2l0aFByb3h5IHx8IHByb3h5Ow0KICAgICAgICBjb25zdCB0aGlzUHJveHkgPSBzZXR1cFN0YXRlLl9faXNTY3JpcHRTZXR1cCA/IG5ldyBQcm94eShwcm94eVRvVXNlLCB7DQogICAgICAgICAgZ2V0KHRhcmdldCwga2V5LCByZWNlaXZlcikgew0KICAgICAgICAgICAgd2FybiQxKA0KICAgICAgICAgICAgICBgUHJvcGVydHkgJyR7U3RyaW5nKA0KICAgICAgICAgICAgICBrZXkNCiAgICAgICAgICAgICl9JyB3YXMgYWNjZXNzZWQgdmlhICd0aGlzJy4gQXZvaWQgdXNpbmcgJ3RoaXMnIGluIHRlbXBsYXRlcy5gDQogICAgICAgICAgICApOw0KICAgICAgICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0KHRhcmdldCwga2V5LCByZWNlaXZlcik7DQogICAgICAgICAgfQ0KICAgICAgICB9KSA6IHByb3h5VG9Vc2U7DQogICAgICAgIHJlc3VsdCA9IG5vcm1hbGl6ZVZOb2RlKA0KICAgICAgICAgIHJlbmRlci5jYWxsKA0KICAgICAgICAgICAgdGhpc1Byb3h5LA0KICAgICAgICAgICAgcHJveHlUb1VzZSwNCiAgICAgICAgICAgIHJlbmRlckNhY2hlLA0KICAgICAgICAgICAgdHJ1ZSA/IHNoYWxsb3dSZWFkb25seShwcm9wcykgOiBwcm9wcywNCiAgICAgICAgICAgIHNldHVwU3RhdGUsDQogICAgICAgICAgICBkYXRhLA0KICAgICAgICAgICAgY3R4DQogICAgICAgICAgKQ0KICAgICAgICApOw0KICAgICAgICBmYWxsdGhyb3VnaEF0dHJzID0gYXR0cnM7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb25zdCByZW5kZXIyID0gQ29tcG9uZW50Ow0KICAgICAgICBpZiAoYXR0cnMgPT09IHByb3BzKSB7DQogICAgICAgICAgbWFya0F0dHJzQWNjZXNzZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICByZXN1bHQgPSBub3JtYWxpemVWTm9kZSgNCiAgICAgICAgICByZW5kZXIyLmxlbmd0aCA+IDEgPyByZW5kZXIyKA0KICAgICAgICAgICAgdHJ1ZSA/IHNoYWxsb3dSZWFkb25seShwcm9wcykgOiBwcm9wcywNCiAgICAgICAgICAgIHRydWUgPyB7DQogICAgICAgICAgICAgIGdldCBhdHRycygpIHsNCiAgICAgICAgICAgICAgICBtYXJrQXR0cnNBY2Nlc3NlZCgpOw0KICAgICAgICAgICAgICAgIHJldHVybiBzaGFsbG93UmVhZG9ubHkoYXR0cnMpOw0KICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICBzbG90cywNCiAgICAgICAgICAgICAgZW1pdA0KICAgICAgICAgICAgfSA6IHsgYXR0cnMsIHNsb3RzLCBlbWl0IH0NCiAgICAgICAgICApIDogcmVuZGVyMigNCiAgICAgICAgICAgIHRydWUgPyBzaGFsbG93UmVhZG9ubHkocHJvcHMpIDogcHJvcHMsDQogICAgICAgICAgICBudWxsDQogICAgICAgICAgKQ0KICAgICAgICApOw0KICAgICAgICBmYWxsdGhyb3VnaEF0dHJzID0gQ29tcG9uZW50LnByb3BzID8gYXR0cnMgOiBnZXRGdW5jdGlvbmFsRmFsbHRocm91Z2goYXR0cnMpOw0KICAgICAgfQ0KICAgIH0gY2F0Y2ggKGVycikgew0KICAgICAgYmxvY2tTdGFjay5sZW5ndGggPSAwOw0KICAgICAgaGFuZGxlRXJyb3IoZXJyLCBpbnN0YW5jZSwgMSk7DQogICAgICByZXN1bHQgPSBjcmVhdGVWTm9kZShDb21tZW50KTsNCiAgICB9DQogICAgbGV0IHJvb3QgPSByZXN1bHQ7DQogICAgbGV0IHNldFJvb3QgPSB2b2lkIDA7DQogICAgaWYgKHJlc3VsdC5wYXRjaEZsYWcgPiAwICYmIHJlc3VsdC5wYXRjaEZsYWcgJiAyMDQ4KSB7DQogICAgICBbcm9vdCwgc2V0Um9vdF0gPSBnZXRDaGlsZFJvb3QocmVzdWx0KTsNCiAgICB9DQogICAgaWYgKGZhbGx0aHJvdWdoQXR0cnMgJiYgaW5oZXJpdEF0dHJzICE9PSBmYWxzZSkgew0KICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGZhbGx0aHJvdWdoQXR0cnMpOw0KICAgICAgY29uc3QgeyBzaGFwZUZsYWcgfSA9IHJvb3Q7DQogICAgICBpZiAoa2V5cy5sZW5ndGgpIHsNCiAgICAgICAgaWYgKHNoYXBlRmxhZyAmICgxIHwgNikpIHsNCiAgICAgICAgICBpZiAocHJvcHNPcHRpb25zICYmIGtleXMuc29tZShpc01vZGVsTGlzdGVuZXIpKSB7DQogICAgICAgICAgICBmYWxsdGhyb3VnaEF0dHJzID0gZmlsdGVyTW9kZWxMaXN0ZW5lcnMoDQogICAgICAgICAgICAgIGZhbGx0aHJvdWdoQXR0cnMsDQogICAgICAgICAgICAgIHByb3BzT3B0aW9ucw0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9DQogICAgICAgICAgcm9vdCA9IGNsb25lVk5vZGUocm9vdCwgZmFsbHRocm91Z2hBdHRycywgZmFsc2UsIHRydWUpOw0KICAgICAgICB9IGVsc2UgaWYgKCFhY2Nlc3NlZEF0dHJzICYmIHJvb3QudHlwZSAhPT0gQ29tbWVudCkgew0KICAgICAgICAgIGNvbnN0IGFsbEF0dHJzID0gT2JqZWN0LmtleXMoYXR0cnMpOw0KICAgICAgICAgIGNvbnN0IGV2ZW50QXR0cnMgPSBbXTsNCiAgICAgICAgICBjb25zdCBleHRyYUF0dHJzID0gW107DQogICAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBhbGxBdHRycy5sZW5ndGg7IGkgPCBsOyBpKyspIHsNCiAgICAgICAgICAgIGNvbnN0IGtleSA9IGFsbEF0dHJzW2ldOw0KICAgICAgICAgICAgaWYgKGlzT24oa2V5KSkgew0KICAgICAgICAgICAgICBpZiAoIWlzTW9kZWxMaXN0ZW5lcihrZXkpKSB7DQogICAgICAgICAgICAgICAgZXZlbnRBdHRycy5wdXNoKGtleVsyXS50b0xvd2VyQ2FzZSgpICsga2V5LnNsaWNlKDMpKTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgZXh0cmFBdHRycy5wdXNoKGtleSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmIChleHRyYUF0dHJzLmxlbmd0aCkgew0KICAgICAgICAgICAgd2FybiQxKA0KICAgICAgICAgICAgICBgRXh0cmFuZW91cyBub24tcHJvcHMgYXR0cmlidXRlcyAoJHtleHRyYUF0dHJzLmpvaW4oIiwgIil9KSB3ZXJlIHBhc3NlZCB0byBjb21wb25lbnQgYnV0IGNvdWxkIG5vdCBiZSBhdXRvbWF0aWNhbGx5IGluaGVyaXRlZCBiZWNhdXNlIGNvbXBvbmVudCByZW5kZXJzIGZyYWdtZW50IG9yIHRleHQgb3IgdGVsZXBvcnQgcm9vdCBub2Rlcy5gDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpZiAoZXZlbnRBdHRycy5sZW5ndGgpIHsNCiAgICAgICAgICAgIHdhcm4kMSgNCiAgICAgICAgICAgICAgYEV4dHJhbmVvdXMgbm9uLWVtaXRzIGV2ZW50IGxpc3RlbmVycyAoJHtldmVudEF0dHJzLmpvaW4oIiwgIil9KSB3ZXJlIHBhc3NlZCB0byBjb21wb25lbnQgYnV0IGNvdWxkIG5vdCBiZSBhdXRvbWF0aWNhbGx5IGluaGVyaXRlZCBiZWNhdXNlIGNvbXBvbmVudCByZW5kZXJzIGZyYWdtZW50IG9yIHRleHQgcm9vdCBub2Rlcy4gSWYgdGhlIGxpc3RlbmVyIGlzIGludGVuZGVkIHRvIGJlIGEgY29tcG9uZW50IGN1c3RvbSBldmVudCBsaXN0ZW5lciBvbmx5LCBkZWNsYXJlIGl0IHVzaW5nIHRoZSAiZW1pdHMiIG9wdGlvbi5gDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAodm5vZGUuZGlycykgew0KICAgICAgaWYgKCFpc0VsZW1lbnRSb290KHJvb3QpKSB7DQogICAgICAgIHdhcm4kMSgNCiAgICAgICAgICBgUnVudGltZSBkaXJlY3RpdmUgdXNlZCBvbiBjb21wb25lbnQgd2l0aCBub24tZWxlbWVudCByb290IG5vZGUuIFRoZSBkaXJlY3RpdmVzIHdpbGwgbm90IGZ1bmN0aW9uIGFzIGludGVuZGVkLmANCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICAgIHJvb3QgPSBjbG9uZVZOb2RlKHJvb3QsIG51bGwsIGZhbHNlLCB0cnVlKTsNCiAgICAgIHJvb3QuZGlycyA9IHJvb3QuZGlycyA/IHJvb3QuZGlycy5jb25jYXQodm5vZGUuZGlycykgOiB2bm9kZS5kaXJzOw0KICAgIH0NCiAgICBpZiAodm5vZGUudHJhbnNpdGlvbikgew0KICAgICAgaWYgKCFpc0VsZW1lbnRSb290KHJvb3QpKSB7DQogICAgICAgIHdhcm4kMSgNCiAgICAgICAgICBgQ29tcG9uZW50IGluc2lkZSA8VHJhbnNpdGlvbj4gcmVuZGVycyBub24tZWxlbWVudCByb290IG5vZGUgdGhhdCBjYW5ub3QgYmUgYW5pbWF0ZWQuYA0KICAgICAgICApOw0KICAgICAgfQ0KICAgICAgc2V0VHJhbnNpdGlvbkhvb2tzKHJvb3QsIHZub2RlLnRyYW5zaXRpb24pOw0KICAgIH0NCiAgICBpZiAoc2V0Um9vdCkgew0KICAgICAgc2V0Um9vdChyb290KTsNCiAgICB9IGVsc2Ugew0KICAgICAgcmVzdWx0ID0gcm9vdDsNCiAgICB9DQogICAgc2V0Q3VycmVudFJlbmRlcmluZ0luc3RhbmNlKHByZXYpOw0KICAgIHJldHVybiByZXN1bHQ7DQogIH0NCiAgY29uc3QgZ2V0Q2hpbGRSb290ID0gKHZub2RlKSA9PiB7DQogICAgY29uc3QgcmF3Q2hpbGRyZW4gPSB2bm9kZS5jaGlsZHJlbjsNCiAgICBjb25zdCBkeW5hbWljQ2hpbGRyZW4gPSB2bm9kZS5keW5hbWljQ2hpbGRyZW47DQogICAgY29uc3QgY2hpbGRSb290ID0gZmlsdGVyU2luZ2xlUm9vdChyYXdDaGlsZHJlbiwgZmFsc2UpOw0KICAgIGlmICghY2hpbGRSb290KSB7DQogICAgICByZXR1cm4gW3Zub2RlLCB2b2lkIDBdOw0KICAgIH0gZWxzZSBpZiAoY2hpbGRSb290LnBhdGNoRmxhZyA+IDAgJiYgY2hpbGRSb290LnBhdGNoRmxhZyAmIDIwNDgpIHsNCiAgICAgIHJldHVybiBnZXRDaGlsZFJvb3QoY2hpbGRSb290KTsNCiAgICB9DQogICAgY29uc3QgaW5kZXggPSByYXdDaGlsZHJlbi5pbmRleE9mKGNoaWxkUm9vdCk7DQogICAgY29uc3QgZHluYW1pY0luZGV4ID0gZHluYW1pY0NoaWxkcmVuID8gZHluYW1pY0NoaWxkcmVuLmluZGV4T2YoY2hpbGRSb290KSA6IC0xOw0KICAgIGNvbnN0IHNldFJvb3QgPSAodXBkYXRlZFJvb3QpID0+IHsNCiAgICAgIHJhd0NoaWxkcmVuW2luZGV4XSA9IHVwZGF0ZWRSb290Ow0KICAgICAgaWYgKGR5bmFtaWNDaGlsZHJlbikgew0KICAgICAgICBpZiAoZHluYW1pY0luZGV4ID4gLTEpIHsNCiAgICAgICAgICBkeW5hbWljQ2hpbGRyZW5bZHluYW1pY0luZGV4XSA9IHVwZGF0ZWRSb290Ow0KICAgICAgICB9IGVsc2UgaWYgKHVwZGF0ZWRSb290LnBhdGNoRmxhZyA+IDApIHsNCiAgICAgICAgICB2bm9kZS5keW5hbWljQ2hpbGRyZW4gPSBbLi4uZHluYW1pY0NoaWxkcmVuLCB1cGRhdGVkUm9vdF07DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9Ow0KICAgIHJldHVybiBbbm9ybWFsaXplVk5vZGUoY2hpbGRSb290KSwgc2V0Um9vdF07DQogIH07DQogIGZ1bmN0aW9uIGZpbHRlclNpbmdsZVJvb3QoY2hpbGRyZW4sIHJlY3Vyc2UgPSB0cnVlKSB7DQogICAgbGV0IHNpbmdsZVJvb3Q7DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgew0KICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXTsNCiAgICAgIGlmIChpc1ZOb2RlKGNoaWxkKSkgew0KICAgICAgICBpZiAoY2hpbGQudHlwZSAhPT0gQ29tbWVudCB8fCBjaGlsZC5jaGlsZHJlbiA9PT0gInYtaWYiKSB7DQogICAgICAgICAgaWYgKHNpbmdsZVJvb3QpIHsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgc2luZ2xlUm9vdCA9IGNoaWxkOw0KICAgICAgICAgICAgaWYgKHJlY3Vyc2UgJiYgc2luZ2xlUm9vdC5wYXRjaEZsYWcgPiAwICYmIHNpbmdsZVJvb3QucGF0Y2hGbGFnICYgMjA0OCkgew0KICAgICAgICAgICAgICByZXR1cm4gZmlsdGVyU2luZ2xlUm9vdChzaW5nbGVSb290LmNoaWxkcmVuKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHNpbmdsZVJvb3Q7DQogIH0NCiAgY29uc3QgZ2V0RnVuY3Rpb25hbEZhbGx0aHJvdWdoID0gKGF0dHJzKSA9PiB7DQogICAgbGV0IHJlczsNCiAgICBmb3IgKGNvbnN0IGtleSBpbiBhdHRycykgew0KICAgICAgaWYgKGtleSA9PT0gImNsYXNzIiB8fCBrZXkgPT09ICJzdHlsZSIgfHwgaXNPbihrZXkpKSB7DQogICAgICAgIChyZXMgfHwgKHJlcyA9IHt9KSlba2V5XSA9IGF0dHJzW2tleV07DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiByZXM7DQogIH07DQogIGNvbnN0IGZpbHRlck1vZGVsTGlzdGVuZXJzID0gKGF0dHJzLCBwcm9wcykgPT4gew0KICAgIGNvbnN0IHJlcyA9IHt9Ow0KICAgIGZvciAoY29uc3Qga2V5IGluIGF0dHJzKSB7DQogICAgICBpZiAoIWlzTW9kZWxMaXN0ZW5lcihrZXkpIHx8ICEoa2V5LnNsaWNlKDkpIGluIHByb3BzKSkgew0KICAgICAgICByZXNba2V5XSA9IGF0dHJzW2tleV07DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiByZXM7DQogIH07DQogIGNvbnN0IGlzRWxlbWVudFJvb3QgPSAodm5vZGUpID0+IHsNCiAgICByZXR1cm4gdm5vZGUuc2hhcGVGbGFnICYgKDYgfCAxKSB8fCB2bm9kZS50eXBlID09PSBDb21tZW50Ow0KICB9Ow0KICBmdW5jdGlvbiBzaG91bGRVcGRhdGVDb21wb25lbnQocHJldlZOb2RlLCBuZXh0Vk5vZGUsIG9wdGltaXplZCkgew0KICAgIGNvbnN0IHsgcHJvcHM6IHByZXZQcm9wcywgY2hpbGRyZW46IHByZXZDaGlsZHJlbiwgY29tcG9uZW50IH0gPSBwcmV2Vk5vZGU7DQogICAgY29uc3QgeyBwcm9wczogbmV4dFByb3BzLCBjaGlsZHJlbjogbmV4dENoaWxkcmVuLCBwYXRjaEZsYWcgfSA9IG5leHRWTm9kZTsNCiAgICBjb25zdCBlbWl0cyA9IGNvbXBvbmVudC5lbWl0c09wdGlvbnM7DQogICAgaWYgKChwcmV2Q2hpbGRyZW4gfHwgbmV4dENoaWxkcmVuKSAmJiBpc0htclVwZGF0aW5nKSB7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogICAgaWYgKG5leHRWTm9kZS5kaXJzIHx8IG5leHRWTm9kZS50cmFuc2l0aW9uKSB7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogICAgaWYgKG9wdGltaXplZCAmJiBwYXRjaEZsYWcgPj0gMCkgew0KICAgICAgaWYgKHBhdGNoRmxhZyAmIDEwMjQpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgICBpZiAocGF0Y2hGbGFnICYgMTYpIHsNCiAgICAgICAgaWYgKCFwcmV2UHJvcHMpIHsNCiAgICAgICAgICByZXR1cm4gISFuZXh0UHJvcHM7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGhhc1Byb3BzQ2hhbmdlZChwcmV2UHJvcHMsIG5leHRQcm9wcywgZW1pdHMpOw0KICAgICAgfSBlbHNlIGlmIChwYXRjaEZsYWcgJiA4KSB7DQogICAgICAgIGNvbnN0IGR5bmFtaWNQcm9wcyA9IG5leHRWTm9kZS5keW5hbWljUHJvcHM7DQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZHluYW1pY1Byb3BzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgY29uc3Qga2V5ID0gZHluYW1pY1Byb3BzW2ldOw0KICAgICAgICAgIGlmIChuZXh0UHJvcHNba2V5XSAhPT0gcHJldlByb3BzW2tleV0gJiYgIWlzRW1pdExpc3RlbmVyKGVtaXRzLCBrZXkpKSB7DQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9IGVsc2Ugew0KICAgICAgaWYgKHByZXZDaGlsZHJlbiB8fCBuZXh0Q2hpbGRyZW4pIHsNCiAgICAgICAgaWYgKCFuZXh0Q2hpbGRyZW4gfHwgIW5leHRDaGlsZHJlbi4kc3RhYmxlKSB7DQogICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmIChwcmV2UHJvcHMgPT09IG5leHRQcm9wcykgew0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICB9DQogICAgICBpZiAoIXByZXZQcm9wcykgew0KICAgICAgICByZXR1cm4gISFuZXh0UHJvcHM7DQogICAgICB9DQogICAgICBpZiAoIW5leHRQcm9wcykgew0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBoYXNQcm9wc0NoYW5nZWQocHJldlByb3BzLCBuZXh0UHJvcHMsIGVtaXRzKTsNCiAgICB9DQogICAgcmV0dXJuIGZhbHNlOw0KICB9DQogIGZ1bmN0aW9uIGhhc1Byb3BzQ2hhbmdlZChwcmV2UHJvcHMsIG5leHRQcm9wcywgZW1pdHNPcHRpb25zKSB7DQogICAgY29uc3QgbmV4dEtleXMgPSBPYmplY3Qua2V5cyhuZXh0UHJvcHMpOw0KICAgIGlmIChuZXh0S2V5cy5sZW5ndGggIT09IE9iamVjdC5rZXlzKHByZXZQcm9wcykubGVuZ3RoKSB7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuZXh0S2V5cy5sZW5ndGg7IGkrKykgew0KICAgICAgY29uc3Qga2V5ID0gbmV4dEtleXNbaV07DQogICAgICBpZiAobmV4dFByb3BzW2tleV0gIT09IHByZXZQcm9wc1trZXldICYmICFpc0VtaXRMaXN0ZW5lcihlbWl0c09wdGlvbnMsIGtleSkpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiBmYWxzZTsNCiAgfQ0KICBmdW5jdGlvbiB1cGRhdGVIT0NIb3N0RWwoeyB2bm9kZSwgcGFyZW50IH0sIGVsKSB7DQogICAgd2hpbGUgKHBhcmVudCkgew0KICAgICAgY29uc3Qgcm9vdCA9IHBhcmVudC5zdWJUcmVlOw0KICAgICAgaWYgKHJvb3Quc3VzcGVuc2UgJiYgcm9vdC5zdXNwZW5zZS5hY3RpdmVCcmFuY2ggPT09IHZub2RlKSB7DQogICAgICAgIHJvb3QuZWwgPSB2bm9kZS5lbDsNCiAgICAgIH0NCiAgICAgIGlmIChyb290ID09PSB2bm9kZSkgew0KICAgICAgICAodm5vZGUgPSBwYXJlbnQudm5vZGUpLmVsID0gZWw7DQogICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBicmVhazsNCiAgICAgIH0NCiAgICB9DQogIH0NCg0KICBjb25zdCBpc1N1c3BlbnNlID0gKHR5cGUpID0+IHR5cGUuX19pc1N1c3BlbnNlOw0KICBsZXQgc3VzcGVuc2VJZCA9IDA7DQogIGNvbnN0IFN1c3BlbnNlSW1wbCA9IHsNCiAgICBuYW1lOiAiU3VzcGVuc2UiLA0KICAgIC8vIEluIG9yZGVyIHRvIG1ha2UgU3VzcGVuc2UgdHJlZS1zaGFrYWJsZSwgd2UgbmVlZCB0byBhdm9pZCBpbXBvcnRpbmcgaXQNCiAgICAvLyBkaXJlY3RseSBpbiB0aGUgcmVuZGVyZXIuIFRoZSByZW5kZXJlciBjaGVja3MgZm9yIHRoZSBfX2lzU3VzcGVuc2UgZmxhZw0KICAgIC8vIG9uIGEgdm5vZGUncyB0eXBlIGFuZCBjYWxscyB0aGUgYHByb2Nlc3NgIG1ldGhvZCwgcGFzc2luZyBpbiByZW5kZXJlcg0KICAgIC8vIGludGVybmFscy4NCiAgICBfX2lzU3VzcGVuc2U6IHRydWUsDQogICAgcHJvY2VzcyhuMSwgbjIsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBuYW1lc3BhY2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCByZW5kZXJlckludGVybmFscykgew0KICAgICAgaWYgKG4xID09IG51bGwpIHsNCiAgICAgICAgbW91bnRTdXNwZW5zZSgNCiAgICAgICAgICBuMiwNCiAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgYW5jaG9yLA0KICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgIG9wdGltaXplZCwNCiAgICAgICAgICByZW5kZXJlckludGVybmFscw0KICAgICAgICApOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgaWYgKHBhcmVudFN1c3BlbnNlICYmIHBhcmVudFN1c3BlbnNlLmRlcHMgPiAwICYmICFuMS5zdXNwZW5zZS5pc0luRmFsbGJhY2spIHsNCiAgICAgICAgICBuMi5zdXNwZW5zZSA9IG4xLnN1c3BlbnNlOw0KICAgICAgICAgIG4yLnN1c3BlbnNlLnZub2RlID0gbjI7DQogICAgICAgICAgbjIuZWwgPSBuMS5lbDsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgcGF0Y2hTdXNwZW5zZSgNCiAgICAgICAgICBuMSwNCiAgICAgICAgICBuMiwNCiAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgYW5jaG9yLA0KICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgIG9wdGltaXplZCwNCiAgICAgICAgICByZW5kZXJlckludGVybmFscw0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH0sDQogICAgaHlkcmF0ZTogaHlkcmF0ZVN1c3BlbnNlLA0KICAgIG5vcm1hbGl6ZTogbm9ybWFsaXplU3VzcGVuc2VDaGlsZHJlbg0KICB9Ow0KICBjb25zdCBTdXNwZW5zZSA9IFN1c3BlbnNlSW1wbCA7DQogIGZ1bmN0aW9uIHRyaWdnZXJFdmVudCh2bm9kZSwgbmFtZSkgew0KICAgIGNvbnN0IGV2ZW50TGlzdGVuZXIgPSB2bm9kZS5wcm9wcyAmJiB2bm9kZS5wcm9wc1tuYW1lXTsNCiAgICBpZiAoaXNGdW5jdGlvbihldmVudExpc3RlbmVyKSkgew0KICAgICAgZXZlbnRMaXN0ZW5lcigpOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlKHZub2RlLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCwgcmVuZGVyZXJJbnRlcm5hbHMpIHsNCiAgICBjb25zdCB7DQogICAgICBwOiBwYXRjaCwNCiAgICAgIG86IHsgY3JlYXRlRWxlbWVudCB9DQogICAgfSA9IHJlbmRlcmVySW50ZXJuYWxzOw0KICAgIGNvbnN0IGhpZGRlbkNvbnRhaW5lciA9IGNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIGNvbnN0IHN1c3BlbnNlID0gdm5vZGUuc3VzcGVuc2UgPSBjcmVhdGVTdXNwZW5zZUJvdW5kYXJ5KA0KICAgICAgdm5vZGUsDQogICAgICBwYXJlbnRTdXNwZW5zZSwNCiAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgIGNvbnRhaW5lciwNCiAgICAgIGhpZGRlbkNvbnRhaW5lciwNCiAgICAgIGFuY2hvciwNCiAgICAgIG5hbWVzcGFjZSwNCiAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgIG9wdGltaXplZCwNCiAgICAgIHJlbmRlcmVySW50ZXJuYWxzDQogICAgKTsNCiAgICBwYXRjaCgNCiAgICAgIG51bGwsDQogICAgICBzdXNwZW5zZS5wZW5kaW5nQnJhbmNoID0gdm5vZGUuc3NDb250ZW50LA0KICAgICAgaGlkZGVuQ29udGFpbmVyLA0KICAgICAgbnVsbCwNCiAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgIHN1c3BlbnNlLA0KICAgICAgbmFtZXNwYWNlLA0KICAgICAgc2xvdFNjb3BlSWRzDQogICAgKTsNCiAgICBpZiAoc3VzcGVuc2UuZGVwcyA+IDApIHsNCiAgICAgIHRyaWdnZXJFdmVudCh2bm9kZSwgIm9uUGVuZGluZyIpOw0KICAgICAgdHJpZ2dlckV2ZW50KHZub2RlLCAib25GYWxsYmFjayIpOw0KICAgICAgcGF0Y2goDQogICAgICAgIG51bGwsDQogICAgICAgIHZub2RlLnNzRmFsbGJhY2ssDQogICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgYW5jaG9yLA0KICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgIG51bGwsDQogICAgICAgIC8vIGZhbGxiYWNrIHRyZWUgd2lsbCBub3QgaGF2ZSBzdXNwZW5zZSBjb250ZXh0DQogICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgc2xvdFNjb3BlSWRzDQogICAgICApOw0KICAgICAgc2V0QWN0aXZlQnJhbmNoKHN1c3BlbnNlLCB2bm9kZS5zc0ZhbGxiYWNrKTsNCiAgICB9IGVsc2Ugew0KICAgICAgc3VzcGVuc2UucmVzb2x2ZShmYWxzZSwgdHJ1ZSk7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIHBhdGNoU3VzcGVuc2UobjEsIG4yLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBuYW1lc3BhY2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCB7IHA6IHBhdGNoLCB1bTogdW5tb3VudCwgbzogeyBjcmVhdGVFbGVtZW50IH0gfSkgew0KICAgIGNvbnN0IHN1c3BlbnNlID0gbjIuc3VzcGVuc2UgPSBuMS5zdXNwZW5zZTsNCiAgICBzdXNwZW5zZS52bm9kZSA9IG4yOw0KICAgIG4yLmVsID0gbjEuZWw7DQogICAgY29uc3QgbmV3QnJhbmNoID0gbjIuc3NDb250ZW50Ow0KICAgIGNvbnN0IG5ld0ZhbGxiYWNrID0gbjIuc3NGYWxsYmFjazsNCiAgICBjb25zdCB7IGFjdGl2ZUJyYW5jaCwgcGVuZGluZ0JyYW5jaCwgaXNJbkZhbGxiYWNrLCBpc0h5ZHJhdGluZyB9ID0gc3VzcGVuc2U7DQogICAgaWYgKHBlbmRpbmdCcmFuY2gpIHsNCiAgICAgIHN1c3BlbnNlLnBlbmRpbmdCcmFuY2ggPSBuZXdCcmFuY2g7DQogICAgICBpZiAoaXNTYW1lVk5vZGVUeXBlKG5ld0JyYW5jaCwgcGVuZGluZ0JyYW5jaCkpIHsNCiAgICAgICAgcGF0Y2goDQogICAgICAgICAgcGVuZGluZ0JyYW5jaCwNCiAgICAgICAgICBuZXdCcmFuY2gsDQogICAgICAgICAgc3VzcGVuc2UuaGlkZGVuQ29udGFpbmVyLA0KICAgICAgICAgIG51bGwsDQogICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgIHN1c3BlbnNlLA0KICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICBzbG90U2NvcGVJZHMsDQogICAgICAgICAgb3B0aW1pemVkDQogICAgICAgICk7DQogICAgICAgIGlmIChzdXNwZW5zZS5kZXBzIDw9IDApIHsNCiAgICAgICAgICBzdXNwZW5zZS5yZXNvbHZlKCk7DQogICAgICAgIH0gZWxzZSBpZiAoaXNJbkZhbGxiYWNrKSB7DQogICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZykgew0KICAgICAgICAgICAgcGF0Y2goDQogICAgICAgICAgICAgIGFjdGl2ZUJyYW5jaCwNCiAgICAgICAgICAgICAgbmV3RmFsbGJhY2ssDQogICAgICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICAgICAgYW5jaG9yLA0KICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICAgIG51bGwsDQogICAgICAgICAgICAgIC8vIGZhbGxiYWNrIHRyZWUgd2lsbCBub3QgaGF2ZSBzdXNwZW5zZSBjb250ZXh0DQogICAgICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgICAgICBvcHRpbWl6ZWQNCiAgICAgICAgICAgICk7DQogICAgICAgICAgICBzZXRBY3RpdmVCcmFuY2goc3VzcGVuc2UsIG5ld0ZhbGxiYWNrKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHN1c3BlbnNlLnBlbmRpbmdJZCA9IHN1c3BlbnNlSWQrKzsNCiAgICAgICAgaWYgKGlzSHlkcmF0aW5nKSB7DQogICAgICAgICAgc3VzcGVuc2UuaXNIeWRyYXRpbmcgPSBmYWxzZTsNCiAgICAgICAgICBzdXNwZW5zZS5hY3RpdmVCcmFuY2ggPSBwZW5kaW5nQnJhbmNoOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHVubW91bnQocGVuZGluZ0JyYW5jaCwgcGFyZW50Q29tcG9uZW50LCBzdXNwZW5zZSk7DQogICAgICAgIH0NCiAgICAgICAgc3VzcGVuc2UuZGVwcyA9IDA7DQogICAgICAgIHN1c3BlbnNlLmVmZmVjdHMubGVuZ3RoID0gMDsNCiAgICAgICAgc3VzcGVuc2UuaGlkZGVuQ29udGFpbmVyID0gY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgICAgIGlmIChpc0luRmFsbGJhY2spIHsNCiAgICAgICAgICBwYXRjaCgNCiAgICAgICAgICAgIG51bGwsDQogICAgICAgICAgICBuZXdCcmFuY2gsDQogICAgICAgICAgICBzdXNwZW5zZS5oaWRkZW5Db250YWluZXIsDQogICAgICAgICAgICBudWxsLA0KICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgICAgc3VzcGVuc2UsDQogICAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgICBzbG90U2NvcGVJZHMsDQogICAgICAgICAgICBvcHRpbWl6ZWQNCiAgICAgICAgICApOw0KICAgICAgICAgIGlmIChzdXNwZW5zZS5kZXBzIDw9IDApIHsNCiAgICAgICAgICAgIHN1c3BlbnNlLnJlc29sdmUoKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgcGF0Y2goDQogICAgICAgICAgICAgIGFjdGl2ZUJyYW5jaCwNCiAgICAgICAgICAgICAgbmV3RmFsbGJhY2ssDQogICAgICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICAgICAgYW5jaG9yLA0KICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICAgIG51bGwsDQogICAgICAgICAgICAgIC8vIGZhbGxiYWNrIHRyZWUgd2lsbCBub3QgaGF2ZSBzdXNwZW5zZSBjb250ZXh0DQogICAgICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgICAgICBvcHRpbWl6ZWQNCiAgICAgICAgICAgICk7DQogICAgICAgICAgICBzZXRBY3RpdmVCcmFuY2goc3VzcGVuc2UsIG5ld0ZhbGxiYWNrKTsNCiAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSBpZiAoYWN0aXZlQnJhbmNoICYmIGlzU2FtZVZOb2RlVHlwZShuZXdCcmFuY2gsIGFjdGl2ZUJyYW5jaCkpIHsNCiAgICAgICAgICBwYXRjaCgNCiAgICAgICAgICAgIGFjdGl2ZUJyYW5jaCwNCiAgICAgICAgICAgIG5ld0JyYW5jaCwNCiAgICAgICAgICAgIGNvbnRhaW5lciwNCiAgICAgICAgICAgIGFuY2hvciwNCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICAgIHN1c3BlbnNlLA0KICAgICAgICAgICAgbmFtZXNwYWNlLA0KICAgICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgICAgb3B0aW1pemVkDQogICAgICAgICAgKTsNCiAgICAgICAgICBzdXNwZW5zZS5yZXNvbHZlKHRydWUpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHBhdGNoKA0KICAgICAgICAgICAgbnVsbCwNCiAgICAgICAgICAgIG5ld0JyYW5jaCwNCiAgICAgICAgICAgIHN1c3BlbnNlLmhpZGRlbkNvbnRhaW5lciwNCiAgICAgICAgICAgIG51bGwsDQogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICAgICAgICBzdXNwZW5zZSwNCiAgICAgICAgICAgIG5hbWVzcGFjZSwNCiAgICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICAgICk7DQogICAgICAgICAgaWYgKHN1c3BlbnNlLmRlcHMgPD0gMCkgew0KICAgICAgICAgICAgc3VzcGVuc2UucmVzb2x2ZSgpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICBpZiAoYWN0aXZlQnJhbmNoICYmIGlzU2FtZVZOb2RlVHlwZShuZXdCcmFuY2gsIGFjdGl2ZUJyYW5jaCkpIHsNCiAgICAgICAgcGF0Y2goDQogICAgICAgICAgYWN0aXZlQnJhbmNoLA0KICAgICAgICAgIG5ld0JyYW5jaCwNCiAgICAgICAgICBjb250YWluZXIsDQogICAgICAgICAgYW5jaG9yLA0KICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICBzdXNwZW5zZSwNCiAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICApOw0KICAgICAgICBzZXRBY3RpdmVCcmFuY2goc3VzcGVuc2UsIG5ld0JyYW5jaCk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0cmlnZ2VyRXZlbnQobjIsICJvblBlbmRpbmciKTsNCiAgICAgICAgc3VzcGVuc2UucGVuZGluZ0JyYW5jaCA9IG5ld0JyYW5jaDsNCiAgICAgICAgaWYgKG5ld0JyYW5jaC5zaGFwZUZsYWcgJiA1MTIpIHsNCiAgICAgICAgICBzdXNwZW5zZS5wZW5kaW5nSWQgPSBuZXdCcmFuY2guY29tcG9uZW50LnN1c3BlbnNlSWQ7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgc3VzcGVuc2UucGVuZGluZ0lkID0gc3VzcGVuc2VJZCsrOw0KICAgICAgICB9DQogICAgICAgIHBhdGNoKA0KICAgICAgICAgIG51bGwsDQogICAgICAgICAgbmV3QnJhbmNoLA0KICAgICAgICAgIHN1c3BlbnNlLmhpZGRlbkNvbnRhaW5lciwNCiAgICAgICAgICBudWxsLA0KICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICBzdXNwZW5zZSwNCiAgICAgICAgICBuYW1lc3BhY2UsDQogICAgICAgICAgc2xvdFNjb3BlSWRzLA0KICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICApOw0KICAgICAgICBpZiAoc3VzcGVuc2UuZGVwcyA8PSAwKSB7DQogICAgICAgICAgc3VzcGVuc2UucmVzb2x2ZSgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGNvbnN0IHsgdGltZW91dCwgcGVuZGluZ0lkIH0gPSBzdXNwZW5zZTsNCiAgICAgICAgICBpZiAodGltZW91dCA+IDApIHsNCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gew0KICAgICAgICAgICAgICBpZiAoc3VzcGVuc2UucGVuZGluZ0lkID09PSBwZW5kaW5nSWQpIHsNCiAgICAgICAgICAgICAgICBzdXNwZW5zZS5mYWxsYmFjayhuZXdGYWxsYmFjayk7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sIHRpbWVvdXQpOw0KICAgICAgICAgIH0gZWxzZSBpZiAodGltZW91dCA9PT0gMCkgew0KICAgICAgICAgICAgc3VzcGVuc2UuZmFsbGJhY2sobmV3RmFsbGJhY2spOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgfQ0KICBsZXQgaGFzV2FybmVkID0gZmFsc2U7DQogIGZ1bmN0aW9uIGNyZWF0ZVN1c3BlbnNlQm91bmRhcnkodm5vZGUsIHBhcmVudFN1c3BlbnNlLCBwYXJlbnRDb21wb25lbnQsIGNvbnRhaW5lciwgaGlkZGVuQ29udGFpbmVyLCBhbmNob3IsIG5hbWVzcGFjZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQsIHJlbmRlcmVySW50ZXJuYWxzLCBpc0h5ZHJhdGluZyA9IGZhbHNlKSB7DQogICAgaWYgKCFoYXNXYXJuZWQpIHsNCiAgICAgIGhhc1dhcm5lZCA9IHRydWU7DQogICAgICBjb25zb2xlW2NvbnNvbGUuaW5mbyA/ICJpbmZvIiA6ICJsb2ciXSgNCiAgICAgICAgYDxTdXNwZW5zZT4gaXMgYW4gZXhwZXJpbWVudGFsIGZlYXR1cmUgYW5kIGl0cyBBUEkgd2lsbCBsaWtlbHkgY2hhbmdlLmANCiAgICAgICk7DQogICAgfQ0KICAgIGNvbnN0IHsNCiAgICAgIHA6IHBhdGNoLA0KICAgICAgbTogbW92ZSwNCiAgICAgIHVtOiB1bm1vdW50LA0KICAgICAgbjogbmV4dCwNCiAgICAgIG86IHsgcGFyZW50Tm9kZSwgcmVtb3ZlIH0NCiAgICB9ID0gcmVuZGVyZXJJbnRlcm5hbHM7DQogICAgbGV0IHBhcmVudFN1c3BlbnNlSWQ7DQogICAgY29uc3QgaXNTdXNwZW5zaWJsZSA9IGlzVk5vZGVTdXNwZW5zaWJsZSh2bm9kZSk7DQogICAgaWYgKGlzU3VzcGVuc2libGUpIHsNCiAgICAgIGlmIChwYXJlbnRTdXNwZW5zZSAmJiBwYXJlbnRTdXNwZW5zZS5wZW5kaW5nQnJhbmNoKSB7DQogICAgICAgIHBhcmVudFN1c3BlbnNlSWQgPSBwYXJlbnRTdXNwZW5zZS5wZW5kaW5nSWQ7DQogICAgICAgIHBhcmVudFN1c3BlbnNlLmRlcHMrKzsNCiAgICAgIH0NCiAgICB9DQogICAgY29uc3QgdGltZW91dCA9IHZub2RlLnByb3BzID8gdG9OdW1iZXIodm5vZGUucHJvcHMudGltZW91dCkgOiB2b2lkIDA7DQogICAgew0KICAgICAgYXNzZXJ0TnVtYmVyKHRpbWVvdXQsIGBTdXNwZW5zZSB0aW1lb3V0YCk7DQogICAgfQ0KICAgIGNvbnN0IGluaXRpYWxBbmNob3IgPSBhbmNob3I7DQogICAgY29uc3Qgc3VzcGVuc2UgPSB7DQogICAgICB2bm9kZSwNCiAgICAgIHBhcmVudDogcGFyZW50U3VzcGVuc2UsDQogICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICBuYW1lc3BhY2UsDQogICAgICBjb250YWluZXIsDQogICAgICBoaWRkZW5Db250YWluZXIsDQogICAgICBkZXBzOiAwLA0KICAgICAgcGVuZGluZ0lkOiBzdXNwZW5zZUlkKyssDQogICAgICB0aW1lb3V0OiB0eXBlb2YgdGltZW91dCA9PT0gIm51bWJlciIgPyB0aW1lb3V0IDogLTEsDQogICAgICBhY3RpdmVCcmFuY2g6IG51bGwsDQogICAgICBwZW5kaW5nQnJhbmNoOiBudWxsLA0KICAgICAgaXNJbkZhbGxiYWNrOiAhaXNIeWRyYXRpbmcsDQogICAgICBpc0h5ZHJhdGluZywNCiAgICAgIGlzVW5tb3VudGVkOiBmYWxzZSwNCiAgICAgIGVmZmVjdHM6IFtdLA0KICAgICAgcmVzb2x2ZShyZXN1bWUgPSBmYWxzZSwgc3luYyA9IGZhbHNlKSB7DQogICAgICAgIHsNCiAgICAgICAgICBpZiAoIXJlc3VtZSAmJiAhc3VzcGVuc2UucGVuZGluZ0JyYW5jaCkgew0KICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKA0KICAgICAgICAgICAgICBgc3VzcGVuc2UucmVzb2x2ZSgpIGlzIGNhbGxlZCB3aXRob3V0IGEgcGVuZGluZyBicmFuY2guYA0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKHN1c3BlbnNlLmlzVW5tb3VudGVkKSB7DQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoDQogICAgICAgICAgICAgIGBzdXNwZW5zZS5yZXNvbHZlKCkgaXMgY2FsbGVkIG9uIGFuIGFscmVhZHkgdW5tb3VudGVkIHN1c3BlbnNlIGJvdW5kYXJ5LmANCiAgICAgICAgICAgICk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGNvbnN0IHsNCiAgICAgICAgICB2bm9kZTogdm5vZGUyLA0KICAgICAgICAgIGFjdGl2ZUJyYW5jaCwNCiAgICAgICAgICBwZW5kaW5nQnJhbmNoLA0KICAgICAgICAgIHBlbmRpbmdJZCwNCiAgICAgICAgICBlZmZlY3RzLA0KICAgICAgICAgIHBhcmVudENvbXBvbmVudDogcGFyZW50Q29tcG9uZW50MiwNCiAgICAgICAgICBjb250YWluZXI6IGNvbnRhaW5lcjINCiAgICAgICAgfSA9IHN1c3BlbnNlOw0KICAgICAgICBsZXQgZGVsYXlFbnRlciA9IGZhbHNlOw0KICAgICAgICBpZiAoc3VzcGVuc2UuaXNIeWRyYXRpbmcpIHsNCiAgICAgICAgICBzdXNwZW5zZS5pc0h5ZHJhdGluZyA9IGZhbHNlOw0KICAgICAgICB9IGVsc2UgaWYgKCFyZXN1bWUpIHsNCiAgICAgICAgICBkZWxheUVudGVyID0gYWN0aXZlQnJhbmNoICYmIHBlbmRpbmdCcmFuY2gudHJhbnNpdGlvbiAmJiBwZW5kaW5nQnJhbmNoLnRyYW5zaXRpb24ubW9kZSA9PT0gIm91dC1pbiI7DQogICAgICAgICAgaWYgKGRlbGF5RW50ZXIpIHsNCiAgICAgICAgICAgIGFjdGl2ZUJyYW5jaC50cmFuc2l0aW9uLmFmdGVyTGVhdmUgPSAoKSA9PiB7DQogICAgICAgICAgICAgIGlmIChwZW5kaW5nSWQgPT09IHN1c3BlbnNlLnBlbmRpbmdJZCkgew0KICAgICAgICAgICAgICAgIG1vdmUoDQogICAgICAgICAgICAgICAgICBwZW5kaW5nQnJhbmNoLA0KICAgICAgICAgICAgICAgICAgY29udGFpbmVyMiwNCiAgICAgICAgICAgICAgICAgIGFuY2hvciA9PT0gaW5pdGlhbEFuY2hvciA/IG5leHQoYWN0aXZlQnJhbmNoKSA6IGFuY2hvciwNCiAgICAgICAgICAgICAgICAgIDANCiAgICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgICAgIHF1ZXVlUG9zdEZsdXNoQ2IoZWZmZWN0cyk7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH07DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmIChhY3RpdmVCcmFuY2gpIHsNCiAgICAgICAgICAgIGlmIChwYXJlbnROb2RlKGFjdGl2ZUJyYW5jaC5lbCkgPT09IGNvbnRhaW5lcjIpIHsNCiAgICAgICAgICAgICAgYW5jaG9yID0gbmV4dChhY3RpdmVCcmFuY2gpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdW5tb3VudChhY3RpdmVCcmFuY2gsIHBhcmVudENvbXBvbmVudDIsIHN1c3BlbnNlLCB0cnVlKTsNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKCFkZWxheUVudGVyKSB7DQogICAgICAgICAgICBtb3ZlKHBlbmRpbmdCcmFuY2gsIGNvbnRhaW5lcjIsIGFuY2hvciwgMCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHNldEFjdGl2ZUJyYW5jaChzdXNwZW5zZSwgcGVuZGluZ0JyYW5jaCk7DQogICAgICAgIHN1c3BlbnNlLnBlbmRpbmdCcmFuY2ggPSBudWxsOw0KICAgICAgICBzdXNwZW5zZS5pc0luRmFsbGJhY2sgPSBmYWxzZTsNCiAgICAgICAgbGV0IHBhcmVudCA9IHN1c3BlbnNlLnBhcmVudDsNCiAgICAgICAgbGV0IGhhc1VucmVzb2x2ZWRBbmNlc3RvciA9IGZhbHNlOw0KICAgICAgICB3aGlsZSAocGFyZW50KSB7DQogICAgICAgICAgaWYgKHBhcmVudC5wZW5kaW5nQnJhbmNoKSB7DQogICAgICAgICAgICBwYXJlbnQuZWZmZWN0cy5wdXNoKC4uLmVmZmVjdHMpOw0KICAgICAgICAgICAgaGFzVW5yZXNvbHZlZEFuY2VzdG9yID0gdHJ1ZTsNCiAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgIH0NCiAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50Ow0KICAgICAgICB9DQogICAgICAgIGlmICghaGFzVW5yZXNvbHZlZEFuY2VzdG9yICYmICFkZWxheUVudGVyKSB7DQogICAgICAgICAgcXVldWVQb3N0Rmx1c2hDYihlZmZlY3RzKTsNCiAgICAgICAgfQ0KICAgICAgICBzdXNwZW5zZS5lZmZlY3RzID0gW107DQogICAgICAgIGlmIChpc1N1c3BlbnNpYmxlKSB7DQogICAgICAgICAgaWYgKHBhcmVudFN1c3BlbnNlICYmIHBhcmVudFN1c3BlbnNlLnBlbmRpbmdCcmFuY2ggJiYgcGFyZW50U3VzcGVuc2VJZCA9PT0gcGFyZW50U3VzcGVuc2UucGVuZGluZ0lkKSB7DQogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZS5kZXBzLS07DQogICAgICAgICAgICBpZiAocGFyZW50U3VzcGVuc2UuZGVwcyA9PT0gMCAmJiAhc3luYykgew0KICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZS5yZXNvbHZlKCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHRyaWdnZXJFdmVudCh2bm9kZTIsICJvblJlc29sdmUiKTsNCiAgICAgIH0sDQogICAgICBmYWxsYmFjayhmYWxsYmFja1ZOb2RlKSB7DQogICAgICAgIGlmICghc3VzcGVuc2UucGVuZGluZ0JyYW5jaCkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICBjb25zdCB7IHZub2RlOiB2bm9kZTIsIGFjdGl2ZUJyYW5jaCwgcGFyZW50Q29tcG9uZW50OiBwYXJlbnRDb21wb25lbnQyLCBjb250YWluZXI6IGNvbnRhaW5lcjIsIG5hbWVzcGFjZTogbmFtZXNwYWNlMiB9ID0gc3VzcGVuc2U7DQogICAgICAgIHRyaWdnZXJFdmVudCh2bm9kZTIsICJvbkZhbGxiYWNrIik7DQogICAgICAgIGNvbnN0IGFuY2hvcjIgPSBuZXh0KGFjdGl2ZUJyYW5jaCk7DQogICAgICAgIGNvbnN0IG1vdW50RmFsbGJhY2sgPSAoKSA9PiB7DQogICAgICAgICAgaWYgKCFzdXNwZW5zZS5pc0luRmFsbGJhY2spIHsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICB9DQogICAgICAgICAgcGF0Y2goDQogICAgICAgICAgICBudWxsLA0KICAgICAgICAgICAgZmFsbGJhY2tWTm9kZSwNCiAgICAgICAgICAgIGNvbnRhaW5lcjIsDQogICAgICAgICAgICBhbmNob3IyLA0KICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50MiwNCiAgICAgICAgICAgIG51bGwsDQogICAgICAgICAgICAvLyBmYWxsYmFjayB0cmVlIHdpbGwgbm90IGhhdmUgc3VzcGVuc2UgY29udGV4dA0KICAgICAgICAgICAgbmFtZXNwYWNlMiwNCiAgICAgICAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgICAgICAgIG9wdGltaXplZA0KICAgICAgICAgICk7DQogICAgICAgICAgc2V0QWN0aXZlQnJhbmNoKHN1c3BlbnNlLCBmYWxsYmFja1ZOb2RlKTsNCiAgICAgICAgfTsNCiAgICAgICAgY29uc3QgZGVsYXlFbnRlciA9IGZhbGxiYWNrVk5vZGUudHJhbnNpdGlvbiAmJiBmYWxsYmFja1ZOb2RlLnRyYW5zaXRpb24ubW9kZSA9PT0gIm91dC1pbiI7DQogICAgICAgIGlmIChkZWxheUVudGVyKSB7DQogICAgICAgICAgYWN0aXZlQnJhbmNoLnRyYW5zaXRpb24uYWZ0ZXJMZWF2ZSA9IG1vdW50RmFsbGJhY2s7DQogICAgICAgIH0NCiAgICAgICAgc3VzcGVuc2UuaXNJbkZhbGxiYWNrID0gdHJ1ZTsNCiAgICAgICAgdW5tb3VudCgNCiAgICAgICAgICBhY3RpdmVCcmFuY2gsDQogICAgICAgICAgcGFyZW50Q29tcG9uZW50MiwNCiAgICAgICAgICBudWxsLA0KICAgICAgICAgIC8vIG5vIHN1c3BlbnNlIHNvIHVubW91bnQgaG9va3MgZmlyZSBub3cNCiAgICAgICAgICB0cnVlDQogICAgICAgICAgLy8gc2hvdWxkUmVtb3ZlDQogICAgICAgICk7DQogICAgICAgIGlmICghZGVsYXlFbnRlcikgew0KICAgICAgICAgIG1vdW50RmFsbGJhY2soKTsNCiAgICAgICAgfQ0KICAgICAgfSwNCiAgICAgIG1vdmUoY29udGFpbmVyMiwgYW5jaG9yMiwgdHlwZSkgew0KICAgICAgICBzdXNwZW5zZS5hY3RpdmVCcmFuY2ggJiYgbW92ZShzdXNwZW5zZS5hY3RpdmVCcmFuY2gsIGNvbnRhaW5lcjIsIGFuY2hvcjIsIHR5cGUpOw0KICAgICAgICBzdXNwZW5zZS5jb250YWluZXIgPSBjb250YWluZXIyOw0KICAgICAgfSwNCiAgICAgIG5leHQoKSB7DQogICAgICAgIHJldHVybiBzdXNwZW5zZS5hY3RpdmVCcmFuY2ggJiYgbmV4dChzdXNwZW5zZS5hY3RpdmVCcmFuY2gpOw0KICAgICAgfSwNCiAgICAgIHJlZ2lzdGVyRGVwKGluc3RhbmNlLCBzZXR1cFJlbmRlckVmZmVjdCwgb3B0aW1pemVkMikgew0KICAgICAgICBjb25zdCBpc0luUGVuZGluZ1N1c3BlbnNlID0gISFzdXNwZW5zZS5wZW5kaW5nQnJhbmNoOw0KICAgICAgICBpZiAoaXNJblBlbmRpbmdTdXNwZW5zZSkgew0KICAgICAgICAgIHN1c3BlbnNlLmRlcHMrKzsNCiAgICAgICAgfQ0KICAgICAgICBjb25zdCBoeWRyYXRlZEVsID0gaW5zdGFuY2Uudm5vZGUuZWw7DQogICAgICAgIGluc3RhbmNlLmFzeW5jRGVwLmNhdGNoKChlcnIpID0+IHsNCiAgICAgICAgICBoYW5kbGVFcnJvcihlcnIsIGluc3RhbmNlLCAwKTsNCiAgICAgICAgfSkudGhlbigoYXN5bmNTZXR1cFJlc3VsdCkgPT4gew0KICAgICAgICAgIGlmIChpbnN0YW5jZS5pc1VubW91bnRlZCB8fCBzdXNwZW5zZS5pc1VubW91bnRlZCB8fCBzdXNwZW5zZS5wZW5kaW5nSWQgIT09IGluc3RhbmNlLnN1c3BlbnNlSWQpIHsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICB9DQogICAgICAgICAgaW5zdGFuY2UuYXN5bmNSZXNvbHZlZCA9IHRydWU7DQogICAgICAgICAgY29uc3QgeyB2bm9kZTogdm5vZGUyIH0gPSBpbnN0YW5jZTsNCiAgICAgICAgICB7DQogICAgICAgICAgICBwdXNoV2FybmluZ0NvbnRleHQodm5vZGUyKTsNCiAgICAgICAgICB9DQogICAgICAgICAgaGFuZGxlU2V0dXBSZXN1bHQoaW5zdGFuY2UsIGFzeW5jU2V0dXBSZXN1bHQsIGZhbHNlKTsNCiAgICAgICAgICBpZiAoaHlkcmF0ZWRFbCkgew0KICAgICAgICAgICAgdm5vZGUyLmVsID0gaHlkcmF0ZWRFbDsNCiAgICAgICAgICB9DQogICAgICAgICAgY29uc3QgcGxhY2Vob2xkZXIgPSAhaHlkcmF0ZWRFbCAmJiBpbnN0YW5jZS5zdWJUcmVlLmVsOw0KICAgICAgICAgIHNldHVwUmVuZGVyRWZmZWN0KA0KICAgICAgICAgICAgaW5zdGFuY2UsDQogICAgICAgICAgICB2bm9kZTIsDQogICAgICAgICAgICAvLyBjb21wb25lbnQgbWF5IGhhdmUgYmVlbiBtb3ZlZCBiZWZvcmUgcmVzb2x2ZS4NCiAgICAgICAgICAgIC8vIGlmIHRoaXMgaXMgbm90IGEgaHlkcmF0aW9uLCBpbnN0YW5jZS5zdWJUcmVlIHdpbGwgYmUgdGhlIGNvbW1lbnQNCiAgICAgICAgICAgIC8vIHBsYWNlaG9sZGVyLg0KICAgICAgICAgICAgcGFyZW50Tm9kZShoeWRyYXRlZEVsIHx8IGluc3RhbmNlLnN1YlRyZWUuZWwpLA0KICAgICAgICAgICAgLy8gYW5jaG9yIHdpbGwgbm90IGJlIHVzZWQgaWYgdGhpcyBpcyBoeWRyYXRpb24sIHNvIG9ubHkgbmVlZCB0bw0KICAgICAgICAgICAgLy8gY29uc2lkZXIgdGhlIGNvbW1lbnQgcGxhY2Vob2xkZXIgY2FzZS4NCiAgICAgICAgICAgIGh5ZHJhdGVkRWwgPyBudWxsIDogbmV4dChpbnN0YW5jZS5zdWJUcmVlKSwNCiAgICAgICAgICAgIHN1c3BlbnNlLA0KICAgICAgICAgICAgbmFtZXNwYWNlLA0KICAgICAgICAgICAgb3B0aW1pemVkMg0KICAgICAgICAgICk7DQogICAgICAgICAgaWYgKHBsYWNlaG9sZGVyKSB7DQogICAgICAgICAgICByZW1vdmUocGxhY2Vob2xkZXIpOw0KICAgICAgICAgIH0NCiAgICAgICAgICB1cGRhdGVIT0NIb3N0RWwoaW5zdGFuY2UsIHZub2RlMi5lbCk7DQogICAgICAgICAgew0KICAgICAgICAgICAgcG9wV2FybmluZ0NvbnRleHQoKTsNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKGlzSW5QZW5kaW5nU3VzcGVuc2UgJiYgLS1zdXNwZW5zZS5kZXBzID09PSAwKSB7DQogICAgICAgICAgICBzdXNwZW5zZS5yZXNvbHZlKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgIH0sDQogICAgICB1bm1vdW50KHBhcmVudFN1c3BlbnNlMiwgZG9SZW1vdmUpIHsNCiAgICAgICAgc3VzcGVuc2UuaXNVbm1vdW50ZWQgPSB0cnVlOw0KICAgICAgICBpZiAoc3VzcGVuc2UuYWN0aXZlQnJhbmNoKSB7DQogICAgICAgICAgdW5tb3VudCgNCiAgICAgICAgICAgIHN1c3BlbnNlLmFjdGl2ZUJyYW5jaCwNCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwNCiAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlMiwNCiAgICAgICAgICAgIGRvUmVtb3ZlDQogICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoc3VzcGVuc2UucGVuZGluZ0JyYW5jaCkgew0KICAgICAgICAgIHVubW91bnQoDQogICAgICAgICAgICBzdXNwZW5zZS5wZW5kaW5nQnJhbmNoLA0KICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LA0KICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UyLA0KICAgICAgICAgICAgZG9SZW1vdmUNCiAgICAgICAgICApOw0KICAgICAgICB9DQogICAgICB9DQogICAgfTsNCiAgICByZXR1cm4gc3VzcGVuc2U7DQogIH0NCiAgZnVuY3Rpb24gaHlkcmF0ZVN1c3BlbnNlKG5vZGUsIHZub2RlLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBuYW1lc3BhY2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCByZW5kZXJlckludGVybmFscywgaHlkcmF0ZU5vZGUpIHsNCiAgICBjb25zdCBzdXNwZW5zZSA9IHZub2RlLnN1c3BlbnNlID0gY3JlYXRlU3VzcGVuc2VCb3VuZGFyeSgNCiAgICAgIHZub2RlLA0KICAgICAgcGFyZW50U3VzcGVuc2UsDQogICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICBub2RlLnBhcmVudE5vZGUsDQogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcmVzdHJpY3RlZC1nbG9iYWxzDQogICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSwNCiAgICAgIG51bGwsDQogICAgICBuYW1lc3BhY2UsDQogICAgICBzbG90U2NvcGVJZHMsDQogICAgICBvcHRpbWl6ZWQsDQogICAgICByZW5kZXJlckludGVybmFscywNCiAgICAgIHRydWUNCiAgICApOw0KICAgIGNvbnN0IHJlc3VsdCA9IGh5ZHJhdGVOb2RlKA0KICAgICAgbm9kZSwNCiAgICAgIHN1c3BlbnNlLnBlbmRpbmdCcmFuY2ggPSB2bm9kZS5zc0NvbnRlbnQsDQogICAgICBwYXJlbnRDb21wb25lbnQsDQogICAgICBzdXNwZW5zZSwNCiAgICAgIHNsb3RTY29wZUlkcywNCiAgICAgIG9wdGltaXplZA0KICAgICk7DQogICAgaWYgKHN1c3BlbnNlLmRlcHMgPT09IDApIHsNCiAgICAgIHN1c3BlbnNlLnJlc29sdmUoZmFsc2UsIHRydWUpOw0KICAgIH0NCiAgICByZXR1cm4gcmVzdWx0Ow0KICB9DQogIGZ1bmN0aW9uIG5vcm1hbGl6ZVN1c3BlbnNlQ2hpbGRyZW4odm5vZGUpIHsNCiAgICBjb25zdCB7IHNoYXBlRmxhZywgY2hpbGRyZW4gfSA9IHZub2RlOw0KICAgIGNvbnN0IGlzU2xvdENoaWxkcmVuID0gc2hhcGVGbGFnICYgMzI7DQogICAgdm5vZGUuc3NDb250ZW50ID0gbm9ybWFsaXplU3VzcGVuc2VTbG90KA0KICAgICAgaXNTbG90Q2hpbGRyZW4gPyBjaGlsZHJlbi5kZWZhdWx0IDogY2hpbGRyZW4NCiAgICApOw0KICAgIHZub2RlLnNzRmFsbGJhY2sgPSBpc1Nsb3RDaGlsZHJlbiA/IG5vcm1hbGl6ZVN1c3BlbnNlU2xvdChjaGlsZHJlbi5mYWxsYmFjaykgOiBjcmVhdGVWTm9kZShDb21tZW50KTsNCiAgfQ0KICBmdW5jdGlvbiBub3JtYWxpemVTdXNwZW5zZVNsb3Qocykgew0KICAgIGxldCBibG9jazsNCiAgICBpZiAoaXNGdW5jdGlvbihzKSkgew0KICAgICAgY29uc3QgdHJhY2tCbG9jayA9IGlzQmxvY2tUcmVlRW5hYmxlZCAmJiBzLl9jOw0KICAgICAgaWYgKHRyYWNrQmxvY2spIHsNCiAgICAgICAgcy5fZCA9IGZhbHNlOw0KICAgICAgICBvcGVuQmxvY2soKTsNCiAgICAgIH0NCiAgICAgIHMgPSBzKCk7DQogICAgICBpZiAodHJhY2tCbG9jaykgew0KICAgICAgICBzLl9kID0gdHJ1ZTsNCiAgICAgICAgYmxvY2sgPSBjdXJyZW50QmxvY2s7DQogICAgICAgIGNsb3NlQmxvY2soKTsNCiAgICAgIH0NCiAgICB9DQogICAgaWYgKGlzQXJyYXkocykpIHsNCiAgICAgIGNvbnN0IHNpbmdsZUNoaWxkID0gZmlsdGVyU2luZ2xlUm9vdChzKTsNCiAgICAgIGlmICghc2luZ2xlQ2hpbGQgJiYgcy5maWx0ZXIoKGNoaWxkKSA9PiBjaGlsZCAhPT0gTlVMTF9EWU5BTUlDX0NPTVBPTkVOVCkubGVuZ3RoID4gMCkgew0KICAgICAgICB3YXJuJDEoYDxTdXNwZW5zZT4gc2xvdHMgZXhwZWN0IGEgc2luZ2xlIHJvb3Qgbm9kZS5gKTsNCiAgICAgIH0NCiAgICAgIHMgPSBzaW5nbGVDaGlsZDsNCiAgICB9DQogICAgcyA9IG5vcm1hbGl6ZVZOb2RlKHMpOw0KICAgIGlmIChibG9jayAmJiAhcy5keW5hbWljQ2hpbGRyZW4pIHsNCiAgICAgIHMuZHluYW1pY0NoaWxkcmVuID0gYmxvY2suZmlsdGVyKChjKSA9PiBjICE9PSBzKTsNCiAgICB9DQogICAgcmV0dXJuIHM7DQogIH0NCiAgZnVuY3Rpb24gcXVldWVFZmZlY3RXaXRoU3VzcGVuc2UoZm4sIHN1c3BlbnNlKSB7DQogICAgaWYgKHN1c3BlbnNlICYmIHN1c3BlbnNlLnBlbmRpbmdCcmFuY2gpIHsNCiAgICAgIGlmIChpc0FycmF5KGZuKSkgew0KICAgICAgICBzdXNwZW5zZS5lZmZlY3RzLnB1c2goLi4uZm4pOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgc3VzcGVuc2UuZWZmZWN0cy5wdXNoKGZuKTsNCiAgICAgIH0NCiAgICB9IGVsc2Ugew0KICAgICAgcXVldWVQb3N0Rmx1c2hDYihmbik7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIHNldEFjdGl2ZUJyYW5jaChzdXNwZW5zZSwgYnJhbmNoKSB7DQogICAgc3VzcGVuc2UuYWN0aXZlQnJhbmNoID0gYnJhbmNoOw0KICAgIGNvbnN0IHsgdm5vZGUsIHBhcmVudENvbXBvbmVudCB9ID0gc3VzcGVuc2U7DQogICAgbGV0IGVsID0gYnJhbmNoLmVsOw0KICAgIHdoaWxlICghZWwgJiYgYnJhbmNoLmNvbXBvbmVudCkgew0KICAgICAgYnJhbmNoID0gYnJhbmNoLmNvbXBvbmVudC5zdWJUcmVlOw0KICAgICAgZWwgPSBicmFuY2guZWw7DQogICAgfQ0KICAgIHZub2RlLmVsID0gZWw7DQogICAgaWYgKHBhcmVudENvbXBvbmVudCAmJiBwYXJlbnRDb21wb25lbnQuc3ViVHJlZSA9PT0gdm5vZGUpIHsNCiAgICAgIHBhcmVudENvbXBvbmVudC52bm9kZS5lbCA9IGVsOw0KICAgICAgdXBkYXRlSE9DSG9zdEVsKHBhcmVudENvbXBvbmVudCwgZWwpOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBpc1ZOb2RlU3VzcGVuc2libGUodm5vZGUpIHsNCiAgICBjb25zdCBzdXNwZW5zaWJsZSA9IHZub2RlLnByb3BzICYmIHZub2RlLnByb3BzLnN1c3BlbnNpYmxlOw0KICAgIHJldHVybiBzdXNwZW5zaWJsZSAhPSBudWxsICYmIHN1c3BlbnNpYmxlICE9PSBmYWxzZTsNCiAgfQ0KDQogIGNvbnN0IEZyYWdtZW50ID0gU3ltYm9sLmZvcigidi1mZ3QiKTsNCiAgY29uc3QgVGV4dCA9IFN5bWJvbC5mb3IoInYtdHh0Iik7DQogIGNvbnN0IENvbW1lbnQgPSBTeW1ib2wuZm9yKCJ2LWNtdCIpOw0KICBjb25zdCBTdGF0aWMgPSBTeW1ib2wuZm9yKCJ2LXN0YyIpOw0KICBjb25zdCBibG9ja1N0YWNrID0gW107DQogIGxldCBjdXJyZW50QmxvY2sgPSBudWxsOw0KICBmdW5jdGlvbiBvcGVuQmxvY2soZGlzYWJsZVRyYWNraW5nID0gZmFsc2UpIHsNCiAgICBibG9ja1N0YWNrLnB1c2goY3VycmVudEJsb2NrID0gZGlzYWJsZVRyYWNraW5nID8gbnVsbCA6IFtdKTsNCiAgfQ0KICBmdW5jdGlvbiBjbG9zZUJsb2NrKCkgew0KICAgIGJsb2NrU3RhY2sucG9wKCk7DQogICAgY3VycmVudEJsb2NrID0gYmxvY2tTdGFja1tibG9ja1N0YWNrLmxlbmd0aCAtIDFdIHx8IG51bGw7DQogIH0NCiAgbGV0IGlzQmxvY2tUcmVlRW5hYmxlZCA9IDE7DQogIGZ1bmN0aW9uIHNldEJsb2NrVHJhY2tpbmcodmFsdWUsIGluVk9uY2UgPSBmYWxzZSkgew0KICAgIGlzQmxvY2tUcmVlRW5hYmxlZCArPSB2YWx1ZTsNCiAgICBpZiAodmFsdWUgPCAwICYmIGN1cnJlbnRCbG9jayAmJiBpblZPbmNlKSB7DQogICAgICBjdXJyZW50QmxvY2suaGFzT25jZSA9IHRydWU7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIHNldHVwQmxvY2sodm5vZGUpIHsNCiAgICB2bm9kZS5keW5hbWljQ2hpbGRyZW4gPSBpc0Jsb2NrVHJlZUVuYWJsZWQgPiAwID8gY3VycmVudEJsb2NrIHx8IEVNUFRZX0FSUiA6IG51bGw7DQogICAgY2xvc2VCbG9jaygpOw0KICAgIGlmIChpc0Jsb2NrVHJlZUVuYWJsZWQgPiAwICYmIGN1cnJlbnRCbG9jaykgew0KICAgICAgY3VycmVudEJsb2NrLnB1c2godm5vZGUpOw0KICAgIH0NCiAgICByZXR1cm4gdm5vZGU7DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlRWxlbWVudEJsb2NrKHR5cGUsIHByb3BzLCBjaGlsZHJlbiwgcGF0Y2hGbGFnLCBkeW5hbWljUHJvcHMsIHNoYXBlRmxhZykgew0KICAgIHJldHVybiBzZXR1cEJsb2NrKA0KICAgICAgY3JlYXRlQmFzZVZOb2RlKA0KICAgICAgICB0eXBlLA0KICAgICAgICBwcm9wcywNCiAgICAgICAgY2hpbGRyZW4sDQogICAgICAgIHBhdGNoRmxhZywNCiAgICAgICAgZHluYW1pY1Byb3BzLA0KICAgICAgICBzaGFwZUZsYWcsDQogICAgICAgIHRydWUNCiAgICAgICkNCiAgICApOw0KICB9DQogIGZ1bmN0aW9uIGNyZWF0ZUJsb2NrKHR5cGUsIHByb3BzLCBjaGlsZHJlbiwgcGF0Y2hGbGFnLCBkeW5hbWljUHJvcHMpIHsNCiAgICByZXR1cm4gc2V0dXBCbG9jaygNCiAgICAgIGNyZWF0ZVZOb2RlKA0KICAgICAgICB0eXBlLA0KICAgICAgICBwcm9wcywNCiAgICAgICAgY2hpbGRyZW4sDQogICAgICAgIHBhdGNoRmxhZywNCiAgICAgICAgZHluYW1pY1Byb3BzLA0KICAgICAgICB0cnVlDQogICAgICApDQogICAgKTsNCiAgfQ0KICBmdW5jdGlvbiBpc1ZOb2RlKHZhbHVlKSB7DQogICAgcmV0dXJuIHZhbHVlID8gdmFsdWUuX192X2lzVk5vZGUgPT09IHRydWUgOiBmYWxzZTsNCiAgfQ0KICBmdW5jdGlvbiBpc1NhbWVWTm9kZVR5cGUobjEsIG4yKSB7DQogICAgaWYgKG4yLnNoYXBlRmxhZyAmIDYgJiYgbjEuY29tcG9uZW50KSB7DQogICAgICBjb25zdCBkaXJ0eUluc3RhbmNlcyA9IGhtckRpcnR5Q29tcG9uZW50cy5nZXQobjIudHlwZSk7DQogICAgICBpZiAoZGlydHlJbnN0YW5jZXMgJiYgZGlydHlJbnN0YW5jZXMuaGFzKG4xLmNvbXBvbmVudCkpIHsNCiAgICAgICAgbjEuc2hhcGVGbGFnICY9IC0yNTc7DQogICAgICAgIG4yLnNoYXBlRmxhZyAmPSAtNTEzOw0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiBuMS50eXBlID09PSBuMi50eXBlICYmIG4xLmtleSA9PT0gbjIua2V5Ow0KICB9DQogIGxldCB2bm9kZUFyZ3NUcmFuc2Zvcm1lcjsNCiAgZnVuY3Rpb24gdHJhbnNmb3JtVk5vZGVBcmdzKHRyYW5zZm9ybWVyKSB7DQogICAgdm5vZGVBcmdzVHJhbnNmb3JtZXIgPSB0cmFuc2Zvcm1lcjsNCiAgfQ0KICBjb25zdCBjcmVhdGVWTm9kZVdpdGhBcmdzVHJhbnNmb3JtID0gKC4uLmFyZ3MpID0+IHsNCiAgICByZXR1cm4gX2NyZWF0ZVZOb2RlKA0KICAgICAgLi4udm5vZGVBcmdzVHJhbnNmb3JtZXIgPyB2bm9kZUFyZ3NUcmFuc2Zvcm1lcihhcmdzLCBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UpIDogYXJncw0KICAgICk7DQogIH07DQogIGNvbnN0IG5vcm1hbGl6ZUtleSA9ICh7IGtleSB9KSA9PiBrZXkgIT0gbnVsbCA/IGtleSA6IG51bGw7DQogIGNvbnN0IG5vcm1hbGl6ZVJlZiA9ICh7DQogICAgcmVmLA0KICAgIHJlZl9rZXksDQogICAgcmVmX2Zvcg0KICB9KSA9PiB7DQogICAgaWYgKHR5cGVvZiByZWYgPT09ICJudW1iZXIiKSB7DQogICAgICByZWYgPSAiIiArIHJlZjsNCiAgICB9DQogICAgcmV0dXJuIHJlZiAhPSBudWxsID8gaXNTdHJpbmcocmVmKSB8fCBpc1JlZihyZWYpIHx8IGlzRnVuY3Rpb24ocmVmKSA/IHsgaTogY3VycmVudFJlbmRlcmluZ0luc3RhbmNlLCByOiByZWYsIGs6IHJlZl9rZXksIGY6ICEhcmVmX2ZvciB9IDogcmVmIDogbnVsbDsNCiAgfTsNCiAgZnVuY3Rpb24gY3JlYXRlQmFzZVZOb2RlKHR5cGUsIHByb3BzID0gbnVsbCwgY2hpbGRyZW4gPSBudWxsLCBwYXRjaEZsYWcgPSAwLCBkeW5hbWljUHJvcHMgPSBudWxsLCBzaGFwZUZsYWcgPSB0eXBlID09PSBGcmFnbWVudCA/IDAgOiAxLCBpc0Jsb2NrTm9kZSA9IGZhbHNlLCBuZWVkRnVsbENoaWxkcmVuTm9ybWFsaXphdGlvbiA9IGZhbHNlKSB7DQogICAgY29uc3Qgdm5vZGUgPSB7DQogICAgICBfX3ZfaXNWTm9kZTogdHJ1ZSwNCiAgICAgIF9fdl9za2lwOiB0cnVlLA0KICAgICAgdHlwZSwNCiAgICAgIHByb3BzLA0KICAgICAga2V5OiBwcm9wcyAmJiBub3JtYWxpemVLZXkocHJvcHMpLA0KICAgICAgcmVmOiBwcm9wcyAmJiBub3JtYWxpemVSZWYocHJvcHMpLA0KICAgICAgc2NvcGVJZDogY3VycmVudFNjb3BlSWQsDQogICAgICBzbG90U2NvcGVJZHM6IG51bGwsDQogICAgICBjaGlsZHJlbiwNCiAgICAgIGNvbXBvbmVudDogbnVsbCwNCiAgICAgIHN1c3BlbnNlOiBudWxsLA0KICAgICAgc3NDb250ZW50OiBudWxsLA0KICAgICAgc3NGYWxsYmFjazogbnVsbCwNCiAgICAgIGRpcnM6IG51bGwsDQogICAgICB0cmFuc2l0aW9uOiBudWxsLA0KICAgICAgZWw6IG51bGwsDQogICAgICBhbmNob3I6IG51bGwsDQogICAgICB0YXJnZXQ6IG51bGwsDQogICAgICB0YXJnZXRTdGFydDogbnVsbCwNCiAgICAgIHRhcmdldEFuY2hvcjogbnVsbCwNCiAgICAgIHN0YXRpY0NvdW50OiAwLA0KICAgICAgc2hhcGVGbGFnLA0KICAgICAgcGF0Y2hGbGFnLA0KICAgICAgZHluYW1pY1Byb3BzLA0KICAgICAgZHluYW1pY0NoaWxkcmVuOiBudWxsLA0KICAgICAgYXBwQ29udGV4dDogbnVsbCwNCiAgICAgIGN0eDogY3VycmVudFJlbmRlcmluZ0luc3RhbmNlDQogICAgfTsNCiAgICBpZiAobmVlZEZ1bGxDaGlsZHJlbk5vcm1hbGl6YXRpb24pIHsNCiAgICAgIG5vcm1hbGl6ZUNoaWxkcmVuKHZub2RlLCBjaGlsZHJlbik7DQogICAgICBpZiAoc2hhcGVGbGFnICYgMTI4KSB7DQogICAgICAgIHR5cGUubm9ybWFsaXplKHZub2RlKTsNCiAgICAgIH0NCiAgICB9IGVsc2UgaWYgKGNoaWxkcmVuKSB7DQogICAgICB2bm9kZS5zaGFwZUZsYWcgfD0gaXNTdHJpbmcoY2hpbGRyZW4pID8gOCA6IDE2Ow0KICAgIH0NCiAgICBpZiAodm5vZGUua2V5ICE9PSB2bm9kZS5rZXkpIHsNCiAgICAgIHdhcm4kMShgVk5vZGUgY3JlYXRlZCB3aXRoIGludmFsaWQga2V5IChOYU4pLiBWTm9kZSB0eXBlOmAsIHZub2RlLnR5cGUpOw0KICAgIH0NCiAgICBpZiAoaXNCbG9ja1RyZWVFbmFibGVkID4gMCAmJiAvLyBhdm9pZCBhIGJsb2NrIG5vZGUgZnJvbSB0cmFja2luZyBpdHNlbGYNCiAgICAhaXNCbG9ja05vZGUgJiYgLy8gaGFzIGN1cnJlbnQgcGFyZW50IGJsb2NrDQogICAgY3VycmVudEJsb2NrICYmIC8vIHByZXNlbmNlIG9mIGEgcGF0Y2ggZmxhZyBpbmRpY2F0ZXMgdGhpcyBub2RlIG5lZWRzIHBhdGNoaW5nIG9uIHVwZGF0ZXMuDQogICAgLy8gY29tcG9uZW50IG5vZGVzIGFsc28gc2hvdWxkIGFsd2F5cyBiZSBwYXRjaGVkLCBiZWNhdXNlIGV2ZW4gaWYgdGhlDQogICAgLy8gY29tcG9uZW50IGRvZXNuJ3QgbmVlZCB0byB1cGRhdGUsIGl0IG5lZWRzIHRvIHBlcnNpc3QgdGhlIGluc3RhbmNlIG9uIHRvDQogICAgLy8gdGhlIG5leHQgdm5vZGUgc28gdGhhdCBpdCBjYW4gYmUgcHJvcGVybHkgdW5tb3VudGVkIGxhdGVyLg0KICAgICh2bm9kZS5wYXRjaEZsYWcgPiAwIHx8IHNoYXBlRmxhZyAmIDYpICYmIC8vIHRoZSBFVkVOVFMgZmxhZyBpcyBvbmx5IGZvciBoeWRyYXRpb24gYW5kIGlmIGl0IGlzIHRoZSBvbmx5IGZsYWcsIHRoZQ0KICAgIC8vIHZub2RlIHNob3VsZCBub3QgYmUgY29uc2lkZXJlZCBkeW5hbWljIGR1ZSB0byBoYW5kbGVyIGNhY2hpbmcuDQogICAgdm5vZGUucGF0Y2hGbGFnICE9PSAzMikgew0KICAgICAgY3VycmVudEJsb2NrLnB1c2godm5vZGUpOw0KICAgIH0NCiAgICByZXR1cm4gdm5vZGU7DQogIH0NCiAgY29uc3QgY3JlYXRlVk5vZGUgPSBjcmVhdGVWTm9kZVdpdGhBcmdzVHJhbnNmb3JtIDsNCiAgZnVuY3Rpb24gX2NyZWF0ZVZOb2RlKHR5cGUsIHByb3BzID0gbnVsbCwgY2hpbGRyZW4gPSBudWxsLCBwYXRjaEZsYWcgPSAwLCBkeW5hbWljUHJvcHMgPSBudWxsLCBpc0Jsb2NrTm9kZSA9IGZhbHNlKSB7DQogICAgaWYgKCF0eXBlIHx8IHR5cGUgPT09IE5VTExfRFlOQU1JQ19DT01QT05FTlQpIHsNCiAgICAgIGlmICghdHlwZSkgew0KICAgICAgICB3YXJuJDEoYEludmFsaWQgdm5vZGUgdHlwZSB3aGVuIGNyZWF0aW5nIHZub2RlOiAke3R5cGV9LmApOw0KICAgICAgfQ0KICAgICAgdHlwZSA9IENvbW1lbnQ7DQogICAgfQ0KICAgIGlmIChpc1ZOb2RlKHR5cGUpKSB7DQogICAgICBjb25zdCBjbG9uZWQgPSBjbG9uZVZOb2RlKA0KICAgICAgICB0eXBlLA0KICAgICAgICBwcm9wcywNCiAgICAgICAgdHJ1ZQ0KICAgICAgICAvKiBtZXJnZVJlZjogdHJ1ZSAqLw0KICAgICAgKTsNCiAgICAgIGlmIChjaGlsZHJlbikgew0KICAgICAgICBub3JtYWxpemVDaGlsZHJlbihjbG9uZWQsIGNoaWxkcmVuKTsNCiAgICAgIH0NCiAgICAgIGlmIChpc0Jsb2NrVHJlZUVuYWJsZWQgPiAwICYmICFpc0Jsb2NrTm9kZSAmJiBjdXJyZW50QmxvY2spIHsNCiAgICAgICAgaWYgKGNsb25lZC5zaGFwZUZsYWcgJiA2KSB7DQogICAgICAgICAgY3VycmVudEJsb2NrW2N1cnJlbnRCbG9jay5pbmRleE9mKHR5cGUpXSA9IGNsb25lZDsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBjdXJyZW50QmxvY2sucHVzaChjbG9uZWQpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICBjbG9uZWQucGF0Y2hGbGFnID0gLTI7DQogICAgICByZXR1cm4gY2xvbmVkOw0KICAgIH0NCiAgICBpZiAoaXNDbGFzc0NvbXBvbmVudCh0eXBlKSkgew0KICAgICAgdHlwZSA9IHR5cGUuX192Y2NPcHRzOw0KICAgIH0NCiAgICBpZiAocHJvcHMpIHsNCiAgICAgIHByb3BzID0gZ3VhcmRSZWFjdGl2ZVByb3BzKHByb3BzKTsNCiAgICAgIGxldCB7IGNsYXNzOiBrbGFzcywgc3R5bGUgfSA9IHByb3BzOw0KICAgICAgaWYgKGtsYXNzICYmICFpc1N0cmluZyhrbGFzcykpIHsNCiAgICAgICAgcHJvcHMuY2xhc3MgPSBub3JtYWxpemVDbGFzcyhrbGFzcyk7DQogICAgICB9DQogICAgICBpZiAoaXNPYmplY3Qoc3R5bGUpKSB7DQogICAgICAgIGlmIChpc1Byb3h5KHN0eWxlKSAmJiAhaXNBcnJheShzdHlsZSkpIHsNCiAgICAgICAgICBzdHlsZSA9IGV4dGVuZCh7fSwgc3R5bGUpOw0KICAgICAgICB9DQogICAgICAgIHByb3BzLnN0eWxlID0gbm9ybWFsaXplU3R5bGUoc3R5bGUpOw0KICAgICAgfQ0KICAgIH0NCiAgICBjb25zdCBzaGFwZUZsYWcgPSBpc1N0cmluZyh0eXBlKSA/IDEgOiBpc1N1c3BlbnNlKHR5cGUpID8gMTI4IDogaXNUZWxlcG9ydCh0eXBlKSA/IDY0IDogaXNPYmplY3QodHlwZSkgPyA0IDogaXNGdW5jdGlvbih0eXBlKSA/IDIgOiAwOw0KICAgIGlmIChzaGFwZUZsYWcgJiA0ICYmIGlzUHJveHkodHlwZSkpIHsNCiAgICAgIHR5cGUgPSB0b1Jhdyh0eXBlKTsNCiAgICAgIHdhcm4kMSgNCiAgICAgICAgYFZ1ZSByZWNlaXZlZCBhIENvbXBvbmVudCB0aGF0IHdhcyBtYWRlIGEgcmVhY3RpdmUgb2JqZWN0LiBUaGlzIGNhbiBsZWFkIHRvIHVubmVjZXNzYXJ5IHBlcmZvcm1hbmNlIG92ZXJoZWFkIGFuZCBzaG91bGQgYmUgYXZvaWRlZCBieSBtYXJraW5nIHRoZSBjb21wb25lbnQgd2l0aCBcYG1hcmtSYXdcYCBvciB1c2luZyBcYHNoYWxsb3dSZWZcYCBpbnN0ZWFkIG9mIFxgcmVmXGAuYCwNCiAgICAgICAgYA0KQ29tcG9uZW50IHRoYXQgd2FzIG1hZGUgcmVhY3RpdmU6IGAsDQogICAgICAgIHR5cGUNCiAgICAgICk7DQogICAgfQ0KICAgIHJldHVybiBjcmVhdGVCYXNlVk5vZGUoDQogICAgICB0eXBlLA0KICAgICAgcHJvcHMsDQogICAgICBjaGlsZHJlbiwNCiAgICAgIHBhdGNoRmxhZywNCiAgICAgIGR5bmFtaWNQcm9wcywNCiAgICAgIHNoYXBlRmxhZywNCiAgICAgIGlzQmxvY2tOb2RlLA0KICAgICAgdHJ1ZQ0KICAgICk7DQogIH0NCiAgZnVuY3Rpb24gZ3VhcmRSZWFjdGl2ZVByb3BzKHByb3BzKSB7DQogICAgaWYgKCFwcm9wcykgcmV0dXJuIG51bGw7DQogICAgcmV0dXJuIGlzUHJveHkocHJvcHMpIHx8IGlzSW50ZXJuYWxPYmplY3QocHJvcHMpID8gZXh0ZW5kKHt9LCBwcm9wcykgOiBwcm9wczsNCiAgfQ0KICBmdW5jdGlvbiBjbG9uZVZOb2RlKHZub2RlLCBleHRyYVByb3BzLCBtZXJnZVJlZiA9IGZhbHNlLCBjbG9uZVRyYW5zaXRpb24gPSBmYWxzZSkgew0KICAgIGNvbnN0IHsgcHJvcHMsIHJlZiwgcGF0Y2hGbGFnLCBjaGlsZHJlbiwgdHJhbnNpdGlvbiB9ID0gdm5vZGU7DQogICAgY29uc3QgbWVyZ2VkUHJvcHMgPSBleHRyYVByb3BzID8gbWVyZ2VQcm9wcyhwcm9wcyB8fCB7fSwgZXh0cmFQcm9wcykgOiBwcm9wczsNCiAgICBjb25zdCBjbG9uZWQgPSB7DQogICAgICBfX3ZfaXNWTm9kZTogdHJ1ZSwNCiAgICAgIF9fdl9za2lwOiB0cnVlLA0KICAgICAgdHlwZTogdm5vZGUudHlwZSwNCiAgICAgIHByb3BzOiBtZXJnZWRQcm9wcywNCiAgICAgIGtleTogbWVyZ2VkUHJvcHMgJiYgbm9ybWFsaXplS2V5KG1lcmdlZFByb3BzKSwNCiAgICAgIHJlZjogZXh0cmFQcm9wcyAmJiBleHRyYVByb3BzLnJlZiA/ICgNCiAgICAgICAgLy8gIzIwNzggaW4gdGhlIGNhc2Ugb2YgPGNvbXBvbmVudCA6aXM9InZub2RlIiByZWY9ImV4dHJhIi8+DQogICAgICAgIC8vIGlmIHRoZSB2bm9kZSBpdHNlbGYgYWxyZWFkeSBoYXMgYSByZWYsIGNsb25lVk5vZGUgd2lsbCBuZWVkIHRvIG1lcmdlDQogICAgICAgIC8vIHRoZSByZWZzIHNvIHRoZSBzaW5nbGUgdm5vZGUgY2FuIGJlIHNldCBvbiBtdWx0aXBsZSByZWZzDQogICAgICAgIG1lcmdlUmVmICYmIHJlZiA/IGlzQXJyYXkocmVmKSA/IHJlZi5jb25jYXQobm9ybWFsaXplUmVmKGV4dHJhUHJvcHMpKSA6IFtyZWYsIG5vcm1hbGl6ZVJlZihleHRyYVByb3BzKV0gOiBub3JtYWxpemVSZWYoZXh0cmFQcm9wcykNCiAgICAgICkgOiByZWYsDQogICAgICBzY29wZUlkOiB2bm9kZS5zY29wZUlkLA0KICAgICAgc2xvdFNjb3BlSWRzOiB2bm9kZS5zbG90U2NvcGVJZHMsDQogICAgICBjaGlsZHJlbjogcGF0Y2hGbGFnID09PSAtMSAmJiBpc0FycmF5KGNoaWxkcmVuKSA/IGNoaWxkcmVuLm1hcChkZWVwQ2xvbmVWTm9kZSkgOiBjaGlsZHJlbiwNCiAgICAgIHRhcmdldDogdm5vZGUudGFyZ2V0LA0KICAgICAgdGFyZ2V0U3RhcnQ6IHZub2RlLnRhcmdldFN0YXJ0LA0KICAgICAgdGFyZ2V0QW5jaG9yOiB2bm9kZS50YXJnZXRBbmNob3IsDQogICAgICBzdGF0aWNDb3VudDogdm5vZGUuc3RhdGljQ291bnQsDQogICAgICBzaGFwZUZsYWc6IHZub2RlLnNoYXBlRmxhZywNCiAgICAgIC8vIGlmIHRoZSB2bm9kZSBpcyBjbG9uZWQgd2l0aCBleHRyYSBwcm9wcywgd2UgY2FuIG5vIGxvbmdlciBhc3N1bWUgaXRzDQogICAgICAvLyBleGlzdGluZyBwYXRjaCBmbGFnIHRvIGJlIHJlbGlhYmxlIGFuZCBuZWVkIHRvIGFkZCB0aGUgRlVMTF9QUk9QUyBmbGFnLg0KICAgICAgLy8gbm90ZTogcHJlc2VydmUgZmxhZyBmb3IgZnJhZ21lbnRzIHNpbmNlIHRoZXkgdXNlIHRoZSBmbGFnIGZvciBjaGlsZHJlbg0KICAgICAgLy8gZmFzdCBwYXRocyBvbmx5Lg0KICAgICAgcGF0Y2hGbGFnOiBleHRyYVByb3BzICYmIHZub2RlLnR5cGUgIT09IEZyYWdtZW50ID8gcGF0Y2hGbGFnID09PSAtMSA/IDE2IDogcGF0Y2hGbGFnIHwgMTYgOiBwYXRjaEZsYWcsDQogICAgICBkeW5hbWljUHJvcHM6IHZub2RlLmR5bmFtaWNQcm9wcywNCiAgICAgIGR5bmFtaWNDaGlsZHJlbjogdm5vZGUuZHluYW1pY0NoaWxkcmVuLA0KICAgICAgYXBwQ29udGV4dDogdm5vZGUuYXBwQ29udGV4dCwNCiAgICAgIGRpcnM6IHZub2RlLmRpcnMsDQogICAgICB0cmFuc2l0aW9uLA0KICAgICAgLy8gVGhlc2Ugc2hvdWxkIHRlY2huaWNhbGx5IG9ubHkgYmUgbm9uLW51bGwgb24gbW91bnRlZCBWTm9kZXMuIEhvd2V2ZXIsDQogICAgICAvLyB0aGV5ICpzaG91bGQqIGJlIGNvcGllZCBmb3Iga2VwdC1hbGl2ZSB2bm9kZXMuIFNvIHdlIGp1c3QgYWx3YXlzIGNvcHkNCiAgICAgIC8vIHRoZW0gc2luY2UgdGhlbSBiZWluZyBub24tbnVsbCBkdXJpbmcgYSBtb3VudCBkb2Vzbid0IGFmZmVjdCB0aGUgbG9naWMgYXMNCiAgICAgIC8vIHRoZXkgd2lsbCBzaW1wbHkgYmUgb3ZlcndyaXR0ZW4uDQogICAgICBjb21wb25lbnQ6IHZub2RlLmNvbXBvbmVudCwNCiAgICAgIHN1c3BlbnNlOiB2bm9kZS5zdXNwZW5zZSwNCiAgICAgIHNzQ29udGVudDogdm5vZGUuc3NDb250ZW50ICYmIGNsb25lVk5vZGUodm5vZGUuc3NDb250ZW50KSwNCiAgICAgIHNzRmFsbGJhY2s6IHZub2RlLnNzRmFsbGJhY2sgJiYgY2xvbmVWTm9kZSh2bm9kZS5zc0ZhbGxiYWNrKSwNCiAgICAgIGVsOiB2bm9kZS5lbCwNCiAgICAgIGFuY2hvcjogdm5vZGUuYW5jaG9yLA0KICAgICAgY3R4OiB2bm9kZS5jdHgsDQogICAgICBjZTogdm5vZGUuY2UNCiAgICB9Ow0KICAgIGlmICh0cmFuc2l0aW9uICYmIGNsb25lVHJhbnNpdGlvbikgew0KICAgICAgc2V0VHJhbnNpdGlvbkhvb2tzKA0KICAgICAgICBjbG9uZWQsDQogICAgICAgIHRyYW5zaXRpb24uY2xvbmUoY2xvbmVkKQ0KICAgICAgKTsNCiAgICB9DQogICAgcmV0dXJuIGNsb25lZDsNCiAgfQ0KICBmdW5jdGlvbiBkZWVwQ2xvbmVWTm9kZSh2bm9kZSkgew0KICAgIGNvbnN0IGNsb25lZCA9IGNsb25lVk5vZGUodm5vZGUpOw0KICAgIGlmIChpc0FycmF5KHZub2RlLmNoaWxkcmVuKSkgew0KICAgICAgY2xvbmVkLmNoaWxkcmVuID0gdm5vZGUuY2hpbGRyZW4ubWFwKGRlZXBDbG9uZVZOb2RlKTsNCiAgICB9DQogICAgcmV0dXJuIGNsb25lZDsNCiAgfQ0KICBmdW5jdGlvbiBjcmVhdGVUZXh0Vk5vZGUodGV4dCA9ICIgIiwgZmxhZyA9IDApIHsNCiAgICByZXR1cm4gY3JlYXRlVk5vZGUoVGV4dCwgbnVsbCwgdGV4dCwgZmxhZyk7DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlU3RhdGljVk5vZGUoY29udGVudCwgbnVtYmVyT2ZOb2Rlcykgew0KICAgIGNvbnN0IHZub2RlID0gY3JlYXRlVk5vZGUoU3RhdGljLCBudWxsLCBjb250ZW50KTsNCiAgICB2bm9kZS5zdGF0aWNDb3VudCA9IG51bWJlck9mTm9kZXM7DQogICAgcmV0dXJuIHZub2RlOw0KICB9DQogIGZ1bmN0aW9uIGNyZWF0ZUNvbW1lbnRWTm9kZSh0ZXh0ID0gIiIsIGFzQmxvY2sgPSBmYWxzZSkgew0KICAgIHJldHVybiBhc0Jsb2NrID8gKG9wZW5CbG9jaygpLCBjcmVhdGVCbG9jayhDb21tZW50LCBudWxsLCB0ZXh0KSkgOiBjcmVhdGVWTm9kZShDb21tZW50LCBudWxsLCB0ZXh0KTsNCiAgfQ0KICBmdW5jdGlvbiBub3JtYWxpemVWTm9kZShjaGlsZCkgew0KICAgIGlmIChjaGlsZCA9PSBudWxsIHx8IHR5cGVvZiBjaGlsZCA9PT0gImJvb2xlYW4iKSB7DQogICAgICByZXR1cm4gY3JlYXRlVk5vZGUoQ29tbWVudCk7DQogICAgfSBlbHNlIGlmIChpc0FycmF5KGNoaWxkKSkgew0KICAgICAgcmV0dXJuIGNyZWF0ZVZOb2RlKA0KICAgICAgICBGcmFnbWVudCwNCiAgICAgICAgbnVsbCwNCiAgICAgICAgLy8gIzM2NjYsIGF2b2lkIHJlZmVyZW5jZSBwb2xsdXRpb24gd2hlbiByZXVzaW5nIHZub2RlDQogICAgICAgIGNoaWxkLnNsaWNlKCkNCiAgICAgICk7DQogICAgfSBlbHNlIGlmIChpc1ZOb2RlKGNoaWxkKSkgew0KICAgICAgcmV0dXJuIGNsb25lSWZNb3VudGVkKGNoaWxkKTsNCiAgICB9IGVsc2Ugew0KICAgICAgcmV0dXJuIGNyZWF0ZVZOb2RlKFRleHQsIG51bGwsIFN0cmluZyhjaGlsZCkpOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBjbG9uZUlmTW91bnRlZChjaGlsZCkgew0KICAgIHJldHVybiBjaGlsZC5lbCA9PT0gbnVsbCAmJiBjaGlsZC5wYXRjaEZsYWcgIT09IC0xIHx8IGNoaWxkLm1lbW8gPyBjaGlsZCA6IGNsb25lVk5vZGUoY2hpbGQpOw0KICB9DQogIGZ1bmN0aW9uIG5vcm1hbGl6ZUNoaWxkcmVuKHZub2RlLCBjaGlsZHJlbikgew0KICAgIGxldCB0eXBlID0gMDsNCiAgICBjb25zdCB7IHNoYXBlRmxhZyB9ID0gdm5vZGU7DQogICAgaWYgKGNoaWxkcmVuID09IG51bGwpIHsNCiAgICAgIGNoaWxkcmVuID0gbnVsbDsNCiAgICB9IGVsc2UgaWYgKGlzQXJyYXkoY2hpbGRyZW4pKSB7DQogICAgICB0eXBlID0gMTY7DQogICAgfSBlbHNlIGlmICh0eXBlb2YgY2hpbGRyZW4gPT09ICJvYmplY3QiKSB7DQogICAgICBpZiAoc2hhcGVGbGFnICYgKDEgfCA2NCkpIHsNCiAgICAgICAgY29uc3Qgc2xvdCA9IGNoaWxkcmVuLmRlZmF1bHQ7DQogICAgICAgIGlmIChzbG90KSB7DQogICAgICAgICAgc2xvdC5fYyAmJiAoc2xvdC5fZCA9IGZhbHNlKTsNCiAgICAgICAgICBub3JtYWxpemVDaGlsZHJlbih2bm9kZSwgc2xvdCgpKTsNCiAgICAgICAgICBzbG90Ll9jICYmIChzbG90Ll9kID0gdHJ1ZSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdHlwZSA9IDMyOw0KICAgICAgICBjb25zdCBzbG90RmxhZyA9IGNoaWxkcmVuLl87DQogICAgICAgIGlmICghc2xvdEZsYWcgJiYgIWlzSW50ZXJuYWxPYmplY3QoY2hpbGRyZW4pKSB7DQogICAgICAgICAgY2hpbGRyZW4uX2N0eCA9IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZTsNCiAgICAgICAgfSBlbHNlIGlmIChzbG90RmxhZyA9PT0gMyAmJiBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UpIHsNCiAgICAgICAgICBpZiAoY3VycmVudFJlbmRlcmluZ0luc3RhbmNlLnNsb3RzLl8gPT09IDEpIHsNCiAgICAgICAgICAgIGNoaWxkcmVuLl8gPSAxOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBjaGlsZHJlbi5fID0gMjsNCiAgICAgICAgICAgIHZub2RlLnBhdGNoRmxhZyB8PSAxMDI0Ow0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0gZWxzZSBpZiAoaXNGdW5jdGlvbihjaGlsZHJlbikpIHsNCiAgICAgIGNoaWxkcmVuID0geyBkZWZhdWx0OiBjaGlsZHJlbiwgX2N0eDogY3VycmVudFJlbmRlcmluZ0luc3RhbmNlIH07DQogICAgICB0eXBlID0gMzI7DQogICAgfSBlbHNlIHsNCiAgICAgIGNoaWxkcmVuID0gU3RyaW5nKGNoaWxkcmVuKTsNCiAgICAgIGlmIChzaGFwZUZsYWcgJiA2NCkgew0KICAgICAgICB0eXBlID0gMTY7DQogICAgICAgIGNoaWxkcmVuID0gW2NyZWF0ZVRleHRWTm9kZShjaGlsZHJlbildOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdHlwZSA9IDg7DQogICAgICB9DQogICAgfQ0KICAgIHZub2RlLmNoaWxkcmVuID0gY2hpbGRyZW47DQogICAgdm5vZGUuc2hhcGVGbGFnIHw9IHR5cGU7DQogIH0NCiAgZnVuY3Rpb24gbWVyZ2VQcm9wcyguLi5hcmdzKSB7DQogICAgY29uc3QgcmV0ID0ge307DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7DQogICAgICBjb25zdCB0b01lcmdlID0gYXJnc1tpXTsNCiAgICAgIGZvciAoY29uc3Qga2V5IGluIHRvTWVyZ2UpIHsNCiAgICAgICAgaWYgKGtleSA9PT0gImNsYXNzIikgew0KICAgICAgICAgIGlmIChyZXQuY2xhc3MgIT09IHRvTWVyZ2UuY2xhc3MpIHsNCiAgICAgICAgICAgIHJldC5jbGFzcyA9IG5vcm1hbGl6ZUNsYXNzKFtyZXQuY2xhc3MsIHRvTWVyZ2UuY2xhc3NdKTsNCiAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAic3R5bGUiKSB7DQogICAgICAgICAgcmV0LnN0eWxlID0gbm9ybWFsaXplU3R5bGUoW3JldC5zdHlsZSwgdG9NZXJnZS5zdHlsZV0pOw0KICAgICAgICB9IGVsc2UgaWYgKGlzT24oa2V5KSkgew0KICAgICAgICAgIGNvbnN0IGV4aXN0aW5nID0gcmV0W2tleV07DQogICAgICAgICAgY29uc3QgaW5jb21pbmcgPSB0b01lcmdlW2tleV07DQogICAgICAgICAgaWYgKGluY29taW5nICYmIGV4aXN0aW5nICE9PSBpbmNvbWluZyAmJiAhKGlzQXJyYXkoZXhpc3RpbmcpICYmIGV4aXN0aW5nLmluY2x1ZGVzKGluY29taW5nKSkpIHsNCiAgICAgICAgICAgIHJldFtrZXldID0gZXhpc3RpbmcgPyBbXS5jb25jYXQoZXhpc3RpbmcsIGluY29taW5nKSA6IGluY29taW5nOw0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIGlmIChrZXkgIT09ICIiKSB7DQogICAgICAgICAgcmV0W2tleV0gPSB0b01lcmdlW2tleV07DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHJldDsNCiAgfQ0KICBmdW5jdGlvbiBpbnZva2VWTm9kZUhvb2soaG9vaywgaW5zdGFuY2UsIHZub2RlLCBwcmV2Vk5vZGUgPSBudWxsKSB7DQogICAgY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoaG9vaywgaW5zdGFuY2UsIDcsIFsNCiAgICAgIHZub2RlLA0KICAgICAgcHJldlZOb2RlDQogICAgXSk7DQogIH0NCg0KICBjb25zdCBlbXB0eUFwcENvbnRleHQgPSBjcmVhdGVBcHBDb250ZXh0KCk7DQogIGxldCB1aWQgPSAwOw0KICBmdW5jdGlvbiBjcmVhdGVDb21wb25lbnRJbnN0YW5jZSh2bm9kZSwgcGFyZW50LCBzdXNwZW5zZSkgew0KICAgIGNvbnN0IHR5cGUgPSB2bm9kZS50eXBlOw0KICAgIGNvbnN0IGFwcENvbnRleHQgPSAocGFyZW50ID8gcGFyZW50LmFwcENvbnRleHQgOiB2bm9kZS5hcHBDb250ZXh0KSB8fCBlbXB0eUFwcENvbnRleHQ7DQogICAgY29uc3QgaW5zdGFuY2UgPSB7DQogICAgICB1aWQ6IHVpZCsrLA0KICAgICAgdm5vZGUsDQogICAgICB0eXBlLA0KICAgICAgcGFyZW50LA0KICAgICAgYXBwQ29udGV4dCwNCiAgICAgIHJvb3Q6IG51bGwsDQogICAgICAvLyB0byBiZSBpbW1lZGlhdGVseSBzZXQNCiAgICAgIG5leHQ6IG51bGwsDQogICAgICBzdWJUcmVlOiBudWxsLA0KICAgICAgLy8gd2lsbCBiZSBzZXQgc3luY2hyb25vdXNseSByaWdodCBhZnRlciBjcmVhdGlvbg0KICAgICAgZWZmZWN0OiBudWxsLA0KICAgICAgdXBkYXRlOiBudWxsLA0KICAgICAgLy8gd2lsbCBiZSBzZXQgc3luY2hyb25vdXNseSByaWdodCBhZnRlciBjcmVhdGlvbg0KICAgICAgam9iOiBudWxsLA0KICAgICAgc2NvcGU6IG5ldyBFZmZlY3RTY29wZSgNCiAgICAgICAgdHJ1ZQ0KICAgICAgICAvKiBkZXRhY2hlZCAqLw0KICAgICAgKSwNCiAgICAgIHJlbmRlcjogbnVsbCwNCiAgICAgIHByb3h5OiBudWxsLA0KICAgICAgZXhwb3NlZDogbnVsbCwNCiAgICAgIGV4cG9zZVByb3h5OiBudWxsLA0KICAgICAgd2l0aFByb3h5OiBudWxsLA0KICAgICAgcHJvdmlkZXM6IHBhcmVudCA/IHBhcmVudC5wcm92aWRlcyA6IE9iamVjdC5jcmVhdGUoYXBwQ29udGV4dC5wcm92aWRlcyksDQogICAgICBpZHM6IHBhcmVudCA/IHBhcmVudC5pZHMgOiBbIiIsIDAsIDBdLA0KICAgICAgYWNjZXNzQ2FjaGU6IG51bGwsDQogICAgICByZW5kZXJDYWNoZTogW10sDQogICAgICAvLyBsb2NhbCByZXNvbHZlZCBhc3NldHMNCiAgICAgIGNvbXBvbmVudHM6IG51bGwsDQogICAgICBkaXJlY3RpdmVzOiBudWxsLA0KICAgICAgLy8gcmVzb2x2ZWQgcHJvcHMgYW5kIGVtaXRzIG9wdGlvbnMNCiAgICAgIHByb3BzT3B0aW9uczogbm9ybWFsaXplUHJvcHNPcHRpb25zKHR5cGUsIGFwcENvbnRleHQpLA0KICAgICAgZW1pdHNPcHRpb25zOiBub3JtYWxpemVFbWl0c09wdGlvbnModHlwZSwgYXBwQ29udGV4dCksDQogICAgICAvLyBlbWl0DQogICAgICBlbWl0OiBudWxsLA0KICAgICAgLy8gdG8gYmUgc2V0IGltbWVkaWF0ZWx5DQogICAgICBlbWl0dGVkOiBudWxsLA0KICAgICAgLy8gcHJvcHMgZGVmYXVsdCB2YWx1ZQ0KICAgICAgcHJvcHNEZWZhdWx0czogRU1QVFlfT0JKLA0KICAgICAgLy8gaW5oZXJpdEF0dHJzDQogICAgICBpbmhlcml0QXR0cnM6IHR5cGUuaW5oZXJpdEF0dHJzLA0KICAgICAgLy8gc3RhdGUNCiAgICAgIGN0eDogRU1QVFlfT0JKLA0KICAgICAgZGF0YTogRU1QVFlfT0JKLA0KICAgICAgcHJvcHM6IEVNUFRZX09CSiwNCiAgICAgIGF0dHJzOiBFTVBUWV9PQkosDQogICAgICBzbG90czogRU1QVFlfT0JKLA0KICAgICAgcmVmczogRU1QVFlfT0JKLA0KICAgICAgc2V0dXBTdGF0ZTogRU1QVFlfT0JKLA0KICAgICAgc2V0dXBDb250ZXh0OiBudWxsLA0KICAgICAgLy8gc3VzcGVuc2UgcmVsYXRlZA0KICAgICAgc3VzcGVuc2UsDQogICAgICBzdXNwZW5zZUlkOiBzdXNwZW5zZSA/IHN1c3BlbnNlLnBlbmRpbmdJZCA6IDAsDQogICAgICBhc3luY0RlcDogbnVsbCwNCiAgICAgIGFzeW5jUmVzb2x2ZWQ6IGZhbHNlLA0KICAgICAgLy8gbGlmZWN5Y2xlIGhvb2tzDQogICAgICAvLyBub3QgdXNpbmcgZW51bXMgaGVyZSBiZWNhdXNlIGl0IHJlc3VsdHMgaW4gY29tcHV0ZWQgcHJvcGVydGllcw0KICAgICAgaXNNb3VudGVkOiBmYWxzZSwNCiAgICAgIGlzVW5tb3VudGVkOiBmYWxzZSwNCiAgICAgIGlzRGVhY3RpdmF0ZWQ6IGZhbHNlLA0KICAgICAgYmM6IG51bGwsDQogICAgICBjOiBudWxsLA0KICAgICAgYm06IG51bGwsDQogICAgICBtOiBudWxsLA0KICAgICAgYnU6IG51bGwsDQogICAgICB1OiBudWxsLA0KICAgICAgdW06IG51bGwsDQogICAgICBidW06IG51bGwsDQogICAgICBkYTogbnVsbCwNCiAgICAgIGE6IG51bGwsDQogICAgICBydGc6IG51bGwsDQogICAgICBydGM6IG51bGwsDQogICAgICBlYzogbnVsbCwNCiAgICAgIHNwOiBudWxsDQogICAgfTsNCiAgICB7DQogICAgICBpbnN0YW5jZS5jdHggPSBjcmVhdGVEZXZSZW5kZXJDb250ZXh0KGluc3RhbmNlKTsNCiAgICB9DQogICAgaW5zdGFuY2Uucm9vdCA9IHBhcmVudCA/IHBhcmVudC5yb290IDogaW5zdGFuY2U7DQogICAgaW5zdGFuY2UuZW1pdCA9IGVtaXQuYmluZChudWxsLCBpbnN0YW5jZSk7DQogICAgaWYgKHZub2RlLmNlKSB7DQogICAgICB2bm9kZS5jZShpbnN0YW5jZSk7DQogICAgfQ0KICAgIHJldHVybiBpbnN0YW5jZTsNCiAgfQ0KICBsZXQgY3VycmVudEluc3RhbmNlID0gbnVsbDsNCiAgY29uc3QgZ2V0Q3VycmVudEluc3RhbmNlID0gKCkgPT4gY3VycmVudEluc3RhbmNlIHx8IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZTsNCiAgbGV0IGludGVybmFsU2V0Q3VycmVudEluc3RhbmNlOw0KICBsZXQgc2V0SW5TU1JTZXR1cFN0YXRlOw0KICB7DQogICAgaW50ZXJuYWxTZXRDdXJyZW50SW5zdGFuY2UgPSAoaSkgPT4gew0KICAgICAgY3VycmVudEluc3RhbmNlID0gaTsNCiAgICB9Ow0KICAgIHNldEluU1NSU2V0dXBTdGF0ZSA9ICh2KSA9PiB7DQogICAgICBpc0luU1NSQ29tcG9uZW50U2V0dXAgPSB2Ow0KICAgIH07DQogIH0NCiAgY29uc3Qgc2V0Q3VycmVudEluc3RhbmNlID0gKGluc3RhbmNlKSA9PiB7DQogICAgY29uc3QgcHJldiA9IGN1cnJlbnRJbnN0YW5jZTsNCiAgICBpbnRlcm5hbFNldEN1cnJlbnRJbnN0YW5jZShpbnN0YW5jZSk7DQogICAgaW5zdGFuY2Uuc2NvcGUub24oKTsNCiAgICByZXR1cm4gKCkgPT4gew0KICAgICAgaW5zdGFuY2Uuc2NvcGUub2ZmKCk7DQogICAgICBpbnRlcm5hbFNldEN1cnJlbnRJbnN0YW5jZShwcmV2KTsNCiAgICB9Ow0KICB9Ow0KICBjb25zdCB1bnNldEN1cnJlbnRJbnN0YW5jZSA9ICgpID0+IHsNCiAgICBjdXJyZW50SW5zdGFuY2UgJiYgY3VycmVudEluc3RhbmNlLnNjb3BlLm9mZigpOw0KICAgIGludGVybmFsU2V0Q3VycmVudEluc3RhbmNlKG51bGwpOw0KICB9Ow0KICBjb25zdCBpc0J1aWx0SW5UYWcgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcCgic2xvdCxjb21wb25lbnQiKTsNCiAgZnVuY3Rpb24gdmFsaWRhdGVDb21wb25lbnROYW1lKG5hbWUsIHsgaXNOYXRpdmVUYWcgfSkgew0KICAgIGlmIChpc0J1aWx0SW5UYWcobmFtZSkgfHwgaXNOYXRpdmVUYWcobmFtZSkpIHsNCiAgICAgIHdhcm4kMSgNCiAgICAgICAgIkRvIG5vdCB1c2UgYnVpbHQtaW4gb3IgcmVzZXJ2ZWQgSFRNTCBlbGVtZW50cyBhcyBjb21wb25lbnQgaWQ6ICIgKyBuYW1lDQogICAgICApOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBpc1N0YXRlZnVsQ29tcG9uZW50KGluc3RhbmNlKSB7DQogICAgcmV0dXJuIGluc3RhbmNlLnZub2RlLnNoYXBlRmxhZyAmIDQ7DQogIH0NCiAgbGV0IGlzSW5TU1JDb21wb25lbnRTZXR1cCA9IGZhbHNlOw0KICBmdW5jdGlvbiBzZXR1cENvbXBvbmVudChpbnN0YW5jZSwgaXNTU1IgPSBmYWxzZSwgb3B0aW1pemVkID0gZmFsc2UpIHsNCiAgICBpc1NTUiAmJiBzZXRJblNTUlNldHVwU3RhdGUoaXNTU1IpOw0KICAgIGNvbnN0IHsgcHJvcHMsIGNoaWxkcmVuIH0gPSBpbnN0YW5jZS52bm9kZTsNCiAgICBjb25zdCBpc1N0YXRlZnVsID0gaXNTdGF0ZWZ1bENvbXBvbmVudChpbnN0YW5jZSk7DQogICAgaW5pdFByb3BzKGluc3RhbmNlLCBwcm9wcywgaXNTdGF0ZWZ1bCwgaXNTU1IpOw0KICAgIGluaXRTbG90cyhpbnN0YW5jZSwgY2hpbGRyZW4sIG9wdGltaXplZCB8fCBpc1NTUik7DQogICAgY29uc3Qgc2V0dXBSZXN1bHQgPSBpc1N0YXRlZnVsID8gc2V0dXBTdGF0ZWZ1bENvbXBvbmVudChpbnN0YW5jZSwgaXNTU1IpIDogdm9pZCAwOw0KICAgIGlzU1NSICYmIHNldEluU1NSU2V0dXBTdGF0ZShmYWxzZSk7DQogICAgcmV0dXJuIHNldHVwUmVzdWx0Ow0KICB9DQogIGZ1bmN0aW9uIHNldHVwU3RhdGVmdWxDb21wb25lbnQoaW5zdGFuY2UsIGlzU1NSKSB7DQogICAgdmFyIF9hOw0KICAgIGNvbnN0IENvbXBvbmVudCA9IGluc3RhbmNlLnR5cGU7DQogICAgew0KICAgICAgaWYgKENvbXBvbmVudC5uYW1lKSB7DQogICAgICAgIHZhbGlkYXRlQ29tcG9uZW50TmFtZShDb21wb25lbnQubmFtZSwgaW5zdGFuY2UuYXBwQ29udGV4dC5jb25maWcpOw0KICAgICAgfQ0KICAgICAgaWYgKENvbXBvbmVudC5jb21wb25lbnRzKSB7DQogICAgICAgIGNvbnN0IG5hbWVzID0gT2JqZWN0LmtleXMoQ29tcG9uZW50LmNvbXBvbmVudHMpOw0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgdmFsaWRhdGVDb21wb25lbnROYW1lKG5hbWVzW2ldLCBpbnN0YW5jZS5hcHBDb250ZXh0LmNvbmZpZyk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmIChDb21wb25lbnQuZGlyZWN0aXZlcykgew0KICAgICAgICBjb25zdCBuYW1lcyA9IE9iamVjdC5rZXlzKENvbXBvbmVudC5kaXJlY3RpdmVzKTsNCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuYW1lcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgIHZhbGlkYXRlRGlyZWN0aXZlTmFtZShuYW1lc1tpXSk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmIChDb21wb25lbnQuY29tcGlsZXJPcHRpb25zICYmIGlzUnVudGltZU9ubHkoKSkgew0KICAgICAgICB3YXJuJDEoDQogICAgICAgICAgYCJjb21waWxlck9wdGlvbnMiIGlzIG9ubHkgc3VwcG9ydGVkIHdoZW4gdXNpbmcgYSBidWlsZCBvZiBWdWUgdGhhdCBpbmNsdWRlcyB0aGUgcnVudGltZSBjb21waWxlci4gU2luY2UgeW91IGFyZSB1c2luZyBhIHJ1bnRpbWUtb25seSBidWlsZCwgdGhlIG9wdGlvbnMgc2hvdWxkIGJlIHBhc3NlZCB2aWEgeW91ciBidWlsZCB0b29sIGNvbmZpZyBpbnN0ZWFkLmANCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICB9DQogICAgaW5zdGFuY2UuYWNjZXNzQ2FjaGUgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsNCiAgICBpbnN0YW5jZS5wcm94eSA9IG5ldyBQcm94eShpbnN0YW5jZS5jdHgsIFB1YmxpY0luc3RhbmNlUHJveHlIYW5kbGVycyk7DQogICAgew0KICAgICAgZXhwb3NlUHJvcHNPblJlbmRlckNvbnRleHQoaW5zdGFuY2UpOw0KICAgIH0NCiAgICBjb25zdCB7IHNldHVwIH0gPSBDb21wb25lbnQ7DQogICAgaWYgKHNldHVwKSB7DQogICAgICBwYXVzZVRyYWNraW5nKCk7DQogICAgICBjb25zdCBzZXR1cENvbnRleHQgPSBpbnN0YW5jZS5zZXR1cENvbnRleHQgPSBzZXR1cC5sZW5ndGggPiAxID8gY3JlYXRlU2V0dXBDb250ZXh0KGluc3RhbmNlKSA6IG51bGw7DQogICAgICBjb25zdCByZXNldCA9IHNldEN1cnJlbnRJbnN0YW5jZShpbnN0YW5jZSk7DQogICAgICBjb25zdCBzZXR1cFJlc3VsdCA9IGNhbGxXaXRoRXJyb3JIYW5kbGluZygNCiAgICAgICAgc2V0dXAsDQogICAgICAgIGluc3RhbmNlLA0KICAgICAgICAwLA0KICAgICAgICBbDQogICAgICAgICAgc2hhbGxvd1JlYWRvbmx5KGluc3RhbmNlLnByb3BzKSAsDQogICAgICAgICAgc2V0dXBDb250ZXh0DQogICAgICAgIF0NCiAgICAgICk7DQogICAgICBjb25zdCBpc0FzeW5jU2V0dXAgPSBpc1Byb21pc2Uoc2V0dXBSZXN1bHQpOw0KICAgICAgcmVzZXRUcmFja2luZygpOw0KICAgICAgcmVzZXQoKTsNCiAgICAgIGlmICgoaXNBc3luY1NldHVwIHx8IGluc3RhbmNlLnNwKSAmJiAhaXNBc3luY1dyYXBwZXIoaW5zdGFuY2UpKSB7DQogICAgICAgIG1hcmtBc3luY0JvdW5kYXJ5KGluc3RhbmNlKTsNCiAgICAgIH0NCiAgICAgIGlmIChpc0FzeW5jU2V0dXApIHsNCiAgICAgICAgc2V0dXBSZXN1bHQudGhlbih1bnNldEN1cnJlbnRJbnN0YW5jZSwgdW5zZXRDdXJyZW50SW5zdGFuY2UpOw0KICAgICAgICBpZiAoaXNTU1IpIHsNCiAgICAgICAgICByZXR1cm4gc2V0dXBSZXN1bHQudGhlbigocmVzb2x2ZWRSZXN1bHQpID0+IHsNCiAgICAgICAgICAgIGhhbmRsZVNldHVwUmVzdWx0KGluc3RhbmNlLCByZXNvbHZlZFJlc3VsdCwgaXNTU1IpOw0KICAgICAgICAgIH0pLmNhdGNoKChlKSA9PiB7DQogICAgICAgICAgICBoYW5kbGVFcnJvcihlLCBpbnN0YW5jZSwgMCk7DQogICAgICAgICAgfSk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgaW5zdGFuY2UuYXN5bmNEZXAgPSBzZXR1cFJlc3VsdDsNCiAgICAgICAgICBpZiAoIWluc3RhbmNlLnN1c3BlbnNlKSB7DQogICAgICAgICAgICBjb25zdCBuYW1lID0gKF9hID0gQ29tcG9uZW50Lm5hbWUpICE9IG51bGwgPyBfYSA6ICJBbm9ueW1vdXMiOw0KICAgICAgICAgICAgd2FybiQxKA0KICAgICAgICAgICAgICBgQ29tcG9uZW50IDwke25hbWV9Pjogc2V0dXAgZnVuY3Rpb24gcmV0dXJuZWQgYSBwcm9taXNlLCBidXQgbm8gPFN1c3BlbnNlPiBib3VuZGFyeSB3YXMgZm91bmQgaW4gdGhlIHBhcmVudCBjb21wb25lbnQgdHJlZS4gQSBjb21wb25lbnQgd2l0aCBhc3luYyBzZXR1cCgpIG11c3QgYmUgbmVzdGVkIGluIGEgPFN1c3BlbnNlPiBpbiBvcmRlciB0byBiZSByZW5kZXJlZC5gDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgaGFuZGxlU2V0dXBSZXN1bHQoaW5zdGFuY2UsIHNldHVwUmVzdWx0LCBpc1NTUik7DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIGZpbmlzaENvbXBvbmVudFNldHVwKGluc3RhbmNlLCBpc1NTUik7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGhhbmRsZVNldHVwUmVzdWx0KGluc3RhbmNlLCBzZXR1cFJlc3VsdCwgaXNTU1IpIHsNCiAgICBpZiAoaXNGdW5jdGlvbihzZXR1cFJlc3VsdCkpIHsNCiAgICAgIHsNCiAgICAgICAgaW5zdGFuY2UucmVuZGVyID0gc2V0dXBSZXN1bHQ7DQogICAgICB9DQogICAgfSBlbHNlIGlmIChpc09iamVjdChzZXR1cFJlc3VsdCkpIHsNCiAgICAgIGlmIChpc1ZOb2RlKHNldHVwUmVzdWx0KSkgew0KICAgICAgICB3YXJuJDEoDQogICAgICAgICAgYHNldHVwKCkgc2hvdWxkIG5vdCByZXR1cm4gVk5vZGVzIGRpcmVjdGx5IC0gcmV0dXJuIGEgcmVuZGVyIGZ1bmN0aW9uIGluc3RlYWQuYA0KICAgICAgICApOw0KICAgICAgfQ0KICAgICAgew0KICAgICAgICBpbnN0YW5jZS5kZXZ0b29sc1Jhd1NldHVwU3RhdGUgPSBzZXR1cFJlc3VsdDsNCiAgICAgIH0NCiAgICAgIGluc3RhbmNlLnNldHVwU3RhdGUgPSBwcm94eVJlZnMoc2V0dXBSZXN1bHQpOw0KICAgICAgew0KICAgICAgICBleHBvc2VTZXR1cFN0YXRlT25SZW5kZXJDb250ZXh0KGluc3RhbmNlKTsNCiAgICAgIH0NCiAgICB9IGVsc2UgaWYgKHNldHVwUmVzdWx0ICE9PSB2b2lkIDApIHsNCiAgICAgIHdhcm4kMSgNCiAgICAgICAgYHNldHVwKCkgc2hvdWxkIHJldHVybiBhbiBvYmplY3QuIFJlY2VpdmVkOiAke3NldHVwUmVzdWx0ID09PSBudWxsID8gIm51bGwiIDogdHlwZW9mIHNldHVwUmVzdWx0fWANCiAgICAgICk7DQogICAgfQ0KICAgIGZpbmlzaENvbXBvbmVudFNldHVwKGluc3RhbmNlLCBpc1NTUik7DQogIH0NCiAgbGV0IGNvbXBpbGUkMTsNCiAgbGV0IGluc3RhbGxXaXRoUHJveHk7DQogIGZ1bmN0aW9uIHJlZ2lzdGVyUnVudGltZUNvbXBpbGVyKF9jb21waWxlKSB7DQogICAgY29tcGlsZSQxID0gX2NvbXBpbGU7DQogICAgaW5zdGFsbFdpdGhQcm94eSA9IChpKSA9PiB7DQogICAgICBpZiAoaS5yZW5kZXIuX3JjKSB7DQogICAgICAgIGkud2l0aFByb3h5ID0gbmV3IFByb3h5KGkuY3R4LCBSdW50aW1lQ29tcGlsZWRQdWJsaWNJbnN0YW5jZVByb3h5SGFuZGxlcnMpOw0KICAgICAgfQ0KICAgIH07DQogIH0NCiAgY29uc3QgaXNSdW50aW1lT25seSA9ICgpID0+ICFjb21waWxlJDE7DQogIGZ1bmN0aW9uIGZpbmlzaENvbXBvbmVudFNldHVwKGluc3RhbmNlLCBpc1NTUiwgc2tpcE9wdGlvbnMpIHsNCiAgICBjb25zdCBDb21wb25lbnQgPSBpbnN0YW5jZS50eXBlOw0KICAgIGlmICghaW5zdGFuY2UucmVuZGVyKSB7DQogICAgICBpZiAoIWlzU1NSICYmIGNvbXBpbGUkMSAmJiAhQ29tcG9uZW50LnJlbmRlcikgew0KICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IENvbXBvbmVudC50ZW1wbGF0ZSB8fCByZXNvbHZlTWVyZ2VkT3B0aW9ucyhpbnN0YW5jZSkudGVtcGxhdGU7DQogICAgICAgIGlmICh0ZW1wbGF0ZSkgew0KICAgICAgICAgIHsNCiAgICAgICAgICAgIHN0YXJ0TWVhc3VyZShpbnN0YW5jZSwgYGNvbXBpbGVgKTsNCiAgICAgICAgICB9DQogICAgICAgICAgY29uc3QgeyBpc0N1c3RvbUVsZW1lbnQsIGNvbXBpbGVyT3B0aW9ucyB9ID0gaW5zdGFuY2UuYXBwQ29udGV4dC5jb25maWc7DQogICAgICAgICAgY29uc3QgeyBkZWxpbWl0ZXJzLCBjb21waWxlck9wdGlvbnM6IGNvbXBvbmVudENvbXBpbGVyT3B0aW9ucyB9ID0gQ29tcG9uZW50Ow0KICAgICAgICAgIGNvbnN0IGZpbmFsQ29tcGlsZXJPcHRpb25zID0gZXh0ZW5kKA0KICAgICAgICAgICAgZXh0ZW5kKA0KICAgICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgaXNDdXN0b21FbGVtZW50LA0KICAgICAgICAgICAgICAgIGRlbGltaXRlcnMNCiAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgY29tcGlsZXJPcHRpb25zDQogICAgICAgICAgICApLA0KICAgICAgICAgICAgY29tcG9uZW50Q29tcGlsZXJPcHRpb25zDQogICAgICAgICAgKTsNCiAgICAgICAgICBDb21wb25lbnQucmVuZGVyID0gY29tcGlsZSQxKHRlbXBsYXRlLCBmaW5hbENvbXBpbGVyT3B0aW9ucyk7DQogICAgICAgICAgew0KICAgICAgICAgICAgZW5kTWVhc3VyZShpbnN0YW5jZSwgYGNvbXBpbGVgKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGluc3RhbmNlLnJlbmRlciA9IENvbXBvbmVudC5yZW5kZXIgfHwgTk9PUDsNCiAgICAgIGlmIChpbnN0YWxsV2l0aFByb3h5KSB7DQogICAgICAgIGluc3RhbGxXaXRoUHJveHkoaW5zdGFuY2UpOw0KICAgICAgfQ0KICAgIH0NCiAgICB7DQogICAgICBjb25zdCByZXNldCA9IHNldEN1cnJlbnRJbnN0YW5jZShpbnN0YW5jZSk7DQogICAgICBwYXVzZVRyYWNraW5nKCk7DQogICAgICB0cnkgew0KICAgICAgICBhcHBseU9wdGlvbnMoaW5zdGFuY2UpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgcmVzZXRUcmFja2luZygpOw0KICAgICAgICByZXNldCgpOw0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAoIUNvbXBvbmVudC5yZW5kZXIgJiYgaW5zdGFuY2UucmVuZGVyID09PSBOT09QICYmICFpc1NTUikgew0KICAgICAgaWYgKCFjb21waWxlJDEgJiYgQ29tcG9uZW50LnRlbXBsYXRlKSB7DQogICAgICAgIHdhcm4kMSgNCiAgICAgICAgICBgQ29tcG9uZW50IHByb3ZpZGVkIHRlbXBsYXRlIG9wdGlvbiBidXQgcnVudGltZSBjb21waWxhdGlvbiBpcyBub3Qgc3VwcG9ydGVkIGluIHRoaXMgYnVpbGQgb2YgVnVlLmAgKyAoYCBVc2UgInZ1ZS5nbG9iYWwuanMiIGluc3RlYWQuYCApDQogICAgICAgICk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB3YXJuJDEoYENvbXBvbmVudCBpcyBtaXNzaW5nIHRlbXBsYXRlIG9yIHJlbmRlciBmdW5jdGlvbjogYCwgQ29tcG9uZW50KTsNCiAgICAgIH0NCiAgICB9DQogIH0NCiAgY29uc3QgYXR0cnNQcm94eUhhbmRsZXJzID0gew0KICAgIGdldCh0YXJnZXQsIGtleSkgew0KICAgICAgbWFya0F0dHJzQWNjZXNzZWQoKTsNCiAgICAgIHRyYWNrKHRhcmdldCwgImdldCIsICIiKTsNCiAgICAgIHJldHVybiB0YXJnZXRba2V5XTsNCiAgICB9LA0KICAgIHNldCgpIHsNCiAgICAgIHdhcm4kMShgc2V0dXBDb250ZXh0LmF0dHJzIGlzIHJlYWRvbmx5LmApOw0KICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH0sDQogICAgZGVsZXRlUHJvcGVydHkoKSB7DQogICAgICB3YXJuJDEoYHNldHVwQ29udGV4dC5hdHRycyBpcyByZWFkb25seS5gKTsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQogIH0gOw0KICBmdW5jdGlvbiBnZXRTbG90c1Byb3h5KGluc3RhbmNlKSB7DQogICAgcmV0dXJuIG5ldyBQcm94eShpbnN0YW5jZS5zbG90cywgew0KICAgICAgZ2V0KHRhcmdldCwga2V5KSB7DQogICAgICAgIHRyYWNrKGluc3RhbmNlLCAiZ2V0IiwgIiRzbG90cyIpOw0KICAgICAgICByZXR1cm4gdGFyZ2V0W2tleV07DQogICAgICB9DQogICAgfSk7DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlU2V0dXBDb250ZXh0KGluc3RhbmNlKSB7DQogICAgY29uc3QgZXhwb3NlID0gKGV4cG9zZWQpID0+IHsNCiAgICAgIHsNCiAgICAgICAgaWYgKGluc3RhbmNlLmV4cG9zZWQpIHsNCiAgICAgICAgICB3YXJuJDEoYGV4cG9zZSgpIHNob3VsZCBiZSBjYWxsZWQgb25seSBvbmNlIHBlciBzZXR1cCgpLmApOw0KICAgICAgICB9DQogICAgICAgIGlmIChleHBvc2VkICE9IG51bGwpIHsNCiAgICAgICAgICBsZXQgZXhwb3NlZFR5cGUgPSB0eXBlb2YgZXhwb3NlZDsNCiAgICAgICAgICBpZiAoZXhwb3NlZFR5cGUgPT09ICJvYmplY3QiKSB7DQogICAgICAgICAgICBpZiAoaXNBcnJheShleHBvc2VkKSkgew0KICAgICAgICAgICAgICBleHBvc2VkVHlwZSA9ICJhcnJheSI7DQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzUmVmKGV4cG9zZWQpKSB7DQogICAgICAgICAgICAgIGV4cG9zZWRUeXBlID0gInJlZiI7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmIChleHBvc2VkVHlwZSAhPT0gIm9iamVjdCIpIHsNCiAgICAgICAgICAgIHdhcm4kMSgNCiAgICAgICAgICAgICAgYGV4cG9zZSgpIHNob3VsZCBiZSBwYXNzZWQgYSBwbGFpbiBvYmplY3QsIHJlY2VpdmVkICR7ZXhwb3NlZFR5cGV9LmANCiAgICAgICAgICAgICk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgICBpbnN0YW5jZS5leHBvc2VkID0gZXhwb3NlZCB8fCB7fTsNCiAgICB9Ow0KICAgIHsNCiAgICAgIGxldCBhdHRyc1Byb3h5Ow0KICAgICAgbGV0IHNsb3RzUHJveHk7DQogICAgICByZXR1cm4gT2JqZWN0LmZyZWV6ZSh7DQogICAgICAgIGdldCBhdHRycygpIHsNCiAgICAgICAgICByZXR1cm4gYXR0cnNQcm94eSB8fCAoYXR0cnNQcm94eSA9IG5ldyBQcm94eShpbnN0YW5jZS5hdHRycywgYXR0cnNQcm94eUhhbmRsZXJzKSk7DQogICAgICAgIH0sDQogICAgICAgIGdldCBzbG90cygpIHsNCiAgICAgICAgICByZXR1cm4gc2xvdHNQcm94eSB8fCAoc2xvdHNQcm94eSA9IGdldFNsb3RzUHJveHkoaW5zdGFuY2UpKTsNCiAgICAgICAgfSwNCiAgICAgICAgZ2V0IGVtaXQoKSB7DQogICAgICAgICAgcmV0dXJuIChldmVudCwgLi4uYXJncykgPT4gaW5zdGFuY2UuZW1pdChldmVudCwgLi4uYXJncyk7DQogICAgICAgIH0sDQogICAgICAgIGV4cG9zZQ0KICAgICAgfSk7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGdldENvbXBvbmVudFB1YmxpY0luc3RhbmNlKGluc3RhbmNlKSB7DQogICAgaWYgKGluc3RhbmNlLmV4cG9zZWQpIHsNCiAgICAgIHJldHVybiBpbnN0YW5jZS5leHBvc2VQcm94eSB8fCAoaW5zdGFuY2UuZXhwb3NlUHJveHkgPSBuZXcgUHJveHkocHJveHlSZWZzKG1hcmtSYXcoaW5zdGFuY2UuZXhwb3NlZCkpLCB7DQogICAgICAgIGdldCh0YXJnZXQsIGtleSkgew0KICAgICAgICAgIGlmIChrZXkgaW4gdGFyZ2V0KSB7DQogICAgICAgICAgICByZXR1cm4gdGFyZ2V0W2tleV07DQogICAgICAgICAgfSBlbHNlIGlmIChrZXkgaW4gcHVibGljUHJvcGVydGllc01hcCkgew0KICAgICAgICAgICAgcmV0dXJuIHB1YmxpY1Byb3BlcnRpZXNNYXBba2V5XShpbnN0YW5jZSk7DQogICAgICAgICAgfQ0KICAgICAgICB9LA0KICAgICAgICBoYXModGFyZ2V0LCBrZXkpIHsNCiAgICAgICAgICByZXR1cm4ga2V5IGluIHRhcmdldCB8fCBrZXkgaW4gcHVibGljUHJvcGVydGllc01hcDsNCiAgICAgICAgfQ0KICAgICAgfSkpOw0KICAgIH0gZWxzZSB7DQogICAgICByZXR1cm4gaW5zdGFuY2UucHJveHk7DQogICAgfQ0KICB9DQogIGNvbnN0IGNsYXNzaWZ5UkUgPSAvKD86XnxbLV9dKShcdykvZzsNCiAgY29uc3QgY2xhc3NpZnkgPSAoc3RyKSA9PiBzdHIucmVwbGFjZShjbGFzc2lmeVJFLCAoYykgPT4gYy50b1VwcGVyQ2FzZSgpKS5yZXBsYWNlKC9bLV9dL2csICIiKTsNCiAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZShDb21wb25lbnQsIGluY2x1ZGVJbmZlcnJlZCA9IHRydWUpIHsNCiAgICByZXR1cm4gaXNGdW5jdGlvbihDb21wb25lbnQpID8gQ29tcG9uZW50LmRpc3BsYXlOYW1lIHx8IENvbXBvbmVudC5uYW1lIDogQ29tcG9uZW50Lm5hbWUgfHwgaW5jbHVkZUluZmVycmVkICYmIENvbXBvbmVudC5fX25hbWU7DQogIH0NCiAgZnVuY3Rpb24gZm9ybWF0Q29tcG9uZW50TmFtZShpbnN0YW5jZSwgQ29tcG9uZW50LCBpc1Jvb3QgPSBmYWxzZSkgew0KICAgIGxldCBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZShDb21wb25lbnQpOw0KICAgIGlmICghbmFtZSAmJiBDb21wb25lbnQuX19maWxlKSB7DQogICAgICBjb25zdCBtYXRjaCA9IENvbXBvbmVudC5fX2ZpbGUubWF0Y2goLyhbXi9cXF0rKVwuXHcrJC8pOw0KICAgICAgaWYgKG1hdGNoKSB7DQogICAgICAgIG5hbWUgPSBtYXRjaFsxXTsNCiAgICAgIH0NCiAgICB9DQogICAgaWYgKCFuYW1lICYmIGluc3RhbmNlICYmIGluc3RhbmNlLnBhcmVudCkgew0KICAgICAgY29uc3QgaW5mZXJGcm9tUmVnaXN0cnkgPSAocmVnaXN0cnkpID0+IHsNCiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gcmVnaXN0cnkpIHsNCiAgICAgICAgICBpZiAocmVnaXN0cnlba2V5XSA9PT0gQ29tcG9uZW50KSB7DQogICAgICAgICAgICByZXR1cm4ga2V5Ow0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfTsNCiAgICAgIG5hbWUgPSBpbmZlckZyb21SZWdpc3RyeSgNCiAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50cyB8fCBpbnN0YW5jZS5wYXJlbnQudHlwZS5jb21wb25lbnRzDQogICAgICApIHx8IGluZmVyRnJvbVJlZ2lzdHJ5KGluc3RhbmNlLmFwcENvbnRleHQuY29tcG9uZW50cyk7DQogICAgfQ0KICAgIHJldHVybiBuYW1lID8gY2xhc3NpZnkobmFtZSkgOiBpc1Jvb3QgPyBgQXBwYCA6IGBBbm9ueW1vdXNgOw0KICB9DQogIGZ1bmN0aW9uIGlzQ2xhc3NDb21wb25lbnQodmFsdWUpIHsNCiAgICByZXR1cm4gaXNGdW5jdGlvbih2YWx1ZSkgJiYgIl9fdmNjT3B0cyIgaW4gdmFsdWU7DQogIH0NCg0KICBjb25zdCBjb21wdXRlZCA9IChnZXR0ZXJPck9wdGlvbnMsIGRlYnVnT3B0aW9ucykgPT4gew0KICAgIGNvbnN0IGMgPSBjb21wdXRlZCQxKGdldHRlck9yT3B0aW9ucywgZGVidWdPcHRpb25zLCBpc0luU1NSQ29tcG9uZW50U2V0dXApOw0KICAgIHsNCiAgICAgIGNvbnN0IGkgPSBnZXRDdXJyZW50SW5zdGFuY2UoKTsNCiAgICAgIGlmIChpICYmIGkuYXBwQ29udGV4dC5jb25maWcud2FyblJlY3Vyc2l2ZUNvbXB1dGVkKSB7DQogICAgICAgIGMuX3dhcm5SZWN1cnNpdmUgPSB0cnVlOw0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gYzsNCiAgfTsNCg0KICBmdW5jdGlvbiBoKHR5cGUsIHByb3BzT3JDaGlsZHJlbiwgY2hpbGRyZW4pIHsNCiAgICBjb25zdCBsID0gYXJndW1lbnRzLmxlbmd0aDsNCiAgICBpZiAobCA9PT0gMikgew0KICAgICAgaWYgKGlzT2JqZWN0KHByb3BzT3JDaGlsZHJlbikgJiYgIWlzQXJyYXkocHJvcHNPckNoaWxkcmVuKSkgew0KICAgICAgICBpZiAoaXNWTm9kZShwcm9wc09yQ2hpbGRyZW4pKSB7DQogICAgICAgICAgcmV0dXJuIGNyZWF0ZVZOb2RlKHR5cGUsIG51bGwsIFtwcm9wc09yQ2hpbGRyZW5dKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gY3JlYXRlVk5vZGUodHlwZSwgcHJvcHNPckNoaWxkcmVuKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiBjcmVhdGVWTm9kZSh0eXBlLCBudWxsLCBwcm9wc09yQ2hpbGRyZW4pOw0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICBpZiAobCA+IDMpIHsNCiAgICAgICAgY2hpbGRyZW4gPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOw0KICAgICAgfSBlbHNlIGlmIChsID09PSAzICYmIGlzVk5vZGUoY2hpbGRyZW4pKSB7DQogICAgICAgIGNoaWxkcmVuID0gW2NoaWxkcmVuXTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBjcmVhdGVWTm9kZSh0eXBlLCBwcm9wc09yQ2hpbGRyZW4sIGNoaWxkcmVuKTsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBpbml0Q3VzdG9tRm9ybWF0dGVyKCkgew0KICAgIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgew0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBjb25zdCB2dWVTdHlsZSA9IHsgc3R5bGU6ICJjb2xvcjojM2JhNzc2IiB9Ow0KICAgIGNvbnN0IG51bWJlclN0eWxlID0geyBzdHlsZTogImNvbG9yOiMxNjc3ZmYiIH07DQogICAgY29uc3Qgc3RyaW5nU3R5bGUgPSB7IHN0eWxlOiAiY29sb3I6I2Y1MjIyZCIgfTsNCiAgICBjb25zdCBrZXl3b3JkU3R5bGUgPSB7IHN0eWxlOiAiY29sb3I6I2ViMmY5NiIgfTsNCiAgICBjb25zdCBmb3JtYXR0ZXIgPSB7DQogICAgICBfX3Z1ZV9jdXN0b21fZm9ybWF0dGVyOiB0cnVlLA0KICAgICAgaGVhZGVyKG9iaikgew0KICAgICAgICBpZiAoIWlzT2JqZWN0KG9iaikpIHsNCiAgICAgICAgICByZXR1cm4gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob2JqLl9faXNWdWUpIHsNCiAgICAgICAgICByZXR1cm4gWyJkaXYiLCB2dWVTdHlsZSwgYFZ1ZUluc3RhbmNlYF07DQogICAgICAgIH0gZWxzZSBpZiAoaXNSZWYob2JqKSkgew0KICAgICAgICAgIHBhdXNlVHJhY2tpbmcoKTsNCiAgICAgICAgICBjb25zdCB2YWx1ZSA9IG9iai52YWx1ZTsNCiAgICAgICAgICByZXNldFRyYWNraW5nKCk7DQogICAgICAgICAgcmV0dXJuIFsNCiAgICAgICAgICAgICJkaXYiLA0KICAgICAgICAgICAge30sDQogICAgICAgICAgICBbInNwYW4iLCB2dWVTdHlsZSwgZ2VuUmVmRmxhZyhvYmopXSwNCiAgICAgICAgICAgICI8IiwNCiAgICAgICAgICAgIGZvcm1hdFZhbHVlKHZhbHVlKSwNCiAgICAgICAgICAgIGA+YA0KICAgICAgICAgIF07DQogICAgICAgIH0gZWxzZSBpZiAoaXNSZWFjdGl2ZShvYmopKSB7DQogICAgICAgICAgcmV0dXJuIFsNCiAgICAgICAgICAgICJkaXYiLA0KICAgICAgICAgICAge30sDQogICAgICAgICAgICBbInNwYW4iLCB2dWVTdHlsZSwgaXNTaGFsbG93KG9iaikgPyAiU2hhbGxvd1JlYWN0aXZlIiA6ICJSZWFjdGl2ZSJdLA0KICAgICAgICAgICAgIjwiLA0KICAgICAgICAgICAgZm9ybWF0VmFsdWUob2JqKSwNCiAgICAgICAgICAgIGA+JHtpc1JlYWRvbmx5KG9iaikgPyBgIChyZWFkb25seSlgIDogYGB9YA0KICAgICAgICAgIF07DQogICAgICAgIH0gZWxzZSBpZiAoaXNSZWFkb25seShvYmopKSB7DQogICAgICAgICAgcmV0dXJuIFsNCiAgICAgICAgICAgICJkaXYiLA0KICAgICAgICAgICAge30sDQogICAgICAgICAgICBbInNwYW4iLCB2dWVTdHlsZSwgaXNTaGFsbG93KG9iaikgPyAiU2hhbGxvd1JlYWRvbmx5IiA6ICJSZWFkb25seSJdLA0KICAgICAgICAgICAgIjwiLA0KICAgICAgICAgICAgZm9ybWF0VmFsdWUob2JqKSwNCiAgICAgICAgICAgICI+Ig0KICAgICAgICAgIF07DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICB9LA0KICAgICAgaGFzQm9keShvYmopIHsNCiAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouX19pc1Z1ZTsNCiAgICAgIH0sDQogICAgICBib2R5KG9iaikgew0KICAgICAgICBpZiAob2JqICYmIG9iai5fX2lzVnVlKSB7DQogICAgICAgICAgcmV0dXJuIFsNCiAgICAgICAgICAgICJkaXYiLA0KICAgICAgICAgICAge30sDQogICAgICAgICAgICAuLi5mb3JtYXRJbnN0YW5jZShvYmouJCkNCiAgICAgICAgICBdOw0KICAgICAgICB9DQogICAgICB9DQogICAgfTsNCiAgICBmdW5jdGlvbiBmb3JtYXRJbnN0YW5jZShpbnN0YW5jZSkgew0KICAgICAgY29uc3QgYmxvY2tzID0gW107DQogICAgICBpZiAoaW5zdGFuY2UudHlwZS5wcm9wcyAmJiBpbnN0YW5jZS5wcm9wcykgew0KICAgICAgICBibG9ja3MucHVzaChjcmVhdGVJbnN0YW5jZUJsb2NrKCJwcm9wcyIsIHRvUmF3KGluc3RhbmNlLnByb3BzKSkpOw0KICAgICAgfQ0KICAgICAgaWYgKGluc3RhbmNlLnNldHVwU3RhdGUgIT09IEVNUFRZX09CSikgew0KICAgICAgICBibG9ja3MucHVzaChjcmVhdGVJbnN0YW5jZUJsb2NrKCJzZXR1cCIsIGluc3RhbmNlLnNldHVwU3RhdGUpKTsNCiAgICAgIH0NCiAgICAgIGlmIChpbnN0YW5jZS5kYXRhICE9PSBFTVBUWV9PQkopIHsNCiAgICAgICAgYmxvY2tzLnB1c2goY3JlYXRlSW5zdGFuY2VCbG9jaygiZGF0YSIsIHRvUmF3KGluc3RhbmNlLmRhdGEpKSk7DQogICAgICB9DQogICAgICBjb25zdCBjb21wdXRlZCA9IGV4dHJhY3RLZXlzKGluc3RhbmNlLCAiY29tcHV0ZWQiKTsNCiAgICAgIGlmIChjb21wdXRlZCkgew0KICAgICAgICBibG9ja3MucHVzaChjcmVhdGVJbnN0YW5jZUJsb2NrKCJjb21wdXRlZCIsIGNvbXB1dGVkKSk7DQogICAgICB9DQogICAgICBjb25zdCBpbmplY3RlZCA9IGV4dHJhY3RLZXlzKGluc3RhbmNlLCAiaW5qZWN0Iik7DQogICAgICBpZiAoaW5qZWN0ZWQpIHsNCiAgICAgICAgYmxvY2tzLnB1c2goY3JlYXRlSW5zdGFuY2VCbG9jaygiaW5qZWN0ZWQiLCBpbmplY3RlZCkpOw0KICAgICAgfQ0KICAgICAgYmxvY2tzLnB1c2goWw0KICAgICAgICAiZGl2IiwNCiAgICAgICAge30sDQogICAgICAgIFsNCiAgICAgICAgICAic3BhbiIsDQogICAgICAgICAgew0KICAgICAgICAgICAgc3R5bGU6IGtleXdvcmRTdHlsZS5zdHlsZSArICI7b3BhY2l0eTowLjY2Ig0KICAgICAgICAgIH0sDQogICAgICAgICAgIiQgKGludGVybmFsKTogIg0KICAgICAgICBdLA0KICAgICAgICBbIm9iamVjdCIsIHsgb2JqZWN0OiBpbnN0YW5jZSB9XQ0KICAgICAgXSk7DQogICAgICByZXR1cm4gYmxvY2tzOw0KICAgIH0NCiAgICBmdW5jdGlvbiBjcmVhdGVJbnN0YW5jZUJsb2NrKHR5cGUsIHRhcmdldCkgew0KICAgICAgdGFyZ2V0ID0gZXh0ZW5kKHt9LCB0YXJnZXQpOw0KICAgICAgaWYgKCFPYmplY3Qua2V5cyh0YXJnZXQpLmxlbmd0aCkgew0KICAgICAgICByZXR1cm4gWyJzcGFuIiwge31dOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIFsNCiAgICAgICAgImRpdiIsDQogICAgICAgIHsgc3R5bGU6ICJsaW5lLWhlaWdodDoxLjI1ZW07bWFyZ2luLWJvdHRvbTowLjZlbSIgfSwNCiAgICAgICAgWw0KICAgICAgICAgICJkaXYiLA0KICAgICAgICAgIHsNCiAgICAgICAgICAgIHN0eWxlOiAiY29sb3I6IzQ3NjU4MiINCiAgICAgICAgICB9LA0KICAgICAgICAgIHR5cGUNCiAgICAgICAgXSwNCiAgICAgICAgWw0KICAgICAgICAgICJkaXYiLA0KICAgICAgICAgIHsNCiAgICAgICAgICAgIHN0eWxlOiAicGFkZGluZy1sZWZ0OjEuMjVlbSINCiAgICAgICAgICB9LA0KICAgICAgICAgIC4uLk9iamVjdC5rZXlzKHRhcmdldCkubWFwKChrZXkpID0+IHsNCiAgICAgICAgICAgIHJldHVybiBbDQogICAgICAgICAgICAgICJkaXYiLA0KICAgICAgICAgICAgICB7fSwNCiAgICAgICAgICAgICAgWyJzcGFuIiwga2V5d29yZFN0eWxlLCBrZXkgKyAiOiAiXSwNCiAgICAgICAgICAgICAgZm9ybWF0VmFsdWUodGFyZ2V0W2tleV0sIGZhbHNlKQ0KICAgICAgICAgICAgXTsNCiAgICAgICAgICB9KQ0KICAgICAgICBdDQogICAgICBdOw0KICAgIH0NCiAgICBmdW5jdGlvbiBmb3JtYXRWYWx1ZSh2LCBhc1JhdyA9IHRydWUpIHsNCiAgICAgIGlmICh0eXBlb2YgdiA9PT0gIm51bWJlciIpIHsNCiAgICAgICAgcmV0dXJuIFsic3BhbiIsIG51bWJlclN0eWxlLCB2XTsNCiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHYgPT09ICJzdHJpbmciKSB7DQogICAgICAgIHJldHVybiBbInNwYW4iLCBzdHJpbmdTdHlsZSwgSlNPTi5zdHJpbmdpZnkodildOw0KICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdiA9PT0gImJvb2xlYW4iKSB7DQogICAgICAgIHJldHVybiBbInNwYW4iLCBrZXl3b3JkU3R5bGUsIHZdOw0KICAgICAgfSBlbHNlIGlmIChpc09iamVjdCh2KSkgew0KICAgICAgICByZXR1cm4gWyJvYmplY3QiLCB7IG9iamVjdDogYXNSYXcgPyB0b1Jhdyh2KSA6IHYgfV07DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gWyJzcGFuIiwgc3RyaW5nU3R5bGUsIFN0cmluZyh2KV07DQogICAgICB9DQogICAgfQ0KICAgIGZ1bmN0aW9uIGV4dHJhY3RLZXlzKGluc3RhbmNlLCB0eXBlKSB7DQogICAgICBjb25zdCBDb21wID0gaW5zdGFuY2UudHlwZTsNCiAgICAgIGlmIChpc0Z1bmN0aW9uKENvbXApKSB7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIGNvbnN0IGV4dHJhY3RlZCA9IHt9Ow0KICAgICAgZm9yIChjb25zdCBrZXkgaW4gaW5zdGFuY2UuY3R4KSB7DQogICAgICAgIGlmIChpc0tleU9mVHlwZShDb21wLCBrZXksIHR5cGUpKSB7DQogICAgICAgICAgZXh0cmFjdGVkW2tleV0gPSBpbnN0YW5jZS5jdHhba2V5XTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcmV0dXJuIGV4dHJhY3RlZDsNCiAgICB9DQogICAgZnVuY3Rpb24gaXNLZXlPZlR5cGUoQ29tcCwga2V5LCB0eXBlKSB7DQogICAgICBjb25zdCBvcHRzID0gQ29tcFt0eXBlXTsNCiAgICAgIGlmIChpc0FycmF5KG9wdHMpICYmIG9wdHMuaW5jbHVkZXMoa2V5KSB8fCBpc09iamVjdChvcHRzKSAmJiBrZXkgaW4gb3B0cykgew0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIGlmIChDb21wLmV4dGVuZHMgJiYgaXNLZXlPZlR5cGUoQ29tcC5leHRlbmRzLCBrZXksIHR5cGUpKSB7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfQ0KICAgICAgaWYgKENvbXAubWl4aW5zICYmIENvbXAubWl4aW5zLnNvbWUoKG0pID0+IGlzS2V5T2ZUeXBlKG0sIGtleSwgdHlwZSkpKSB7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfQ0KICAgIH0NCiAgICBmdW5jdGlvbiBnZW5SZWZGbGFnKHYpIHsNCiAgICAgIGlmIChpc1NoYWxsb3codikpIHsNCiAgICAgICAgcmV0dXJuIGBTaGFsbG93UmVmYDsNCiAgICAgIH0NCiAgICAgIGlmICh2LmVmZmVjdCkgew0KICAgICAgICByZXR1cm4gYENvbXB1dGVkUmVmYDsNCiAgICAgIH0NCiAgICAgIHJldHVybiBgUmVmYDsNCiAgICB9DQogICAgaWYgKHdpbmRvdy5kZXZ0b29sc0Zvcm1hdHRlcnMpIHsNCiAgICAgIHdpbmRvdy5kZXZ0b29sc0Zvcm1hdHRlcnMucHVzaChmb3JtYXR0ZXIpOw0KICAgIH0gZWxzZSB7DQogICAgICB3aW5kb3cuZGV2dG9vbHNGb3JtYXR0ZXJzID0gW2Zvcm1hdHRlcl07DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gd2l0aE1lbW8obWVtbywgcmVuZGVyLCBjYWNoZSwgaW5kZXgpIHsNCiAgICBjb25zdCBjYWNoZWQgPSBjYWNoZVtpbmRleF07DQogICAgaWYgKGNhY2hlZCAmJiBpc01lbW9TYW1lKGNhY2hlZCwgbWVtbykpIHsNCiAgICAgIHJldHVybiBjYWNoZWQ7DQogICAgfQ0KICAgIGNvbnN0IHJldCA9IHJlbmRlcigpOw0KICAgIHJldC5tZW1vID0gbWVtby5zbGljZSgpOw0KICAgIHJldC5jYWNoZUluZGV4ID0gaW5kZXg7DQogICAgcmV0dXJuIGNhY2hlW2luZGV4XSA9IHJldDsNCiAgfQ0KICBmdW5jdGlvbiBpc01lbW9TYW1lKGNhY2hlZCwgbWVtbykgew0KICAgIGNvbnN0IHByZXYgPSBjYWNoZWQubWVtbzsNCiAgICBpZiAocHJldi5sZW5ndGggIT0gbWVtby5sZW5ndGgpIHsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcmV2Lmxlbmd0aDsgaSsrKSB7DQogICAgICBpZiAoaGFzQ2hhbmdlZChwcmV2W2ldLCBtZW1vW2ldKSkgew0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICB9DQogICAgfQ0KICAgIGlmIChpc0Jsb2NrVHJlZUVuYWJsZWQgPiAwICYmIGN1cnJlbnRCbG9jaykgew0KICAgICAgY3VycmVudEJsb2NrLnB1c2goY2FjaGVkKTsNCiAgICB9DQogICAgcmV0dXJuIHRydWU7DQogIH0NCg0KICBjb25zdCB2ZXJzaW9uID0gIjMuNS4xNyI7DQogIGNvbnN0IHdhcm4gPSB3YXJuJDEgOw0KICBjb25zdCBFcnJvclR5cGVTdHJpbmdzID0gRXJyb3JUeXBlU3RyaW5ncyQxIDsNCiAgY29uc3QgZGV2dG9vbHMgPSBkZXZ0b29scyQxIDsNCiAgY29uc3Qgc2V0RGV2dG9vbHNIb29rID0gc2V0RGV2dG9vbHNIb29rJDEgOw0KICBjb25zdCBzc3JVdGlscyA9IG51bGw7DQogIGNvbnN0IHJlc29sdmVGaWx0ZXIgPSBudWxsOw0KICBjb25zdCBjb21wYXRVdGlscyA9IG51bGw7DQogIGNvbnN0IERlcHJlY2F0aW9uVHlwZXMgPSBudWxsOw0KDQogIGxldCBwb2xpY3kgPSB2b2lkIDA7DQogIGNvbnN0IHR0ID0gdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LnRydXN0ZWRUeXBlczsNCiAgaWYgKHR0KSB7DQogICAgdHJ5IHsNCiAgICAgIHBvbGljeSA9IC8qIEBfX1BVUkVfXyAqLyB0dC5jcmVhdGVQb2xpY3koInZ1ZSIsIHsNCiAgICAgICAgY3JlYXRlSFRNTDogKHZhbCkgPT4gdmFsDQogICAgICB9KTsNCiAgICB9IGNhdGNoIChlKSB7DQogICAgICB3YXJuKGBFcnJvciBjcmVhdGluZyB0cnVzdGVkIHR5cGVzIHBvbGljeTogJHtlfWApOw0KICAgIH0NCiAgfQ0KICBjb25zdCB1bnNhZmVUb1RydXN0ZWRIVE1MID0gcG9saWN5ID8gKHZhbCkgPT4gcG9saWN5LmNyZWF0ZUhUTUwodmFsKSA6ICh2YWwpID0+IHZhbDsNCiAgY29uc3Qgc3ZnTlMgPSAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciOw0KICBjb25zdCBtYXRobWxOUyA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk4L01hdGgvTWF0aE1MIjsNCiAgY29uc3QgZG9jID0gdHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiA/IGRvY3VtZW50IDogbnVsbDsNCiAgY29uc3QgdGVtcGxhdGVDb250YWluZXIgPSBkb2MgJiYgLyogQF9fUFVSRV9fICovIGRvYy5jcmVhdGVFbGVtZW50KCJ0ZW1wbGF0ZSIpOw0KICBjb25zdCBub2RlT3BzID0gew0KICAgIGluc2VydDogKGNoaWxkLCBwYXJlbnQsIGFuY2hvcikgPT4gew0KICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShjaGlsZCwgYW5jaG9yIHx8IG51bGwpOw0KICAgIH0sDQogICAgcmVtb3ZlOiAoY2hpbGQpID0+IHsNCiAgICAgIGNvbnN0IHBhcmVudCA9IGNoaWxkLnBhcmVudE5vZGU7DQogICAgICBpZiAocGFyZW50KSB7DQogICAgICAgIHBhcmVudC5yZW1vdmVDaGlsZChjaGlsZCk7DQogICAgICB9DQogICAgfSwNCiAgICBjcmVhdGVFbGVtZW50OiAodGFnLCBuYW1lc3BhY2UsIGlzLCBwcm9wcykgPT4gew0KICAgICAgY29uc3QgZWwgPSBuYW1lc3BhY2UgPT09ICJzdmciID8gZG9jLmNyZWF0ZUVsZW1lbnROUyhzdmdOUywgdGFnKSA6IG5hbWVzcGFjZSA9PT0gIm1hdGhtbCIgPyBkb2MuY3JlYXRlRWxlbWVudE5TKG1hdGhtbE5TLCB0YWcpIDogaXMgPyBkb2MuY3JlYXRlRWxlbWVudCh0YWcsIHsgaXMgfSkgOiBkb2MuY3JlYXRlRWxlbWVudCh0YWcpOw0KICAgICAgaWYgKHRhZyA9PT0gInNlbGVjdCIgJiYgcHJvcHMgJiYgcHJvcHMubXVsdGlwbGUgIT0gbnVsbCkgew0KICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoIm11bHRpcGxlIiwgcHJvcHMubXVsdGlwbGUpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIGVsOw0KICAgIH0sDQogICAgY3JlYXRlVGV4dDogKHRleHQpID0+IGRvYy5jcmVhdGVUZXh0Tm9kZSh0ZXh0KSwNCiAgICBjcmVhdGVDb21tZW50OiAodGV4dCkgPT4gZG9jLmNyZWF0ZUNvbW1lbnQodGV4dCksDQogICAgc2V0VGV4dDogKG5vZGUsIHRleHQpID0+IHsNCiAgICAgIG5vZGUubm9kZVZhbHVlID0gdGV4dDsNCiAgICB9LA0KICAgIHNldEVsZW1lbnRUZXh0OiAoZWwsIHRleHQpID0+IHsNCiAgICAgIGVsLnRleHRDb250ZW50ID0gdGV4dDsNCiAgICB9LA0KICAgIHBhcmVudE5vZGU6IChub2RlKSA9PiBub2RlLnBhcmVudE5vZGUsDQogICAgbmV4dFNpYmxpbmc6IChub2RlKSA9PiBub2RlLm5leHRTaWJsaW5nLA0KICAgIHF1ZXJ5U2VsZWN0b3I6IChzZWxlY3RvcikgPT4gZG9jLnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpLA0KICAgIHNldFNjb3BlSWQoZWwsIGlkKSB7DQogICAgICBlbC5zZXRBdHRyaWJ1dGUoaWQsICIiKTsNCiAgICB9LA0KICAgIC8vIF9fVU5TQUZFX18NCiAgICAvLyBSZWFzb246IGlubmVySFRNTC4NCiAgICAvLyBTdGF0aWMgY29udGVudCBoZXJlIGNhbiBvbmx5IGNvbWUgZnJvbSBjb21waWxlZCB0ZW1wbGF0ZXMuDQogICAgLy8gQXMgbG9uZyBhcyB0aGUgdXNlciBvbmx5IHVzZXMgdHJ1c3RlZCB0ZW1wbGF0ZXMsIHRoaXMgaXMgc2FmZS4NCiAgICBpbnNlcnRTdGF0aWNDb250ZW50KGNvbnRlbnQsIHBhcmVudCwgYW5jaG9yLCBuYW1lc3BhY2UsIHN0YXJ0LCBlbmQpIHsNCiAgICAgIGNvbnN0IGJlZm9yZSA9IGFuY2hvciA/IGFuY2hvci5wcmV2aW91c1NpYmxpbmcgOiBwYXJlbnQubGFzdENoaWxkOw0KICAgICAgaWYgKHN0YXJ0ICYmIChzdGFydCA9PT0gZW5kIHx8IHN0YXJ0Lm5leHRTaWJsaW5nKSkgew0KICAgICAgICB3aGlsZSAodHJ1ZSkgew0KICAgICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUoc3RhcnQuY2xvbmVOb2RlKHRydWUpLCBhbmNob3IpOw0KICAgICAgICAgIGlmIChzdGFydCA9PT0gZW5kIHx8ICEoc3RhcnQgPSBzdGFydC5uZXh0U2libGluZykpIGJyZWFrOw0KICAgICAgICB9DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0ZW1wbGF0ZUNvbnRhaW5lci5pbm5lckhUTUwgPSB1bnNhZmVUb1RydXN0ZWRIVE1MKA0KICAgICAgICAgIG5hbWVzcGFjZSA9PT0gInN2ZyIgPyBgPHN2Zz4ke2NvbnRlbnR9PC9zdmc+YCA6IG5hbWVzcGFjZSA9PT0gIm1hdGhtbCIgPyBgPG1hdGg+JHtjb250ZW50fTwvbWF0aD5gIDogY29udGVudA0KICAgICAgICApOw0KICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IHRlbXBsYXRlQ29udGFpbmVyLmNvbnRlbnQ7DQogICAgICAgIGlmIChuYW1lc3BhY2UgPT09ICJzdmciIHx8IG5hbWVzcGFjZSA9PT0gIm1hdGhtbCIpIHsNCiAgICAgICAgICBjb25zdCB3cmFwcGVyID0gdGVtcGxhdGUuZmlyc3RDaGlsZDsNCiAgICAgICAgICB3aGlsZSAod3JhcHBlci5maXJzdENoaWxkKSB7DQogICAgICAgICAgICB0ZW1wbGF0ZS5hcHBlbmRDaGlsZCh3cmFwcGVyLmZpcnN0Q2hpbGQpOw0KICAgICAgICAgIH0NCiAgICAgICAgICB0ZW1wbGF0ZS5yZW1vdmVDaGlsZCh3cmFwcGVyKTsNCiAgICAgICAgfQ0KICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKHRlbXBsYXRlLCBhbmNob3IpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIFsNCiAgICAgICAgLy8gZmlyc3QNCiAgICAgICAgYmVmb3JlID8gYmVmb3JlLm5leHRTaWJsaW5nIDogcGFyZW50LmZpcnN0Q2hpbGQsDQogICAgICAgIC8vIGxhc3QNCiAgICAgICAgYW5jaG9yID8gYW5jaG9yLnByZXZpb3VzU2libGluZyA6IHBhcmVudC5sYXN0Q2hpbGQNCiAgICAgIF07DQogICAgfQ0KICB9Ow0KDQogIGNvbnN0IFRSQU5TSVRJT04kMSA9ICJ0cmFuc2l0aW9uIjsNCiAgY29uc3QgQU5JTUFUSU9OID0gImFuaW1hdGlvbiI7DQogIGNvbnN0IHZ0Y0tleSA9IFN5bWJvbCgiX3Z0YyIpOw0KICBjb25zdCBET01UcmFuc2l0aW9uUHJvcHNWYWxpZGF0b3JzID0gew0KICAgIG5hbWU6IFN0cmluZywNCiAgICB0eXBlOiBTdHJpbmcsDQogICAgY3NzOiB7DQogICAgICB0eXBlOiBCb29sZWFuLA0KICAgICAgZGVmYXVsdDogdHJ1ZQ0KICAgIH0sDQogICAgZHVyYXRpb246IFtTdHJpbmcsIE51bWJlciwgT2JqZWN0XSwNCiAgICBlbnRlckZyb21DbGFzczogU3RyaW5nLA0KICAgIGVudGVyQWN0aXZlQ2xhc3M6IFN0cmluZywNCiAgICBlbnRlclRvQ2xhc3M6IFN0cmluZywNCiAgICBhcHBlYXJGcm9tQ2xhc3M6IFN0cmluZywNCiAgICBhcHBlYXJBY3RpdmVDbGFzczogU3RyaW5nLA0KICAgIGFwcGVhclRvQ2xhc3M6IFN0cmluZywNCiAgICBsZWF2ZUZyb21DbGFzczogU3RyaW5nLA0KICAgIGxlYXZlQWN0aXZlQ2xhc3M6IFN0cmluZywNCiAgICBsZWF2ZVRvQ2xhc3M6IFN0cmluZw0KICB9Ow0KICBjb25zdCBUcmFuc2l0aW9uUHJvcHNWYWxpZGF0b3JzID0gLyogQF9fUFVSRV9fICovIGV4dGVuZCgNCiAgICB7fSwNCiAgICBCYXNlVHJhbnNpdGlvblByb3BzVmFsaWRhdG9ycywNCiAgICBET01UcmFuc2l0aW9uUHJvcHNWYWxpZGF0b3JzDQogICk7DQogIGNvbnN0IGRlY29yYXRlJDEgPSAodCkgPT4gew0KICAgIHQuZGlzcGxheU5hbWUgPSAiVHJhbnNpdGlvbiI7DQogICAgdC5wcm9wcyA9IFRyYW5zaXRpb25Qcm9wc1ZhbGlkYXRvcnM7DQogICAgcmV0dXJuIHQ7DQogIH07DQogIGNvbnN0IFRyYW5zaXRpb24gPSAvKiBAX19QVVJFX18gKi8gZGVjb3JhdGUkMSgNCiAgICAocHJvcHMsIHsgc2xvdHMgfSkgPT4gaChCYXNlVHJhbnNpdGlvbiwgcmVzb2x2ZVRyYW5zaXRpb25Qcm9wcyhwcm9wcyksIHNsb3RzKQ0KICApOw0KICBjb25zdCBjYWxsSG9vayA9IChob29rLCBhcmdzID0gW10pID0+IHsNCiAgICBpZiAoaXNBcnJheShob29rKSkgew0KICAgICAgaG9vay5mb3JFYWNoKChoMikgPT4gaDIoLi4uYXJncykpOw0KICAgIH0gZWxzZSBpZiAoaG9vaykgew0KICAgICAgaG9vayguLi5hcmdzKTsNCiAgICB9DQogIH07DQogIGNvbnN0IGhhc0V4cGxpY2l0Q2FsbGJhY2sgPSAoaG9vaykgPT4gew0KICAgIHJldHVybiBob29rID8gaXNBcnJheShob29rKSA/IGhvb2suc29tZSgoaDIpID0+IGgyLmxlbmd0aCA+IDEpIDogaG9vay5sZW5ndGggPiAxIDogZmFsc2U7DQogIH07DQogIGZ1bmN0aW9uIHJlc29sdmVUcmFuc2l0aW9uUHJvcHMocmF3UHJvcHMpIHsNCiAgICBjb25zdCBiYXNlUHJvcHMgPSB7fTsNCiAgICBmb3IgKGNvbnN0IGtleSBpbiByYXdQcm9wcykgew0KICAgICAgaWYgKCEoa2V5IGluIERPTVRyYW5zaXRpb25Qcm9wc1ZhbGlkYXRvcnMpKSB7DQogICAgICAgIGJhc2VQcm9wc1trZXldID0gcmF3UHJvcHNba2V5XTsNCiAgICAgIH0NCiAgICB9DQogICAgaWYgKHJhd1Byb3BzLmNzcyA9PT0gZmFsc2UpIHsNCiAgICAgIHJldHVybiBiYXNlUHJvcHM7DQogICAgfQ0KICAgIGNvbnN0IHsNCiAgICAgIG5hbWUgPSAidiIsDQogICAgICB0eXBlLA0KICAgICAgZHVyYXRpb24sDQogICAgICBlbnRlckZyb21DbGFzcyA9IGAke25hbWV9LWVudGVyLWZyb21gLA0KICAgICAgZW50ZXJBY3RpdmVDbGFzcyA9IGAke25hbWV9LWVudGVyLWFjdGl2ZWAsDQogICAgICBlbnRlclRvQ2xhc3MgPSBgJHtuYW1lfS1lbnRlci10b2AsDQogICAgICBhcHBlYXJGcm9tQ2xhc3MgPSBlbnRlckZyb21DbGFzcywNCiAgICAgIGFwcGVhckFjdGl2ZUNsYXNzID0gZW50ZXJBY3RpdmVDbGFzcywNCiAgICAgIGFwcGVhclRvQ2xhc3MgPSBlbnRlclRvQ2xhc3MsDQogICAgICBsZWF2ZUZyb21DbGFzcyA9IGAke25hbWV9LWxlYXZlLWZyb21gLA0KICAgICAgbGVhdmVBY3RpdmVDbGFzcyA9IGAke25hbWV9LWxlYXZlLWFjdGl2ZWAsDQogICAgICBsZWF2ZVRvQ2xhc3MgPSBgJHtuYW1lfS1sZWF2ZS10b2ANCiAgICB9ID0gcmF3UHJvcHM7DQogICAgY29uc3QgZHVyYXRpb25zID0gbm9ybWFsaXplRHVyYXRpb24oZHVyYXRpb24pOw0KICAgIGNvbnN0IGVudGVyRHVyYXRpb24gPSBkdXJhdGlvbnMgJiYgZHVyYXRpb25zWzBdOw0KICAgIGNvbnN0IGxlYXZlRHVyYXRpb24gPSBkdXJhdGlvbnMgJiYgZHVyYXRpb25zWzFdOw0KICAgIGNvbnN0IHsNCiAgICAgIG9uQmVmb3JlRW50ZXIsDQogICAgICBvbkVudGVyLA0KICAgICAgb25FbnRlckNhbmNlbGxlZCwNCiAgICAgIG9uTGVhdmUsDQogICAgICBvbkxlYXZlQ2FuY2VsbGVkLA0KICAgICAgb25CZWZvcmVBcHBlYXIgPSBvbkJlZm9yZUVudGVyLA0KICAgICAgb25BcHBlYXIgPSBvbkVudGVyLA0KICAgICAgb25BcHBlYXJDYW5jZWxsZWQgPSBvbkVudGVyQ2FuY2VsbGVkDQogICAgfSA9IGJhc2VQcm9wczsNCiAgICBjb25zdCBmaW5pc2hFbnRlciA9IChlbCwgaXNBcHBlYXIsIGRvbmUsIGlzQ2FuY2VsbGVkKSA9PiB7DQogICAgICBlbC5fZW50ZXJDYW5jZWxsZWQgPSBpc0NhbmNlbGxlZDsNCiAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgaXNBcHBlYXIgPyBhcHBlYXJUb0NsYXNzIDogZW50ZXJUb0NsYXNzKTsNCiAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgaXNBcHBlYXIgPyBhcHBlYXJBY3RpdmVDbGFzcyA6IGVudGVyQWN0aXZlQ2xhc3MpOw0KICAgICAgZG9uZSAmJiBkb25lKCk7DQogICAgfTsNCiAgICBjb25zdCBmaW5pc2hMZWF2ZSA9IChlbCwgZG9uZSkgPT4gew0KICAgICAgZWwuX2lzTGVhdmluZyA9IGZhbHNlOw0KICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUZyb21DbGFzcyk7DQogICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlVG9DbGFzcyk7DQogICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQWN0aXZlQ2xhc3MpOw0KICAgICAgZG9uZSAmJiBkb25lKCk7DQogICAgfTsNCiAgICBjb25zdCBtYWtlRW50ZXJIb29rID0gKGlzQXBwZWFyKSA9PiB7DQogICAgICByZXR1cm4gKGVsLCBkb25lKSA9PiB7DQogICAgICAgIGNvbnN0IGhvb2sgPSBpc0FwcGVhciA/IG9uQXBwZWFyIDogb25FbnRlcjsNCiAgICAgICAgY29uc3QgcmVzb2x2ZSA9ICgpID0+IGZpbmlzaEVudGVyKGVsLCBpc0FwcGVhciwgZG9uZSk7DQogICAgICAgIGNhbGxIb29rKGhvb2ssIFtlbCwgcmVzb2x2ZV0pOw0KICAgICAgICBuZXh0RnJhbWUoKCkgPT4gew0KICAgICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgaXNBcHBlYXIgPyBhcHBlYXJGcm9tQ2xhc3MgOiBlbnRlckZyb21DbGFzcyk7DQogICAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBpc0FwcGVhciA/IGFwcGVhclRvQ2xhc3MgOiBlbnRlclRvQ2xhc3MpOw0KICAgICAgICAgIGlmICghaGFzRXhwbGljaXRDYWxsYmFjayhob29rKSkgew0KICAgICAgICAgICAgd2hlblRyYW5zaXRpb25FbmRzKGVsLCB0eXBlLCBlbnRlckR1cmF0aW9uLCByZXNvbHZlKTsNCiAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgfTsNCiAgICB9Ow0KICAgIHJldHVybiBleHRlbmQoYmFzZVByb3BzLCB7DQogICAgICBvbkJlZm9yZUVudGVyKGVsKSB7DQogICAgICAgIGNhbGxIb29rKG9uQmVmb3JlRW50ZXIsIFtlbF0pOw0KICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGVudGVyRnJvbUNsYXNzKTsNCiAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBlbnRlckFjdGl2ZUNsYXNzKTsNCiAgICAgIH0sDQogICAgICBvbkJlZm9yZUFwcGVhcihlbCkgew0KICAgICAgICBjYWxsSG9vayhvbkJlZm9yZUFwcGVhciwgW2VsXSk7DQogICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgYXBwZWFyRnJvbUNsYXNzKTsNCiAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBhcHBlYXJBY3RpdmVDbGFzcyk7DQogICAgICB9LA0KICAgICAgb25FbnRlcjogbWFrZUVudGVySG9vayhmYWxzZSksDQogICAgICBvbkFwcGVhcjogbWFrZUVudGVySG9vayh0cnVlKSwNCiAgICAgIG9uTGVhdmUoZWwsIGRvbmUpIHsNCiAgICAgICAgZWwuX2lzTGVhdmluZyA9IHRydWU7DQogICAgICAgIGNvbnN0IHJlc29sdmUgPSAoKSA9PiBmaW5pc2hMZWF2ZShlbCwgZG9uZSk7DQogICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVGcm9tQ2xhc3MpOw0KICAgICAgICBpZiAoIWVsLl9lbnRlckNhbmNlbGxlZCkgew0KICAgICAgICAgIGZvcmNlUmVmbG93KCk7DQogICAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUFjdGl2ZUNsYXNzKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQWN0aXZlQ2xhc3MpOw0KICAgICAgICAgIGZvcmNlUmVmbG93KCk7DQogICAgICAgIH0NCiAgICAgICAgbmV4dEZyYW1lKCgpID0+IHsNCiAgICAgICAgICBpZiAoIWVsLl9pc0xlYXZpbmcpIHsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICB9DQogICAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUZyb21DbGFzcyk7DQogICAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZVRvQ2xhc3MpOw0KICAgICAgICAgIGlmICghaGFzRXhwbGljaXRDYWxsYmFjayhvbkxlYXZlKSkgew0KICAgICAgICAgICAgd2hlblRyYW5zaXRpb25FbmRzKGVsLCB0eXBlLCBsZWF2ZUR1cmF0aW9uLCByZXNvbHZlKTsNCiAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgICBjYWxsSG9vayhvbkxlYXZlLCBbZWwsIHJlc29sdmVdKTsNCiAgICAgIH0sDQogICAgICBvbkVudGVyQ2FuY2VsbGVkKGVsKSB7DQogICAgICAgIGZpbmlzaEVudGVyKGVsLCBmYWxzZSwgdm9pZCAwLCB0cnVlKTsNCiAgICAgICAgY2FsbEhvb2sob25FbnRlckNhbmNlbGxlZCwgW2VsXSk7DQogICAgICB9LA0KICAgICAgb25BcHBlYXJDYW5jZWxsZWQoZWwpIHsNCiAgICAgICAgZmluaXNoRW50ZXIoZWwsIHRydWUsIHZvaWQgMCwgdHJ1ZSk7DQogICAgICAgIGNhbGxIb29rKG9uQXBwZWFyQ2FuY2VsbGVkLCBbZWxdKTsNCiAgICAgIH0sDQogICAgICBvbkxlYXZlQ2FuY2VsbGVkKGVsKSB7DQogICAgICAgIGZpbmlzaExlYXZlKGVsKTsNCiAgICAgICAgY2FsbEhvb2sob25MZWF2ZUNhbmNlbGxlZCwgW2VsXSk7DQogICAgICB9DQogICAgfSk7DQogIH0NCiAgZnVuY3Rpb24gbm9ybWFsaXplRHVyYXRpb24oZHVyYXRpb24pIHsNCiAgICBpZiAoZHVyYXRpb24gPT0gbnVsbCkgew0KICAgICAgcmV0dXJuIG51bGw7DQogICAgfSBlbHNlIGlmIChpc09iamVjdChkdXJhdGlvbikpIHsNCiAgICAgIHJldHVybiBbTnVtYmVyT2YoZHVyYXRpb24uZW50ZXIpLCBOdW1iZXJPZihkdXJhdGlvbi5sZWF2ZSldOw0KICAgIH0gZWxzZSB7DQogICAgICBjb25zdCBuID0gTnVtYmVyT2YoZHVyYXRpb24pOw0KICAgICAgcmV0dXJuIFtuLCBuXTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gTnVtYmVyT2YodmFsKSB7DQogICAgY29uc3QgcmVzID0gdG9OdW1iZXIodmFsKTsNCiAgICB7DQogICAgICBhc3NlcnROdW1iZXIocmVzLCAiPHRyYW5zaXRpb24+IGV4cGxpY2l0IGR1cmF0aW9uIik7DQogICAgfQ0KICAgIHJldHVybiByZXM7DQogIH0NCiAgZnVuY3Rpb24gYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBjbHMpIHsNCiAgICBjbHMuc3BsaXQoL1xzKy8pLmZvckVhY2goKGMpID0+IGMgJiYgZWwuY2xhc3NMaXN0LmFkZChjKSk7DQogICAgKGVsW3Z0Y0tleV0gfHwgKGVsW3Z0Y0tleV0gPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpKSkuYWRkKGNscyk7DQogIH0NCiAgZnVuY3Rpb24gcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBjbHMpIHsNCiAgICBjbHMuc3BsaXQoL1xzKy8pLmZvckVhY2goKGMpID0+IGMgJiYgZWwuY2xhc3NMaXN0LnJlbW92ZShjKSk7DQogICAgY29uc3QgX3Z0YyA9IGVsW3Z0Y0tleV07DQogICAgaWYgKF92dGMpIHsNCiAgICAgIF92dGMuZGVsZXRlKGNscyk7DQogICAgICBpZiAoIV92dGMuc2l6ZSkgew0KICAgICAgICBlbFt2dGNLZXldID0gdm9pZCAwOw0KICAgICAgfQ0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBuZXh0RnJhbWUoY2IpIHsNCiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gew0KICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGNiKTsNCiAgICB9KTsNCiAgfQ0KICBsZXQgZW5kSWQgPSAwOw0KICBmdW5jdGlvbiB3aGVuVHJhbnNpdGlvbkVuZHMoZWwsIGV4cGVjdGVkVHlwZSwgZXhwbGljaXRUaW1lb3V0LCByZXNvbHZlKSB7DQogICAgY29uc3QgaWQgPSBlbC5fZW5kSWQgPSArK2VuZElkOw0KICAgIGNvbnN0IHJlc29sdmVJZk5vdFN0YWxlID0gKCkgPT4gew0KICAgICAgaWYgKGlkID09PSBlbC5fZW5kSWQpIHsNCiAgICAgICAgcmVzb2x2ZSgpOw0KICAgICAgfQ0KICAgIH07DQogICAgaWYgKGV4cGxpY2l0VGltZW91dCAhPSBudWxsKSB7DQogICAgICByZXR1cm4gc2V0VGltZW91dChyZXNvbHZlSWZOb3RTdGFsZSwgZXhwbGljaXRUaW1lb3V0KTsNCiAgICB9DQogICAgY29uc3QgeyB0eXBlLCB0aW1lb3V0LCBwcm9wQ291bnQgfSA9IGdldFRyYW5zaXRpb25JbmZvKGVsLCBleHBlY3RlZFR5cGUpOw0KICAgIGlmICghdHlwZSkgew0KICAgICAgcmV0dXJuIHJlc29sdmUoKTsNCiAgICB9DQogICAgY29uc3QgZW5kRXZlbnQgPSB0eXBlICsgImVuZCI7DQogICAgbGV0IGVuZGVkID0gMDsNCiAgICBjb25zdCBlbmQgPSAoKSA9PiB7DQogICAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKGVuZEV2ZW50LCBvbkVuZCk7DQogICAgICByZXNvbHZlSWZOb3RTdGFsZSgpOw0KICAgIH07DQogICAgY29uc3Qgb25FbmQgPSAoZSkgPT4gew0KICAgICAgaWYgKGUudGFyZ2V0ID09PSBlbCAmJiArK2VuZGVkID49IHByb3BDb3VudCkgew0KICAgICAgICBlbmQoKTsNCiAgICAgIH0NCiAgICB9Ow0KICAgIHNldFRpbWVvdXQoKCkgPT4gew0KICAgICAgaWYgKGVuZGVkIDwgcHJvcENvdW50KSB7DQogICAgICAgIGVuZCgpOw0KICAgICAgfQ0KICAgIH0sIHRpbWVvdXQgKyAxKTsNCiAgICBlbC5hZGRFdmVudExpc3RlbmVyKGVuZEV2ZW50LCBvbkVuZCk7DQogIH0NCiAgZnVuY3Rpb24gZ2V0VHJhbnNpdGlvbkluZm8oZWwsIGV4cGVjdGVkVHlwZSkgew0KICAgIGNvbnN0IHN0eWxlcyA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsKTsNCiAgICBjb25zdCBnZXRTdHlsZVByb3BlcnRpZXMgPSAoa2V5KSA9PiAoc3R5bGVzW2tleV0gfHwgIiIpLnNwbGl0KCIsICIpOw0KICAgIGNvbnN0IHRyYW5zaXRpb25EZWxheXMgPSBnZXRTdHlsZVByb3BlcnRpZXMoYCR7VFJBTlNJVElPTiQxfURlbGF5YCk7DQogICAgY29uc3QgdHJhbnNpdGlvbkR1cmF0aW9ucyA9IGdldFN0eWxlUHJvcGVydGllcyhgJHtUUkFOU0lUSU9OJDF9RHVyYXRpb25gKTsNCiAgICBjb25zdCB0cmFuc2l0aW9uVGltZW91dCA9IGdldFRpbWVvdXQodHJhbnNpdGlvbkRlbGF5cywgdHJhbnNpdGlvbkR1cmF0aW9ucyk7DQogICAgY29uc3QgYW5pbWF0aW9uRGVsYXlzID0gZ2V0U3R5bGVQcm9wZXJ0aWVzKGAke0FOSU1BVElPTn1EZWxheWApOw0KICAgIGNvbnN0IGFuaW1hdGlvbkR1cmF0aW9ucyA9IGdldFN0eWxlUHJvcGVydGllcyhgJHtBTklNQVRJT059RHVyYXRpb25gKTsNCiAgICBjb25zdCBhbmltYXRpb25UaW1lb3V0ID0gZ2V0VGltZW91dChhbmltYXRpb25EZWxheXMsIGFuaW1hdGlvbkR1cmF0aW9ucyk7DQogICAgbGV0IHR5cGUgPSBudWxsOw0KICAgIGxldCB0aW1lb3V0ID0gMDsNCiAgICBsZXQgcHJvcENvdW50ID0gMDsNCiAgICBpZiAoZXhwZWN0ZWRUeXBlID09PSBUUkFOU0lUSU9OJDEpIHsNCiAgICAgIGlmICh0cmFuc2l0aW9uVGltZW91dCA+IDApIHsNCiAgICAgICAgdHlwZSA9IFRSQU5TSVRJT04kMTsNCiAgICAgICAgdGltZW91dCA9IHRyYW5zaXRpb25UaW1lb3V0Ow0KICAgICAgICBwcm9wQ291bnQgPSB0cmFuc2l0aW9uRHVyYXRpb25zLmxlbmd0aDsNCiAgICAgIH0NCiAgICB9IGVsc2UgaWYgKGV4cGVjdGVkVHlwZSA9PT0gQU5JTUFUSU9OKSB7DQogICAgICBpZiAoYW5pbWF0aW9uVGltZW91dCA+IDApIHsNCiAgICAgICAgdHlwZSA9IEFOSU1BVElPTjsNCiAgICAgICAgdGltZW91dCA9IGFuaW1hdGlvblRpbWVvdXQ7DQogICAgICAgIHByb3BDb3VudCA9IGFuaW1hdGlvbkR1cmF0aW9ucy5sZW5ndGg7DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIHRpbWVvdXQgPSBNYXRoLm1heCh0cmFuc2l0aW9uVGltZW91dCwgYW5pbWF0aW9uVGltZW91dCk7DQogICAgICB0eXBlID0gdGltZW91dCA+IDAgPyB0cmFuc2l0aW9uVGltZW91dCA+IGFuaW1hdGlvblRpbWVvdXQgPyBUUkFOU0lUSU9OJDEgOiBBTklNQVRJT04gOiBudWxsOw0KICAgICAgcHJvcENvdW50ID0gdHlwZSA/IHR5cGUgPT09IFRSQU5TSVRJT04kMSA/IHRyYW5zaXRpb25EdXJhdGlvbnMubGVuZ3RoIDogYW5pbWF0aW9uRHVyYXRpb25zLmxlbmd0aCA6IDA7DQogICAgfQ0KICAgIGNvbnN0IGhhc1RyYW5zZm9ybSA9IHR5cGUgPT09IFRSQU5TSVRJT04kMSAmJiAvXGIodHJhbnNmb3JtfGFsbCkoLHwkKS8udGVzdCgNCiAgICAgIGdldFN0eWxlUHJvcGVydGllcyhgJHtUUkFOU0lUSU9OJDF9UHJvcGVydHlgKS50b1N0cmluZygpDQogICAgKTsNCiAgICByZXR1cm4gew0KICAgICAgdHlwZSwNCiAgICAgIHRpbWVvdXQsDQogICAgICBwcm9wQ291bnQsDQogICAgICBoYXNUcmFuc2Zvcm0NCiAgICB9Ow0KICB9DQogIGZ1bmN0aW9uIGdldFRpbWVvdXQoZGVsYXlzLCBkdXJhdGlvbnMpIHsNCiAgICB3aGlsZSAoZGVsYXlzLmxlbmd0aCA8IGR1cmF0aW9ucy5sZW5ndGgpIHsNCiAgICAgIGRlbGF5cyA9IGRlbGF5cy5jb25jYXQoZGVsYXlzKTsNCiAgICB9DQogICAgcmV0dXJuIE1hdGgubWF4KC4uLmR1cmF0aW9ucy5tYXAoKGQsIGkpID0+IHRvTXMoZCkgKyB0b01zKGRlbGF5c1tpXSkpKTsNCiAgfQ0KICBmdW5jdGlvbiB0b01zKHMpIHsNCiAgICBpZiAocyA9PT0gImF1dG8iKSByZXR1cm4gMDsNCiAgICByZXR1cm4gTnVtYmVyKHMuc2xpY2UoMCwgLTEpLnJlcGxhY2UoIiwiLCAiLiIpKSAqIDFlMzsNCiAgfQ0KICBmdW5jdGlvbiBmb3JjZVJlZmxvdygpIHsNCiAgICByZXR1cm4gZG9jdW1lbnQuYm9keS5vZmZzZXRIZWlnaHQ7DQogIH0NCg0KICBmdW5jdGlvbiBwYXRjaENsYXNzKGVsLCB2YWx1ZSwgaXNTVkcpIHsNCiAgICBjb25zdCB0cmFuc2l0aW9uQ2xhc3NlcyA9IGVsW3Z0Y0tleV07DQogICAgaWYgKHRyYW5zaXRpb25DbGFzc2VzKSB7DQogICAgICB2YWx1ZSA9ICh2YWx1ZSA/IFt2YWx1ZSwgLi4udHJhbnNpdGlvbkNsYXNzZXNdIDogWy4uLnRyYW5zaXRpb25DbGFzc2VzXSkuam9pbigiICIpOw0KICAgIH0NCiAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKCJjbGFzcyIpOw0KICAgIH0gZWxzZSBpZiAoaXNTVkcpIHsNCiAgICAgIGVsLnNldEF0dHJpYnV0ZSgiY2xhc3MiLCB2YWx1ZSk7DQogICAgfSBlbHNlIHsNCiAgICAgIGVsLmNsYXNzTmFtZSA9IHZhbHVlOw0KICAgIH0NCiAgfQ0KDQogIGNvbnN0IHZTaG93T3JpZ2luYWxEaXNwbGF5ID0gU3ltYm9sKCJfdm9kIik7DQogIGNvbnN0IHZTaG93SGlkZGVuID0gU3ltYm9sKCJfdnNoIik7DQogIGNvbnN0IHZTaG93ID0gew0KICAgIGJlZm9yZU1vdW50KGVsLCB7IHZhbHVlIH0sIHsgdHJhbnNpdGlvbiB9KSB7DQogICAgICBlbFt2U2hvd09yaWdpbmFsRGlzcGxheV0gPSBlbC5zdHlsZS5kaXNwbGF5ID09PSAibm9uZSIgPyAiIiA6IGVsLnN0eWxlLmRpc3BsYXk7DQogICAgICBpZiAodHJhbnNpdGlvbiAmJiB2YWx1ZSkgew0KICAgICAgICB0cmFuc2l0aW9uLmJlZm9yZUVudGVyKGVsKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHNldERpc3BsYXkoZWwsIHZhbHVlKTsNCiAgICAgIH0NCiAgICB9LA0KICAgIG1vdW50ZWQoZWwsIHsgdmFsdWUgfSwgeyB0cmFuc2l0aW9uIH0pIHsNCiAgICAgIGlmICh0cmFuc2l0aW9uICYmIHZhbHVlKSB7DQogICAgICAgIHRyYW5zaXRpb24uZW50ZXIoZWwpOw0KICAgICAgfQ0KICAgIH0sDQogICAgdXBkYXRlZChlbCwgeyB2YWx1ZSwgb2xkVmFsdWUgfSwgeyB0cmFuc2l0aW9uIH0pIHsNCiAgICAgIGlmICghdmFsdWUgPT09ICFvbGRWYWx1ZSkgcmV0dXJuOw0KICAgICAgaWYgKHRyYW5zaXRpb24pIHsNCiAgICAgICAgaWYgKHZhbHVlKSB7DQogICAgICAgICAgdHJhbnNpdGlvbi5iZWZvcmVFbnRlcihlbCk7DQogICAgICAgICAgc2V0RGlzcGxheShlbCwgdHJ1ZSk7DQogICAgICAgICAgdHJhbnNpdGlvbi5lbnRlcihlbCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgdHJhbnNpdGlvbi5sZWF2ZShlbCwgKCkgPT4gew0KICAgICAgICAgICAgc2V0RGlzcGxheShlbCwgZmFsc2UpOw0KICAgICAgICAgIH0pOw0KICAgICAgICB9DQogICAgICB9IGVsc2Ugew0KICAgICAgICBzZXREaXNwbGF5KGVsLCB2YWx1ZSk7DQogICAgICB9DQogICAgfSwNCiAgICBiZWZvcmVVbm1vdW50KGVsLCB7IHZhbHVlIH0pIHsNCiAgICAgIHNldERpc3BsYXkoZWwsIHZhbHVlKTsNCiAgICB9DQogIH07DQogIHsNCiAgICB2U2hvdy5uYW1lID0gInNob3ciOw0KICB9DQogIGZ1bmN0aW9uIHNldERpc3BsYXkoZWwsIHZhbHVlKSB7DQogICAgZWwuc3R5bGUuZGlzcGxheSA9IHZhbHVlID8gZWxbdlNob3dPcmlnaW5hbERpc3BsYXldIDogIm5vbmUiOw0KICAgIGVsW3ZTaG93SGlkZGVuXSA9ICF2YWx1ZTsNCiAgfQ0KDQogIGNvbnN0IENTU19WQVJfVEVYVCA9IFN5bWJvbCgiQ1NTX1ZBUl9URVhUIiApOw0KICBmdW5jdGlvbiB1c2VDc3NWYXJzKGdldHRlcikgew0KICAgIGNvbnN0IGluc3RhbmNlID0gZ2V0Q3VycmVudEluc3RhbmNlKCk7DQogICAgaWYgKCFpbnN0YW5jZSkgew0KICAgICAgd2FybihgdXNlQ3NzVmFycyBpcyBjYWxsZWQgd2l0aG91dCBjdXJyZW50IGFjdGl2ZSBjb21wb25lbnQgaW5zdGFuY2UuYCk7DQogICAgICByZXR1cm47DQogICAgfQ0KICAgIGNvbnN0IHVwZGF0ZVRlbGVwb3J0cyA9IGluc3RhbmNlLnV0ID0gKHZhcnMgPSBnZXR0ZXIoaW5zdGFuY2UucHJveHkpKSA9PiB7DQogICAgICBBcnJheS5mcm9tKA0KICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGBbZGF0YS12LW93bmVyPSIke2luc3RhbmNlLnVpZH0iXWApDQogICAgICApLmZvckVhY2goKG5vZGUpID0+IHNldFZhcnNPbk5vZGUobm9kZSwgdmFycykpOw0KICAgIH07DQogICAgew0KICAgICAgaW5zdGFuY2UuZ2V0Q3NzVmFycyA9ICgpID0+IGdldHRlcihpbnN0YW5jZS5wcm94eSk7DQogICAgfQ0KICAgIGNvbnN0IHNldFZhcnMgPSAoKSA9PiB7DQogICAgICBjb25zdCB2YXJzID0gZ2V0dGVyKGluc3RhbmNlLnByb3h5KTsNCiAgICAgIGlmIChpbnN0YW5jZS5jZSkgew0KICAgICAgICBzZXRWYXJzT25Ob2RlKGluc3RhbmNlLmNlLCB2YXJzKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHNldFZhcnNPblZOb2RlKGluc3RhbmNlLnN1YlRyZWUsIHZhcnMpOw0KICAgICAgfQ0KICAgICAgdXBkYXRlVGVsZXBvcnRzKHZhcnMpOw0KICAgIH07DQogICAgb25CZWZvcmVVcGRhdGUoKCkgPT4gew0KICAgICAgcXVldWVQb3N0Rmx1c2hDYihzZXRWYXJzKTsNCiAgICB9KTsNCiAgICBvbk1vdW50ZWQoKCkgPT4gew0KICAgICAgd2F0Y2goc2V0VmFycywgTk9PUCwgeyBmbHVzaDogInBvc3QiIH0pOw0KICAgICAgY29uc3Qgb2IgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihzZXRWYXJzKTsNCiAgICAgIG9iLm9ic2VydmUoaW5zdGFuY2Uuc3ViVHJlZS5lbC5wYXJlbnROb2RlLCB7IGNoaWxkTGlzdDogdHJ1ZSB9KTsNCiAgICAgIG9uVW5tb3VudGVkKCgpID0+IG9iLmRpc2Nvbm5lY3QoKSk7DQogICAgfSk7DQogIH0NCiAgZnVuY3Rpb24gc2V0VmFyc09uVk5vZGUodm5vZGUsIHZhcnMpIHsNCiAgICBpZiAodm5vZGUuc2hhcGVGbGFnICYgMTI4KSB7DQogICAgICBjb25zdCBzdXNwZW5zZSA9IHZub2RlLnN1c3BlbnNlOw0KICAgICAgdm5vZGUgPSBzdXNwZW5zZS5hY3RpdmVCcmFuY2g7DQogICAgICBpZiAoc3VzcGVuc2UucGVuZGluZ0JyYW5jaCAmJiAhc3VzcGVuc2UuaXNIeWRyYXRpbmcpIHsNCiAgICAgICAgc3VzcGVuc2UuZWZmZWN0cy5wdXNoKCgpID0+IHsNCiAgICAgICAgICBzZXRWYXJzT25WTm9kZShzdXNwZW5zZS5hY3RpdmVCcmFuY2gsIHZhcnMpOw0KICAgICAgICB9KTsNCiAgICAgIH0NCiAgICB9DQogICAgd2hpbGUgKHZub2RlLmNvbXBvbmVudCkgew0KICAgICAgdm5vZGUgPSB2bm9kZS5jb21wb25lbnQuc3ViVHJlZTsNCiAgICB9DQogICAgaWYgKHZub2RlLnNoYXBlRmxhZyAmIDEgJiYgdm5vZGUuZWwpIHsNCiAgICAgIHNldFZhcnNPbk5vZGUodm5vZGUuZWwsIHZhcnMpOw0KICAgIH0gZWxzZSBpZiAodm5vZGUudHlwZSA9PT0gRnJhZ21lbnQpIHsNCiAgICAgIHZub2RlLmNoaWxkcmVuLmZvckVhY2goKGMpID0+IHNldFZhcnNPblZOb2RlKGMsIHZhcnMpKTsNCiAgICB9IGVsc2UgaWYgKHZub2RlLnR5cGUgPT09IFN0YXRpYykgew0KICAgICAgbGV0IHsgZWwsIGFuY2hvciB9ID0gdm5vZGU7DQogICAgICB3aGlsZSAoZWwpIHsNCiAgICAgICAgc2V0VmFyc09uTm9kZShlbCwgdmFycyk7DQogICAgICAgIGlmIChlbCA9PT0gYW5jaG9yKSBicmVhazsNCiAgICAgICAgZWwgPSBlbC5uZXh0U2libGluZzsNCiAgICAgIH0NCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gc2V0VmFyc09uTm9kZShlbCwgdmFycykgew0KICAgIGlmIChlbC5ub2RlVHlwZSA9PT0gMSkgew0KICAgICAgY29uc3Qgc3R5bGUgPSBlbC5zdHlsZTsNCiAgICAgIGxldCBjc3NUZXh0ID0gIiI7DQogICAgICBmb3IgKGNvbnN0IGtleSBpbiB2YXJzKSB7DQogICAgICAgIHN0eWxlLnNldFByb3BlcnR5KGAtLSR7a2V5fWAsIHZhcnNba2V5XSk7DQogICAgICAgIGNzc1RleHQgKz0gYC0tJHtrZXl9OiAke3ZhcnNba2V5XX07YDsNCiAgICAgIH0NCiAgICAgIHN0eWxlW0NTU19WQVJfVEVYVF0gPSBjc3NUZXh0Ow0KICAgIH0NCiAgfQ0KDQogIGNvbnN0IGRpc3BsYXlSRSA9IC8oXnw7KVxzKmRpc3BsYXlccyo6LzsNCiAgZnVuY3Rpb24gcGF0Y2hTdHlsZShlbCwgcHJldiwgbmV4dCkgew0KICAgIGNvbnN0IHN0eWxlID0gZWwuc3R5bGU7DQogICAgY29uc3QgaXNDc3NTdHJpbmcgPSBpc1N0cmluZyhuZXh0KTsNCiAgICBsZXQgaGFzQ29udHJvbGxlZERpc3BsYXkgPSBmYWxzZTsNCiAgICBpZiAobmV4dCAmJiAhaXNDc3NTdHJpbmcpIHsNCiAgICAgIGlmIChwcmV2KSB7DQogICAgICAgIGlmICghaXNTdHJpbmcocHJldikpIHsNCiAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBwcmV2KSB7DQogICAgICAgICAgICBpZiAobmV4dFtrZXldID09IG51bGwpIHsNCiAgICAgICAgICAgICAgc2V0U3R5bGUoc3R5bGUsIGtleSwgIiIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBmb3IgKGNvbnN0IHByZXZTdHlsZSBvZiBwcmV2LnNwbGl0KCI7IikpIHsNCiAgICAgICAgICAgIGNvbnN0IGtleSA9IHByZXZTdHlsZS5zbGljZSgwLCBwcmV2U3R5bGUuaW5kZXhPZigiOiIpKS50cmltKCk7DQogICAgICAgICAgICBpZiAobmV4dFtrZXldID09IG51bGwpIHsNCiAgICAgICAgICAgICAgc2V0U3R5bGUoc3R5bGUsIGtleSwgIiIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgZm9yIChjb25zdCBrZXkgaW4gbmV4dCkgew0KICAgICAgICBpZiAoa2V5ID09PSAiZGlzcGxheSIpIHsNCiAgICAgICAgICBoYXNDb250cm9sbGVkRGlzcGxheSA9IHRydWU7DQogICAgICAgIH0NCiAgICAgICAgc2V0U3R5bGUoc3R5bGUsIGtleSwgbmV4dFtrZXldKTsNCiAgICAgIH0NCiAgICB9IGVsc2Ugew0KICAgICAgaWYgKGlzQ3NzU3RyaW5nKSB7DQogICAgICAgIGlmIChwcmV2ICE9PSBuZXh0KSB7DQogICAgICAgICAgY29uc3QgY3NzVmFyVGV4dCA9IHN0eWxlW0NTU19WQVJfVEVYVF07DQogICAgICAgICAgaWYgKGNzc1ZhclRleHQpIHsNCiAgICAgICAgICAgIG5leHQgKz0gIjsiICsgY3NzVmFyVGV4dDsNCiAgICAgICAgICB9DQogICAgICAgICAgc3R5bGUuY3NzVGV4dCA9IG5leHQ7DQogICAgICAgICAgaGFzQ29udHJvbGxlZERpc3BsYXkgPSBkaXNwbGF5UkUudGVzdChuZXh0KTsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIGlmIChwcmV2KSB7DQogICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZSgic3R5bGUiKTsNCiAgICAgIH0NCiAgICB9DQogICAgaWYgKHZTaG93T3JpZ2luYWxEaXNwbGF5IGluIGVsKSB7DQogICAgICBlbFt2U2hvd09yaWdpbmFsRGlzcGxheV0gPSBoYXNDb250cm9sbGVkRGlzcGxheSA/IHN0eWxlLmRpc3BsYXkgOiAiIjsNCiAgICAgIGlmIChlbFt2U2hvd0hpZGRlbl0pIHsNCiAgICAgICAgc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgICAgIH0NCiAgICB9DQogIH0NCiAgY29uc3Qgc2VtaWNvbG9uUkUgPSAvW15cXF07XHMqJC87DQogIGNvbnN0IGltcG9ydGFudFJFID0gL1xzKiFpbXBvcnRhbnQkLzsNCiAgZnVuY3Rpb24gc2V0U3R5bGUoc3R5bGUsIG5hbWUsIHZhbCkgew0KICAgIGlmIChpc0FycmF5KHZhbCkpIHsNCiAgICAgIHZhbC5mb3JFYWNoKCh2KSA9PiBzZXRTdHlsZShzdHlsZSwgbmFtZSwgdikpOw0KICAgIH0gZWxzZSB7DQogICAgICBpZiAodmFsID09IG51bGwpIHZhbCA9ICIiOw0KICAgICAgew0KICAgICAgICBpZiAoc2VtaWNvbG9uUkUudGVzdCh2YWwpKSB7DQogICAgICAgICAgd2FybigNCiAgICAgICAgICAgIGBVbmV4cGVjdGVkIHNlbWljb2xvbiBhdCB0aGUgZW5kIG9mICcke25hbWV9JyBzdHlsZSB2YWx1ZTogJyR7dmFsfSdgDQogICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgaWYgKG5hbWUuc3RhcnRzV2l0aCgiLS0iKSkgew0KICAgICAgICBzdHlsZS5zZXRQcm9wZXJ0eShuYW1lLCB2YWwpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29uc3QgcHJlZml4ZWQgPSBhdXRvUHJlZml4KHN0eWxlLCBuYW1lKTsNCiAgICAgICAgaWYgKGltcG9ydGFudFJFLnRlc3QodmFsKSkgew0KICAgICAgICAgIHN0eWxlLnNldFByb3BlcnR5KA0KICAgICAgICAgICAgaHlwaGVuYXRlKHByZWZpeGVkKSwNCiAgICAgICAgICAgIHZhbC5yZXBsYWNlKGltcG9ydGFudFJFLCAiIiksDQogICAgICAgICAgICAiaW1wb3J0YW50Ig0KICAgICAgICAgICk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgc3R5bGVbcHJlZml4ZWRdID0gdmFsOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICB9DQogIGNvbnN0IHByZWZpeGVzID0gWyJXZWJraXQiLCAiTW96IiwgIm1zIl07DQogIGNvbnN0IHByZWZpeENhY2hlID0ge307DQogIGZ1bmN0aW9uIGF1dG9QcmVmaXgoc3R5bGUsIHJhd05hbWUpIHsNCiAgICBjb25zdCBjYWNoZWQgPSBwcmVmaXhDYWNoZVtyYXdOYW1lXTsNCiAgICBpZiAoY2FjaGVkKSB7DQogICAgICByZXR1cm4gY2FjaGVkOw0KICAgIH0NCiAgICBsZXQgbmFtZSA9IGNhbWVsaXplKHJhd05hbWUpOw0KICAgIGlmIChuYW1lICE9PSAiZmlsdGVyIiAmJiBuYW1lIGluIHN0eWxlKSB7DQogICAgICByZXR1cm4gcHJlZml4Q2FjaGVbcmF3TmFtZV0gPSBuYW1lOw0KICAgIH0NCiAgICBuYW1lID0gY2FwaXRhbGl6ZShuYW1lKTsNCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByZWZpeGVzLmxlbmd0aDsgaSsrKSB7DQogICAgICBjb25zdCBwcmVmaXhlZCA9IHByZWZpeGVzW2ldICsgbmFtZTsNCiAgICAgIGlmIChwcmVmaXhlZCBpbiBzdHlsZSkgew0KICAgICAgICByZXR1cm4gcHJlZml4Q2FjaGVbcmF3TmFtZV0gPSBwcmVmaXhlZDsNCiAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHJhd05hbWU7DQogIH0NCg0KICBjb25zdCB4bGlua05TID0gImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiOw0KICBmdW5jdGlvbiBwYXRjaEF0dHIoZWwsIGtleSwgdmFsdWUsIGlzU1ZHLCBpbnN0YW5jZSwgaXNCb29sZWFuID0gaXNTcGVjaWFsQm9vbGVhbkF0dHIoa2V5KSkgew0KICAgIGlmIChpc1NWRyAmJiBrZXkuc3RhcnRzV2l0aCgieGxpbms6IikpIHsNCiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZU5TKHhsaW5rTlMsIGtleS5zbGljZSg2LCBrZXkubGVuZ3RoKSk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBlbC5zZXRBdHRyaWJ1dGVOUyh4bGlua05TLCBrZXksIHZhbHVlKTsNCiAgICAgIH0NCiAgICB9IGVsc2Ugew0KICAgICAgaWYgKHZhbHVlID09IG51bGwgfHwgaXNCb29sZWFuICYmICFpbmNsdWRlQm9vbGVhbkF0dHIodmFsdWUpKSB7DQogICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShrZXkpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgZWwuc2V0QXR0cmlidXRlKA0KICAgICAgICAgIGtleSwNCiAgICAgICAgICBpc0Jvb2xlYW4gPyAiIiA6IGlzU3ltYm9sKHZhbHVlKSA/IFN0cmluZyh2YWx1ZSkgOiB2YWx1ZQ0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIHBhdGNoRE9NUHJvcChlbCwga2V5LCB2YWx1ZSwgcGFyZW50Q29tcG9uZW50LCBhdHRyTmFtZSkgew0KICAgIGlmIChrZXkgPT09ICJpbm5lckhUTUwiIHx8IGtleSA9PT0gInRleHRDb250ZW50Iikgew0KICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsNCiAgICAgICAgZWxba2V5XSA9IGtleSA9PT0gImlubmVySFRNTCIgPyB1bnNhZmVUb1RydXN0ZWRIVE1MKHZhbHVlKSA6IHZhbHVlOw0KICAgICAgfQ0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBjb25zdCB0YWcgPSBlbC50YWdOYW1lOw0KICAgIGlmIChrZXkgPT09ICJ2YWx1ZSIgJiYgdGFnICE9PSAiUFJPR1JFU1MiICYmIC8vIGN1c3RvbSBlbGVtZW50cyBtYXkgdXNlIF92YWx1ZSBpbnRlcm5hbGx5DQogICAgIXRhZy5pbmNsdWRlcygiLSIpKSB7DQogICAgICBjb25zdCBvbGRWYWx1ZSA9IHRhZyA9PT0gIk9QVElPTiIgPyBlbC5nZXRBdHRyaWJ1dGUoInZhbHVlIikgfHwgIiIgOiBlbC52YWx1ZTsNCiAgICAgIGNvbnN0IG5ld1ZhbHVlID0gdmFsdWUgPT0gbnVsbCA/ICgNCiAgICAgICAgLy8gIzExNjQ3OiB2YWx1ZSBzaG91bGQgYmUgc2V0IGFzIGVtcHR5IHN0cmluZyBmb3IgbnVsbCBhbmQgdW5kZWZpbmVkLA0KICAgICAgICAvLyBidXQgPGlucHV0IHR5cGU9ImNoZWNrYm94Ij4gc2hvdWxkIGJlIHNldCBhcyAnb24nLg0KICAgICAgICBlbC50eXBlID09PSAiY2hlY2tib3giID8gIm9uIiA6ICIiDQogICAgICApIDogU3RyaW5nKHZhbHVlKTsNCiAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUgfHwgISgiX3ZhbHVlIiBpbiBlbCkpIHsNCiAgICAgICAgZWwudmFsdWUgPSBuZXdWYWx1ZTsNCiAgICAgIH0NCiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShrZXkpOw0KICAgICAgfQ0KICAgICAgZWwuX3ZhbHVlID0gdmFsdWU7DQogICAgICByZXR1cm47DQogICAgfQ0KICAgIGxldCBuZWVkUmVtb3ZlID0gZmFsc2U7DQogICAgaWYgKHZhbHVlID09PSAiIiB8fCB2YWx1ZSA9PSBudWxsKSB7DQogICAgICBjb25zdCB0eXBlID0gdHlwZW9mIGVsW2tleV07DQogICAgICBpZiAodHlwZSA9PT0gImJvb2xlYW4iKSB7DQogICAgICAgIHZhbHVlID0gaW5jbHVkZUJvb2xlYW5BdHRyKHZhbHVlKTsNCiAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT0gbnVsbCAmJiB0eXBlID09PSAic3RyaW5nIikgew0KICAgICAgICB2YWx1ZSA9ICIiOw0KICAgICAgICBuZWVkUmVtb3ZlID0gdHJ1ZTsNCiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gIm51bWJlciIpIHsNCiAgICAgICAgdmFsdWUgPSAwOw0KICAgICAgICBuZWVkUmVtb3ZlID0gdHJ1ZTsNCiAgICAgIH0NCiAgICB9DQogICAgdHJ5IHsNCiAgICAgIGVsW2tleV0gPSB2YWx1ZTsNCiAgICB9IGNhdGNoIChlKSB7DQogICAgICBpZiAoIW5lZWRSZW1vdmUpIHsNCiAgICAgICAgd2FybigNCiAgICAgICAgICBgRmFpbGVkIHNldHRpbmcgcHJvcCAiJHtrZXl9IiBvbiA8JHt0YWcudG9Mb3dlckNhc2UoKX0+OiB2YWx1ZSAke3ZhbHVlfSBpcyBpbnZhbGlkLmAsDQogICAgICAgICAgZQ0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH0NCiAgICBuZWVkUmVtb3ZlICYmIGVsLnJlbW92ZUF0dHJpYnV0ZShhdHRyTmFtZSB8fCBrZXkpOw0KICB9DQoNCiAgZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcihlbCwgZXZlbnQsIGhhbmRsZXIsIG9wdGlvbnMpIHsNCiAgICBlbC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCBoYW5kbGVyLCBvcHRpb25zKTsNCiAgfQ0KICBmdW5jdGlvbiByZW1vdmVFdmVudExpc3RlbmVyKGVsLCBldmVudCwgaGFuZGxlciwgb3B0aW9ucykgew0KICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnQsIGhhbmRsZXIsIG9wdGlvbnMpOw0KICB9DQogIGNvbnN0IHZlaUtleSA9IFN5bWJvbCgiX3ZlaSIpOw0KICBmdW5jdGlvbiBwYXRjaEV2ZW50KGVsLCByYXdOYW1lLCBwcmV2VmFsdWUsIG5leHRWYWx1ZSwgaW5zdGFuY2UgPSBudWxsKSB7DQogICAgY29uc3QgaW52b2tlcnMgPSBlbFt2ZWlLZXldIHx8IChlbFt2ZWlLZXldID0ge30pOw0KICAgIGNvbnN0IGV4aXN0aW5nSW52b2tlciA9IGludm9rZXJzW3Jhd05hbWVdOw0KICAgIGlmIChuZXh0VmFsdWUgJiYgZXhpc3RpbmdJbnZva2VyKSB7DQogICAgICBleGlzdGluZ0ludm9rZXIudmFsdWUgPSBzYW5pdGl6ZUV2ZW50VmFsdWUobmV4dFZhbHVlLCByYXdOYW1lKSA7DQogICAgfSBlbHNlIHsNCiAgICAgIGNvbnN0IFtuYW1lLCBvcHRpb25zXSA9IHBhcnNlTmFtZShyYXdOYW1lKTsNCiAgICAgIGlmIChuZXh0VmFsdWUpIHsNCiAgICAgICAgY29uc3QgaW52b2tlciA9IGludm9rZXJzW3Jhd05hbWVdID0gY3JlYXRlSW52b2tlcigNCiAgICAgICAgICBzYW5pdGl6ZUV2ZW50VmFsdWUobmV4dFZhbHVlLCByYXdOYW1lKSAsDQogICAgICAgICAgaW5zdGFuY2UNCiAgICAgICAgKTsNCiAgICAgICAgYWRkRXZlbnRMaXN0ZW5lcihlbCwgbmFtZSwgaW52b2tlciwgb3B0aW9ucyk7DQogICAgICB9IGVsc2UgaWYgKGV4aXN0aW5nSW52b2tlcikgew0KICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyKGVsLCBuYW1lLCBleGlzdGluZ0ludm9rZXIsIG9wdGlvbnMpOw0KICAgICAgICBpbnZva2Vyc1tyYXdOYW1lXSA9IHZvaWQgMDsNCiAgICAgIH0NCiAgICB9DQogIH0NCiAgY29uc3Qgb3B0aW9uc01vZGlmaWVyUkUgPSAvKD86T25jZXxQYXNzaXZlfENhcHR1cmUpJC87DQogIGZ1bmN0aW9uIHBhcnNlTmFtZShuYW1lKSB7DQogICAgbGV0IG9wdGlvbnM7DQogICAgaWYgKG9wdGlvbnNNb2RpZmllclJFLnRlc3QobmFtZSkpIHsNCiAgICAgIG9wdGlvbnMgPSB7fTsNCiAgICAgIGxldCBtOw0KICAgICAgd2hpbGUgKG0gPSBuYW1lLm1hdGNoKG9wdGlvbnNNb2RpZmllclJFKSkgew0KICAgICAgICBuYW1lID0gbmFtZS5zbGljZSgwLCBuYW1lLmxlbmd0aCAtIG1bMF0ubGVuZ3RoKTsNCiAgICAgICAgb3B0aW9uc1ttWzBdLnRvTG93ZXJDYXNlKCldID0gdHJ1ZTsNCiAgICAgIH0NCiAgICB9DQogICAgY29uc3QgZXZlbnQgPSBuYW1lWzJdID09PSAiOiIgPyBuYW1lLnNsaWNlKDMpIDogaHlwaGVuYXRlKG5hbWUuc2xpY2UoMikpOw0KICAgIHJldHVybiBbZXZlbnQsIG9wdGlvbnNdOw0KICB9DQogIGxldCBjYWNoZWROb3cgPSAwOw0KICBjb25zdCBwID0gLyogQF9fUFVSRV9fICovIFByb21pc2UucmVzb2x2ZSgpOw0KICBjb25zdCBnZXROb3cgPSAoKSA9PiBjYWNoZWROb3cgfHwgKHAudGhlbigoKSA9PiBjYWNoZWROb3cgPSAwKSwgY2FjaGVkTm93ID0gRGF0ZS5ub3coKSk7DQogIGZ1bmN0aW9uIGNyZWF0ZUludm9rZXIoaW5pdGlhbFZhbHVlLCBpbnN0YW5jZSkgew0KICAgIGNvbnN0IGludm9rZXIgPSAoZSkgPT4gew0KICAgICAgaWYgKCFlLl92dHMpIHsNCiAgICAgICAgZS5fdnRzID0gRGF0ZS5ub3coKTsNCiAgICAgIH0gZWxzZSBpZiAoZS5fdnRzIDw9IGludm9rZXIuYXR0YWNoZWQpIHsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoDQogICAgICAgIHBhdGNoU3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKGUsIGludm9rZXIudmFsdWUpLA0KICAgICAgICBpbnN0YW5jZSwNCiAgICAgICAgNSwNCiAgICAgICAgW2VdDQogICAgICApOw0KICAgIH07DQogICAgaW52b2tlci52YWx1ZSA9IGluaXRpYWxWYWx1ZTsNCiAgICBpbnZva2VyLmF0dGFjaGVkID0gZ2V0Tm93KCk7DQogICAgcmV0dXJuIGludm9rZXI7DQogIH0NCiAgZnVuY3Rpb24gc2FuaXRpemVFdmVudFZhbHVlKHZhbHVlLCBwcm9wTmFtZSkgew0KICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSB8fCBpc0FycmF5KHZhbHVlKSkgew0KICAgICAgcmV0dXJuIHZhbHVlOw0KICAgIH0NCiAgICB3YXJuKA0KICAgICAgYFdyb25nIHR5cGUgcGFzc2VkIGFzIGV2ZW50IGhhbmRsZXIgdG8gJHtwcm9wTmFtZX0gLSBkaWQgeW91IGZvcmdldCBAIG9yIDogaW4gZnJvbnQgb2YgeW91ciBwcm9wPw0KRXhwZWN0ZWQgZnVuY3Rpb24gb3IgYXJyYXkgb2YgZnVuY3Rpb25zLCByZWNlaXZlZCB0eXBlICR7dHlwZW9mIHZhbHVlfS5gDQogICAgKTsNCiAgICByZXR1cm4gTk9PUDsNCiAgfQ0KICBmdW5jdGlvbiBwYXRjaFN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbihlLCB2YWx1ZSkgew0KICAgIGlmIChpc0FycmF5KHZhbHVlKSkgew0KICAgICAgY29uc3Qgb3JpZ2luYWxTdG9wID0gZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb247DQogICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbiA9ICgpID0+IHsNCiAgICAgICAgb3JpZ2luYWxTdG9wLmNhbGwoZSk7DQogICAgICAgIGUuX3N0b3BwZWQgPSB0cnVlOw0KICAgICAgfTsNCiAgICAgIHJldHVybiB2YWx1ZS5tYXAoDQogICAgICAgIChmbikgPT4gKGUyKSA9PiAhZTIuX3N0b3BwZWQgJiYgZm4gJiYgZm4oZTIpDQogICAgICApOw0KICAgIH0gZWxzZSB7DQogICAgICByZXR1cm4gdmFsdWU7DQogICAgfQ0KICB9DQoNCiAgY29uc3QgaXNOYXRpdmVPbiA9IChrZXkpID0+IGtleS5jaGFyQ29kZUF0KDApID09PSAxMTEgJiYga2V5LmNoYXJDb2RlQXQoMSkgPT09IDExMCAmJiAvLyBsb3dlcmNhc2UgbGV0dGVyDQogIGtleS5jaGFyQ29kZUF0KDIpID4gOTYgJiYga2V5LmNoYXJDb2RlQXQoMikgPCAxMjM7DQogIGNvbnN0IHBhdGNoUHJvcCA9IChlbCwga2V5LCBwcmV2VmFsdWUsIG5leHRWYWx1ZSwgbmFtZXNwYWNlLCBwYXJlbnRDb21wb25lbnQpID0+IHsNCiAgICBjb25zdCBpc1NWRyA9IG5hbWVzcGFjZSA9PT0gInN2ZyI7DQogICAgaWYgKGtleSA9PT0gImNsYXNzIikgew0KICAgICAgcGF0Y2hDbGFzcyhlbCwgbmV4dFZhbHVlLCBpc1NWRyk7DQogICAgfSBlbHNlIGlmIChrZXkgPT09ICJzdHlsZSIpIHsNCiAgICAgIHBhdGNoU3R5bGUoZWwsIHByZXZWYWx1ZSwgbmV4dFZhbHVlKTsNCiAgICB9IGVsc2UgaWYgKGlzT24oa2V5KSkgew0KICAgICAgaWYgKCFpc01vZGVsTGlzdGVuZXIoa2V5KSkgew0KICAgICAgICBwYXRjaEV2ZW50KGVsLCBrZXksIHByZXZWYWx1ZSwgbmV4dFZhbHVlLCBwYXJlbnRDb21wb25lbnQpOw0KICAgICAgfQ0KICAgIH0gZWxzZSBpZiAoa2V5WzBdID09PSAiLiIgPyAoa2V5ID0ga2V5LnNsaWNlKDEpLCB0cnVlKSA6IGtleVswXSA9PT0gIl4iID8gKGtleSA9IGtleS5zbGljZSgxKSwgZmFsc2UpIDogc2hvdWxkU2V0QXNQcm9wKGVsLCBrZXksIG5leHRWYWx1ZSwgaXNTVkcpKSB7DQogICAgICBwYXRjaERPTVByb3AoZWwsIGtleSwgbmV4dFZhbHVlKTsNCiAgICAgIGlmICghZWwudGFnTmFtZS5pbmNsdWRlcygiLSIpICYmIChrZXkgPT09ICJ2YWx1ZSIgfHwga2V5ID09PSAiY2hlY2tlZCIgfHwga2V5ID09PSAic2VsZWN0ZWQiKSkgew0KICAgICAgICBwYXRjaEF0dHIoZWwsIGtleSwgbmV4dFZhbHVlLCBpc1NWRywgcGFyZW50Q29tcG9uZW50LCBrZXkgIT09ICJ2YWx1ZSIpOw0KICAgICAgfQ0KICAgIH0gZWxzZSBpZiAoDQogICAgICAvLyAjMTEwODEgZm9yY2Ugc2V0IHByb3BzIGZvciBwb3NzaWJsZSBhc3luYyBjdXN0b20gZWxlbWVudA0KICAgICAgZWwuX2lzVnVlQ0UgJiYgKC9bQS1aXS8udGVzdChrZXkpIHx8ICFpc1N0cmluZyhuZXh0VmFsdWUpKQ0KICAgICkgew0KICAgICAgcGF0Y2hET01Qcm9wKGVsLCBjYW1lbGl6ZShrZXkpLCBuZXh0VmFsdWUsIHBhcmVudENvbXBvbmVudCwga2V5KTsNCiAgICB9IGVsc2Ugew0KICAgICAgaWYgKGtleSA9PT0gInRydWUtdmFsdWUiKSB7DQogICAgICAgIGVsLl90cnVlVmFsdWUgPSBuZXh0VmFsdWU7DQogICAgICB9IGVsc2UgaWYgKGtleSA9PT0gImZhbHNlLXZhbHVlIikgew0KICAgICAgICBlbC5fZmFsc2VWYWx1ZSA9IG5leHRWYWx1ZTsNCiAgICAgIH0NCiAgICAgIHBhdGNoQXR0cihlbCwga2V5LCBuZXh0VmFsdWUsIGlzU1ZHKTsNCiAgICB9DQogIH07DQogIGZ1bmN0aW9uIHNob3VsZFNldEFzUHJvcChlbCwga2V5LCB2YWx1ZSwgaXNTVkcpIHsNCiAgICBpZiAoaXNTVkcpIHsNCiAgICAgIGlmIChrZXkgPT09ICJpbm5lckhUTUwiIHx8IGtleSA9PT0gInRleHRDb250ZW50Iikgew0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIGlmIChrZXkgaW4gZWwgJiYgaXNOYXRpdmVPbihrZXkpICYmIGlzRnVuY3Rpb24odmFsdWUpKSB7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH0NCiAgICBpZiAoa2V5ID09PSAic3BlbGxjaGVjayIgfHwga2V5ID09PSAiZHJhZ2dhYmxlIiB8fCBrZXkgPT09ICJ0cmFuc2xhdGUiIHx8IGtleSA9PT0gImF1dG9jb3JyZWN0Iikgew0KICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH0NCiAgICBpZiAoa2V5ID09PSAiZm9ybSIpIHsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQogICAgaWYgKGtleSA9PT0gImxpc3QiICYmIGVsLnRhZ05hbWUgPT09ICJJTlBVVCIpIHsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQogICAgaWYgKGtleSA9PT0gInR5cGUiICYmIGVsLnRhZ05hbWUgPT09ICJURVhUQVJFQSIpIHsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQogICAgaWYgKGtleSA9PT0gIndpZHRoIiB8fCBrZXkgPT09ICJoZWlnaHQiKSB7DQogICAgICBjb25zdCB0YWcgPSBlbC50YWdOYW1lOw0KICAgICAgaWYgKHRhZyA9PT0gIklNRyIgfHwgdGFnID09PSAiVklERU8iIHx8IHRhZyA9PT0gIkNBTlZBUyIgfHwgdGFnID09PSAiU09VUkNFIikgew0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICB9DQogICAgfQ0KICAgIGlmIChpc05hdGl2ZU9uKGtleSkgJiYgaXNTdHJpbmcodmFsdWUpKSB7DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KICAgIHJldHVybiBrZXkgaW4gZWw7DQogIH0NCg0KICBjb25zdCBSRU1PVkFMID0ge307DQogIC8qISAjX19OT19TSURFX0VGRkVDVFNfXyAqLw0KICAvLyBAX19OT19TSURFX0VGRkVDVFNfXw0KICBmdW5jdGlvbiBkZWZpbmVDdXN0b21FbGVtZW50KG9wdGlvbnMsIGV4dHJhT3B0aW9ucywgX2NyZWF0ZUFwcCkgew0KICAgIGNvbnN0IENvbXAgPSBkZWZpbmVDb21wb25lbnQob3B0aW9ucywgZXh0cmFPcHRpb25zKTsNCiAgICBpZiAoaXNQbGFpbk9iamVjdChDb21wKSkgZXh0ZW5kKENvbXAsIGV4dHJhT3B0aW9ucyk7DQogICAgY2xhc3MgVnVlQ3VzdG9tRWxlbWVudCBleHRlbmRzIFZ1ZUVsZW1lbnQgew0KICAgICAgY29uc3RydWN0b3IoaW5pdGlhbFByb3BzKSB7DQogICAgICAgIHN1cGVyKENvbXAsIGluaXRpYWxQcm9wcywgX2NyZWF0ZUFwcCk7DQogICAgICB9DQogICAgfQ0KICAgIFZ1ZUN1c3RvbUVsZW1lbnQuZGVmID0gQ29tcDsNCiAgICByZXR1cm4gVnVlQ3VzdG9tRWxlbWVudDsNCiAgfQ0KICAvKiEgI19fTk9fU0lERV9FRkZFQ1RTX18gKi8NCiAgY29uc3QgZGVmaW5lU1NSQ3VzdG9tRWxlbWVudCA9IC8qIEBfX05PX1NJREVfRUZGRUNUU19fICovIChvcHRpb25zLCBleHRyYU9wdGlvbnMpID0+IHsNCiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIGRlZmluZUN1c3RvbUVsZW1lbnQob3B0aW9ucywgZXh0cmFPcHRpb25zLCBjcmVhdGVTU1JBcHApOw0KICB9Ow0KICBjb25zdCBCYXNlQ2xhc3MgPSB0eXBlb2YgSFRNTEVsZW1lbnQgIT09ICJ1bmRlZmluZWQiID8gSFRNTEVsZW1lbnQgOiBjbGFzcyB7DQogIH07DQogIGNsYXNzIFZ1ZUVsZW1lbnQgZXh0ZW5kcyBCYXNlQ2xhc3Mgew0KICAgIGNvbnN0cnVjdG9yKF9kZWYsIF9wcm9wcyA9IHt9LCBfY3JlYXRlQXBwID0gY3JlYXRlQXBwKSB7DQogICAgICBzdXBlcigpOw0KICAgICAgdGhpcy5fZGVmID0gX2RlZjsNCiAgICAgIHRoaXMuX3Byb3BzID0gX3Byb3BzOw0KICAgICAgdGhpcy5fY3JlYXRlQXBwID0gX2NyZWF0ZUFwcDsNCiAgICAgIHRoaXMuX2lzVnVlQ0UgPSB0cnVlOw0KICAgICAgLyoqDQogICAgICAgKiBAaW50ZXJuYWwNCiAgICAgICAqLw0KICAgICAgdGhpcy5faW5zdGFuY2UgPSBudWxsOw0KICAgICAgLyoqDQogICAgICAgKiBAaW50ZXJuYWwNCiAgICAgICAqLw0KICAgICAgdGhpcy5fYXBwID0gbnVsbDsNCiAgICAgIC8qKg0KICAgICAgICogQGludGVybmFsDQogICAgICAgKi8NCiAgICAgIHRoaXMuX25vbmNlID0gdGhpcy5fZGVmLm5vbmNlOw0KICAgICAgdGhpcy5fY29ubmVjdGVkID0gZmFsc2U7DQogICAgICB0aGlzLl9yZXNvbHZlZCA9IGZhbHNlOw0KICAgICAgdGhpcy5fbnVtYmVyUHJvcHMgPSBudWxsOw0KICAgICAgdGhpcy5fc3R5bGVDaGlsZHJlbiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha1NldCgpOw0KICAgICAgdGhpcy5fb2IgPSBudWxsOw0KICAgICAgaWYgKHRoaXMuc2hhZG93Um9vdCAmJiBfY3JlYXRlQXBwICE9PSBjcmVhdGVBcHApIHsNCiAgICAgICAgdGhpcy5fcm9vdCA9IHRoaXMuc2hhZG93Um9vdDsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGlmICh0aGlzLnNoYWRvd1Jvb3QpIHsNCiAgICAgICAgICB3YXJuKA0KICAgICAgICAgICAgYEN1c3RvbSBlbGVtZW50IGhhcyBwcmUtcmVuZGVyZWQgZGVjbGFyYXRpdmUgc2hhZG93IHJvb3QgYnV0IGlzIG5vdCBkZWZpbmVkIGFzIGh5ZHJhdGFibGUuIFVzZSBcYGRlZmluZVNTUkN1c3RvbUVsZW1lbnRcYC5gDQogICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoX2RlZi5zaGFkb3dSb290ICE9PSBmYWxzZSkgew0KICAgICAgICAgIHRoaXMuYXR0YWNoU2hhZG93KHsgbW9kZTogIm9wZW4iIH0pOw0KICAgICAgICAgIHRoaXMuX3Jvb3QgPSB0aGlzLnNoYWRvd1Jvb3Q7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgdGhpcy5fcm9vdCA9IHRoaXM7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7DQogICAgICBpZiAoIXRoaXMuaXNDb25uZWN0ZWQpIHJldHVybjsNCiAgICAgIGlmICghdGhpcy5zaGFkb3dSb290ICYmICF0aGlzLl9yZXNvbHZlZCkgew0KICAgICAgICB0aGlzLl9wYXJzZVNsb3RzKCk7DQogICAgICB9DQogICAgICB0aGlzLl9jb25uZWN0ZWQgPSB0cnVlOw0KICAgICAgbGV0IHBhcmVudCA9IHRoaXM7DQogICAgICB3aGlsZSAocGFyZW50ID0gcGFyZW50ICYmIChwYXJlbnQucGFyZW50Tm9kZSB8fCBwYXJlbnQuaG9zdCkpIHsNCiAgICAgICAgaWYgKHBhcmVudCBpbnN0YW5jZW9mIFZ1ZUVsZW1lbnQpIHsNCiAgICAgICAgICB0aGlzLl9wYXJlbnQgPSBwYXJlbnQ7DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmICghdGhpcy5faW5zdGFuY2UpIHsNCiAgICAgICAgaWYgKHRoaXMuX3Jlc29sdmVkKSB7DQogICAgICAgICAgdGhpcy5fbW91bnQodGhpcy5fZGVmKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBpZiAocGFyZW50ICYmIHBhcmVudC5fcGVuZGluZ1Jlc29sdmUpIHsNCiAgICAgICAgICAgIHRoaXMuX3BlbmRpbmdSZXNvbHZlID0gcGFyZW50Ll9wZW5kaW5nUmVzb2x2ZS50aGVuKCgpID0+IHsNCiAgICAgICAgICAgICAgdGhpcy5fcGVuZGluZ1Jlc29sdmUgPSB2b2lkIDA7DQogICAgICAgICAgICAgIHRoaXMuX3Jlc29sdmVEZWYoKTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICB0aGlzLl9yZXNvbHZlRGVmKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIF9zZXRQYXJlbnQocGFyZW50ID0gdGhpcy5fcGFyZW50KSB7DQogICAgICBpZiAocGFyZW50KSB7DQogICAgICAgIHRoaXMuX2luc3RhbmNlLnBhcmVudCA9IHBhcmVudC5faW5zdGFuY2U7DQogICAgICAgIHRoaXMuX2luaGVyaXRQYXJlbnRDb250ZXh0KHBhcmVudCk7DQogICAgICB9DQogICAgfQ0KICAgIF9pbmhlcml0UGFyZW50Q29udGV4dChwYXJlbnQgPSB0aGlzLl9wYXJlbnQpIHsNCiAgICAgIGlmIChwYXJlbnQgJiYgdGhpcy5fYXBwKSB7DQogICAgICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZigNCiAgICAgICAgICB0aGlzLl9hcHAuX2NvbnRleHQucHJvdmlkZXMsDQogICAgICAgICAgcGFyZW50Ll9pbnN0YW5jZS5wcm92aWRlcw0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH0NCiAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHsNCiAgICAgIHRoaXMuX2Nvbm5lY3RlZCA9IGZhbHNlOw0KICAgICAgbmV4dFRpY2soKCkgPT4gew0KICAgICAgICBpZiAoIXRoaXMuX2Nvbm5lY3RlZCkgew0KICAgICAgICAgIGlmICh0aGlzLl9vYikgew0KICAgICAgICAgICAgdGhpcy5fb2IuZGlzY29ubmVjdCgpOw0KICAgICAgICAgICAgdGhpcy5fb2IgPSBudWxsOw0KICAgICAgICAgIH0NCiAgICAgICAgICB0aGlzLl9hcHAgJiYgdGhpcy5fYXBwLnVubW91bnQoKTsNCiAgICAgICAgICBpZiAodGhpcy5faW5zdGFuY2UpIHRoaXMuX2luc3RhbmNlLmNlID0gdm9pZCAwOw0KICAgICAgICAgIHRoaXMuX2FwcCA9IHRoaXMuX2luc3RhbmNlID0gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgfSk7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIHJlc29sdmUgaW5uZXIgY29tcG9uZW50IGRlZmluaXRpb24gKGhhbmRsZSBwb3NzaWJsZSBhc3luYyBjb21wb25lbnQpDQogICAgICovDQogICAgX3Jlc29sdmVEZWYoKSB7DQogICAgICBpZiAodGhpcy5fcGVuZGluZ1Jlc29sdmUpIHsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmF0dHJpYnV0ZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgdGhpcy5fc2V0QXR0cih0aGlzLmF0dHJpYnV0ZXNbaV0ubmFtZSk7DQogICAgICB9DQogICAgICB0aGlzLl9vYiA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKChtdXRhdGlvbnMpID0+IHsNCiAgICAgICAgZm9yIChjb25zdCBtIG9mIG11dGF0aW9ucykgew0KICAgICAgICAgIHRoaXMuX3NldEF0dHIobS5hdHRyaWJ1dGVOYW1lKTsNCiAgICAgICAgfQ0KICAgICAgfSk7DQogICAgICB0aGlzLl9vYi5vYnNlcnZlKHRoaXMsIHsgYXR0cmlidXRlczogdHJ1ZSB9KTsNCiAgICAgIGNvbnN0IHJlc29sdmUgPSAoZGVmLCBpc0FzeW5jID0gZmFsc2UpID0+IHsNCiAgICAgICAgdGhpcy5fcmVzb2x2ZWQgPSB0cnVlOw0KICAgICAgICB0aGlzLl9wZW5kaW5nUmVzb2x2ZSA9IHZvaWQgMDsNCiAgICAgICAgY29uc3QgeyBwcm9wcywgc3R5bGVzIH0gPSBkZWY7DQogICAgICAgIGxldCBudW1iZXJQcm9wczsNCiAgICAgICAgaWYgKHByb3BzICYmICFpc0FycmF5KHByb3BzKSkgew0KICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIHByb3BzKSB7DQogICAgICAgICAgICBjb25zdCBvcHQgPSBwcm9wc1trZXldOw0KICAgICAgICAgICAgaWYgKG9wdCA9PT0gTnVtYmVyIHx8IG9wdCAmJiBvcHQudHlwZSA9PT0gTnVtYmVyKSB7DQogICAgICAgICAgICAgIGlmIChrZXkgaW4gdGhpcy5fcHJvcHMpIHsNCiAgICAgICAgICAgICAgICB0aGlzLl9wcm9wc1trZXldID0gdG9OdW1iZXIodGhpcy5fcHJvcHNba2V5XSk7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgKG51bWJlclByb3BzIHx8IChudW1iZXJQcm9wcyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpKSlbY2FtZWxpemUoa2V5KV0gPSB0cnVlOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICB0aGlzLl9udW1iZXJQcm9wcyA9IG51bWJlclByb3BzOw0KICAgICAgICB0aGlzLl9yZXNvbHZlUHJvcHMoZGVmKTsNCiAgICAgICAgaWYgKHRoaXMuc2hhZG93Um9vdCkgew0KICAgICAgICAgIHRoaXMuX2FwcGx5U3R5bGVzKHN0eWxlcyk7DQogICAgICAgIH0gZWxzZSBpZiAoc3R5bGVzKSB7DQogICAgICAgICAgd2FybigNCiAgICAgICAgICAgICJDdXN0b20gZWxlbWVudCBzdHlsZSBpbmplY3Rpb24gaXMgbm90IHN1cHBvcnRlZCB3aGVuIHVzaW5nIHNoYWRvd1Jvb3Q6IGZhbHNlIg0KICAgICAgICAgICk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5fbW91bnQoZGVmKTsNCiAgICAgIH07DQogICAgICBjb25zdCBhc3luY0RlZiA9IHRoaXMuX2RlZi5fX2FzeW5jTG9hZGVyOw0KICAgICAgaWYgKGFzeW5jRGVmKSB7DQogICAgICAgIHRoaXMuX3BlbmRpbmdSZXNvbHZlID0gYXN5bmNEZWYoKS50aGVuKChkZWYpID0+IHsNCiAgICAgICAgICBkZWYuY29uZmlndXJlQXBwID0gdGhpcy5fZGVmLmNvbmZpZ3VyZUFwcDsNCiAgICAgICAgICByZXNvbHZlKHRoaXMuX2RlZiA9IGRlZiwgdHJ1ZSk7DQogICAgICAgIH0pOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmVzb2x2ZSh0aGlzLl9kZWYpOw0KICAgICAgfQ0KICAgIH0NCiAgICBfbW91bnQoZGVmKSB7DQogICAgICBpZiAoIWRlZi5uYW1lKSB7DQogICAgICAgIGRlZi5uYW1lID0gIlZ1ZUVsZW1lbnQiOw0KICAgICAgfQ0KICAgICAgdGhpcy5fYXBwID0gdGhpcy5fY3JlYXRlQXBwKGRlZik7DQogICAgICB0aGlzLl9pbmhlcml0UGFyZW50Q29udGV4dCgpOw0KICAgICAgaWYgKGRlZi5jb25maWd1cmVBcHApIHsNCiAgICAgICAgZGVmLmNvbmZpZ3VyZUFwcCh0aGlzLl9hcHApOw0KICAgICAgfQ0KICAgICAgdGhpcy5fYXBwLl9jZVZOb2RlID0gdGhpcy5fY3JlYXRlVk5vZGUoKTsNCiAgICAgIHRoaXMuX2FwcC5tb3VudCh0aGlzLl9yb290KTsNCiAgICAgIGNvbnN0IGV4cG9zZWQgPSB0aGlzLl9pbnN0YW5jZSAmJiB0aGlzLl9pbnN0YW5jZS5leHBvc2VkOw0KICAgICAgaWYgKCFleHBvc2VkKSByZXR1cm47DQogICAgICBmb3IgKGNvbnN0IGtleSBpbiBleHBvc2VkKSB7DQogICAgICAgIGlmICghaGFzT3duKHRoaXMsIGtleSkpIHsNCiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywga2V5LCB7DQogICAgICAgICAgICAvLyB1bndyYXAgcmVmIHRvIGJlIGNvbnNpc3RlbnQgd2l0aCBwdWJsaWMgaW5zdGFuY2UgYmVoYXZpb3INCiAgICAgICAgICAgIGdldDogKCkgPT4gdW5yZWYoZXhwb3NlZFtrZXldKQ0KICAgICAgICAgIH0pOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHdhcm4oYEV4cG9zZWQgcHJvcGVydHkgIiR7a2V5fSIgYWxyZWFkeSBleGlzdHMgb24gY3VzdG9tIGVsZW1lbnQuYCk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogICAgX3Jlc29sdmVQcm9wcyhkZWYpIHsNCiAgICAgIGNvbnN0IHsgcHJvcHMgfSA9IGRlZjsNCiAgICAgIGNvbnN0IGRlY2xhcmVkUHJvcEtleXMgPSBpc0FycmF5KHByb3BzKSA/IHByb3BzIDogT2JqZWN0LmtleXMocHJvcHMgfHwge30pOw0KICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXModGhpcykpIHsNCiAgICAgICAgaWYgKGtleVswXSAhPT0gIl8iICYmIGRlY2xhcmVkUHJvcEtleXMuaW5jbHVkZXMoa2V5KSkgew0KICAgICAgICAgIHRoaXMuX3NldFByb3Aoa2V5LCB0aGlzW2tleV0pOw0KICAgICAgICB9DQogICAgICB9DQogICAgICBmb3IgKGNvbnN0IGtleSBvZiBkZWNsYXJlZFByb3BLZXlzLm1hcChjYW1lbGl6ZSkpIHsNCiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIGtleSwgew0KICAgICAgICAgIGdldCgpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9nZXRQcm9wKGtleSk7DQogICAgICAgICAgfSwNCiAgICAgICAgICBzZXQodmFsKSB7DQogICAgICAgICAgICB0aGlzLl9zZXRQcm9wKGtleSwgdmFsLCB0cnVlLCB0cnVlKTsNCiAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgfQ0KICAgIH0NCiAgICBfc2V0QXR0cihrZXkpIHsNCiAgICAgIGlmIChrZXkuc3RhcnRzV2l0aCgiZGF0YS12LSIpKSByZXR1cm47DQogICAgICBjb25zdCBoYXMgPSB0aGlzLmhhc0F0dHJpYnV0ZShrZXkpOw0KICAgICAgbGV0IHZhbHVlID0gaGFzID8gdGhpcy5nZXRBdHRyaWJ1dGUoa2V5KSA6IFJFTU9WQUw7DQogICAgICBjb25zdCBjYW1lbEtleSA9IGNhbWVsaXplKGtleSk7DQogICAgICBpZiAoaGFzICYmIHRoaXMuX251bWJlclByb3BzICYmIHRoaXMuX251bWJlclByb3BzW2NhbWVsS2V5XSkgew0KICAgICAgICB2YWx1ZSA9IHRvTnVtYmVyKHZhbHVlKTsNCiAgICAgIH0NCiAgICAgIHRoaXMuX3NldFByb3AoY2FtZWxLZXksIHZhbHVlLCBmYWxzZSwgdHJ1ZSk7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIEBpbnRlcm5hbA0KICAgICAqLw0KICAgIF9nZXRQcm9wKGtleSkgew0KICAgICAgcmV0dXJuIHRoaXMuX3Byb3BzW2tleV07DQogICAgfQ0KICAgIC8qKg0KICAgICAqIEBpbnRlcm5hbA0KICAgICAqLw0KICAgIF9zZXRQcm9wKGtleSwgdmFsLCBzaG91bGRSZWZsZWN0ID0gdHJ1ZSwgc2hvdWxkVXBkYXRlID0gZmFsc2UpIHsNCiAgICAgIGlmICh2YWwgIT09IHRoaXMuX3Byb3BzW2tleV0pIHsNCiAgICAgICAgaWYgKHZhbCA9PT0gUkVNT1ZBTCkgew0KICAgICAgICAgIGRlbGV0ZSB0aGlzLl9wcm9wc1trZXldOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHRoaXMuX3Byb3BzW2tleV0gPSB2YWw7DQogICAgICAgICAgaWYgKGtleSA9PT0gImtleSIgJiYgdGhpcy5fYXBwKSB7DQogICAgICAgICAgICB0aGlzLl9hcHAuX2NlVk5vZGUua2V5ID0gdmFsOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBpZiAoc2hvdWxkVXBkYXRlICYmIHRoaXMuX2luc3RhbmNlKSB7DQogICAgICAgICAgdGhpcy5fdXBkYXRlKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHNob3VsZFJlZmxlY3QpIHsNCiAgICAgICAgICBjb25zdCBvYiA9IHRoaXMuX29iOw0KICAgICAgICAgIG9iICYmIG9iLmRpc2Nvbm5lY3QoKTsNCiAgICAgICAgICBpZiAodmFsID09PSB0cnVlKSB7DQogICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZShoeXBoZW5hdGUoa2V5KSwgIiIpOw0KICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsNCiAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKGh5cGhlbmF0ZShrZXkpLCB2YWwgKyAiIik7DQogICAgICAgICAgfSBlbHNlIGlmICghdmFsKSB7DQogICAgICAgICAgICB0aGlzLnJlbW92ZUF0dHJpYnV0ZShoeXBoZW5hdGUoa2V5KSk7DQogICAgICAgICAgfQ0KICAgICAgICAgIG9iICYmIG9iLm9ic2VydmUodGhpcywgeyBhdHRyaWJ1dGVzOiB0cnVlIH0pOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIF91cGRhdGUoKSB7DQogICAgICBjb25zdCB2bm9kZSA9IHRoaXMuX2NyZWF0ZVZOb2RlKCk7DQogICAgICBpZiAodGhpcy5fYXBwKSB2bm9kZS5hcHBDb250ZXh0ID0gdGhpcy5fYXBwLl9jb250ZXh0Ow0KICAgICAgcmVuZGVyKHZub2RlLCB0aGlzLl9yb290KTsNCiAgICB9DQogICAgX2NyZWF0ZVZOb2RlKCkgew0KICAgICAgY29uc3QgYmFzZVByb3BzID0ge307DQogICAgICBpZiAoIXRoaXMuc2hhZG93Um9vdCkgew0KICAgICAgICBiYXNlUHJvcHMub25Wbm9kZU1vdW50ZWQgPSBiYXNlUHJvcHMub25Wbm9kZVVwZGF0ZWQgPSB0aGlzLl9yZW5kZXJTbG90cy5iaW5kKHRoaXMpOw0KICAgICAgfQ0KICAgICAgY29uc3Qgdm5vZGUgPSBjcmVhdGVWTm9kZSh0aGlzLl9kZWYsIGV4dGVuZChiYXNlUHJvcHMsIHRoaXMuX3Byb3BzKSk7DQogICAgICBpZiAoIXRoaXMuX2luc3RhbmNlKSB7DQogICAgICAgIHZub2RlLmNlID0gKGluc3RhbmNlKSA9PiB7DQogICAgICAgICAgdGhpcy5faW5zdGFuY2UgPSBpbnN0YW5jZTsNCiAgICAgICAgICBpbnN0YW5jZS5jZSA9IHRoaXM7DQogICAgICAgICAgaW5zdGFuY2UuaXNDRSA9IHRydWU7DQogICAgICAgICAgew0KICAgICAgICAgICAgaW5zdGFuY2UuY2VSZWxvYWQgPSAobmV3U3R5bGVzKSA9PiB7DQogICAgICAgICAgICAgIGlmICh0aGlzLl9zdHlsZXMpIHsNCiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZXMuZm9yRWFjaCgocykgPT4gdGhpcy5fcm9vdC5yZW1vdmVDaGlsZChzKSk7DQogICAgICAgICAgICAgICAgdGhpcy5fc3R5bGVzLmxlbmd0aCA9IDA7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgdGhpcy5fYXBwbHlTdHlsZXMobmV3U3R5bGVzKTsNCiAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2UgPSBudWxsOw0KICAgICAgICAgICAgICB0aGlzLl91cGRhdGUoKTsNCiAgICAgICAgICAgIH07DQogICAgICAgICAgfQ0KICAgICAgICAgIGNvbnN0IGRpc3BhdGNoID0gKGV2ZW50LCBhcmdzKSA9PiB7DQogICAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoDQogICAgICAgICAgICAgIG5ldyBDdXN0b21FdmVudCgNCiAgICAgICAgICAgICAgICBldmVudCwNCiAgICAgICAgICAgICAgICBpc1BsYWluT2JqZWN0KGFyZ3NbMF0pID8gZXh0ZW5kKHsgZGV0YWlsOiBhcmdzIH0sIGFyZ3NbMF0pIDogeyBkZXRhaWw6IGFyZ3MgfQ0KICAgICAgICAgICAgICApDQogICAgICAgICAgICApOw0KICAgICAgICAgIH07DQogICAgICAgICAgaW5zdGFuY2UuZW1pdCA9IChldmVudCwgLi4uYXJncykgPT4gew0KICAgICAgICAgICAgZGlzcGF0Y2goZXZlbnQsIGFyZ3MpOw0KICAgICAgICAgICAgaWYgKGh5cGhlbmF0ZShldmVudCkgIT09IGV2ZW50KSB7DQogICAgICAgICAgICAgIGRpc3BhdGNoKGh5cGhlbmF0ZShldmVudCksIGFyZ3MpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH07DQogICAgICAgICAgdGhpcy5fc2V0UGFyZW50KCk7DQogICAgICAgIH07DQogICAgICB9DQogICAgICByZXR1cm4gdm5vZGU7DQogICAgfQ0KICAgIF9hcHBseVN0eWxlcyhzdHlsZXMsIG93bmVyKSB7DQogICAgICBpZiAoIXN0eWxlcykgcmV0dXJuOw0KICAgICAgaWYgKG93bmVyKSB7DQogICAgICAgIGlmIChvd25lciA9PT0gdGhpcy5fZGVmIHx8IHRoaXMuX3N0eWxlQ2hpbGRyZW4uaGFzKG93bmVyKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLl9zdHlsZUNoaWxkcmVuLmFkZChvd25lcik7DQogICAgICB9DQogICAgICBjb25zdCBub25jZSA9IHRoaXMuX25vbmNlOw0KICAgICAgZm9yIChsZXQgaSA9IHN0eWxlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgew0KICAgICAgICBjb25zdCBzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTsNCiAgICAgICAgaWYgKG5vbmNlKSBzLnNldEF0dHJpYnV0ZSgibm9uY2UiLCBub25jZSk7DQogICAgICAgIHMudGV4dENvbnRlbnQgPSBzdHlsZXNbaV07DQogICAgICAgIHRoaXMuc2hhZG93Um9vdC5wcmVwZW5kKHMpOw0KICAgICAgICB7DQogICAgICAgICAgaWYgKG93bmVyKSB7DQogICAgICAgICAgICBpZiAob3duZXIuX19obXJJZCkgew0KICAgICAgICAgICAgICBpZiAoIXRoaXMuX2NoaWxkU3R5bGVzKSB0aGlzLl9jaGlsZFN0eWxlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7DQogICAgICAgICAgICAgIGxldCBlbnRyeSA9IHRoaXMuX2NoaWxkU3R5bGVzLmdldChvd25lci5fX2htcklkKTsNCiAgICAgICAgICAgICAgaWYgKCFlbnRyeSkgew0KICAgICAgICAgICAgICAgIHRoaXMuX2NoaWxkU3R5bGVzLnNldChvd25lci5fX2htcklkLCBlbnRyeSA9IFtdKTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICBlbnRyeS5wdXNoKHMpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAodGhpcy5fc3R5bGVzIHx8ICh0aGlzLl9zdHlsZXMgPSBbXSkpLnB1c2gocyk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIE9ubHkgY2FsbGVkIHdoZW4gc2hhZG93Um9vdCBpcyBmYWxzZQ0KICAgICAqLw0KICAgIF9wYXJzZVNsb3RzKCkgew0KICAgICAgY29uc3Qgc2xvdHMgPSB0aGlzLl9zbG90cyA9IHt9Ow0KICAgICAgbGV0IG47DQogICAgICB3aGlsZSAobiA9IHRoaXMuZmlyc3RDaGlsZCkgew0KICAgICAgICBjb25zdCBzbG90TmFtZSA9IG4ubm9kZVR5cGUgPT09IDEgJiYgbi5nZXRBdHRyaWJ1dGUoInNsb3QiKSB8fCAiZGVmYXVsdCI7DQogICAgICAgIChzbG90c1tzbG90TmFtZV0gfHwgKHNsb3RzW3Nsb3ROYW1lXSA9IFtdKSkucHVzaChuKTsNCiAgICAgICAgdGhpcy5yZW1vdmVDaGlsZChuKTsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogT25seSBjYWxsZWQgd2hlbiBzaGFkb3dSb290IGlzIGZhbHNlDQogICAgICovDQogICAgX3JlbmRlclNsb3RzKCkgew0KICAgICAgY29uc3Qgb3V0bGV0cyA9ICh0aGlzLl90ZWxlcG9ydFRhcmdldCB8fCB0aGlzKS5xdWVyeVNlbGVjdG9yQWxsKCJzbG90Iik7DQogICAgICBjb25zdCBzY29wZUlkID0gdGhpcy5faW5zdGFuY2UudHlwZS5fX3Njb3BlSWQ7DQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG91dGxldHMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgY29uc3QgbyA9IG91dGxldHNbaV07DQogICAgICAgIGNvbnN0IHNsb3ROYW1lID0gby5nZXRBdHRyaWJ1dGUoIm5hbWUiKSB8fCAiZGVmYXVsdCI7DQogICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0aGlzLl9zbG90c1tzbG90TmFtZV07DQogICAgICAgIGNvbnN0IHBhcmVudCA9IG8ucGFyZW50Tm9kZTsNCiAgICAgICAgaWYgKGNvbnRlbnQpIHsNCiAgICAgICAgICBmb3IgKGNvbnN0IG4gb2YgY29udGVudCkgew0KICAgICAgICAgICAgaWYgKHNjb3BlSWQgJiYgbi5ub2RlVHlwZSA9PT0gMSkgew0KICAgICAgICAgICAgICBjb25zdCBpZCA9IHNjb3BlSWQgKyAiLXMiOw0KICAgICAgICAgICAgICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKG4sIDEpOw0KICAgICAgICAgICAgICBuLnNldEF0dHJpYnV0ZShpZCwgIiIpOw0KICAgICAgICAgICAgICBsZXQgY2hpbGQ7DQogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCA9IHdhbGtlci5uZXh0Tm9kZSgpKSB7DQogICAgICAgICAgICAgICAgY2hpbGQuc2V0QXR0cmlidXRlKGlkLCAiIik7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUobiwgbyk7DQogICAgICAgICAgfQ0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHdoaWxlIChvLmZpcnN0Q2hpbGQpIHBhcmVudC5pbnNlcnRCZWZvcmUoby5maXJzdENoaWxkLCBvKTsNCiAgICAgICAgfQ0KICAgICAgICBwYXJlbnQucmVtb3ZlQ2hpbGQobyk7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIEBpbnRlcm5hbA0KICAgICAqLw0KICAgIF9pbmplY3RDaGlsZFN0eWxlKGNvbXApIHsNCiAgICAgIHRoaXMuX2FwcGx5U3R5bGVzKGNvbXAuc3R5bGVzLCBjb21wKTsNCiAgICB9DQogICAgLyoqDQogICAgICogQGludGVybmFsDQogICAgICovDQogICAgX3JlbW92ZUNoaWxkU3R5bGUoY29tcCkgew0KICAgICAgew0KICAgICAgICB0aGlzLl9zdHlsZUNoaWxkcmVuLmRlbGV0ZShjb21wKTsNCiAgICAgICAgaWYgKHRoaXMuX2NoaWxkU3R5bGVzICYmIGNvbXAuX19obXJJZCkgew0KICAgICAgICAgIGNvbnN0IG9sZFN0eWxlcyA9IHRoaXMuX2NoaWxkU3R5bGVzLmdldChjb21wLl9faG1ySWQpOw0KICAgICAgICAgIGlmIChvbGRTdHlsZXMpIHsNCiAgICAgICAgICAgIG9sZFN0eWxlcy5mb3JFYWNoKChzKSA9PiB0aGlzLl9yb290LnJlbW92ZUNoaWxkKHMpKTsNCiAgICAgICAgICAgIG9sZFN0eWxlcy5sZW5ndGggPSAwOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiB1c2VIb3N0KGNhbGxlcikgew0KICAgIGNvbnN0IGluc3RhbmNlID0gZ2V0Q3VycmVudEluc3RhbmNlKCk7DQogICAgY29uc3QgZWwgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS5jZTsNCiAgICBpZiAoZWwpIHsNCiAgICAgIHJldHVybiBlbDsNCiAgICB9IGVsc2Ugew0KICAgICAgaWYgKCFpbnN0YW5jZSkgew0KICAgICAgICB3YXJuKA0KICAgICAgICAgIGAke2NhbGxlciB8fCAidXNlSG9zdCJ9IGNhbGxlZCB3aXRob3V0IGFuIGFjdGl2ZSBjb21wb25lbnQgaW5zdGFuY2UuYA0KICAgICAgICApOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgd2FybigNCiAgICAgICAgICBgJHtjYWxsZXIgfHwgInVzZUhvc3QifSBjYW4gb25seSBiZSB1c2VkIGluIGNvbXBvbmVudHMgZGVmaW5lZCB2aWEgZGVmaW5lQ3VzdG9tRWxlbWVudC5gDQogICAgICAgICk7DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiBudWxsOw0KICB9DQogIGZ1bmN0aW9uIHVzZVNoYWRvd1Jvb3QoKSB7DQogICAgY29uc3QgZWwgPSB1c2VIb3N0KCJ1c2VTaGFkb3dSb290IikgOw0KICAgIHJldHVybiBlbCAmJiBlbC5zaGFkb3dSb290Ow0KICB9DQoNCiAgZnVuY3Rpb24gdXNlQ3NzTW9kdWxlKG5hbWUgPSAiJHN0eWxlIikgew0KICAgIHsNCiAgICAgIHsNCiAgICAgICAgd2FybihgdXNlQ3NzTW9kdWxlKCkgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgZ2xvYmFsIGJ1aWxkLmApOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIEVNUFRZX09CSjsNCiAgICB9DQogIH0NCg0KICBjb25zdCBwb3NpdGlvbk1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOw0KICBjb25zdCBuZXdQb3NpdGlvbk1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOw0KICBjb25zdCBtb3ZlQ2JLZXkgPSBTeW1ib2woIl9tb3ZlQ2IiKTsNCiAgY29uc3QgZW50ZXJDYktleSA9IFN5bWJvbCgiX2VudGVyQ2IiKTsNCiAgY29uc3QgZGVjb3JhdGUgPSAodCkgPT4gew0KICAgIGRlbGV0ZSB0LnByb3BzLm1vZGU7DQogICAgcmV0dXJuIHQ7DQogIH07DQogIGNvbnN0IFRyYW5zaXRpb25Hcm91cEltcGwgPSAvKiBAX19QVVJFX18gKi8gZGVjb3JhdGUoew0KICAgIG5hbWU6ICJUcmFuc2l0aW9uR3JvdXAiLA0KICAgIHByb3BzOiAvKiBAX19QVVJFX18gKi8gZXh0ZW5kKHt9LCBUcmFuc2l0aW9uUHJvcHNWYWxpZGF0b3JzLCB7DQogICAgICB0YWc6IFN0cmluZywNCiAgICAgIG1vdmVDbGFzczogU3RyaW5nDQogICAgfSksDQogICAgc2V0dXAocHJvcHMsIHsgc2xvdHMgfSkgew0KICAgICAgY29uc3QgaW5zdGFuY2UgPSBnZXRDdXJyZW50SW5zdGFuY2UoKTsNCiAgICAgIGNvbnN0IHN0YXRlID0gdXNlVHJhbnNpdGlvblN0YXRlKCk7DQogICAgICBsZXQgcHJldkNoaWxkcmVuOw0KICAgICAgbGV0IGNoaWxkcmVuOw0KICAgICAgb25VcGRhdGVkKCgpID0+IHsNCiAgICAgICAgaWYgKCFwcmV2Q2hpbGRyZW4ubGVuZ3RoKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIGNvbnN0IG1vdmVDbGFzcyA9IHByb3BzLm1vdmVDbGFzcyB8fCBgJHtwcm9wcy5uYW1lIHx8ICJ2In0tbW92ZWA7DQogICAgICAgIGlmICghaGFzQ1NTVHJhbnNmb3JtKA0KICAgICAgICAgIHByZXZDaGlsZHJlblswXS5lbCwNCiAgICAgICAgICBpbnN0YW5jZS52bm9kZS5lbCwNCiAgICAgICAgICBtb3ZlQ2xhc3MNCiAgICAgICAgKSkgew0KICAgICAgICAgIHByZXZDaGlsZHJlbiA9IFtdOw0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICBwcmV2Q2hpbGRyZW4uZm9yRWFjaChjYWxsUGVuZGluZ0Nicyk7DQogICAgICAgIHByZXZDaGlsZHJlbi5mb3JFYWNoKHJlY29yZFBvc2l0aW9uKTsNCiAgICAgICAgY29uc3QgbW92ZWRDaGlsZHJlbiA9IHByZXZDaGlsZHJlbi5maWx0ZXIoYXBwbHlUcmFuc2xhdGlvbik7DQogICAgICAgIGZvcmNlUmVmbG93KCk7DQogICAgICAgIG1vdmVkQ2hpbGRyZW4uZm9yRWFjaCgoYykgPT4gew0KICAgICAgICAgIGNvbnN0IGVsID0gYy5lbDsNCiAgICAgICAgICBjb25zdCBzdHlsZSA9IGVsLnN0eWxlOw0KICAgICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgbW92ZUNsYXNzKTsNCiAgICAgICAgICBzdHlsZS50cmFuc2Zvcm0gPSBzdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSBzdHlsZS50cmFuc2l0aW9uRHVyYXRpb24gPSAiIjsNCiAgICAgICAgICBjb25zdCBjYiA9IGVsW21vdmVDYktleV0gPSAoZSkgPT4gew0KICAgICAgICAgICAgaWYgKGUgJiYgZS50YXJnZXQgIT09IGVsKSB7DQogICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmICghZSB8fCAvdHJhbnNmb3JtJC8udGVzdChlLnByb3BlcnR5TmFtZSkpIHsNCiAgICAgICAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigidHJhbnNpdGlvbmVuZCIsIGNiKTsNCiAgICAgICAgICAgICAgZWxbbW92ZUNiS2V5XSA9IG51bGw7DQogICAgICAgICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbW92ZUNsYXNzKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9Ow0KICAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoInRyYW5zaXRpb25lbmQiLCBjYik7DQogICAgICAgIH0pOw0KICAgICAgICBwcmV2Q2hpbGRyZW4gPSBbXTsNCiAgICAgIH0pOw0KICAgICAgcmV0dXJuICgpID0+IHsNCiAgICAgICAgY29uc3QgcmF3UHJvcHMgPSB0b1Jhdyhwcm9wcyk7DQogICAgICAgIGNvbnN0IGNzc1RyYW5zaXRpb25Qcm9wcyA9IHJlc29sdmVUcmFuc2l0aW9uUHJvcHMocmF3UHJvcHMpOw0KICAgICAgICBsZXQgdGFnID0gcmF3UHJvcHMudGFnIHx8IEZyYWdtZW50Ow0KICAgICAgICBwcmV2Q2hpbGRyZW4gPSBbXTsNCiAgICAgICAgaWYgKGNoaWxkcmVuKSB7DQogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXTsNCiAgICAgICAgICAgIGlmIChjaGlsZC5lbCAmJiBjaGlsZC5lbCBpbnN0YW5jZW9mIEVsZW1lbnQpIHsNCiAgICAgICAgICAgICAgcHJldkNoaWxkcmVuLnB1c2goY2hpbGQpOw0KICAgICAgICAgICAgICBzZXRUcmFuc2l0aW9uSG9va3MoDQogICAgICAgICAgICAgICAgY2hpbGQsDQogICAgICAgICAgICAgICAgcmVzb2x2ZVRyYW5zaXRpb25Ib29rcygNCiAgICAgICAgICAgICAgICAgIGNoaWxkLA0KICAgICAgICAgICAgICAgICAgY3NzVHJhbnNpdGlvblByb3BzLA0KICAgICAgICAgICAgICAgICAgc3RhdGUsDQogICAgICAgICAgICAgICAgICBpbnN0YW5jZQ0KICAgICAgICAgICAgICAgICkNCiAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgcG9zaXRpb25NYXAuc2V0KA0KICAgICAgICAgICAgICAgIGNoaWxkLA0KICAgICAgICAgICAgICAgIGNoaWxkLmVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGNoaWxkcmVuID0gc2xvdHMuZGVmYXVsdCA/IGdldFRyYW5zaXRpb25SYXdDaGlsZHJlbihzbG90cy5kZWZhdWx0KCkpIDogW107DQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICBjb25zdCBjaGlsZCA9IGNoaWxkcmVuW2ldOw0KICAgICAgICAgIGlmIChjaGlsZC5rZXkgIT0gbnVsbCkgew0KICAgICAgICAgICAgc2V0VHJhbnNpdGlvbkhvb2tzKA0KICAgICAgICAgICAgICBjaGlsZCwNCiAgICAgICAgICAgICAgcmVzb2x2ZVRyYW5zaXRpb25Ib29rcyhjaGlsZCwgY3NzVHJhbnNpdGlvblByb3BzLCBzdGF0ZSwgaW5zdGFuY2UpDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0gZWxzZSBpZiAoY2hpbGQudHlwZSAhPT0gVGV4dCkgew0KICAgICAgICAgICAgd2FybihgPFRyYW5zaXRpb25Hcm91cD4gY2hpbGRyZW4gbXVzdCBiZSBrZXllZC5gKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGNyZWF0ZVZOb2RlKHRhZywgbnVsbCwgY2hpbGRyZW4pOw0KICAgICAgfTsNCiAgICB9DQogIH0pOw0KICBjb25zdCBUcmFuc2l0aW9uR3JvdXAgPSBUcmFuc2l0aW9uR3JvdXBJbXBsOw0KICBmdW5jdGlvbiBjYWxsUGVuZGluZ0NicyhjKSB7DQogICAgY29uc3QgZWwgPSBjLmVsOw0KICAgIGlmIChlbFttb3ZlQ2JLZXldKSB7DQogICAgICBlbFttb3ZlQ2JLZXldKCk7DQogICAgfQ0KICAgIGlmIChlbFtlbnRlckNiS2V5XSkgew0KICAgICAgZWxbZW50ZXJDYktleV0oKTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gcmVjb3JkUG9zaXRpb24oYykgew0KICAgIG5ld1Bvc2l0aW9uTWFwLnNldChjLCBjLmVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpKTsNCiAgfQ0KICBmdW5jdGlvbiBhcHBseVRyYW5zbGF0aW9uKGMpIHsNCiAgICBjb25zdCBvbGRQb3MgPSBwb3NpdGlvbk1hcC5nZXQoYyk7DQogICAgY29uc3QgbmV3UG9zID0gbmV3UG9zaXRpb25NYXAuZ2V0KGMpOw0KICAgIGNvbnN0IGR4ID0gb2xkUG9zLmxlZnQgLSBuZXdQb3MubGVmdDsNCiAgICBjb25zdCBkeSA9IG9sZFBvcy50b3AgLSBuZXdQb3MudG9wOw0KICAgIGlmIChkeCB8fCBkeSkgew0KICAgICAgY29uc3QgcyA9IGMuZWwuc3R5bGU7DQogICAgICBzLnRyYW5zZm9ybSA9IHMud2Via2l0VHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgke2R4fXB4LCR7ZHl9cHgpYDsNCiAgICAgIHMudHJhbnNpdGlvbkR1cmF0aW9uID0gIjBzIjsNCiAgICAgIHJldHVybiBjOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBoYXNDU1NUcmFuc2Zvcm0oZWwsIHJvb3QsIG1vdmVDbGFzcykgew0KICAgIGNvbnN0IGNsb25lID0gZWwuY2xvbmVOb2RlKCk7DQogICAgY29uc3QgX3Z0YyA9IGVsW3Z0Y0tleV07DQogICAgaWYgKF92dGMpIHsNCiAgICAgIF92dGMuZm9yRWFjaCgoY2xzKSA9PiB7DQogICAgICAgIGNscy5zcGxpdCgvXHMrLykuZm9yRWFjaCgoYykgPT4gYyAmJiBjbG9uZS5jbGFzc0xpc3QucmVtb3ZlKGMpKTsNCiAgICAgIH0pOw0KICAgIH0NCiAgICBtb3ZlQ2xhc3Muc3BsaXQoL1xzKy8pLmZvckVhY2goKGMpID0+IGMgJiYgY2xvbmUuY2xhc3NMaXN0LmFkZChjKSk7DQogICAgY2xvbmUuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgICBjb25zdCBjb250YWluZXIgPSByb290Lm5vZGVUeXBlID09PSAxID8gcm9vdCA6IHJvb3QucGFyZW50Tm9kZTsNCiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoY2xvbmUpOw0KICAgIGNvbnN0IHsgaGFzVHJhbnNmb3JtIH0gPSBnZXRUcmFuc2l0aW9uSW5mbyhjbG9uZSk7DQogICAgY29udGFpbmVyLnJlbW92ZUNoaWxkKGNsb25lKTsNCiAgICByZXR1cm4gaGFzVHJhbnNmb3JtOw0KICB9DQoNCiAgY29uc3QgZ2V0TW9kZWxBc3NpZ25lciA9ICh2bm9kZSkgPT4gew0KICAgIGNvbnN0IGZuID0gdm5vZGUucHJvcHNbIm9uVXBkYXRlOm1vZGVsVmFsdWUiXSB8fCBmYWxzZTsNCiAgICByZXR1cm4gaXNBcnJheShmbikgPyAodmFsdWUpID0+IGludm9rZUFycmF5Rm5zKGZuLCB2YWx1ZSkgOiBmbjsNCiAgfTsNCiAgZnVuY3Rpb24gb25Db21wb3NpdGlvblN0YXJ0KGUpIHsNCiAgICBlLnRhcmdldC5jb21wb3NpbmcgPSB0cnVlOw0KICB9DQogIGZ1bmN0aW9uIG9uQ29tcG9zaXRpb25FbmQoZSkgew0KICAgIGNvbnN0IHRhcmdldCA9IGUudGFyZ2V0Ow0KICAgIGlmICh0YXJnZXQuY29tcG9zaW5nKSB7DQogICAgICB0YXJnZXQuY29tcG9zaW5nID0gZmFsc2U7DQogICAgICB0YXJnZXQuZGlzcGF0Y2hFdmVudChuZXcgRXZlbnQoImlucHV0IikpOw0KICAgIH0NCiAgfQ0KICBjb25zdCBhc3NpZ25LZXkgPSBTeW1ib2woIl9hc3NpZ24iKTsNCiAgY29uc3Qgdk1vZGVsVGV4dCA9IHsNCiAgICBjcmVhdGVkKGVsLCB7IG1vZGlmaWVyczogeyBsYXp5LCB0cmltLCBudW1iZXIgfSB9LCB2bm9kZSkgew0KICAgICAgZWxbYXNzaWduS2V5XSA9IGdldE1vZGVsQXNzaWduZXIodm5vZGUpOw0KICAgICAgY29uc3QgY2FzdFRvTnVtYmVyID0gbnVtYmVyIHx8IHZub2RlLnByb3BzICYmIHZub2RlLnByb3BzLnR5cGUgPT09ICJudW1iZXIiOw0KICAgICAgYWRkRXZlbnRMaXN0ZW5lcihlbCwgbGF6eSA/ICJjaGFuZ2UiIDogImlucHV0IiwgKGUpID0+IHsNCiAgICAgICAgaWYgKGUudGFyZ2V0LmNvbXBvc2luZykgcmV0dXJuOw0KICAgICAgICBsZXQgZG9tVmFsdWUgPSBlbC52YWx1ZTsNCiAgICAgICAgaWYgKHRyaW0pIHsNCiAgICAgICAgICBkb21WYWx1ZSA9IGRvbVZhbHVlLnRyaW0oKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoY2FzdFRvTnVtYmVyKSB7DQogICAgICAgICAgZG9tVmFsdWUgPSBsb29zZVRvTnVtYmVyKGRvbVZhbHVlKTsNCiAgICAgICAgfQ0KICAgICAgICBlbFthc3NpZ25LZXldKGRvbVZhbHVlKTsNCiAgICAgIH0pOw0KICAgICAgaWYgKHRyaW0pIHsNCiAgICAgICAgYWRkRXZlbnRMaXN0ZW5lcihlbCwgImNoYW5nZSIsICgpID0+IHsNCiAgICAgICAgICBlbC52YWx1ZSA9IGVsLnZhbHVlLnRyaW0oKTsNCiAgICAgICAgfSk7DQogICAgICB9DQogICAgICBpZiAoIWxhenkpIHsNCiAgICAgICAgYWRkRXZlbnRMaXN0ZW5lcihlbCwgImNvbXBvc2l0aW9uc3RhcnQiLCBvbkNvbXBvc2l0aW9uU3RhcnQpOw0KICAgICAgICBhZGRFdmVudExpc3RlbmVyKGVsLCAiY29tcG9zaXRpb25lbmQiLCBvbkNvbXBvc2l0aW9uRW5kKTsNCiAgICAgICAgYWRkRXZlbnRMaXN0ZW5lcihlbCwgImNoYW5nZSIsIG9uQ29tcG9zaXRpb25FbmQpOw0KICAgICAgfQ0KICAgIH0sDQogICAgLy8gc2V0IHZhbHVlIG9uIG1vdW50ZWQgc28gaXQncyBhZnRlciBtaW4vbWF4IGZvciB0eXBlPSJyYW5nZSINCiAgICBtb3VudGVkKGVsLCB7IHZhbHVlIH0pIHsNCiAgICAgIGVsLnZhbHVlID0gdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWU7DQogICAgfSwNCiAgICBiZWZvcmVVcGRhdGUoZWwsIHsgdmFsdWUsIG9sZFZhbHVlLCBtb2RpZmllcnM6IHsgbGF6eSwgdHJpbSwgbnVtYmVyIH0gfSwgdm5vZGUpIHsNCiAgICAgIGVsW2Fzc2lnbktleV0gPSBnZXRNb2RlbEFzc2lnbmVyKHZub2RlKTsNCiAgICAgIGlmIChlbC5jb21wb3NpbmcpIHJldHVybjsNCiAgICAgIGNvbnN0IGVsVmFsdWUgPSAobnVtYmVyIHx8IGVsLnR5cGUgPT09ICJudW1iZXIiKSAmJiAhL14wXGQvLnRlc3QoZWwudmFsdWUpID8gbG9vc2VUb051bWJlcihlbC52YWx1ZSkgOiBlbC52YWx1ZTsNCiAgICAgIGNvbnN0IG5ld1ZhbHVlID0gdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWU7DQogICAgICBpZiAoZWxWYWx1ZSA9PT0gbmV3VmFsdWUpIHsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgaWYgKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IGVsICYmIGVsLnR5cGUgIT09ICJyYW5nZSIpIHsNCiAgICAgICAgaWYgKGxhenkgJiYgdmFsdWUgPT09IG9sZFZhbHVlKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIGlmICh0cmltICYmIGVsLnZhbHVlLnRyaW0oKSA9PT0gbmV3VmFsdWUpIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGVsLnZhbHVlID0gbmV3VmFsdWU7DQogICAgfQ0KICB9Ow0KICBjb25zdCB2TW9kZWxDaGVja2JveCA9IHsNCiAgICAvLyAjNDA5NiBhcnJheSBjaGVja2JveGVzIG5lZWQgdG8gYmUgZGVlcCB0cmF2ZXJzZWQNCiAgICBkZWVwOiB0cnVlLA0KICAgIGNyZWF0ZWQoZWwsIF8sIHZub2RlKSB7DQogICAgICBlbFthc3NpZ25LZXldID0gZ2V0TW9kZWxBc3NpZ25lcih2bm9kZSk7DQogICAgICBhZGRFdmVudExpc3RlbmVyKGVsLCAiY2hhbmdlIiwgKCkgPT4gew0KICAgICAgICBjb25zdCBtb2RlbFZhbHVlID0gZWwuX21vZGVsVmFsdWU7DQogICAgICAgIGNvbnN0IGVsZW1lbnRWYWx1ZSA9IGdldFZhbHVlKGVsKTsNCiAgICAgICAgY29uc3QgY2hlY2tlZCA9IGVsLmNoZWNrZWQ7DQogICAgICAgIGNvbnN0IGFzc2lnbiA9IGVsW2Fzc2lnbktleV07DQogICAgICAgIGlmIChpc0FycmF5KG1vZGVsVmFsdWUpKSB7DQogICAgICAgICAgY29uc3QgaW5kZXggPSBsb29zZUluZGV4T2YobW9kZWxWYWx1ZSwgZWxlbWVudFZhbHVlKTsNCiAgICAgICAgICBjb25zdCBmb3VuZCA9IGluZGV4ICE9PSAtMTsNCiAgICAgICAgICBpZiAoY2hlY2tlZCAmJiAhZm91bmQpIHsNCiAgICAgICAgICAgIGFzc2lnbihtb2RlbFZhbHVlLmNvbmNhdChlbGVtZW50VmFsdWUpKTsNCiAgICAgICAgICB9IGVsc2UgaWYgKCFjaGVja2VkICYmIGZvdW5kKSB7DQogICAgICAgICAgICBjb25zdCBmaWx0ZXJlZCA9IFsuLi5tb2RlbFZhbHVlXTsNCiAgICAgICAgICAgIGZpbHRlcmVkLnNwbGljZShpbmRleCwgMSk7DQogICAgICAgICAgICBhc3NpZ24oZmlsdGVyZWQpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIGlmIChpc1NldChtb2RlbFZhbHVlKSkgew0KICAgICAgICAgIGNvbnN0IGNsb25lZCA9IG5ldyBTZXQobW9kZWxWYWx1ZSk7DQogICAgICAgICAgaWYgKGNoZWNrZWQpIHsNCiAgICAgICAgICAgIGNsb25lZC5hZGQoZWxlbWVudFZhbHVlKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgY2xvbmVkLmRlbGV0ZShlbGVtZW50VmFsdWUpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBhc3NpZ24oY2xvbmVkKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBhc3NpZ24oZ2V0Q2hlY2tib3hWYWx1ZShlbCwgY2hlY2tlZCkpOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICB9LA0KICAgIC8vIHNldCBpbml0aWFsIGNoZWNrZWQgb24gbW91bnQgdG8gd2FpdCBmb3IgdHJ1ZS12YWx1ZS9mYWxzZS12YWx1ZQ0KICAgIG1vdW50ZWQ6IHNldENoZWNrZWQsDQogICAgYmVmb3JlVXBkYXRlKGVsLCBiaW5kaW5nLCB2bm9kZSkgew0KICAgICAgZWxbYXNzaWduS2V5XSA9IGdldE1vZGVsQXNzaWduZXIodm5vZGUpOw0KICAgICAgc2V0Q2hlY2tlZChlbCwgYmluZGluZywgdm5vZGUpOw0KICAgIH0NCiAgfTsNCiAgZnVuY3Rpb24gc2V0Q2hlY2tlZChlbCwgeyB2YWx1ZSwgb2xkVmFsdWUgfSwgdm5vZGUpIHsNCiAgICBlbC5fbW9kZWxWYWx1ZSA9IHZhbHVlOw0KICAgIGxldCBjaGVja2VkOw0KICAgIGlmIChpc0FycmF5KHZhbHVlKSkgew0KICAgICAgY2hlY2tlZCA9IGxvb3NlSW5kZXhPZih2YWx1ZSwgdm5vZGUucHJvcHMudmFsdWUpID4gLTE7DQogICAgfSBlbHNlIGlmIChpc1NldCh2YWx1ZSkpIHsNCiAgICAgIGNoZWNrZWQgPSB2YWx1ZS5oYXModm5vZGUucHJvcHMudmFsdWUpOw0KICAgIH0gZWxzZSB7DQogICAgICBpZiAodmFsdWUgPT09IG9sZFZhbHVlKSByZXR1cm47DQogICAgICBjaGVja2VkID0gbG9vc2VFcXVhbCh2YWx1ZSwgZ2V0Q2hlY2tib3hWYWx1ZShlbCwgdHJ1ZSkpOw0KICAgIH0NCiAgICBpZiAoZWwuY2hlY2tlZCAhPT0gY2hlY2tlZCkgew0KICAgICAgZWwuY2hlY2tlZCA9IGNoZWNrZWQ7DQogICAgfQ0KICB9DQogIGNvbnN0IHZNb2RlbFJhZGlvID0gew0KICAgIGNyZWF0ZWQoZWwsIHsgdmFsdWUgfSwgdm5vZGUpIHsNCiAgICAgIGVsLmNoZWNrZWQgPSBsb29zZUVxdWFsKHZhbHVlLCB2bm9kZS5wcm9wcy52YWx1ZSk7DQogICAgICBlbFthc3NpZ25LZXldID0gZ2V0TW9kZWxBc3NpZ25lcih2bm9kZSk7DQogICAgICBhZGRFdmVudExpc3RlbmVyKGVsLCAiY2hhbmdlIiwgKCkgPT4gew0KICAgICAgICBlbFthc3NpZ25LZXldKGdldFZhbHVlKGVsKSk7DQogICAgICB9KTsNCiAgICB9LA0KICAgIGJlZm9yZVVwZGF0ZShlbCwgeyB2YWx1ZSwgb2xkVmFsdWUgfSwgdm5vZGUpIHsNCiAgICAgIGVsW2Fzc2lnbktleV0gPSBnZXRNb2RlbEFzc2lnbmVyKHZub2RlKTsNCiAgICAgIGlmICh2YWx1ZSAhPT0gb2xkVmFsdWUpIHsNCiAgICAgICAgZWwuY2hlY2tlZCA9IGxvb3NlRXF1YWwodmFsdWUsIHZub2RlLnByb3BzLnZhbHVlKTsNCiAgICAgIH0NCiAgICB9DQogIH07DQogIGNvbnN0IHZNb2RlbFNlbGVjdCA9IHsNCiAgICAvLyA8c2VsZWN0IG11bHRpcGxlPiB2YWx1ZSBuZWVkIHRvIGJlIGRlZXAgdHJhdmVyc2VkDQogICAgZGVlcDogdHJ1ZSwNCiAgICBjcmVhdGVkKGVsLCB7IHZhbHVlLCBtb2RpZmllcnM6IHsgbnVtYmVyIH0gfSwgdm5vZGUpIHsNCiAgICAgIGNvbnN0IGlzU2V0TW9kZWwgPSBpc1NldCh2YWx1ZSk7DQogICAgICBhZGRFdmVudExpc3RlbmVyKGVsLCAiY2hhbmdlIiwgKCkgPT4gew0KICAgICAgICBjb25zdCBzZWxlY3RlZFZhbCA9IEFycmF5LnByb3RvdHlwZS5maWx0ZXIuY2FsbChlbC5vcHRpb25zLCAobykgPT4gby5zZWxlY3RlZCkubWFwKA0KICAgICAgICAgIChvKSA9PiBudW1iZXIgPyBsb29zZVRvTnVtYmVyKGdldFZhbHVlKG8pKSA6IGdldFZhbHVlKG8pDQogICAgICAgICk7DQogICAgICAgIGVsW2Fzc2lnbktleV0oDQogICAgICAgICAgZWwubXVsdGlwbGUgPyBpc1NldE1vZGVsID8gbmV3IFNldChzZWxlY3RlZFZhbCkgOiBzZWxlY3RlZFZhbCA6IHNlbGVjdGVkVmFsWzBdDQogICAgICAgICk7DQogICAgICAgIGVsLl9hc3NpZ25pbmcgPSB0cnVlOw0KICAgICAgICBuZXh0VGljaygoKSA9PiB7DQogICAgICAgICAgZWwuX2Fzc2lnbmluZyA9IGZhbHNlOw0KICAgICAgICB9KTsNCiAgICAgIH0pOw0KICAgICAgZWxbYXNzaWduS2V5XSA9IGdldE1vZGVsQXNzaWduZXIodm5vZGUpOw0KICAgIH0sDQogICAgLy8gc2V0IHZhbHVlIGluIG1vdW50ZWQgJiB1cGRhdGVkIGJlY2F1c2UgPHNlbGVjdD4gcmVsaWVzIG9uIGl0cyBjaGlsZHJlbg0KICAgIC8vIDxvcHRpb24+cy4NCiAgICBtb3VudGVkKGVsLCB7IHZhbHVlIH0pIHsNCiAgICAgIHNldFNlbGVjdGVkKGVsLCB2YWx1ZSk7DQogICAgfSwNCiAgICBiZWZvcmVVcGRhdGUoZWwsIF9iaW5kaW5nLCB2bm9kZSkgew0KICAgICAgZWxbYXNzaWduS2V5XSA9IGdldE1vZGVsQXNzaWduZXIodm5vZGUpOw0KICAgIH0sDQogICAgdXBkYXRlZChlbCwgeyB2YWx1ZSB9KSB7DQogICAgICBpZiAoIWVsLl9hc3NpZ25pbmcpIHsNCiAgICAgICAgc2V0U2VsZWN0ZWQoZWwsIHZhbHVlKTsNCiAgICAgIH0NCiAgICB9DQogIH07DQogIGZ1bmN0aW9uIHNldFNlbGVjdGVkKGVsLCB2YWx1ZSkgew0KICAgIGNvbnN0IGlzTXVsdGlwbGUgPSBlbC5tdWx0aXBsZTsNCiAgICBjb25zdCBpc0FycmF5VmFsdWUgPSBpc0FycmF5KHZhbHVlKTsNCiAgICBpZiAoaXNNdWx0aXBsZSAmJiAhaXNBcnJheVZhbHVlICYmICFpc1NldCh2YWx1ZSkpIHsNCiAgICAgIHdhcm4oDQogICAgICAgIGA8c2VsZWN0IG11bHRpcGxlIHYtbW9kZWw+IGV4cGVjdHMgYW4gQXJyYXkgb3IgU2V0IHZhbHVlIGZvciBpdHMgYmluZGluZywgYnV0IGdvdCAke09iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkuc2xpY2UoOCwgLTEpfS5gDQogICAgICApOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBmb3IgKGxldCBpID0gMCwgbCA9IGVsLm9wdGlvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7DQogICAgICBjb25zdCBvcHRpb24gPSBlbC5vcHRpb25zW2ldOw0KICAgICAgY29uc3Qgb3B0aW9uVmFsdWUgPSBnZXRWYWx1ZShvcHRpb24pOw0KICAgICAgaWYgKGlzTXVsdGlwbGUpIHsNCiAgICAgICAgaWYgKGlzQXJyYXlWYWx1ZSkgew0KICAgICAgICAgIGNvbnN0IG9wdGlvblR5cGUgPSB0eXBlb2Ygb3B0aW9uVmFsdWU7DQogICAgICAgICAgaWYgKG9wdGlvblR5cGUgPT09ICJzdHJpbmciIHx8IG9wdGlvblR5cGUgPT09ICJudW1iZXIiKSB7DQogICAgICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSB2YWx1ZS5zb21lKCh2KSA9PiBTdHJpbmcodikgPT09IFN0cmluZyhvcHRpb25WYWx1ZSkpOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBsb29zZUluZGV4T2YodmFsdWUsIG9wdGlvblZhbHVlKSA+IC0xOw0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSB2YWx1ZS5oYXMob3B0aW9uVmFsdWUpOw0KICAgICAgICB9DQogICAgICB9IGVsc2UgaWYgKGxvb3NlRXF1YWwoZ2V0VmFsdWUob3B0aW9uKSwgdmFsdWUpKSB7DQogICAgICAgIGlmIChlbC5zZWxlY3RlZEluZGV4ICE9PSBpKSBlbC5zZWxlY3RlZEluZGV4ID0gaTsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAoIWlzTXVsdGlwbGUgJiYgZWwuc2VsZWN0ZWRJbmRleCAhPT0gLTEpIHsNCiAgICAgIGVsLnNlbGVjdGVkSW5kZXggPSAtMTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gZ2V0VmFsdWUoZWwpIHsNCiAgICByZXR1cm4gIl92YWx1ZSIgaW4gZWwgPyBlbC5fdmFsdWUgOiBlbC52YWx1ZTsNCiAgfQ0KICBmdW5jdGlvbiBnZXRDaGVja2JveFZhbHVlKGVsLCBjaGVja2VkKSB7DQogICAgY29uc3Qga2V5ID0gY2hlY2tlZCA/ICJfdHJ1ZVZhbHVlIiA6ICJfZmFsc2VWYWx1ZSI7DQogICAgcmV0dXJuIGtleSBpbiBlbCA/IGVsW2tleV0gOiBjaGVja2VkOw0KICB9DQogIGNvbnN0IHZNb2RlbER5bmFtaWMgPSB7DQogICAgY3JlYXRlZChlbCwgYmluZGluZywgdm5vZGUpIHsNCiAgICAgIGNhbGxNb2RlbEhvb2soZWwsIGJpbmRpbmcsIHZub2RlLCBudWxsLCAiY3JlYXRlZCIpOw0KICAgIH0sDQogICAgbW91bnRlZChlbCwgYmluZGluZywgdm5vZGUpIHsNCiAgICAgIGNhbGxNb2RlbEhvb2soZWwsIGJpbmRpbmcsIHZub2RlLCBudWxsLCAibW91bnRlZCIpOw0KICAgIH0sDQogICAgYmVmb3JlVXBkYXRlKGVsLCBiaW5kaW5nLCB2bm9kZSwgcHJldlZOb2RlKSB7DQogICAgICBjYWxsTW9kZWxIb29rKGVsLCBiaW5kaW5nLCB2bm9kZSwgcHJldlZOb2RlLCAiYmVmb3JlVXBkYXRlIik7DQogICAgfSwNCiAgICB1cGRhdGVkKGVsLCBiaW5kaW5nLCB2bm9kZSwgcHJldlZOb2RlKSB7DQogICAgICBjYWxsTW9kZWxIb29rKGVsLCBiaW5kaW5nLCB2bm9kZSwgcHJldlZOb2RlLCAidXBkYXRlZCIpOw0KICAgIH0NCiAgfTsNCiAgZnVuY3Rpb24gcmVzb2x2ZUR5bmFtaWNNb2RlbCh0YWdOYW1lLCB0eXBlKSB7DQogICAgc3dpdGNoICh0YWdOYW1lKSB7DQogICAgICBjYXNlICJTRUxFQ1QiOg0KICAgICAgICByZXR1cm4gdk1vZGVsU2VsZWN0Ow0KICAgICAgY2FzZSAiVEVYVEFSRUEiOg0KICAgICAgICByZXR1cm4gdk1vZGVsVGV4dDsNCiAgICAgIGRlZmF1bHQ6DQogICAgICAgIHN3aXRjaCAodHlwZSkgew0KICAgICAgICAgIGNhc2UgImNoZWNrYm94IjoNCiAgICAgICAgICAgIHJldHVybiB2TW9kZWxDaGVja2JveDsNCiAgICAgICAgICBjYXNlICJyYWRpbyI6DQogICAgICAgICAgICByZXR1cm4gdk1vZGVsUmFkaW87DQogICAgICAgICAgZGVmYXVsdDoNCiAgICAgICAgICAgIHJldHVybiB2TW9kZWxUZXh0Ow0KICAgICAgICB9DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGNhbGxNb2RlbEhvb2soZWwsIGJpbmRpbmcsIHZub2RlLCBwcmV2Vk5vZGUsIGhvb2spIHsNCiAgICBjb25zdCBtb2RlbFRvVXNlID0gcmVzb2x2ZUR5bmFtaWNNb2RlbCgNCiAgICAgIGVsLnRhZ05hbWUsDQogICAgICB2bm9kZS5wcm9wcyAmJiB2bm9kZS5wcm9wcy50eXBlDQogICAgKTsNCiAgICBjb25zdCBmbiA9IG1vZGVsVG9Vc2VbaG9va107DQogICAgZm4gJiYgZm4oZWwsIGJpbmRpbmcsIHZub2RlLCBwcmV2Vk5vZGUpOw0KICB9DQoNCiAgY29uc3Qgc3lzdGVtTW9kaWZpZXJzID0gWyJjdHJsIiwgInNoaWZ0IiwgImFsdCIsICJtZXRhIl07DQogIGNvbnN0IG1vZGlmaWVyR3VhcmRzID0gew0KICAgIHN0b3A6IChlKSA9PiBlLnN0b3BQcm9wYWdhdGlvbigpLA0KICAgIHByZXZlbnQ6IChlKSA9PiBlLnByZXZlbnREZWZhdWx0KCksDQogICAgc2VsZjogKGUpID0+IGUudGFyZ2V0ICE9PSBlLmN1cnJlbnRUYXJnZXQsDQogICAgY3RybDogKGUpID0+ICFlLmN0cmxLZXksDQogICAgc2hpZnQ6IChlKSA9PiAhZS5zaGlmdEtleSwNCiAgICBhbHQ6IChlKSA9PiAhZS5hbHRLZXksDQogICAgbWV0YTogKGUpID0+ICFlLm1ldGFLZXksDQogICAgbGVmdDogKGUpID0+ICJidXR0b24iIGluIGUgJiYgZS5idXR0b24gIT09IDAsDQogICAgbWlkZGxlOiAoZSkgPT4gImJ1dHRvbiIgaW4gZSAmJiBlLmJ1dHRvbiAhPT0gMSwNCiAgICByaWdodDogKGUpID0+ICJidXR0b24iIGluIGUgJiYgZS5idXR0b24gIT09IDIsDQogICAgZXhhY3Q6IChlLCBtb2RpZmllcnMpID0+IHN5c3RlbU1vZGlmaWVycy5zb21lKChtKSA9PiBlW2Ake219S2V5YF0gJiYgIW1vZGlmaWVycy5pbmNsdWRlcyhtKSkNCiAgfTsNCiAgY29uc3Qgd2l0aE1vZGlmaWVycyA9IChmbiwgbW9kaWZpZXJzKSA9PiB7DQogICAgY29uc3QgY2FjaGUgPSBmbi5fd2l0aE1vZHMgfHwgKGZuLl93aXRoTW9kcyA9IHt9KTsNCiAgICBjb25zdCBjYWNoZUtleSA9IG1vZGlmaWVycy5qb2luKCIuIik7DQogICAgcmV0dXJuIGNhY2hlW2NhY2hlS2V5XSB8fCAoY2FjaGVbY2FjaGVLZXldID0gKGV2ZW50LCAuLi5hcmdzKSA9PiB7DQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1vZGlmaWVycy5sZW5ndGg7IGkrKykgew0KICAgICAgICBjb25zdCBndWFyZCA9IG1vZGlmaWVyR3VhcmRzW21vZGlmaWVyc1tpXV07DQogICAgICAgIGlmIChndWFyZCAmJiBndWFyZChldmVudCwgbW9kaWZpZXJzKSkgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIGZuKGV2ZW50LCAuLi5hcmdzKTsNCiAgICB9KTsNCiAgfTsNCiAgY29uc3Qga2V5TmFtZXMgPSB7DQogICAgZXNjOiAiZXNjYXBlIiwNCiAgICBzcGFjZTogIiAiLA0KICAgIHVwOiAiYXJyb3ctdXAiLA0KICAgIGxlZnQ6ICJhcnJvdy1sZWZ0IiwNCiAgICByaWdodDogImFycm93LXJpZ2h0IiwNCiAgICBkb3duOiAiYXJyb3ctZG93biIsDQogICAgZGVsZXRlOiAiYmFja3NwYWNlIg0KICB9Ow0KICBjb25zdCB3aXRoS2V5cyA9IChmbiwgbW9kaWZpZXJzKSA9PiB7DQogICAgY29uc3QgY2FjaGUgPSBmbi5fd2l0aEtleXMgfHwgKGZuLl93aXRoS2V5cyA9IHt9KTsNCiAgICBjb25zdCBjYWNoZUtleSA9IG1vZGlmaWVycy5qb2luKCIuIik7DQogICAgcmV0dXJuIGNhY2hlW2NhY2hlS2V5XSB8fCAoY2FjaGVbY2FjaGVLZXldID0gKGV2ZW50KSA9PiB7DQogICAgICBpZiAoISgia2V5IiBpbiBldmVudCkpIHsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgY29uc3QgZXZlbnRLZXkgPSBoeXBoZW5hdGUoZXZlbnQua2V5KTsNCiAgICAgIGlmIChtb2RpZmllcnMuc29tZSgNCiAgICAgICAgKGspID0+IGsgPT09IGV2ZW50S2V5IHx8IGtleU5hbWVzW2tdID09PSBldmVudEtleQ0KICAgICAgKSkgew0KICAgICAgICByZXR1cm4gZm4oZXZlbnQpOw0KICAgICAgfQ0KICAgIH0pOw0KICB9Ow0KDQogIGNvbnN0IHJlbmRlcmVyT3B0aW9ucyA9IC8qIEBfX1BVUkVfXyAqLyBleHRlbmQoeyBwYXRjaFByb3AgfSwgbm9kZU9wcyk7DQogIGxldCByZW5kZXJlcjsNCiAgbGV0IGVuYWJsZWRIeWRyYXRpb24gPSBmYWxzZTsNCiAgZnVuY3Rpb24gZW5zdXJlUmVuZGVyZXIoKSB7DQogICAgcmV0dXJuIHJlbmRlcmVyIHx8IChyZW5kZXJlciA9IGNyZWF0ZVJlbmRlcmVyKHJlbmRlcmVyT3B0aW9ucykpOw0KICB9DQogIGZ1bmN0aW9uIGVuc3VyZUh5ZHJhdGlvblJlbmRlcmVyKCkgew0KICAgIHJlbmRlcmVyID0gZW5hYmxlZEh5ZHJhdGlvbiA/IHJlbmRlcmVyIDogY3JlYXRlSHlkcmF0aW9uUmVuZGVyZXIocmVuZGVyZXJPcHRpb25zKTsNCiAgICBlbmFibGVkSHlkcmF0aW9uID0gdHJ1ZTsNCiAgICByZXR1cm4gcmVuZGVyZXI7DQogIH0NCiAgY29uc3QgcmVuZGVyID0gKC4uLmFyZ3MpID0+IHsNCiAgICBlbnN1cmVSZW5kZXJlcigpLnJlbmRlciguLi5hcmdzKTsNCiAgfTsNCiAgY29uc3QgaHlkcmF0ZSA9ICguLi5hcmdzKSA9PiB7DQogICAgZW5zdXJlSHlkcmF0aW9uUmVuZGVyZXIoKS5oeWRyYXRlKC4uLmFyZ3MpOw0KICB9Ow0KICBjb25zdCBjcmVhdGVBcHAgPSAoLi4uYXJncykgPT4gew0KICAgIGNvbnN0IGFwcCA9IGVuc3VyZVJlbmRlcmVyKCkuY3JlYXRlQXBwKC4uLmFyZ3MpOw0KICAgIHsNCiAgICAgIGluamVjdE5hdGl2ZVRhZ0NoZWNrKGFwcCk7DQogICAgICBpbmplY3RDb21waWxlck9wdGlvbnNDaGVjayhhcHApOw0KICAgIH0NCiAgICBjb25zdCB7IG1vdW50IH0gPSBhcHA7DQogICAgYXBwLm1vdW50ID0gKGNvbnRhaW5lck9yU2VsZWN0b3IpID0+IHsNCiAgICAgIGNvbnN0IGNvbnRhaW5lciA9IG5vcm1hbGl6ZUNvbnRhaW5lcihjb250YWluZXJPclNlbGVjdG9yKTsNCiAgICAgIGlmICghY29udGFpbmVyKSByZXR1cm47DQogICAgICBjb25zdCBjb21wb25lbnQgPSBhcHAuX2NvbXBvbmVudDsNCiAgICAgIGlmICghaXNGdW5jdGlvbihjb21wb25lbnQpICYmICFjb21wb25lbnQucmVuZGVyICYmICFjb21wb25lbnQudGVtcGxhdGUpIHsNCiAgICAgICAgY29tcG9uZW50LnRlbXBsYXRlID0gY29udGFpbmVyLmlubmVySFRNTDsNCiAgICAgIH0NCiAgICAgIGlmIChjb250YWluZXIubm9kZVR5cGUgPT09IDEpIHsNCiAgICAgICAgY29udGFpbmVyLnRleHRDb250ZW50ID0gIiI7DQogICAgICB9DQogICAgICBjb25zdCBwcm94eSA9IG1vdW50KGNvbnRhaW5lciwgZmFsc2UsIHJlc29sdmVSb290TmFtZXNwYWNlKGNvbnRhaW5lcikpOw0KICAgICAgaWYgKGNvbnRhaW5lciBpbnN0YW5jZW9mIEVsZW1lbnQpIHsNCiAgICAgICAgY29udGFpbmVyLnJlbW92ZUF0dHJpYnV0ZSgidi1jbG9hayIpOw0KICAgICAgICBjb250YWluZXIuc2V0QXR0cmlidXRlKCJkYXRhLXYtYXBwIiwgIiIpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIHByb3h5Ow0KICAgIH07DQogICAgcmV0dXJuIGFwcDsNCiAgfTsNCiAgY29uc3QgY3JlYXRlU1NSQXBwID0gKC4uLmFyZ3MpID0+IHsNCiAgICBjb25zdCBhcHAgPSBlbnN1cmVIeWRyYXRpb25SZW5kZXJlcigpLmNyZWF0ZUFwcCguLi5hcmdzKTsNCiAgICB7DQogICAgICBpbmplY3ROYXRpdmVUYWdDaGVjayhhcHApOw0KICAgICAgaW5qZWN0Q29tcGlsZXJPcHRpb25zQ2hlY2soYXBwKTsNCiAgICB9DQogICAgY29uc3QgeyBtb3VudCB9ID0gYXBwOw0KICAgIGFwcC5tb3VudCA9IChjb250YWluZXJPclNlbGVjdG9yKSA9PiB7DQogICAgICBjb25zdCBjb250YWluZXIgPSBub3JtYWxpemVDb250YWluZXIoY29udGFpbmVyT3JTZWxlY3Rvcik7DQogICAgICBpZiAoY29udGFpbmVyKSB7DQogICAgICAgIHJldHVybiBtb3VudChjb250YWluZXIsIHRydWUsIHJlc29sdmVSb290TmFtZXNwYWNlKGNvbnRhaW5lcikpOw0KICAgICAgfQ0KICAgIH07DQogICAgcmV0dXJuIGFwcDsNCiAgfTsNCiAgZnVuY3Rpb24gcmVzb2x2ZVJvb3ROYW1lc3BhY2UoY29udGFpbmVyKSB7DQogICAgaWYgKGNvbnRhaW5lciBpbnN0YW5jZW9mIFNWR0VsZW1lbnQpIHsNCiAgICAgIHJldHVybiAic3ZnIjsNCiAgICB9DQogICAgaWYgKHR5cGVvZiBNYXRoTUxFbGVtZW50ID09PSAiZnVuY3Rpb24iICYmIGNvbnRhaW5lciBpbnN0YW5jZW9mIE1hdGhNTEVsZW1lbnQpIHsNCiAgICAgIHJldHVybiAibWF0aG1sIjsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gaW5qZWN0TmF0aXZlVGFnQ2hlY2soYXBwKSB7DQogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGFwcC5jb25maWcsICJpc05hdGl2ZVRhZyIsIHsNCiAgICAgIHZhbHVlOiAodGFnKSA9PiBpc0hUTUxUYWcodGFnKSB8fCBpc1NWR1RhZyh0YWcpIHx8IGlzTWF0aE1MVGFnKHRhZyksDQogICAgICB3cml0YWJsZTogZmFsc2UNCiAgICB9KTsNCiAgfQ0KICBmdW5jdGlvbiBpbmplY3RDb21waWxlck9wdGlvbnNDaGVjayhhcHApIHsNCiAgICBpZiAoaXNSdW50aW1lT25seSgpKSB7DQogICAgICBjb25zdCBpc0N1c3RvbUVsZW1lbnQgPSBhcHAuY29uZmlnLmlzQ3VzdG9tRWxlbWVudDsNCiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShhcHAuY29uZmlnLCAiaXNDdXN0b21FbGVtZW50Iiwgew0KICAgICAgICBnZXQoKSB7DQogICAgICAgICAgcmV0dXJuIGlzQ3VzdG9tRWxlbWVudDsNCiAgICAgICAgfSwNCiAgICAgICAgc2V0KCkgew0KICAgICAgICAgIHdhcm4oDQogICAgICAgICAgICBgVGhlIFxgaXNDdXN0b21FbGVtZW50XGAgY29uZmlnIG9wdGlvbiBpcyBkZXByZWNhdGVkLiBVc2UgXGBjb21waWxlck9wdGlvbnMuaXNDdXN0b21FbGVtZW50XGAgaW5zdGVhZC5gDQogICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgICAgfSk7DQogICAgICBjb25zdCBjb21waWxlck9wdGlvbnMgPSBhcHAuY29uZmlnLmNvbXBpbGVyT3B0aW9uczsNCiAgICAgIGNvbnN0IG1zZyA9IGBUaGUgXGBjb21waWxlck9wdGlvbnNcYCBjb25maWcgb3B0aW9uIGlzIG9ubHkgcmVzcGVjdGVkIHdoZW4gdXNpbmcgYSBidWlsZCBvZiBWdWUuanMgdGhhdCBpbmNsdWRlcyB0aGUgcnVudGltZSBjb21waWxlciAoYWthICJmdWxsIGJ1aWxkIikuIFNpbmNlIHlvdSBhcmUgdXNpbmcgdGhlIHJ1bnRpbWUtb25seSBidWlsZCwgXGBjb21waWxlck9wdGlvbnNcYCBtdXN0IGJlIHBhc3NlZCB0byBcYEB2dWUvY29tcGlsZXItZG9tXGAgaW4gdGhlIGJ1aWxkIHNldHVwIGluc3RlYWQuDQotIEZvciB2dWUtbG9hZGVyOiBwYXNzIGl0IHZpYSB2dWUtbG9hZGVyJ3MgXGBjb21waWxlck9wdGlvbnNcYCBsb2FkZXIgb3B0aW9uLg0KLSBGb3IgdnVlLWNsaTogc2VlIGh0dHBzOi8vY2xpLnZ1ZWpzLm9yZy9ndWlkZS93ZWJwYWNrLmh0bWwjbW9kaWZ5aW5nLW9wdGlvbnMtb2YtYS1sb2FkZXINCi0gRm9yIHZpdGU6IHBhc3MgaXQgdmlhIEB2aXRlanMvcGx1Z2luLXZ1ZSBvcHRpb25zLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3ZpdGVqcy92aXRlLXBsdWdpbi12dWUvdHJlZS9tYWluL3BhY2thZ2VzL3BsdWdpbi12dWUjZXhhbXBsZS1mb3ItcGFzc2luZy1vcHRpb25zLXRvLXZ1ZWNvbXBpbGVyLXNmY2A7DQogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYXBwLmNvbmZpZywgImNvbXBpbGVyT3B0aW9ucyIsIHsNCiAgICAgICAgZ2V0KCkgew0KICAgICAgICAgIHdhcm4obXNnKTsNCiAgICAgICAgICByZXR1cm4gY29tcGlsZXJPcHRpb25zOw0KICAgICAgICB9LA0KICAgICAgICBzZXQoKSB7DQogICAgICAgICAgd2Fybihtc2cpOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gbm9ybWFsaXplQ29udGFpbmVyKGNvbnRhaW5lcikgew0KICAgIGlmIChpc1N0cmluZyhjb250YWluZXIpKSB7DQogICAgICBjb25zdCByZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGNvbnRhaW5lcik7DQogICAgICBpZiAoIXJlcykgew0KICAgICAgICB3YXJuKA0KICAgICAgICAgIGBGYWlsZWQgdG8gbW91bnQgYXBwOiBtb3VudCB0YXJnZXQgc2VsZWN0b3IgIiR7Y29udGFpbmVyfSIgcmV0dXJuZWQgbnVsbC5gDQogICAgICAgICk7DQogICAgICB9DQogICAgICByZXR1cm4gcmVzOw0KICAgIH0NCiAgICBpZiAod2luZG93LlNoYWRvd1Jvb3QgJiYgY29udGFpbmVyIGluc3RhbmNlb2Ygd2luZG93LlNoYWRvd1Jvb3QgJiYgY29udGFpbmVyLm1vZGUgPT09ICJjbG9zZWQiKSB7DQogICAgICB3YXJuKA0KICAgICAgICBgbW91bnRpbmcgb24gYSBTaGFkb3dSb290IHdpdGggXGB7bW9kZTogImNsb3NlZCJ9XGAgbWF5IGxlYWQgdG8gdW5wcmVkaWN0YWJsZSBidWdzYA0KICAgICAgKTsNCiAgICB9DQogICAgcmV0dXJuIGNvbnRhaW5lcjsNCiAgfQ0KICBjb25zdCBpbml0RGlyZWN0aXZlc0ZvclNTUiA9IE5PT1A7DQoNCiAgZnVuY3Rpb24gaW5pdERldigpIHsNCiAgICB7DQogICAgICB7DQogICAgICAgIGNvbnNvbGUuaW5mbygNCiAgICAgICAgICBgWW91IGFyZSBydW5uaW5nIGEgZGV2ZWxvcG1lbnQgYnVpbGQgb2YgVnVlLg0KTWFrZSBzdXJlIHRvIHVzZSB0aGUgcHJvZHVjdGlvbiBidWlsZCAoKi5wcm9kLmpzKSB3aGVuIGRlcGxveWluZyBmb3IgcHJvZHVjdGlvbi5gDQogICAgICAgICk7DQogICAgICB9DQogICAgICBpbml0Q3VzdG9tRm9ybWF0dGVyKCk7DQogICAgfQ0KICB9DQoNCiAgY29uc3QgRlJBR01FTlQgPSBTeW1ib2woYEZyYWdtZW50YCApOw0KICBjb25zdCBURUxFUE9SVCA9IFN5bWJvbChgVGVsZXBvcnRgICk7DQogIGNvbnN0IFNVU1BFTlNFID0gU3ltYm9sKGBTdXNwZW5zZWAgKTsNCiAgY29uc3QgS0VFUF9BTElWRSA9IFN5bWJvbChgS2VlcEFsaXZlYCApOw0KICBjb25zdCBCQVNFX1RSQU5TSVRJT04gPSBTeW1ib2woDQogICAgYEJhc2VUcmFuc2l0aW9uYCANCiAgKTsNCiAgY29uc3QgT1BFTl9CTE9DSyA9IFN5bWJvbChgb3BlbkJsb2NrYCApOw0KICBjb25zdCBDUkVBVEVfQkxPQ0sgPSBTeW1ib2woYGNyZWF0ZUJsb2NrYCApOw0KICBjb25zdCBDUkVBVEVfRUxFTUVOVF9CTE9DSyA9IFN5bWJvbCgNCiAgICBgY3JlYXRlRWxlbWVudEJsb2NrYCANCiAgKTsNCiAgY29uc3QgQ1JFQVRFX1ZOT0RFID0gU3ltYm9sKGBjcmVhdGVWTm9kZWAgKTsNCiAgY29uc3QgQ1JFQVRFX0VMRU1FTlRfVk5PREUgPSBTeW1ib2woDQogICAgYGNyZWF0ZUVsZW1lbnRWTm9kZWAgDQogICk7DQogIGNvbnN0IENSRUFURV9DT01NRU5UID0gU3ltYm9sKA0KICAgIGBjcmVhdGVDb21tZW50Vk5vZGVgIA0KICApOw0KICBjb25zdCBDUkVBVEVfVEVYVCA9IFN5bWJvbCgNCiAgICBgY3JlYXRlVGV4dFZOb2RlYCANCiAgKTsNCiAgY29uc3QgQ1JFQVRFX1NUQVRJQyA9IFN5bWJvbCgNCiAgICBgY3JlYXRlU3RhdGljVk5vZGVgIA0KICApOw0KICBjb25zdCBSRVNPTFZFX0NPTVBPTkVOVCA9IFN5bWJvbCgNCiAgICBgcmVzb2x2ZUNvbXBvbmVudGAgDQogICk7DQogIGNvbnN0IFJFU09MVkVfRFlOQU1JQ19DT01QT05FTlQgPSBTeW1ib2woDQogICAgYHJlc29sdmVEeW5hbWljQ29tcG9uZW50YCANCiAgKTsNCiAgY29uc3QgUkVTT0xWRV9ESVJFQ1RJVkUgPSBTeW1ib2woDQogICAgYHJlc29sdmVEaXJlY3RpdmVgIA0KICApOw0KICBjb25zdCBSRVNPTFZFX0ZJTFRFUiA9IFN5bWJvbCgNCiAgICBgcmVzb2x2ZUZpbHRlcmAgDQogICk7DQogIGNvbnN0IFdJVEhfRElSRUNUSVZFUyA9IFN5bWJvbCgNCiAgICBgd2l0aERpcmVjdGl2ZXNgIA0KICApOw0KICBjb25zdCBSRU5ERVJfTElTVCA9IFN5bWJvbChgcmVuZGVyTGlzdGAgKTsNCiAgY29uc3QgUkVOREVSX1NMT1QgPSBTeW1ib2woYHJlbmRlclNsb3RgICk7DQogIGNvbnN0IENSRUFURV9TTE9UUyA9IFN5bWJvbChgY3JlYXRlU2xvdHNgICk7DQogIGNvbnN0IFRPX0RJU1BMQVlfU1RSSU5HID0gU3ltYm9sKA0KICAgIGB0b0Rpc3BsYXlTdHJpbmdgIA0KICApOw0KICBjb25zdCBNRVJHRV9QUk9QUyA9IFN5bWJvbChgbWVyZ2VQcm9wc2AgKTsNCiAgY29uc3QgTk9STUFMSVpFX0NMQVNTID0gU3ltYm9sKA0KICAgIGBub3JtYWxpemVDbGFzc2AgDQogICk7DQogIGNvbnN0IE5PUk1BTElaRV9TVFlMRSA9IFN5bWJvbCgNCiAgICBgbm9ybWFsaXplU3R5bGVgIA0KICApOw0KICBjb25zdCBOT1JNQUxJWkVfUFJPUFMgPSBTeW1ib2woDQogICAgYG5vcm1hbGl6ZVByb3BzYCANCiAgKTsNCiAgY29uc3QgR1VBUkRfUkVBQ1RJVkVfUFJPUFMgPSBTeW1ib2woDQogICAgYGd1YXJkUmVhY3RpdmVQcm9wc2AgDQogICk7DQogIGNvbnN0IFRPX0hBTkRMRVJTID0gU3ltYm9sKGB0b0hhbmRsZXJzYCApOw0KICBjb25zdCBDQU1FTElaRSA9IFN5bWJvbChgY2FtZWxpemVgICk7DQogIGNvbnN0IENBUElUQUxJWkUgPSBTeW1ib2woYGNhcGl0YWxpemVgICk7DQogIGNvbnN0IFRPX0hBTkRMRVJfS0VZID0gU3ltYm9sKA0KICAgIGB0b0hhbmRsZXJLZXlgIA0KICApOw0KICBjb25zdCBTRVRfQkxPQ0tfVFJBQ0tJTkcgPSBTeW1ib2woDQogICAgYHNldEJsb2NrVHJhY2tpbmdgIA0KICApOw0KICBjb25zdCBQVVNIX1NDT1BFX0lEID0gU3ltYm9sKGBwdXNoU2NvcGVJZGAgKTsNCiAgY29uc3QgUE9QX1NDT1BFX0lEID0gU3ltYm9sKGBwb3BTY29wZUlkYCApOw0KICBjb25zdCBXSVRIX0NUWCA9IFN5bWJvbChgd2l0aEN0eGAgKTsNCiAgY29uc3QgVU5SRUYgPSBTeW1ib2woYHVucmVmYCApOw0KICBjb25zdCBJU19SRUYgPSBTeW1ib2woYGlzUmVmYCApOw0KICBjb25zdCBXSVRIX01FTU8gPSBTeW1ib2woYHdpdGhNZW1vYCApOw0KICBjb25zdCBJU19NRU1PX1NBTUUgPSBTeW1ib2woYGlzTWVtb1NhbWVgICk7DQogIGNvbnN0IGhlbHBlck5hbWVNYXAgPSB7DQogICAgW0ZSQUdNRU5UXTogYEZyYWdtZW50YCwNCiAgICBbVEVMRVBPUlRdOiBgVGVsZXBvcnRgLA0KICAgIFtTVVNQRU5TRV06IGBTdXNwZW5zZWAsDQogICAgW0tFRVBfQUxJVkVdOiBgS2VlcEFsaXZlYCwNCiAgICBbQkFTRV9UUkFOU0lUSU9OXTogYEJhc2VUcmFuc2l0aW9uYCwNCiAgICBbT1BFTl9CTE9DS106IGBvcGVuQmxvY2tgLA0KICAgIFtDUkVBVEVfQkxPQ0tdOiBgY3JlYXRlQmxvY2tgLA0KICAgIFtDUkVBVEVfRUxFTUVOVF9CTE9DS106IGBjcmVhdGVFbGVtZW50QmxvY2tgLA0KICAgIFtDUkVBVEVfVk5PREVdOiBgY3JlYXRlVk5vZGVgLA0KICAgIFtDUkVBVEVfRUxFTUVOVF9WTk9ERV06IGBjcmVhdGVFbGVtZW50Vk5vZGVgLA0KICAgIFtDUkVBVEVfQ09NTUVOVF06IGBjcmVhdGVDb21tZW50Vk5vZGVgLA0KICAgIFtDUkVBVEVfVEVYVF06IGBjcmVhdGVUZXh0Vk5vZGVgLA0KICAgIFtDUkVBVEVfU1RBVElDXTogYGNyZWF0ZVN0YXRpY1ZOb2RlYCwNCiAgICBbUkVTT0xWRV9DT01QT05FTlRdOiBgcmVzb2x2ZUNvbXBvbmVudGAsDQogICAgW1JFU09MVkVfRFlOQU1JQ19DT01QT05FTlRdOiBgcmVzb2x2ZUR5bmFtaWNDb21wb25lbnRgLA0KICAgIFtSRVNPTFZFX0RJUkVDVElWRV06IGByZXNvbHZlRGlyZWN0aXZlYCwNCiAgICBbUkVTT0xWRV9GSUxURVJdOiBgcmVzb2x2ZUZpbHRlcmAsDQogICAgW1dJVEhfRElSRUNUSVZFU106IGB3aXRoRGlyZWN0aXZlc2AsDQogICAgW1JFTkRFUl9MSVNUXTogYHJlbmRlckxpc3RgLA0KICAgIFtSRU5ERVJfU0xPVF06IGByZW5kZXJTbG90YCwNCiAgICBbQ1JFQVRFX1NMT1RTXTogYGNyZWF0ZVNsb3RzYCwNCiAgICBbVE9fRElTUExBWV9TVFJJTkddOiBgdG9EaXNwbGF5U3RyaW5nYCwNCiAgICBbTUVSR0VfUFJPUFNdOiBgbWVyZ2VQcm9wc2AsDQogICAgW05PUk1BTElaRV9DTEFTU106IGBub3JtYWxpemVDbGFzc2AsDQogICAgW05PUk1BTElaRV9TVFlMRV06IGBub3JtYWxpemVTdHlsZWAsDQogICAgW05PUk1BTElaRV9QUk9QU106IGBub3JtYWxpemVQcm9wc2AsDQogICAgW0dVQVJEX1JFQUNUSVZFX1BST1BTXTogYGd1YXJkUmVhY3RpdmVQcm9wc2AsDQogICAgW1RPX0hBTkRMRVJTXTogYHRvSGFuZGxlcnNgLA0KICAgIFtDQU1FTElaRV06IGBjYW1lbGl6ZWAsDQogICAgW0NBUElUQUxJWkVdOiBgY2FwaXRhbGl6ZWAsDQogICAgW1RPX0hBTkRMRVJfS0VZXTogYHRvSGFuZGxlcktleWAsDQogICAgW1NFVF9CTE9DS19UUkFDS0lOR106IGBzZXRCbG9ja1RyYWNraW5nYCwNCiAgICBbUFVTSF9TQ09QRV9JRF06IGBwdXNoU2NvcGVJZGAsDQogICAgW1BPUF9TQ09QRV9JRF06IGBwb3BTY29wZUlkYCwNCiAgICBbV0lUSF9DVFhdOiBgd2l0aEN0eGAsDQogICAgW1VOUkVGXTogYHVucmVmYCwNCiAgICBbSVNfUkVGXTogYGlzUmVmYCwNCiAgICBbV0lUSF9NRU1PXTogYHdpdGhNZW1vYCwNCiAgICBbSVNfTUVNT19TQU1FXTogYGlzTWVtb1NhbWVgDQogIH07DQogIGZ1bmN0aW9uIHJlZ2lzdGVyUnVudGltZUhlbHBlcnMoaGVscGVycykgew0KICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoaGVscGVycykuZm9yRWFjaCgocykgPT4gew0KICAgICAgaGVscGVyTmFtZU1hcFtzXSA9IGhlbHBlcnNbc107DQogICAgfSk7DQogIH0NCg0KICBjb25zdCBsb2NTdHViID0gew0KICAgIHN0YXJ0OiB7IGxpbmU6IDEsIGNvbHVtbjogMSwgb2Zmc2V0OiAwIH0sDQogICAgZW5kOiB7IGxpbmU6IDEsIGNvbHVtbjogMSwgb2Zmc2V0OiAwIH0sDQogICAgc291cmNlOiAiIg0KICB9Ow0KICBmdW5jdGlvbiBjcmVhdGVSb290KGNoaWxkcmVuLCBzb3VyY2UgPSAiIikgew0KICAgIHJldHVybiB7DQogICAgICB0eXBlOiAwLA0KICAgICAgc291cmNlLA0KICAgICAgY2hpbGRyZW4sDQogICAgICBoZWxwZXJzOiAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpLA0KICAgICAgY29tcG9uZW50czogW10sDQogICAgICBkaXJlY3RpdmVzOiBbXSwNCiAgICAgIGhvaXN0czogW10sDQogICAgICBpbXBvcnRzOiBbXSwNCiAgICAgIGNhY2hlZDogW10sDQogICAgICB0ZW1wczogMCwNCiAgICAgIGNvZGVnZW5Ob2RlOiB2b2lkIDAsDQogICAgICBsb2M6IGxvY1N0dWINCiAgICB9Ow0KICB9DQogIGZ1bmN0aW9uIGNyZWF0ZVZOb2RlQ2FsbChjb250ZXh0LCB0YWcsIHByb3BzLCBjaGlsZHJlbiwgcGF0Y2hGbGFnLCBkeW5hbWljUHJvcHMsIGRpcmVjdGl2ZXMsIGlzQmxvY2sgPSBmYWxzZSwgZGlzYWJsZVRyYWNraW5nID0gZmFsc2UsIGlzQ29tcG9uZW50ID0gZmFsc2UsIGxvYyA9IGxvY1N0dWIpIHsNCiAgICBpZiAoY29udGV4dCkgew0KICAgICAgaWYgKGlzQmxvY2spIHsNCiAgICAgICAgY29udGV4dC5oZWxwZXIoT1BFTl9CTE9DSyk7DQogICAgICAgIGNvbnRleHQuaGVscGVyKGdldFZOb2RlQmxvY2tIZWxwZXIoY29udGV4dC5pblNTUiwgaXNDb21wb25lbnQpKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbnRleHQuaGVscGVyKGdldFZOb2RlSGVscGVyKGNvbnRleHQuaW5TU1IsIGlzQ29tcG9uZW50KSk7DQogICAgICB9DQogICAgICBpZiAoZGlyZWN0aXZlcykgew0KICAgICAgICBjb250ZXh0LmhlbHBlcihXSVRIX0RJUkVDVElWRVMpOw0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gew0KICAgICAgdHlwZTogMTMsDQogICAgICB0YWcsDQogICAgICBwcm9wcywNCiAgICAgIGNoaWxkcmVuLA0KICAgICAgcGF0Y2hGbGFnLA0KICAgICAgZHluYW1pY1Byb3BzLA0KICAgICAgZGlyZWN0aXZlcywNCiAgICAgIGlzQmxvY2ssDQogICAgICBkaXNhYmxlVHJhY2tpbmcsDQogICAgICBpc0NvbXBvbmVudCwNCiAgICAgIGxvYw0KICAgIH07DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlQXJyYXlFeHByZXNzaW9uKGVsZW1lbnRzLCBsb2MgPSBsb2NTdHViKSB7DQogICAgcmV0dXJuIHsNCiAgICAgIHR5cGU6IDE3LA0KICAgICAgbG9jLA0KICAgICAgZWxlbWVudHMNCiAgICB9Ow0KICB9DQogIGZ1bmN0aW9uIGNyZWF0ZU9iamVjdEV4cHJlc3Npb24ocHJvcGVydGllcywgbG9jID0gbG9jU3R1Yikgew0KICAgIHJldHVybiB7DQogICAgICB0eXBlOiAxNSwNCiAgICAgIGxvYywNCiAgICAgIHByb3BlcnRpZXMNCiAgICB9Ow0KICB9DQogIGZ1bmN0aW9uIGNyZWF0ZU9iamVjdFByb3BlcnR5KGtleSwgdmFsdWUpIHsNCiAgICByZXR1cm4gew0KICAgICAgdHlwZTogMTYsDQogICAgICBsb2M6IGxvY1N0dWIsDQogICAgICBrZXk6IGlzU3RyaW5nKGtleSkgPyBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGtleSwgdHJ1ZSkgOiBrZXksDQogICAgICB2YWx1ZQ0KICAgIH07DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihjb250ZW50LCBpc1N0YXRpYyA9IGZhbHNlLCBsb2MgPSBsb2NTdHViLCBjb25zdFR5cGUgPSAwKSB7DQogICAgcmV0dXJuIHsNCiAgICAgIHR5cGU6IDQsDQogICAgICBsb2MsDQogICAgICBjb250ZW50LA0KICAgICAgaXNTdGF0aWMsDQogICAgICBjb25zdFR5cGU6IGlzU3RhdGljID8gMyA6IGNvbnN0VHlwZQ0KICAgIH07DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlQ29tcG91bmRFeHByZXNzaW9uKGNoaWxkcmVuLCBsb2MgPSBsb2NTdHViKSB7DQogICAgcmV0dXJuIHsNCiAgICAgIHR5cGU6IDgsDQogICAgICBsb2MsDQogICAgICBjaGlsZHJlbg0KICAgIH07DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlQ2FsbEV4cHJlc3Npb24oY2FsbGVlLCBhcmdzID0gW10sIGxvYyA9IGxvY1N0dWIpIHsNCiAgICByZXR1cm4gew0KICAgICAgdHlwZTogMTQsDQogICAgICBsb2MsDQogICAgICBjYWxsZWUsDQogICAgICBhcmd1bWVudHM6IGFyZ3MNCiAgICB9Ow0KICB9DQogIGZ1bmN0aW9uIGNyZWF0ZUZ1bmN0aW9uRXhwcmVzc2lvbihwYXJhbXMsIHJldHVybnMgPSB2b2lkIDAsIG5ld2xpbmUgPSBmYWxzZSwgaXNTbG90ID0gZmFsc2UsIGxvYyA9IGxvY1N0dWIpIHsNCiAgICByZXR1cm4gew0KICAgICAgdHlwZTogMTgsDQogICAgICBwYXJhbXMsDQogICAgICByZXR1cm5zLA0KICAgICAgbmV3bGluZSwNCiAgICAgIGlzU2xvdCwNCiAgICAgIGxvYw0KICAgIH07DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlQ29uZGl0aW9uYWxFeHByZXNzaW9uKHRlc3QsIGNvbnNlcXVlbnQsIGFsdGVybmF0ZSwgbmV3bGluZSA9IHRydWUpIHsNCiAgICByZXR1cm4gew0KICAgICAgdHlwZTogMTksDQogICAgICB0ZXN0LA0KICAgICAgY29uc2VxdWVudCwNCiAgICAgIGFsdGVybmF0ZSwNCiAgICAgIG5ld2xpbmUsDQogICAgICBsb2M6IGxvY1N0dWINCiAgICB9Ow0KICB9DQogIGZ1bmN0aW9uIGNyZWF0ZUNhY2hlRXhwcmVzc2lvbihpbmRleCwgdmFsdWUsIG5lZWRQYXVzZVRyYWNraW5nID0gZmFsc2UsIGluVk9uY2UgPSBmYWxzZSkgew0KICAgIHJldHVybiB7DQogICAgICB0eXBlOiAyMCwNCiAgICAgIGluZGV4LA0KICAgICAgdmFsdWUsDQogICAgICBuZWVkUGF1c2VUcmFja2luZywNCiAgICAgIGluVk9uY2UsDQogICAgICBuZWVkQXJyYXlTcHJlYWQ6IGZhbHNlLA0KICAgICAgbG9jOiBsb2NTdHViDQogICAgfTsNCiAgfQ0KICBmdW5jdGlvbiBjcmVhdGVCbG9ja1N0YXRlbWVudChib2R5KSB7DQogICAgcmV0dXJuIHsNCiAgICAgIHR5cGU6IDIxLA0KICAgICAgYm9keSwNCiAgICAgIGxvYzogbG9jU3R1Yg0KICAgIH07DQogIH0NCiAgZnVuY3Rpb24gZ2V0Vk5vZGVIZWxwZXIoc3NyLCBpc0NvbXBvbmVudCkgew0KICAgIHJldHVybiBzc3IgfHwgaXNDb21wb25lbnQgPyBDUkVBVEVfVk5PREUgOiBDUkVBVEVfRUxFTUVOVF9WTk9ERTsNCiAgfQ0KICBmdW5jdGlvbiBnZXRWTm9kZUJsb2NrSGVscGVyKHNzciwgaXNDb21wb25lbnQpIHsNCiAgICByZXR1cm4gc3NyIHx8IGlzQ29tcG9uZW50ID8gQ1JFQVRFX0JMT0NLIDogQ1JFQVRFX0VMRU1FTlRfQkxPQ0s7DQogIH0NCiAgZnVuY3Rpb24gY29udmVydFRvQmxvY2sobm9kZSwgeyBoZWxwZXIsIHJlbW92ZUhlbHBlciwgaW5TU1IgfSkgew0KICAgIGlmICghbm9kZS5pc0Jsb2NrKSB7DQogICAgICBub2RlLmlzQmxvY2sgPSB0cnVlOw0KICAgICAgcmVtb3ZlSGVscGVyKGdldFZOb2RlSGVscGVyKGluU1NSLCBub2RlLmlzQ29tcG9uZW50KSk7DQogICAgICBoZWxwZXIoT1BFTl9CTE9DSyk7DQogICAgICBoZWxwZXIoZ2V0Vk5vZGVCbG9ja0hlbHBlcihpblNTUiwgbm9kZS5pc0NvbXBvbmVudCkpOw0KICAgIH0NCiAgfQ0KDQogIGNvbnN0IGRlZmF1bHREZWxpbWl0ZXJzT3BlbiA9IG5ldyBVaW50OEFycmF5KFsxMjMsIDEyM10pOw0KICBjb25zdCBkZWZhdWx0RGVsaW1pdGVyc0Nsb3NlID0gbmV3IFVpbnQ4QXJyYXkoWzEyNSwgMTI1XSk7DQogIGZ1bmN0aW9uIGlzVGFnU3RhcnRDaGFyKGMpIHsNCiAgICByZXR1cm4gYyA+PSA5NyAmJiBjIDw9IDEyMiB8fCBjID49IDY1ICYmIGMgPD0gOTA7DQogIH0NCiAgZnVuY3Rpb24gaXNXaGl0ZXNwYWNlKGMpIHsNCiAgICByZXR1cm4gYyA9PT0gMzIgfHwgYyA9PT0gMTAgfHwgYyA9PT0gOSB8fCBjID09PSAxMiB8fCBjID09PSAxMzsNCiAgfQ0KICBmdW5jdGlvbiBpc0VuZE9mVGFnU2VjdGlvbihjKSB7DQogICAgcmV0dXJuIGMgPT09IDQ3IHx8IGMgPT09IDYyIHx8IGlzV2hpdGVzcGFjZShjKTsNCiAgfQ0KICBmdW5jdGlvbiB0b0NoYXJDb2RlcyhzdHIpIHsNCiAgICBjb25zdCByZXQgPSBuZXcgVWludDhBcnJheShzdHIubGVuZ3RoKTsNCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ci5sZW5ndGg7IGkrKykgew0KICAgICAgcmV0W2ldID0gc3RyLmNoYXJDb2RlQXQoaSk7DQogICAgfQ0KICAgIHJldHVybiByZXQ7DQogIH0NCiAgY29uc3QgU2VxdWVuY2VzID0gew0KICAgIENkYXRhOiBuZXcgVWludDhBcnJheShbNjcsIDY4LCA2NSwgODQsIDY1LCA5MV0pLA0KICAgIC8vIENEQVRBWw0KICAgIENkYXRhRW5kOiBuZXcgVWludDhBcnJheShbOTMsIDkzLCA2Ml0pLA0KICAgIC8vIF1dPg0KICAgIENvbW1lbnRFbmQ6IG5ldyBVaW50OEFycmF5KFs0NSwgNDUsIDYyXSksDQogICAgLy8gYC0tPmANCiAgICBTY3JpcHRFbmQ6IG5ldyBVaW50OEFycmF5KFs2MCwgNDcsIDExNSwgOTksIDExNCwgMTA1LCAxMTIsIDExNl0pLA0KICAgIC8vIGA8XC9zY3JpcHRgDQogICAgU3R5bGVFbmQ6IG5ldyBVaW50OEFycmF5KFs2MCwgNDcsIDExNSwgMTE2LCAxMjEsIDEwOCwgMTAxXSksDQogICAgLy8gYDwvc3R5bGVgDQogICAgVGl0bGVFbmQ6IG5ldyBVaW50OEFycmF5KFs2MCwgNDcsIDExNiwgMTA1LCAxMTYsIDEwOCwgMTAxXSksDQogICAgLy8gYDwvdGl0bGVgDQogICAgVGV4dGFyZWFFbmQ6IG5ldyBVaW50OEFycmF5KFsNCiAgICAgIDYwLA0KICAgICAgNDcsDQogICAgICAxMTYsDQogICAgICAxMDEsDQogICAgICAxMjAsDQogICAgICAxMTYsDQogICAgICA5NywNCiAgICAgIDExNCwNCiAgICAgIDEwMSwNCiAgICAgIDk3DQogICAgXSkNCiAgICAvLyBgPC90ZXh0YXJlYQ0KICB9Ow0KICBjbGFzcyBUb2tlbml6ZXIgew0KICAgIGNvbnN0cnVjdG9yKHN0YWNrLCBjYnMpIHsNCiAgICAgIHRoaXMuc3RhY2sgPSBzdGFjazsNCiAgICAgIHRoaXMuY2JzID0gY2JzOw0KICAgICAgLyoqIFRoZSBjdXJyZW50IHN0YXRlIHRoZSB0b2tlbml6ZXIgaXMgaW4uICovDQogICAgICB0aGlzLnN0YXRlID0gMTsNCiAgICAgIC8qKiBUaGUgcmVhZCBidWZmZXIuICovDQogICAgICB0aGlzLmJ1ZmZlciA9ICIiOw0KICAgICAgLyoqIFRoZSBiZWdpbm5pbmcgb2YgdGhlIHNlY3Rpb24gdGhhdCBpcyBjdXJyZW50bHkgYmVpbmcgcmVhZC4gKi8NCiAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gMDsNCiAgICAgIC8qKiBUaGUgaW5kZXggd2l0aGluIHRoZSBidWZmZXIgdGhhdCB3ZSBhcmUgY3VycmVudGx5IGxvb2tpbmcgYXQuICovDQogICAgICB0aGlzLmluZGV4ID0gMDsNCiAgICAgIC8qKiBUaGUgc3RhcnQgb2YgdGhlIGxhc3QgZW50aXR5LiAqLw0KICAgICAgdGhpcy5lbnRpdHlTdGFydCA9IDA7DQogICAgICAvKiogU29tZSBiZWhhdmlvciwgZWcuIHdoZW4gZGVjb2RpbmcgZW50aXRpZXMsIGlzIGRvbmUgd2hpbGUgd2UgYXJlIGluIGFub3RoZXIgc3RhdGUuIFRoaXMga2VlcHMgdHJhY2sgb2YgdGhlIG90aGVyIHN0YXRlIHR5cGUuICovDQogICAgICB0aGlzLmJhc2VTdGF0ZSA9IDE7DQogICAgICAvKiogRm9yIHNwZWNpYWwgcGFyc2luZyBiZWhhdmlvciBpbnNpZGUgb2Ygc2NyaXB0IGFuZCBzdHlsZSB0YWdzLiAqLw0KICAgICAgdGhpcy5pblJDREFUQSA9IGZhbHNlOw0KICAgICAgLyoqIEZvciBkaXNhYmxpbmcgUkNEQVRBIHRhZ3MgaGFuZGxpbmcgKi8NCiAgICAgIHRoaXMuaW5YTUwgPSBmYWxzZTsNCiAgICAgIC8qKiBGb3IgZGlzYWJsaW5nIGludGVycG9sYXRpb24gcGFyc2luZyBpbiB2LXByZSAqLw0KICAgICAgdGhpcy5pblZQcmUgPSBmYWxzZTsNCiAgICAgIC8qKiBSZWNvcmQgbmV3bGluZSBwb3NpdGlvbnMgZm9yIGZhc3QgbGluZSAvIGNvbHVtbiBjYWxjdWxhdGlvbiAqLw0KICAgICAgdGhpcy5uZXdsaW5lcyA9IFtdOw0KICAgICAgdGhpcy5tb2RlID0gMDsNCiAgICAgIHRoaXMuZGVsaW1pdGVyT3BlbiA9IGRlZmF1bHREZWxpbWl0ZXJzT3BlbjsNCiAgICAgIHRoaXMuZGVsaW1pdGVyQ2xvc2UgPSBkZWZhdWx0RGVsaW1pdGVyc0Nsb3NlOw0KICAgICAgdGhpcy5kZWxpbWl0ZXJJbmRleCA9IC0xOw0KICAgICAgdGhpcy5jdXJyZW50U2VxdWVuY2UgPSB2b2lkIDA7DQogICAgICB0aGlzLnNlcXVlbmNlSW5kZXggPSAwOw0KICAgIH0NCiAgICBnZXQgaW5TRkNSb290KCkgew0KICAgICAgcmV0dXJuIHRoaXMubW9kZSA9PT0gMiAmJiB0aGlzLnN0YWNrLmxlbmd0aCA9PT0gMDsNCiAgICB9DQogICAgcmVzZXQoKSB7DQogICAgICB0aGlzLnN0YXRlID0gMTsNCiAgICAgIHRoaXMubW9kZSA9IDA7DQogICAgICB0aGlzLmJ1ZmZlciA9ICIiOw0KICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSAwOw0KICAgICAgdGhpcy5pbmRleCA9IDA7DQogICAgICB0aGlzLmJhc2VTdGF0ZSA9IDE7DQogICAgICB0aGlzLmluUkNEQVRBID0gZmFsc2U7DQogICAgICB0aGlzLmN1cnJlbnRTZXF1ZW5jZSA9IHZvaWQgMDsNCiAgICAgIHRoaXMubmV3bGluZXMubGVuZ3RoID0gMDsNCiAgICAgIHRoaXMuZGVsaW1pdGVyT3BlbiA9IGRlZmF1bHREZWxpbWl0ZXJzT3BlbjsNCiAgICAgIHRoaXMuZGVsaW1pdGVyQ2xvc2UgPSBkZWZhdWx0RGVsaW1pdGVyc0Nsb3NlOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiBHZW5lcmF0ZSBQb3NpdGlvbiBvYmplY3Qgd2l0aCBsaW5lIC8gY29sdW1uIGluZm9ybWF0aW9uIHVzaW5nIHJlY29yZGVkDQogICAgICogbmV3bGluZSBwb3NpdGlvbnMuIFdlIGtub3cgdGhlIGluZGV4IGlzIGFsd2F5cyBnb2luZyB0byBiZSBhbiBhbHJlYWR5DQogICAgICogcHJvY2Vzc2VkIGluZGV4LCBzbyBhbGwgdGhlIG5ld2xpbmVzIHVwIHRvIHRoaXMgaW5kZXggc2hvdWxkIGhhdmUgYmVlbg0KICAgICAqIHJlY29yZGVkLg0KICAgICAqLw0KICAgIGdldFBvcyhpbmRleCkgew0KICAgICAgbGV0IGxpbmUgPSAxOw0KICAgICAgbGV0IGNvbHVtbiA9IGluZGV4ICsgMTsNCiAgICAgIGZvciAobGV0IGkgPSB0aGlzLm5ld2xpbmVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7DQogICAgICAgIGNvbnN0IG5ld2xpbmVJbmRleCA9IHRoaXMubmV3bGluZXNbaV07DQogICAgICAgIGlmIChpbmRleCA+IG5ld2xpbmVJbmRleCkgew0KICAgICAgICAgIGxpbmUgPSBpICsgMjsNCiAgICAgICAgICBjb2x1bW4gPSBpbmRleCAtIG5ld2xpbmVJbmRleDsNCiAgICAgICAgICBicmVhazsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcmV0dXJuIHsNCiAgICAgICAgY29sdW1uLA0KICAgICAgICBsaW5lLA0KICAgICAgICBvZmZzZXQ6IGluZGV4DQogICAgICB9Ow0KICAgIH0NCiAgICBwZWVrKCkgew0KICAgICAgcmV0dXJuIHRoaXMuYnVmZmVyLmNoYXJDb2RlQXQodGhpcy5pbmRleCArIDEpOw0KICAgIH0NCiAgICBzdGF0ZVRleHQoYykgew0KICAgICAgaWYgKGMgPT09IDYwKSB7DQogICAgICAgIGlmICh0aGlzLmluZGV4ID4gdGhpcy5zZWN0aW9uU3RhcnQpIHsNCiAgICAgICAgICB0aGlzLmNicy5vbnRleHQodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXgpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuc3RhdGUgPSA1Ow0KICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXg7DQogICAgICB9IGVsc2UgaWYgKCF0aGlzLmluVlByZSAmJiBjID09PSB0aGlzLmRlbGltaXRlck9wZW5bMF0pIHsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IDI7DQogICAgICAgIHRoaXMuZGVsaW1pdGVySW5kZXggPSAwOw0KICAgICAgICB0aGlzLnN0YXRlSW50ZXJwb2xhdGlvbk9wZW4oYyk7DQogICAgICB9DQogICAgfQ0KICAgIHN0YXRlSW50ZXJwb2xhdGlvbk9wZW4oYykgew0KICAgICAgaWYgKGMgPT09IHRoaXMuZGVsaW1pdGVyT3Blblt0aGlzLmRlbGltaXRlckluZGV4XSkgew0KICAgICAgICBpZiAodGhpcy5kZWxpbWl0ZXJJbmRleCA9PT0gdGhpcy5kZWxpbWl0ZXJPcGVuLmxlbmd0aCAtIDEpIHsNCiAgICAgICAgICBjb25zdCBzdGFydCA9IHRoaXMuaW5kZXggKyAxIC0gdGhpcy5kZWxpbWl0ZXJPcGVuLmxlbmd0aDsNCiAgICAgICAgICBpZiAoc3RhcnQgPiB0aGlzLnNlY3Rpb25TdGFydCkgew0KICAgICAgICAgICAgdGhpcy5jYnMub250ZXh0KHRoaXMuc2VjdGlvblN0YXJ0LCBzdGFydCk7DQogICAgICAgICAgfQ0KICAgICAgICAgIHRoaXMuc3RhdGUgPSAzOw0KICAgICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gc3RhcnQ7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgdGhpcy5kZWxpbWl0ZXJJbmRleCsrOw0KICAgICAgICB9DQogICAgICB9IGVsc2UgaWYgKHRoaXMuaW5SQ0RBVEEpIHsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IDMyOw0KICAgICAgICB0aGlzLnN0YXRlSW5SQ0RBVEEoYyk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0aGlzLnN0YXRlID0gMTsNCiAgICAgICAgdGhpcy5zdGF0ZVRleHQoYyk7DQogICAgICB9DQogICAgfQ0KICAgIHN0YXRlSW50ZXJwb2xhdGlvbihjKSB7DQogICAgICBpZiAoYyA9PT0gdGhpcy5kZWxpbWl0ZXJDbG9zZVswXSkgew0KICAgICAgICB0aGlzLnN0YXRlID0gNDsNCiAgICAgICAgdGhpcy5kZWxpbWl0ZXJJbmRleCA9IDA7DQogICAgICAgIHRoaXMuc3RhdGVJbnRlcnBvbGF0aW9uQ2xvc2UoYyk7DQogICAgICB9DQogICAgfQ0KICAgIHN0YXRlSW50ZXJwb2xhdGlvbkNsb3NlKGMpIHsNCiAgICAgIGlmIChjID09PSB0aGlzLmRlbGltaXRlckNsb3NlW3RoaXMuZGVsaW1pdGVySW5kZXhdKSB7DQogICAgICAgIGlmICh0aGlzLmRlbGltaXRlckluZGV4ID09PSB0aGlzLmRlbGltaXRlckNsb3NlLmxlbmd0aCAtIDEpIHsNCiAgICAgICAgICB0aGlzLmNicy5vbmludGVycG9sYXRpb24odGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXggKyAxKTsNCiAgICAgICAgICBpZiAodGhpcy5pblJDREFUQSkgew0KICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IDMyOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICB0aGlzLnN0YXRlID0gMTsNCiAgICAgICAgICB9DQogICAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICB0aGlzLmRlbGltaXRlckluZGV4Kys7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHRoaXMuc3RhdGUgPSAzOw0KICAgICAgICB0aGlzLnN0YXRlSW50ZXJwb2xhdGlvbihjKTsNCiAgICAgIH0NCiAgICB9DQogICAgc3RhdGVTcGVjaWFsU3RhcnRTZXF1ZW5jZShjKSB7DQogICAgICBjb25zdCBpc0VuZCA9IHRoaXMuc2VxdWVuY2VJbmRleCA9PT0gdGhpcy5jdXJyZW50U2VxdWVuY2UubGVuZ3RoOw0KICAgICAgY29uc3QgaXNNYXRjaCA9IGlzRW5kID8gKA0KICAgICAgICAvLyBJZiB3ZSBhcmUgYXQgdGhlIGVuZCBvZiB0aGUgc2VxdWVuY2UsIG1ha2Ugc3VyZSB0aGUgdGFnIG5hbWUgaGFzIGVuZGVkDQogICAgICAgIGlzRW5kT2ZUYWdTZWN0aW9uKGMpDQogICAgICApIDogKA0KICAgICAgICAvLyBPdGhlcndpc2UsIGRvIGEgY2FzZS1pbnNlbnNpdGl2ZSBjb21wYXJpc29uDQogICAgICAgIChjIHwgMzIpID09PSB0aGlzLmN1cnJlbnRTZXF1ZW5jZVt0aGlzLnNlcXVlbmNlSW5kZXhdDQogICAgICApOw0KICAgICAgaWYgKCFpc01hdGNoKSB7DQogICAgICAgIHRoaXMuaW5SQ0RBVEEgPSBmYWxzZTsNCiAgICAgIH0gZWxzZSBpZiAoIWlzRW5kKSB7DQogICAgICAgIHRoaXMuc2VxdWVuY2VJbmRleCsrOw0KICAgICAgICByZXR1cm47DQogICAgICB9DQogICAgICB0aGlzLnNlcXVlbmNlSW5kZXggPSAwOw0KICAgICAgdGhpcy5zdGF0ZSA9IDY7DQogICAgICB0aGlzLnN0YXRlSW5UYWdOYW1lKGMpOw0KICAgIH0NCiAgICAvKiogTG9vayBmb3IgYW4gZW5kIHRhZy4gRm9yIDx0aXRsZT4gYW5kIDx0ZXh0YXJlYT4sIGFsc28gZGVjb2RlIGVudGl0aWVzLiAqLw0KICAgIHN0YXRlSW5SQ0RBVEEoYykgew0KICAgICAgaWYgKHRoaXMuc2VxdWVuY2VJbmRleCA9PT0gdGhpcy5jdXJyZW50U2VxdWVuY2UubGVuZ3RoKSB7DQogICAgICAgIGlmIChjID09PSA2MiB8fCBpc1doaXRlc3BhY2UoYykpIHsNCiAgICAgICAgICBjb25zdCBlbmRPZlRleHQgPSB0aGlzLmluZGV4IC0gdGhpcy5jdXJyZW50U2VxdWVuY2UubGVuZ3RoOw0KICAgICAgICAgIGlmICh0aGlzLnNlY3Rpb25TdGFydCA8IGVuZE9mVGV4dCkgew0KICAgICAgICAgICAgY29uc3QgYWN0dWFsSW5kZXggPSB0aGlzLmluZGV4Ow0KICAgICAgICAgICAgdGhpcy5pbmRleCA9IGVuZE9mVGV4dDsNCiAgICAgICAgICAgIHRoaXMuY2JzLm9udGV4dCh0aGlzLnNlY3Rpb25TdGFydCwgZW5kT2ZUZXh0KTsNCiAgICAgICAgICAgIHRoaXMuaW5kZXggPSBhY3R1YWxJbmRleDsNCiAgICAgICAgICB9DQogICAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSBlbmRPZlRleHQgKyAyOw0KICAgICAgICAgIHRoaXMuc3RhdGVJbkNsb3NpbmdUYWdOYW1lKGMpOw0KICAgICAgICAgIHRoaXMuaW5SQ0RBVEEgPSBmYWxzZTsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5zZXF1ZW5jZUluZGV4ID0gMDsNCiAgICAgIH0NCiAgICAgIGlmICgoYyB8IDMyKSA9PT0gdGhpcy5jdXJyZW50U2VxdWVuY2VbdGhpcy5zZXF1ZW5jZUluZGV4XSkgew0KICAgICAgICB0aGlzLnNlcXVlbmNlSW5kZXggKz0gMTsNCiAgICAgIH0gZWxzZSBpZiAodGhpcy5zZXF1ZW5jZUluZGV4ID09PSAwKSB7DQogICAgICAgIGlmICh0aGlzLmN1cnJlbnRTZXF1ZW5jZSA9PT0gU2VxdWVuY2VzLlRpdGxlRW5kIHx8IHRoaXMuY3VycmVudFNlcXVlbmNlID09PSBTZXF1ZW5jZXMuVGV4dGFyZWFFbmQgJiYgIXRoaXMuaW5TRkNSb290KSB7DQogICAgICAgICAgaWYgKCF0aGlzLmluVlByZSAmJiBjID09PSB0aGlzLmRlbGltaXRlck9wZW5bMF0pIHsNCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAyOw0KICAgICAgICAgICAgdGhpcy5kZWxpbWl0ZXJJbmRleCA9IDA7DQogICAgICAgICAgICB0aGlzLnN0YXRlSW50ZXJwb2xhdGlvbk9wZW4oYyk7DQogICAgICAgICAgfQ0KICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZmFzdEZvcndhcmRUbyg2MCkpIHsNCiAgICAgICAgICB0aGlzLnNlcXVlbmNlSW5kZXggPSAxOw0KICAgICAgICB9DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0aGlzLnNlcXVlbmNlSW5kZXggPSBOdW1iZXIoYyA9PT0gNjApOw0KICAgICAgfQ0KICAgIH0NCiAgICBzdGF0ZUNEQVRBU2VxdWVuY2UoYykgew0KICAgICAgaWYgKGMgPT09IFNlcXVlbmNlcy5DZGF0YVt0aGlzLnNlcXVlbmNlSW5kZXhdKSB7DQogICAgICAgIGlmICgrK3RoaXMuc2VxdWVuY2VJbmRleCA9PT0gU2VxdWVuY2VzLkNkYXRhLmxlbmd0aCkgew0KICAgICAgICAgIHRoaXMuc3RhdGUgPSAyODsNCiAgICAgICAgICB0aGlzLmN1cnJlbnRTZXF1ZW5jZSA9IFNlcXVlbmNlcy5DZGF0YUVuZDsNCiAgICAgICAgICB0aGlzLnNlcXVlbmNlSW5kZXggPSAwOw0KICAgICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gdGhpcy5pbmRleCArIDE7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHRoaXMuc2VxdWVuY2VJbmRleCA9IDA7DQogICAgICAgIHRoaXMuc3RhdGUgPSAyMzsNCiAgICAgICAgdGhpcy5zdGF0ZUluRGVjbGFyYXRpb24oYyk7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIFdoZW4gd2Ugd2FpdCBmb3Igb25lIHNwZWNpZmljIGNoYXJhY3Rlciwgd2UgY2FuIHNwZWVkIHRoaW5ncyB1cA0KICAgICAqIGJ5IHNraXBwaW5nIHRocm91Z2ggdGhlIGJ1ZmZlciB1bnRpbCB3ZSBmaW5kIGl0Lg0KICAgICAqDQogICAgICogQHJldHVybnMgV2hldGhlciB0aGUgY2hhcmFjdGVyIHdhcyBmb3VuZC4NCiAgICAgKi8NCiAgICBmYXN0Rm9yd2FyZFRvKGMpIHsNCiAgICAgIHdoaWxlICgrK3RoaXMuaW5kZXggPCB0aGlzLmJ1ZmZlci5sZW5ndGgpIHsNCiAgICAgICAgY29uc3QgY2MgPSB0aGlzLmJ1ZmZlci5jaGFyQ29kZUF0KHRoaXMuaW5kZXgpOw0KICAgICAgICBpZiAoY2MgPT09IDEwKSB7DQogICAgICAgICAgdGhpcy5uZXdsaW5lcy5wdXNoKHRoaXMuaW5kZXgpOw0KICAgICAgICB9DQogICAgICAgIGlmIChjYyA9PT0gYykgew0KICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9DQogICAgICB9DQogICAgICB0aGlzLmluZGV4ID0gdGhpcy5idWZmZXIubGVuZ3RoIC0gMTsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQogICAgLyoqDQogICAgICogQ29tbWVudHMgYW5kIENEQVRBIGVuZCB3aXRoIGAtLT5gIGFuZCBgXV0+YC4NCiAgICAgKg0KICAgICAqIFRoZWlyIGNvbW1vbiBxdWFsaXRpZXMgYXJlOg0KICAgICAqIC0gVGhlaXIgZW5kIHNlcXVlbmNlcyBoYXZlIGEgZGlzdGluY3QgY2hhcmFjdGVyIHRoZXkgc3RhcnQgd2l0aC4NCiAgICAgKiAtIFRoYXQgY2hhcmFjdGVyIGlzIHRoZW4gcmVwZWF0ZWQsIHNvIHdlIGhhdmUgdG8gY2hlY2sgbXVsdGlwbGUgcmVwZWF0cy4NCiAgICAgKiAtIEFsbCBjaGFyYWN0ZXJzIGJ1dCB0aGUgc3RhcnQgY2hhcmFjdGVyIG9mIHRoZSBzZXF1ZW5jZSBjYW4gYmUgc2tpcHBlZC4NCiAgICAgKi8NCiAgICBzdGF0ZUluQ29tbWVudExpa2UoYykgew0KICAgICAgaWYgKGMgPT09IHRoaXMuY3VycmVudFNlcXVlbmNlW3RoaXMuc2VxdWVuY2VJbmRleF0pIHsNCiAgICAgICAgaWYgKCsrdGhpcy5zZXF1ZW5jZUluZGV4ID09PSB0aGlzLmN1cnJlbnRTZXF1ZW5jZS5sZW5ndGgpIHsNCiAgICAgICAgICBpZiAodGhpcy5jdXJyZW50U2VxdWVuY2UgPT09IFNlcXVlbmNlcy5DZGF0YUVuZCkgew0KICAgICAgICAgICAgdGhpcy5jYnMub25jZGF0YSh0aGlzLnNlY3Rpb25TdGFydCwgdGhpcy5pbmRleCAtIDIpOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICB0aGlzLmNicy5vbmNvbW1lbnQodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXggLSAyKTsNCiAgICAgICAgICB9DQogICAgICAgICAgdGhpcy5zZXF1ZW5jZUluZGV4ID0gMDsNCiAgICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOw0KICAgICAgICAgIHRoaXMuc3RhdGUgPSAxOw0KICAgICAgICB9DQogICAgICB9IGVsc2UgaWYgKHRoaXMuc2VxdWVuY2VJbmRleCA9PT0gMCkgew0KICAgICAgICBpZiAodGhpcy5mYXN0Rm9yd2FyZFRvKHRoaXMuY3VycmVudFNlcXVlbmNlWzBdKSkgew0KICAgICAgICAgIHRoaXMuc2VxdWVuY2VJbmRleCA9IDE7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSBpZiAoYyAhPT0gdGhpcy5jdXJyZW50U2VxdWVuY2VbdGhpcy5zZXF1ZW5jZUluZGV4IC0gMV0pIHsNCiAgICAgICAgdGhpcy5zZXF1ZW5jZUluZGV4ID0gMDsNCiAgICAgIH0NCiAgICB9DQogICAgc3RhcnRTcGVjaWFsKHNlcXVlbmNlLCBvZmZzZXQpIHsNCiAgICAgIHRoaXMuZW50ZXJSQ0RBVEEoc2VxdWVuY2UsIG9mZnNldCk7DQogICAgICB0aGlzLnN0YXRlID0gMzE7DQogICAgfQ0KICAgIGVudGVyUkNEQVRBKHNlcXVlbmNlLCBvZmZzZXQpIHsNCiAgICAgIHRoaXMuaW5SQ0RBVEEgPSB0cnVlOw0KICAgICAgdGhpcy5jdXJyZW50U2VxdWVuY2UgPSBzZXF1ZW5jZTsNCiAgICAgIHRoaXMuc2VxdWVuY2VJbmRleCA9IG9mZnNldDsNCiAgICB9DQogICAgc3RhdGVCZWZvcmVUYWdOYW1lKGMpIHsNCiAgICAgIGlmIChjID09PSAzMykgew0KICAgICAgICB0aGlzLnN0YXRlID0gMjI7DQogICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gdGhpcy5pbmRleCArIDE7DQogICAgICB9IGVsc2UgaWYgKGMgPT09IDYzKSB7DQogICAgICAgIHRoaXMuc3RhdGUgPSAyNDsNCiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsNCiAgICAgIH0gZWxzZSBpZiAoaXNUYWdTdGFydENoYXIoYykpIHsNCiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4Ow0KICAgICAgICBpZiAodGhpcy5tb2RlID09PSAwKSB7DQogICAgICAgICAgdGhpcy5zdGF0ZSA9IDY7DQogICAgICAgIH0gZWxzZSBpZiAodGhpcy5pblNGQ1Jvb3QpIHsNCiAgICAgICAgICB0aGlzLnN0YXRlID0gMzQ7DQogICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuaW5YTUwpIHsNCiAgICAgICAgICBpZiAoYyA9PT0gMTE2KSB7DQogICAgICAgICAgICB0aGlzLnN0YXRlID0gMzA7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSBjID09PSAxMTUgPyAyOSA6IDY7DQogICAgICAgICAgfQ0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHRoaXMuc3RhdGUgPSA2Ow0KICAgICAgICB9DQogICAgICB9IGVsc2UgaWYgKGMgPT09IDQ3KSB7DQogICAgICAgIHRoaXMuc3RhdGUgPSA4Ow0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IDE7DQogICAgICAgIHRoaXMuc3RhdGVUZXh0KGMpOw0KICAgICAgfQ0KICAgIH0NCiAgICBzdGF0ZUluVGFnTmFtZShjKSB7DQogICAgICBpZiAoaXNFbmRPZlRhZ1NlY3Rpb24oYykpIHsNCiAgICAgICAgdGhpcy5oYW5kbGVUYWdOYW1lKGMpOw0KICAgICAgfQ0KICAgIH0NCiAgICBzdGF0ZUluU0ZDUm9vdFRhZ05hbWUoYykgew0KICAgICAgaWYgKGlzRW5kT2ZUYWdTZWN0aW9uKGMpKSB7DQogICAgICAgIGNvbnN0IHRhZyA9IHRoaXMuYnVmZmVyLnNsaWNlKHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsNCiAgICAgICAgaWYgKHRhZyAhPT0gInRlbXBsYXRlIikgew0KICAgICAgICAgIHRoaXMuZW50ZXJSQ0RBVEEodG9DaGFyQ29kZXMoYDwvYCArIHRhZyksIDApOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuaGFuZGxlVGFnTmFtZShjKTsNCiAgICAgIH0NCiAgICB9DQogICAgaGFuZGxlVGFnTmFtZShjKSB7DQogICAgICB0aGlzLmNicy5vbm9wZW50YWduYW1lKHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsNCiAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gLTE7DQogICAgICB0aGlzLnN0YXRlID0gMTE7DQogICAgICB0aGlzLnN0YXRlQmVmb3JlQXR0ck5hbWUoYyk7DQogICAgfQ0KICAgIHN0YXRlQmVmb3JlQ2xvc2luZ1RhZ05hbWUoYykgew0KICAgICAgaWYgKGlzV2hpdGVzcGFjZShjKSkgOyBlbHNlIGlmIChjID09PSA2Mikgew0KICAgICAgICB7DQogICAgICAgICAgdGhpcy5jYnMub25lcnIoMTQsIHRoaXMuaW5kZXgpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuc3RhdGUgPSAxOw0KICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IGlzVGFnU3RhcnRDaGFyKGMpID8gOSA6IDI3Ow0KICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXg7DQogICAgICB9DQogICAgfQ0KICAgIHN0YXRlSW5DbG9zaW5nVGFnTmFtZShjKSB7DQogICAgICBpZiAoYyA9PT0gNjIgfHwgaXNXaGl0ZXNwYWNlKGMpKSB7DQogICAgICAgIHRoaXMuY2JzLm9uY2xvc2V0YWcodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXgpOw0KICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IC0xOw0KICAgICAgICB0aGlzLnN0YXRlID0gMTA7DQogICAgICAgIHRoaXMuc3RhdGVBZnRlckNsb3NpbmdUYWdOYW1lKGMpOw0KICAgICAgfQ0KICAgIH0NCiAgICBzdGF0ZUFmdGVyQ2xvc2luZ1RhZ05hbWUoYykgew0KICAgICAgaWYgKGMgPT09IDYyKSB7DQogICAgICAgIHRoaXMuc3RhdGUgPSAxOw0KICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOw0KICAgICAgfQ0KICAgIH0NCiAgICBzdGF0ZUJlZm9yZUF0dHJOYW1lKGMpIHsNCiAgICAgIGlmIChjID09PSA2Mikgew0KICAgICAgICB0aGlzLmNicy5vbm9wZW50YWdlbmQodGhpcy5pbmRleCk7DQogICAgICAgIGlmICh0aGlzLmluUkNEQVRBKSB7DQogICAgICAgICAgdGhpcy5zdGF0ZSA9IDMyOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHRoaXMuc3RhdGUgPSAxOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gdGhpcy5pbmRleCArIDE7DQogICAgICB9IGVsc2UgaWYgKGMgPT09IDQ3KSB7DQogICAgICAgIHRoaXMuc3RhdGUgPSA3Ow0KICAgICAgICBpZiAodGhpcy5wZWVrKCkgIT09IDYyKSB7DQogICAgICAgICAgdGhpcy5jYnMub25lcnIoMjIsIHRoaXMuaW5kZXgpOw0KICAgICAgICB9DQogICAgICB9IGVsc2UgaWYgKGMgPT09IDYwICYmIHRoaXMucGVlaygpID09PSA0Nykgew0KICAgICAgICB0aGlzLmNicy5vbm9wZW50YWdlbmQodGhpcy5pbmRleCk7DQogICAgICAgIHRoaXMuc3RhdGUgPSA1Ow0KICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXg7DQogICAgICB9IGVsc2UgaWYgKCFpc1doaXRlc3BhY2UoYykpIHsNCiAgICAgICAgaWYgKGMgPT09IDYxKSB7DQogICAgICAgICAgdGhpcy5jYnMub25lcnIoDQogICAgICAgICAgICAxOSwNCiAgICAgICAgICAgIHRoaXMuaW5kZXgNCiAgICAgICAgICApOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuaGFuZGxlQXR0clN0YXJ0KGMpOw0KICAgICAgfQ0KICAgIH0NCiAgICBoYW5kbGVBdHRyU3RhcnQoYykgew0KICAgICAgaWYgKGMgPT09IDExOCAmJiB0aGlzLnBlZWsoKSA9PT0gNDUpIHsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IDEzOw0KICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXg7DQogICAgICB9IGVsc2UgaWYgKGMgPT09IDQ2IHx8IGMgPT09IDU4IHx8IGMgPT09IDY0IHx8IGMgPT09IDM1KSB7DQogICAgICAgIHRoaXMuY2JzLm9uZGlybmFtZSh0aGlzLmluZGV4LCB0aGlzLmluZGV4ICsgMSk7DQogICAgICAgIHRoaXMuc3RhdGUgPSAxNDsNCiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHRoaXMuc3RhdGUgPSAxMjsNCiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4Ow0KICAgICAgfQ0KICAgIH0NCiAgICBzdGF0ZUluU2VsZkNsb3NpbmdUYWcoYykgew0KICAgICAgaWYgKGMgPT09IDYyKSB7DQogICAgICAgIHRoaXMuY2JzLm9uc2VsZmNsb3Npbmd0YWcodGhpcy5pbmRleCk7DQogICAgICAgIHRoaXMuc3RhdGUgPSAxOw0KICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOw0KICAgICAgICB0aGlzLmluUkNEQVRBID0gZmFsc2U7DQogICAgICB9IGVsc2UgaWYgKCFpc1doaXRlc3BhY2UoYykpIHsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IDExOw0KICAgICAgICB0aGlzLnN0YXRlQmVmb3JlQXR0ck5hbWUoYyk7DQogICAgICB9DQogICAgfQ0KICAgIHN0YXRlSW5BdHRyTmFtZShjKSB7DQogICAgICBpZiAoYyA9PT0gNjEgfHwgaXNFbmRPZlRhZ1NlY3Rpb24oYykpIHsNCiAgICAgICAgdGhpcy5jYnMub25hdHRyaWJuYW1lKHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsNCiAgICAgICAgdGhpcy5oYW5kbGVBdHRyTmFtZUVuZChjKTsNCiAgICAgIH0gZWxzZSBpZiAoYyA9PT0gMzQgfHwgYyA9PT0gMzkgfHwgYyA9PT0gNjApIHsNCiAgICAgICAgdGhpcy5jYnMub25lcnIoDQogICAgICAgICAgMTcsDQogICAgICAgICAgdGhpcy5pbmRleA0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH0NCiAgICBzdGF0ZUluRGlyTmFtZShjKSB7DQogICAgICBpZiAoYyA9PT0gNjEgfHwgaXNFbmRPZlRhZ1NlY3Rpb24oYykpIHsNCiAgICAgICAgdGhpcy5jYnMub25kaXJuYW1lKHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsNCiAgICAgICAgdGhpcy5oYW5kbGVBdHRyTmFtZUVuZChjKTsNCiAgICAgIH0gZWxzZSBpZiAoYyA9PT0gNTgpIHsNCiAgICAgICAgdGhpcy5jYnMub25kaXJuYW1lKHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IDE0Ow0KICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOw0KICAgICAgfSBlbHNlIGlmIChjID09PSA0Nikgew0KICAgICAgICB0aGlzLmNicy5vbmRpcm5hbWUodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXgpOw0KICAgICAgICB0aGlzLnN0YXRlID0gMTY7DQogICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gdGhpcy5pbmRleCArIDE7DQogICAgICB9DQogICAgfQ0KICAgIHN0YXRlSW5EaXJBcmcoYykgew0KICAgICAgaWYgKGMgPT09IDYxIHx8IGlzRW5kT2ZUYWdTZWN0aW9uKGMpKSB7DQogICAgICAgIHRoaXMuY2JzLm9uZGlyYXJnKHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsNCiAgICAgICAgdGhpcy5oYW5kbGVBdHRyTmFtZUVuZChjKTsNCiAgICAgIH0gZWxzZSBpZiAoYyA9PT0gOTEpIHsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IDE1Ow0KICAgICAgfSBlbHNlIGlmIChjID09PSA0Nikgew0KICAgICAgICB0aGlzLmNicy5vbmRpcmFyZyh0aGlzLnNlY3Rpb25TdGFydCwgdGhpcy5pbmRleCk7DQogICAgICAgIHRoaXMuc3RhdGUgPSAxNjsNCiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsNCiAgICAgIH0NCiAgICB9DQogICAgc3RhdGVJbkR5bmFtaWNEaXJBcmcoYykgew0KICAgICAgaWYgKGMgPT09IDkzKSB7DQogICAgICAgIHRoaXMuc3RhdGUgPSAxNDsNCiAgICAgIH0gZWxzZSBpZiAoYyA9PT0gNjEgfHwgaXNFbmRPZlRhZ1NlY3Rpb24oYykpIHsNCiAgICAgICAgdGhpcy5jYnMub25kaXJhcmcodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXggKyAxKTsNCiAgICAgICAgdGhpcy5oYW5kbGVBdHRyTmFtZUVuZChjKTsNCiAgICAgICAgew0KICAgICAgICAgIHRoaXMuY2JzLm9uZXJyKA0KICAgICAgICAgICAgMjcsDQogICAgICAgICAgICB0aGlzLmluZGV4DQogICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICBzdGF0ZUluRGlyTW9kaWZpZXIoYykgew0KICAgICAgaWYgKGMgPT09IDYxIHx8IGlzRW5kT2ZUYWdTZWN0aW9uKGMpKSB7DQogICAgICAgIHRoaXMuY2JzLm9uZGlybW9kaWZpZXIodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXgpOw0KICAgICAgICB0aGlzLmhhbmRsZUF0dHJOYW1lRW5kKGMpOw0KICAgICAgfSBlbHNlIGlmIChjID09PSA0Nikgew0KICAgICAgICB0aGlzLmNicy5vbmRpcm1vZGlmaWVyKHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsNCiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsNCiAgICAgIH0NCiAgICB9DQogICAgaGFuZGxlQXR0ck5hbWVFbmQoYykgew0KICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4Ow0KICAgICAgdGhpcy5zdGF0ZSA9IDE3Ow0KICAgICAgdGhpcy5jYnMub25hdHRyaWJuYW1lZW5kKHRoaXMuaW5kZXgpOw0KICAgICAgdGhpcy5zdGF0ZUFmdGVyQXR0ck5hbWUoYyk7DQogICAgfQ0KICAgIHN0YXRlQWZ0ZXJBdHRyTmFtZShjKSB7DQogICAgICBpZiAoYyA9PT0gNjEpIHsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IDE4Ow0KICAgICAgfSBlbHNlIGlmIChjID09PSA0NyB8fCBjID09PSA2Mikgew0KICAgICAgICB0aGlzLmNicy5vbmF0dHJpYmVuZCgwLCB0aGlzLnNlY3Rpb25TdGFydCk7DQogICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gLTE7DQogICAgICAgIHRoaXMuc3RhdGUgPSAxMTsNCiAgICAgICAgdGhpcy5zdGF0ZUJlZm9yZUF0dHJOYW1lKGMpOw0KICAgICAgfSBlbHNlIGlmICghaXNXaGl0ZXNwYWNlKGMpKSB7DQogICAgICAgIHRoaXMuY2JzLm9uYXR0cmliZW5kKDAsIHRoaXMuc2VjdGlvblN0YXJ0KTsNCiAgICAgICAgdGhpcy5oYW5kbGVBdHRyU3RhcnQoYyk7DQogICAgICB9DQogICAgfQ0KICAgIHN0YXRlQmVmb3JlQXR0clZhbHVlKGMpIHsNCiAgICAgIGlmIChjID09PSAzNCkgew0KICAgICAgICB0aGlzLnN0YXRlID0gMTk7DQogICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gdGhpcy5pbmRleCArIDE7DQogICAgICB9IGVsc2UgaWYgKGMgPT09IDM5KSB7DQogICAgICAgIHRoaXMuc3RhdGUgPSAyMDsNCiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsNCiAgICAgIH0gZWxzZSBpZiAoIWlzV2hpdGVzcGFjZShjKSkgew0KICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXg7DQogICAgICAgIHRoaXMuc3RhdGUgPSAyMTsNCiAgICAgICAgdGhpcy5zdGF0ZUluQXR0clZhbHVlTm9RdW90ZXMoYyk7DQogICAgICB9DQogICAgfQ0KICAgIGhhbmRsZUluQXR0clZhbHVlKGMsIHF1b3RlKSB7DQogICAgICBpZiAoYyA9PT0gcXVvdGUgfHwgdGhpcy5mYXN0Rm9yd2FyZFRvKHF1b3RlKSkgew0KICAgICAgICB0aGlzLmNicy5vbmF0dHJpYmRhdGEodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXgpOw0KICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IC0xOw0KICAgICAgICB0aGlzLmNicy5vbmF0dHJpYmVuZCgNCiAgICAgICAgICBxdW90ZSA9PT0gMzQgPyAzIDogMiwNCiAgICAgICAgICB0aGlzLmluZGV4ICsgMQ0KICAgICAgICApOw0KICAgICAgICB0aGlzLnN0YXRlID0gMTE7DQogICAgICB9DQogICAgfQ0KICAgIHN0YXRlSW5BdHRyVmFsdWVEb3VibGVRdW90ZXMoYykgew0KICAgICAgdGhpcy5oYW5kbGVJbkF0dHJWYWx1ZShjLCAzNCk7DQogICAgfQ0KICAgIHN0YXRlSW5BdHRyVmFsdWVTaW5nbGVRdW90ZXMoYykgew0KICAgICAgdGhpcy5oYW5kbGVJbkF0dHJWYWx1ZShjLCAzOSk7DQogICAgfQ0KICAgIHN0YXRlSW5BdHRyVmFsdWVOb1F1b3RlcyhjKSB7DQogICAgICBpZiAoaXNXaGl0ZXNwYWNlKGMpIHx8IGMgPT09IDYyKSB7DQogICAgICAgIHRoaXMuY2JzLm9uYXR0cmliZGF0YSh0aGlzLnNlY3Rpb25TdGFydCwgdGhpcy5pbmRleCk7DQogICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gLTE7DQogICAgICAgIHRoaXMuY2JzLm9uYXR0cmliZW5kKDEsIHRoaXMuaW5kZXgpOw0KICAgICAgICB0aGlzLnN0YXRlID0gMTE7DQogICAgICAgIHRoaXMuc3RhdGVCZWZvcmVBdHRyTmFtZShjKTsNCiAgICAgIH0gZWxzZSBpZiAoYyA9PT0gMzQgfHwgYyA9PT0gMzkgfHwgYyA9PT0gNjAgfHwgYyA9PT0gNjEgfHwgYyA9PT0gOTYpIHsNCiAgICAgICAgdGhpcy5jYnMub25lcnIoDQogICAgICAgICAgMTgsDQogICAgICAgICAgdGhpcy5pbmRleA0KICAgICAgICApOw0KICAgICAgfSBlbHNlIDsNCiAgICB9DQogICAgc3RhdGVCZWZvcmVEZWNsYXJhdGlvbihjKSB7DQogICAgICBpZiAoYyA9PT0gOTEpIHsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IDI2Ow0KICAgICAgICB0aGlzLnNlcXVlbmNlSW5kZXggPSAwOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IGMgPT09IDQ1ID8gMjUgOiAyMzsNCiAgICAgIH0NCiAgICB9DQogICAgc3RhdGVJbkRlY2xhcmF0aW9uKGMpIHsNCiAgICAgIGlmIChjID09PSA2MiB8fCB0aGlzLmZhc3RGb3J3YXJkVG8oNjIpKSB7DQogICAgICAgIHRoaXMuc3RhdGUgPSAxOw0KICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOw0KICAgICAgfQ0KICAgIH0NCiAgICBzdGF0ZUluUHJvY2Vzc2luZ0luc3RydWN0aW9uKGMpIHsNCiAgICAgIGlmIChjID09PSA2MiB8fCB0aGlzLmZhc3RGb3J3YXJkVG8oNjIpKSB7DQogICAgICAgIHRoaXMuY2JzLm9ucHJvY2Vzc2luZ2luc3RydWN0aW9uKHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IDE7DQogICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gdGhpcy5pbmRleCArIDE7DQogICAgICB9DQogICAgfQ0KICAgIHN0YXRlQmVmb3JlQ29tbWVudChjKSB7DQogICAgICBpZiAoYyA9PT0gNDUpIHsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IDI4Ow0KICAgICAgICB0aGlzLmN1cnJlbnRTZXF1ZW5jZSA9IFNlcXVlbmNlcy5Db21tZW50RW5kOw0KICAgICAgICB0aGlzLnNlcXVlbmNlSW5kZXggPSAyOw0KICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IDIzOw0KICAgICAgfQ0KICAgIH0NCiAgICBzdGF0ZUluU3BlY2lhbENvbW1lbnQoYykgew0KICAgICAgaWYgKGMgPT09IDYyIHx8IHRoaXMuZmFzdEZvcndhcmRUbyg2MikpIHsNCiAgICAgICAgdGhpcy5jYnMub25jb21tZW50KHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IDE7DQogICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gdGhpcy5pbmRleCArIDE7DQogICAgICB9DQogICAgfQ0KICAgIHN0YXRlQmVmb3JlU3BlY2lhbFMoYykgew0KICAgICAgaWYgKGMgPT09IFNlcXVlbmNlcy5TY3JpcHRFbmRbM10pIHsNCiAgICAgICAgdGhpcy5zdGFydFNwZWNpYWwoU2VxdWVuY2VzLlNjcmlwdEVuZCwgNCk7DQogICAgICB9IGVsc2UgaWYgKGMgPT09IFNlcXVlbmNlcy5TdHlsZUVuZFszXSkgew0KICAgICAgICB0aGlzLnN0YXJ0U3BlY2lhbChTZXF1ZW5jZXMuU3R5bGVFbmQsIDQpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdGhpcy5zdGF0ZSA9IDY7DQogICAgICAgIHRoaXMuc3RhdGVJblRhZ05hbWUoYyk7DQogICAgICB9DQogICAgfQ0KICAgIHN0YXRlQmVmb3JlU3BlY2lhbFQoYykgew0KICAgICAgaWYgKGMgPT09IFNlcXVlbmNlcy5UaXRsZUVuZFszXSkgew0KICAgICAgICB0aGlzLnN0YXJ0U3BlY2lhbChTZXF1ZW5jZXMuVGl0bGVFbmQsIDQpOw0KICAgICAgfSBlbHNlIGlmIChjID09PSBTZXF1ZW5jZXMuVGV4dGFyZWFFbmRbM10pIHsNCiAgICAgICAgdGhpcy5zdGFydFNwZWNpYWwoU2VxdWVuY2VzLlRleHRhcmVhRW5kLCA0KTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHRoaXMuc3RhdGUgPSA2Ow0KICAgICAgICB0aGlzLnN0YXRlSW5UYWdOYW1lKGMpOw0KICAgICAgfQ0KICAgIH0NCiAgICBzdGFydEVudGl0eSgpIHsNCiAgICB9DQogICAgc3RhdGVJbkVudGl0eSgpIHsNCiAgICB9DQogICAgLyoqDQogICAgICogSXRlcmF0ZXMgdGhyb3VnaCB0aGUgYnVmZmVyLCBjYWxsaW5nIHRoZSBmdW5jdGlvbiBjb3JyZXNwb25kaW5nIHRvIHRoZSBjdXJyZW50IHN0YXRlLg0KICAgICAqDQogICAgICogU3RhdGVzIHRoYXQgYXJlIG1vcmUgbGlrZWx5IHRvIGJlIGhpdCBhcmUgaGlnaGVyIHVwLCBhcyBhIHBlcmZvcm1hbmNlIGltcHJvdmVtZW50Lg0KICAgICAqLw0KICAgIHBhcnNlKGlucHV0KSB7DQogICAgICB0aGlzLmJ1ZmZlciA9IGlucHV0Ow0KICAgICAgd2hpbGUgKHRoaXMuaW5kZXggPCB0aGlzLmJ1ZmZlci5sZW5ndGgpIHsNCiAgICAgICAgY29uc3QgYyA9IHRoaXMuYnVmZmVyLmNoYXJDb2RlQXQodGhpcy5pbmRleCk7DQogICAgICAgIGlmIChjID09PSAxMCAmJiB0aGlzLnN0YXRlICE9PSAzMykgew0KICAgICAgICAgIHRoaXMubmV3bGluZXMucHVzaCh0aGlzLmluZGV4KTsNCiAgICAgICAgfQ0KICAgICAgICBzd2l0Y2ggKHRoaXMuc3RhdGUpIHsNCiAgICAgICAgICBjYXNlIDE6IHsNCiAgICAgICAgICAgIHRoaXMuc3RhdGVUZXh0KGMpOw0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNhc2UgMjogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUludGVycG9sYXRpb25PcGVuKGMpOw0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNhc2UgMzogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUludGVycG9sYXRpb24oYyk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgY2FzZSA0OiB7DQogICAgICAgICAgICB0aGlzLnN0YXRlSW50ZXJwb2xhdGlvbkNsb3NlKGMpOw0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNhc2UgMzE6IHsNCiAgICAgICAgICAgIHRoaXMuc3RhdGVTcGVjaWFsU3RhcnRTZXF1ZW5jZShjKTsNCiAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjYXNlIDMyOiB7DQogICAgICAgICAgICB0aGlzLnN0YXRlSW5SQ0RBVEEoYyk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgY2FzZSAyNjogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUNEQVRBU2VxdWVuY2UoYyk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgY2FzZSAxOTogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUluQXR0clZhbHVlRG91YmxlUXVvdGVzKGMpOw0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNhc2UgMTI6IHsNCiAgICAgICAgICAgIHRoaXMuc3RhdGVJbkF0dHJOYW1lKGMpOw0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNhc2UgMTM6IHsNCiAgICAgICAgICAgIHRoaXMuc3RhdGVJbkRpck5hbWUoYyk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgY2FzZSAxNDogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUluRGlyQXJnKGMpOw0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNhc2UgMTU6IHsNCiAgICAgICAgICAgIHRoaXMuc3RhdGVJbkR5bmFtaWNEaXJBcmcoYyk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgY2FzZSAxNjogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUluRGlyTW9kaWZpZXIoYyk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgY2FzZSAyODogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUluQ29tbWVudExpa2UoYyk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgY2FzZSAyNzogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUluU3BlY2lhbENvbW1lbnQoYyk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgY2FzZSAxMTogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUJlZm9yZUF0dHJOYW1lKGMpOw0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNhc2UgNjogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUluVGFnTmFtZShjKTsNCiAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjYXNlIDM0OiB7DQogICAgICAgICAgICB0aGlzLnN0YXRlSW5TRkNSb290VGFnTmFtZShjKTsNCiAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjYXNlIDk6IHsNCiAgICAgICAgICAgIHRoaXMuc3RhdGVJbkNsb3NpbmdUYWdOYW1lKGMpOw0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNhc2UgNTogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUJlZm9yZVRhZ05hbWUoYyk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgY2FzZSAxNzogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUFmdGVyQXR0ck5hbWUoYyk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgY2FzZSAyMDogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUluQXR0clZhbHVlU2luZ2xlUXVvdGVzKGMpOw0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNhc2UgMTg6IHsNCiAgICAgICAgICAgIHRoaXMuc3RhdGVCZWZvcmVBdHRyVmFsdWUoYyk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgY2FzZSA4OiB7DQogICAgICAgICAgICB0aGlzLnN0YXRlQmVmb3JlQ2xvc2luZ1RhZ05hbWUoYyk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgY2FzZSAxMDogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUFmdGVyQ2xvc2luZ1RhZ05hbWUoYyk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgY2FzZSAyOTogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUJlZm9yZVNwZWNpYWxTKGMpOw0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNhc2UgMzA6IHsNCiAgICAgICAgICAgIHRoaXMuc3RhdGVCZWZvcmVTcGVjaWFsVChjKTsNCiAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjYXNlIDIxOiB7DQogICAgICAgICAgICB0aGlzLnN0YXRlSW5BdHRyVmFsdWVOb1F1b3RlcyhjKTsNCiAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjYXNlIDc6IHsNCiAgICAgICAgICAgIHRoaXMuc3RhdGVJblNlbGZDbG9zaW5nVGFnKGMpOw0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNhc2UgMjM6IHsNCiAgICAgICAgICAgIHRoaXMuc3RhdGVJbkRlY2xhcmF0aW9uKGMpOw0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNhc2UgMjI6IHsNCiAgICAgICAgICAgIHRoaXMuc3RhdGVCZWZvcmVEZWNsYXJhdGlvbihjKTsNCiAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjYXNlIDI1OiB7DQogICAgICAgICAgICB0aGlzLnN0YXRlQmVmb3JlQ29tbWVudChjKTsNCiAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjYXNlIDI0OiB7DQogICAgICAgICAgICB0aGlzLnN0YXRlSW5Qcm9jZXNzaW5nSW5zdHJ1Y3Rpb24oYyk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgICAgY2FzZSAzMzogew0KICAgICAgICAgICAgdGhpcy5zdGF0ZUluRW50aXR5KCk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5pbmRleCsrOw0KICAgICAgfQ0KICAgICAgdGhpcy5jbGVhbnVwKCk7DQogICAgICB0aGlzLmZpbmlzaCgpOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiBSZW1vdmUgZGF0YSB0aGF0IGhhcyBhbHJlYWR5IGJlZW4gY29uc3VtZWQgZnJvbSB0aGUgYnVmZmVyLg0KICAgICAqLw0KICAgIGNsZWFudXAoKSB7DQogICAgICBpZiAodGhpcy5zZWN0aW9uU3RhcnQgIT09IHRoaXMuaW5kZXgpIHsNCiAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09IDEgfHwgdGhpcy5zdGF0ZSA9PT0gMzIgJiYgdGhpcy5zZXF1ZW5jZUluZGV4ID09PSAwKSB7DQogICAgICAgICAgdGhpcy5jYnMub250ZXh0KHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsNCiAgICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXg7DQogICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZSA9PT0gMTkgfHwgdGhpcy5zdGF0ZSA9PT0gMjAgfHwgdGhpcy5zdGF0ZSA9PT0gMjEpIHsNCiAgICAgICAgICB0aGlzLmNicy5vbmF0dHJpYmRhdGEodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXgpOw0KICAgICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gdGhpcy5pbmRleDsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICBmaW5pc2goKSB7DQogICAgICB0aGlzLmhhbmRsZVRyYWlsaW5nRGF0YSgpOw0KICAgICAgdGhpcy5jYnMub25lbmQoKTsNCiAgICB9DQogICAgLyoqIEhhbmRsZSBhbnkgdHJhaWxpbmcgZGF0YS4gKi8NCiAgICBoYW5kbGVUcmFpbGluZ0RhdGEoKSB7DQogICAgICBjb25zdCBlbmRJbmRleCA9IHRoaXMuYnVmZmVyLmxlbmd0aDsNCiAgICAgIGlmICh0aGlzLnNlY3Rpb25TdGFydCA+PSBlbmRJbmRleCkgew0KICAgICAgICByZXR1cm47DQogICAgICB9DQogICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gMjgpIHsNCiAgICAgICAgaWYgKHRoaXMuY3VycmVudFNlcXVlbmNlID09PSBTZXF1ZW5jZXMuQ2RhdGFFbmQpIHsNCiAgICAgICAgICB0aGlzLmNicy5vbmNkYXRhKHRoaXMuc2VjdGlvblN0YXJ0LCBlbmRJbmRleCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgdGhpcy5jYnMub25jb21tZW50KHRoaXMuc2VjdGlvblN0YXJ0LCBlbmRJbmRleCk7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZSA9PT0gNiB8fCB0aGlzLnN0YXRlID09PSAxMSB8fCB0aGlzLnN0YXRlID09PSAxOCB8fCB0aGlzLnN0YXRlID09PSAxNyB8fCB0aGlzLnN0YXRlID09PSAxMiB8fCB0aGlzLnN0YXRlID09PSAxMyB8fCB0aGlzLnN0YXRlID09PSAxNCB8fCB0aGlzLnN0YXRlID09PSAxNSB8fCB0aGlzLnN0YXRlID09PSAxNiB8fCB0aGlzLnN0YXRlID09PSAyMCB8fCB0aGlzLnN0YXRlID09PSAxOSB8fCB0aGlzLnN0YXRlID09PSAyMSB8fCB0aGlzLnN0YXRlID09PSA5KSA7IGVsc2Ugew0KICAgICAgICB0aGlzLmNicy5vbnRleHQodGhpcy5zZWN0aW9uU3RhcnQsIGVuZEluZGV4KTsNCiAgICAgIH0NCiAgICB9DQogICAgZW1pdENvZGVQb2ludChjcCwgY29uc3VtZWQpIHsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBkZWZhdWx0T25FcnJvcihlcnJvcikgew0KICAgIHRocm93IGVycm9yOw0KICB9DQogIGZ1bmN0aW9uIGRlZmF1bHRPbldhcm4obXNnKSB7DQogICAgY29uc29sZS53YXJuKGBbVnVlIHdhcm5dICR7bXNnLm1lc3NhZ2V9YCk7DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlQ29tcGlsZXJFcnJvcihjb2RlLCBsb2MsIG1lc3NhZ2VzLCBhZGRpdGlvbmFsTWVzc2FnZSkgew0KICAgIGNvbnN0IG1zZyA9IChtZXNzYWdlcyB8fCBlcnJvck1lc3NhZ2VzKVtjb2RlXSArIChhZGRpdGlvbmFsTWVzc2FnZSB8fCBgYCkgOw0KICAgIGNvbnN0IGVycm9yID0gbmV3IFN5bnRheEVycm9yKFN0cmluZyhtc2cpKTsNCiAgICBlcnJvci5jb2RlID0gY29kZTsNCiAgICBlcnJvci5sb2MgPSBsb2M7DQogICAgcmV0dXJuIGVycm9yOw0KICB9DQogIGNvbnN0IGVycm9yTWVzc2FnZXMgPSB7DQogICAgLy8gcGFyc2UgZXJyb3JzDQogICAgWzBdOiAiSWxsZWdhbCBjb21tZW50LiIsDQogICAgWzFdOiAiQ0RBVEEgc2VjdGlvbiBpcyBhbGxvd2VkIG9ubHkgaW4gWE1MIGNvbnRleHQuIiwNCiAgICBbMl06ICJEdXBsaWNhdGUgYXR0cmlidXRlLiIsDQogICAgWzNdOiAiRW5kIHRhZyBjYW5ub3QgaGF2ZSBhdHRyaWJ1dGVzLiIsDQogICAgWzRdOiAiSWxsZWdhbCAnLycgaW4gdGFncy4iLA0KICAgIFs1XTogIlVuZXhwZWN0ZWQgRU9GIGluIHRhZy4iLA0KICAgIFs2XTogIlVuZXhwZWN0ZWQgRU9GIGluIENEQVRBIHNlY3Rpb24uIiwNCiAgICBbN106ICJVbmV4cGVjdGVkIEVPRiBpbiBjb21tZW50LiIsDQogICAgWzhdOiAiVW5leHBlY3RlZCBFT0YgaW4gc2NyaXB0LiIsDQogICAgWzldOiAiVW5leHBlY3RlZCBFT0YgaW4gdGFnLiIsDQogICAgWzEwXTogIkluY29ycmVjdGx5IGNsb3NlZCBjb21tZW50LiIsDQogICAgWzExXTogIkluY29ycmVjdGx5IG9wZW5lZCBjb21tZW50LiIsDQogICAgWzEyXTogIklsbGVnYWwgdGFnIG5hbWUuIFVzZSAnJmx0OycgdG8gcHJpbnQgJzwnLiIsDQogICAgWzEzXTogIkF0dHJpYnV0ZSB2YWx1ZSB3YXMgZXhwZWN0ZWQuIiwNCiAgICBbMTRdOiAiRW5kIHRhZyBuYW1lIHdhcyBleHBlY3RlZC4iLA0KICAgIFsxNV06ICJXaGl0ZXNwYWNlIHdhcyBleHBlY3RlZC4iLA0KICAgIFsxNl06ICJVbmV4cGVjdGVkICc8IS0tJyBpbiBjb21tZW50LiIsDQogICAgWzE3XTogYEF0dHJpYnV0ZSBuYW1lIGNhbm5vdCBjb250YWluIFUrMDAyMiAoIiksIFUrMDAyNyAoJyksIGFuZCBVKzAwM0MgKDwpLmAsDQogICAgWzE4XTogIlVucXVvdGVkIGF0dHJpYnV0ZSB2YWx1ZSBjYW5ub3QgY29udGFpbiBVKzAwMjIgKFwiKSwgVSswMDI3ICgnKSwgVSswMDNDICg8KSwgVSswMDNEICg9KSwgYW5kIFUrMDA2MCAoYCkuIiwNCiAgICBbMTldOiAiQXR0cmlidXRlIG5hbWUgY2Fubm90IHN0YXJ0IHdpdGggJz0nLiIsDQogICAgWzIxXTogIic8PycgaXMgYWxsb3dlZCBvbmx5IGluIFhNTCBjb250ZXh0LiIsDQogICAgWzIwXTogYFVuZXhwZWN0ZWQgbnVsbCBjaGFyYWN0ZXIuYCwNCiAgICBbMjJdOiAiSWxsZWdhbCAnLycgaW4gdGFncy4iLA0KICAgIC8vIFZ1ZS1zcGVjaWZpYyBwYXJzZSBlcnJvcnMNCiAgICBbMjNdOiAiSW52YWxpZCBlbmQgdGFnLiIsDQogICAgWzI0XTogIkVsZW1lbnQgaXMgbWlzc2luZyBlbmQgdGFnLiIsDQogICAgWzI1XTogIkludGVycG9sYXRpb24gZW5kIHNpZ24gd2FzIG5vdCBmb3VuZC4iLA0KICAgIFsyN106ICJFbmQgYnJhY2tldCBmb3IgZHluYW1pYyBkaXJlY3RpdmUgYXJndW1lbnQgd2FzIG5vdCBmb3VuZC4gTm90ZSB0aGF0IGR5bmFtaWMgZGlyZWN0aXZlIGFyZ3VtZW50IGNhbm5vdCBjb250YWluIHNwYWNlcy4iLA0KICAgIFsyNl06ICJMZWdhbCBkaXJlY3RpdmUgbmFtZSB3YXMgZXhwZWN0ZWQuIiwNCiAgICAvLyB0cmFuc2Zvcm0gZXJyb3JzDQogICAgWzI4XTogYHYtaWYvdi1lbHNlLWlmIGlzIG1pc3NpbmcgZXhwcmVzc2lvbi5gLA0KICAgIFsyOV06IGB2LWlmL2Vsc2UgYnJhbmNoZXMgbXVzdCB1c2UgdW5pcXVlIGtleXMuYCwNCiAgICBbMzBdOiBgdi1lbHNlL3YtZWxzZS1pZiBoYXMgbm8gYWRqYWNlbnQgdi1pZiBvciB2LWVsc2UtaWYuYCwNCiAgICBbMzFdOiBgdi1mb3IgaXMgbWlzc2luZyBleHByZXNzaW9uLmAsDQogICAgWzMyXTogYHYtZm9yIGhhcyBpbnZhbGlkIGV4cHJlc3Npb24uYCwNCiAgICBbMzNdOiBgPHRlbXBsYXRlIHYtZm9yPiBrZXkgc2hvdWxkIGJlIHBsYWNlZCBvbiB0aGUgPHRlbXBsYXRlPiB0YWcuYCwNCiAgICBbMzRdOiBgdi1iaW5kIGlzIG1pc3NpbmcgZXhwcmVzc2lvbi5gLA0KICAgIFs1Ml06IGB2LWJpbmQgd2l0aCBzYW1lLW5hbWUgc2hvcnRoYW5kIG9ubHkgYWxsb3dzIHN0YXRpYyBhcmd1bWVudC5gLA0KICAgIFszNV06IGB2LW9uIGlzIG1pc3NpbmcgZXhwcmVzc2lvbi5gLA0KICAgIFszNl06IGBVbmV4cGVjdGVkIGN1c3RvbSBkaXJlY3RpdmUgb24gPHNsb3Q+IG91dGxldC5gLA0KICAgIFszN106IGBNaXhlZCB2LXNsb3QgdXNhZ2Ugb24gYm90aCB0aGUgY29tcG9uZW50IGFuZCBuZXN0ZWQgPHRlbXBsYXRlPi4gV2hlbiB0aGVyZSBhcmUgbXVsdGlwbGUgbmFtZWQgc2xvdHMsIGFsbCBzbG90cyBzaG91bGQgdXNlIDx0ZW1wbGF0ZT4gc3ludGF4IHRvIGF2b2lkIHNjb3BlIGFtYmlndWl0eS5gLA0KICAgIFszOF06IGBEdXBsaWNhdGUgc2xvdCBuYW1lcyBmb3VuZC4gYCwNCiAgICBbMzldOiBgRXh0cmFuZW91cyBjaGlsZHJlbiBmb3VuZCB3aGVuIGNvbXBvbmVudCBhbHJlYWR5IGhhcyBleHBsaWNpdGx5IG5hbWVkIGRlZmF1bHQgc2xvdC4gVGhlc2UgY2hpbGRyZW4gd2lsbCBiZSBpZ25vcmVkLmAsDQogICAgWzQwXTogYHYtc2xvdCBjYW4gb25seSBiZSB1c2VkIG9uIGNvbXBvbmVudHMgb3IgPHRlbXBsYXRlPiB0YWdzLmAsDQogICAgWzQxXTogYHYtbW9kZWwgaXMgbWlzc2luZyBleHByZXNzaW9uLmAsDQogICAgWzQyXTogYHYtbW9kZWwgdmFsdWUgbXVzdCBiZSBhIHZhbGlkIEphdmFTY3JpcHQgbWVtYmVyIGV4cHJlc3Npb24uYCwNCiAgICBbNDNdOiBgdi1tb2RlbCBjYW5ub3QgYmUgdXNlZCBvbiB2LWZvciBvciB2LXNsb3Qgc2NvcGUgdmFyaWFibGVzIGJlY2F1c2UgdGhleSBhcmUgbm90IHdyaXRhYmxlLmAsDQogICAgWzQ0XTogYHYtbW9kZWwgY2Fubm90IGJlIHVzZWQgb24gYSBwcm9wLCBiZWNhdXNlIGxvY2FsIHByb3AgYmluZGluZ3MgYXJlIG5vdCB3cml0YWJsZS4NClVzZSBhIHYtYmluZCBiaW5kaW5nIGNvbWJpbmVkIHdpdGggYSB2LW9uIGxpc3RlbmVyIHRoYXQgZW1pdHMgdXBkYXRlOnggZXZlbnQgaW5zdGVhZC5gLA0KICAgIFs0NV06IGBFcnJvciBwYXJzaW5nIEphdmFTY3JpcHQgZXhwcmVzc2lvbjogYCwNCiAgICBbNDZdOiBgPEtlZXBBbGl2ZT4gZXhwZWN0cyBleGFjdGx5IG9uZSBjaGlsZCBjb21wb25lbnQuYCwNCiAgICBbNTFdOiBgQHZub2RlLSogaG9va3MgaW4gdGVtcGxhdGVzIGFyZSBubyBsb25nZXIgc3VwcG9ydGVkLiBVc2UgdGhlIHZ1ZTogcHJlZml4IGluc3RlYWQuIEZvciBleGFtcGxlLCBAdm5vZGUtbW91bnRlZCBzaG91bGQgYmUgY2hhbmdlZCB0byBAdnVlOm1vdW50ZWQuIEB2bm9kZS0qIGhvb2tzIHN1cHBvcnQgaGFzIGJlZW4gcmVtb3ZlZCBpbiAzLjQuYCwNCiAgICAvLyBnZW5lcmljIGVycm9ycw0KICAgIFs0N106IGAicHJlZml4SWRlbnRpZmllcnMiIG9wdGlvbiBpcyBub3Qgc3VwcG9ydGVkIGluIHRoaXMgYnVpbGQgb2YgY29tcGlsZXIuYCwNCiAgICBbNDhdOiBgRVMgbW9kdWxlIG1vZGUgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGlzIGJ1aWxkIG9mIGNvbXBpbGVyLmAsDQogICAgWzQ5XTogYCJjYWNoZUhhbmRsZXJzIiBvcHRpb24gaXMgb25seSBzdXBwb3J0ZWQgd2hlbiB0aGUgInByZWZpeElkZW50aWZpZXJzIiBvcHRpb24gaXMgZW5hYmxlZC5gLA0KICAgIFs1MF06IGAic2NvcGVJZCIgb3B0aW9uIGlzIG9ubHkgc3VwcG9ydGVkIGluIG1vZHVsZSBtb2RlLmAsDQogICAgLy8ganVzdCB0byBmdWxmaWxsIHR5cGVzDQogICAgWzUzXTogYGANCiAgfTsNCg0KICBjb25zdCBpc1N0YXRpY0V4cCA9IChwKSA9PiBwLnR5cGUgPT09IDQgJiYgcC5pc1N0YXRpYzsNCiAgZnVuY3Rpb24gaXNDb3JlQ29tcG9uZW50KHRhZykgew0KICAgIHN3aXRjaCAodGFnKSB7DQogICAgICBjYXNlICJUZWxlcG9ydCI6DQogICAgICBjYXNlICJ0ZWxlcG9ydCI6DQogICAgICAgIHJldHVybiBURUxFUE9SVDsNCiAgICAgIGNhc2UgIlN1c3BlbnNlIjoNCiAgICAgIGNhc2UgInN1c3BlbnNlIjoNCiAgICAgICAgcmV0dXJuIFNVU1BFTlNFOw0KICAgICAgY2FzZSAiS2VlcEFsaXZlIjoNCiAgICAgIGNhc2UgImtlZXAtYWxpdmUiOg0KICAgICAgICByZXR1cm4gS0VFUF9BTElWRTsNCiAgICAgIGNhc2UgIkJhc2VUcmFuc2l0aW9uIjoNCiAgICAgIGNhc2UgImJhc2UtdHJhbnNpdGlvbiI6DQogICAgICAgIHJldHVybiBCQVNFX1RSQU5TSVRJT047DQogICAgfQ0KICB9DQogIGNvbnN0IG5vbklkZW50aWZpZXJSRSA9IC9eXGR8W15cJFx3XHhBMC1cdUZGRkZdLzsNCiAgY29uc3QgaXNTaW1wbGVJZGVudGlmaWVyID0gKG5hbWUpID0+ICFub25JZGVudGlmaWVyUkUudGVzdChuYW1lKTsNCiAgY29uc3QgdmFsaWRGaXJzdElkZW50Q2hhclJFID0gL1tBLVphLXpfJFx4QTAtXHVGRkZGXS87DQogIGNvbnN0IHZhbGlkSWRlbnRDaGFyUkUgPSAvW1wuXD9cdyRceEEwLVx1RkZGRl0vOw0KICBjb25zdCB3aGl0ZXNwYWNlUkUgPSAvXHMrWy5bXVxzKnxccypbLltdXHMrL2c7DQogIGNvbnN0IGdldEV4cFNvdXJjZSA9IChleHApID0+IGV4cC50eXBlID09PSA0ID8gZXhwLmNvbnRlbnQgOiBleHAubG9jLnNvdXJjZTsNCiAgY29uc3QgaXNNZW1iZXJFeHByZXNzaW9uQnJvd3NlciA9IChleHApID0+IHsNCiAgICBjb25zdCBwYXRoID0gZ2V0RXhwU291cmNlKGV4cCkudHJpbSgpLnJlcGxhY2Uod2hpdGVzcGFjZVJFLCAocykgPT4gcy50cmltKCkpOw0KICAgIGxldCBzdGF0ZSA9IDAgLyogaW5NZW1iZXJFeHAgKi87DQogICAgbGV0IHN0YXRlU3RhY2sgPSBbXTsNCiAgICBsZXQgY3VycmVudE9wZW5CcmFja2V0Q291bnQgPSAwOw0KICAgIGxldCBjdXJyZW50T3BlblBhcmVuc0NvdW50ID0gMDsNCiAgICBsZXQgY3VycmVudFN0cmluZ1R5cGUgPSBudWxsOw0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGF0aC5sZW5ndGg7IGkrKykgew0KICAgICAgY29uc3QgY2hhciA9IHBhdGguY2hhckF0KGkpOw0KICAgICAgc3dpdGNoIChzdGF0ZSkgew0KICAgICAgICBjYXNlIDAgLyogaW5NZW1iZXJFeHAgKi86DQogICAgICAgICAgaWYgKGNoYXIgPT09ICJbIikgew0KICAgICAgICAgICAgc3RhdGVTdGFjay5wdXNoKHN0YXRlKTsNCiAgICAgICAgICAgIHN0YXRlID0gMSAvKiBpbkJyYWNrZXRzICovOw0KICAgICAgICAgICAgY3VycmVudE9wZW5CcmFja2V0Q291bnQrKzsNCiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICIoIikgew0KICAgICAgICAgICAgc3RhdGVTdGFjay5wdXNoKHN0YXRlKTsNCiAgICAgICAgICAgIHN0YXRlID0gMiAvKiBpblBhcmVucyAqLzsNCiAgICAgICAgICAgIGN1cnJlbnRPcGVuUGFyZW5zQ291bnQrKzsNCiAgICAgICAgICB9IGVsc2UgaWYgKCEoaSA9PT0gMCA/IHZhbGlkRmlyc3RJZGVudENoYXJSRSA6IHZhbGlkSWRlbnRDaGFyUkUpLnRlc3QoY2hhcikpIHsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICB9DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIGNhc2UgMSAvKiBpbkJyYWNrZXRzICovOg0KICAgICAgICAgIGlmIChjaGFyID09PSBgJ2AgfHwgY2hhciA9PT0gYCJgIHx8IGNoYXIgPT09ICJgIikgew0KICAgICAgICAgICAgc3RhdGVTdGFjay5wdXNoKHN0YXRlKTsNCiAgICAgICAgICAgIHN0YXRlID0gMyAvKiBpblN0cmluZyAqLzsNCiAgICAgICAgICAgIGN1cnJlbnRTdHJpbmdUeXBlID0gY2hhcjsNCiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09IGBbYCkgew0KICAgICAgICAgICAgY3VycmVudE9wZW5CcmFja2V0Q291bnQrKzsNCiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09IGBdYCkgew0KICAgICAgICAgICAgaWYgKCEtLWN1cnJlbnRPcGVuQnJhY2tldENvdW50KSB7DQogICAgICAgICAgICAgIHN0YXRlID0gc3RhdGVTdGFjay5wb3AoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIGNhc2UgMiAvKiBpblBhcmVucyAqLzoNCiAgICAgICAgICBpZiAoY2hhciA9PT0gYCdgIHx8IGNoYXIgPT09IGAiYCB8fCBjaGFyID09PSAiYCIpIHsNCiAgICAgICAgICAgIHN0YXRlU3RhY2sucHVzaChzdGF0ZSk7DQogICAgICAgICAgICBzdGF0ZSA9IDMgLyogaW5TdHJpbmcgKi87DQogICAgICAgICAgICBjdXJyZW50U3RyaW5nVHlwZSA9IGNoYXI7DQogICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSBgKGApIHsNCiAgICAgICAgICAgIGN1cnJlbnRPcGVuUGFyZW5zQ291bnQrKzsNCiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09IGApYCkgew0KICAgICAgICAgICAgaWYgKGkgPT09IHBhdGgubGVuZ3RoIC0gMSkgew0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoIS0tY3VycmVudE9wZW5QYXJlbnNDb3VudCkgew0KICAgICAgICAgICAgICBzdGF0ZSA9IHN0YXRlU3RhY2sucG9wKCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICAgIGJyZWFrOw0KICAgICAgICBjYXNlIDMgLyogaW5TdHJpbmcgKi86DQogICAgICAgICAgaWYgKGNoYXIgPT09IGN1cnJlbnRTdHJpbmdUeXBlKSB7DQogICAgICAgICAgICBzdGF0ZSA9IHN0YXRlU3RhY2sucG9wKCk7DQogICAgICAgICAgICBjdXJyZW50U3RyaW5nVHlwZSA9IG51bGw7DQogICAgICAgICAgfQ0KICAgICAgICAgIGJyZWFrOw0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gIWN1cnJlbnRPcGVuQnJhY2tldENvdW50ICYmICFjdXJyZW50T3BlblBhcmVuc0NvdW50Ow0KICB9Ow0KICBjb25zdCBpc01lbWJlckV4cHJlc3Npb24gPSBpc01lbWJlckV4cHJlc3Npb25Ccm93c2VyIDsNCiAgY29uc3QgZm5FeHBSRSA9IC9eXHMqKGFzeW5jXHMqKT8oXChbXildKj9cKXxbXHckX10rKVxzKig6W149XSspPz0+fF5ccyooYXN5bmNccyspP2Z1bmN0aW9uKD86XHMrW1x3JF0rKT9ccypcKC87DQogIGNvbnN0IGlzRm5FeHByZXNzaW9uQnJvd3NlciA9IChleHApID0+IGZuRXhwUkUudGVzdChnZXRFeHBTb3VyY2UoZXhwKSk7DQogIGNvbnN0IGlzRm5FeHByZXNzaW9uID0gaXNGbkV4cHJlc3Npb25Ccm93c2VyIDsNCiAgZnVuY3Rpb24gYXNzZXJ0KGNvbmRpdGlvbiwgbXNnKSB7DQogICAgaWYgKCFjb25kaXRpb24pIHsNCiAgICAgIHRocm93IG5ldyBFcnJvcihtc2cgfHwgYHVuZXhwZWN0ZWQgY29tcGlsZXIgY29uZGl0aW9uYCk7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGZpbmREaXIobm9kZSwgbmFtZSwgYWxsb3dFbXB0eSA9IGZhbHNlKSB7DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLnByb3BzLmxlbmd0aDsgaSsrKSB7DQogICAgICBjb25zdCBwID0gbm9kZS5wcm9wc1tpXTsNCiAgICAgIGlmIChwLnR5cGUgPT09IDcgJiYgKGFsbG93RW1wdHkgfHwgcC5leHApICYmIChpc1N0cmluZyhuYW1lKSA/IHAubmFtZSA9PT0gbmFtZSA6IG5hbWUudGVzdChwLm5hbWUpKSkgew0KICAgICAgICByZXR1cm4gcDsNCiAgICAgIH0NCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gZmluZFByb3Aobm9kZSwgbmFtZSwgZHluYW1pY09ubHkgPSBmYWxzZSwgYWxsb3dFbXB0eSA9IGZhbHNlKSB7DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLnByb3BzLmxlbmd0aDsgaSsrKSB7DQogICAgICBjb25zdCBwID0gbm9kZS5wcm9wc1tpXTsNCiAgICAgIGlmIChwLnR5cGUgPT09IDYpIHsNCiAgICAgICAgaWYgKGR5bmFtaWNPbmx5KSBjb250aW51ZTsNCiAgICAgICAgaWYgKHAubmFtZSA9PT0gbmFtZSAmJiAocC52YWx1ZSB8fCBhbGxvd0VtcHR5KSkgew0KICAgICAgICAgIHJldHVybiBwOw0KICAgICAgICB9DQogICAgICB9IGVsc2UgaWYgKHAubmFtZSA9PT0gImJpbmQiICYmIChwLmV4cCB8fCBhbGxvd0VtcHR5KSAmJiBpc1N0YXRpY0FyZ09mKHAuYXJnLCBuYW1lKSkgew0KICAgICAgICByZXR1cm4gcDsNCiAgICAgIH0NCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gaXNTdGF0aWNBcmdPZihhcmcsIG5hbWUpIHsNCiAgICByZXR1cm4gISEoYXJnICYmIGlzU3RhdGljRXhwKGFyZykgJiYgYXJnLmNvbnRlbnQgPT09IG5hbWUpOw0KICB9DQogIGZ1bmN0aW9uIGhhc0R5bmFtaWNLZXlWQmluZChub2RlKSB7DQogICAgcmV0dXJuIG5vZGUucHJvcHMuc29tZSgNCiAgICAgIChwKSA9PiBwLnR5cGUgPT09IDcgJiYgcC5uYW1lID09PSAiYmluZCIgJiYgKCFwLmFyZyB8fCAvLyB2LWJpbmQ9Im9iaiINCiAgICAgIHAuYXJnLnR5cGUgIT09IDQgfHwgLy8gdi1iaW5kOltfY3R4LmZvb10NCiAgICAgICFwLmFyZy5pc1N0YXRpYykNCiAgICAgIC8vIHYtYmluZDpbZm9vXQ0KICAgICk7DQogIH0NCiAgZnVuY3Rpb24gaXNUZXh0JDEobm9kZSkgew0KICAgIHJldHVybiBub2RlLnR5cGUgPT09IDUgfHwgbm9kZS50eXBlID09PSAyOw0KICB9DQogIGZ1bmN0aW9uIGlzVlNsb3QocCkgew0KICAgIHJldHVybiBwLnR5cGUgPT09IDcgJiYgcC5uYW1lID09PSAic2xvdCI7DQogIH0NCiAgZnVuY3Rpb24gaXNUZW1wbGF0ZU5vZGUobm9kZSkgew0KICAgIHJldHVybiBub2RlLnR5cGUgPT09IDEgJiYgbm9kZS50YWdUeXBlID09PSAzOw0KICB9DQogIGZ1bmN0aW9uIGlzU2xvdE91dGxldChub2RlKSB7DQogICAgcmV0dXJuIG5vZGUudHlwZSA9PT0gMSAmJiBub2RlLnRhZ1R5cGUgPT09IDI7DQogIH0NCiAgY29uc3QgcHJvcHNIZWxwZXJTZXQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbTk9STUFMSVpFX1BST1BTLCBHVUFSRF9SRUFDVElWRV9QUk9QU10pOw0KICBmdW5jdGlvbiBnZXRVbm5vcm1hbGl6ZWRQcm9wcyhwcm9wcywgY2FsbFBhdGggPSBbXSkgew0KICAgIGlmIChwcm9wcyAmJiAhaXNTdHJpbmcocHJvcHMpICYmIHByb3BzLnR5cGUgPT09IDE0KSB7DQogICAgICBjb25zdCBjYWxsZWUgPSBwcm9wcy5jYWxsZWU7DQogICAgICBpZiAoIWlzU3RyaW5nKGNhbGxlZSkgJiYgcHJvcHNIZWxwZXJTZXQuaGFzKGNhbGxlZSkpIHsNCiAgICAgICAgcmV0dXJuIGdldFVubm9ybWFsaXplZFByb3BzKA0KICAgICAgICAgIHByb3BzLmFyZ3VtZW50c1swXSwNCiAgICAgICAgICBjYWxsUGF0aC5jb25jYXQocHJvcHMpDQogICAgICAgICk7DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiBbcHJvcHMsIGNhbGxQYXRoXTsNCiAgfQ0KICBmdW5jdGlvbiBpbmplY3RQcm9wKG5vZGUsIHByb3AsIGNvbnRleHQpIHsNCiAgICBsZXQgcHJvcHNXaXRoSW5qZWN0aW9uOw0KICAgIGxldCBwcm9wcyA9IG5vZGUudHlwZSA9PT0gMTMgPyBub2RlLnByb3BzIDogbm9kZS5hcmd1bWVudHNbMl07DQogICAgbGV0IGNhbGxQYXRoID0gW107DQogICAgbGV0IHBhcmVudENhbGw7DQogICAgaWYgKHByb3BzICYmICFpc1N0cmluZyhwcm9wcykgJiYgcHJvcHMudHlwZSA9PT0gMTQpIHsNCiAgICAgIGNvbnN0IHJldCA9IGdldFVubm9ybWFsaXplZFByb3BzKHByb3BzKTsNCiAgICAgIHByb3BzID0gcmV0WzBdOw0KICAgICAgY2FsbFBhdGggPSByZXRbMV07DQogICAgICBwYXJlbnRDYWxsID0gY2FsbFBhdGhbY2FsbFBhdGgubGVuZ3RoIC0gMV07DQogICAgfQ0KICAgIGlmIChwcm9wcyA9PSBudWxsIHx8IGlzU3RyaW5nKHByb3BzKSkgew0KICAgICAgcHJvcHNXaXRoSW5qZWN0aW9uID0gY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihbcHJvcF0pOw0KICAgIH0gZWxzZSBpZiAocHJvcHMudHlwZSA9PT0gMTQpIHsNCiAgICAgIGNvbnN0IGZpcnN0ID0gcHJvcHMuYXJndW1lbnRzWzBdOw0KICAgICAgaWYgKCFpc1N0cmluZyhmaXJzdCkgJiYgZmlyc3QudHlwZSA9PT0gMTUpIHsNCiAgICAgICAgaWYgKCFoYXNQcm9wKHByb3AsIGZpcnN0KSkgew0KICAgICAgICAgIGZpcnN0LnByb3BlcnRpZXMudW5zaGlmdChwcm9wKTsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgaWYgKHByb3BzLmNhbGxlZSA9PT0gVE9fSEFORExFUlMpIHsNCiAgICAgICAgICBwcm9wc1dpdGhJbmplY3Rpb24gPSBjcmVhdGVDYWxsRXhwcmVzc2lvbihjb250ZXh0LmhlbHBlcihNRVJHRV9QUk9QUyksIFsNCiAgICAgICAgICAgIGNyZWF0ZU9iamVjdEV4cHJlc3Npb24oW3Byb3BdKSwNCiAgICAgICAgICAgIHByb3BzDQogICAgICAgICAgXSk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcHJvcHMuYXJndW1lbnRzLnVuc2hpZnQoY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihbcHJvcF0pKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgIXByb3BzV2l0aEluamVjdGlvbiAmJiAocHJvcHNXaXRoSW5qZWN0aW9uID0gcHJvcHMpOw0KICAgIH0gZWxzZSBpZiAocHJvcHMudHlwZSA9PT0gMTUpIHsNCiAgICAgIGlmICghaGFzUHJvcChwcm9wLCBwcm9wcykpIHsNCiAgICAgICAgcHJvcHMucHJvcGVydGllcy51bnNoaWZ0KHByb3ApOw0KICAgICAgfQ0KICAgICAgcHJvcHNXaXRoSW5qZWN0aW9uID0gcHJvcHM7DQogICAgfSBlbHNlIHsNCiAgICAgIHByb3BzV2l0aEluamVjdGlvbiA9IGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKE1FUkdFX1BST1BTKSwgWw0KICAgICAgICBjcmVhdGVPYmplY3RFeHByZXNzaW9uKFtwcm9wXSksDQogICAgICAgIHByb3BzDQogICAgICBdKTsNCiAgICAgIGlmIChwYXJlbnRDYWxsICYmIHBhcmVudENhbGwuY2FsbGVlID09PSBHVUFSRF9SRUFDVElWRV9QUk9QUykgew0KICAgICAgICBwYXJlbnRDYWxsID0gY2FsbFBhdGhbY2FsbFBhdGgubGVuZ3RoIC0gMl07DQogICAgICB9DQogICAgfQ0KICAgIGlmIChub2RlLnR5cGUgPT09IDEzKSB7DQogICAgICBpZiAocGFyZW50Q2FsbCkgew0KICAgICAgICBwYXJlbnRDYWxsLmFyZ3VtZW50c1swXSA9IHByb3BzV2l0aEluamVjdGlvbjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIG5vZGUucHJvcHMgPSBwcm9wc1dpdGhJbmplY3Rpb247DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIGlmIChwYXJlbnRDYWxsKSB7DQogICAgICAgIHBhcmVudENhbGwuYXJndW1lbnRzWzBdID0gcHJvcHNXaXRoSW5qZWN0aW9uOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgbm9kZS5hcmd1bWVudHNbMl0gPSBwcm9wc1dpdGhJbmplY3Rpb247DQogICAgICB9DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGhhc1Byb3AocHJvcCwgcHJvcHMpIHsNCiAgICBsZXQgcmVzdWx0ID0gZmFsc2U7DQogICAgaWYgKHByb3Aua2V5LnR5cGUgPT09IDQpIHsNCiAgICAgIGNvbnN0IHByb3BLZXlOYW1lID0gcHJvcC5rZXkuY29udGVudDsNCiAgICAgIHJlc3VsdCA9IHByb3BzLnByb3BlcnRpZXMuc29tZSgNCiAgICAgICAgKHApID0+IHAua2V5LnR5cGUgPT09IDQgJiYgcC5rZXkuY29udGVudCA9PT0gcHJvcEtleU5hbWUNCiAgICAgICk7DQogICAgfQ0KICAgIHJldHVybiByZXN1bHQ7DQogIH0NCiAgZnVuY3Rpb24gdG9WYWxpZEFzc2V0SWQobmFtZSwgdHlwZSkgew0KICAgIHJldHVybiBgXyR7dHlwZX1fJHtuYW1lLnJlcGxhY2UoL1teXHddL2csIChzZWFyY2hWYWx1ZSwgcmVwbGFjZVZhbHVlKSA9PiB7DQogICAgcmV0dXJuIHNlYXJjaFZhbHVlID09PSAiLSIgPyAiXyIgOiBuYW1lLmNoYXJDb2RlQXQocmVwbGFjZVZhbHVlKS50b1N0cmluZygpOw0KICB9KX1gOw0KICB9DQogIGZ1bmN0aW9uIGdldE1lbW9lZFZOb2RlQ2FsbChub2RlKSB7DQogICAgaWYgKG5vZGUudHlwZSA9PT0gMTQgJiYgbm9kZS5jYWxsZWUgPT09IFdJVEhfTUVNTykgew0KICAgICAgcmV0dXJuIG5vZGUuYXJndW1lbnRzWzFdLnJldHVybnM7DQogICAgfSBlbHNlIHsNCiAgICAgIHJldHVybiBub2RlOw0KICAgIH0NCiAgfQ0KICBjb25zdCBmb3JBbGlhc1JFID0gLyhbXHNcU10qPylccysoPzppbnxvZilccysoXFNbXHNcU10qKS87DQoNCiAgY29uc3QgZGVmYXVsdFBhcnNlck9wdGlvbnMgPSB7DQogICAgcGFyc2VNb2RlOiAiYmFzZSIsDQogICAgbnM6IDAsDQogICAgZGVsaW1pdGVyczogW2B7e2AsIGB9fWBdLA0KICAgIGdldE5hbWVzcGFjZTogKCkgPT4gMCwNCiAgICBpc1ZvaWRUYWc6IE5PLA0KICAgIGlzUHJlVGFnOiBOTywNCiAgICBpc0lnbm9yZU5ld2xpbmVUYWc6IE5PLA0KICAgIGlzQ3VzdG9tRWxlbWVudDogTk8sDQogICAgb25FcnJvcjogZGVmYXVsdE9uRXJyb3IsDQogICAgb25XYXJuOiBkZWZhdWx0T25XYXJuLA0KICAgIGNvbW1lbnRzOiB0cnVlLA0KICAgIHByZWZpeElkZW50aWZpZXJzOiBmYWxzZQ0KICB9Ow0KICBsZXQgY3VycmVudE9wdGlvbnMgPSBkZWZhdWx0UGFyc2VyT3B0aW9uczsNCiAgbGV0IGN1cnJlbnRSb290ID0gbnVsbDsNCiAgbGV0IGN1cnJlbnRJbnB1dCA9ICIiOw0KICBsZXQgY3VycmVudE9wZW5UYWcgPSBudWxsOw0KICBsZXQgY3VycmVudFByb3AgPSBudWxsOw0KICBsZXQgY3VycmVudEF0dHJWYWx1ZSA9ICIiOw0KICBsZXQgY3VycmVudEF0dHJTdGFydEluZGV4ID0gLTE7DQogIGxldCBjdXJyZW50QXR0ckVuZEluZGV4ID0gLTE7DQogIGxldCBpblByZSA9IDA7DQogIGxldCBpblZQcmUgPSBmYWxzZTsNCiAgbGV0IGN1cnJlbnRWUHJlQm91bmRhcnkgPSBudWxsOw0KICBjb25zdCBzdGFjayA9IFtdOw0KICBjb25zdCB0b2tlbml6ZXIgPSBuZXcgVG9rZW5pemVyKHN0YWNrLCB7DQogICAgb25lcnI6IGVtaXRFcnJvciwNCiAgICBvbnRleHQoc3RhcnQsIGVuZCkgew0KICAgICAgb25UZXh0KGdldFNsaWNlKHN0YXJ0LCBlbmQpLCBzdGFydCwgZW5kKTsNCiAgICB9LA0KICAgIG9udGV4dGVudGl0eShjaGFyLCBzdGFydCwgZW5kKSB7DQogICAgICBvblRleHQoY2hhciwgc3RhcnQsIGVuZCk7DQogICAgfSwNCiAgICBvbmludGVycG9sYXRpb24oc3RhcnQsIGVuZCkgew0KICAgICAgaWYgKGluVlByZSkgew0KICAgICAgICByZXR1cm4gb25UZXh0KGdldFNsaWNlKHN0YXJ0LCBlbmQpLCBzdGFydCwgZW5kKTsNCiAgICAgIH0NCiAgICAgIGxldCBpbm5lclN0YXJ0ID0gc3RhcnQgKyB0b2tlbml6ZXIuZGVsaW1pdGVyT3Blbi5sZW5ndGg7DQogICAgICBsZXQgaW5uZXJFbmQgPSBlbmQgLSB0b2tlbml6ZXIuZGVsaW1pdGVyQ2xvc2UubGVuZ3RoOw0KICAgICAgd2hpbGUgKGlzV2hpdGVzcGFjZShjdXJyZW50SW5wdXQuY2hhckNvZGVBdChpbm5lclN0YXJ0KSkpIHsNCiAgICAgICAgaW5uZXJTdGFydCsrOw0KICAgICAgfQ0KICAgICAgd2hpbGUgKGlzV2hpdGVzcGFjZShjdXJyZW50SW5wdXQuY2hhckNvZGVBdChpbm5lckVuZCAtIDEpKSkgew0KICAgICAgICBpbm5lckVuZC0tOw0KICAgICAgfQ0KICAgICAgbGV0IGV4cCA9IGdldFNsaWNlKGlubmVyU3RhcnQsIGlubmVyRW5kKTsNCiAgICAgIGlmIChleHAuaW5jbHVkZXMoIiYiKSkgew0KICAgICAgICB7DQogICAgICAgICAgZXhwID0gY3VycmVudE9wdGlvbnMuZGVjb2RlRW50aXRpZXMoZXhwLCBmYWxzZSk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGFkZE5vZGUoew0KICAgICAgICB0eXBlOiA1LA0KICAgICAgICBjb250ZW50OiBjcmVhdGVFeHAoZXhwLCBmYWxzZSwgZ2V0TG9jKGlubmVyU3RhcnQsIGlubmVyRW5kKSksDQogICAgICAgIGxvYzogZ2V0TG9jKHN0YXJ0LCBlbmQpDQogICAgICB9KTsNCiAgICB9LA0KICAgIG9ub3BlbnRhZ25hbWUoc3RhcnQsIGVuZCkgew0KICAgICAgY29uc3QgbmFtZSA9IGdldFNsaWNlKHN0YXJ0LCBlbmQpOw0KICAgICAgY3VycmVudE9wZW5UYWcgPSB7DQogICAgICAgIHR5cGU6IDEsDQogICAgICAgIHRhZzogbmFtZSwNCiAgICAgICAgbnM6IGN1cnJlbnRPcHRpb25zLmdldE5hbWVzcGFjZShuYW1lLCBzdGFja1swXSwgY3VycmVudE9wdGlvbnMubnMpLA0KICAgICAgICB0YWdUeXBlOiAwLA0KICAgICAgICAvLyB3aWxsIGJlIHJlZmluZWQgb24gdGFnIGNsb3NlDQogICAgICAgIHByb3BzOiBbXSwNCiAgICAgICAgY2hpbGRyZW46IFtdLA0KICAgICAgICBsb2M6IGdldExvYyhzdGFydCAtIDEsIGVuZCksDQogICAgICAgIGNvZGVnZW5Ob2RlOiB2b2lkIDANCiAgICAgIH07DQogICAgfSwNCiAgICBvbm9wZW50YWdlbmQoZW5kKSB7DQogICAgICBlbmRPcGVuVGFnKGVuZCk7DQogICAgfSwNCiAgICBvbmNsb3NldGFnKHN0YXJ0LCBlbmQpIHsNCiAgICAgIGNvbnN0IG5hbWUgPSBnZXRTbGljZShzdGFydCwgZW5kKTsNCiAgICAgIGlmICghY3VycmVudE9wdGlvbnMuaXNWb2lkVGFnKG5hbWUpKSB7DQogICAgICAgIGxldCBmb3VuZCA9IGZhbHNlOw0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0YWNrLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgY29uc3QgZSA9IHN0YWNrW2ldOw0KICAgICAgICAgIGlmIChlLnRhZy50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCkpIHsNCiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsNCiAgICAgICAgICAgIGlmIChpID4gMCkgew0KICAgICAgICAgICAgICBlbWl0RXJyb3IoMjQsIHN0YWNrWzBdLmxvYy5zdGFydC5vZmZzZXQpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPD0gaTsgaisrKSB7DQogICAgICAgICAgICAgIGNvbnN0IGVsID0gc3RhY2suc2hpZnQoKTsNCiAgICAgICAgICAgICAgb25DbG9zZVRhZyhlbCwgZW5kLCBqIDwgaSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFmb3VuZCkgew0KICAgICAgICAgIGVtaXRFcnJvcigyMywgYmFja1RyYWNrKHN0YXJ0LCA2MCkpOw0KICAgICAgICB9DQogICAgICB9DQogICAgfSwNCiAgICBvbnNlbGZjbG9zaW5ndGFnKGVuZCkgew0KICAgICAgY29uc3QgbmFtZSA9IGN1cnJlbnRPcGVuVGFnLnRhZzsNCiAgICAgIGN1cnJlbnRPcGVuVGFnLmlzU2VsZkNsb3NpbmcgPSB0cnVlOw0KICAgICAgZW5kT3BlblRhZyhlbmQpOw0KICAgICAgaWYgKHN0YWNrWzBdICYmIHN0YWNrWzBdLnRhZyA9PT0gbmFtZSkgew0KICAgICAgICBvbkNsb3NlVGFnKHN0YWNrLnNoaWZ0KCksIGVuZCk7DQogICAgICB9DQogICAgfSwNCiAgICBvbmF0dHJpYm5hbWUoc3RhcnQsIGVuZCkgew0KICAgICAgY3VycmVudFByb3AgPSB7DQogICAgICAgIHR5cGU6IDYsDQogICAgICAgIG5hbWU6IGdldFNsaWNlKHN0YXJ0LCBlbmQpLA0KICAgICAgICBuYW1lTG9jOiBnZXRMb2Moc3RhcnQsIGVuZCksDQogICAgICAgIHZhbHVlOiB2b2lkIDAsDQogICAgICAgIGxvYzogZ2V0TG9jKHN0YXJ0KQ0KICAgICAgfTsNCiAgICB9LA0KICAgIG9uZGlybmFtZShzdGFydCwgZW5kKSB7DQogICAgICBjb25zdCByYXcgPSBnZXRTbGljZShzdGFydCwgZW5kKTsNCiAgICAgIGNvbnN0IG5hbWUgPSByYXcgPT09ICIuIiB8fCByYXcgPT09ICI6IiA/ICJiaW5kIiA6IHJhdyA9PT0gIkAiID8gIm9uIiA6IHJhdyA9PT0gIiMiID8gInNsb3QiIDogcmF3LnNsaWNlKDIpOw0KICAgICAgaWYgKCFpblZQcmUgJiYgbmFtZSA9PT0gIiIpIHsNCiAgICAgICAgZW1pdEVycm9yKDI2LCBzdGFydCk7DQogICAgICB9DQogICAgICBpZiAoaW5WUHJlIHx8IG5hbWUgPT09ICIiKSB7DQogICAgICAgIGN1cnJlbnRQcm9wID0gew0KICAgICAgICAgIHR5cGU6IDYsDQogICAgICAgICAgbmFtZTogcmF3LA0KICAgICAgICAgIG5hbWVMb2M6IGdldExvYyhzdGFydCwgZW5kKSwNCiAgICAgICAgICB2YWx1ZTogdm9pZCAwLA0KICAgICAgICAgIGxvYzogZ2V0TG9jKHN0YXJ0KQ0KICAgICAgICB9Ow0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY3VycmVudFByb3AgPSB7DQogICAgICAgICAgdHlwZTogNywNCiAgICAgICAgICBuYW1lLA0KICAgICAgICAgIHJhd05hbWU6IHJhdywNCiAgICAgICAgICBleHA6IHZvaWQgMCwNCiAgICAgICAgICBhcmc6IHZvaWQgMCwNCiAgICAgICAgICBtb2RpZmllcnM6IHJhdyA9PT0gIi4iID8gW2NyZWF0ZVNpbXBsZUV4cHJlc3Npb24oInByb3AiKV0gOiBbXSwNCiAgICAgICAgICBsb2M6IGdldExvYyhzdGFydCkNCiAgICAgICAgfTsNCiAgICAgICAgaWYgKG5hbWUgPT09ICJwcmUiKSB7DQogICAgICAgICAgaW5WUHJlID0gdG9rZW5pemVyLmluVlByZSA9IHRydWU7DQogICAgICAgICAgY3VycmVudFZQcmVCb3VuZGFyeSA9IGN1cnJlbnRPcGVuVGFnOw0KICAgICAgICAgIGNvbnN0IHByb3BzID0gY3VycmVudE9wZW5UYWcucHJvcHM7DQogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgaWYgKHByb3BzW2ldLnR5cGUgPT09IDcpIHsNCiAgICAgICAgICAgICAgcHJvcHNbaV0gPSBkaXJUb0F0dHIocHJvcHNbaV0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0sDQogICAgb25kaXJhcmcoc3RhcnQsIGVuZCkgew0KICAgICAgaWYgKHN0YXJ0ID09PSBlbmQpIHJldHVybjsNCiAgICAgIGNvbnN0IGFyZyA9IGdldFNsaWNlKHN0YXJ0LCBlbmQpOw0KICAgICAgaWYgKGluVlByZSkgew0KICAgICAgICBjdXJyZW50UHJvcC5uYW1lICs9IGFyZzsNCiAgICAgICAgc2V0TG9jRW5kKGN1cnJlbnRQcm9wLm5hbWVMb2MsIGVuZCk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb25zdCBpc1N0YXRpYyA9IGFyZ1swXSAhPT0gYFtgOw0KICAgICAgICBjdXJyZW50UHJvcC5hcmcgPSBjcmVhdGVFeHAoDQogICAgICAgICAgaXNTdGF0aWMgPyBhcmcgOiBhcmcuc2xpY2UoMSwgLTEpLA0KICAgICAgICAgIGlzU3RhdGljLA0KICAgICAgICAgIGdldExvYyhzdGFydCwgZW5kKSwNCiAgICAgICAgICBpc1N0YXRpYyA/IDMgOiAwDQogICAgICAgICk7DQogICAgICB9DQogICAgfSwNCiAgICBvbmRpcm1vZGlmaWVyKHN0YXJ0LCBlbmQpIHsNCiAgICAgIGNvbnN0IG1vZCA9IGdldFNsaWNlKHN0YXJ0LCBlbmQpOw0KICAgICAgaWYgKGluVlByZSkgew0KICAgICAgICBjdXJyZW50UHJvcC5uYW1lICs9ICIuIiArIG1vZDsNCiAgICAgICAgc2V0TG9jRW5kKGN1cnJlbnRQcm9wLm5hbWVMb2MsIGVuZCk7DQogICAgICB9IGVsc2UgaWYgKGN1cnJlbnRQcm9wLm5hbWUgPT09ICJzbG90Iikgew0KICAgICAgICBjb25zdCBhcmcgPSBjdXJyZW50UHJvcC5hcmc7DQogICAgICAgIGlmIChhcmcpIHsNCiAgICAgICAgICBhcmcuY29udGVudCArPSAiLiIgKyBtb2Q7DQogICAgICAgICAgc2V0TG9jRW5kKGFyZy5sb2MsIGVuZCk7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbnN0IGV4cCA9IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24obW9kLCB0cnVlLCBnZXRMb2Moc3RhcnQsIGVuZCkpOw0KICAgICAgICBjdXJyZW50UHJvcC5tb2RpZmllcnMucHVzaChleHApOw0KICAgICAgfQ0KICAgIH0sDQogICAgb25hdHRyaWJkYXRhKHN0YXJ0LCBlbmQpIHsNCiAgICAgIGN1cnJlbnRBdHRyVmFsdWUgKz0gZ2V0U2xpY2Uoc3RhcnQsIGVuZCk7DQogICAgICBpZiAoY3VycmVudEF0dHJTdGFydEluZGV4IDwgMCkgY3VycmVudEF0dHJTdGFydEluZGV4ID0gc3RhcnQ7DQogICAgICBjdXJyZW50QXR0ckVuZEluZGV4ID0gZW5kOw0KICAgIH0sDQogICAgb25hdHRyaWJlbnRpdHkoY2hhciwgc3RhcnQsIGVuZCkgew0KICAgICAgY3VycmVudEF0dHJWYWx1ZSArPSBjaGFyOw0KICAgICAgaWYgKGN1cnJlbnRBdHRyU3RhcnRJbmRleCA8IDApIGN1cnJlbnRBdHRyU3RhcnRJbmRleCA9IHN0YXJ0Ow0KICAgICAgY3VycmVudEF0dHJFbmRJbmRleCA9IGVuZDsNCiAgICB9LA0KICAgIG9uYXR0cmlibmFtZWVuZChlbmQpIHsNCiAgICAgIGNvbnN0IHN0YXJ0ID0gY3VycmVudFByb3AubG9jLnN0YXJ0Lm9mZnNldDsNCiAgICAgIGNvbnN0IG5hbWUgPSBnZXRTbGljZShzdGFydCwgZW5kKTsNCiAgICAgIGlmIChjdXJyZW50UHJvcC50eXBlID09PSA3KSB7DQogICAgICAgIGN1cnJlbnRQcm9wLnJhd05hbWUgPSBuYW1lOw0KICAgICAgfQ0KICAgICAgaWYgKGN1cnJlbnRPcGVuVGFnLnByb3BzLnNvbWUoDQogICAgICAgIChwKSA9PiAocC50eXBlID09PSA3ID8gcC5yYXdOYW1lIDogcC5uYW1lKSA9PT0gbmFtZQ0KICAgICAgKSkgew0KICAgICAgICBlbWl0RXJyb3IoMiwgc3RhcnQpOw0KICAgICAgfQ0KICAgIH0sDQogICAgb25hdHRyaWJlbmQocXVvdGUsIGVuZCkgew0KICAgICAgaWYgKGN1cnJlbnRPcGVuVGFnICYmIGN1cnJlbnRQcm9wKSB7DQogICAgICAgIHNldExvY0VuZChjdXJyZW50UHJvcC5sb2MsIGVuZCk7DQogICAgICAgIGlmIChxdW90ZSAhPT0gMCkgew0KICAgICAgICAgIGlmIChjdXJyZW50QXR0clZhbHVlLmluY2x1ZGVzKCImIikpIHsNCiAgICAgICAgICAgIGN1cnJlbnRBdHRyVmFsdWUgPSBjdXJyZW50T3B0aW9ucy5kZWNvZGVFbnRpdGllcygNCiAgICAgICAgICAgICAgY3VycmVudEF0dHJWYWx1ZSwNCiAgICAgICAgICAgICAgdHJ1ZQ0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKGN1cnJlbnRQcm9wLnR5cGUgPT09IDYpIHsNCiAgICAgICAgICAgIGlmIChjdXJyZW50UHJvcC5uYW1lID09PSAiY2xhc3MiKSB7DQogICAgICAgICAgICAgIGN1cnJlbnRBdHRyVmFsdWUgPSBjb25kZW5zZShjdXJyZW50QXR0clZhbHVlKS50cmltKCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAocXVvdGUgPT09IDEgJiYgIWN1cnJlbnRBdHRyVmFsdWUpIHsNCiAgICAgICAgICAgICAgZW1pdEVycm9yKDEzLCBlbmQpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY3VycmVudFByb3AudmFsdWUgPSB7DQogICAgICAgICAgICAgIHR5cGU6IDIsDQogICAgICAgICAgICAgIGNvbnRlbnQ6IGN1cnJlbnRBdHRyVmFsdWUsDQogICAgICAgICAgICAgIGxvYzogcXVvdGUgPT09IDEgPyBnZXRMb2MoY3VycmVudEF0dHJTdGFydEluZGV4LCBjdXJyZW50QXR0ckVuZEluZGV4KSA6IGdldExvYyhjdXJyZW50QXR0clN0YXJ0SW5kZXggLSAxLCBjdXJyZW50QXR0ckVuZEluZGV4ICsgMSkNCiAgICAgICAgICAgIH07DQogICAgICAgICAgICBpZiAodG9rZW5pemVyLmluU0ZDUm9vdCAmJiBjdXJyZW50T3BlblRhZy50YWcgPT09ICJ0ZW1wbGF0ZSIgJiYgY3VycmVudFByb3AubmFtZSA9PT0gImxhbmciICYmIGN1cnJlbnRBdHRyVmFsdWUgJiYgY3VycmVudEF0dHJWYWx1ZSAhPT0gImh0bWwiKSB7DQogICAgICAgICAgICAgIHRva2VuaXplci5lbnRlclJDREFUQSh0b0NoYXJDb2RlcyhgPC90ZW1wbGF0ZWApLCAwKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgbGV0IGV4cFBhcnNlTW9kZSA9IDAgLyogTm9ybWFsICovOw0KICAgICAgICAgICAgY3VycmVudFByb3AuZXhwID0gY3JlYXRlRXhwKA0KICAgICAgICAgICAgICBjdXJyZW50QXR0clZhbHVlLA0KICAgICAgICAgICAgICBmYWxzZSwNCiAgICAgICAgICAgICAgZ2V0TG9jKGN1cnJlbnRBdHRyU3RhcnRJbmRleCwgY3VycmVudEF0dHJFbmRJbmRleCksDQogICAgICAgICAgICAgIDAsDQogICAgICAgICAgICAgIGV4cFBhcnNlTW9kZQ0KICAgICAgICAgICAgKTsNCiAgICAgICAgICAgIGlmIChjdXJyZW50UHJvcC5uYW1lID09PSAiZm9yIikgew0KICAgICAgICAgICAgICBjdXJyZW50UHJvcC5mb3JQYXJzZVJlc3VsdCA9IHBhcnNlRm9yRXhwcmVzc2lvbihjdXJyZW50UHJvcC5leHApOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBpZiAoY3VycmVudFByb3AudHlwZSAhPT0gNyB8fCBjdXJyZW50UHJvcC5uYW1lICE9PSAicHJlIikgew0KICAgICAgICAgIGN1cnJlbnRPcGVuVGFnLnByb3BzLnB1c2goY3VycmVudFByb3ApOw0KICAgICAgICB9DQogICAgICB9DQogICAgICBjdXJyZW50QXR0clZhbHVlID0gIiI7DQogICAgICBjdXJyZW50QXR0clN0YXJ0SW5kZXggPSBjdXJyZW50QXR0ckVuZEluZGV4ID0gLTE7DQogICAgfSwNCiAgICBvbmNvbW1lbnQoc3RhcnQsIGVuZCkgew0KICAgICAgaWYgKGN1cnJlbnRPcHRpb25zLmNvbW1lbnRzKSB7DQogICAgICAgIGFkZE5vZGUoew0KICAgICAgICAgIHR5cGU6IDMsDQogICAgICAgICAgY29udGVudDogZ2V0U2xpY2Uoc3RhcnQsIGVuZCksDQogICAgICAgICAgbG9jOiBnZXRMb2Moc3RhcnQgLSA0LCBlbmQgKyAzKQ0KICAgICAgICB9KTsNCiAgICAgIH0NCiAgICB9LA0KICAgIG9uZW5kKCkgew0KICAgICAgY29uc3QgZW5kID0gY3VycmVudElucHV0Lmxlbmd0aDsNCiAgICAgIGlmICh0b2tlbml6ZXIuc3RhdGUgIT09IDEpIHsNCiAgICAgICAgc3dpdGNoICh0b2tlbml6ZXIuc3RhdGUpIHsNCiAgICAgICAgICBjYXNlIDU6DQogICAgICAgICAgY2FzZSA4Og0KICAgICAgICAgICAgZW1pdEVycm9yKDUsIGVuZCk7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICBjYXNlIDM6DQogICAgICAgICAgY2FzZSA0Og0KICAgICAgICAgICAgZW1pdEVycm9yKA0KICAgICAgICAgICAgICAyNSwNCiAgICAgICAgICAgICAgdG9rZW5pemVyLnNlY3Rpb25TdGFydA0KICAgICAgICAgICAgKTsNCiAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgIGNhc2UgMjg6DQogICAgICAgICAgICBpZiAodG9rZW5pemVyLmN1cnJlbnRTZXF1ZW5jZSA9PT0gU2VxdWVuY2VzLkNkYXRhRW5kKSB7DQogICAgICAgICAgICAgIGVtaXRFcnJvcig2LCBlbmQpOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgZW1pdEVycm9yKDcsIGVuZCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICBjYXNlIDY6DQogICAgICAgICAgY2FzZSA3Og0KICAgICAgICAgIGNhc2UgOToNCiAgICAgICAgICBjYXNlIDExOg0KICAgICAgICAgIGNhc2UgMTI6DQogICAgICAgICAgY2FzZSAxMzoNCiAgICAgICAgICBjYXNlIDE0Og0KICAgICAgICAgIGNhc2UgMTU6DQogICAgICAgICAgY2FzZSAxNjoNCiAgICAgICAgICBjYXNlIDE3Og0KICAgICAgICAgIGNhc2UgMTg6DQogICAgICAgICAgY2FzZSAxOToNCiAgICAgICAgICAvLyAiDQogICAgICAgICAgY2FzZSAyMDoNCiAgICAgICAgICAvLyAnDQogICAgICAgICAgY2FzZSAyMToNCiAgICAgICAgICAgIGVtaXRFcnJvcig5LCBlbmQpOw0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBzdGFjay5sZW5ndGg7IGluZGV4KyspIHsNCiAgICAgICAgb25DbG9zZVRhZyhzdGFja1tpbmRleF0sIGVuZCAtIDEpOw0KICAgICAgICBlbWl0RXJyb3IoMjQsIHN0YWNrW2luZGV4XS5sb2Muc3RhcnQub2Zmc2V0KTsNCiAgICAgIH0NCiAgICB9LA0KICAgIG9uY2RhdGEoc3RhcnQsIGVuZCkgew0KICAgICAgaWYgKHN0YWNrWzBdLm5zICE9PSAwKSB7DQogICAgICAgIG9uVGV4dChnZXRTbGljZShzdGFydCwgZW5kKSwgc3RhcnQsIGVuZCk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBlbWl0RXJyb3IoMSwgc3RhcnQgLSA5KTsNCiAgICAgIH0NCiAgICB9LA0KICAgIG9ucHJvY2Vzc2luZ2luc3RydWN0aW9uKHN0YXJ0KSB7DQogICAgICBpZiAoKHN0YWNrWzBdID8gc3RhY2tbMF0ubnMgOiBjdXJyZW50T3B0aW9ucy5ucykgPT09IDApIHsNCiAgICAgICAgZW1pdEVycm9yKA0KICAgICAgICAgIDIxLA0KICAgICAgICAgIHN0YXJ0IC0gMQ0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH0NCiAgfSk7DQogIGNvbnN0IGZvckl0ZXJhdG9yUkUgPSAvLChbXixcfVxdXSopKD86LChbXixcfVxdXSopKT8kLzsNCiAgY29uc3Qgc3RyaXBQYXJlbnNSRSA9IC9eXCh8XCkkL2c7DQogIGZ1bmN0aW9uIHBhcnNlRm9yRXhwcmVzc2lvbihpbnB1dCkgew0KICAgIGNvbnN0IGxvYyA9IGlucHV0LmxvYzsNCiAgICBjb25zdCBleHAgPSBpbnB1dC5jb250ZW50Ow0KICAgIGNvbnN0IGluTWF0Y2ggPSBleHAubWF0Y2goZm9yQWxpYXNSRSk7DQogICAgaWYgKCFpbk1hdGNoKSByZXR1cm47DQogICAgY29uc3QgWywgTEhTLCBSSFNdID0gaW5NYXRjaDsNCiAgICBjb25zdCBjcmVhdGVBbGlhc0V4cHJlc3Npb24gPSAoY29udGVudCwgb2Zmc2V0LCBhc1BhcmFtID0gZmFsc2UpID0+IHsNCiAgICAgIGNvbnN0IHN0YXJ0ID0gbG9jLnN0YXJ0Lm9mZnNldCArIG9mZnNldDsNCiAgICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgY29udGVudC5sZW5ndGg7DQogICAgICByZXR1cm4gY3JlYXRlRXhwKA0KICAgICAgICBjb250ZW50LA0KICAgICAgICBmYWxzZSwNCiAgICAgICAgZ2V0TG9jKHN0YXJ0LCBlbmQpLA0KICAgICAgICAwLA0KICAgICAgICBhc1BhcmFtID8gMSAvKiBQYXJhbXMgKi8gOiAwIC8qIE5vcm1hbCAqLw0KICAgICAgKTsNCiAgICB9Ow0KICAgIGNvbnN0IHJlc3VsdCA9IHsNCiAgICAgIHNvdXJjZTogY3JlYXRlQWxpYXNFeHByZXNzaW9uKFJIUy50cmltKCksIGV4cC5pbmRleE9mKFJIUywgTEhTLmxlbmd0aCkpLA0KICAgICAgdmFsdWU6IHZvaWQgMCwNCiAgICAgIGtleTogdm9pZCAwLA0KICAgICAgaW5kZXg6IHZvaWQgMCwNCiAgICAgIGZpbmFsaXplZDogZmFsc2UNCiAgICB9Ow0KICAgIGxldCB2YWx1ZUNvbnRlbnQgPSBMSFMudHJpbSgpLnJlcGxhY2Uoc3RyaXBQYXJlbnNSRSwgIiIpLnRyaW0oKTsNCiAgICBjb25zdCB0cmltbWVkT2Zmc2V0ID0gTEhTLmluZGV4T2YodmFsdWVDb250ZW50KTsNCiAgICBjb25zdCBpdGVyYXRvck1hdGNoID0gdmFsdWVDb250ZW50Lm1hdGNoKGZvckl0ZXJhdG9yUkUpOw0KICAgIGlmIChpdGVyYXRvck1hdGNoKSB7DQogICAgICB2YWx1ZUNvbnRlbnQgPSB2YWx1ZUNvbnRlbnQucmVwbGFjZShmb3JJdGVyYXRvclJFLCAiIikudHJpbSgpOw0KICAgICAgY29uc3Qga2V5Q29udGVudCA9IGl0ZXJhdG9yTWF0Y2hbMV0udHJpbSgpOw0KICAgICAgbGV0IGtleU9mZnNldDsNCiAgICAgIGlmIChrZXlDb250ZW50KSB7DQogICAgICAgIGtleU9mZnNldCA9IGV4cC5pbmRleE9mKGtleUNvbnRlbnQsIHRyaW1tZWRPZmZzZXQgKyB2YWx1ZUNvbnRlbnQubGVuZ3RoKTsNCiAgICAgICAgcmVzdWx0LmtleSA9IGNyZWF0ZUFsaWFzRXhwcmVzc2lvbihrZXlDb250ZW50LCBrZXlPZmZzZXQsIHRydWUpOw0KICAgICAgfQ0KICAgICAgaWYgKGl0ZXJhdG9yTWF0Y2hbMl0pIHsNCiAgICAgICAgY29uc3QgaW5kZXhDb250ZW50ID0gaXRlcmF0b3JNYXRjaFsyXS50cmltKCk7DQogICAgICAgIGlmIChpbmRleENvbnRlbnQpIHsNCiAgICAgICAgICByZXN1bHQuaW5kZXggPSBjcmVhdGVBbGlhc0V4cHJlc3Npb24oDQogICAgICAgICAgICBpbmRleENvbnRlbnQsDQogICAgICAgICAgICBleHAuaW5kZXhPZigNCiAgICAgICAgICAgICAgaW5kZXhDb250ZW50LA0KICAgICAgICAgICAgICByZXN1bHQua2V5ID8ga2V5T2Zmc2V0ICsga2V5Q29udGVudC5sZW5ndGggOiB0cmltbWVkT2Zmc2V0ICsgdmFsdWVDb250ZW50Lmxlbmd0aA0KICAgICAgICAgICAgKSwNCiAgICAgICAgICAgIHRydWUNCiAgICAgICAgICApOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIGlmICh2YWx1ZUNvbnRlbnQpIHsNCiAgICAgIHJlc3VsdC52YWx1ZSA9IGNyZWF0ZUFsaWFzRXhwcmVzc2lvbih2YWx1ZUNvbnRlbnQsIHRyaW1tZWRPZmZzZXQsIHRydWUpOw0KICAgIH0NCiAgICByZXR1cm4gcmVzdWx0Ow0KICB9DQogIGZ1bmN0aW9uIGdldFNsaWNlKHN0YXJ0LCBlbmQpIHsNCiAgICByZXR1cm4gY3VycmVudElucHV0LnNsaWNlKHN0YXJ0LCBlbmQpOw0KICB9DQogIGZ1bmN0aW9uIGVuZE9wZW5UYWcoZW5kKSB7DQogICAgaWYgKHRva2VuaXplci5pblNGQ1Jvb3QpIHsNCiAgICAgIGN1cnJlbnRPcGVuVGFnLmlubmVyTG9jID0gZ2V0TG9jKGVuZCArIDEsIGVuZCArIDEpOw0KICAgIH0NCiAgICBhZGROb2RlKGN1cnJlbnRPcGVuVGFnKTsNCiAgICBjb25zdCB7IHRhZywgbnMgfSA9IGN1cnJlbnRPcGVuVGFnOw0KICAgIGlmIChucyA9PT0gMCAmJiBjdXJyZW50T3B0aW9ucy5pc1ByZVRhZyh0YWcpKSB7DQogICAgICBpblByZSsrOw0KICAgIH0NCiAgICBpZiAoY3VycmVudE9wdGlvbnMuaXNWb2lkVGFnKHRhZykpIHsNCiAgICAgIG9uQ2xvc2VUYWcoY3VycmVudE9wZW5UYWcsIGVuZCk7DQogICAgfSBlbHNlIHsNCiAgICAgIHN0YWNrLnVuc2hpZnQoY3VycmVudE9wZW5UYWcpOw0KICAgICAgaWYgKG5zID09PSAxIHx8IG5zID09PSAyKSB7DQogICAgICAgIHRva2VuaXplci5pblhNTCA9IHRydWU7DQogICAgICB9DQogICAgfQ0KICAgIGN1cnJlbnRPcGVuVGFnID0gbnVsbDsNCiAgfQ0KICBmdW5jdGlvbiBvblRleHQoY29udGVudCwgc3RhcnQsIGVuZCkgew0KICAgIHsNCiAgICAgIGNvbnN0IHRhZyA9IHN0YWNrWzBdICYmIHN0YWNrWzBdLnRhZzsNCiAgICAgIGlmICh0YWcgIT09ICJzY3JpcHQiICYmIHRhZyAhPT0gInN0eWxlIiAmJiBjb250ZW50LmluY2x1ZGVzKCImIikpIHsNCiAgICAgICAgY29udGVudCA9IGN1cnJlbnRPcHRpb25zLmRlY29kZUVudGl0aWVzKGNvbnRlbnQsIGZhbHNlKTsNCiAgICAgIH0NCiAgICB9DQogICAgY29uc3QgcGFyZW50ID0gc3RhY2tbMF0gfHwgY3VycmVudFJvb3Q7DQogICAgY29uc3QgbGFzdE5vZGUgPSBwYXJlbnQuY2hpbGRyZW5bcGFyZW50LmNoaWxkcmVuLmxlbmd0aCAtIDFdOw0KICAgIGlmIChsYXN0Tm9kZSAmJiBsYXN0Tm9kZS50eXBlID09PSAyKSB7DQogICAgICBsYXN0Tm9kZS5jb250ZW50ICs9IGNvbnRlbnQ7DQogICAgICBzZXRMb2NFbmQobGFzdE5vZGUubG9jLCBlbmQpOw0KICAgIH0gZWxzZSB7DQogICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaCh7DQogICAgICAgIHR5cGU6IDIsDQogICAgICAgIGNvbnRlbnQsDQogICAgICAgIGxvYzogZ2V0TG9jKHN0YXJ0LCBlbmQpDQogICAgICB9KTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gb25DbG9zZVRhZyhlbCwgZW5kLCBpc0ltcGxpZWQgPSBmYWxzZSkgew0KICAgIGlmIChpc0ltcGxpZWQpIHsNCiAgICAgIHNldExvY0VuZChlbC5sb2MsIGJhY2tUcmFjayhlbmQsIDYwKSk7DQogICAgfSBlbHNlIHsNCiAgICAgIHNldExvY0VuZChlbC5sb2MsIGxvb2tBaGVhZChlbmQsIDYyKSArIDEpOw0KICAgIH0NCiAgICBpZiAodG9rZW5pemVyLmluU0ZDUm9vdCkgew0KICAgICAgaWYgKGVsLmNoaWxkcmVuLmxlbmd0aCkgew0KICAgICAgICBlbC5pbm5lckxvYy5lbmQgPSBleHRlbmQoe30sIGVsLmNoaWxkcmVuW2VsLmNoaWxkcmVuLmxlbmd0aCAtIDFdLmxvYy5lbmQpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgZWwuaW5uZXJMb2MuZW5kID0gZXh0ZW5kKHt9LCBlbC5pbm5lckxvYy5zdGFydCk7DQogICAgICB9DQogICAgICBlbC5pbm5lckxvYy5zb3VyY2UgPSBnZXRTbGljZSgNCiAgICAgICAgZWwuaW5uZXJMb2Muc3RhcnQub2Zmc2V0LA0KICAgICAgICBlbC5pbm5lckxvYy5lbmQub2Zmc2V0DQogICAgICApOw0KICAgIH0NCiAgICBjb25zdCB7IHRhZywgbnMsIGNoaWxkcmVuIH0gPSBlbDsNCiAgICBpZiAoIWluVlByZSkgew0KICAgICAgaWYgKHRhZyA9PT0gInNsb3QiKSB7DQogICAgICAgIGVsLnRhZ1R5cGUgPSAyOw0KICAgICAgfSBlbHNlIGlmIChpc0ZyYWdtZW50VGVtcGxhdGUoZWwpKSB7DQogICAgICAgIGVsLnRhZ1R5cGUgPSAzOw0KICAgICAgfSBlbHNlIGlmIChpc0NvbXBvbmVudChlbCkpIHsNCiAgICAgICAgZWwudGFnVHlwZSA9IDE7DQogICAgICB9DQogICAgfQ0KICAgIGlmICghdG9rZW5pemVyLmluUkNEQVRBKSB7DQogICAgICBlbC5jaGlsZHJlbiA9IGNvbmRlbnNlV2hpdGVzcGFjZShjaGlsZHJlbik7DQogICAgfQ0KICAgIGlmIChucyA9PT0gMCAmJiBjdXJyZW50T3B0aW9ucy5pc0lnbm9yZU5ld2xpbmVUYWcodGFnKSkgew0KICAgICAgY29uc3QgZmlyc3QgPSBjaGlsZHJlblswXTsNCiAgICAgIGlmIChmaXJzdCAmJiBmaXJzdC50eXBlID09PSAyKSB7DQogICAgICAgIGZpcnN0LmNvbnRlbnQgPSBmaXJzdC5jb250ZW50LnJlcGxhY2UoL15ccj9cbi8sICIiKTsNCiAgICAgIH0NCiAgICB9DQogICAgaWYgKG5zID09PSAwICYmIGN1cnJlbnRPcHRpb25zLmlzUHJlVGFnKHRhZykpIHsNCiAgICAgIGluUHJlLS07DQogICAgfQ0KICAgIGlmIChjdXJyZW50VlByZUJvdW5kYXJ5ID09PSBlbCkgew0KICAgICAgaW5WUHJlID0gdG9rZW5pemVyLmluVlByZSA9IGZhbHNlOw0KICAgICAgY3VycmVudFZQcmVCb3VuZGFyeSA9IG51bGw7DQogICAgfQ0KICAgIGlmICh0b2tlbml6ZXIuaW5YTUwgJiYgKHN0YWNrWzBdID8gc3RhY2tbMF0ubnMgOiBjdXJyZW50T3B0aW9ucy5ucykgPT09IDApIHsNCiAgICAgIHRva2VuaXplci5pblhNTCA9IGZhbHNlOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBsb29rQWhlYWQoaW5kZXgsIGMpIHsNCiAgICBsZXQgaSA9IGluZGV4Ow0KICAgIHdoaWxlIChjdXJyZW50SW5wdXQuY2hhckNvZGVBdChpKSAhPT0gYyAmJiBpIDwgY3VycmVudElucHV0Lmxlbmd0aCAtIDEpIGkrKzsNCiAgICByZXR1cm4gaTsNCiAgfQ0KICBmdW5jdGlvbiBiYWNrVHJhY2soaW5kZXgsIGMpIHsNCiAgICBsZXQgaSA9IGluZGV4Ow0KICAgIHdoaWxlIChjdXJyZW50SW5wdXQuY2hhckNvZGVBdChpKSAhPT0gYyAmJiBpID49IDApIGktLTsNCiAgICByZXR1cm4gaTsNCiAgfQ0KICBjb25zdCBzcGVjaWFsVGVtcGxhdGVEaXIgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbImlmIiwgImVsc2UiLCAiZWxzZS1pZiIsICJmb3IiLCAic2xvdCJdKTsNCiAgZnVuY3Rpb24gaXNGcmFnbWVudFRlbXBsYXRlKHsgdGFnLCBwcm9wcyB9KSB7DQogICAgaWYgKHRhZyA9PT0gInRlbXBsYXRlIikgew0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgew0KICAgICAgICBpZiAocHJvcHNbaV0udHlwZSA9PT0gNyAmJiBzcGVjaWFsVGVtcGxhdGVEaXIuaGFzKHByb3BzW2ldLm5hbWUpKSB7DQogICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIGZhbHNlOw0KICB9DQogIGZ1bmN0aW9uIGlzQ29tcG9uZW50KHsgdGFnLCBwcm9wcyB9KSB7DQogICAgaWYgKGN1cnJlbnRPcHRpb25zLmlzQ3VzdG9tRWxlbWVudCh0YWcpKSB7DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KICAgIGlmICh0YWcgPT09ICJjb21wb25lbnQiIHx8IGlzVXBwZXJDYXNlKHRhZy5jaGFyQ29kZUF0KDApKSB8fCBpc0NvcmVDb21wb25lbnQodGFnKSB8fCBjdXJyZW50T3B0aW9ucy5pc0J1aWx0SW5Db21wb25lbnQgJiYgY3VycmVudE9wdGlvbnMuaXNCdWlsdEluQ29tcG9uZW50KHRhZykgfHwgY3VycmVudE9wdGlvbnMuaXNOYXRpdmVUYWcgJiYgIWN1cnJlbnRPcHRpb25zLmlzTmF0aXZlVGFnKHRhZykpIHsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7DQogICAgICBjb25zdCBwID0gcHJvcHNbaV07DQogICAgICBpZiAocC50eXBlID09PSA2KSB7DQogICAgICAgIGlmIChwLm5hbWUgPT09ICJpcyIgJiYgcC52YWx1ZSkgew0KICAgICAgICAgIGlmIChwLnZhbHVlLmNvbnRlbnQuc3RhcnRzV2l0aCgidnVlOiIpKSB7DQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIGZhbHNlOw0KICB9DQogIGZ1bmN0aW9uIGlzVXBwZXJDYXNlKGMpIHsNCiAgICByZXR1cm4gYyA+IDY0ICYmIGMgPCA5MTsNCiAgfQ0KICBjb25zdCB3aW5kb3dzTmV3bGluZVJFID0gL1xyXG4vZzsNCiAgZnVuY3Rpb24gY29uZGVuc2VXaGl0ZXNwYWNlKG5vZGVzKSB7DQogICAgY29uc3Qgc2hvdWxkQ29uZGVuc2UgPSBjdXJyZW50T3B0aW9ucy53aGl0ZXNwYWNlICE9PSAicHJlc2VydmUiOw0KICAgIGxldCByZW1vdmVkV2hpdGVzcGFjZSA9IGZhbHNlOw0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgIGNvbnN0IG5vZGUgPSBub2Rlc1tpXTsNCiAgICAgIGlmIChub2RlLnR5cGUgPT09IDIpIHsNCiAgICAgICAgaWYgKCFpblByZSkgew0KICAgICAgICAgIGlmIChpc0FsbFdoaXRlc3BhY2Uobm9kZS5jb250ZW50KSkgew0KICAgICAgICAgICAgY29uc3QgcHJldiA9IG5vZGVzW2kgLSAxXSAmJiBub2Rlc1tpIC0gMV0udHlwZTsNCiAgICAgICAgICAgIGNvbnN0IG5leHQgPSBub2Rlc1tpICsgMV0gJiYgbm9kZXNbaSArIDFdLnR5cGU7DQogICAgICAgICAgICBpZiAoIXByZXYgfHwgIW5leHQgfHwgc2hvdWxkQ29uZGVuc2UgJiYgKHByZXYgPT09IDMgJiYgKG5leHQgPT09IDMgfHwgbmV4dCA9PT0gMSkgfHwgcHJldiA9PT0gMSAmJiAobmV4dCA9PT0gMyB8fCBuZXh0ID09PSAxICYmIGhhc05ld2xpbmVDaGFyKG5vZGUuY29udGVudCkpKSkgew0KICAgICAgICAgICAgICByZW1vdmVkV2hpdGVzcGFjZSA9IHRydWU7DQogICAgICAgICAgICAgIG5vZGVzW2ldID0gbnVsbDsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgIG5vZGUuY29udGVudCA9ICIgIjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZENvbmRlbnNlKSB7DQogICAgICAgICAgICBub2RlLmNvbnRlbnQgPSBjb25kZW5zZShub2RlLmNvbnRlbnQpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBub2RlLmNvbnRlbnQgPSBub2RlLmNvbnRlbnQucmVwbGFjZSh3aW5kb3dzTmV3bGluZVJFLCAiXG4iKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gcmVtb3ZlZFdoaXRlc3BhY2UgPyBub2Rlcy5maWx0ZXIoQm9vbGVhbikgOiBub2RlczsNCiAgfQ0KICBmdW5jdGlvbiBpc0FsbFdoaXRlc3BhY2Uoc3RyKSB7DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpKyspIHsNCiAgICAgIGlmICghaXNXaGl0ZXNwYWNlKHN0ci5jaGFyQ29kZUF0KGkpKSkgew0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiB0cnVlOw0KICB9DQogIGZ1bmN0aW9uIGhhc05ld2xpbmVDaGFyKHN0cikgew0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgaSsrKSB7DQogICAgICBjb25zdCBjID0gc3RyLmNoYXJDb2RlQXQoaSk7DQogICAgICBpZiAoYyA9PT0gMTAgfHwgYyA9PT0gMTMpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiBmYWxzZTsNCiAgfQ0KICBmdW5jdGlvbiBjb25kZW5zZShzdHIpIHsNCiAgICBsZXQgcmV0ID0gIiI7DQogICAgbGV0IHByZXZDaGFySXNXaGl0ZXNwYWNlID0gZmFsc2U7DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpKyspIHsNCiAgICAgIGlmIChpc1doaXRlc3BhY2Uoc3RyLmNoYXJDb2RlQXQoaSkpKSB7DQogICAgICAgIGlmICghcHJldkNoYXJJc1doaXRlc3BhY2UpIHsNCiAgICAgICAgICByZXQgKz0gIiAiOw0KICAgICAgICAgIHByZXZDaGFySXNXaGl0ZXNwYWNlID0gdHJ1ZTsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0ICs9IHN0cltpXTsNCiAgICAgICAgcHJldkNoYXJJc1doaXRlc3BhY2UgPSBmYWxzZTsNCiAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHJldDsNCiAgfQ0KICBmdW5jdGlvbiBhZGROb2RlKG5vZGUpIHsNCiAgICAoc3RhY2tbMF0gfHwgY3VycmVudFJvb3QpLmNoaWxkcmVuLnB1c2gobm9kZSk7DQogIH0NCiAgZnVuY3Rpb24gZ2V0TG9jKHN0YXJ0LCBlbmQpIHsNCiAgICByZXR1cm4gew0KICAgICAgc3RhcnQ6IHRva2VuaXplci5nZXRQb3Moc3RhcnQpLA0KICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBhbGxvdyBsYXRlIGF0dGFjaG1lbnQNCiAgICAgIGVuZDogZW5kID09IG51bGwgPyBlbmQgOiB0b2tlbml6ZXIuZ2V0UG9zKGVuZCksDQogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGFsbG93IGxhdGUgYXR0YWNobWVudA0KICAgICAgc291cmNlOiBlbmQgPT0gbnVsbCA/IGVuZCA6IGdldFNsaWNlKHN0YXJ0LCBlbmQpDQogICAgfTsNCiAgfQ0KICBmdW5jdGlvbiBjbG9uZUxvYyhsb2MpIHsNCiAgICByZXR1cm4gZ2V0TG9jKGxvYy5zdGFydC5vZmZzZXQsIGxvYy5lbmQub2Zmc2V0KTsNCiAgfQ0KICBmdW5jdGlvbiBzZXRMb2NFbmQobG9jLCBlbmQpIHsNCiAgICBsb2MuZW5kID0gdG9rZW5pemVyLmdldFBvcyhlbmQpOw0KICAgIGxvYy5zb3VyY2UgPSBnZXRTbGljZShsb2Muc3RhcnQub2Zmc2V0LCBlbmQpOw0KICB9DQogIGZ1bmN0aW9uIGRpclRvQXR0cihkaXIpIHsNCiAgICBjb25zdCBhdHRyID0gew0KICAgICAgdHlwZTogNiwNCiAgICAgIG5hbWU6IGRpci5yYXdOYW1lLA0KICAgICAgbmFtZUxvYzogZ2V0TG9jKA0KICAgICAgICBkaXIubG9jLnN0YXJ0Lm9mZnNldCwNCiAgICAgICAgZGlyLmxvYy5zdGFydC5vZmZzZXQgKyBkaXIucmF3TmFtZS5sZW5ndGgNCiAgICAgICksDQogICAgICB2YWx1ZTogdm9pZCAwLA0KICAgICAgbG9jOiBkaXIubG9jDQogICAgfTsNCiAgICBpZiAoZGlyLmV4cCkgew0KICAgICAgY29uc3QgbG9jID0gZGlyLmV4cC5sb2M7DQogICAgICBpZiAobG9jLmVuZC5vZmZzZXQgPCBkaXIubG9jLmVuZC5vZmZzZXQpIHsNCiAgICAgICAgbG9jLnN0YXJ0Lm9mZnNldC0tOw0KICAgICAgICBsb2Muc3RhcnQuY29sdW1uLS07DQogICAgICAgIGxvYy5lbmQub2Zmc2V0Kys7DQogICAgICAgIGxvYy5lbmQuY29sdW1uKys7DQogICAgICB9DQogICAgICBhdHRyLnZhbHVlID0gew0KICAgICAgICB0eXBlOiAyLA0KICAgICAgICBjb250ZW50OiBkaXIuZXhwLmNvbnRlbnQsDQogICAgICAgIGxvYw0KICAgICAgfTsNCiAgICB9DQogICAgcmV0dXJuIGF0dHI7DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlRXhwKGNvbnRlbnQsIGlzU3RhdGljID0gZmFsc2UsIGxvYywgY29uc3RUeXBlID0gMCwgcGFyc2VNb2RlID0gMCAvKiBOb3JtYWwgKi8pIHsNCiAgICBjb25zdCBleHAgPSBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGNvbnRlbnQsIGlzU3RhdGljLCBsb2MsIGNvbnN0VHlwZSk7DQogICAgcmV0dXJuIGV4cDsNCiAgfQ0KICBmdW5jdGlvbiBlbWl0RXJyb3IoY29kZSwgaW5kZXgsIG1lc3NhZ2UpIHsNCiAgICBjdXJyZW50T3B0aW9ucy5vbkVycm9yKA0KICAgICAgY3JlYXRlQ29tcGlsZXJFcnJvcihjb2RlLCBnZXRMb2MoaW5kZXgsIGluZGV4KSwgdm9pZCAwLCBtZXNzYWdlKQ0KICAgICk7DQogIH0NCiAgZnVuY3Rpb24gcmVzZXQoKSB7DQogICAgdG9rZW5pemVyLnJlc2V0KCk7DQogICAgY3VycmVudE9wZW5UYWcgPSBudWxsOw0KICAgIGN1cnJlbnRQcm9wID0gbnVsbDsNCiAgICBjdXJyZW50QXR0clZhbHVlID0gIiI7DQogICAgY3VycmVudEF0dHJTdGFydEluZGV4ID0gLTE7DQogICAgY3VycmVudEF0dHJFbmRJbmRleCA9IC0xOw0KICAgIHN0YWNrLmxlbmd0aCA9IDA7DQogIH0NCiAgZnVuY3Rpb24gYmFzZVBhcnNlKGlucHV0LCBvcHRpb25zKSB7DQogICAgcmVzZXQoKTsNCiAgICBjdXJyZW50SW5wdXQgPSBpbnB1dDsNCiAgICBjdXJyZW50T3B0aW9ucyA9IGV4dGVuZCh7fSwgZGVmYXVsdFBhcnNlck9wdGlvbnMpOw0KICAgIGlmIChvcHRpb25zKSB7DQogICAgICBsZXQga2V5Ow0KICAgICAgZm9yIChrZXkgaW4gb3B0aW9ucykgew0KICAgICAgICBpZiAob3B0aW9uc1trZXldICE9IG51bGwpIHsNCiAgICAgICAgICBjdXJyZW50T3B0aW9uc1trZXldID0gb3B0aW9uc1trZXldOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIHsNCiAgICAgIGlmICghY3VycmVudE9wdGlvbnMuZGVjb2RlRW50aXRpZXMpIHsNCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKA0KICAgICAgICAgIGBbQHZ1ZS9jb21waWxlci1jb3JlXSBkZWNvZGVFbnRpdGllcyBvcHRpb24gaXMgcmVxdWlyZWQgaW4gYnJvd3NlciBidWlsZHMuYA0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH0NCiAgICB0b2tlbml6ZXIubW9kZSA9IGN1cnJlbnRPcHRpb25zLnBhcnNlTW9kZSA9PT0gImh0bWwiID8gMSA6IGN1cnJlbnRPcHRpb25zLnBhcnNlTW9kZSA9PT0gInNmYyIgPyAyIDogMDsNCiAgICB0b2tlbml6ZXIuaW5YTUwgPSBjdXJyZW50T3B0aW9ucy5ucyA9PT0gMSB8fCBjdXJyZW50T3B0aW9ucy5ucyA9PT0gMjsNCiAgICBjb25zdCBkZWxpbWl0ZXJzID0gb3B0aW9ucyAmJiBvcHRpb25zLmRlbGltaXRlcnM7DQogICAgaWYgKGRlbGltaXRlcnMpIHsNCiAgICAgIHRva2VuaXplci5kZWxpbWl0ZXJPcGVuID0gdG9DaGFyQ29kZXMoZGVsaW1pdGVyc1swXSk7DQogICAgICB0b2tlbml6ZXIuZGVsaW1pdGVyQ2xvc2UgPSB0b0NoYXJDb2RlcyhkZWxpbWl0ZXJzWzFdKTsNCiAgICB9DQogICAgY29uc3Qgcm9vdCA9IGN1cnJlbnRSb290ID0gY3JlYXRlUm9vdChbXSwgaW5wdXQpOw0KICAgIHRva2VuaXplci5wYXJzZShjdXJyZW50SW5wdXQpOw0KICAgIHJvb3QubG9jID0gZ2V0TG9jKDAsIGlucHV0Lmxlbmd0aCk7DQogICAgcm9vdC5jaGlsZHJlbiA9IGNvbmRlbnNlV2hpdGVzcGFjZShyb290LmNoaWxkcmVuKTsNCiAgICBjdXJyZW50Um9vdCA9IG51bGw7DQogICAgcmV0dXJuIHJvb3Q7DQogIH0NCg0KICBmdW5jdGlvbiBjYWNoZVN0YXRpYyhyb290LCBjb250ZXh0KSB7DQogICAgd2FsaygNCiAgICAgIHJvb3QsDQogICAgICB2b2lkIDAsDQogICAgICBjb250ZXh0LA0KICAgICAgLy8gUm9vdCBub2RlIGlzIHVuZm9ydHVuYXRlbHkgbm9uLWhvaXN0YWJsZSBkdWUgdG8gcG90ZW50aWFsIHBhcmVudA0KICAgICAgLy8gZmFsbHRocm91Z2ggYXR0cmlidXRlcy4NCiAgICAgICEhZ2V0U2luZ2xlRWxlbWVudFJvb3Qocm9vdCkNCiAgICApOw0KICB9DQogIGZ1bmN0aW9uIGdldFNpbmdsZUVsZW1lbnRSb290KHJvb3QpIHsNCiAgICBjb25zdCBjaGlsZHJlbiA9IHJvb3QuY2hpbGRyZW4uZmlsdGVyKCh4KSA9PiB4LnR5cGUgIT09IDMpOw0KICAgIHJldHVybiBjaGlsZHJlbi5sZW5ndGggPT09IDEgJiYgY2hpbGRyZW5bMF0udHlwZSA9PT0gMSAmJiAhaXNTbG90T3V0bGV0KGNoaWxkcmVuWzBdKSA/IGNoaWxkcmVuWzBdIDogbnVsbDsNCiAgfQ0KICBmdW5jdGlvbiB3YWxrKG5vZGUsIHBhcmVudCwgY29udGV4dCwgZG9Ob3RIb2lzdE5vZGUgPSBmYWxzZSwgaW5Gb3IgPSBmYWxzZSkgew0KICAgIGNvbnN0IHsgY2hpbGRyZW4gfSA9IG5vZGU7DQogICAgY29uc3QgdG9DYWNoZSA9IFtdOw0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsNCiAgICAgIGNvbnN0IGNoaWxkID0gY2hpbGRyZW5baV07DQogICAgICBpZiAoY2hpbGQudHlwZSA9PT0gMSAmJiBjaGlsZC50YWdUeXBlID09PSAwKSB7DQogICAgICAgIGNvbnN0IGNvbnN0YW50VHlwZSA9IGRvTm90SG9pc3ROb2RlID8gMCA6IGdldENvbnN0YW50VHlwZShjaGlsZCwgY29udGV4dCk7DQogICAgICAgIGlmIChjb25zdGFudFR5cGUgPiAwKSB7DQogICAgICAgICAgaWYgKGNvbnN0YW50VHlwZSA+PSAyKSB7DQogICAgICAgICAgICBjaGlsZC5jb2RlZ2VuTm9kZS5wYXRjaEZsYWcgPSAtMTsNCiAgICAgICAgICAgIHRvQ2FjaGUucHVzaChjaGlsZCk7DQogICAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgY29uc3QgY29kZWdlbk5vZGUgPSBjaGlsZC5jb2RlZ2VuTm9kZTsNCiAgICAgICAgICBpZiAoY29kZWdlbk5vZGUudHlwZSA9PT0gMTMpIHsNCiAgICAgICAgICAgIGNvbnN0IGZsYWcgPSBjb2RlZ2VuTm9kZS5wYXRjaEZsYWc7DQogICAgICAgICAgICBpZiAoKGZsYWcgPT09IHZvaWQgMCB8fCBmbGFnID09PSA1MTIgfHwgZmxhZyA9PT0gMSkgJiYgZ2V0R2VuZXJhdGVkUHJvcHNDb25zdGFudFR5cGUoY2hpbGQsIGNvbnRleHQpID49IDIpIHsNCiAgICAgICAgICAgICAgY29uc3QgcHJvcHMgPSBnZXROb2RlUHJvcHMoY2hpbGQpOw0KICAgICAgICAgICAgICBpZiAocHJvcHMpIHsNCiAgICAgICAgICAgICAgICBjb2RlZ2VuTm9kZS5wcm9wcyA9IGNvbnRleHQuaG9pc3QocHJvcHMpOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoY29kZWdlbk5vZGUuZHluYW1pY1Byb3BzKSB7DQogICAgICAgICAgICAgIGNvZGVnZW5Ob2RlLmR5bmFtaWNQcm9wcyA9IGNvbnRleHQuaG9pc3QoY29kZWdlbk5vZGUuZHluYW1pY1Byb3BzKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSBpZiAoY2hpbGQudHlwZSA9PT0gMTIpIHsNCiAgICAgICAgY29uc3QgY29uc3RhbnRUeXBlID0gZG9Ob3RIb2lzdE5vZGUgPyAwIDogZ2V0Q29uc3RhbnRUeXBlKGNoaWxkLCBjb250ZXh0KTsNCiAgICAgICAgaWYgKGNvbnN0YW50VHlwZSA+PSAyKSB7DQogICAgICAgICAgdG9DYWNoZS5wdXNoKGNoaWxkKTsNCiAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgaWYgKGNoaWxkLnR5cGUgPT09IDEpIHsNCiAgICAgICAgY29uc3QgaXNDb21wb25lbnQgPSBjaGlsZC50YWdUeXBlID09PSAxOw0KICAgICAgICBpZiAoaXNDb21wb25lbnQpIHsNCiAgICAgICAgICBjb250ZXh0LnNjb3Blcy52U2xvdCsrOw0KICAgICAgICB9DQogICAgICAgIHdhbGsoY2hpbGQsIG5vZGUsIGNvbnRleHQsIGZhbHNlLCBpbkZvcik7DQogICAgICAgIGlmIChpc0NvbXBvbmVudCkgew0KICAgICAgICAgIGNvbnRleHQuc2NvcGVzLnZTbG90LS07DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSBpZiAoY2hpbGQudHlwZSA9PT0gMTEpIHsNCiAgICAgICAgd2FsayhjaGlsZCwgbm9kZSwgY29udGV4dCwgY2hpbGQuY2hpbGRyZW4ubGVuZ3RoID09PSAxLCB0cnVlKTsNCiAgICAgIH0gZWxzZSBpZiAoY2hpbGQudHlwZSA9PT0gOSkgew0KICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgY2hpbGQuYnJhbmNoZXMubGVuZ3RoOyBpMisrKSB7DQogICAgICAgICAgd2FsaygNCiAgICAgICAgICAgIGNoaWxkLmJyYW5jaGVzW2kyXSwNCiAgICAgICAgICAgIG5vZGUsDQogICAgICAgICAgICBjb250ZXh0LA0KICAgICAgICAgICAgY2hpbGQuYnJhbmNoZXNbaTJdLmNoaWxkcmVuLmxlbmd0aCA9PT0gMSwNCiAgICAgICAgICAgIGluRm9yDQogICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICBsZXQgY2FjaGVkQXNBcnJheSA9IGZhbHNlOw0KICAgIGNvbnN0IHNsb3RDYWNoZUtleXMgPSBbXTsNCiAgICBpZiAodG9DYWNoZS5sZW5ndGggPT09IGNoaWxkcmVuLmxlbmd0aCAmJiBub2RlLnR5cGUgPT09IDEpIHsNCiAgICAgIGlmIChub2RlLnRhZ1R5cGUgPT09IDAgJiYgbm9kZS5jb2RlZ2VuTm9kZSAmJiBub2RlLmNvZGVnZW5Ob2RlLnR5cGUgPT09IDEzICYmIGlzQXJyYXkobm9kZS5jb2RlZ2VuTm9kZS5jaGlsZHJlbikpIHsNCiAgICAgICAgbm9kZS5jb2RlZ2VuTm9kZS5jaGlsZHJlbiA9IGdldENhY2hlRXhwcmVzc2lvbigNCiAgICAgICAgICBjcmVhdGVBcnJheUV4cHJlc3Npb24obm9kZS5jb2RlZ2VuTm9kZS5jaGlsZHJlbikNCiAgICAgICAgKTsNCiAgICAgICAgY2FjaGVkQXNBcnJheSA9IHRydWU7DQogICAgICB9IGVsc2UgaWYgKG5vZGUudGFnVHlwZSA9PT0gMSAmJiBub2RlLmNvZGVnZW5Ob2RlICYmIG5vZGUuY29kZWdlbk5vZGUudHlwZSA9PT0gMTMgJiYgbm9kZS5jb2RlZ2VuTm9kZS5jaGlsZHJlbiAmJiAhaXNBcnJheShub2RlLmNvZGVnZW5Ob2RlLmNoaWxkcmVuKSAmJiBub2RlLmNvZGVnZW5Ob2RlLmNoaWxkcmVuLnR5cGUgPT09IDE1KSB7DQogICAgICAgIGNvbnN0IHNsb3QgPSBnZXRTbG90Tm9kZShub2RlLmNvZGVnZW5Ob2RlLCAiZGVmYXVsdCIpOw0KICAgICAgICBpZiAoc2xvdCkgew0KICAgICAgICAgIHNsb3RDYWNoZUtleXMucHVzaChjb250ZXh0LmNhY2hlZC5sZW5ndGgpOw0KICAgICAgICAgIHNsb3QucmV0dXJucyA9IGdldENhY2hlRXhwcmVzc2lvbigNCiAgICAgICAgICAgIGNyZWF0ZUFycmF5RXhwcmVzc2lvbihzbG90LnJldHVybnMpDQogICAgICAgICAgKTsNCiAgICAgICAgICBjYWNoZWRBc0FycmF5ID0gdHJ1ZTsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIGlmIChub2RlLnRhZ1R5cGUgPT09IDMgJiYgcGFyZW50ICYmIHBhcmVudC50eXBlID09PSAxICYmIHBhcmVudC50YWdUeXBlID09PSAxICYmIHBhcmVudC5jb2RlZ2VuTm9kZSAmJiBwYXJlbnQuY29kZWdlbk5vZGUudHlwZSA9PT0gMTMgJiYgcGFyZW50LmNvZGVnZW5Ob2RlLmNoaWxkcmVuICYmICFpc0FycmF5KHBhcmVudC5jb2RlZ2VuTm9kZS5jaGlsZHJlbikgJiYgcGFyZW50LmNvZGVnZW5Ob2RlLmNoaWxkcmVuLnR5cGUgPT09IDE1KSB7DQogICAgICAgIGNvbnN0IHNsb3ROYW1lID0gZmluZERpcihub2RlLCAic2xvdCIsIHRydWUpOw0KICAgICAgICBjb25zdCBzbG90ID0gc2xvdE5hbWUgJiYgc2xvdE5hbWUuYXJnICYmIGdldFNsb3ROb2RlKHBhcmVudC5jb2RlZ2VuTm9kZSwgc2xvdE5hbWUuYXJnKTsNCiAgICAgICAgaWYgKHNsb3QpIHsNCiAgICAgICAgICBzbG90Q2FjaGVLZXlzLnB1c2goY29udGV4dC5jYWNoZWQubGVuZ3RoKTsNCiAgICAgICAgICBzbG90LnJldHVybnMgPSBnZXRDYWNoZUV4cHJlc3Npb24oDQogICAgICAgICAgICBjcmVhdGVBcnJheUV4cHJlc3Npb24oc2xvdC5yZXR1cm5zKQ0KICAgICAgICAgICk7DQogICAgICAgICAgY2FjaGVkQXNBcnJheSA9IHRydWU7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogICAgaWYgKCFjYWNoZWRBc0FycmF5KSB7DQogICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRvQ2FjaGUpIHsNCiAgICAgICAgc2xvdENhY2hlS2V5cy5wdXNoKGNvbnRleHQuY2FjaGVkLmxlbmd0aCk7DQogICAgICAgIGNoaWxkLmNvZGVnZW5Ob2RlID0gY29udGV4dC5jYWNoZShjaGlsZC5jb2RlZ2VuTm9kZSk7DQogICAgICB9DQogICAgfQ0KICAgIGlmIChzbG90Q2FjaGVLZXlzLmxlbmd0aCAmJiBub2RlLnR5cGUgPT09IDEgJiYgbm9kZS50YWdUeXBlID09PSAxICYmIG5vZGUuY29kZWdlbk5vZGUgJiYgbm9kZS5jb2RlZ2VuTm9kZS50eXBlID09PSAxMyAmJiBub2RlLmNvZGVnZW5Ob2RlLmNoaWxkcmVuICYmICFpc0FycmF5KG5vZGUuY29kZWdlbk5vZGUuY2hpbGRyZW4pICYmIG5vZGUuY29kZWdlbk5vZGUuY2hpbGRyZW4udHlwZSA9PT0gMTUpIHsNCiAgICAgIG5vZGUuY29kZWdlbk5vZGUuY2hpbGRyZW4ucHJvcGVydGllcy5wdXNoKA0KICAgICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eSgNCiAgICAgICAgICBgX19gLA0KICAgICAgICAgIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oSlNPTi5zdHJpbmdpZnkoc2xvdENhY2hlS2V5cyksIGZhbHNlKQ0KICAgICAgICApDQogICAgICApOw0KICAgIH0NCiAgICBmdW5jdGlvbiBnZXRDYWNoZUV4cHJlc3Npb24odmFsdWUpIHsNCiAgICAgIGNvbnN0IGV4cCA9IGNvbnRleHQuY2FjaGUodmFsdWUpOw0KICAgICAgaWYgKGluRm9yICYmIGNvbnRleHQuaG1yKSB7DQogICAgICAgIGV4cC5uZWVkQXJyYXlTcHJlYWQgPSB0cnVlOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIGV4cDsNCiAgICB9DQogICAgZnVuY3Rpb24gZ2V0U2xvdE5vZGUobm9kZTIsIG5hbWUpIHsNCiAgICAgIGlmIChub2RlMi5jaGlsZHJlbiAmJiAhaXNBcnJheShub2RlMi5jaGlsZHJlbikgJiYgbm9kZTIuY2hpbGRyZW4udHlwZSA9PT0gMTUpIHsNCiAgICAgICAgY29uc3Qgc2xvdCA9IG5vZGUyLmNoaWxkcmVuLnByb3BlcnRpZXMuZmluZCgNCiAgICAgICAgICAocCkgPT4gcC5rZXkgPT09IG5hbWUgfHwgcC5rZXkuY29udGVudCA9PT0gbmFtZQ0KICAgICAgICApOw0KICAgICAgICByZXR1cm4gc2xvdCAmJiBzbG90LnZhbHVlOw0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAodG9DYWNoZS5sZW5ndGggJiYgY29udGV4dC50cmFuc2Zvcm1Ib2lzdCkgew0KICAgICAgY29udGV4dC50cmFuc2Zvcm1Ib2lzdChjaGlsZHJlbiwgY29udGV4dCwgbm9kZSk7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGdldENvbnN0YW50VHlwZShub2RlLCBjb250ZXh0KSB7DQogICAgY29uc3QgeyBjb25zdGFudENhY2hlIH0gPSBjb250ZXh0Ow0KICAgIHN3aXRjaCAobm9kZS50eXBlKSB7DQogICAgICBjYXNlIDE6DQogICAgICAgIGlmIChub2RlLnRhZ1R5cGUgIT09IDApIHsNCiAgICAgICAgICByZXR1cm4gMDsNCiAgICAgICAgfQ0KICAgICAgICBjb25zdCBjYWNoZWQgPSBjb25zdGFudENhY2hlLmdldChub2RlKTsNCiAgICAgICAgaWYgKGNhY2hlZCAhPT0gdm9pZCAwKSB7DQogICAgICAgICAgcmV0dXJuIGNhY2hlZDsNCiAgICAgICAgfQ0KICAgICAgICBjb25zdCBjb2RlZ2VuTm9kZSA9IG5vZGUuY29kZWdlbk5vZGU7DQogICAgICAgIGlmIChjb2RlZ2VuTm9kZS50eXBlICE9PSAxMykgew0KICAgICAgICAgIHJldHVybiAwOw0KICAgICAgICB9DQogICAgICAgIGlmIChjb2RlZ2VuTm9kZS5pc0Jsb2NrICYmIG5vZGUudGFnICE9PSAic3ZnIiAmJiBub2RlLnRhZyAhPT0gImZvcmVpZ25PYmplY3QiICYmIG5vZGUudGFnICE9PSAibWF0aCIpIHsNCiAgICAgICAgICByZXR1cm4gMDsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoY29kZWdlbk5vZGUucGF0Y2hGbGFnID09PSB2b2lkIDApIHsNCiAgICAgICAgICBsZXQgcmV0dXJuVHlwZTIgPSAzOw0KICAgICAgICAgIGNvbnN0IGdlbmVyYXRlZFByb3BzVHlwZSA9IGdldEdlbmVyYXRlZFByb3BzQ29uc3RhbnRUeXBlKG5vZGUsIGNvbnRleHQpOw0KICAgICAgICAgIGlmIChnZW5lcmF0ZWRQcm9wc1R5cGUgPT09IDApIHsNCiAgICAgICAgICAgIGNvbnN0YW50Q2FjaGUuc2V0KG5vZGUsIDApOw0KICAgICAgICAgICAgcmV0dXJuIDA7DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmIChnZW5lcmF0ZWRQcm9wc1R5cGUgPCByZXR1cm5UeXBlMikgew0KICAgICAgICAgICAgcmV0dXJuVHlwZTIgPSBnZW5lcmF0ZWRQcm9wc1R5cGU7DQogICAgICAgICAgfQ0KICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgY29uc3QgY2hpbGRUeXBlID0gZ2V0Q29uc3RhbnRUeXBlKG5vZGUuY2hpbGRyZW5baV0sIGNvbnRleHQpOw0KICAgICAgICAgICAgaWYgKGNoaWxkVHlwZSA9PT0gMCkgew0KICAgICAgICAgICAgICBjb25zdGFudENhY2hlLnNldChub2RlLCAwKTsNCiAgICAgICAgICAgICAgcmV0dXJuIDA7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoY2hpbGRUeXBlIDwgcmV0dXJuVHlwZTIpIHsNCiAgICAgICAgICAgICAgcmV0dXJuVHlwZTIgPSBjaGlsZFR5cGU7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmIChyZXR1cm5UeXBlMiA+IDEpIHsNCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5wcm9wcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICBjb25zdCBwID0gbm9kZS5wcm9wc1tpXTsNCiAgICAgICAgICAgICAgaWYgKHAudHlwZSA9PT0gNyAmJiBwLm5hbWUgPT09ICJiaW5kIiAmJiBwLmV4cCkgew0KICAgICAgICAgICAgICAgIGNvbnN0IGV4cFR5cGUgPSBnZXRDb25zdGFudFR5cGUocC5leHAsIGNvbnRleHQpOw0KICAgICAgICAgICAgICAgIGlmIChleHBUeXBlID09PSAwKSB7DQogICAgICAgICAgICAgICAgICBjb25zdGFudENhY2hlLnNldChub2RlLCAwKTsNCiAgICAgICAgICAgICAgICAgIHJldHVybiAwOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZiAoZXhwVHlwZSA8IHJldHVyblR5cGUyKSB7DQogICAgICAgICAgICAgICAgICByZXR1cm5UeXBlMiA9IGV4cFR5cGU7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmIChjb2RlZ2VuTm9kZS5pc0Jsb2NrKSB7DQogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUucHJvcHMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgY29uc3QgcCA9IG5vZGUucHJvcHNbaV07DQogICAgICAgICAgICAgIGlmIChwLnR5cGUgPT09IDcpIHsNCiAgICAgICAgICAgICAgICBjb25zdGFudENhY2hlLnNldChub2RlLCAwKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gMDsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY29udGV4dC5yZW1vdmVIZWxwZXIoT1BFTl9CTE9DSyk7DQogICAgICAgICAgICBjb250ZXh0LnJlbW92ZUhlbHBlcigNCiAgICAgICAgICAgICAgZ2V0Vk5vZGVCbG9ja0hlbHBlcihjb250ZXh0LmluU1NSLCBjb2RlZ2VuTm9kZS5pc0NvbXBvbmVudCkNCiAgICAgICAgICAgICk7DQogICAgICAgICAgICBjb2RlZ2VuTm9kZS5pc0Jsb2NrID0gZmFsc2U7DQogICAgICAgICAgICBjb250ZXh0LmhlbHBlcihnZXRWTm9kZUhlbHBlcihjb250ZXh0LmluU1NSLCBjb2RlZ2VuTm9kZS5pc0NvbXBvbmVudCkpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjb25zdGFudENhY2hlLnNldChub2RlLCByZXR1cm5UeXBlMik7DQogICAgICAgICAgcmV0dXJuIHJldHVyblR5cGUyOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGNvbnN0YW50Q2FjaGUuc2V0KG5vZGUsIDApOw0KICAgICAgICAgIHJldHVybiAwOw0KICAgICAgICB9DQogICAgICBjYXNlIDI6DQogICAgICBjYXNlIDM6DQogICAgICAgIHJldHVybiAzOw0KICAgICAgY2FzZSA5Og0KICAgICAgY2FzZSAxMToNCiAgICAgIGNhc2UgMTA6DQogICAgICAgIHJldHVybiAwOw0KICAgICAgY2FzZSA1Og0KICAgICAgY2FzZSAxMjoNCiAgICAgICAgcmV0dXJuIGdldENvbnN0YW50VHlwZShub2RlLmNvbnRlbnQsIGNvbnRleHQpOw0KICAgICAgY2FzZSA0Og0KICAgICAgICByZXR1cm4gbm9kZS5jb25zdFR5cGU7DQogICAgICBjYXNlIDg6DQogICAgICAgIGxldCByZXR1cm5UeXBlID0gMzsNCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgY29uc3QgY2hpbGQgPSBub2RlLmNoaWxkcmVuW2ldOw0KICAgICAgICAgIGlmIChpc1N0cmluZyhjaGlsZCkgfHwgaXNTeW1ib2woY2hpbGQpKSB7DQogICAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgICB9DQogICAgICAgICAgY29uc3QgY2hpbGRUeXBlID0gZ2V0Q29uc3RhbnRUeXBlKGNoaWxkLCBjb250ZXh0KTsNCiAgICAgICAgICBpZiAoY2hpbGRUeXBlID09PSAwKSB7DQogICAgICAgICAgICByZXR1cm4gMDsNCiAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkVHlwZSA8IHJldHVyblR5cGUpIHsNCiAgICAgICAgICAgIHJldHVyblR5cGUgPSBjaGlsZFR5cGU7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiByZXR1cm5UeXBlOw0KICAgICAgY2FzZSAyMDoNCiAgICAgICAgcmV0dXJuIDI7DQogICAgICBkZWZhdWx0Og0KICAgICAgICByZXR1cm4gMDsNCiAgICB9DQogIH0NCiAgY29uc3QgYWxsb3dIb2lzdGVkSGVscGVyU2V0ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWw0KICAgIE5PUk1BTElaRV9DTEFTUywNCiAgICBOT1JNQUxJWkVfU1RZTEUsDQogICAgTk9STUFMSVpFX1BST1BTLA0KICAgIEdVQVJEX1JFQUNUSVZFX1BST1BTDQogIF0pOw0KICBmdW5jdGlvbiBnZXRDb25zdGFudFR5cGVPZkhlbHBlckNhbGwodmFsdWUsIGNvbnRleHQpIHsNCiAgICBpZiAodmFsdWUudHlwZSA9PT0gMTQgJiYgIWlzU3RyaW5nKHZhbHVlLmNhbGxlZSkgJiYgYWxsb3dIb2lzdGVkSGVscGVyU2V0Lmhhcyh2YWx1ZS5jYWxsZWUpKSB7DQogICAgICBjb25zdCBhcmcgPSB2YWx1ZS5hcmd1bWVudHNbMF07DQogICAgICBpZiAoYXJnLnR5cGUgPT09IDQpIHsNCiAgICAgICAgcmV0dXJuIGdldENvbnN0YW50VHlwZShhcmcsIGNvbnRleHQpOw0KICAgICAgfSBlbHNlIGlmIChhcmcudHlwZSA9PT0gMTQpIHsNCiAgICAgICAgcmV0dXJuIGdldENvbnN0YW50VHlwZU9mSGVscGVyQ2FsbChhcmcsIGNvbnRleHQpOw0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gMDsNCiAgfQ0KICBmdW5jdGlvbiBnZXRHZW5lcmF0ZWRQcm9wc0NvbnN0YW50VHlwZShub2RlLCBjb250ZXh0KSB7DQogICAgbGV0IHJldHVyblR5cGUgPSAzOw0KICAgIGNvbnN0IHByb3BzID0gZ2V0Tm9kZVByb3BzKG5vZGUpOw0KICAgIGlmIChwcm9wcyAmJiBwcm9wcy50eXBlID09PSAxNSkgew0KICAgICAgY29uc3QgeyBwcm9wZXJ0aWVzIH0gPSBwcm9wczsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcGVydGllcy5sZW5ndGg7IGkrKykgew0KICAgICAgICBjb25zdCB7IGtleSwgdmFsdWUgfSA9IHByb3BlcnRpZXNbaV07DQogICAgICAgIGNvbnN0IGtleVR5cGUgPSBnZXRDb25zdGFudFR5cGUoa2V5LCBjb250ZXh0KTsNCiAgICAgICAgaWYgKGtleVR5cGUgPT09IDApIHsNCiAgICAgICAgICByZXR1cm4ga2V5VHlwZTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoa2V5VHlwZSA8IHJldHVyblR5cGUpIHsNCiAgICAgICAgICByZXR1cm5UeXBlID0ga2V5VHlwZTsNCiAgICAgICAgfQ0KICAgICAgICBsZXQgdmFsdWVUeXBlOw0KICAgICAgICBpZiAodmFsdWUudHlwZSA9PT0gNCkgew0KICAgICAgICAgIHZhbHVlVHlwZSA9IGdldENvbnN0YW50VHlwZSh2YWx1ZSwgY29udGV4dCk7DQogICAgICAgIH0gZWxzZSBpZiAodmFsdWUudHlwZSA9PT0gMTQpIHsNCiAgICAgICAgICB2YWx1ZVR5cGUgPSBnZXRDb25zdGFudFR5cGVPZkhlbHBlckNhbGwodmFsdWUsIGNvbnRleHQpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHZhbHVlVHlwZSA9IDA7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHZhbHVlVHlwZSA9PT0gMCkgew0KICAgICAgICAgIHJldHVybiB2YWx1ZVR5cGU7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHZhbHVlVHlwZSA8IHJldHVyblR5cGUpIHsNCiAgICAgICAgICByZXR1cm5UeXBlID0gdmFsdWVUeXBlOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiByZXR1cm5UeXBlOw0KICB9DQogIGZ1bmN0aW9uIGdldE5vZGVQcm9wcyhub2RlKSB7DQogICAgY29uc3QgY29kZWdlbk5vZGUgPSBub2RlLmNvZGVnZW5Ob2RlOw0KICAgIGlmIChjb2RlZ2VuTm9kZS50eXBlID09PSAxMykgew0KICAgICAgcmV0dXJuIGNvZGVnZW5Ob2RlLnByb3BzOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIGNyZWF0ZVRyYW5zZm9ybUNvbnRleHQocm9vdCwgew0KICAgIGZpbGVuYW1lID0gIiIsDQogICAgcHJlZml4SWRlbnRpZmllcnMgPSBmYWxzZSwNCiAgICBob2lzdFN0YXRpYyA9IGZhbHNlLA0KICAgIGhtciA9IGZhbHNlLA0KICAgIGNhY2hlSGFuZGxlcnMgPSBmYWxzZSwNCiAgICBub2RlVHJhbnNmb3JtcyA9IFtdLA0KICAgIGRpcmVjdGl2ZVRyYW5zZm9ybXMgPSB7fSwNCiAgICB0cmFuc2Zvcm1Ib2lzdCA9IG51bGwsDQogICAgaXNCdWlsdEluQ29tcG9uZW50ID0gTk9PUCwNCiAgICBpc0N1c3RvbUVsZW1lbnQgPSBOT09QLA0KICAgIGV4cHJlc3Npb25QbHVnaW5zID0gW10sDQogICAgc2NvcGVJZCA9IG51bGwsDQogICAgc2xvdHRlZCA9IHRydWUsDQogICAgc3NyID0gZmFsc2UsDQogICAgaW5TU1IgPSBmYWxzZSwNCiAgICBzc3JDc3NWYXJzID0gYGAsDQogICAgYmluZGluZ01ldGFkYXRhID0gRU1QVFlfT0JKLA0KICAgIGlubGluZSA9IGZhbHNlLA0KICAgIGlzVFMgPSBmYWxzZSwNCiAgICBvbkVycm9yID0gZGVmYXVsdE9uRXJyb3IsDQogICAgb25XYXJuID0gZGVmYXVsdE9uV2FybiwNCiAgICBjb21wYXRDb25maWcNCiAgfSkgew0KICAgIGNvbnN0IG5hbWVNYXRjaCA9IGZpbGVuYW1lLnJlcGxhY2UoL1w/LiokLywgIiIpLm1hdGNoKC8oW14vXFxdKylcLlx3KyQvKTsNCiAgICBjb25zdCBjb250ZXh0ID0gew0KICAgICAgLy8gb3B0aW9ucw0KICAgICAgZmlsZW5hbWUsDQogICAgICBzZWxmTmFtZTogbmFtZU1hdGNoICYmIGNhcGl0YWxpemUoY2FtZWxpemUobmFtZU1hdGNoWzFdKSksDQogICAgICBwcmVmaXhJZGVudGlmaWVycywNCiAgICAgIGhvaXN0U3RhdGljLA0KICAgICAgaG1yLA0KICAgICAgY2FjaGVIYW5kbGVycywNCiAgICAgIG5vZGVUcmFuc2Zvcm1zLA0KICAgICAgZGlyZWN0aXZlVHJhbnNmb3JtcywNCiAgICAgIHRyYW5zZm9ybUhvaXN0LA0KICAgICAgaXNCdWlsdEluQ29tcG9uZW50LA0KICAgICAgaXNDdXN0b21FbGVtZW50LA0KICAgICAgZXhwcmVzc2lvblBsdWdpbnMsDQogICAgICBzY29wZUlkLA0KICAgICAgc2xvdHRlZCwNCiAgICAgIHNzciwNCiAgICAgIGluU1NSLA0KICAgICAgc3NyQ3NzVmFycywNCiAgICAgIGJpbmRpbmdNZXRhZGF0YSwNCiAgICAgIGlubGluZSwNCiAgICAgIGlzVFMsDQogICAgICBvbkVycm9yLA0KICAgICAgb25XYXJuLA0KICAgICAgY29tcGF0Q29uZmlnLA0KICAgICAgLy8gc3RhdGUNCiAgICAgIHJvb3QsDQogICAgICBoZWxwZXJzOiAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLA0KICAgICAgY29tcG9uZW50czogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwNCiAgICAgIGRpcmVjdGl2ZXM6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksDQogICAgICBob2lzdHM6IFtdLA0KICAgICAgaW1wb3J0czogW10sDQogICAgICBjYWNoZWQ6IFtdLA0KICAgICAgY29uc3RhbnRDYWNoZTogLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCksDQogICAgICB0ZW1wczogMCwNCiAgICAgIGlkZW50aWZpZXJzOiAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKSwNCiAgICAgIHNjb3Blczogew0KICAgICAgICB2Rm9yOiAwLA0KICAgICAgICB2U2xvdDogMCwNCiAgICAgICAgdlByZTogMCwNCiAgICAgICAgdk9uY2U6IDANCiAgICAgIH0sDQogICAgICBwYXJlbnQ6IG51bGwsDQogICAgICBncmFuZFBhcmVudDogbnVsbCwNCiAgICAgIGN1cnJlbnROb2RlOiByb290LA0KICAgICAgY2hpbGRJbmRleDogMCwNCiAgICAgIGluVk9uY2U6IGZhbHNlLA0KICAgICAgLy8gbWV0aG9kcw0KICAgICAgaGVscGVyKG5hbWUpIHsNCiAgICAgICAgY29uc3QgY291bnQgPSBjb250ZXh0LmhlbHBlcnMuZ2V0KG5hbWUpIHx8IDA7DQogICAgICAgIGNvbnRleHQuaGVscGVycy5zZXQobmFtZSwgY291bnQgKyAxKTsNCiAgICAgICAgcmV0dXJuIG5hbWU7DQogICAgICB9LA0KICAgICAgcmVtb3ZlSGVscGVyKG5hbWUpIHsNCiAgICAgICAgY29uc3QgY291bnQgPSBjb250ZXh0LmhlbHBlcnMuZ2V0KG5hbWUpOw0KICAgICAgICBpZiAoY291bnQpIHsNCiAgICAgICAgICBjb25zdCBjdXJyZW50Q291bnQgPSBjb3VudCAtIDE7DQogICAgICAgICAgaWYgKCFjdXJyZW50Q291bnQpIHsNCiAgICAgICAgICAgIGNvbnRleHQuaGVscGVycy5kZWxldGUobmFtZSk7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGNvbnRleHQuaGVscGVycy5zZXQobmFtZSwgY3VycmVudENvdW50KTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0sDQogICAgICBoZWxwZXJTdHJpbmcobmFtZSkgew0KICAgICAgICByZXR1cm4gYF8ke2hlbHBlck5hbWVNYXBbY29udGV4dC5oZWxwZXIobmFtZSldfWA7DQogICAgICB9LA0KICAgICAgcmVwbGFjZU5vZGUobm9kZSkgew0KICAgICAgICB7DQogICAgICAgICAgaWYgKCFjb250ZXh0LmN1cnJlbnROb2RlKSB7DQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vZGUgYmVpbmcgcmVwbGFjZWQgaXMgYWxyZWFkeSByZW1vdmVkLmApOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpZiAoIWNvbnRleHQucGFyZW50KSB7DQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCByZXBsYWNlIHJvb3Qgbm9kZS5gKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgY29udGV4dC5wYXJlbnQuY2hpbGRyZW5bY29udGV4dC5jaGlsZEluZGV4XSA9IGNvbnRleHQuY3VycmVudE5vZGUgPSBub2RlOw0KICAgICAgfSwNCiAgICAgIHJlbW92ZU5vZGUobm9kZSkgew0KICAgICAgICBpZiAoIWNvbnRleHQucGFyZW50KSB7DQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcmVtb3ZlIHJvb3Qgbm9kZS5gKTsNCiAgICAgICAgfQ0KICAgICAgICBjb25zdCBsaXN0ID0gY29udGV4dC5wYXJlbnQuY2hpbGRyZW47DQogICAgICAgIGNvbnN0IHJlbW92YWxJbmRleCA9IG5vZGUgPyBsaXN0LmluZGV4T2Yobm9kZSkgOiBjb250ZXh0LmN1cnJlbnROb2RlID8gY29udGV4dC5jaGlsZEluZGV4IDogLTE7DQogICAgICAgIGlmIChyZW1vdmFsSW5kZXggPCAwKSB7DQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBub2RlIGJlaW5nIHJlbW92ZWQgaXMgbm90IGEgY2hpbGQgb2YgY3VycmVudCBwYXJlbnRgKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIW5vZGUgfHwgbm9kZSA9PT0gY29udGV4dC5jdXJyZW50Tm9kZSkgew0KICAgICAgICAgIGNvbnRleHQuY3VycmVudE5vZGUgPSBudWxsOw0KICAgICAgICAgIGNvbnRleHQub25Ob2RlUmVtb3ZlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGlmIChjb250ZXh0LmNoaWxkSW5kZXggPiByZW1vdmFsSW5kZXgpIHsNCiAgICAgICAgICAgIGNvbnRleHQuY2hpbGRJbmRleC0tOw0KICAgICAgICAgICAgY29udGV4dC5vbk5vZGVSZW1vdmVkKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGNvbnRleHQucGFyZW50LmNoaWxkcmVuLnNwbGljZShyZW1vdmFsSW5kZXgsIDEpOw0KICAgICAgfSwNCiAgICAgIG9uTm9kZVJlbW92ZWQ6IE5PT1AsDQogICAgICBhZGRJZGVudGlmaWVycyhleHApIHsNCiAgICAgIH0sDQogICAgICByZW1vdmVJZGVudGlmaWVycyhleHApIHsNCiAgICAgIH0sDQogICAgICBob2lzdChleHApIHsNCiAgICAgICAgaWYgKGlzU3RyaW5nKGV4cCkpIGV4cCA9IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oZXhwKTsNCiAgICAgICAgY29udGV4dC5ob2lzdHMucHVzaChleHApOw0KICAgICAgICBjb25zdCBpZGVudGlmaWVyID0gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbigNCiAgICAgICAgICBgX2hvaXN0ZWRfJHtjb250ZXh0LmhvaXN0cy5sZW5ndGh9YCwNCiAgICAgICAgICBmYWxzZSwNCiAgICAgICAgICBleHAubG9jLA0KICAgICAgICAgIDINCiAgICAgICAgKTsNCiAgICAgICAgaWRlbnRpZmllci5ob2lzdGVkID0gZXhwOw0KICAgICAgICByZXR1cm4gaWRlbnRpZmllcjsNCiAgICAgIH0sDQogICAgICBjYWNoZShleHAsIGlzVk5vZGUgPSBmYWxzZSwgaW5WT25jZSA9IGZhbHNlKSB7DQogICAgICAgIGNvbnN0IGNhY2hlRXhwID0gY3JlYXRlQ2FjaGVFeHByZXNzaW9uKA0KICAgICAgICAgIGNvbnRleHQuY2FjaGVkLmxlbmd0aCwNCiAgICAgICAgICBleHAsDQogICAgICAgICAgaXNWTm9kZSwNCiAgICAgICAgICBpblZPbmNlDQogICAgICAgICk7DQogICAgICAgIGNvbnRleHQuY2FjaGVkLnB1c2goY2FjaGVFeHApOw0KICAgICAgICByZXR1cm4gY2FjaGVFeHA7DQogICAgICB9DQogICAgfTsNCiAgICByZXR1cm4gY29udGV4dDsNCiAgfQ0KICBmdW5jdGlvbiB0cmFuc2Zvcm0ocm9vdCwgb3B0aW9ucykgew0KICAgIGNvbnN0IGNvbnRleHQgPSBjcmVhdGVUcmFuc2Zvcm1Db250ZXh0KHJvb3QsIG9wdGlvbnMpOw0KICAgIHRyYXZlcnNlTm9kZShyb290LCBjb250ZXh0KTsNCiAgICBpZiAob3B0aW9ucy5ob2lzdFN0YXRpYykgew0KICAgICAgY2FjaGVTdGF0aWMocm9vdCwgY29udGV4dCk7DQogICAgfQ0KICAgIGlmICghb3B0aW9ucy5zc3IpIHsNCiAgICAgIGNyZWF0ZVJvb3RDb2RlZ2VuKHJvb3QsIGNvbnRleHQpOw0KICAgIH0NCiAgICByb290LmhlbHBlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbLi4uY29udGV4dC5oZWxwZXJzLmtleXMoKV0pOw0KICAgIHJvb3QuY29tcG9uZW50cyA9IFsuLi5jb250ZXh0LmNvbXBvbmVudHNdOw0KICAgIHJvb3QuZGlyZWN0aXZlcyA9IFsuLi5jb250ZXh0LmRpcmVjdGl2ZXNdOw0KICAgIHJvb3QuaW1wb3J0cyA9IGNvbnRleHQuaW1wb3J0czsNCiAgICByb290LmhvaXN0cyA9IGNvbnRleHQuaG9pc3RzOw0KICAgIHJvb3QudGVtcHMgPSBjb250ZXh0LnRlbXBzOw0KICAgIHJvb3QuY2FjaGVkID0gY29udGV4dC5jYWNoZWQ7DQogICAgcm9vdC50cmFuc2Zvcm1lZCA9IHRydWU7DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlUm9vdENvZGVnZW4ocm9vdCwgY29udGV4dCkgew0KICAgIGNvbnN0IHsgaGVscGVyIH0gPSBjb250ZXh0Ow0KICAgIGNvbnN0IHsgY2hpbGRyZW4gfSA9IHJvb3Q7DQogICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA9PT0gMSkgew0KICAgICAgY29uc3Qgc2luZ2xlRWxlbWVudFJvb3RDaGlsZCA9IGdldFNpbmdsZUVsZW1lbnRSb290KHJvb3QpOw0KICAgICAgaWYgKHNpbmdsZUVsZW1lbnRSb290Q2hpbGQgJiYgc2luZ2xlRWxlbWVudFJvb3RDaGlsZC5jb2RlZ2VuTm9kZSkgew0KICAgICAgICBjb25zdCBjb2RlZ2VuTm9kZSA9IHNpbmdsZUVsZW1lbnRSb290Q2hpbGQuY29kZWdlbk5vZGU7DQogICAgICAgIGlmIChjb2RlZ2VuTm9kZS50eXBlID09PSAxMykgew0KICAgICAgICAgIGNvbnZlcnRUb0Jsb2NrKGNvZGVnZW5Ob2RlLCBjb250ZXh0KTsNCiAgICAgICAgfQ0KICAgICAgICByb290LmNvZGVnZW5Ob2RlID0gY29kZWdlbk5vZGU7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByb290LmNvZGVnZW5Ob2RlID0gY2hpbGRyZW5bMF07DQogICAgICB9DQogICAgfSBlbHNlIGlmIChjaGlsZHJlbi5sZW5ndGggPiAxKSB7DQogICAgICBsZXQgcGF0Y2hGbGFnID0gNjQ7DQogICAgICBpZiAoY2hpbGRyZW4uZmlsdGVyKChjKSA9PiBjLnR5cGUgIT09IDMpLmxlbmd0aCA9PT0gMSkgew0KICAgICAgICBwYXRjaEZsYWcgfD0gMjA0ODsNCiAgICAgIH0NCiAgICAgIHJvb3QuY29kZWdlbk5vZGUgPSBjcmVhdGVWTm9kZUNhbGwoDQogICAgICAgIGNvbnRleHQsDQogICAgICAgIGhlbHBlcihGUkFHTUVOVCksDQogICAgICAgIHZvaWQgMCwNCiAgICAgICAgcm9vdC5jaGlsZHJlbiwNCiAgICAgICAgcGF0Y2hGbGFnLA0KICAgICAgICB2b2lkIDAsDQogICAgICAgIHZvaWQgMCwNCiAgICAgICAgdHJ1ZSwNCiAgICAgICAgdm9pZCAwLA0KICAgICAgICBmYWxzZQ0KICAgICAgKTsNCiAgICB9IGVsc2UgOw0KICB9DQogIGZ1bmN0aW9uIHRyYXZlcnNlQ2hpbGRyZW4ocGFyZW50LCBjb250ZXh0KSB7DQogICAgbGV0IGkgPSAwOw0KICAgIGNvbnN0IG5vZGVSZW1vdmVkID0gKCkgPT4gew0KICAgICAgaS0tOw0KICAgIH07DQogICAgZm9yICg7IGkgPCBwYXJlbnQuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsNCiAgICAgIGNvbnN0IGNoaWxkID0gcGFyZW50LmNoaWxkcmVuW2ldOw0KICAgICAgaWYgKGlzU3RyaW5nKGNoaWxkKSkgY29udGludWU7DQogICAgICBjb250ZXh0LmdyYW5kUGFyZW50ID0gY29udGV4dC5wYXJlbnQ7DQogICAgICBjb250ZXh0LnBhcmVudCA9IHBhcmVudDsNCiAgICAgIGNvbnRleHQuY2hpbGRJbmRleCA9IGk7DQogICAgICBjb250ZXh0Lm9uTm9kZVJlbW92ZWQgPSBub2RlUmVtb3ZlZDsNCiAgICAgIHRyYXZlcnNlTm9kZShjaGlsZCwgY29udGV4dCk7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIHRyYXZlcnNlTm9kZShub2RlLCBjb250ZXh0KSB7DQogICAgY29udGV4dC5jdXJyZW50Tm9kZSA9IG5vZGU7DQogICAgY29uc3QgeyBub2RlVHJhbnNmb3JtcyB9ID0gY29udGV4dDsNCiAgICBjb25zdCBleGl0Rm5zID0gW107DQogICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IG5vZGVUcmFuc2Zvcm1zLmxlbmd0aDsgaTIrKykgew0KICAgICAgY29uc3Qgb25FeGl0ID0gbm9kZVRyYW5zZm9ybXNbaTJdKG5vZGUsIGNvbnRleHQpOw0KICAgICAgaWYgKG9uRXhpdCkgew0KICAgICAgICBpZiAoaXNBcnJheShvbkV4aXQpKSB7DQogICAgICAgICAgZXhpdEZucy5wdXNoKC4uLm9uRXhpdCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgZXhpdEZucy5wdXNoKG9uRXhpdCk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmICghY29udGV4dC5jdXJyZW50Tm9kZSkgew0KICAgICAgICByZXR1cm47DQogICAgICB9IGVsc2Ugew0KICAgICAgICBub2RlID0gY29udGV4dC5jdXJyZW50Tm9kZTsNCiAgICAgIH0NCiAgICB9DQogICAgc3dpdGNoIChub2RlLnR5cGUpIHsNCiAgICAgIGNhc2UgMzoNCiAgICAgICAgaWYgKCFjb250ZXh0LnNzcikgew0KICAgICAgICAgIGNvbnRleHQuaGVscGVyKENSRUFURV9DT01NRU5UKTsNCiAgICAgICAgfQ0KICAgICAgICBicmVhazsNCiAgICAgIGNhc2UgNToNCiAgICAgICAgaWYgKCFjb250ZXh0LnNzcikgew0KICAgICAgICAgIGNvbnRleHQuaGVscGVyKFRPX0RJU1BMQVlfU1RSSU5HKTsNCiAgICAgICAgfQ0KICAgICAgICBicmVhazsNCiAgICAgIC8vIGZvciBjb250YWluZXIgdHlwZXMsIGZ1cnRoZXIgdHJhdmVyc2UgZG93bndhcmRzDQogICAgICBjYXNlIDk6DQogICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBub2RlLmJyYW5jaGVzLmxlbmd0aDsgaTIrKykgew0KICAgICAgICAgIHRyYXZlcnNlTm9kZShub2RlLmJyYW5jaGVzW2kyXSwgY29udGV4dCk7DQogICAgICAgIH0NCiAgICAgICAgYnJlYWs7DQogICAgICBjYXNlIDEwOg0KICAgICAgY2FzZSAxMToNCiAgICAgIGNhc2UgMToNCiAgICAgIGNhc2UgMDoNCiAgICAgICAgdHJhdmVyc2VDaGlsZHJlbihub2RlLCBjb250ZXh0KTsNCiAgICAgICAgYnJlYWs7DQogICAgfQ0KICAgIGNvbnRleHQuY3VycmVudE5vZGUgPSBub2RlOw0KICAgIGxldCBpID0gZXhpdEZucy5sZW5ndGg7DQogICAgd2hpbGUgKGktLSkgew0KICAgICAgZXhpdEZuc1tpXSgpOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBjcmVhdGVTdHJ1Y3R1cmFsRGlyZWN0aXZlVHJhbnNmb3JtKG5hbWUsIGZuKSB7DQogICAgY29uc3QgbWF0Y2hlcyA9IGlzU3RyaW5nKG5hbWUpID8gKG4pID0+IG4gPT09IG5hbWUgOiAobikgPT4gbmFtZS50ZXN0KG4pOw0KICAgIHJldHVybiAobm9kZSwgY29udGV4dCkgPT4gew0KICAgICAgaWYgKG5vZGUudHlwZSA9PT0gMSkgew0KICAgICAgICBjb25zdCB7IHByb3BzIH0gPSBub2RlOw0KICAgICAgICBpZiAobm9kZS50YWdUeXBlID09PSAzICYmIHByb3BzLnNvbWUoaXNWU2xvdCkpIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgY29uc3QgZXhpdEZucyA9IFtdOw0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgY29uc3QgcHJvcCA9IHByb3BzW2ldOw0KICAgICAgICAgIGlmIChwcm9wLnR5cGUgPT09IDcgJiYgbWF0Y2hlcyhwcm9wLm5hbWUpKSB7DQogICAgICAgICAgICBwcm9wcy5zcGxpY2UoaSwgMSk7DQogICAgICAgICAgICBpLS07DQogICAgICAgICAgICBjb25zdCBvbkV4aXQgPSBmbihub2RlLCBwcm9wLCBjb250ZXh0KTsNCiAgICAgICAgICAgIGlmIChvbkV4aXQpIGV4aXRGbnMucHVzaChvbkV4aXQpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZXhpdEZuczsNCiAgICAgIH0NCiAgICB9Ow0KICB9DQoNCiAgY29uc3QgUFVSRV9BTk5PVEFUSU9OID0gYC8qQF9fUFVSRV9fKi9gOw0KICBjb25zdCBhbGlhc0hlbHBlciA9IChzKSA9PiBgJHtoZWxwZXJOYW1lTWFwW3NdfTogXyR7aGVscGVyTmFtZU1hcFtzXX1gOw0KICBmdW5jdGlvbiBjcmVhdGVDb2RlZ2VuQ29udGV4dChhc3QsIHsNCiAgICBtb2RlID0gImZ1bmN0aW9uIiwNCiAgICBwcmVmaXhJZGVudGlmaWVycyA9IG1vZGUgPT09ICJtb2R1bGUiLA0KICAgIHNvdXJjZU1hcCA9IGZhbHNlLA0KICAgIGZpbGVuYW1lID0gYHRlbXBsYXRlLnZ1ZS5odG1sYCwNCiAgICBzY29wZUlkID0gbnVsbCwNCiAgICBvcHRpbWl6ZUltcG9ydHMgPSBmYWxzZSwNCiAgICBydW50aW1lR2xvYmFsTmFtZSA9IGBWdWVgLA0KICAgIHJ1bnRpbWVNb2R1bGVOYW1lID0gYHZ1ZWAsDQogICAgc3NyUnVudGltZU1vZHVsZU5hbWUgPSAidnVlL3NlcnZlci1yZW5kZXJlciIsDQogICAgc3NyID0gZmFsc2UsDQogICAgaXNUUyA9IGZhbHNlLA0KICAgIGluU1NSID0gZmFsc2UNCiAgfSkgew0KICAgIGNvbnN0IGNvbnRleHQgPSB7DQogICAgICBtb2RlLA0KICAgICAgcHJlZml4SWRlbnRpZmllcnMsDQogICAgICBzb3VyY2VNYXAsDQogICAgICBmaWxlbmFtZSwNCiAgICAgIHNjb3BlSWQsDQogICAgICBvcHRpbWl6ZUltcG9ydHMsDQogICAgICBydW50aW1lR2xvYmFsTmFtZSwNCiAgICAgIHJ1bnRpbWVNb2R1bGVOYW1lLA0KICAgICAgc3NyUnVudGltZU1vZHVsZU5hbWUsDQogICAgICBzc3IsDQogICAgICBpc1RTLA0KICAgICAgaW5TU1IsDQogICAgICBzb3VyY2U6IGFzdC5zb3VyY2UsDQogICAgICBjb2RlOiBgYCwNCiAgICAgIGNvbHVtbjogMSwNCiAgICAgIGxpbmU6IDEsDQogICAgICBvZmZzZXQ6IDAsDQogICAgICBpbmRlbnRMZXZlbDogMCwNCiAgICAgIHB1cmU6IGZhbHNlLA0KICAgICAgbWFwOiB2b2lkIDAsDQogICAgICBoZWxwZXIoa2V5KSB7DQogICAgICAgIHJldHVybiBgXyR7aGVscGVyTmFtZU1hcFtrZXldfWA7DQogICAgICB9LA0KICAgICAgcHVzaChjb2RlLCBuZXdsaW5lSW5kZXggPSAtMiAvKiBOb25lICovLCBub2RlKSB7DQogICAgICAgIGNvbnRleHQuY29kZSArPSBjb2RlOw0KICAgICAgfSwNCiAgICAgIGluZGVudCgpIHsNCiAgICAgICAgbmV3bGluZSgrK2NvbnRleHQuaW5kZW50TGV2ZWwpOw0KICAgICAgfSwNCiAgICAgIGRlaW5kZW50KHdpdGhvdXROZXdMaW5lID0gZmFsc2UpIHsNCiAgICAgICAgaWYgKHdpdGhvdXROZXdMaW5lKSB7DQogICAgICAgICAgLS1jb250ZXh0LmluZGVudExldmVsOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIG5ld2xpbmUoLS1jb250ZXh0LmluZGVudExldmVsKTsNCiAgICAgICAgfQ0KICAgICAgfSwNCiAgICAgIG5ld2xpbmUoKSB7DQogICAgICAgIG5ld2xpbmUoY29udGV4dC5pbmRlbnRMZXZlbCk7DQogICAgICB9DQogICAgfTsNCiAgICBmdW5jdGlvbiBuZXdsaW5lKG4pIHsNCiAgICAgIGNvbnRleHQucHVzaCgiXG4iICsgYCAgYC5yZXBlYXQobiksIDAgLyogU3RhcnQgKi8pOw0KICAgIH0NCiAgICByZXR1cm4gY29udGV4dDsNCiAgfQ0KICBmdW5jdGlvbiBnZW5lcmF0ZShhc3QsIG9wdGlvbnMgPSB7fSkgew0KICAgIGNvbnN0IGNvbnRleHQgPSBjcmVhdGVDb2RlZ2VuQ29udGV4dChhc3QsIG9wdGlvbnMpOw0KICAgIGlmIChvcHRpb25zLm9uQ29udGV4dENyZWF0ZWQpIG9wdGlvbnMub25Db250ZXh0Q3JlYXRlZChjb250ZXh0KTsNCiAgICBjb25zdCB7DQogICAgICBtb2RlLA0KICAgICAgcHVzaCwNCiAgICAgIHByZWZpeElkZW50aWZpZXJzLA0KICAgICAgaW5kZW50LA0KICAgICAgZGVpbmRlbnQsDQogICAgICBuZXdsaW5lLA0KICAgICAgc2NvcGVJZCwNCiAgICAgIHNzcg0KICAgIH0gPSBjb250ZXh0Ow0KICAgIGNvbnN0IGhlbHBlcnMgPSBBcnJheS5mcm9tKGFzdC5oZWxwZXJzKTsNCiAgICBjb25zdCBoYXNIZWxwZXJzID0gaGVscGVycy5sZW5ndGggPiAwOw0KICAgIGNvbnN0IHVzZVdpdGhCbG9jayA9ICFwcmVmaXhJZGVudGlmaWVycyAmJiBtb2RlICE9PSAibW9kdWxlIjsNCiAgICBjb25zdCBwcmVhbWJsZUNvbnRleHQgPSBjb250ZXh0Ow0KICAgIHsNCiAgICAgIGdlbkZ1bmN0aW9uUHJlYW1ibGUoYXN0LCBwcmVhbWJsZUNvbnRleHQpOw0KICAgIH0NCiAgICBjb25zdCBmdW5jdGlvbk5hbWUgPSBzc3IgPyBgc3NyUmVuZGVyYCA6IGByZW5kZXJgOw0KICAgIGNvbnN0IGFyZ3MgPSBzc3IgPyBbIl9jdHgiLCAiX3B1c2giLCAiX3BhcmVudCIsICJfYXR0cnMiXSA6IFsiX2N0eCIsICJfY2FjaGUiXTsNCiAgICBjb25zdCBzaWduYXR1cmUgPSBhcmdzLmpvaW4oIiwgIik7DQogICAgew0KICAgICAgcHVzaChgZnVuY3Rpb24gJHtmdW5jdGlvbk5hbWV9KCR7c2lnbmF0dXJlfSkge2ApOw0KICAgIH0NCiAgICBpbmRlbnQoKTsNCiAgICBpZiAodXNlV2l0aEJsb2NrKSB7DQogICAgICBwdXNoKGB3aXRoIChfY3R4KSB7YCk7DQogICAgICBpbmRlbnQoKTsNCiAgICAgIGlmIChoYXNIZWxwZXJzKSB7DQogICAgICAgIHB1c2goDQogICAgICAgICAgYGNvbnN0IHsgJHtoZWxwZXJzLm1hcChhbGlhc0hlbHBlcikuam9pbigiLCAiKX0gfSA9IF9WdWUNCmAsDQogICAgICAgICAgLTEgLyogRW5kICovDQogICAgICAgICk7DQogICAgICAgIG5ld2xpbmUoKTsNCiAgICAgIH0NCiAgICB9DQogICAgaWYgKGFzdC5jb21wb25lbnRzLmxlbmd0aCkgew0KICAgICAgZ2VuQXNzZXRzKGFzdC5jb21wb25lbnRzLCAiY29tcG9uZW50IiwgY29udGV4dCk7DQogICAgICBpZiAoYXN0LmRpcmVjdGl2ZXMubGVuZ3RoIHx8IGFzdC50ZW1wcyA+IDApIHsNCiAgICAgICAgbmV3bGluZSgpOw0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAoYXN0LmRpcmVjdGl2ZXMubGVuZ3RoKSB7DQogICAgICBnZW5Bc3NldHMoYXN0LmRpcmVjdGl2ZXMsICJkaXJlY3RpdmUiLCBjb250ZXh0KTsNCiAgICAgIGlmIChhc3QudGVtcHMgPiAwKSB7DQogICAgICAgIG5ld2xpbmUoKTsNCiAgICAgIH0NCiAgICB9DQogICAgaWYgKGFzdC50ZW1wcyA+IDApIHsNCiAgICAgIHB1c2goYGxldCBgKTsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXN0LnRlbXBzOyBpKyspIHsNCiAgICAgICAgcHVzaChgJHtpID4gMCA/IGAsIGAgOiBgYH1fdGVtcCR7aX1gKTsNCiAgICAgIH0NCiAgICB9DQogICAgaWYgKGFzdC5jb21wb25lbnRzLmxlbmd0aCB8fCBhc3QuZGlyZWN0aXZlcy5sZW5ndGggfHwgYXN0LnRlbXBzKSB7DQogICAgICBwdXNoKGANCmAsIDAgLyogU3RhcnQgKi8pOw0KICAgICAgbmV3bGluZSgpOw0KICAgIH0NCiAgICBpZiAoIXNzcikgew0KICAgICAgcHVzaChgcmV0dXJuIGApOw0KICAgIH0NCiAgICBpZiAoYXN0LmNvZGVnZW5Ob2RlKSB7DQogICAgICBnZW5Ob2RlKGFzdC5jb2RlZ2VuTm9kZSwgY29udGV4dCk7DQogICAgfSBlbHNlIHsNCiAgICAgIHB1c2goYG51bGxgKTsNCiAgICB9DQogICAgaWYgKHVzZVdpdGhCbG9jaykgew0KICAgICAgZGVpbmRlbnQoKTsNCiAgICAgIHB1c2goYH1gKTsNCiAgICB9DQogICAgZGVpbmRlbnQoKTsNCiAgICBwdXNoKGB9YCk7DQogICAgcmV0dXJuIHsNCiAgICAgIGFzdCwNCiAgICAgIGNvZGU6IGNvbnRleHQuY29kZSwNCiAgICAgIHByZWFtYmxlOiBgYCwNCiAgICAgIG1hcDogY29udGV4dC5tYXAgPyBjb250ZXh0Lm1hcC50b0pTT04oKSA6IHZvaWQgMA0KICAgIH07DQogIH0NCiAgZnVuY3Rpb24gZ2VuRnVuY3Rpb25QcmVhbWJsZShhc3QsIGNvbnRleHQpIHsNCiAgICBjb25zdCB7DQogICAgICBzc3IsDQogICAgICBwcmVmaXhJZGVudGlmaWVycywNCiAgICAgIHB1c2gsDQogICAgICBuZXdsaW5lLA0KICAgICAgcnVudGltZU1vZHVsZU5hbWUsDQogICAgICBydW50aW1lR2xvYmFsTmFtZSwNCiAgICAgIHNzclJ1bnRpbWVNb2R1bGVOYW1lDQogICAgfSA9IGNvbnRleHQ7DQogICAgY29uc3QgVnVlQmluZGluZyA9IHJ1bnRpbWVHbG9iYWxOYW1lOw0KICAgIGNvbnN0IGhlbHBlcnMgPSBBcnJheS5mcm9tKGFzdC5oZWxwZXJzKTsNCiAgICBpZiAoaGVscGVycy5sZW5ndGggPiAwKSB7DQogICAgICB7DQogICAgICAgIHB1c2goYGNvbnN0IF9WdWUgPSAke1Z1ZUJpbmRpbmd9DQpgLCAtMSAvKiBFbmQgKi8pOw0KICAgICAgICBpZiAoYXN0LmhvaXN0cy5sZW5ndGgpIHsNCiAgICAgICAgICBjb25zdCBzdGF0aWNIZWxwZXJzID0gWw0KICAgICAgICAgICAgQ1JFQVRFX1ZOT0RFLA0KICAgICAgICAgICAgQ1JFQVRFX0VMRU1FTlRfVk5PREUsDQogICAgICAgICAgICBDUkVBVEVfQ09NTUVOVCwNCiAgICAgICAgICAgIENSRUFURV9URVhULA0KICAgICAgICAgICAgQ1JFQVRFX1NUQVRJQw0KICAgICAgICAgIF0uZmlsdGVyKChoZWxwZXIpID0+IGhlbHBlcnMuaW5jbHVkZXMoaGVscGVyKSkubWFwKGFsaWFzSGVscGVyKS5qb2luKCIsICIpOw0KICAgICAgICAgIHB1c2goYGNvbnN0IHsgJHtzdGF0aWNIZWxwZXJzfSB9ID0gX1Z1ZQ0KYCwgLTEgLyogRW5kICovKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICBnZW5Ib2lzdHMoYXN0LmhvaXN0cywgY29udGV4dCk7DQogICAgbmV3bGluZSgpOw0KICAgIHB1c2goYHJldHVybiBgKTsNCiAgfQ0KICBmdW5jdGlvbiBnZW5Bc3NldHMoYXNzZXRzLCB0eXBlLCB7IGhlbHBlciwgcHVzaCwgbmV3bGluZSwgaXNUUyB9KSB7DQogICAgY29uc3QgcmVzb2x2ZXIgPSBoZWxwZXIoDQogICAgICB0eXBlID09PSAiY29tcG9uZW50IiA/IFJFU09MVkVfQ09NUE9ORU5UIDogUkVTT0xWRV9ESVJFQ1RJVkUNCiAgICApOw0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXNzZXRzLmxlbmd0aDsgaSsrKSB7DQogICAgICBsZXQgaWQgPSBhc3NldHNbaV07DQogICAgICBjb25zdCBtYXliZVNlbGZSZWZlcmVuY2UgPSBpZC5lbmRzV2l0aCgiX19zZWxmIik7DQogICAgICBpZiAobWF5YmVTZWxmUmVmZXJlbmNlKSB7DQogICAgICAgIGlkID0gaWQuc2xpY2UoMCwgLTYpOw0KICAgICAgfQ0KICAgICAgcHVzaCgNCiAgICAgICAgYGNvbnN0ICR7dG9WYWxpZEFzc2V0SWQoaWQsIHR5cGUpfSA9ICR7cmVzb2x2ZXJ9KCR7SlNPTi5zdHJpbmdpZnkoaWQpfSR7bWF5YmVTZWxmUmVmZXJlbmNlID8gYCwgdHJ1ZWAgOiBgYH0pJHtpc1RTID8gYCFgIDogYGB9YA0KICAgICAgKTsNCiAgICAgIGlmIChpIDwgYXNzZXRzLmxlbmd0aCAtIDEpIHsNCiAgICAgICAgbmV3bGluZSgpOw0KICAgICAgfQ0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBnZW5Ib2lzdHMoaG9pc3RzLCBjb250ZXh0KSB7DQogICAgaWYgKCFob2lzdHMubGVuZ3RoKSB7DQogICAgICByZXR1cm47DQogICAgfQ0KICAgIGNvbnRleHQucHVyZSA9IHRydWU7DQogICAgY29uc3QgeyBwdXNoLCBuZXdsaW5lIH0gPSBjb250ZXh0Ow0KICAgIG5ld2xpbmUoKTsNCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhvaXN0cy5sZW5ndGg7IGkrKykgew0KICAgICAgY29uc3QgZXhwID0gaG9pc3RzW2ldOw0KICAgICAgaWYgKGV4cCkgew0KICAgICAgICBwdXNoKGBjb25zdCBfaG9pc3RlZF8ke2kgKyAxfSA9IGApOw0KICAgICAgICBnZW5Ob2RlKGV4cCwgY29udGV4dCk7DQogICAgICAgIG5ld2xpbmUoKTsNCiAgICAgIH0NCiAgICB9DQogICAgY29udGV4dC5wdXJlID0gZmFsc2U7DQogIH0NCiAgZnVuY3Rpb24gaXNUZXh0KG4pIHsNCiAgICByZXR1cm4gaXNTdHJpbmcobikgfHwgbi50eXBlID09PSA0IHx8IG4udHlwZSA9PT0gMiB8fCBuLnR5cGUgPT09IDUgfHwgbi50eXBlID09PSA4Ow0KICB9DQogIGZ1bmN0aW9uIGdlbk5vZGVMaXN0QXNBcnJheShub2RlcywgY29udGV4dCkgew0KICAgIGNvbnN0IG11bHRpbGluZXMgPSBub2Rlcy5sZW5ndGggPiAzIHx8IG5vZGVzLnNvbWUoKG4pID0+IGlzQXJyYXkobikgfHwgIWlzVGV4dChuKSk7DQogICAgY29udGV4dC5wdXNoKGBbYCk7DQogICAgbXVsdGlsaW5lcyAmJiBjb250ZXh0LmluZGVudCgpOw0KICAgIGdlbk5vZGVMaXN0KG5vZGVzLCBjb250ZXh0LCBtdWx0aWxpbmVzKTsNCiAgICBtdWx0aWxpbmVzICYmIGNvbnRleHQuZGVpbmRlbnQoKTsNCiAgICBjb250ZXh0LnB1c2goYF1gKTsNCiAgfQ0KICBmdW5jdGlvbiBnZW5Ob2RlTGlzdChub2RlcywgY29udGV4dCwgbXVsdGlsaW5lcyA9IGZhbHNlLCBjb21tYSA9IHRydWUpIHsNCiAgICBjb25zdCB7IHB1c2gsIG5ld2xpbmUgfSA9IGNvbnRleHQ7DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykgew0KICAgICAgY29uc3Qgbm9kZSA9IG5vZGVzW2ldOw0KICAgICAgaWYgKGlzU3RyaW5nKG5vZGUpKSB7DQogICAgICAgIHB1c2gobm9kZSwgLTMgLyogVW5rbm93biAqLyk7DQogICAgICB9IGVsc2UgaWYgKGlzQXJyYXkobm9kZSkpIHsNCiAgICAgICAgZ2VuTm9kZUxpc3RBc0FycmF5KG5vZGUsIGNvbnRleHQpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgZ2VuTm9kZShub2RlLCBjb250ZXh0KTsNCiAgICAgIH0NCiAgICAgIGlmIChpIDwgbm9kZXMubGVuZ3RoIC0gMSkgew0KICAgICAgICBpZiAobXVsdGlsaW5lcykgew0KICAgICAgICAgIGNvbW1hICYmIHB1c2goIiwiKTsNCiAgICAgICAgICBuZXdsaW5lKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgY29tbWEgJiYgcHVzaCgiLCAiKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBnZW5Ob2RlKG5vZGUsIGNvbnRleHQpIHsNCiAgICBpZiAoaXNTdHJpbmcobm9kZSkpIHsNCiAgICAgIGNvbnRleHQucHVzaChub2RlLCAtMyAvKiBVbmtub3duICovKTsNCiAgICAgIHJldHVybjsNCiAgICB9DQogICAgaWYgKGlzU3ltYm9sKG5vZGUpKSB7DQogICAgICBjb250ZXh0LnB1c2goY29udGV4dC5oZWxwZXIobm9kZSkpOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBzd2l0Y2ggKG5vZGUudHlwZSkgew0KICAgICAgY2FzZSAxOg0KICAgICAgY2FzZSA5Og0KICAgICAgY2FzZSAxMToNCiAgICAgICAgYXNzZXJ0KA0KICAgICAgICAgIG5vZGUuY29kZWdlbk5vZGUgIT0gbnVsbCwNCiAgICAgICAgICBgQ29kZWdlbiBub2RlIGlzIG1pc3NpbmcgZm9yIGVsZW1lbnQvaWYvZm9yIG5vZGUuIEFwcGx5IGFwcHJvcHJpYXRlIHRyYW5zZm9ybXMgZmlyc3QuYA0KICAgICAgICApOw0KICAgICAgICBnZW5Ob2RlKG5vZGUuY29kZWdlbk5vZGUsIGNvbnRleHQpOw0KICAgICAgICBicmVhazsNCiAgICAgIGNhc2UgMjoNCiAgICAgICAgZ2VuVGV4dChub2RlLCBjb250ZXh0KTsNCiAgICAgICAgYnJlYWs7DQogICAgICBjYXNlIDQ6DQogICAgICAgIGdlbkV4cHJlc3Npb24obm9kZSwgY29udGV4dCk7DQogICAgICAgIGJyZWFrOw0KICAgICAgY2FzZSA1Og0KICAgICAgICBnZW5JbnRlcnBvbGF0aW9uKG5vZGUsIGNvbnRleHQpOw0KICAgICAgICBicmVhazsNCiAgICAgIGNhc2UgMTI6DQogICAgICAgIGdlbk5vZGUobm9kZS5jb2RlZ2VuTm9kZSwgY29udGV4dCk7DQogICAgICAgIGJyZWFrOw0KICAgICAgY2FzZSA4Og0KICAgICAgICBnZW5Db21wb3VuZEV4cHJlc3Npb24obm9kZSwgY29udGV4dCk7DQogICAgICAgIGJyZWFrOw0KICAgICAgY2FzZSAzOg0KICAgICAgICBnZW5Db21tZW50KG5vZGUsIGNvbnRleHQpOw0KICAgICAgICBicmVhazsNCiAgICAgIGNhc2UgMTM6DQogICAgICAgIGdlblZOb2RlQ2FsbChub2RlLCBjb250ZXh0KTsNCiAgICAgICAgYnJlYWs7DQogICAgICBjYXNlIDE0Og0KICAgICAgICBnZW5DYWxsRXhwcmVzc2lvbihub2RlLCBjb250ZXh0KTsNCiAgICAgICAgYnJlYWs7DQogICAgICBjYXNlIDE1Og0KICAgICAgICBnZW5PYmplY3RFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpOw0KICAgICAgICBicmVhazsNCiAgICAgIGNhc2UgMTc6DQogICAgICAgIGdlbkFycmF5RXhwcmVzc2lvbihub2RlLCBjb250ZXh0KTsNCiAgICAgICAgYnJlYWs7DQogICAgICBjYXNlIDE4Og0KICAgICAgICBnZW5GdW5jdGlvbkV4cHJlc3Npb24obm9kZSwgY29udGV4dCk7DQogICAgICAgIGJyZWFrOw0KICAgICAgY2FzZSAxOToNCiAgICAgICAgZ2VuQ29uZGl0aW9uYWxFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpOw0KICAgICAgICBicmVhazsNCiAgICAgIGNhc2UgMjA6DQogICAgICAgIGdlbkNhY2hlRXhwcmVzc2lvbihub2RlLCBjb250ZXh0KTsNCiAgICAgICAgYnJlYWs7DQogICAgICBjYXNlIDIxOg0KICAgICAgICBnZW5Ob2RlTGlzdChub2RlLmJvZHksIGNvbnRleHQsIHRydWUsIGZhbHNlKTsNCiAgICAgICAgYnJlYWs7DQogICAgICAvLyBTU1Igb25seSB0eXBlcw0KICAgICAgY2FzZSAyMjoNCiAgICAgICAgYnJlYWs7DQogICAgICBjYXNlIDIzOg0KICAgICAgICBicmVhazsNCiAgICAgIGNhc2UgMjQ6DQogICAgICAgIGJyZWFrOw0KICAgICAgY2FzZSAyNToNCiAgICAgICAgYnJlYWs7DQogICAgICBjYXNlIDI2Og0KICAgICAgICBicmVhazsNCiAgICAgIC8qIHY4IGlnbm9yZSBzdGFydCAqLw0KICAgICAgY2FzZSAxMDoNCiAgICAgICAgYnJlYWs7DQogICAgICBkZWZhdWx0Og0KICAgICAgICB7DQogICAgICAgICAgYXNzZXJ0KGZhbHNlLCBgdW5oYW5kbGVkIGNvZGVnZW4gbm9kZSB0eXBlOiAke25vZGUudHlwZX1gKTsNCiAgICAgICAgICBjb25zdCBleGhhdXN0aXZlQ2hlY2sgPSBub2RlOw0KICAgICAgICAgIHJldHVybiBleGhhdXN0aXZlQ2hlY2s7DQogICAgICAgIH0NCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gZ2VuVGV4dChub2RlLCBjb250ZXh0KSB7DQogICAgY29udGV4dC5wdXNoKEpTT04uc3RyaW5naWZ5KG5vZGUuY29udGVudCksIC0zIC8qIFVua25vd24gKi8sIG5vZGUpOw0KICB9DQogIGZ1bmN0aW9uIGdlbkV4cHJlc3Npb24obm9kZSwgY29udGV4dCkgew0KICAgIGNvbnN0IHsgY29udGVudCwgaXNTdGF0aWMgfSA9IG5vZGU7DQogICAgY29udGV4dC5wdXNoKA0KICAgICAgaXNTdGF0aWMgPyBKU09OLnN0cmluZ2lmeShjb250ZW50KSA6IGNvbnRlbnQsDQogICAgICAtMyAvKiBVbmtub3duICovLA0KICAgICAgbm9kZQ0KICAgICk7DQogIH0NCiAgZnVuY3Rpb24gZ2VuSW50ZXJwb2xhdGlvbihub2RlLCBjb250ZXh0KSB7DQogICAgY29uc3QgeyBwdXNoLCBoZWxwZXIsIHB1cmUgfSA9IGNvbnRleHQ7DQogICAgaWYgKHB1cmUpIHB1c2goUFVSRV9BTk5PVEFUSU9OKTsNCiAgICBwdXNoKGAke2hlbHBlcihUT19ESVNQTEFZX1NUUklORyl9KGApOw0KICAgIGdlbk5vZGUobm9kZS5jb250ZW50LCBjb250ZXh0KTsNCiAgICBwdXNoKGApYCk7DQogIH0NCiAgZnVuY3Rpb24gZ2VuQ29tcG91bmRFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpIHsNCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsNCiAgICAgIGNvbnN0IGNoaWxkID0gbm9kZS5jaGlsZHJlbltpXTsNCiAgICAgIGlmIChpc1N0cmluZyhjaGlsZCkpIHsNCiAgICAgICAgY29udGV4dC5wdXNoKGNoaWxkLCAtMyAvKiBVbmtub3duICovKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGdlbk5vZGUoY2hpbGQsIGNvbnRleHQpOw0KICAgICAgfQ0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBnZW5FeHByZXNzaW9uQXNQcm9wZXJ0eUtleShub2RlLCBjb250ZXh0KSB7DQogICAgY29uc3QgeyBwdXNoIH0gPSBjb250ZXh0Ow0KICAgIGlmIChub2RlLnR5cGUgPT09IDgpIHsNCiAgICAgIHB1c2goYFtgKTsNCiAgICAgIGdlbkNvbXBvdW5kRXhwcmVzc2lvbihub2RlLCBjb250ZXh0KTsNCiAgICAgIHB1c2goYF1gKTsNCiAgICB9IGVsc2UgaWYgKG5vZGUuaXNTdGF0aWMpIHsNCiAgICAgIGNvbnN0IHRleHQgPSBpc1NpbXBsZUlkZW50aWZpZXIobm9kZS5jb250ZW50KSA/IG5vZGUuY29udGVudCA6IEpTT04uc3RyaW5naWZ5KG5vZGUuY29udGVudCk7DQogICAgICBwdXNoKHRleHQsIC0yIC8qIE5vbmUgKi8sIG5vZGUpOw0KICAgIH0gZWxzZSB7DQogICAgICBwdXNoKGBbJHtub2RlLmNvbnRlbnR9XWAsIC0zIC8qIFVua25vd24gKi8sIG5vZGUpOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBnZW5Db21tZW50KG5vZGUsIGNvbnRleHQpIHsNCiAgICBjb25zdCB7IHB1c2gsIGhlbHBlciwgcHVyZSB9ID0gY29udGV4dDsNCiAgICBpZiAocHVyZSkgew0KICAgICAgcHVzaChQVVJFX0FOTk9UQVRJT04pOw0KICAgIH0NCiAgICBwdXNoKA0KICAgICAgYCR7aGVscGVyKENSRUFURV9DT01NRU5UKX0oJHtKU09OLnN0cmluZ2lmeShub2RlLmNvbnRlbnQpfSlgLA0KICAgICAgLTMgLyogVW5rbm93biAqLywNCiAgICAgIG5vZGUNCiAgICApOw0KICB9DQogIGZ1bmN0aW9uIGdlblZOb2RlQ2FsbChub2RlLCBjb250ZXh0KSB7DQogICAgY29uc3QgeyBwdXNoLCBoZWxwZXIsIHB1cmUgfSA9IGNvbnRleHQ7DQogICAgY29uc3Qgew0KICAgICAgdGFnLA0KICAgICAgcHJvcHMsDQogICAgICBjaGlsZHJlbiwNCiAgICAgIHBhdGNoRmxhZywNCiAgICAgIGR5bmFtaWNQcm9wcywNCiAgICAgIGRpcmVjdGl2ZXMsDQogICAgICBpc0Jsb2NrLA0KICAgICAgZGlzYWJsZVRyYWNraW5nLA0KICAgICAgaXNDb21wb25lbnQNCiAgICB9ID0gbm9kZTsNCiAgICBsZXQgcGF0Y2hGbGFnU3RyaW5nOw0KICAgIGlmIChwYXRjaEZsYWcpIHsNCiAgICAgIHsNCiAgICAgICAgaWYgKHBhdGNoRmxhZyA8IDApIHsNCiAgICAgICAgICBwYXRjaEZsYWdTdHJpbmcgPSBwYXRjaEZsYWcgKyBgIC8qICR7UGF0Y2hGbGFnTmFtZXNbcGF0Y2hGbGFnXX0gKi9gOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGNvbnN0IGZsYWdOYW1lcyA9IE9iamVjdC5rZXlzKFBhdGNoRmxhZ05hbWVzKS5tYXAoTnVtYmVyKS5maWx0ZXIoKG4pID0+IG4gPiAwICYmIHBhdGNoRmxhZyAmIG4pLm1hcCgobikgPT4gUGF0Y2hGbGFnTmFtZXNbbl0pLmpvaW4oYCwgYCk7DQogICAgICAgICAgcGF0Y2hGbGFnU3RyaW5nID0gcGF0Y2hGbGFnICsgYCAvKiAke2ZsYWdOYW1lc30gKi9gOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIGlmIChkaXJlY3RpdmVzKSB7DQogICAgICBwdXNoKGhlbHBlcihXSVRIX0RJUkVDVElWRVMpICsgYChgKTsNCiAgICB9DQogICAgaWYgKGlzQmxvY2spIHsNCiAgICAgIHB1c2goYCgke2hlbHBlcihPUEVOX0JMT0NLKX0oJHtkaXNhYmxlVHJhY2tpbmcgPyBgdHJ1ZWAgOiBgYH0pLCBgKTsNCiAgICB9DQogICAgaWYgKHB1cmUpIHsNCiAgICAgIHB1c2goUFVSRV9BTk5PVEFUSU9OKTsNCiAgICB9DQogICAgY29uc3QgY2FsbEhlbHBlciA9IGlzQmxvY2sgPyBnZXRWTm9kZUJsb2NrSGVscGVyKGNvbnRleHQuaW5TU1IsIGlzQ29tcG9uZW50KSA6IGdldFZOb2RlSGVscGVyKGNvbnRleHQuaW5TU1IsIGlzQ29tcG9uZW50KTsNCiAgICBwdXNoKGhlbHBlcihjYWxsSGVscGVyKSArIGAoYCwgLTIgLyogTm9uZSAqLywgbm9kZSk7DQogICAgZ2VuTm9kZUxpc3QoDQogICAgICBnZW5OdWxsYWJsZUFyZ3MoW3RhZywgcHJvcHMsIGNoaWxkcmVuLCBwYXRjaEZsYWdTdHJpbmcsIGR5bmFtaWNQcm9wc10pLA0KICAgICAgY29udGV4dA0KICAgICk7DQogICAgcHVzaChgKWApOw0KICAgIGlmIChpc0Jsb2NrKSB7DQogICAgICBwdXNoKGApYCk7DQogICAgfQ0KICAgIGlmIChkaXJlY3RpdmVzKSB7DQogICAgICBwdXNoKGAsIGApOw0KICAgICAgZ2VuTm9kZShkaXJlY3RpdmVzLCBjb250ZXh0KTsNCiAgICAgIHB1c2goYClgKTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gZ2VuTnVsbGFibGVBcmdzKGFyZ3MpIHsNCiAgICBsZXQgaSA9IGFyZ3MubGVuZ3RoOw0KICAgIHdoaWxlIChpLS0pIHsNCiAgICAgIGlmIChhcmdzW2ldICE9IG51bGwpIGJyZWFrOw0KICAgIH0NCiAgICByZXR1cm4gYXJncy5zbGljZSgwLCBpICsgMSkubWFwKChhcmcpID0+IGFyZyB8fCBgbnVsbGApOw0KICB9DQogIGZ1bmN0aW9uIGdlbkNhbGxFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpIHsNCiAgICBjb25zdCB7IHB1c2gsIGhlbHBlciwgcHVyZSB9ID0gY29udGV4dDsNCiAgICBjb25zdCBjYWxsZWUgPSBpc1N0cmluZyhub2RlLmNhbGxlZSkgPyBub2RlLmNhbGxlZSA6IGhlbHBlcihub2RlLmNhbGxlZSk7DQogICAgaWYgKHB1cmUpIHsNCiAgICAgIHB1c2goUFVSRV9BTk5PVEFUSU9OKTsNCiAgICB9DQogICAgcHVzaChjYWxsZWUgKyBgKGAsIC0yIC8qIE5vbmUgKi8sIG5vZGUpOw0KICAgIGdlbk5vZGVMaXN0KG5vZGUuYXJndW1lbnRzLCBjb250ZXh0KTsNCiAgICBwdXNoKGApYCk7DQogIH0NCiAgZnVuY3Rpb24gZ2VuT2JqZWN0RXhwcmVzc2lvbihub2RlLCBjb250ZXh0KSB7DQogICAgY29uc3QgeyBwdXNoLCBpbmRlbnQsIGRlaW5kZW50LCBuZXdsaW5lIH0gPSBjb250ZXh0Ow0KICAgIGNvbnN0IHsgcHJvcGVydGllcyB9ID0gbm9kZTsNCiAgICBpZiAoIXByb3BlcnRpZXMubGVuZ3RoKSB7DQogICAgICBwdXNoKGB7fWAsIC0yIC8qIE5vbmUgKi8sIG5vZGUpOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBjb25zdCBtdWx0aWxpbmVzID0gcHJvcGVydGllcy5sZW5ndGggPiAxIHx8IHByb3BlcnRpZXMuc29tZSgocCkgPT4gcC52YWx1ZS50eXBlICE9PSA0KTsNCiAgICBwdXNoKG11bHRpbGluZXMgPyBge2AgOiBgeyBgKTsNCiAgICBtdWx0aWxpbmVzICYmIGluZGVudCgpOw0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcGVydGllcy5sZW5ndGg7IGkrKykgew0KICAgICAgY29uc3QgeyBrZXksIHZhbHVlIH0gPSBwcm9wZXJ0aWVzW2ldOw0KICAgICAgZ2VuRXhwcmVzc2lvbkFzUHJvcGVydHlLZXkoa2V5LCBjb250ZXh0KTsNCiAgICAgIHB1c2goYDogYCk7DQogICAgICBnZW5Ob2RlKHZhbHVlLCBjb250ZXh0KTsNCiAgICAgIGlmIChpIDwgcHJvcGVydGllcy5sZW5ndGggLSAxKSB7DQogICAgICAgIHB1c2goYCxgKTsNCiAgICAgICAgbmV3bGluZSgpOw0KICAgICAgfQ0KICAgIH0NCiAgICBtdWx0aWxpbmVzICYmIGRlaW5kZW50KCk7DQogICAgcHVzaChtdWx0aWxpbmVzID8gYH1gIDogYCB9YCk7DQogIH0NCiAgZnVuY3Rpb24gZ2VuQXJyYXlFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpIHsNCiAgICBnZW5Ob2RlTGlzdEFzQXJyYXkobm9kZS5lbGVtZW50cywgY29udGV4dCk7DQogIH0NCiAgZnVuY3Rpb24gZ2VuRnVuY3Rpb25FeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpIHsNCiAgICBjb25zdCB7IHB1c2gsIGluZGVudCwgZGVpbmRlbnQgfSA9IGNvbnRleHQ7DQogICAgY29uc3QgeyBwYXJhbXMsIHJldHVybnMsIGJvZHksIG5ld2xpbmUsIGlzU2xvdCB9ID0gbm9kZTsNCiAgICBpZiAoaXNTbG90KSB7DQogICAgICBwdXNoKGBfJHtoZWxwZXJOYW1lTWFwW1dJVEhfQ1RYXX0oYCk7DQogICAgfQ0KICAgIHB1c2goYChgLCAtMiAvKiBOb25lICovLCBub2RlKTsNCiAgICBpZiAoaXNBcnJheShwYXJhbXMpKSB7DQogICAgICBnZW5Ob2RlTGlzdChwYXJhbXMsIGNvbnRleHQpOw0KICAgIH0gZWxzZSBpZiAocGFyYW1zKSB7DQogICAgICBnZW5Ob2RlKHBhcmFtcywgY29udGV4dCk7DQogICAgfQ0KICAgIHB1c2goYCkgPT4gYCk7DQogICAgaWYgKG5ld2xpbmUgfHwgYm9keSkgew0KICAgICAgcHVzaChge2ApOw0KICAgICAgaW5kZW50KCk7DQogICAgfQ0KICAgIGlmIChyZXR1cm5zKSB7DQogICAgICBpZiAobmV3bGluZSkgew0KICAgICAgICBwdXNoKGByZXR1cm4gYCk7DQogICAgICB9DQogICAgICBpZiAoaXNBcnJheShyZXR1cm5zKSkgew0KICAgICAgICBnZW5Ob2RlTGlzdEFzQXJyYXkocmV0dXJucywgY29udGV4dCk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBnZW5Ob2RlKHJldHVybnMsIGNvbnRleHQpOw0KICAgICAgfQ0KICAgIH0gZWxzZSBpZiAoYm9keSkgew0KICAgICAgZ2VuTm9kZShib2R5LCBjb250ZXh0KTsNCiAgICB9DQogICAgaWYgKG5ld2xpbmUgfHwgYm9keSkgew0KICAgICAgZGVpbmRlbnQoKTsNCiAgICAgIHB1c2goYH1gKTsNCiAgICB9DQogICAgaWYgKGlzU2xvdCkgew0KICAgICAgcHVzaChgKWApOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBnZW5Db25kaXRpb25hbEV4cHJlc3Npb24obm9kZSwgY29udGV4dCkgew0KICAgIGNvbnN0IHsgdGVzdCwgY29uc2VxdWVudCwgYWx0ZXJuYXRlLCBuZXdsaW5lOiBuZWVkTmV3bGluZSB9ID0gbm9kZTsNCiAgICBjb25zdCB7IHB1c2gsIGluZGVudCwgZGVpbmRlbnQsIG5ld2xpbmUgfSA9IGNvbnRleHQ7DQogICAgaWYgKHRlc3QudHlwZSA9PT0gNCkgew0KICAgICAgY29uc3QgbmVlZHNQYXJlbnMgPSAhaXNTaW1wbGVJZGVudGlmaWVyKHRlc3QuY29udGVudCk7DQogICAgICBuZWVkc1BhcmVucyAmJiBwdXNoKGAoYCk7DQogICAgICBnZW5FeHByZXNzaW9uKHRlc3QsIGNvbnRleHQpOw0KICAgICAgbmVlZHNQYXJlbnMgJiYgcHVzaChgKWApOw0KICAgIH0gZWxzZSB7DQogICAgICBwdXNoKGAoYCk7DQogICAgICBnZW5Ob2RlKHRlc3QsIGNvbnRleHQpOw0KICAgICAgcHVzaChgKWApOw0KICAgIH0NCiAgICBuZWVkTmV3bGluZSAmJiBpbmRlbnQoKTsNCiAgICBjb250ZXh0LmluZGVudExldmVsKys7DQogICAgbmVlZE5ld2xpbmUgfHwgcHVzaChgIGApOw0KICAgIHB1c2goYD8gYCk7DQogICAgZ2VuTm9kZShjb25zZXF1ZW50LCBjb250ZXh0KTsNCiAgICBjb250ZXh0LmluZGVudExldmVsLS07DQogICAgbmVlZE5ld2xpbmUgJiYgbmV3bGluZSgpOw0KICAgIG5lZWROZXdsaW5lIHx8IHB1c2goYCBgKTsNCiAgICBwdXNoKGA6IGApOw0KICAgIGNvbnN0IGlzTmVzdGVkID0gYWx0ZXJuYXRlLnR5cGUgPT09IDE5Ow0KICAgIGlmICghaXNOZXN0ZWQpIHsNCiAgICAgIGNvbnRleHQuaW5kZW50TGV2ZWwrKzsNCiAgICB9DQogICAgZ2VuTm9kZShhbHRlcm5hdGUsIGNvbnRleHQpOw0KICAgIGlmICghaXNOZXN0ZWQpIHsNCiAgICAgIGNvbnRleHQuaW5kZW50TGV2ZWwtLTsNCiAgICB9DQogICAgbmVlZE5ld2xpbmUgJiYgZGVpbmRlbnQoDQogICAgICB0cnVlDQogICAgICAvKiB3aXRob3V0IG5ld2xpbmUgKi8NCiAgICApOw0KICB9DQogIGZ1bmN0aW9uIGdlbkNhY2hlRXhwcmVzc2lvbihub2RlLCBjb250ZXh0KSB7DQogICAgY29uc3QgeyBwdXNoLCBoZWxwZXIsIGluZGVudCwgZGVpbmRlbnQsIG5ld2xpbmUgfSA9IGNvbnRleHQ7DQogICAgY29uc3QgeyBuZWVkUGF1c2VUcmFja2luZywgbmVlZEFycmF5U3ByZWFkIH0gPSBub2RlOw0KICAgIGlmIChuZWVkQXJyYXlTcHJlYWQpIHsNCiAgICAgIHB1c2goYFsuLi4oYCk7DQogICAgfQ0KICAgIHB1c2goYF9jYWNoZVske25vZGUuaW5kZXh9XSB8fCAoYCk7DQogICAgaWYgKG5lZWRQYXVzZVRyYWNraW5nKSB7DQogICAgICBpbmRlbnQoKTsNCiAgICAgIHB1c2goYCR7aGVscGVyKFNFVF9CTE9DS19UUkFDS0lORyl9KC0xYCk7DQogICAgICBpZiAobm9kZS5pblZPbmNlKSBwdXNoKGAsIHRydWVgKTsNCiAgICAgIHB1c2goYCksYCk7DQogICAgICBuZXdsaW5lKCk7DQogICAgICBwdXNoKGAoYCk7DQogICAgfQ0KICAgIHB1c2goYF9jYWNoZVske25vZGUuaW5kZXh9XSA9IGApOw0KICAgIGdlbk5vZGUobm9kZS52YWx1ZSwgY29udGV4dCk7DQogICAgaWYgKG5lZWRQYXVzZVRyYWNraW5nKSB7DQogICAgICBwdXNoKGApLmNhY2hlSW5kZXggPSAke25vZGUuaW5kZXh9LGApOw0KICAgICAgbmV3bGluZSgpOw0KICAgICAgcHVzaChgJHtoZWxwZXIoU0VUX0JMT0NLX1RSQUNLSU5HKX0oMSksYCk7DQogICAgICBuZXdsaW5lKCk7DQogICAgICBwdXNoKGBfY2FjaGVbJHtub2RlLmluZGV4fV1gKTsNCiAgICAgIGRlaW5kZW50KCk7DQogICAgfQ0KICAgIHB1c2goYClgKTsNCiAgICBpZiAobmVlZEFycmF5U3ByZWFkKSB7DQogICAgICBwdXNoKGApXWApOw0KICAgIH0NCiAgfQ0KDQogIGNvbnN0IHByb2hpYml0ZWRLZXl3b3JkUkUgPSBuZXcgUmVnRXhwKA0KICAgICJcXGIiICsgImFyZ3VtZW50cyxhd2FpdCxicmVhayxjYXNlLGNhdGNoLGNsYXNzLGNvbnN0LGNvbnRpbnVlLGRlYnVnZ2VyLGRlZmF1bHQsZGVsZXRlLGRvLGVsc2UsZXhwb3J0LGV4dGVuZHMsZmluYWxseSxmb3IsZnVuY3Rpb24saWYsaW1wb3J0LGxldCxuZXcscmV0dXJuLHN1cGVyLHN3aXRjaCx0aHJvdyx0cnksdmFyLHZvaWQsd2hpbGUsd2l0aCx5aWVsZCIuc3BsaXQoIiwiKS5qb2luKCJcXGJ8XFxiIikgKyAiXFxiIg0KICApOw0KICBjb25zdCBzdHJpcFN0cmluZ1JFID0gLycoPzpbXidcXF18XFwuKSonfCIoPzpbXiJcXF18XFwuKSoifGAoPzpbXmBcXF18XFwuKSpcJFx7fFx9KD86W15gXFxdfFxcLikqYHxgKD86W15gXFxdfFxcLikqYC9nOw0KICBmdW5jdGlvbiB2YWxpZGF0ZUJyb3dzZXJFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQsIGFzUGFyYW1zID0gZmFsc2UsIGFzUmF3U3RhdGVtZW50cyA9IGZhbHNlKSB7DQogICAgY29uc3QgZXhwID0gbm9kZS5jb250ZW50Ow0KICAgIGlmICghZXhwLnRyaW0oKSkgew0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICB0cnkgew0KICAgICAgbmV3IEZ1bmN0aW9uKA0KICAgICAgICBhc1Jhd1N0YXRlbWVudHMgPyBgICR7ZXhwfSBgIDogYHJldHVybiAke2FzUGFyYW1zID8gYCgke2V4cH0pID0+IHt9YCA6IGAoJHtleHB9KWB9YA0KICAgICAgKTsNCiAgICB9IGNhdGNoIChlKSB7DQogICAgICBsZXQgbWVzc2FnZSA9IGUubWVzc2FnZTsNCiAgICAgIGNvbnN0IGtleXdvcmRNYXRjaCA9IGV4cC5yZXBsYWNlKHN0cmlwU3RyaW5nUkUsICIiKS5tYXRjaChwcm9oaWJpdGVkS2V5d29yZFJFKTsNCiAgICAgIGlmIChrZXl3b3JkTWF0Y2gpIHsNCiAgICAgICAgbWVzc2FnZSA9IGBhdm9pZCB1c2luZyBKYXZhU2NyaXB0IGtleXdvcmQgYXMgcHJvcGVydHkgbmFtZTogIiR7a2V5d29yZE1hdGNoWzBdfSJgOw0KICAgICAgfQ0KICAgICAgY29udGV4dC5vbkVycm9yKA0KICAgICAgICBjcmVhdGVDb21waWxlckVycm9yKA0KICAgICAgICAgIDQ1LA0KICAgICAgICAgIG5vZGUubG9jLA0KICAgICAgICAgIHZvaWQgMCwNCiAgICAgICAgICBtZXNzYWdlDQogICAgICAgICkNCiAgICAgICk7DQogICAgfQ0KICB9DQoNCiAgY29uc3QgdHJhbnNmb3JtRXhwcmVzc2lvbiA9IChub2RlLCBjb250ZXh0KSA9PiB7DQogICAgaWYgKG5vZGUudHlwZSA9PT0gNSkgew0KICAgICAgbm9kZS5jb250ZW50ID0gcHJvY2Vzc0V4cHJlc3Npb24oDQogICAgICAgIG5vZGUuY29udGVudCwNCiAgICAgICAgY29udGV4dA0KICAgICAgKTsNCiAgICB9IGVsc2UgaWYgKG5vZGUudHlwZSA9PT0gMSkgew0KICAgICAgY29uc3QgbWVtbyA9IGZpbmREaXIobm9kZSwgIm1lbW8iKTsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5wcm9wcy5sZW5ndGg7IGkrKykgew0KICAgICAgICBjb25zdCBkaXIgPSBub2RlLnByb3BzW2ldOw0KICAgICAgICBpZiAoZGlyLnR5cGUgPT09IDcgJiYgZGlyLm5hbWUgIT09ICJmb3IiKSB7DQogICAgICAgICAgY29uc3QgZXhwID0gZGlyLmV4cDsNCiAgICAgICAgICBjb25zdCBhcmcgPSBkaXIuYXJnOw0KICAgICAgICAgIGlmIChleHAgJiYgZXhwLnR5cGUgPT09IDQgJiYgIShkaXIubmFtZSA9PT0gIm9uIiAmJiBhcmcpICYmIC8vIGtleSBoYXMgYmVlbiBwcm9jZXNzZWQgaW4gdHJhbnNmb3JtRm9yKHZNZW1vICsgdkZvcikNCiAgICAgICAgICAhKG1lbW8gJiYgYXJnICYmIGFyZy50eXBlID09PSA0ICYmIGFyZy5jb250ZW50ID09PSAia2V5IikpIHsNCiAgICAgICAgICAgIGRpci5leHAgPSBwcm9jZXNzRXhwcmVzc2lvbigNCiAgICAgICAgICAgICAgZXhwLA0KICAgICAgICAgICAgICBjb250ZXh0LA0KICAgICAgICAgICAgICAvLyBzbG90IGFyZ3MgbXVzdCBiZSBwcm9jZXNzZWQgYXMgZnVuY3Rpb24gcGFyYW1zDQogICAgICAgICAgICAgIGRpci5uYW1lID09PSAic2xvdCINCiAgICAgICAgICAgICk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmIChhcmcgJiYgYXJnLnR5cGUgPT09IDQgJiYgIWFyZy5pc1N0YXRpYykgew0KICAgICAgICAgICAgZGlyLmFyZyA9IHByb2Nlc3NFeHByZXNzaW9uKGFyZywgY29udGV4dCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICB9Ow0KICBmdW5jdGlvbiBwcm9jZXNzRXhwcmVzc2lvbihub2RlLCBjb250ZXh0LCBhc1BhcmFtcyA9IGZhbHNlLCBhc1Jhd1N0YXRlbWVudHMgPSBmYWxzZSwgbG9jYWxWYXJzID0gT2JqZWN0LmNyZWF0ZShjb250ZXh0LmlkZW50aWZpZXJzKSkgew0KICAgIHsNCiAgICAgIHsNCiAgICAgICAgdmFsaWRhdGVCcm93c2VyRXhwcmVzc2lvbihub2RlLCBjb250ZXh0LCBhc1BhcmFtcywgYXNSYXdTdGF0ZW1lbnRzKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBub2RlOw0KICAgIH0NCiAgfQ0KDQogIGNvbnN0IHRyYW5zZm9ybUlmID0gY3JlYXRlU3RydWN0dXJhbERpcmVjdGl2ZVRyYW5zZm9ybSgNCiAgICAvXihpZnxlbHNlfGVsc2UtaWYpJC8sDQogICAgKG5vZGUsIGRpciwgY29udGV4dCkgPT4gew0KICAgICAgcmV0dXJuIHByb2Nlc3NJZihub2RlLCBkaXIsIGNvbnRleHQsIChpZk5vZGUsIGJyYW5jaCwgaXNSb290KSA9PiB7DQogICAgICAgIGNvbnN0IHNpYmxpbmdzID0gY29udGV4dC5wYXJlbnQuY2hpbGRyZW47DQogICAgICAgIGxldCBpID0gc2libGluZ3MuaW5kZXhPZihpZk5vZGUpOw0KICAgICAgICBsZXQga2V5ID0gMDsNCiAgICAgICAgd2hpbGUgKGktLSA+PSAwKSB7DQogICAgICAgICAgY29uc3Qgc2libGluZyA9IHNpYmxpbmdzW2ldOw0KICAgICAgICAgIGlmIChzaWJsaW5nICYmIHNpYmxpbmcudHlwZSA9PT0gOSkgew0KICAgICAgICAgICAga2V5ICs9IHNpYmxpbmcuYnJhbmNoZXMubGVuZ3RoOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gKCkgPT4gew0KICAgICAgICAgIGlmIChpc1Jvb3QpIHsNCiAgICAgICAgICAgIGlmTm9kZS5jb2RlZ2VuTm9kZSA9IGNyZWF0ZUNvZGVnZW5Ob2RlRm9yQnJhbmNoKA0KICAgICAgICAgICAgICBicmFuY2gsDQogICAgICAgICAgICAgIGtleSwNCiAgICAgICAgICAgICAgY29udGV4dA0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgY29uc3QgcGFyZW50Q29uZGl0aW9uID0gZ2V0UGFyZW50Q29uZGl0aW9uKGlmTm9kZS5jb2RlZ2VuTm9kZSk7DQogICAgICAgICAgICBwYXJlbnRDb25kaXRpb24uYWx0ZXJuYXRlID0gY3JlYXRlQ29kZWdlbk5vZGVGb3JCcmFuY2goDQogICAgICAgICAgICAgIGJyYW5jaCwNCiAgICAgICAgICAgICAga2V5ICsgaWZOb2RlLmJyYW5jaGVzLmxlbmd0aCAtIDEsDQogICAgICAgICAgICAgIGNvbnRleHQNCiAgICAgICAgICAgICk7DQogICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgfSk7DQogICAgfQ0KICApOw0KICBmdW5jdGlvbiBwcm9jZXNzSWYobm9kZSwgZGlyLCBjb250ZXh0LCBwcm9jZXNzQ29kZWdlbikgew0KICAgIGlmIChkaXIubmFtZSAhPT0gImVsc2UiICYmICghZGlyLmV4cCB8fCAhZGlyLmV4cC5jb250ZW50LnRyaW0oKSkpIHsNCiAgICAgIGNvbnN0IGxvYyA9IGRpci5leHAgPyBkaXIuZXhwLmxvYyA6IG5vZGUubG9jOw0KICAgICAgY29udGV4dC5vbkVycm9yKA0KICAgICAgICBjcmVhdGVDb21waWxlckVycm9yKDI4LCBkaXIubG9jKQ0KICAgICAgKTsNCiAgICAgIGRpci5leHAgPSBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGB0cnVlYCwgZmFsc2UsIGxvYyk7DQogICAgfQ0KICAgIGlmIChkaXIuZXhwKSB7DQogICAgICB2YWxpZGF0ZUJyb3dzZXJFeHByZXNzaW9uKGRpci5leHAsIGNvbnRleHQpOw0KICAgIH0NCiAgICBpZiAoZGlyLm5hbWUgPT09ICJpZiIpIHsNCiAgICAgIGNvbnN0IGJyYW5jaCA9IGNyZWF0ZUlmQnJhbmNoKG5vZGUsIGRpcik7DQogICAgICBjb25zdCBpZk5vZGUgPSB7DQogICAgICAgIHR5cGU6IDksDQogICAgICAgIGxvYzogY2xvbmVMb2Mobm9kZS5sb2MpLA0KICAgICAgICBicmFuY2hlczogW2JyYW5jaF0NCiAgICAgIH07DQogICAgICBjb250ZXh0LnJlcGxhY2VOb2RlKGlmTm9kZSk7DQogICAgICBpZiAocHJvY2Vzc0NvZGVnZW4pIHsNCiAgICAgICAgcmV0dXJuIHByb2Nlc3NDb2RlZ2VuKGlmTm9kZSwgYnJhbmNoLCB0cnVlKTsNCiAgICAgIH0NCiAgICB9IGVsc2Ugew0KICAgICAgY29uc3Qgc2libGluZ3MgPSBjb250ZXh0LnBhcmVudC5jaGlsZHJlbjsNCiAgICAgIGNvbnN0IGNvbW1lbnRzID0gW107DQogICAgICBsZXQgaSA9IHNpYmxpbmdzLmluZGV4T2Yobm9kZSk7DQogICAgICB3aGlsZSAoaS0tID49IC0xKSB7DQogICAgICAgIGNvbnN0IHNpYmxpbmcgPSBzaWJsaW5nc1tpXTsNCiAgICAgICAgaWYgKHNpYmxpbmcgJiYgc2libGluZy50eXBlID09PSAzKSB7DQogICAgICAgICAgY29udGV4dC5yZW1vdmVOb2RlKHNpYmxpbmcpOw0KICAgICAgICAgIGNvbW1lbnRzLnVuc2hpZnQoc2libGluZyk7DQogICAgICAgICAgY29udGludWU7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHNpYmxpbmcgJiYgc2libGluZy50eXBlID09PSAyICYmICFzaWJsaW5nLmNvbnRlbnQudHJpbSgpLmxlbmd0aCkgew0KICAgICAgICAgIGNvbnRleHQucmVtb3ZlTm9kZShzaWJsaW5nKTsNCiAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoc2libGluZyAmJiBzaWJsaW5nLnR5cGUgPT09IDkpIHsNCiAgICAgICAgICBpZiAoZGlyLm5hbWUgPT09ICJlbHNlLWlmIiAmJiBzaWJsaW5nLmJyYW5jaGVzW3NpYmxpbmcuYnJhbmNoZXMubGVuZ3RoIC0gMV0uY29uZGl0aW9uID09PSB2b2lkIDApIHsNCiAgICAgICAgICAgIGNvbnRleHQub25FcnJvcigNCiAgICAgICAgICAgICAgY3JlYXRlQ29tcGlsZXJFcnJvcigzMCwgbm9kZS5sb2MpDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjb250ZXh0LnJlbW92ZU5vZGUoKTsNCiAgICAgICAgICBjb25zdCBicmFuY2ggPSBjcmVhdGVJZkJyYW5jaChub2RlLCBkaXIpOw0KICAgICAgICAgIGlmIChjb21tZW50cy5sZW5ndGggJiYgLy8gIzM2MTkgaWdub3JlIGNvbW1lbnRzIGlmIHRoZSB2LWlmIGlzIGRpcmVjdCBjaGlsZCBvZiA8dHJhbnNpdGlvbj4NCiAgICAgICAgICAhKGNvbnRleHQucGFyZW50ICYmIGNvbnRleHQucGFyZW50LnR5cGUgPT09IDEgJiYgKGNvbnRleHQucGFyZW50LnRhZyA9PT0gInRyYW5zaXRpb24iIHx8IGNvbnRleHQucGFyZW50LnRhZyA9PT0gIlRyYW5zaXRpb24iKSkpIHsNCiAgICAgICAgICAgIGJyYW5jaC5jaGlsZHJlbiA9IFsuLi5jb21tZW50cywgLi4uYnJhbmNoLmNoaWxkcmVuXTsNCiAgICAgICAgICB9DQogICAgICAgICAgew0KICAgICAgICAgICAgY29uc3Qga2V5ID0gYnJhbmNoLnVzZXJLZXk7DQogICAgICAgICAgICBpZiAoa2V5KSB7DQogICAgICAgICAgICAgIHNpYmxpbmcuYnJhbmNoZXMuZm9yRWFjaCgoeyB1c2VyS2V5IH0pID0+IHsNCiAgICAgICAgICAgICAgICBpZiAoaXNTYW1lS2V5KHVzZXJLZXksIGtleSkpIHsNCiAgICAgICAgICAgICAgICAgIGNvbnRleHQub25FcnJvcigNCiAgICAgICAgICAgICAgICAgICAgY3JlYXRlQ29tcGlsZXJFcnJvcigNCiAgICAgICAgICAgICAgICAgICAgICAyOSwNCiAgICAgICAgICAgICAgICAgICAgICBicmFuY2gudXNlcktleS5sb2MNCiAgICAgICAgICAgICAgICAgICAgKQ0KICAgICAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgICBzaWJsaW5nLmJyYW5jaGVzLnB1c2goYnJhbmNoKTsNCiAgICAgICAgICBjb25zdCBvbkV4aXQgPSBwcm9jZXNzQ29kZWdlbiAmJiBwcm9jZXNzQ29kZWdlbihzaWJsaW5nLCBicmFuY2gsIGZhbHNlKTsNCiAgICAgICAgICB0cmF2ZXJzZU5vZGUoYnJhbmNoLCBjb250ZXh0KTsNCiAgICAgICAgICBpZiAob25FeGl0KSBvbkV4aXQoKTsNCiAgICAgICAgICBjb250ZXh0LmN1cnJlbnROb2RlID0gbnVsbDsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoDQogICAgICAgICAgICBjcmVhdGVDb21waWxlckVycm9yKDMwLCBub2RlLmxvYykNCiAgICAgICAgICApOw0KICAgICAgICB9DQogICAgICAgIGJyZWFrOw0KICAgICAgfQ0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBjcmVhdGVJZkJyYW5jaChub2RlLCBkaXIpIHsNCiAgICBjb25zdCBpc1RlbXBsYXRlSWYgPSBub2RlLnRhZ1R5cGUgPT09IDM7DQogICAgcmV0dXJuIHsNCiAgICAgIHR5cGU6IDEwLA0KICAgICAgbG9jOiBub2RlLmxvYywNCiAgICAgIGNvbmRpdGlvbjogZGlyLm5hbWUgPT09ICJlbHNlIiA/IHZvaWQgMCA6IGRpci5leHAsDQogICAgICBjaGlsZHJlbjogaXNUZW1wbGF0ZUlmICYmICFmaW5kRGlyKG5vZGUsICJmb3IiKSA/IG5vZGUuY2hpbGRyZW4gOiBbbm9kZV0sDQogICAgICB1c2VyS2V5OiBmaW5kUHJvcChub2RlLCBga2V5YCksDQogICAgICBpc1RlbXBsYXRlSWYNCiAgICB9Ow0KICB9DQogIGZ1bmN0aW9uIGNyZWF0ZUNvZGVnZW5Ob2RlRm9yQnJhbmNoKGJyYW5jaCwga2V5SW5kZXgsIGNvbnRleHQpIHsNCiAgICBpZiAoYnJhbmNoLmNvbmRpdGlvbikgew0KICAgICAgcmV0dXJuIGNyZWF0ZUNvbmRpdGlvbmFsRXhwcmVzc2lvbigNCiAgICAgICAgYnJhbmNoLmNvbmRpdGlvbiwNCiAgICAgICAgY3JlYXRlQ2hpbGRyZW5Db2RlZ2VuTm9kZShicmFuY2gsIGtleUluZGV4LCBjb250ZXh0KSwNCiAgICAgICAgLy8gbWFrZSBzdXJlIHRvIHBhc3MgaW4gYXNCbG9jazogdHJ1ZSBzbyB0aGF0IHRoZSBjb21tZW50IG5vZGUgY2FsbA0KICAgICAgICAvLyBjbG9zZXMgdGhlIGN1cnJlbnQgYmxvY2suDQogICAgICAgIGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKENSRUFURV9DT01NRU5UKSwgWw0KICAgICAgICAgICcidi1pZiInICwNCiAgICAgICAgICAidHJ1ZSINCiAgICAgICAgXSkNCiAgICAgICk7DQogICAgfSBlbHNlIHsNCiAgICAgIHJldHVybiBjcmVhdGVDaGlsZHJlbkNvZGVnZW5Ob2RlKGJyYW5jaCwga2V5SW5kZXgsIGNvbnRleHQpOw0KICAgIH0NCiAgfQ0KICBmdW5jdGlvbiBjcmVhdGVDaGlsZHJlbkNvZGVnZW5Ob2RlKGJyYW5jaCwga2V5SW5kZXgsIGNvbnRleHQpIHsNCiAgICBjb25zdCB7IGhlbHBlciB9ID0gY29udGV4dDsNCiAgICBjb25zdCBrZXlQcm9wZXJ0eSA9IGNyZWF0ZU9iamVjdFByb3BlcnR5KA0KICAgICAgYGtleWAsDQogICAgICBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKA0KICAgICAgICBgJHtrZXlJbmRleH1gLA0KICAgICAgICBmYWxzZSwNCiAgICAgICAgbG9jU3R1YiwNCiAgICAgICAgMg0KICAgICAgKQ0KICAgICk7DQogICAgY29uc3QgeyBjaGlsZHJlbiB9ID0gYnJhbmNoOw0KICAgIGNvbnN0IGZpcnN0Q2hpbGQgPSBjaGlsZHJlblswXTsNCiAgICBjb25zdCBuZWVkRnJhZ21lbnRXcmFwcGVyID0gY2hpbGRyZW4ubGVuZ3RoICE9PSAxIHx8IGZpcnN0Q2hpbGQudHlwZSAhPT0gMTsNCiAgICBpZiAobmVlZEZyYWdtZW50V3JhcHBlcikgew0KICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA9PT0gMSAmJiBmaXJzdENoaWxkLnR5cGUgPT09IDExKSB7DQogICAgICAgIGNvbnN0IHZub2RlQ2FsbCA9IGZpcnN0Q2hpbGQuY29kZWdlbk5vZGU7DQogICAgICAgIGluamVjdFByb3Aodm5vZGVDYWxsLCBrZXlQcm9wZXJ0eSwgY29udGV4dCk7DQogICAgICAgIHJldHVybiB2bm9kZUNhbGw7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBsZXQgcGF0Y2hGbGFnID0gNjQ7DQogICAgICAgIGlmICghYnJhbmNoLmlzVGVtcGxhdGVJZiAmJiBjaGlsZHJlbi5maWx0ZXIoKGMpID0+IGMudHlwZSAhPT0gMykubGVuZ3RoID09PSAxKSB7DQogICAgICAgICAgcGF0Y2hGbGFnIHw9IDIwNDg7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGNyZWF0ZVZOb2RlQ2FsbCgNCiAgICAgICAgICBjb250ZXh0LA0KICAgICAgICAgIGhlbHBlcihGUkFHTUVOVCksDQogICAgICAgICAgY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihba2V5UHJvcGVydHldKSwNCiAgICAgICAgICBjaGlsZHJlbiwNCiAgICAgICAgICBwYXRjaEZsYWcsDQogICAgICAgICAgdm9pZCAwLA0KICAgICAgICAgIHZvaWQgMCwNCiAgICAgICAgICB0cnVlLA0KICAgICAgICAgIGZhbHNlLA0KICAgICAgICAgIGZhbHNlLA0KICAgICAgICAgIGJyYW5jaC5sb2MNCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICB9IGVsc2Ugew0KICAgICAgY29uc3QgcmV0ID0gZmlyc3RDaGlsZC5jb2RlZ2VuTm9kZTsNCiAgICAgIGNvbnN0IHZub2RlQ2FsbCA9IGdldE1lbW9lZFZOb2RlQ2FsbChyZXQpOw0KICAgICAgaWYgKHZub2RlQ2FsbC50eXBlID09PSAxMykgew0KICAgICAgICBjb252ZXJ0VG9CbG9jayh2bm9kZUNhbGwsIGNvbnRleHQpOw0KICAgICAgfQ0KICAgICAgaW5qZWN0UHJvcCh2bm9kZUNhbGwsIGtleVByb3BlcnR5LCBjb250ZXh0KTsNCiAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KICB9DQogIGZ1bmN0aW9uIGlzU2FtZUtleShhLCBiKSB7DQogICAgaWYgKCFhIHx8IGEudHlwZSAhPT0gYi50eXBlKSB7DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KICAgIGlmIChhLnR5cGUgPT09IDYpIHsNCiAgICAgIGlmIChhLnZhbHVlLmNvbnRlbnQgIT09IGIudmFsdWUuY29udGVudCkgew0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIGNvbnN0IGV4cCA9IGEuZXhwOw0KICAgICAgY29uc3QgYnJhbmNoRXhwID0gYi5leHA7DQogICAgICBpZiAoZXhwLnR5cGUgIT09IGJyYW5jaEV4cC50eXBlKSB7DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgIH0NCiAgICAgIGlmIChleHAudHlwZSAhPT0gNCB8fCBleHAuaXNTdGF0aWMgIT09IGJyYW5jaEV4cC5pc1N0YXRpYyB8fCBleHAuY29udGVudCAhPT0gYnJhbmNoRXhwLmNvbnRlbnQpIHsNCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gdHJ1ZTsNCiAgfQ0KICBmdW5jdGlvbiBnZXRQYXJlbnRDb25kaXRpb24obm9kZSkgew0KICAgIHdoaWxlICh0cnVlKSB7DQogICAgICBpZiAobm9kZS50eXBlID09PSAxOSkgew0KICAgICAgICBpZiAobm9kZS5hbHRlcm5hdGUudHlwZSA9PT0gMTkpIHsNCiAgICAgICAgICBub2RlID0gbm9kZS5hbHRlcm5hdGU7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIG5vZGU7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSBpZiAobm9kZS50eXBlID09PSAyMCkgew0KICAgICAgICBub2RlID0gbm9kZS52YWx1ZTsNCiAgICAgIH0NCiAgICB9DQogIH0NCg0KICBjb25zdCB0cmFuc2Zvcm1CaW5kID0gKGRpciwgX25vZGUsIGNvbnRleHQpID0+IHsNCiAgICBjb25zdCB7IG1vZGlmaWVycywgbG9jIH0gPSBkaXI7DQogICAgY29uc3QgYXJnID0gZGlyLmFyZzsNCiAgICBsZXQgeyBleHAgfSA9IGRpcjsNCiAgICBpZiAoZXhwICYmIGV4cC50eXBlID09PSA0ICYmICFleHAuY29udGVudC50cmltKCkpIHsNCiAgICAgIHsNCiAgICAgICAgZXhwID0gdm9pZCAwOw0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAoIWV4cCkgew0KICAgICAgaWYgKGFyZy50eXBlICE9PSA0IHx8ICFhcmcuaXNTdGF0aWMpIHsNCiAgICAgICAgY29udGV4dC5vbkVycm9yKA0KICAgICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoDQogICAgICAgICAgICA1MiwNCiAgICAgICAgICAgIGFyZy5sb2MNCiAgICAgICAgICApDQogICAgICAgICk7DQogICAgICAgIHJldHVybiB7DQogICAgICAgICAgcHJvcHM6IFsNCiAgICAgICAgICAgIGNyZWF0ZU9iamVjdFByb3BlcnR5KGFyZywgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbigiIiwgdHJ1ZSwgbG9jKSkNCiAgICAgICAgICBdDQogICAgICAgIH07DQogICAgICB9DQogICAgICB0cmFuc2Zvcm1CaW5kU2hvcnRoYW5kKGRpcik7DQogICAgICBleHAgPSBkaXIuZXhwOw0KICAgIH0NCiAgICBpZiAoYXJnLnR5cGUgIT09IDQpIHsNCiAgICAgIGFyZy5jaGlsZHJlbi51bnNoaWZ0KGAoYCk7DQogICAgICBhcmcuY2hpbGRyZW4ucHVzaChgKSB8fCAiImApOw0KICAgIH0gZWxzZSBpZiAoIWFyZy5pc1N0YXRpYykgew0KICAgICAgYXJnLmNvbnRlbnQgPSBgJHthcmcuY29udGVudH0gfHwgIiJgOw0KICAgIH0NCiAgICBpZiAobW9kaWZpZXJzLnNvbWUoKG1vZCkgPT4gbW9kLmNvbnRlbnQgPT09ICJjYW1lbCIpKSB7DQogICAgICBpZiAoYXJnLnR5cGUgPT09IDQpIHsNCiAgICAgICAgaWYgKGFyZy5pc1N0YXRpYykgew0KICAgICAgICAgIGFyZy5jb250ZW50ID0gY2FtZWxpemUoYXJnLmNvbnRlbnQpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGFyZy5jb250ZW50ID0gYCR7Y29udGV4dC5oZWxwZXJTdHJpbmcoQ0FNRUxJWkUpfSgke2FyZy5jb250ZW50fSlgOw0KICAgICAgICB9DQogICAgICB9IGVsc2Ugew0KICAgICAgICBhcmcuY2hpbGRyZW4udW5zaGlmdChgJHtjb250ZXh0LmhlbHBlclN0cmluZyhDQU1FTElaRSl9KGApOw0KICAgICAgICBhcmcuY2hpbGRyZW4ucHVzaChgKWApOw0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAoIWNvbnRleHQuaW5TU1IpIHsNCiAgICAgIGlmIChtb2RpZmllcnMuc29tZSgobW9kKSA9PiBtb2QuY29udGVudCA9PT0gInByb3AiKSkgew0KICAgICAgICBpbmplY3RQcmVmaXgoYXJnLCAiLiIpOw0KICAgICAgfQ0KICAgICAgaWYgKG1vZGlmaWVycy5zb21lKChtb2QpID0+IG1vZC5jb250ZW50ID09PSAiYXR0ciIpKSB7DQogICAgICAgIGluamVjdFByZWZpeChhcmcsICJeIik7DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiB7DQogICAgICBwcm9wczogW2NyZWF0ZU9iamVjdFByb3BlcnR5KGFyZywgZXhwKV0NCiAgICB9Ow0KICB9Ow0KICBjb25zdCB0cmFuc2Zvcm1CaW5kU2hvcnRoYW5kID0gKGRpciwgY29udGV4dCkgPT4gew0KICAgIGNvbnN0IGFyZyA9IGRpci5hcmc7DQogICAgY29uc3QgcHJvcE5hbWUgPSBjYW1lbGl6ZShhcmcuY29udGVudCk7DQogICAgZGlyLmV4cCA9IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24ocHJvcE5hbWUsIGZhbHNlLCBhcmcubG9jKTsNCiAgfTsNCiAgY29uc3QgaW5qZWN0UHJlZml4ID0gKGFyZywgcHJlZml4KSA9PiB7DQogICAgaWYgKGFyZy50eXBlID09PSA0KSB7DQogICAgICBpZiAoYXJnLmlzU3RhdGljKSB7DQogICAgICAgIGFyZy5jb250ZW50ID0gcHJlZml4ICsgYXJnLmNvbnRlbnQ7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBhcmcuY29udGVudCA9IGBcYCR7cHJlZml4fVwkeyR7YXJnLmNvbnRlbnR9fVxgYDsNCiAgICAgIH0NCiAgICB9IGVsc2Ugew0KICAgICAgYXJnLmNoaWxkcmVuLnVuc2hpZnQoYCcke3ByZWZpeH0nICsgKGApOw0KICAgICAgYXJnLmNoaWxkcmVuLnB1c2goYClgKTsNCiAgICB9DQogIH07DQoNCiAgY29uc3QgdHJhbnNmb3JtRm9yID0gY3JlYXRlU3RydWN0dXJhbERpcmVjdGl2ZVRyYW5zZm9ybSgNCiAgICAiZm9yIiwNCiAgICAobm9kZSwgZGlyLCBjb250ZXh0KSA9PiB7DQogICAgICBjb25zdCB7IGhlbHBlciwgcmVtb3ZlSGVscGVyIH0gPSBjb250ZXh0Ow0KICAgICAgcmV0dXJuIHByb2Nlc3NGb3Iobm9kZSwgZGlyLCBjb250ZXh0LCAoZm9yTm9kZSkgPT4gew0KICAgICAgICBjb25zdCByZW5kZXJFeHAgPSBjcmVhdGVDYWxsRXhwcmVzc2lvbihoZWxwZXIoUkVOREVSX0xJU1QpLCBbDQogICAgICAgICAgZm9yTm9kZS5zb3VyY2UNCiAgICAgICAgXSk7DQogICAgICAgIGNvbnN0IGlzVGVtcGxhdGUgPSBpc1RlbXBsYXRlTm9kZShub2RlKTsNCiAgICAgICAgY29uc3QgbWVtbyA9IGZpbmREaXIobm9kZSwgIm1lbW8iKTsNCiAgICAgICAgY29uc3Qga2V5UHJvcCA9IGZpbmRQcm9wKG5vZGUsIGBrZXlgLCBmYWxzZSwgdHJ1ZSk7DQogICAgICAgIGNvbnN0IGlzRGlyS2V5ID0ga2V5UHJvcCAmJiBrZXlQcm9wLnR5cGUgPT09IDc7DQogICAgICAgIGlmIChpc0RpcktleSAmJiAha2V5UHJvcC5leHApIHsNCiAgICAgICAgICB0cmFuc2Zvcm1CaW5kU2hvcnRoYW5kKGtleVByb3ApOw0KICAgICAgICB9DQogICAgICAgIGxldCBrZXlFeHAgPSBrZXlQcm9wICYmIChrZXlQcm9wLnR5cGUgPT09IDYgPyBrZXlQcm9wLnZhbHVlID8gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihrZXlQcm9wLnZhbHVlLmNvbnRlbnQsIHRydWUpIDogdm9pZCAwIDoga2V5UHJvcC5leHApOw0KICAgICAgICBjb25zdCBrZXlQcm9wZXJ0eSA9IGtleVByb3AgJiYga2V5RXhwID8gY3JlYXRlT2JqZWN0UHJvcGVydHkoYGtleWAsIGtleUV4cCkgOiBudWxsOw0KICAgICAgICBjb25zdCBpc1N0YWJsZUZyYWdtZW50ID0gZm9yTm9kZS5zb3VyY2UudHlwZSA9PT0gNCAmJiBmb3JOb2RlLnNvdXJjZS5jb25zdFR5cGUgPiAwOw0KICAgICAgICBjb25zdCBmcmFnbWVudEZsYWcgPSBpc1N0YWJsZUZyYWdtZW50ID8gNjQgOiBrZXlQcm9wID8gMTI4IDogMjU2Ow0KICAgICAgICBmb3JOb2RlLmNvZGVnZW5Ob2RlID0gY3JlYXRlVk5vZGVDYWxsKA0KICAgICAgICAgIGNvbnRleHQsDQogICAgICAgICAgaGVscGVyKEZSQUdNRU5UKSwNCiAgICAgICAgICB2b2lkIDAsDQogICAgICAgICAgcmVuZGVyRXhwLA0KICAgICAgICAgIGZyYWdtZW50RmxhZywNCiAgICAgICAgICB2b2lkIDAsDQogICAgICAgICAgdm9pZCAwLA0KICAgICAgICAgIHRydWUsDQogICAgICAgICAgIWlzU3RhYmxlRnJhZ21lbnQsDQogICAgICAgICAgZmFsc2UsDQogICAgICAgICAgbm9kZS5sb2MNCiAgICAgICAgKTsNCiAgICAgICAgcmV0dXJuICgpID0+IHsNCiAgICAgICAgICBsZXQgY2hpbGRCbG9jazsNCiAgICAgICAgICBjb25zdCB7IGNoaWxkcmVuIH0gPSBmb3JOb2RlOw0KICAgICAgICAgIGlmIChpc1RlbXBsYXRlKSB7DQogICAgICAgICAgICBub2RlLmNoaWxkcmVuLnNvbWUoKGMpID0+IHsNCiAgICAgICAgICAgICAgaWYgKGMudHlwZSA9PT0gMSkgew0KICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IGZpbmRQcm9wKGMsICJrZXkiKTsNCiAgICAgICAgICAgICAgICBpZiAoa2V5KSB7DQogICAgICAgICAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoDQogICAgICAgICAgICAgICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoDQogICAgICAgICAgICAgICAgICAgICAgMzMsDQogICAgICAgICAgICAgICAgICAgICAga2V5LmxvYw0KICAgICAgICAgICAgICAgICAgICApDQogICAgICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICB9DQogICAgICAgICAgY29uc3QgbmVlZEZyYWdtZW50V3JhcHBlciA9IGNoaWxkcmVuLmxlbmd0aCAhPT0gMSB8fCBjaGlsZHJlblswXS50eXBlICE9PSAxOw0KICAgICAgICAgIGNvbnN0IHNsb3RPdXRsZXQgPSBpc1Nsb3RPdXRsZXQobm9kZSkgPyBub2RlIDogaXNUZW1wbGF0ZSAmJiBub2RlLmNoaWxkcmVuLmxlbmd0aCA9PT0gMSAmJiBpc1Nsb3RPdXRsZXQobm9kZS5jaGlsZHJlblswXSkgPyBub2RlLmNoaWxkcmVuWzBdIDogbnVsbDsNCiAgICAgICAgICBpZiAoc2xvdE91dGxldCkgew0KICAgICAgICAgICAgY2hpbGRCbG9jayA9IHNsb3RPdXRsZXQuY29kZWdlbk5vZGU7DQogICAgICAgICAgICBpZiAoaXNUZW1wbGF0ZSAmJiBrZXlQcm9wZXJ0eSkgew0KICAgICAgICAgICAgICBpbmplY3RQcm9wKGNoaWxkQmxvY2ssIGtleVByb3BlcnR5LCBjb250ZXh0KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9IGVsc2UgaWYgKG5lZWRGcmFnbWVudFdyYXBwZXIpIHsNCiAgICAgICAgICAgIGNoaWxkQmxvY2sgPSBjcmVhdGVWTm9kZUNhbGwoDQogICAgICAgICAgICAgIGNvbnRleHQsDQogICAgICAgICAgICAgIGhlbHBlcihGUkFHTUVOVCksDQogICAgICAgICAgICAgIGtleVByb3BlcnR5ID8gY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihba2V5UHJvcGVydHldKSA6IHZvaWQgMCwNCiAgICAgICAgICAgICAgbm9kZS5jaGlsZHJlbiwNCiAgICAgICAgICAgICAgNjQsDQogICAgICAgICAgICAgIHZvaWQgMCwNCiAgICAgICAgICAgICAgdm9pZCAwLA0KICAgICAgICAgICAgICB0cnVlLA0KICAgICAgICAgICAgICB2b2lkIDAsDQogICAgICAgICAgICAgIGZhbHNlDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBjaGlsZEJsb2NrID0gY2hpbGRyZW5bMF0uY29kZWdlbk5vZGU7DQogICAgICAgICAgICBpZiAoaXNUZW1wbGF0ZSAmJiBrZXlQcm9wZXJ0eSkgew0KICAgICAgICAgICAgICBpbmplY3RQcm9wKGNoaWxkQmxvY2ssIGtleVByb3BlcnR5LCBjb250ZXh0KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChjaGlsZEJsb2NrLmlzQmxvY2sgIT09ICFpc1N0YWJsZUZyYWdtZW50KSB7DQogICAgICAgICAgICAgIGlmIChjaGlsZEJsb2NrLmlzQmxvY2spIHsNCiAgICAgICAgICAgICAgICByZW1vdmVIZWxwZXIoT1BFTl9CTE9DSyk7DQogICAgICAgICAgICAgICAgcmVtb3ZlSGVscGVyKA0KICAgICAgICAgICAgICAgICAgZ2V0Vk5vZGVCbG9ja0hlbHBlcihjb250ZXh0LmluU1NSLCBjaGlsZEJsb2NrLmlzQ29tcG9uZW50KQ0KICAgICAgICAgICAgICAgICk7DQogICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgcmVtb3ZlSGVscGVyKA0KICAgICAgICAgICAgICAgICAgZ2V0Vk5vZGVIZWxwZXIoY29udGV4dC5pblNTUiwgY2hpbGRCbG9jay5pc0NvbXBvbmVudCkNCiAgICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjaGlsZEJsb2NrLmlzQmxvY2sgPSAhaXNTdGFibGVGcmFnbWVudDsNCiAgICAgICAgICAgIGlmIChjaGlsZEJsb2NrLmlzQmxvY2spIHsNCiAgICAgICAgICAgICAgaGVscGVyKE9QRU5fQkxPQ0spOw0KICAgICAgICAgICAgICBoZWxwZXIoZ2V0Vk5vZGVCbG9ja0hlbHBlcihjb250ZXh0LmluU1NSLCBjaGlsZEJsb2NrLmlzQ29tcG9uZW50KSk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICBoZWxwZXIoZ2V0Vk5vZGVIZWxwZXIoY29udGV4dC5pblNTUiwgY2hpbGRCbG9jay5pc0NvbXBvbmVudCkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgICBpZiAobWVtbykgew0KICAgICAgICAgICAgY29uc3QgbG9vcCA9IGNyZWF0ZUZ1bmN0aW9uRXhwcmVzc2lvbigNCiAgICAgICAgICAgICAgY3JlYXRlRm9yTG9vcFBhcmFtcyhmb3JOb2RlLnBhcnNlUmVzdWx0LCBbDQogICAgICAgICAgICAgICAgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgX2NhY2hlZGApDQogICAgICAgICAgICAgIF0pDQogICAgICAgICAgICApOw0KICAgICAgICAgICAgbG9vcC5ib2R5ID0gY3JlYXRlQmxvY2tTdGF0ZW1lbnQoWw0KICAgICAgICAgICAgICBjcmVhdGVDb21wb3VuZEV4cHJlc3Npb24oW2Bjb25zdCBfbWVtbyA9IChgLCBtZW1vLmV4cCwgYClgXSksDQogICAgICAgICAgICAgIGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbihbDQogICAgICAgICAgICAgICAgYGlmIChfY2FjaGVkYCwNCiAgICAgICAgICAgICAgICAuLi5rZXlFeHAgPyBbYCAmJiBfY2FjaGVkLmtleSA9PT0gYCwga2V5RXhwXSA6IFtdLA0KICAgICAgICAgICAgICAgIGAgJiYgJHtjb250ZXh0LmhlbHBlclN0cmluZygNCiAgICAgICAgICAgICAgICBJU19NRU1PX1NBTUUNCiAgICAgICAgICAgICAgKX0oX2NhY2hlZCwgX21lbW8pKSByZXR1cm4gX2NhY2hlZGANCiAgICAgICAgICAgICAgXSksDQogICAgICAgICAgICAgIGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbihbYGNvbnN0IF9pdGVtID0gYCwgY2hpbGRCbG9ja10pLA0KICAgICAgICAgICAgICBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGBfaXRlbS5tZW1vID0gX21lbW9gKSwNCiAgICAgICAgICAgICAgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgcmV0dXJuIF9pdGVtYCkNCiAgICAgICAgICAgIF0pOw0KICAgICAgICAgICAgcmVuZGVyRXhwLmFyZ3VtZW50cy5wdXNoKA0KICAgICAgICAgICAgICBsb29wLA0KICAgICAgICAgICAgICBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGBfY2FjaGVgKSwNCiAgICAgICAgICAgICAgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihTdHJpbmcoY29udGV4dC5jYWNoZWQubGVuZ3RoKSkNCiAgICAgICAgICAgICk7DQogICAgICAgICAgICBjb250ZXh0LmNhY2hlZC5wdXNoKG51bGwpOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICByZW5kZXJFeHAuYXJndW1lbnRzLnB1c2goDQogICAgICAgICAgICAgIGNyZWF0ZUZ1bmN0aW9uRXhwcmVzc2lvbigNCiAgICAgICAgICAgICAgICBjcmVhdGVGb3JMb29wUGFyYW1zKGZvck5vZGUucGFyc2VSZXN1bHQpLA0KICAgICAgICAgICAgICAgIGNoaWxkQmxvY2ssDQogICAgICAgICAgICAgICAgdHJ1ZQ0KICAgICAgICAgICAgICApDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICAgIH0pOw0KICAgIH0NCiAgKTsNCiAgZnVuY3Rpb24gcHJvY2Vzc0Zvcihub2RlLCBkaXIsIGNvbnRleHQsIHByb2Nlc3NDb2RlZ2VuKSB7DQogICAgaWYgKCFkaXIuZXhwKSB7DQogICAgICBjb250ZXh0Lm9uRXJyb3IoDQogICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoMzEsIGRpci5sb2MpDQogICAgICApOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBjb25zdCBwYXJzZVJlc3VsdCA9IGRpci5mb3JQYXJzZVJlc3VsdDsNCiAgICBpZiAoIXBhcnNlUmVzdWx0KSB7DQogICAgICBjb250ZXh0Lm9uRXJyb3IoDQogICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoMzIsIGRpci5sb2MpDQogICAgICApOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBmaW5hbGl6ZUZvclBhcnNlUmVzdWx0KHBhcnNlUmVzdWx0LCBjb250ZXh0KTsNCiAgICBjb25zdCB7IGFkZElkZW50aWZpZXJzLCByZW1vdmVJZGVudGlmaWVycywgc2NvcGVzIH0gPSBjb250ZXh0Ow0KICAgIGNvbnN0IHsgc291cmNlLCB2YWx1ZSwga2V5LCBpbmRleCB9ID0gcGFyc2VSZXN1bHQ7DQogICAgY29uc3QgZm9yTm9kZSA9IHsNCiAgICAgIHR5cGU6IDExLA0KICAgICAgbG9jOiBkaXIubG9jLA0KICAgICAgc291cmNlLA0KICAgICAgdmFsdWVBbGlhczogdmFsdWUsDQogICAgICBrZXlBbGlhczoga2V5LA0KICAgICAgb2JqZWN0SW5kZXhBbGlhczogaW5kZXgsDQogICAgICBwYXJzZVJlc3VsdCwNCiAgICAgIGNoaWxkcmVuOiBpc1RlbXBsYXRlTm9kZShub2RlKSA/IG5vZGUuY2hpbGRyZW4gOiBbbm9kZV0NCiAgICB9Ow0KICAgIGNvbnRleHQucmVwbGFjZU5vZGUoZm9yTm9kZSk7DQogICAgc2NvcGVzLnZGb3IrKzsNCiAgICBjb25zdCBvbkV4aXQgPSBwcm9jZXNzQ29kZWdlbiAmJiBwcm9jZXNzQ29kZWdlbihmb3JOb2RlKTsNCiAgICByZXR1cm4gKCkgPT4gew0KICAgICAgc2NvcGVzLnZGb3ItLTsNCiAgICAgIGlmIChvbkV4aXQpIG9uRXhpdCgpOw0KICAgIH07DQogIH0NCiAgZnVuY3Rpb24gZmluYWxpemVGb3JQYXJzZVJlc3VsdChyZXN1bHQsIGNvbnRleHQpIHsNCiAgICBpZiAocmVzdWx0LmZpbmFsaXplZCkgcmV0dXJuOw0KICAgIHsNCiAgICAgIHZhbGlkYXRlQnJvd3NlckV4cHJlc3Npb24ocmVzdWx0LnNvdXJjZSwgY29udGV4dCk7DQogICAgICBpZiAocmVzdWx0LmtleSkgew0KICAgICAgICB2YWxpZGF0ZUJyb3dzZXJFeHByZXNzaW9uKA0KICAgICAgICAgIHJlc3VsdC5rZXksDQogICAgICAgICAgY29udGV4dCwNCiAgICAgICAgICB0cnVlDQogICAgICAgICk7DQogICAgICB9DQogICAgICBpZiAocmVzdWx0LmluZGV4KSB7DQogICAgICAgIHZhbGlkYXRlQnJvd3NlckV4cHJlc3Npb24oDQogICAgICAgICAgcmVzdWx0LmluZGV4LA0KICAgICAgICAgIGNvbnRleHQsDQogICAgICAgICAgdHJ1ZQ0KICAgICAgICApOw0KICAgICAgfQ0KICAgICAgaWYgKHJlc3VsdC52YWx1ZSkgew0KICAgICAgICB2YWxpZGF0ZUJyb3dzZXJFeHByZXNzaW9uKA0KICAgICAgICAgIHJlc3VsdC52YWx1ZSwNCiAgICAgICAgICBjb250ZXh0LA0KICAgICAgICAgIHRydWUNCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICB9DQogICAgcmVzdWx0LmZpbmFsaXplZCA9IHRydWU7DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlRm9yTG9vcFBhcmFtcyh7IHZhbHVlLCBrZXksIGluZGV4IH0sIG1lbW9BcmdzID0gW10pIHsNCiAgICByZXR1cm4gY3JlYXRlUGFyYW1zTGlzdChbdmFsdWUsIGtleSwgaW5kZXgsIC4uLm1lbW9BcmdzXSk7DQogIH0NCiAgZnVuY3Rpb24gY3JlYXRlUGFyYW1zTGlzdChhcmdzKSB7DQogICAgbGV0IGkgPSBhcmdzLmxlbmd0aDsNCiAgICB3aGlsZSAoaS0tKSB7DQogICAgICBpZiAoYXJnc1tpXSkgYnJlYWs7DQogICAgfQ0KICAgIHJldHVybiBhcmdzLnNsaWNlKDAsIGkgKyAxKS5tYXAoKGFyZywgaTIpID0+IGFyZyB8fCBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGBfYC5yZXBlYXQoaTIgKyAxKSwgZmFsc2UpKTsNCiAgfQ0KDQogIGNvbnN0IGRlZmF1bHRGYWxsYmFjayA9IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oYHVuZGVmaW5lZGAsIGZhbHNlKTsNCiAgY29uc3QgdHJhY2tTbG90U2NvcGVzID0gKG5vZGUsIGNvbnRleHQpID0+IHsNCiAgICBpZiAobm9kZS50eXBlID09PSAxICYmIChub2RlLnRhZ1R5cGUgPT09IDEgfHwgbm9kZS50YWdUeXBlID09PSAzKSkgew0KICAgICAgY29uc3QgdlNsb3QgPSBmaW5kRGlyKG5vZGUsICJzbG90Iik7DQogICAgICBpZiAodlNsb3QpIHsNCiAgICAgICAgdlNsb3QuZXhwOw0KICAgICAgICBjb250ZXh0LnNjb3Blcy52U2xvdCsrOw0KICAgICAgICByZXR1cm4gKCkgPT4gew0KICAgICAgICAgIGNvbnRleHQuc2NvcGVzLnZTbG90LS07DQogICAgICAgIH07DQogICAgICB9DQogICAgfQ0KICB9Ow0KICBjb25zdCBidWlsZENsaWVudFNsb3RGbiA9IChwcm9wcywgX3ZGb3JFeHAsIGNoaWxkcmVuLCBsb2MpID0+IGNyZWF0ZUZ1bmN0aW9uRXhwcmVzc2lvbigNCiAgICBwcm9wcywNCiAgICBjaGlsZHJlbiwNCiAgICBmYWxzZSwNCiAgICB0cnVlLA0KICAgIGNoaWxkcmVuLmxlbmd0aCA/IGNoaWxkcmVuWzBdLmxvYyA6IGxvYw0KICApOw0KICBmdW5jdGlvbiBidWlsZFNsb3RzKG5vZGUsIGNvbnRleHQsIGJ1aWxkU2xvdEZuID0gYnVpbGRDbGllbnRTbG90Rm4pIHsNCiAgICBjb250ZXh0LmhlbHBlcihXSVRIX0NUWCk7DQogICAgY29uc3QgeyBjaGlsZHJlbiwgbG9jIH0gPSBub2RlOw0KICAgIGNvbnN0IHNsb3RzUHJvcGVydGllcyA9IFtdOw0KICAgIGNvbnN0IGR5bmFtaWNTbG90cyA9IFtdOw0KICAgIGxldCBoYXNEeW5hbWljU2xvdHMgPSBjb250ZXh0LnNjb3Blcy52U2xvdCA+IDAgfHwgY29udGV4dC5zY29wZXMudkZvciA+IDA7DQogICAgY29uc3Qgb25Db21wb25lbnRTbG90ID0gZmluZERpcihub2RlLCAic2xvdCIsIHRydWUpOw0KICAgIGlmIChvbkNvbXBvbmVudFNsb3QpIHsNCiAgICAgIGNvbnN0IHsgYXJnLCBleHAgfSA9IG9uQ29tcG9uZW50U2xvdDsNCiAgICAgIGlmIChhcmcgJiYgIWlzU3RhdGljRXhwKGFyZykpIHsNCiAgICAgICAgaGFzRHluYW1pY1Nsb3RzID0gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIHNsb3RzUHJvcGVydGllcy5wdXNoKA0KICAgICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eSgNCiAgICAgICAgICBhcmcgfHwgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbigiZGVmYXVsdCIsIHRydWUpLA0KICAgICAgICAgIGJ1aWxkU2xvdEZuKGV4cCwgdm9pZCAwLCBjaGlsZHJlbiwgbG9jKQ0KICAgICAgICApDQogICAgICApOw0KICAgIH0NCiAgICBsZXQgaGFzVGVtcGxhdGVTbG90cyA9IGZhbHNlOw0KICAgIGxldCBoYXNOYW1lZERlZmF1bHRTbG90ID0gZmFsc2U7DQogICAgY29uc3QgaW1wbGljaXREZWZhdWx0Q2hpbGRyZW4gPSBbXTsNCiAgICBjb25zdCBzZWVuU2xvdE5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsNCiAgICBsZXQgY29uZGl0aW9uYWxCcmFuY2hJbmRleCA9IDA7DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgew0KICAgICAgY29uc3Qgc2xvdEVsZW1lbnQgPSBjaGlsZHJlbltpXTsNCiAgICAgIGxldCBzbG90RGlyOw0KICAgICAgaWYgKCFpc1RlbXBsYXRlTm9kZShzbG90RWxlbWVudCkgfHwgIShzbG90RGlyID0gZmluZERpcihzbG90RWxlbWVudCwgInNsb3QiLCB0cnVlKSkpIHsNCiAgICAgICAgaWYgKHNsb3RFbGVtZW50LnR5cGUgIT09IDMpIHsNCiAgICAgICAgICBpbXBsaWNpdERlZmF1bHRDaGlsZHJlbi5wdXNoKHNsb3RFbGVtZW50KTsNCiAgICAgICAgfQ0KICAgICAgICBjb250aW51ZTsNCiAgICAgIH0NCiAgICAgIGlmIChvbkNvbXBvbmVudFNsb3QpIHsNCiAgICAgICAgY29udGV4dC5vbkVycm9yKA0KICAgICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoMzcsIHNsb3REaXIubG9jKQ0KICAgICAgICApOw0KICAgICAgICBicmVhazsNCiAgICAgIH0NCiAgICAgIGhhc1RlbXBsYXRlU2xvdHMgPSB0cnVlOw0KICAgICAgY29uc3QgeyBjaGlsZHJlbjogc2xvdENoaWxkcmVuLCBsb2M6IHNsb3RMb2MgfSA9IHNsb3RFbGVtZW50Ow0KICAgICAgY29uc3Qgew0KICAgICAgICBhcmc6IHNsb3ROYW1lID0gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgZGVmYXVsdGAsIHRydWUpLA0KICAgICAgICBleHA6IHNsb3RQcm9wcywNCiAgICAgICAgbG9jOiBkaXJMb2MNCiAgICAgIH0gPSBzbG90RGlyOw0KICAgICAgbGV0IHN0YXRpY1Nsb3ROYW1lOw0KICAgICAgaWYgKGlzU3RhdGljRXhwKHNsb3ROYW1lKSkgew0KICAgICAgICBzdGF0aWNTbG90TmFtZSA9IHNsb3ROYW1lID8gc2xvdE5hbWUuY29udGVudCA6IGBkZWZhdWx0YDsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGhhc0R5bmFtaWNTbG90cyA9IHRydWU7DQogICAgICB9DQogICAgICBjb25zdCB2Rm9yID0gZmluZERpcihzbG90RWxlbWVudCwgImZvciIpOw0KICAgICAgY29uc3Qgc2xvdEZ1bmN0aW9uID0gYnVpbGRTbG90Rm4oc2xvdFByb3BzLCB2Rm9yLCBzbG90Q2hpbGRyZW4sIHNsb3RMb2MpOw0KICAgICAgbGV0IHZJZjsNCiAgICAgIGxldCB2RWxzZTsNCiAgICAgIGlmICh2SWYgPSBmaW5kRGlyKHNsb3RFbGVtZW50LCAiaWYiKSkgew0KICAgICAgICBoYXNEeW5hbWljU2xvdHMgPSB0cnVlOw0KICAgICAgICBkeW5hbWljU2xvdHMucHVzaCgNCiAgICAgICAgICBjcmVhdGVDb25kaXRpb25hbEV4cHJlc3Npb24oDQogICAgICAgICAgICB2SWYuZXhwLA0KICAgICAgICAgICAgYnVpbGREeW5hbWljU2xvdChzbG90TmFtZSwgc2xvdEZ1bmN0aW9uLCBjb25kaXRpb25hbEJyYW5jaEluZGV4KyspLA0KICAgICAgICAgICAgZGVmYXVsdEZhbGxiYWNrDQogICAgICAgICAgKQ0KICAgICAgICApOw0KICAgICAgfSBlbHNlIGlmICh2RWxzZSA9IGZpbmREaXIoDQogICAgICAgIHNsb3RFbGVtZW50LA0KICAgICAgICAvXmVsc2UoLWlmKT8kLywNCiAgICAgICAgdHJ1ZQ0KICAgICAgICAvKiBhbGxvd0VtcHR5ICovDQogICAgICApKSB7DQogICAgICAgIGxldCBqID0gaTsNCiAgICAgICAgbGV0IHByZXY7DQogICAgICAgIHdoaWxlIChqLS0pIHsNCiAgICAgICAgICBwcmV2ID0gY2hpbGRyZW5bal07DQogICAgICAgICAgaWYgKHByZXYudHlwZSAhPT0gMyAmJiBpc05vbldoaXRlc3BhY2VDb250ZW50KHByZXYpKSB7DQogICAgICAgICAgICBicmVhazsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgaWYgKHByZXYgJiYgaXNUZW1wbGF0ZU5vZGUocHJldikgJiYgZmluZERpcihwcmV2LCAvXihlbHNlLSk/aWYkLykpIHsNCiAgICAgICAgICBsZXQgY29uZGl0aW9uYWwgPSBkeW5hbWljU2xvdHNbZHluYW1pY1Nsb3RzLmxlbmd0aCAtIDFdOw0KICAgICAgICAgIHdoaWxlIChjb25kaXRpb25hbC5hbHRlcm5hdGUudHlwZSA9PT0gMTkpIHsNCiAgICAgICAgICAgIGNvbmRpdGlvbmFsID0gY29uZGl0aW9uYWwuYWx0ZXJuYXRlOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjb25kaXRpb25hbC5hbHRlcm5hdGUgPSB2RWxzZS5leHAgPyBjcmVhdGVDb25kaXRpb25hbEV4cHJlc3Npb24oDQogICAgICAgICAgICB2RWxzZS5leHAsDQogICAgICAgICAgICBidWlsZER5bmFtaWNTbG90KA0KICAgICAgICAgICAgICBzbG90TmFtZSwNCiAgICAgICAgICAgICAgc2xvdEZ1bmN0aW9uLA0KICAgICAgICAgICAgICBjb25kaXRpb25hbEJyYW5jaEluZGV4KysNCiAgICAgICAgICAgICksDQogICAgICAgICAgICBkZWZhdWx0RmFsbGJhY2sNCiAgICAgICAgICApIDogYnVpbGREeW5hbWljU2xvdChzbG90TmFtZSwgc2xvdEZ1bmN0aW9uLCBjb25kaXRpb25hbEJyYW5jaEluZGV4KyspOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGNvbnRleHQub25FcnJvcigNCiAgICAgICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoMzAsIHZFbHNlLmxvYykNCiAgICAgICAgICApOw0KICAgICAgICB9DQogICAgICB9IGVsc2UgaWYgKHZGb3IpIHsNCiAgICAgICAgaGFzRHluYW1pY1Nsb3RzID0gdHJ1ZTsNCiAgICAgICAgY29uc3QgcGFyc2VSZXN1bHQgPSB2Rm9yLmZvclBhcnNlUmVzdWx0Ow0KICAgICAgICBpZiAocGFyc2VSZXN1bHQpIHsNCiAgICAgICAgICBmaW5hbGl6ZUZvclBhcnNlUmVzdWx0KHBhcnNlUmVzdWx0LCBjb250ZXh0KTsNCiAgICAgICAgICBkeW5hbWljU2xvdHMucHVzaCgNCiAgICAgICAgICAgIGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKFJFTkRFUl9MSVNUKSwgWw0KICAgICAgICAgICAgICBwYXJzZVJlc3VsdC5zb3VyY2UsDQogICAgICAgICAgICAgIGNyZWF0ZUZ1bmN0aW9uRXhwcmVzc2lvbigNCiAgICAgICAgICAgICAgICBjcmVhdGVGb3JMb29wUGFyYW1zKHBhcnNlUmVzdWx0KSwNCiAgICAgICAgICAgICAgICBidWlsZER5bmFtaWNTbG90KHNsb3ROYW1lLCBzbG90RnVuY3Rpb24pLA0KICAgICAgICAgICAgICAgIHRydWUNCiAgICAgICAgICAgICAgKQ0KICAgICAgICAgICAgXSkNCiAgICAgICAgICApOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGNvbnRleHQub25FcnJvcigNCiAgICAgICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoDQogICAgICAgICAgICAgIDMyLA0KICAgICAgICAgICAgICB2Rm9yLmxvYw0KICAgICAgICAgICAgKQ0KICAgICAgICAgICk7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGlmIChzdGF0aWNTbG90TmFtZSkgew0KICAgICAgICAgIGlmIChzZWVuU2xvdE5hbWVzLmhhcyhzdGF0aWNTbG90TmFtZSkpIHsNCiAgICAgICAgICAgIGNvbnRleHQub25FcnJvcigNCiAgICAgICAgICAgICAgY3JlYXRlQ29tcGlsZXJFcnJvcigNCiAgICAgICAgICAgICAgICAzOCwNCiAgICAgICAgICAgICAgICBkaXJMb2MNCiAgICAgICAgICAgICAgKQ0KICAgICAgICAgICAgKTsNCiAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgIH0NCiAgICAgICAgICBzZWVuU2xvdE5hbWVzLmFkZChzdGF0aWNTbG90TmFtZSk7DQogICAgICAgICAgaWYgKHN0YXRpY1Nsb3ROYW1lID09PSAiZGVmYXVsdCIpIHsNCiAgICAgICAgICAgIGhhc05hbWVkRGVmYXVsdFNsb3QgPSB0cnVlOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBzbG90c1Byb3BlcnRpZXMucHVzaChjcmVhdGVPYmplY3RQcm9wZXJ0eShzbG90TmFtZSwgc2xvdEZ1bmN0aW9uKSk7DQogICAgICB9DQogICAgfQ0KICAgIGlmICghb25Db21wb25lbnRTbG90KSB7DQogICAgICBjb25zdCBidWlsZERlZmF1bHRTbG90UHJvcGVydHkgPSAocHJvcHMsIGNoaWxkcmVuMikgPT4gew0KICAgICAgICBjb25zdCBmbiA9IGJ1aWxkU2xvdEZuKHByb3BzLCB2b2lkIDAsIGNoaWxkcmVuMiwgbG9jKTsNCiAgICAgICAgcmV0dXJuIGNyZWF0ZU9iamVjdFByb3BlcnR5KGBkZWZhdWx0YCwgZm4pOw0KICAgICAgfTsNCiAgICAgIGlmICghaGFzVGVtcGxhdGVTbG90cykgew0KICAgICAgICBzbG90c1Byb3BlcnRpZXMucHVzaChidWlsZERlZmF1bHRTbG90UHJvcGVydHkodm9pZCAwLCBjaGlsZHJlbikpOw0KICAgICAgfSBlbHNlIGlmIChpbXBsaWNpdERlZmF1bHRDaGlsZHJlbi5sZW5ndGggJiYgLy8gIzM3NjYNCiAgICAgIC8vIHdpdGggd2hpdGVzcGFjZTogJ3ByZXNlcnZlJywgd2hpdGVzcGFjZXMgYmV0d2VlbiBzbG90cyB3aWxsIGVuZCB1cCBpbg0KICAgICAgLy8gaW1wbGljaXREZWZhdWx0Q2hpbGRyZW4uIElnbm9yZSBpZiBhbGwgaW1wbGljaXQgY2hpbGRyZW4gYXJlIHdoaXRlc3BhY2VzLg0KICAgICAgaW1wbGljaXREZWZhdWx0Q2hpbGRyZW4uc29tZSgobm9kZTIpID0+IGlzTm9uV2hpdGVzcGFjZUNvbnRlbnQobm9kZTIpKSkgew0KICAgICAgICBpZiAoaGFzTmFtZWREZWZhdWx0U2xvdCkgew0KICAgICAgICAgIGNvbnRleHQub25FcnJvcigNCiAgICAgICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoDQogICAgICAgICAgICAgIDM5LA0KICAgICAgICAgICAgICBpbXBsaWNpdERlZmF1bHRDaGlsZHJlblswXS5sb2MNCiAgICAgICAgICAgICkNCiAgICAgICAgICApOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHNsb3RzUHJvcGVydGllcy5wdXNoKA0KICAgICAgICAgICAgYnVpbGREZWZhdWx0U2xvdFByb3BlcnR5KHZvaWQgMCwgaW1wbGljaXREZWZhdWx0Q2hpbGRyZW4pDQogICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICBjb25zdCBzbG90RmxhZyA9IGhhc0R5bmFtaWNTbG90cyA/IDIgOiBoYXNGb3J3YXJkZWRTbG90cyhub2RlLmNoaWxkcmVuKSA/IDMgOiAxOw0KICAgIGxldCBzbG90cyA9IGNyZWF0ZU9iamVjdEV4cHJlc3Npb24oDQogICAgICBzbG90c1Byb3BlcnRpZXMuY29uY2F0KA0KICAgICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eSgNCiAgICAgICAgICBgX2AsDQogICAgICAgICAgLy8gMiA9IGNvbXBpbGVkIGJ1dCBkeW5hbWljID0gY2FuIHNraXAgbm9ybWFsaXphdGlvbiwgYnV0IG11c3QgcnVuIGRpZmYNCiAgICAgICAgICAvLyAxID0gY29tcGlsZWQgYW5kIHN0YXRpYyA9IGNhbiBza2lwIG5vcm1hbGl6YXRpb24gQU5EIGRpZmYgYXMgb3B0aW1pemVkDQogICAgICAgICAgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbigNCiAgICAgICAgICAgIHNsb3RGbGFnICsgKGAgLyogJHtzbG90RmxhZ3NUZXh0W3Nsb3RGbGFnXX0gKi9gICksDQogICAgICAgICAgICBmYWxzZQ0KICAgICAgICAgICkNCiAgICAgICAgKQ0KICAgICAgKSwNCiAgICAgIGxvYw0KICAgICk7DQogICAgaWYgKGR5bmFtaWNTbG90cy5sZW5ndGgpIHsNCiAgICAgIHNsb3RzID0gY3JlYXRlQ2FsbEV4cHJlc3Npb24oY29udGV4dC5oZWxwZXIoQ1JFQVRFX1NMT1RTKSwgWw0KICAgICAgICBzbG90cywNCiAgICAgICAgY3JlYXRlQXJyYXlFeHByZXNzaW9uKGR5bmFtaWNTbG90cykNCiAgICAgIF0pOw0KICAgIH0NCiAgICByZXR1cm4gew0KICAgICAgc2xvdHMsDQogICAgICBoYXNEeW5hbWljU2xvdHMNCiAgICB9Ow0KICB9DQogIGZ1bmN0aW9uIGJ1aWxkRHluYW1pY1Nsb3QobmFtZSwgZm4sIGluZGV4KSB7DQogICAgY29uc3QgcHJvcHMgPSBbDQogICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eShgbmFtZWAsIG5hbWUpLA0KICAgICAgY3JlYXRlT2JqZWN0UHJvcGVydHkoYGZuYCwgZm4pDQogICAgXTsNCiAgICBpZiAoaW5kZXggIT0gbnVsbCkgew0KICAgICAgcHJvcHMucHVzaCgNCiAgICAgICAgY3JlYXRlT2JqZWN0UHJvcGVydHkoYGtleWAsIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oU3RyaW5nKGluZGV4KSwgdHJ1ZSkpDQogICAgICApOw0KICAgIH0NCiAgICByZXR1cm4gY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihwcm9wcyk7DQogIH0NCiAgZnVuY3Rpb24gaGFzRm9yd2FyZGVkU2xvdHMoY2hpbGRyZW4pIHsNCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7DQogICAgICBjb25zdCBjaGlsZCA9IGNoaWxkcmVuW2ldOw0KICAgICAgc3dpdGNoIChjaGlsZC50eXBlKSB7DQogICAgICAgIGNhc2UgMToNCiAgICAgICAgICBpZiAoY2hpbGQudGFnVHlwZSA9PT0gMiB8fCBoYXNGb3J3YXJkZWRTbG90cyhjaGlsZC5jaGlsZHJlbikpIHsNCiAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICAgIH0NCiAgICAgICAgICBicmVhazsNCiAgICAgICAgY2FzZSA5Og0KICAgICAgICAgIGlmIChoYXNGb3J3YXJkZWRTbG90cyhjaGlsZC5icmFuY2hlcykpIHJldHVybiB0cnVlOw0KICAgICAgICAgIGJyZWFrOw0KICAgICAgICBjYXNlIDEwOg0KICAgICAgICBjYXNlIDExOg0KICAgICAgICAgIGlmIChoYXNGb3J3YXJkZWRTbG90cyhjaGlsZC5jaGlsZHJlbikpIHJldHVybiB0cnVlOw0KICAgICAgICAgIGJyZWFrOw0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gZmFsc2U7DQogIH0NCiAgZnVuY3Rpb24gaXNOb25XaGl0ZXNwYWNlQ29udGVudChub2RlKSB7DQogICAgaWYgKG5vZGUudHlwZSAhPT0gMiAmJiBub2RlLnR5cGUgIT09IDEyKQ0KICAgICAgcmV0dXJuIHRydWU7DQogICAgcmV0dXJuIG5vZGUudHlwZSA9PT0gMiA/ICEhbm9kZS5jb250ZW50LnRyaW0oKSA6IGlzTm9uV2hpdGVzcGFjZUNvbnRlbnQobm9kZS5jb250ZW50KTsNCiAgfQ0KDQogIGNvbnN0IGRpcmVjdGl2ZUltcG9ydE1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOw0KICBjb25zdCB0cmFuc2Zvcm1FbGVtZW50ID0gKG5vZGUsIGNvbnRleHQpID0+IHsNCiAgICByZXR1cm4gZnVuY3Rpb24gcG9zdFRyYW5zZm9ybUVsZW1lbnQoKSB7DQogICAgICBub2RlID0gY29udGV4dC5jdXJyZW50Tm9kZTsNCiAgICAgIGlmICghKG5vZGUudHlwZSA9PT0gMSAmJiAobm9kZS50YWdUeXBlID09PSAwIHx8IG5vZGUudGFnVHlwZSA9PT0gMSkpKSB7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIGNvbnN0IHsgdGFnLCBwcm9wcyB9ID0gbm9kZTsNCiAgICAgIGNvbnN0IGlzQ29tcG9uZW50ID0gbm9kZS50YWdUeXBlID09PSAxOw0KICAgICAgbGV0IHZub2RlVGFnID0gaXNDb21wb25lbnQgPyByZXNvbHZlQ29tcG9uZW50VHlwZShub2RlLCBjb250ZXh0KSA6IGAiJHt0YWd9ImA7DQogICAgICBjb25zdCBpc0R5bmFtaWNDb21wb25lbnQgPSBpc09iamVjdCh2bm9kZVRhZykgJiYgdm5vZGVUYWcuY2FsbGVlID09PSBSRVNPTFZFX0RZTkFNSUNfQ09NUE9ORU5UOw0KICAgICAgbGV0IHZub2RlUHJvcHM7DQogICAgICBsZXQgdm5vZGVDaGlsZHJlbjsNCiAgICAgIGxldCBwYXRjaEZsYWcgPSAwOw0KICAgICAgbGV0IHZub2RlRHluYW1pY1Byb3BzOw0KICAgICAgbGV0IGR5bmFtaWNQcm9wTmFtZXM7DQogICAgICBsZXQgdm5vZGVEaXJlY3RpdmVzOw0KICAgICAgbGV0IHNob3VsZFVzZUJsb2NrID0gKA0KICAgICAgICAvLyBkeW5hbWljIGNvbXBvbmVudCBtYXkgcmVzb2x2ZSB0byBwbGFpbiBlbGVtZW50cw0KICAgICAgICBpc0R5bmFtaWNDb21wb25lbnQgfHwgdm5vZGVUYWcgPT09IFRFTEVQT1JUIHx8IHZub2RlVGFnID09PSBTVVNQRU5TRSB8fCAhaXNDb21wb25lbnQgJiYgLy8gPHN2Zz4gYW5kIDxmb3JlaWduT2JqZWN0PiBtdXN0IGJlIGZvcmNlZCBpbnRvIGJsb2NrcyBzbyB0aGF0IGJsb2NrDQogICAgICAgIC8vIHVwZGF0ZXMgaW5zaWRlIGdldCBwcm9wZXIgaXNTVkcgZmxhZyBhdCBydW50aW1lLiAoIzYzOSwgIzY0MykNCiAgICAgICAgLy8gVGhpcyBpcyB0ZWNobmljYWxseSB3ZWItc3BlY2lmaWMsIGJ1dCBzcGxpdHRpbmcgdGhlIGxvZ2ljIG91dCBvZiBjb3JlDQogICAgICAgIC8vIGxlYWRzIHRvIHRvbyBtdWNoIHVubmVjZXNzYXJ5IGNvbXBsZXhpdHkuDQogICAgICAgICh0YWcgPT09ICJzdmciIHx8IHRhZyA9PT0gImZvcmVpZ25PYmplY3QiIHx8IHRhZyA9PT0gIm1hdGgiKQ0KICAgICAgKTsNCiAgICAgIGlmIChwcm9wcy5sZW5ndGggPiAwKSB7DQogICAgICAgIGNvbnN0IHByb3BzQnVpbGRSZXN1bHQgPSBidWlsZFByb3BzKA0KICAgICAgICAgIG5vZGUsDQogICAgICAgICAgY29udGV4dCwNCiAgICAgICAgICB2b2lkIDAsDQogICAgICAgICAgaXNDb21wb25lbnQsDQogICAgICAgICAgaXNEeW5hbWljQ29tcG9uZW50DQogICAgICAgICk7DQogICAgICAgIHZub2RlUHJvcHMgPSBwcm9wc0J1aWxkUmVzdWx0LnByb3BzOw0KICAgICAgICBwYXRjaEZsYWcgPSBwcm9wc0J1aWxkUmVzdWx0LnBhdGNoRmxhZzsNCiAgICAgICAgZHluYW1pY1Byb3BOYW1lcyA9IHByb3BzQnVpbGRSZXN1bHQuZHluYW1pY1Byb3BOYW1lczsNCiAgICAgICAgY29uc3QgZGlyZWN0aXZlcyA9IHByb3BzQnVpbGRSZXN1bHQuZGlyZWN0aXZlczsNCiAgICAgICAgdm5vZGVEaXJlY3RpdmVzID0gZGlyZWN0aXZlcyAmJiBkaXJlY3RpdmVzLmxlbmd0aCA/IGNyZWF0ZUFycmF5RXhwcmVzc2lvbigNCiAgICAgICAgICBkaXJlY3RpdmVzLm1hcCgoZGlyKSA9PiBidWlsZERpcmVjdGl2ZUFyZ3MoZGlyLCBjb250ZXh0KSkNCiAgICAgICAgKSA6IHZvaWQgMDsNCiAgICAgICAgaWYgKHByb3BzQnVpbGRSZXN1bHQuc2hvdWxkVXNlQmxvY2spIHsNCiAgICAgICAgICBzaG91bGRVc2VCbG9jayA9IHRydWU7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmIChub2RlLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsNCiAgICAgICAgaWYgKHZub2RlVGFnID09PSBLRUVQX0FMSVZFKSB7DQogICAgICAgICAgc2hvdWxkVXNlQmxvY2sgPSB0cnVlOw0KICAgICAgICAgIHBhdGNoRmxhZyB8PSAxMDI0Ow0KICAgICAgICAgIGlmIChub2RlLmNoaWxkcmVuLmxlbmd0aCA+IDEpIHsNCiAgICAgICAgICAgIGNvbnRleHQub25FcnJvcigNCiAgICAgICAgICAgICAgY3JlYXRlQ29tcGlsZXJFcnJvcig0Niwgew0KICAgICAgICAgICAgICAgIHN0YXJ0OiBub2RlLmNoaWxkcmVuWzBdLmxvYy5zdGFydCwNCiAgICAgICAgICAgICAgICBlbmQ6IG5vZGUuY2hpbGRyZW5bbm9kZS5jaGlsZHJlbi5sZW5ndGggLSAxXS5sb2MuZW5kLA0KICAgICAgICAgICAgICAgIHNvdXJjZTogIiINCiAgICAgICAgICAgICAgfSkNCiAgICAgICAgICAgICk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGNvbnN0IHNob3VsZEJ1aWxkQXNTbG90cyA9IGlzQ29tcG9uZW50ICYmIC8vIFRlbGVwb3J0IGlzIG5vdCBhIHJlYWwgY29tcG9uZW50IGFuZCBoYXMgZGVkaWNhdGVkIHJ1bnRpbWUgaGFuZGxpbmcNCiAgICAgICAgdm5vZGVUYWcgIT09IFRFTEVQT1JUICYmIC8vIGV4cGxhaW5lZCBhYm92ZS4NCiAgICAgICAgdm5vZGVUYWcgIT09IEtFRVBfQUxJVkU7DQogICAgICAgIGlmIChzaG91bGRCdWlsZEFzU2xvdHMpIHsNCiAgICAgICAgICBjb25zdCB7IHNsb3RzLCBoYXNEeW5hbWljU2xvdHMgfSA9IGJ1aWxkU2xvdHMobm9kZSwgY29udGV4dCk7DQogICAgICAgICAgdm5vZGVDaGlsZHJlbiA9IHNsb3RzOw0KICAgICAgICAgIGlmIChoYXNEeW5hbWljU2xvdHMpIHsNCiAgICAgICAgICAgIHBhdGNoRmxhZyB8PSAxMDI0Ow0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIGlmIChub2RlLmNoaWxkcmVuLmxlbmd0aCA9PT0gMSAmJiB2bm9kZVRhZyAhPT0gVEVMRVBPUlQpIHsNCiAgICAgICAgICBjb25zdCBjaGlsZCA9IG5vZGUuY2hpbGRyZW5bMF07DQogICAgICAgICAgY29uc3QgdHlwZSA9IGNoaWxkLnR5cGU7DQogICAgICAgICAgY29uc3QgaGFzRHluYW1pY1RleHRDaGlsZCA9IHR5cGUgPT09IDUgfHwgdHlwZSA9PT0gODsNCiAgICAgICAgICBpZiAoaGFzRHluYW1pY1RleHRDaGlsZCAmJiBnZXRDb25zdGFudFR5cGUoY2hpbGQsIGNvbnRleHQpID09PSAwKSB7DQogICAgICAgICAgICBwYXRjaEZsYWcgfD0gMTsNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKGhhc0R5bmFtaWNUZXh0Q2hpbGQgfHwgdHlwZSA9PT0gMikgew0KICAgICAgICAgICAgdm5vZGVDaGlsZHJlbiA9IGNoaWxkOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICB2bm9kZUNoaWxkcmVuID0gbm9kZS5jaGlsZHJlbjsNCiAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgdm5vZGVDaGlsZHJlbiA9IG5vZGUuY2hpbGRyZW47DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmIChkeW5hbWljUHJvcE5hbWVzICYmIGR5bmFtaWNQcm9wTmFtZXMubGVuZ3RoKSB7DQogICAgICAgIHZub2RlRHluYW1pY1Byb3BzID0gc3RyaW5naWZ5RHluYW1pY1Byb3BOYW1lcyhkeW5hbWljUHJvcE5hbWVzKTsNCiAgICAgIH0NCiAgICAgIG5vZGUuY29kZWdlbk5vZGUgPSBjcmVhdGVWTm9kZUNhbGwoDQogICAgICAgIGNvbnRleHQsDQogICAgICAgIHZub2RlVGFnLA0KICAgICAgICB2bm9kZVByb3BzLA0KICAgICAgICB2bm9kZUNoaWxkcmVuLA0KICAgICAgICBwYXRjaEZsYWcgPT09IDAgPyB2b2lkIDAgOiBwYXRjaEZsYWcsDQogICAgICAgIHZub2RlRHluYW1pY1Byb3BzLA0KICAgICAgICB2bm9kZURpcmVjdGl2ZXMsDQogICAgICAgICEhc2hvdWxkVXNlQmxvY2ssDQogICAgICAgIGZhbHNlLA0KICAgICAgICBpc0NvbXBvbmVudCwNCiAgICAgICAgbm9kZS5sb2MNCiAgICAgICk7DQogICAgfTsNCiAgfTsNCiAgZnVuY3Rpb24gcmVzb2x2ZUNvbXBvbmVudFR5cGUobm9kZSwgY29udGV4dCwgc3NyID0gZmFsc2UpIHsNCiAgICBsZXQgeyB0YWcgfSA9IG5vZGU7DQogICAgY29uc3QgaXNFeHBsaWNpdER5bmFtaWMgPSBpc0NvbXBvbmVudFRhZyh0YWcpOw0KICAgIGNvbnN0IGlzUHJvcCA9IGZpbmRQcm9wKA0KICAgICAgbm9kZSwNCiAgICAgICJpcyIsDQogICAgICBmYWxzZSwNCiAgICAgIHRydWUNCiAgICAgIC8qIGFsbG93IGVtcHR5ICovDQogICAgKTsNCiAgICBpZiAoaXNQcm9wKSB7DQogICAgICBpZiAoaXNFeHBsaWNpdER5bmFtaWMgfHwgZmFsc2UpIHsNCiAgICAgICAgbGV0IGV4cDsNCiAgICAgICAgaWYgKGlzUHJvcC50eXBlID09PSA2KSB7DQogICAgICAgICAgZXhwID0gaXNQcm9wLnZhbHVlICYmIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oaXNQcm9wLnZhbHVlLmNvbnRlbnQsIHRydWUpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGV4cCA9IGlzUHJvcC5leHA7DQogICAgICAgICAgaWYgKCFleHApIHsNCiAgICAgICAgICAgIGV4cCA9IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oYGlzYCwgZmFsc2UsIGlzUHJvcC5hcmcubG9jKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgaWYgKGV4cCkgew0KICAgICAgICAgIHJldHVybiBjcmVhdGVDYWxsRXhwcmVzc2lvbihjb250ZXh0LmhlbHBlcihSRVNPTFZFX0RZTkFNSUNfQ09NUE9ORU5UKSwgWw0KICAgICAgICAgICAgZXhwDQogICAgICAgICAgXSk7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSBpZiAoaXNQcm9wLnR5cGUgPT09IDYgJiYgaXNQcm9wLnZhbHVlLmNvbnRlbnQuc3RhcnRzV2l0aCgidnVlOiIpKSB7DQogICAgICAgIHRhZyA9IGlzUHJvcC52YWx1ZS5jb250ZW50LnNsaWNlKDQpOw0KICAgICAgfQ0KICAgIH0NCiAgICBjb25zdCBidWlsdEluID0gaXNDb3JlQ29tcG9uZW50KHRhZykgfHwgY29udGV4dC5pc0J1aWx0SW5Db21wb25lbnQodGFnKTsNCiAgICBpZiAoYnVpbHRJbikgew0KICAgICAgaWYgKCFzc3IpIGNvbnRleHQuaGVscGVyKGJ1aWx0SW4pOw0KICAgICAgcmV0dXJuIGJ1aWx0SW47DQogICAgfQ0KICAgIGNvbnRleHQuaGVscGVyKFJFU09MVkVfQ09NUE9ORU5UKTsNCiAgICBjb250ZXh0LmNvbXBvbmVudHMuYWRkKHRhZyk7DQogICAgcmV0dXJuIHRvVmFsaWRBc3NldElkKHRhZywgYGNvbXBvbmVudGApOw0KICB9DQogIGZ1bmN0aW9uIGJ1aWxkUHJvcHMobm9kZSwgY29udGV4dCwgcHJvcHMgPSBub2RlLnByb3BzLCBpc0NvbXBvbmVudCwgaXNEeW5hbWljQ29tcG9uZW50LCBzc3IgPSBmYWxzZSkgew0KICAgIGNvbnN0IHsgdGFnLCBsb2M6IGVsZW1lbnRMb2MsIGNoaWxkcmVuIH0gPSBub2RlOw0KICAgIGxldCBwcm9wZXJ0aWVzID0gW107DQogICAgY29uc3QgbWVyZ2VBcmdzID0gW107DQogICAgY29uc3QgcnVudGltZURpcmVjdGl2ZXMgPSBbXTsNCiAgICBjb25zdCBoYXNDaGlsZHJlbiA9IGNoaWxkcmVuLmxlbmd0aCA+IDA7DQogICAgbGV0IHNob3VsZFVzZUJsb2NrID0gZmFsc2U7DQogICAgbGV0IHBhdGNoRmxhZyA9IDA7DQogICAgbGV0IGhhc1JlZiA9IGZhbHNlOw0KICAgIGxldCBoYXNDbGFzc0JpbmRpbmcgPSBmYWxzZTsNCiAgICBsZXQgaGFzU3R5bGVCaW5kaW5nID0gZmFsc2U7DQogICAgbGV0IGhhc0h5ZHJhdGlvbkV2ZW50QmluZGluZyA9IGZhbHNlOw0KICAgIGxldCBoYXNEeW5hbWljS2V5cyA9IGZhbHNlOw0KICAgIGxldCBoYXNWbm9kZUhvb2sgPSBmYWxzZTsNCiAgICBjb25zdCBkeW5hbWljUHJvcE5hbWVzID0gW107DQogICAgY29uc3QgcHVzaE1lcmdlQXJnID0gKGFyZykgPT4gew0KICAgICAgaWYgKHByb3BlcnRpZXMubGVuZ3RoKSB7DQogICAgICAgIG1lcmdlQXJncy5wdXNoKA0KICAgICAgICAgIGNyZWF0ZU9iamVjdEV4cHJlc3Npb24oZGVkdXBlUHJvcGVydGllcyhwcm9wZXJ0aWVzKSwgZWxlbWVudExvYykNCiAgICAgICAgKTsNCiAgICAgICAgcHJvcGVydGllcyA9IFtdOw0KICAgICAgfQ0KICAgICAgaWYgKGFyZykgbWVyZ2VBcmdzLnB1c2goYXJnKTsNCiAgICB9Ow0KICAgIGNvbnN0IHB1c2hSZWZWRm9yTWFya2VyID0gKCkgPT4gew0KICAgICAgaWYgKGNvbnRleHQuc2NvcGVzLnZGb3IgPiAwKSB7DQogICAgICAgIHByb3BlcnRpZXMucHVzaCgNCiAgICAgICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eSgNCiAgICAgICAgICAgIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oInJlZl9mb3IiLCB0cnVlKSwNCiAgICAgICAgICAgIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oInRydWUiKQ0KICAgICAgICAgICkNCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICB9Ow0KICAgIGNvbnN0IGFuYWx5emVQYXRjaEZsYWcgPSAoeyBrZXksIHZhbHVlIH0pID0+IHsNCiAgICAgIGlmIChpc1N0YXRpY0V4cChrZXkpKSB7DQogICAgICAgIGNvbnN0IG5hbWUgPSBrZXkuY29udGVudDsNCiAgICAgICAgY29uc3QgaXNFdmVudEhhbmRsZXIgPSBpc09uKG5hbWUpOw0KICAgICAgICBpZiAoaXNFdmVudEhhbmRsZXIgJiYgKCFpc0NvbXBvbmVudCB8fCBpc0R5bmFtaWNDb21wb25lbnQpICYmIC8vIG9taXQgdGhlIGZsYWcgZm9yIGNsaWNrIGhhbmRsZXJzIGJlY2F1c2UgaHlkcmF0aW9uIGdpdmVzIGNsaWNrDQogICAgICAgIC8vIGRlZGljYXRlZCBmYXN0IHBhdGguDQogICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm9uY2xpY2siICYmIC8vIG9taXQgdi1tb2RlbCBoYW5kbGVycw0KICAgICAgICBuYW1lICE9PSAib25VcGRhdGU6bW9kZWxWYWx1ZSIgJiYgLy8gb21pdCBvblZub2RlWFhYIGhvb2tzDQogICAgICAgICFpc1Jlc2VydmVkUHJvcChuYW1lKSkgew0KICAgICAgICAgIGhhc0h5ZHJhdGlvbkV2ZW50QmluZGluZyA9IHRydWU7DQogICAgICAgIH0NCiAgICAgICAgaWYgKGlzRXZlbnRIYW5kbGVyICYmIGlzUmVzZXJ2ZWRQcm9wKG5hbWUpKSB7DQogICAgICAgICAgaGFzVm5vZGVIb29rID0gdHJ1ZTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoaXNFdmVudEhhbmRsZXIgJiYgdmFsdWUudHlwZSA9PT0gMTQpIHsNCiAgICAgICAgICB2YWx1ZSA9IHZhbHVlLmFyZ3VtZW50c1swXTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAodmFsdWUudHlwZSA9PT0gMjAgfHwgKHZhbHVlLnR5cGUgPT09IDQgfHwgdmFsdWUudHlwZSA9PT0gOCkgJiYgZ2V0Q29uc3RhbnRUeXBlKHZhbHVlLCBjb250ZXh0KSA+IDApIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgaWYgKG5hbWUgPT09ICJyZWYiKSB7DQogICAgICAgICAgaGFzUmVmID0gdHJ1ZTsNCiAgICAgICAgfSBlbHNlIGlmIChuYW1lID09PSAiY2xhc3MiKSB7DQogICAgICAgICAgaGFzQ2xhc3NCaW5kaW5nID0gdHJ1ZTsNCiAgICAgICAgfSBlbHNlIGlmIChuYW1lID09PSAic3R5bGUiKSB7DQogICAgICAgICAgaGFzU3R5bGVCaW5kaW5nID0gdHJ1ZTsNCiAgICAgICAgfSBlbHNlIGlmIChuYW1lICE9PSAia2V5IiAmJiAhZHluYW1pY1Byb3BOYW1lcy5pbmNsdWRlcyhuYW1lKSkgew0KICAgICAgICAgIGR5bmFtaWNQcm9wTmFtZXMucHVzaChuYW1lKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoaXNDb21wb25lbnQgJiYgKG5hbWUgPT09ICJjbGFzcyIgfHwgbmFtZSA9PT0gInN0eWxlIikgJiYgIWR5bmFtaWNQcm9wTmFtZXMuaW5jbHVkZXMobmFtZSkpIHsNCiAgICAgICAgICBkeW5hbWljUHJvcE5hbWVzLnB1c2gobmFtZSk7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGhhc0R5bmFtaWNLZXlzID0gdHJ1ZTsNCiAgICAgIH0NCiAgICB9Ow0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsNCiAgICAgIGNvbnN0IHByb3AgPSBwcm9wc1tpXTsNCiAgICAgIGlmIChwcm9wLnR5cGUgPT09IDYpIHsNCiAgICAgICAgY29uc3QgeyBsb2MsIG5hbWUsIG5hbWVMb2MsIHZhbHVlIH0gPSBwcm9wOw0KICAgICAgICBsZXQgaXNTdGF0aWMgPSB0cnVlOw0KICAgICAgICBpZiAobmFtZSA9PT0gInJlZiIpIHsNCiAgICAgICAgICBoYXNSZWYgPSB0cnVlOw0KICAgICAgICAgIHB1c2hSZWZWRm9yTWFya2VyKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG5hbWUgPT09ICJpcyIgJiYgKGlzQ29tcG9uZW50VGFnKHRhZykgfHwgdmFsdWUgJiYgdmFsdWUuY29udGVudC5zdGFydHNXaXRoKCJ2dWU6IikgfHwgZmFsc2UpKSB7DQogICAgICAgICAgY29udGludWU7DQogICAgICAgIH0NCiAgICAgICAgcHJvcGVydGllcy5wdXNoKA0KICAgICAgICAgIGNyZWF0ZU9iamVjdFByb3BlcnR5KA0KICAgICAgICAgICAgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihuYW1lLCB0cnVlLCBuYW1lTG9jKSwNCiAgICAgICAgICAgIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oDQogICAgICAgICAgICAgIHZhbHVlID8gdmFsdWUuY29udGVudCA6ICIiLA0KICAgICAgICAgICAgICBpc1N0YXRpYywNCiAgICAgICAgICAgICAgdmFsdWUgPyB2YWx1ZS5sb2MgOiBsb2MNCiAgICAgICAgICAgICkNCiAgICAgICAgICApDQogICAgICAgICk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb25zdCB7IG5hbWUsIGFyZywgZXhwLCBsb2MsIG1vZGlmaWVycyB9ID0gcHJvcDsNCiAgICAgICAgY29uc3QgaXNWQmluZCA9IG5hbWUgPT09ICJiaW5kIjsNCiAgICAgICAgY29uc3QgaXNWT24gPSBuYW1lID09PSAib24iOw0KICAgICAgICBpZiAobmFtZSA9PT0gInNsb3QiKSB7DQogICAgICAgICAgaWYgKCFpc0NvbXBvbmVudCkgew0KICAgICAgICAgICAgY29udGV4dC5vbkVycm9yKA0KICAgICAgICAgICAgICBjcmVhdGVDb21waWxlckVycm9yKDQwLCBsb2MpDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAobmFtZSA9PT0gIm9uY2UiIHx8IG5hbWUgPT09ICJtZW1vIikgew0KICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICB9DQogICAgICAgIGlmIChuYW1lID09PSAiaXMiIHx8IGlzVkJpbmQgJiYgaXNTdGF0aWNBcmdPZihhcmcsICJpcyIpICYmIChpc0NvbXBvbmVudFRhZyh0YWcpIHx8IGZhbHNlKSkgew0KICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICB9DQogICAgICAgIGlmIChpc1ZPbiAmJiBzc3IpIHsNCiAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoDQogICAgICAgICAgLy8gIzkzODogZWxlbWVudHMgd2l0aCBkeW5hbWljIGtleXMgc2hvdWxkIGJlIGZvcmNlZCBpbnRvIGJsb2Nrcw0KICAgICAgICAgIGlzVkJpbmQgJiYgaXNTdGF0aWNBcmdPZihhcmcsICJrZXkiKSB8fCAvLyBpbmxpbmUgYmVmb3JlLXVwZGF0ZSBob29rcyBuZWVkIHRvIGZvcmNlIGJsb2NrIHNvIHRoYXQgaXQgaXMgaW52b2tlZA0KICAgICAgICAgIC8vIGJlZm9yZSBjaGlsZHJlbg0KICAgICAgICAgIGlzVk9uICYmIGhhc0NoaWxkcmVuICYmIGlzU3RhdGljQXJnT2YoYXJnLCAidnVlOmJlZm9yZS11cGRhdGUiKQ0KICAgICAgICApIHsNCiAgICAgICAgICBzaG91bGRVc2VCbG9jayA9IHRydWU7DQogICAgICAgIH0NCiAgICAgICAgaWYgKGlzVkJpbmQgJiYgaXNTdGF0aWNBcmdPZihhcmcsICJyZWYiKSkgew0KICAgICAgICAgIHB1c2hSZWZWRm9yTWFya2VyKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFhcmcgJiYgKGlzVkJpbmQgfHwgaXNWT24pKSB7DQogICAgICAgICAgaGFzRHluYW1pY0tleXMgPSB0cnVlOw0KICAgICAgICAgIGlmIChleHApIHsNCiAgICAgICAgICAgIGlmIChpc1ZCaW5kKSB7DQogICAgICAgICAgICAgIHB1c2hSZWZWRm9yTWFya2VyKCk7DQogICAgICAgICAgICAgIHB1c2hNZXJnZUFyZygpOw0KICAgICAgICAgICAgICBtZXJnZUFyZ3MucHVzaChleHApOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgcHVzaE1lcmdlQXJnKHsNCiAgICAgICAgICAgICAgICB0eXBlOiAxNCwNCiAgICAgICAgICAgICAgICBsb2MsDQogICAgICAgICAgICAgICAgY2FsbGVlOiBjb250ZXh0LmhlbHBlcihUT19IQU5ETEVSUyksDQogICAgICAgICAgICAgICAgYXJndW1lbnRzOiBpc0NvbXBvbmVudCA/IFtleHBdIDogW2V4cCwgYHRydWVgXQ0KICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgY29udGV4dC5vbkVycm9yKA0KICAgICAgICAgICAgICBjcmVhdGVDb21waWxlckVycm9yKA0KICAgICAgICAgICAgICAgIGlzVkJpbmQgPyAzNCA6IDM1LA0KICAgICAgICAgICAgICAgIGxvYw0KICAgICAgICAgICAgICApDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0NCiAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoaXNWQmluZCAmJiBtb2RpZmllcnMuc29tZSgobW9kKSA9PiBtb2QuY29udGVudCA9PT0gInByb3AiKSkgew0KICAgICAgICAgIHBhdGNoRmxhZyB8PSAzMjsNCiAgICAgICAgfQ0KICAgICAgICBjb25zdCBkaXJlY3RpdmVUcmFuc2Zvcm0gPSBjb250ZXh0LmRpcmVjdGl2ZVRyYW5zZm9ybXNbbmFtZV07DQogICAgICAgIGlmIChkaXJlY3RpdmVUcmFuc2Zvcm0pIHsNCiAgICAgICAgICBjb25zdCB7IHByb3BzOiBwcm9wczIsIG5lZWRSdW50aW1lIH0gPSBkaXJlY3RpdmVUcmFuc2Zvcm0ocHJvcCwgbm9kZSwgY29udGV4dCk7DQogICAgICAgICAgIXNzciAmJiBwcm9wczIuZm9yRWFjaChhbmFseXplUGF0Y2hGbGFnKTsNCiAgICAgICAgICBpZiAoaXNWT24gJiYgYXJnICYmICFpc1N0YXRpY0V4cChhcmcpKSB7DQogICAgICAgICAgICBwdXNoTWVyZ2VBcmcoY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihwcm9wczIsIGVsZW1lbnRMb2MpKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgcHJvcGVydGllcy5wdXNoKC4uLnByb3BzMik7DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmIChuZWVkUnVudGltZSkgew0KICAgICAgICAgICAgcnVudGltZURpcmVjdGl2ZXMucHVzaChwcm9wKTsNCiAgICAgICAgICAgIGlmIChpc1N5bWJvbChuZWVkUnVudGltZSkpIHsNCiAgICAgICAgICAgICAgZGlyZWN0aXZlSW1wb3J0TWFwLnNldChwcm9wLCBuZWVkUnVudGltZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9IGVsc2UgaWYgKCFpc0J1aWx0SW5EaXJlY3RpdmUobmFtZSkpIHsNCiAgICAgICAgICBydW50aW1lRGlyZWN0aXZlcy5wdXNoKHByb3ApOw0KICAgICAgICAgIGlmIChoYXNDaGlsZHJlbikgew0KICAgICAgICAgICAgc2hvdWxkVXNlQmxvY2sgPSB0cnVlOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICBsZXQgcHJvcHNFeHByZXNzaW9uID0gdm9pZCAwOw0KICAgIGlmIChtZXJnZUFyZ3MubGVuZ3RoKSB7DQogICAgICBwdXNoTWVyZ2VBcmcoKTsNCiAgICAgIGlmIChtZXJnZUFyZ3MubGVuZ3RoID4gMSkgew0KICAgICAgICBwcm9wc0V4cHJlc3Npb24gPSBjcmVhdGVDYWxsRXhwcmVzc2lvbigNCiAgICAgICAgICBjb250ZXh0LmhlbHBlcihNRVJHRV9QUk9QUyksDQogICAgICAgICAgbWVyZ2VBcmdzLA0KICAgICAgICAgIGVsZW1lbnRMb2MNCiAgICAgICAgKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHByb3BzRXhwcmVzc2lvbiA9IG1lcmdlQXJnc1swXTsNCiAgICAgIH0NCiAgICB9IGVsc2UgaWYgKHByb3BlcnRpZXMubGVuZ3RoKSB7DQogICAgICBwcm9wc0V4cHJlc3Npb24gPSBjcmVhdGVPYmplY3RFeHByZXNzaW9uKA0KICAgICAgICBkZWR1cGVQcm9wZXJ0aWVzKHByb3BlcnRpZXMpLA0KICAgICAgICBlbGVtZW50TG9jDQogICAgICApOw0KICAgIH0NCiAgICBpZiAoaGFzRHluYW1pY0tleXMpIHsNCiAgICAgIHBhdGNoRmxhZyB8PSAxNjsNCiAgICB9IGVsc2Ugew0KICAgICAgaWYgKGhhc0NsYXNzQmluZGluZyAmJiAhaXNDb21wb25lbnQpIHsNCiAgICAgICAgcGF0Y2hGbGFnIHw9IDI7DQogICAgICB9DQogICAgICBpZiAoaGFzU3R5bGVCaW5kaW5nICYmICFpc0NvbXBvbmVudCkgew0KICAgICAgICBwYXRjaEZsYWcgfD0gNDsNCiAgICAgIH0NCiAgICAgIGlmIChkeW5hbWljUHJvcE5hbWVzLmxlbmd0aCkgew0KICAgICAgICBwYXRjaEZsYWcgfD0gODsNCiAgICAgIH0NCiAgICAgIGlmIChoYXNIeWRyYXRpb25FdmVudEJpbmRpbmcpIHsNCiAgICAgICAgcGF0Y2hGbGFnIHw9IDMyOw0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAoIXNob3VsZFVzZUJsb2NrICYmIChwYXRjaEZsYWcgPT09IDAgfHwgcGF0Y2hGbGFnID09PSAzMikgJiYgKGhhc1JlZiB8fCBoYXNWbm9kZUhvb2sgfHwgcnVudGltZURpcmVjdGl2ZXMubGVuZ3RoID4gMCkpIHsNCiAgICAgIHBhdGNoRmxhZyB8PSA1MTI7DQogICAgfQ0KICAgIGlmICghY29udGV4dC5pblNTUiAmJiBwcm9wc0V4cHJlc3Npb24pIHsNCiAgICAgIHN3aXRjaCAocHJvcHNFeHByZXNzaW9uLnR5cGUpIHsNCiAgICAgICAgY2FzZSAxNToNCiAgICAgICAgICBsZXQgY2xhc3NLZXlJbmRleCA9IC0xOw0KICAgICAgICAgIGxldCBzdHlsZUtleUluZGV4ID0gLTE7DQogICAgICAgICAgbGV0IGhhc0R5bmFtaWNLZXkgPSBmYWxzZTsNCiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb3BzRXhwcmVzc2lvbi5wcm9wZXJ0aWVzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBjb25zdCBrZXkgPSBwcm9wc0V4cHJlc3Npb24ucHJvcGVydGllc1tpXS5rZXk7DQogICAgICAgICAgICBpZiAoaXNTdGF0aWNFeHAoa2V5KSkgew0KICAgICAgICAgICAgICBpZiAoa2V5LmNvbnRlbnQgPT09ICJjbGFzcyIpIHsNCiAgICAgICAgICAgICAgICBjbGFzc0tleUluZGV4ID0gaTsNCiAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkuY29udGVudCA9PT0gInN0eWxlIikgew0KICAgICAgICAgICAgICAgIHN0eWxlS2V5SW5kZXggPSBpOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9IGVsc2UgaWYgKCFrZXkuaXNIYW5kbGVyS2V5KSB7DQogICAgICAgICAgICAgIGhhc0R5bmFtaWNLZXkgPSB0cnVlOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgICBjb25zdCBjbGFzc1Byb3AgPSBwcm9wc0V4cHJlc3Npb24ucHJvcGVydGllc1tjbGFzc0tleUluZGV4XTsNCiAgICAgICAgICBjb25zdCBzdHlsZVByb3AgPSBwcm9wc0V4cHJlc3Npb24ucHJvcGVydGllc1tzdHlsZUtleUluZGV4XTsNCiAgICAgICAgICBpZiAoIWhhc0R5bmFtaWNLZXkpIHsNCiAgICAgICAgICAgIGlmIChjbGFzc1Byb3AgJiYgIWlzU3RhdGljRXhwKGNsYXNzUHJvcC52YWx1ZSkpIHsNCiAgICAgICAgICAgICAgY2xhc3NQcm9wLnZhbHVlID0gY3JlYXRlQ2FsbEV4cHJlc3Npb24oDQogICAgICAgICAgICAgICAgY29udGV4dC5oZWxwZXIoTk9STUFMSVpFX0NMQVNTKSwNCiAgICAgICAgICAgICAgICBbY2xhc3NQcm9wLnZhbHVlXQ0KICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKHN0eWxlUHJvcCAmJiAvLyB0aGUgc3RhdGljIHN0eWxlIGlzIGNvbXBpbGVkIGludG8gYW4gb2JqZWN0LA0KICAgICAgICAgICAgLy8gc28gdXNlIGBoYXNTdHlsZUJpbmRpbmdgIHRvIGVuc3VyZSB0aGF0IGl0IGlzIGEgZHluYW1pYyBzdHlsZSBiaW5kaW5nDQogICAgICAgICAgICAoaGFzU3R5bGVCaW5kaW5nIHx8IHN0eWxlUHJvcC52YWx1ZS50eXBlID09PSA0ICYmIHN0eWxlUHJvcC52YWx1ZS5jb250ZW50LnRyaW0oKVswXSA9PT0gYFtgIHx8IC8vIHYtYmluZDpzdHlsZSBhbmQgc3R5bGUgYm90aCBleGlzdCwNCiAgICAgICAgICAgIC8vIHYtYmluZDpzdHlsZSB3aXRoIHN0YXRpYyBsaXRlcmFsIG9iamVjdA0KICAgICAgICAgICAgc3R5bGVQcm9wLnZhbHVlLnR5cGUgPT09IDE3KSkgew0KICAgICAgICAgICAgICBzdHlsZVByb3AudmFsdWUgPSBjcmVhdGVDYWxsRXhwcmVzc2lvbigNCiAgICAgICAgICAgICAgICBjb250ZXh0LmhlbHBlcihOT1JNQUxJWkVfU1RZTEUpLA0KICAgICAgICAgICAgICAgIFtzdHlsZVByb3AudmFsdWVdDQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHByb3BzRXhwcmVzc2lvbiA9IGNyZWF0ZUNhbGxFeHByZXNzaW9uKA0KICAgICAgICAgICAgICBjb250ZXh0LmhlbHBlcihOT1JNQUxJWkVfUFJPUFMpLA0KICAgICAgICAgICAgICBbcHJvcHNFeHByZXNzaW9uXQ0KICAgICAgICAgICAgKTsNCiAgICAgICAgICB9DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIGNhc2UgMTQ6DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIGRlZmF1bHQ6DQogICAgICAgICAgcHJvcHNFeHByZXNzaW9uID0gY3JlYXRlQ2FsbEV4cHJlc3Npb24oDQogICAgICAgICAgICBjb250ZXh0LmhlbHBlcihOT1JNQUxJWkVfUFJPUFMpLA0KICAgICAgICAgICAgWw0KICAgICAgICAgICAgICBjcmVhdGVDYWxsRXhwcmVzc2lvbihjb250ZXh0LmhlbHBlcihHVUFSRF9SRUFDVElWRV9QUk9QUyksIFsNCiAgICAgICAgICAgICAgICBwcm9wc0V4cHJlc3Npb24NCiAgICAgICAgICAgICAgXSkNCiAgICAgICAgICAgIF0NCiAgICAgICAgICApOw0KICAgICAgICAgIGJyZWFrOw0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gew0KICAgICAgcHJvcHM6IHByb3BzRXhwcmVzc2lvbiwNCiAgICAgIGRpcmVjdGl2ZXM6IHJ1bnRpbWVEaXJlY3RpdmVzLA0KICAgICAgcGF0Y2hGbGFnLA0KICAgICAgZHluYW1pY1Byb3BOYW1lcywNCiAgICAgIHNob3VsZFVzZUJsb2NrDQogICAgfTsNCiAgfQ0KICBmdW5jdGlvbiBkZWR1cGVQcm9wZXJ0aWVzKHByb3BlcnRpZXMpIHsNCiAgICBjb25zdCBrbm93blByb3BzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsNCiAgICBjb25zdCBkZWR1cGVkID0gW107DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9wZXJ0aWVzLmxlbmd0aDsgaSsrKSB7DQogICAgICBjb25zdCBwcm9wID0gcHJvcGVydGllc1tpXTsNCiAgICAgIGlmIChwcm9wLmtleS50eXBlID09PSA4IHx8ICFwcm9wLmtleS5pc1N0YXRpYykgew0KICAgICAgICBkZWR1cGVkLnB1c2gocHJvcCk7DQogICAgICAgIGNvbnRpbnVlOw0KICAgICAgfQ0KICAgICAgY29uc3QgbmFtZSA9IHByb3Aua2V5LmNvbnRlbnQ7DQogICAgICBjb25zdCBleGlzdGluZyA9IGtub3duUHJvcHMuZ2V0KG5hbWUpOw0KICAgICAgaWYgKGV4aXN0aW5nKSB7DQogICAgICAgIGlmIChuYW1lID09PSAic3R5bGUiIHx8IG5hbWUgPT09ICJjbGFzcyIgfHwgaXNPbihuYW1lKSkgew0KICAgICAgICAgIG1lcmdlQXNBcnJheShleGlzdGluZywgcHJvcCk7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGtub3duUHJvcHMuc2V0KG5hbWUsIHByb3ApOw0KICAgICAgICBkZWR1cGVkLnB1c2gocHJvcCk7DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiBkZWR1cGVkOw0KICB9DQogIGZ1bmN0aW9uIG1lcmdlQXNBcnJheShleGlzdGluZywgaW5jb21pbmcpIHsNCiAgICBpZiAoZXhpc3RpbmcudmFsdWUudHlwZSA9PT0gMTcpIHsNCiAgICAgIGV4aXN0aW5nLnZhbHVlLmVsZW1lbnRzLnB1c2goaW5jb21pbmcudmFsdWUpOw0KICAgIH0gZWxzZSB7DQogICAgICBleGlzdGluZy52YWx1ZSA9IGNyZWF0ZUFycmF5RXhwcmVzc2lvbigNCiAgICAgICAgW2V4aXN0aW5nLnZhbHVlLCBpbmNvbWluZy52YWx1ZV0sDQogICAgICAgIGV4aXN0aW5nLmxvYw0KICAgICAgKTsNCiAgICB9DQogIH0NCiAgZnVuY3Rpb24gYnVpbGREaXJlY3RpdmVBcmdzKGRpciwgY29udGV4dCkgew0KICAgIGNvbnN0IGRpckFyZ3MgPSBbXTsNCiAgICBjb25zdCBydW50aW1lID0gZGlyZWN0aXZlSW1wb3J0TWFwLmdldChkaXIpOw0KICAgIGlmIChydW50aW1lKSB7DQogICAgICBkaXJBcmdzLnB1c2goY29udGV4dC5oZWxwZXJTdHJpbmcocnVudGltZSkpOw0KICAgIH0gZWxzZSB7DQogICAgICB7DQogICAgICAgIGNvbnRleHQuaGVscGVyKFJFU09MVkVfRElSRUNUSVZFKTsNCiAgICAgICAgY29udGV4dC5kaXJlY3RpdmVzLmFkZChkaXIubmFtZSk7DQogICAgICAgIGRpckFyZ3MucHVzaCh0b1ZhbGlkQXNzZXRJZChkaXIubmFtZSwgYGRpcmVjdGl2ZWApKTsNCiAgICAgIH0NCiAgICB9DQogICAgY29uc3QgeyBsb2MgfSA9IGRpcjsNCiAgICBpZiAoZGlyLmV4cCkgZGlyQXJncy5wdXNoKGRpci5leHApOw0KICAgIGlmIChkaXIuYXJnKSB7DQogICAgICBpZiAoIWRpci5leHApIHsNCiAgICAgICAgZGlyQXJncy5wdXNoKGB2b2lkIDBgKTsNCiAgICAgIH0NCiAgICAgIGRpckFyZ3MucHVzaChkaXIuYXJnKTsNCiAgICB9DQogICAgaWYgKE9iamVjdC5rZXlzKGRpci5tb2RpZmllcnMpLmxlbmd0aCkgew0KICAgICAgaWYgKCFkaXIuYXJnKSB7DQogICAgICAgIGlmICghZGlyLmV4cCkgew0KICAgICAgICAgIGRpckFyZ3MucHVzaChgdm9pZCAwYCk7DQogICAgICAgIH0NCiAgICAgICAgZGlyQXJncy5wdXNoKGB2b2lkIDBgKTsNCiAgICAgIH0NCiAgICAgIGNvbnN0IHRydWVFeHByZXNzaW9uID0gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgdHJ1ZWAsIGZhbHNlLCBsb2MpOw0KICAgICAgZGlyQXJncy5wdXNoKA0KICAgICAgICBjcmVhdGVPYmplY3RFeHByZXNzaW9uKA0KICAgICAgICAgIGRpci5tb2RpZmllcnMubWFwKA0KICAgICAgICAgICAgKG1vZGlmaWVyKSA9PiBjcmVhdGVPYmplY3RQcm9wZXJ0eShtb2RpZmllciwgdHJ1ZUV4cHJlc3Npb24pDQogICAgICAgICAgKSwNCiAgICAgICAgICBsb2MNCiAgICAgICAgKQ0KICAgICAgKTsNCiAgICB9DQogICAgcmV0dXJuIGNyZWF0ZUFycmF5RXhwcmVzc2lvbihkaXJBcmdzLCBkaXIubG9jKTsNCiAgfQ0KICBmdW5jdGlvbiBzdHJpbmdpZnlEeW5hbWljUHJvcE5hbWVzKHByb3BzKSB7DQogICAgbGV0IHByb3BzTmFtZXNTdHJpbmcgPSBgW2A7DQogICAgZm9yIChsZXQgaSA9IDAsIGwgPSBwcm9wcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsNCiAgICAgIHByb3BzTmFtZXNTdHJpbmcgKz0gSlNPTi5zdHJpbmdpZnkocHJvcHNbaV0pOw0KICAgICAgaWYgKGkgPCBsIC0gMSkgcHJvcHNOYW1lc1N0cmluZyArPSAiLCAiOw0KICAgIH0NCiAgICByZXR1cm4gcHJvcHNOYW1lc1N0cmluZyArIGBdYDsNCiAgfQ0KICBmdW5jdGlvbiBpc0NvbXBvbmVudFRhZyh0YWcpIHsNCiAgICByZXR1cm4gdGFnID09PSAiY29tcG9uZW50IiB8fCB0YWcgPT09ICJDb21wb25lbnQiOw0KICB9DQoNCiAgY29uc3QgdHJhbnNmb3JtU2xvdE91dGxldCA9IChub2RlLCBjb250ZXh0KSA9PiB7DQogICAgaWYgKGlzU2xvdE91dGxldChub2RlKSkgew0KICAgICAgY29uc3QgeyBjaGlsZHJlbiwgbG9jIH0gPSBub2RlOw0KICAgICAgY29uc3QgeyBzbG90TmFtZSwgc2xvdFByb3BzIH0gPSBwcm9jZXNzU2xvdE91dGxldChub2RlLCBjb250ZXh0KTsNCiAgICAgIGNvbnN0IHNsb3RBcmdzID0gWw0KICAgICAgICBjb250ZXh0LnByZWZpeElkZW50aWZpZXJzID8gYF9jdHguJHNsb3RzYCA6IGAkc2xvdHNgLA0KICAgICAgICBzbG90TmFtZSwNCiAgICAgICAgInt9IiwNCiAgICAgICAgInVuZGVmaW5lZCIsDQogICAgICAgICJ0cnVlIg0KICAgICAgXTsNCiAgICAgIGxldCBleHBlY3RlZExlbiA9IDI7DQogICAgICBpZiAoc2xvdFByb3BzKSB7DQogICAgICAgIHNsb3RBcmdzWzJdID0gc2xvdFByb3BzOw0KICAgICAgICBleHBlY3RlZExlbiA9IDM7DQogICAgICB9DQogICAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoKSB7DQogICAgICAgIHNsb3RBcmdzWzNdID0gY3JlYXRlRnVuY3Rpb25FeHByZXNzaW9uKFtdLCBjaGlsZHJlbiwgZmFsc2UsIGZhbHNlLCBsb2MpOw0KICAgICAgICBleHBlY3RlZExlbiA9IDQ7DQogICAgICB9DQogICAgICBpZiAoY29udGV4dC5zY29wZUlkICYmICFjb250ZXh0LnNsb3R0ZWQpIHsNCiAgICAgICAgZXhwZWN0ZWRMZW4gPSA1Ow0KICAgICAgfQ0KICAgICAgc2xvdEFyZ3Muc3BsaWNlKGV4cGVjdGVkTGVuKTsNCiAgICAgIG5vZGUuY29kZWdlbk5vZGUgPSBjcmVhdGVDYWxsRXhwcmVzc2lvbigNCiAgICAgICAgY29udGV4dC5oZWxwZXIoUkVOREVSX1NMT1QpLA0KICAgICAgICBzbG90QXJncywNCiAgICAgICAgbG9jDQogICAgICApOw0KICAgIH0NCiAgfTsNCiAgZnVuY3Rpb24gcHJvY2Vzc1Nsb3RPdXRsZXQobm9kZSwgY29udGV4dCkgew0KICAgIGxldCBzbG90TmFtZSA9IGAiZGVmYXVsdCJgOw0KICAgIGxldCBzbG90UHJvcHMgPSB2b2lkIDA7DQogICAgY29uc3Qgbm9uTmFtZVByb3BzID0gW107DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLnByb3BzLmxlbmd0aDsgaSsrKSB7DQogICAgICBjb25zdCBwID0gbm9kZS5wcm9wc1tpXTsNCiAgICAgIGlmIChwLnR5cGUgPT09IDYpIHsNCiAgICAgICAgaWYgKHAudmFsdWUpIHsNCiAgICAgICAgICBpZiAocC5uYW1lID09PSAibmFtZSIpIHsNCiAgICAgICAgICAgIHNsb3ROYW1lID0gSlNPTi5zdHJpbmdpZnkocC52YWx1ZS5jb250ZW50KTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgcC5uYW1lID0gY2FtZWxpemUocC5uYW1lKTsNCiAgICAgICAgICAgIG5vbk5hbWVQcm9wcy5wdXNoKHApOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgaWYgKHAubmFtZSA9PT0gImJpbmQiICYmIGlzU3RhdGljQXJnT2YocC5hcmcsICJuYW1lIikpIHsNCiAgICAgICAgICBpZiAocC5leHApIHsNCiAgICAgICAgICAgIHNsb3ROYW1lID0gcC5leHA7DQogICAgICAgICAgfSBlbHNlIGlmIChwLmFyZyAmJiBwLmFyZy50eXBlID09PSA0KSB7DQogICAgICAgICAgICBjb25zdCBuYW1lID0gY2FtZWxpemUocC5hcmcuY29udGVudCk7DQogICAgICAgICAgICBzbG90TmFtZSA9IHAuZXhwID0gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihuYW1lLCBmYWxzZSwgcC5hcmcubG9jKTsNCiAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgaWYgKHAubmFtZSA9PT0gImJpbmQiICYmIHAuYXJnICYmIGlzU3RhdGljRXhwKHAuYXJnKSkgew0KICAgICAgICAgICAgcC5hcmcuY29udGVudCA9IGNhbWVsaXplKHAuYXJnLmNvbnRlbnQpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBub25OYW1lUHJvcHMucHVzaChwKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICBpZiAobm9uTmFtZVByb3BzLmxlbmd0aCA+IDApIHsNCiAgICAgIGNvbnN0IHsgcHJvcHMsIGRpcmVjdGl2ZXMgfSA9IGJ1aWxkUHJvcHMoDQogICAgICAgIG5vZGUsDQogICAgICAgIGNvbnRleHQsDQogICAgICAgIG5vbk5hbWVQcm9wcywNCiAgICAgICAgZmFsc2UsDQogICAgICAgIGZhbHNlDQogICAgICApOw0KICAgICAgc2xvdFByb3BzID0gcHJvcHM7DQogICAgICBpZiAoZGlyZWN0aXZlcy5sZW5ndGgpIHsNCiAgICAgICAgY29udGV4dC5vbkVycm9yKA0KICAgICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoDQogICAgICAgICAgICAzNiwNCiAgICAgICAgICAgIGRpcmVjdGl2ZXNbMF0ubG9jDQogICAgICAgICAgKQ0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gew0KICAgICAgc2xvdE5hbWUsDQogICAgICBzbG90UHJvcHMNCiAgICB9Ow0KICB9DQoNCiAgY29uc3QgdHJhbnNmb3JtT24kMSA9IChkaXIsIG5vZGUsIGNvbnRleHQsIGF1Z21lbnRvcikgPT4gew0KICAgIGNvbnN0IHsgbG9jLCBtb2RpZmllcnMsIGFyZyB9ID0gZGlyOw0KICAgIGlmICghZGlyLmV4cCAmJiAhbW9kaWZpZXJzLmxlbmd0aCkgew0KICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoMzUsIGxvYykpOw0KICAgIH0NCiAgICBsZXQgZXZlbnROYW1lOw0KICAgIGlmIChhcmcudHlwZSA9PT0gNCkgew0KICAgICAgaWYgKGFyZy5pc1N0YXRpYykgew0KICAgICAgICBsZXQgcmF3TmFtZSA9IGFyZy5jb250ZW50Ow0KICAgICAgICBpZiAocmF3TmFtZS5zdGFydHNXaXRoKCJ2bm9kZSIpKSB7DQogICAgICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoNTEsIGFyZy5sb2MpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAocmF3TmFtZS5zdGFydHNXaXRoKCJ2dWU6IikpIHsNCiAgICAgICAgICByYXdOYW1lID0gYHZub2RlLSR7cmF3TmFtZS5zbGljZSg0KX1gOw0KICAgICAgICB9DQogICAgICAgIGNvbnN0IGV2ZW50U3RyaW5nID0gbm9kZS50YWdUeXBlICE9PSAwIHx8IHJhd05hbWUuc3RhcnRzV2l0aCgidm5vZGUiKSB8fCAhL1tBLVpdLy50ZXN0KHJhd05hbWUpID8gKA0KICAgICAgICAgIC8vIGZvciBub24tZWxlbWVudCBhbmQgdm5vZGUgbGlmZWN5Y2xlIGV2ZW50IGxpc3RlbmVycywgYXV0byBjb252ZXJ0DQogICAgICAgICAgLy8gaXQgdG8gY2FtZWxDYXNlLiBTZWUgaXNzdWUgIzIyNDkNCiAgICAgICAgICB0b0hhbmRsZXJLZXkoY2FtZWxpemUocmF3TmFtZSkpDQogICAgICAgICkgOiAoDQogICAgICAgICAgLy8gcHJlc2VydmUgY2FzZSBmb3IgcGxhaW4gZWxlbWVudCBsaXN0ZW5lcnMgdGhhdCBoYXZlIHVwcGVyY2FzZQ0KICAgICAgICAgIC8vIGxldHRlcnMsIGFzIHRoZXNlIG1heSBiZSBjdXN0b20gZWxlbWVudHMnIGN1c3RvbSBldmVudHMNCiAgICAgICAgICBgb246JHtyYXdOYW1lfWANCiAgICAgICAgKTsNCiAgICAgICAgZXZlbnROYW1lID0gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihldmVudFN0cmluZywgdHJ1ZSwgYXJnLmxvYyk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBldmVudE5hbWUgPSBjcmVhdGVDb21wb3VuZEV4cHJlc3Npb24oWw0KICAgICAgICAgIGAke2NvbnRleHQuaGVscGVyU3RyaW5nKFRPX0hBTkRMRVJfS0VZKX0oYCwNCiAgICAgICAgICBhcmcsDQogICAgICAgICAgYClgDQogICAgICAgIF0pOw0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICBldmVudE5hbWUgPSBhcmc7DQogICAgICBldmVudE5hbWUuY2hpbGRyZW4udW5zaGlmdChgJHtjb250ZXh0LmhlbHBlclN0cmluZyhUT19IQU5ETEVSX0tFWSl9KGApOw0KICAgICAgZXZlbnROYW1lLmNoaWxkcmVuLnB1c2goYClgKTsNCiAgICB9DQogICAgbGV0IGV4cCA9IGRpci5leHA7DQogICAgaWYgKGV4cCAmJiAhZXhwLmNvbnRlbnQudHJpbSgpKSB7DQogICAgICBleHAgPSB2b2lkIDA7DQogICAgfQ0KICAgIGxldCBzaG91bGRDYWNoZSA9IGNvbnRleHQuY2FjaGVIYW5kbGVycyAmJiAhZXhwICYmICFjb250ZXh0LmluVk9uY2U7DQogICAgaWYgKGV4cCkgew0KICAgICAgY29uc3QgaXNNZW1iZXJFeHAgPSBpc01lbWJlckV4cHJlc3Npb24oZXhwKTsNCiAgICAgIGNvbnN0IGlzSW5saW5lU3RhdGVtZW50ID0gIShpc01lbWJlckV4cCB8fCBpc0ZuRXhwcmVzc2lvbihleHApKTsNCiAgICAgIGNvbnN0IGhhc011bHRpcGxlU3RhdGVtZW50cyA9IGV4cC5jb250ZW50LmluY2x1ZGVzKGA7YCk7DQogICAgICB7DQogICAgICAgIHZhbGlkYXRlQnJvd3NlckV4cHJlc3Npb24oDQogICAgICAgICAgZXhwLA0KICAgICAgICAgIGNvbnRleHQsDQogICAgICAgICAgZmFsc2UsDQogICAgICAgICAgaGFzTXVsdGlwbGVTdGF0ZW1lbnRzDQogICAgICAgICk7DQogICAgICB9DQogICAgICBpZiAoaXNJbmxpbmVTdGF0ZW1lbnQgfHwgc2hvdWxkQ2FjaGUgJiYgaXNNZW1iZXJFeHApIHsNCiAgICAgICAgZXhwID0gY3JlYXRlQ29tcG91bmRFeHByZXNzaW9uKFsNCiAgICAgICAgICBgJHtpc0lubGluZVN0YXRlbWVudCA/IGAkZXZlbnRgIDogYCR7YGB9KC4uLmFyZ3MpYH0gPT4gJHtoYXNNdWx0aXBsZVN0YXRlbWVudHMgPyBge2AgOiBgKGB9YCwNCiAgICAgICAgICBleHAsDQogICAgICAgICAgaGFzTXVsdGlwbGVTdGF0ZW1lbnRzID8gYH1gIDogYClgDQogICAgICAgIF0pOw0KICAgICAgfQ0KICAgIH0NCiAgICBsZXQgcmV0ID0gew0KICAgICAgcHJvcHM6IFsNCiAgICAgICAgY3JlYXRlT2JqZWN0UHJvcGVydHkoDQogICAgICAgICAgZXZlbnROYW1lLA0KICAgICAgICAgIGV4cCB8fCBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGAoKSA9PiB7fWAsIGZhbHNlLCBsb2MpDQogICAgICAgICkNCiAgICAgIF0NCiAgICB9Ow0KICAgIGlmIChhdWdtZW50b3IpIHsNCiAgICAgIHJldCA9IGF1Z21lbnRvcihyZXQpOw0KICAgIH0NCiAgICBpZiAoc2hvdWxkQ2FjaGUpIHsNCiAgICAgIHJldC5wcm9wc1swXS52YWx1ZSA9IGNvbnRleHQuY2FjaGUocmV0LnByb3BzWzBdLnZhbHVlKTsNCiAgICB9DQogICAgcmV0LnByb3BzLmZvckVhY2goKHApID0+IHAua2V5LmlzSGFuZGxlcktleSA9IHRydWUpOw0KICAgIHJldHVybiByZXQ7DQogIH07DQoNCiAgY29uc3QgdHJhbnNmb3JtVGV4dCA9IChub2RlLCBjb250ZXh0KSA9PiB7DQogICAgaWYgKG5vZGUudHlwZSA9PT0gMCB8fCBub2RlLnR5cGUgPT09IDEgfHwgbm9kZS50eXBlID09PSAxMSB8fCBub2RlLnR5cGUgPT09IDEwKSB7DQogICAgICByZXR1cm4gKCkgPT4gew0KICAgICAgICBjb25zdCBjaGlsZHJlbiA9IG5vZGUuY2hpbGRyZW47DQogICAgICAgIGxldCBjdXJyZW50Q29udGFpbmVyID0gdm9pZCAwOw0KICAgICAgICBsZXQgaGFzVGV4dCA9IGZhbHNlOw0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXTsNCiAgICAgICAgICBpZiAoaXNUZXh0JDEoY2hpbGQpKSB7DQogICAgICAgICAgICBoYXNUZXh0ID0gdHJ1ZTsNCiAgICAgICAgICAgIGZvciAobGV0IGogPSBpICsgMTsgaiA8IGNoaWxkcmVuLmxlbmd0aDsgaisrKSB7DQogICAgICAgICAgICAgIGNvbnN0IG5leHQgPSBjaGlsZHJlbltqXTsNCiAgICAgICAgICAgICAgaWYgKGlzVGV4dCQxKG5leHQpKSB7DQogICAgICAgICAgICAgICAgaWYgKCFjdXJyZW50Q29udGFpbmVyKSB7DQogICAgICAgICAgICAgICAgICBjdXJyZW50Q29udGFpbmVyID0gY2hpbGRyZW5baV0gPSBjcmVhdGVDb21wb3VuZEV4cHJlc3Npb24oDQogICAgICAgICAgICAgICAgICAgIFtjaGlsZF0sDQogICAgICAgICAgICAgICAgICAgIGNoaWxkLmxvYw0KICAgICAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgY3VycmVudENvbnRhaW5lci5jaGlsZHJlbi5wdXNoKGAgKyBgLCBuZXh0KTsNCiAgICAgICAgICAgICAgICBjaGlsZHJlbi5zcGxpY2UoaiwgMSk7DQogICAgICAgICAgICAgICAgai0tOw0KICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGN1cnJlbnRDb250YWluZXIgPSB2b2lkIDA7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFoYXNUZXh0IHx8IC8vIGlmIHRoaXMgaXMgYSBwbGFpbiBlbGVtZW50IHdpdGggYSBzaW5nbGUgdGV4dCBjaGlsZCwgbGVhdmUgaXQNCiAgICAgICAgLy8gYXMtaXMgc2luY2UgdGhlIHJ1bnRpbWUgaGFzIGRlZGljYXRlZCBmYXN0IHBhdGggZm9yIHRoaXMgYnkgZGlyZWN0bHkNCiAgICAgICAgLy8gc2V0dGluZyB0ZXh0Q29udGVudCBvZiB0aGUgZWxlbWVudC4NCiAgICAgICAgLy8gZm9yIGNvbXBvbmVudCByb290IGl0J3MgYWx3YXlzIG5vcm1hbGl6ZWQgYW55d2F5Lg0KICAgICAgICBjaGlsZHJlbi5sZW5ndGggPT09IDEgJiYgKG5vZGUudHlwZSA9PT0gMCB8fCBub2RlLnR5cGUgPT09IDEgJiYgbm9kZS50YWdUeXBlID09PSAwICYmIC8vICMzNzU2DQogICAgICAgIC8vIGN1c3RvbSBkaXJlY3RpdmVzIGNhbiBwb3RlbnRpYWxseSBhZGQgRE9NIGVsZW1lbnRzIGFyYml0cmFyaWx5LA0KICAgICAgICAvLyB3ZSBuZWVkIHRvIGF2b2lkIHNldHRpbmcgdGV4dENvbnRlbnQgb2YgdGhlIGVsZW1lbnQgYXQgcnVudGltZQ0KICAgICAgICAvLyB0byBhdm9pZCBhY2NpZGVudGFsbHkgb3ZlcndyaXRpbmcgdGhlIERPTSBlbGVtZW50cyBhZGRlZA0KICAgICAgICAvLyBieSB0aGUgdXNlciB0aHJvdWdoIGN1c3RvbSBkaXJlY3RpdmVzLg0KICAgICAgICAhbm9kZS5wcm9wcy5maW5kKA0KICAgICAgICAgIChwKSA9PiBwLnR5cGUgPT09IDcgJiYgIWNvbnRleHQuZGlyZWN0aXZlVHJhbnNmb3Jtc1twLm5hbWVdDQogICAgICAgICkgJiYgLy8gaW4gY29tcGF0IG1vZGUsIDx0ZW1wbGF0ZT4gdGFncyB3aXRoIG5vIHNwZWNpYWwgZGlyZWN0aXZlcw0KICAgICAgICAvLyB3aWxsIGJlIHJlbmRlcmVkIGFzIGEgZnJhZ21lbnQgc28gaXRzIGNoaWxkcmVuIG11c3QgYmUNCiAgICAgICAgLy8gY29udmVydGVkIGludG8gdm5vZGVzLg0KICAgICAgICB0cnVlKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXTsNCiAgICAgICAgICBpZiAoaXNUZXh0JDEoY2hpbGQpIHx8IGNoaWxkLnR5cGUgPT09IDgpIHsNCiAgICAgICAgICAgIGNvbnN0IGNhbGxBcmdzID0gW107DQogICAgICAgICAgICBpZiAoY2hpbGQudHlwZSAhPT0gMiB8fCBjaGlsZC5jb250ZW50ICE9PSAiICIpIHsNCiAgICAgICAgICAgICAgY2FsbEFyZ3MucHVzaChjaGlsZCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoIWNvbnRleHQuc3NyICYmIGdldENvbnN0YW50VHlwZShjaGlsZCwgY29udGV4dCkgPT09IDApIHsNCiAgICAgICAgICAgICAgY2FsbEFyZ3MucHVzaCgNCiAgICAgICAgICAgICAgICAxICsgKGAgLyogJHtQYXRjaEZsYWdOYW1lc1sxXX0gKi9gICkNCiAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNoaWxkcmVuW2ldID0gew0KICAgICAgICAgICAgICB0eXBlOiAxMiwNCiAgICAgICAgICAgICAgY29udGVudDogY2hpbGQsDQogICAgICAgICAgICAgIGxvYzogY2hpbGQubG9jLA0KICAgICAgICAgICAgICBjb2RlZ2VuTm9kZTogY3JlYXRlQ2FsbEV4cHJlc3Npb24oDQogICAgICAgICAgICAgICAgY29udGV4dC5oZWxwZXIoQ1JFQVRFX1RFWFQpLA0KICAgICAgICAgICAgICAgIGNhbGxBcmdzDQogICAgICAgICAgICAgICkNCiAgICAgICAgICAgIH07DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9Ow0KICAgIH0NCiAgfTsNCg0KICBjb25zdCBzZWVuJDEgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKTsNCiAgY29uc3QgdHJhbnNmb3JtT25jZSA9IChub2RlLCBjb250ZXh0KSA9PiB7DQogICAgaWYgKG5vZGUudHlwZSA9PT0gMSAmJiBmaW5kRGlyKG5vZGUsICJvbmNlIiwgdHJ1ZSkpIHsNCiAgICAgIGlmIChzZWVuJDEuaGFzKG5vZGUpIHx8IGNvbnRleHQuaW5WT25jZSB8fCBjb250ZXh0LmluU1NSKSB7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIHNlZW4kMS5hZGQobm9kZSk7DQogICAgICBjb250ZXh0LmluVk9uY2UgPSB0cnVlOw0KICAgICAgY29udGV4dC5oZWxwZXIoU0VUX0JMT0NLX1RSQUNLSU5HKTsNCiAgICAgIHJldHVybiAoKSA9PiB7DQogICAgICAgIGNvbnRleHQuaW5WT25jZSA9IGZhbHNlOw0KICAgICAgICBjb25zdCBjdXIgPSBjb250ZXh0LmN1cnJlbnROb2RlOw0KICAgICAgICBpZiAoY3VyLmNvZGVnZW5Ob2RlKSB7DQogICAgICAgICAgY3VyLmNvZGVnZW5Ob2RlID0gY29udGV4dC5jYWNoZSgNCiAgICAgICAgICAgIGN1ci5jb2RlZ2VuTm9kZSwNCiAgICAgICAgICAgIHRydWUsDQogICAgICAgICAgICB0cnVlDQogICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgICAgfTsNCiAgICB9DQogIH07DQoNCiAgY29uc3QgdHJhbnNmb3JtTW9kZWwkMSA9IChkaXIsIG5vZGUsIGNvbnRleHQpID0+IHsNCiAgICBjb25zdCB7IGV4cCwgYXJnIH0gPSBkaXI7DQogICAgaWYgKCFleHApIHsNCiAgICAgIGNvbnRleHQub25FcnJvcigNCiAgICAgICAgY3JlYXRlQ29tcGlsZXJFcnJvcig0MSwgZGlyLmxvYykNCiAgICAgICk7DQogICAgICByZXR1cm4gY3JlYXRlVHJhbnNmb3JtUHJvcHMoKTsNCiAgICB9DQogICAgY29uc3QgcmF3RXhwID0gZXhwLmxvYy5zb3VyY2UudHJpbSgpOw0KICAgIGNvbnN0IGV4cFN0cmluZyA9IGV4cC50eXBlID09PSA0ID8gZXhwLmNvbnRlbnQgOiByYXdFeHA7DQogICAgY29uc3QgYmluZGluZ1R5cGUgPSBjb250ZXh0LmJpbmRpbmdNZXRhZGF0YVtyYXdFeHBdOw0KICAgIGlmIChiaW5kaW5nVHlwZSA9PT0gInByb3BzIiB8fCBiaW5kaW5nVHlwZSA9PT0gInByb3BzLWFsaWFzZWQiKSB7DQogICAgICBjb250ZXh0Lm9uRXJyb3IoY3JlYXRlQ29tcGlsZXJFcnJvcig0NCwgZXhwLmxvYykpOw0KICAgICAgcmV0dXJuIGNyZWF0ZVRyYW5zZm9ybVByb3BzKCk7DQogICAgfQ0KICAgIGlmICghZXhwU3RyaW5nLnRyaW0oKSB8fCAhaXNNZW1iZXJFeHByZXNzaW9uKGV4cCkgJiYgdHJ1ZSkgew0KICAgICAgY29udGV4dC5vbkVycm9yKA0KICAgICAgICBjcmVhdGVDb21waWxlckVycm9yKDQyLCBleHAubG9jKQ0KICAgICAgKTsNCiAgICAgIHJldHVybiBjcmVhdGVUcmFuc2Zvcm1Qcm9wcygpOw0KICAgIH0NCiAgICBjb25zdCBwcm9wTmFtZSA9IGFyZyA/IGFyZyA6IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oIm1vZGVsVmFsdWUiLCB0cnVlKTsNCiAgICBjb25zdCBldmVudE5hbWUgPSBhcmcgPyBpc1N0YXRpY0V4cChhcmcpID8gYG9uVXBkYXRlOiR7Y2FtZWxpemUoYXJnLmNvbnRlbnQpfWAgOiBjcmVhdGVDb21wb3VuZEV4cHJlc3Npb24oWycib25VcGRhdGU6IiArICcsIGFyZ10pIDogYG9uVXBkYXRlOm1vZGVsVmFsdWVgOw0KICAgIGxldCBhc3NpZ25tZW50RXhwOw0KICAgIGNvbnN0IGV2ZW50QXJnID0gY29udGV4dC5pc1RTID8gYCgkZXZlbnQ6IGFueSlgIDogYCRldmVudGA7DQogICAgew0KICAgICAgYXNzaWdubWVudEV4cCA9IGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbihbDQogICAgICAgIGAke2V2ZW50QXJnfSA9PiAoKGAsDQogICAgICAgIGV4cCwNCiAgICAgICAgYCkgPSAkZXZlbnQpYA0KICAgICAgXSk7DQogICAgfQ0KICAgIGNvbnN0IHByb3BzID0gWw0KICAgICAgLy8gbW9kZWxWYWx1ZTogZm9vDQogICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eShwcm9wTmFtZSwgZGlyLmV4cCksDQogICAgICAvLyAib25VcGRhdGU6bW9kZWxWYWx1ZSI6ICRldmVudCA9PiAoZm9vID0gJGV2ZW50KQ0KICAgICAgY3JlYXRlT2JqZWN0UHJvcGVydHkoZXZlbnROYW1lLCBhc3NpZ25tZW50RXhwKQ0KICAgIF07DQogICAgaWYgKGRpci5tb2RpZmllcnMubGVuZ3RoICYmIG5vZGUudGFnVHlwZSA9PT0gMSkgew0KICAgICAgY29uc3QgbW9kaWZpZXJzID0gZGlyLm1vZGlmaWVycy5tYXAoKG0pID0+IG0uY29udGVudCkubWFwKChtKSA9PiAoaXNTaW1wbGVJZGVudGlmaWVyKG0pID8gbSA6IEpTT04uc3RyaW5naWZ5KG0pKSArIGA6IHRydWVgKS5qb2luKGAsIGApOw0KICAgICAgY29uc3QgbW9kaWZpZXJzS2V5ID0gYXJnID8gaXNTdGF0aWNFeHAoYXJnKSA/IGAke2FyZy5jb250ZW50fU1vZGlmaWVyc2AgOiBjcmVhdGVDb21wb3VuZEV4cHJlc3Npb24oW2FyZywgJyArICJNb2RpZmllcnMiJ10pIDogYG1vZGVsTW9kaWZpZXJzYDsNCiAgICAgIHByb3BzLnB1c2goDQogICAgICAgIGNyZWF0ZU9iamVjdFByb3BlcnR5KA0KICAgICAgICAgIG1vZGlmaWVyc0tleSwNCiAgICAgICAgICBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKA0KICAgICAgICAgICAgYHsgJHttb2RpZmllcnN9IH1gLA0KICAgICAgICAgICAgZmFsc2UsDQogICAgICAgICAgICBkaXIubG9jLA0KICAgICAgICAgICAgMg0KICAgICAgICAgICkNCiAgICAgICAgKQ0KICAgICAgKTsNCiAgICB9DQogICAgcmV0dXJuIGNyZWF0ZVRyYW5zZm9ybVByb3BzKHByb3BzKTsNCiAgfTsNCiAgZnVuY3Rpb24gY3JlYXRlVHJhbnNmb3JtUHJvcHMocHJvcHMgPSBbXSkgew0KICAgIHJldHVybiB7IHByb3BzIH07DQogIH0NCg0KICBjb25zdCBzZWVuID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCk7DQogIGNvbnN0IHRyYW5zZm9ybU1lbW8gPSAobm9kZSwgY29udGV4dCkgPT4gew0KICAgIGlmIChub2RlLnR5cGUgPT09IDEpIHsNCiAgICAgIGNvbnN0IGRpciA9IGZpbmREaXIobm9kZSwgIm1lbW8iKTsNCiAgICAgIGlmICghZGlyIHx8IHNlZW4uaGFzKG5vZGUpKSB7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIHNlZW4uYWRkKG5vZGUpOw0KICAgICAgcmV0dXJuICgpID0+IHsNCiAgICAgICAgY29uc3QgY29kZWdlbk5vZGUgPSBub2RlLmNvZGVnZW5Ob2RlIHx8IGNvbnRleHQuY3VycmVudE5vZGUuY29kZWdlbk5vZGU7DQogICAgICAgIGlmIChjb2RlZ2VuTm9kZSAmJiBjb2RlZ2VuTm9kZS50eXBlID09PSAxMykgew0KICAgICAgICAgIGlmIChub2RlLnRhZ1R5cGUgIT09IDEpIHsNCiAgICAgICAgICAgIGNvbnZlcnRUb0Jsb2NrKGNvZGVnZW5Ob2RlLCBjb250ZXh0KTsNCiAgICAgICAgICB9DQogICAgICAgICAgbm9kZS5jb2RlZ2VuTm9kZSA9IGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKFdJVEhfTUVNTyksIFsNCiAgICAgICAgICAgIGRpci5leHAsDQogICAgICAgICAgICBjcmVhdGVGdW5jdGlvbkV4cHJlc3Npb24odm9pZCAwLCBjb2RlZ2VuTm9kZSksDQogICAgICAgICAgICBgX2NhY2hlYCwNCiAgICAgICAgICAgIFN0cmluZyhjb250ZXh0LmNhY2hlZC5sZW5ndGgpDQogICAgICAgICAgXSk7DQogICAgICAgICAgY29udGV4dC5jYWNoZWQucHVzaChudWxsKTsNCiAgICAgICAgfQ0KICAgICAgfTsNCiAgICB9DQogIH07DQoNCiAgZnVuY3Rpb24gZ2V0QmFzZVRyYW5zZm9ybVByZXNldChwcmVmaXhJZGVudGlmaWVycykgew0KICAgIHJldHVybiBbDQogICAgICBbDQogICAgICAgIHRyYW5zZm9ybU9uY2UsDQogICAgICAgIHRyYW5zZm9ybUlmLA0KICAgICAgICB0cmFuc2Zvcm1NZW1vLA0KICAgICAgICB0cmFuc2Zvcm1Gb3IsDQogICAgICAgIC4uLltdLA0KICAgICAgICAuLi5bdHJhbnNmb3JtRXhwcmVzc2lvbl0gLA0KICAgICAgICB0cmFuc2Zvcm1TbG90T3V0bGV0LA0KICAgICAgICB0cmFuc2Zvcm1FbGVtZW50LA0KICAgICAgICB0cmFja1Nsb3RTY29wZXMsDQogICAgICAgIHRyYW5zZm9ybVRleHQNCiAgICAgIF0sDQogICAgICB7DQogICAgICAgIG9uOiB0cmFuc2Zvcm1PbiQxLA0KICAgICAgICBiaW5kOiB0cmFuc2Zvcm1CaW5kLA0KICAgICAgICBtb2RlbDogdHJhbnNmb3JtTW9kZWwkMQ0KICAgICAgfQ0KICAgIF07DQogIH0NCiAgZnVuY3Rpb24gYmFzZUNvbXBpbGUoc291cmNlLCBvcHRpb25zID0ge30pIHsNCiAgICBjb25zdCBvbkVycm9yID0gb3B0aW9ucy5vbkVycm9yIHx8IGRlZmF1bHRPbkVycm9yOw0KICAgIGNvbnN0IGlzTW9kdWxlTW9kZSA9IG9wdGlvbnMubW9kZSA9PT0gIm1vZHVsZSI7DQogICAgew0KICAgICAgaWYgKG9wdGlvbnMucHJlZml4SWRlbnRpZmllcnMgPT09IHRydWUpIHsNCiAgICAgICAgb25FcnJvcihjcmVhdGVDb21waWxlckVycm9yKDQ3KSk7DQogICAgICB9IGVsc2UgaWYgKGlzTW9kdWxlTW9kZSkgew0KICAgICAgICBvbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoNDgpKTsNCiAgICAgIH0NCiAgICB9DQogICAgY29uc3QgcHJlZml4SWRlbnRpZmllcnMgPSBmYWxzZTsNCiAgICBpZiAob3B0aW9ucy5jYWNoZUhhbmRsZXJzKSB7DQogICAgICBvbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoNDkpKTsNCiAgICB9DQogICAgaWYgKG9wdGlvbnMuc2NvcGVJZCAmJiAhaXNNb2R1bGVNb2RlKSB7DQogICAgICBvbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoNTApKTsNCiAgICB9DQogICAgY29uc3QgcmVzb2x2ZWRPcHRpb25zID0gZXh0ZW5kKHt9LCBvcHRpb25zLCB7DQogICAgICBwcmVmaXhJZGVudGlmaWVycw0KICAgIH0pOw0KICAgIGNvbnN0IGFzdCA9IGlzU3RyaW5nKHNvdXJjZSkgPyBiYXNlUGFyc2Uoc291cmNlLCByZXNvbHZlZE9wdGlvbnMpIDogc291cmNlOw0KICAgIGNvbnN0IFtub2RlVHJhbnNmb3JtcywgZGlyZWN0aXZlVHJhbnNmb3Jtc10gPSBnZXRCYXNlVHJhbnNmb3JtUHJlc2V0KCk7DQogICAgdHJhbnNmb3JtKA0KICAgICAgYXN0LA0KICAgICAgZXh0ZW5kKHt9LCByZXNvbHZlZE9wdGlvbnMsIHsNCiAgICAgICAgbm9kZVRyYW5zZm9ybXM6IFsNCiAgICAgICAgICAuLi5ub2RlVHJhbnNmb3JtcywNCiAgICAgICAgICAuLi5vcHRpb25zLm5vZGVUcmFuc2Zvcm1zIHx8IFtdDQogICAgICAgICAgLy8gdXNlciB0cmFuc2Zvcm1zDQogICAgICAgIF0sDQogICAgICAgIGRpcmVjdGl2ZVRyYW5zZm9ybXM6IGV4dGVuZCgNCiAgICAgICAgICB7fSwNCiAgICAgICAgICBkaXJlY3RpdmVUcmFuc2Zvcm1zLA0KICAgICAgICAgIG9wdGlvbnMuZGlyZWN0aXZlVHJhbnNmb3JtcyB8fCB7fQ0KICAgICAgICAgIC8vIHVzZXIgdHJhbnNmb3Jtcw0KICAgICAgICApDQogICAgICB9KQ0KICAgICk7DQogICAgcmV0dXJuIGdlbmVyYXRlKGFzdCwgcmVzb2x2ZWRPcHRpb25zKTsNCiAgfQ0KDQogIGNvbnN0IG5vb3BEaXJlY3RpdmVUcmFuc2Zvcm0gPSAoKSA9PiAoeyBwcm9wczogW10gfSk7DQoNCiAgY29uc3QgVl9NT0RFTF9SQURJTyA9IFN5bWJvbChgdk1vZGVsUmFkaW9gICk7DQogIGNvbnN0IFZfTU9ERUxfQ0hFQ0tCT1ggPSBTeW1ib2woDQogICAgYHZNb2RlbENoZWNrYm94YCANCiAgKTsNCiAgY29uc3QgVl9NT0RFTF9URVhUID0gU3ltYm9sKGB2TW9kZWxUZXh0YCApOw0KICBjb25zdCBWX01PREVMX1NFTEVDVCA9IFN5bWJvbCgNCiAgICBgdk1vZGVsU2VsZWN0YCANCiAgKTsNCiAgY29uc3QgVl9NT0RFTF9EWU5BTUlDID0gU3ltYm9sKA0KICAgIGB2TW9kZWxEeW5hbWljYCANCiAgKTsNCiAgY29uc3QgVl9PTl9XSVRIX01PRElGSUVSUyA9IFN5bWJvbCgNCiAgICBgdk9uTW9kaWZpZXJzR3VhcmRgIA0KICApOw0KICBjb25zdCBWX09OX1dJVEhfS0VZUyA9IFN5bWJvbCgNCiAgICBgdk9uS2V5c0d1YXJkYCANCiAgKTsNCiAgY29uc3QgVl9TSE9XID0gU3ltYm9sKGB2U2hvd2AgKTsNCiAgY29uc3QgVFJBTlNJVElPTiA9IFN5bWJvbChgVHJhbnNpdGlvbmAgKTsNCiAgY29uc3QgVFJBTlNJVElPTl9HUk9VUCA9IFN5bWJvbCgNCiAgICBgVHJhbnNpdGlvbkdyb3VwYCANCiAgKTsNCiAgcmVnaXN0ZXJSdW50aW1lSGVscGVycyh7DQogICAgW1ZfTU9ERUxfUkFESU9dOiBgdk1vZGVsUmFkaW9gLA0KICAgIFtWX01PREVMX0NIRUNLQk9YXTogYHZNb2RlbENoZWNrYm94YCwNCiAgICBbVl9NT0RFTF9URVhUXTogYHZNb2RlbFRleHRgLA0KICAgIFtWX01PREVMX1NFTEVDVF06IGB2TW9kZWxTZWxlY3RgLA0KICAgIFtWX01PREVMX0RZTkFNSUNdOiBgdk1vZGVsRHluYW1pY2AsDQogICAgW1ZfT05fV0lUSF9NT0RJRklFUlNdOiBgd2l0aE1vZGlmaWVyc2AsDQogICAgW1ZfT05fV0lUSF9LRVlTXTogYHdpdGhLZXlzYCwNCiAgICBbVl9TSE9XXTogYHZTaG93YCwNCiAgICBbVFJBTlNJVElPTl06IGBUcmFuc2l0aW9uYCwNCiAgICBbVFJBTlNJVElPTl9HUk9VUF06IGBUcmFuc2l0aW9uR3JvdXBgDQogIH0pOw0KDQogIGxldCBkZWNvZGVyOw0KICBmdW5jdGlvbiBkZWNvZGVIdG1sQnJvd3NlcihyYXcsIGFzQXR0ciA9IGZhbHNlKSB7DQogICAgaWYgKCFkZWNvZGVyKSB7DQogICAgICBkZWNvZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgfQ0KICAgIGlmIChhc0F0dHIpIHsNCiAgICAgIGRlY29kZXIuaW5uZXJIVE1MID0gYDxkaXYgZm9vPSIke3Jhdy5yZXBsYWNlKC8iL2csICImcXVvdDsiKX0iPmA7DQogICAgICByZXR1cm4gZGVjb2Rlci5jaGlsZHJlblswXS5nZXRBdHRyaWJ1dGUoImZvbyIpOw0KICAgIH0gZWxzZSB7DQogICAgICBkZWNvZGVyLmlubmVySFRNTCA9IHJhdzsNCiAgICAgIHJldHVybiBkZWNvZGVyLnRleHRDb250ZW50Ow0KICAgIH0NCiAgfQ0KDQogIGNvbnN0IHBhcnNlck9wdGlvbnMgPSB7DQogICAgcGFyc2VNb2RlOiAiaHRtbCIsDQogICAgaXNWb2lkVGFnLA0KICAgIGlzTmF0aXZlVGFnOiAodGFnKSA9PiBpc0hUTUxUYWcodGFnKSB8fCBpc1NWR1RhZyh0YWcpIHx8IGlzTWF0aE1MVGFnKHRhZyksDQogICAgaXNQcmVUYWc6ICh0YWcpID0+IHRhZyA9PT0gInByZSIsDQogICAgaXNJZ25vcmVOZXdsaW5lVGFnOiAodGFnKSA9PiB0YWcgPT09ICJwcmUiIHx8IHRhZyA9PT0gInRleHRhcmVhIiwNCiAgICBkZWNvZGVFbnRpdGllczogZGVjb2RlSHRtbEJyb3dzZXIgLA0KICAgIGlzQnVpbHRJbkNvbXBvbmVudDogKHRhZykgPT4gew0KICAgICAgaWYgKHRhZyA9PT0gIlRyYW5zaXRpb24iIHx8IHRhZyA9PT0gInRyYW5zaXRpb24iKSB7DQogICAgICAgIHJldHVybiBUUkFOU0lUSU9OOw0KICAgICAgfSBlbHNlIGlmICh0YWcgPT09ICJUcmFuc2l0aW9uR3JvdXAiIHx8IHRhZyA9PT0gInRyYW5zaXRpb24tZ3JvdXAiKSB7DQogICAgICAgIHJldHVybiBUUkFOU0lUSU9OX0dST1VQOw0KICAgICAgfQ0KICAgIH0sDQogICAgLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2UvcGFyc2luZy5odG1sI3RyZWUtY29uc3RydWN0aW9uLWRpc3BhdGNoZXINCiAgICBnZXROYW1lc3BhY2UodGFnLCBwYXJlbnQsIHJvb3ROYW1lc3BhY2UpIHsNCiAgICAgIGxldCBucyA9IHBhcmVudCA/IHBhcmVudC5ucyA6IHJvb3ROYW1lc3BhY2U7DQogICAgICBpZiAocGFyZW50ICYmIG5zID09PSAyKSB7DQogICAgICAgIGlmIChwYXJlbnQudGFnID09PSAiYW5ub3RhdGlvbi14bWwiKSB7DQogICAgICAgICAgaWYgKHRhZyA9PT0gInN2ZyIpIHsNCiAgICAgICAgICAgIHJldHVybiAxOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpZiAocGFyZW50LnByb3BzLnNvbWUoDQogICAgICAgICAgICAoYSkgPT4gYS50eXBlID09PSA2ICYmIGEubmFtZSA9PT0gImVuY29kaW5nIiAmJiBhLnZhbHVlICE9IG51bGwgJiYgKGEudmFsdWUuY29udGVudCA9PT0gInRleHQvaHRtbCIgfHwgYS52YWx1ZS5jb250ZW50ID09PSAiYXBwbGljYXRpb24veGh0bWwreG1sIikNCiAgICAgICAgICApKSB7DQogICAgICAgICAgICBucyA9IDA7DQogICAgICAgICAgfQ0KICAgICAgICB9IGVsc2UgaWYgKC9ebSg/Oltpb25zXXx0ZXh0KSQvLnRlc3QocGFyZW50LnRhZykgJiYgdGFnICE9PSAibWdseXBoIiAmJiB0YWcgIT09ICJtYWxpZ25tYXJrIikgew0KICAgICAgICAgIG5zID0gMDsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIGlmIChwYXJlbnQgJiYgbnMgPT09IDEpIHsNCiAgICAgICAgaWYgKHBhcmVudC50YWcgPT09ICJmb3JlaWduT2JqZWN0IiB8fCBwYXJlbnQudGFnID09PSAiZGVzYyIgfHwgcGFyZW50LnRhZyA9PT0gInRpdGxlIikgew0KICAgICAgICAgIG5zID0gMDsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgaWYgKG5zID09PSAwKSB7DQogICAgICAgIGlmICh0YWcgPT09ICJzdmciKSB7DQogICAgICAgICAgcmV0dXJuIDE7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHRhZyA9PT0gIm1hdGgiKSB7DQogICAgICAgICAgcmV0dXJuIDI7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHJldHVybiBuczsNCiAgICB9DQogIH07DQoNCiAgY29uc3QgdHJhbnNmb3JtU3R5bGUgPSAobm9kZSkgPT4gew0KICAgIGlmIChub2RlLnR5cGUgPT09IDEpIHsNCiAgICAgIG5vZGUucHJvcHMuZm9yRWFjaCgocCwgaSkgPT4gew0KICAgICAgICBpZiAocC50eXBlID09PSA2ICYmIHAubmFtZSA9PT0gInN0eWxlIiAmJiBwLnZhbHVlKSB7DQogICAgICAgICAgbm9kZS5wcm9wc1tpXSA9IHsNCiAgICAgICAgICAgIHR5cGU6IDcsDQogICAgICAgICAgICBuYW1lOiBgYmluZGAsDQogICAgICAgICAgICBhcmc6IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oYHN0eWxlYCwgdHJ1ZSwgcC5sb2MpLA0KICAgICAgICAgICAgZXhwOiBwYXJzZUlubGluZUNTUyhwLnZhbHVlLmNvbnRlbnQsIHAubG9jKSwNCiAgICAgICAgICAgIG1vZGlmaWVyczogW10sDQogICAgICAgICAgICBsb2M6IHAubG9jDQogICAgICAgICAgfTsNCiAgICAgICAgfQ0KICAgICAgfSk7DQogICAgfQ0KICB9Ow0KICBjb25zdCBwYXJzZUlubGluZUNTUyA9IChjc3NUZXh0LCBsb2MpID0+IHsNCiAgICBjb25zdCBub3JtYWxpemVkID0gcGFyc2VTdHJpbmdTdHlsZShjc3NUZXh0KTsNCiAgICByZXR1cm4gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbigNCiAgICAgIEpTT04uc3RyaW5naWZ5KG5vcm1hbGl6ZWQpLA0KICAgICAgZmFsc2UsDQogICAgICBsb2MsDQogICAgICAzDQogICAgKTsNCiAgfTsNCg0KICBmdW5jdGlvbiBjcmVhdGVET01Db21waWxlckVycm9yKGNvZGUsIGxvYykgew0KICAgIHJldHVybiBjcmVhdGVDb21waWxlckVycm9yKA0KICAgICAgY29kZSwNCiAgICAgIGxvYywNCiAgICAgIERPTUVycm9yTWVzc2FnZXMgDQogICAgKTsNCiAgfQ0KICBjb25zdCBET01FcnJvck1lc3NhZ2VzID0gew0KICAgIFs1M106IGB2LWh0bWwgaXMgbWlzc2luZyBleHByZXNzaW9uLmAsDQogICAgWzU0XTogYHYtaHRtbCB3aWxsIG92ZXJyaWRlIGVsZW1lbnQgY2hpbGRyZW4uYCwNCiAgICBbNTVdOiBgdi10ZXh0IGlzIG1pc3NpbmcgZXhwcmVzc2lvbi5gLA0KICAgIFs1Nl06IGB2LXRleHQgd2lsbCBvdmVycmlkZSBlbGVtZW50IGNoaWxkcmVuLmAsDQogICAgWzU3XTogYHYtbW9kZWwgY2FuIG9ubHkgYmUgdXNlZCBvbiA8aW5wdXQ+LCA8dGV4dGFyZWE+IGFuZCA8c2VsZWN0PiBlbGVtZW50cy5gLA0KICAgIFs1OF06IGB2LW1vZGVsIGFyZ3VtZW50IGlzIG5vdCBzdXBwb3J0ZWQgb24gcGxhaW4gZWxlbWVudHMuYCwNCiAgICBbNTldOiBgdi1tb2RlbCBjYW5ub3QgYmUgdXNlZCBvbiBmaWxlIGlucHV0cyBzaW5jZSB0aGV5IGFyZSByZWFkLW9ubHkuIFVzZSBhIHYtb246Y2hhbmdlIGxpc3RlbmVyIGluc3RlYWQuYCwNCiAgICBbNjBdOiBgVW5uZWNlc3NhcnkgdmFsdWUgYmluZGluZyB1c2VkIGFsb25nc2lkZSB2LW1vZGVsLiBJdCB3aWxsIGludGVyZmVyZSB3aXRoIHYtbW9kZWwncyBiZWhhdmlvci5gLA0KICAgIFs2MV06IGB2LXNob3cgaXMgbWlzc2luZyBleHByZXNzaW9uLmAsDQogICAgWzYyXTogYDxUcmFuc2l0aW9uPiBleHBlY3RzIGV4YWN0bHkgb25lIGNoaWxkIGVsZW1lbnQgb3IgY29tcG9uZW50LmAsDQogICAgWzYzXTogYFRhZ3Mgd2l0aCBzaWRlIGVmZmVjdCAoPHNjcmlwdD4gYW5kIDxzdHlsZT4pIGFyZSBpZ25vcmVkIGluIGNsaWVudCBjb21wb25lbnQgdGVtcGxhdGVzLmANCiAgfTsNCg0KICBjb25zdCB0cmFuc2Zvcm1WSHRtbCA9IChkaXIsIG5vZGUsIGNvbnRleHQpID0+IHsNCiAgICBjb25zdCB7IGV4cCwgbG9jIH0gPSBkaXI7DQogICAgaWYgKCFleHApIHsNCiAgICAgIGNvbnRleHQub25FcnJvcigNCiAgICAgICAgY3JlYXRlRE9NQ29tcGlsZXJFcnJvcig1MywgbG9jKQ0KICAgICAgKTsNCiAgICB9DQogICAgaWYgKG5vZGUuY2hpbGRyZW4ubGVuZ3RoKSB7DQogICAgICBjb250ZXh0Lm9uRXJyb3IoDQogICAgICAgIGNyZWF0ZURPTUNvbXBpbGVyRXJyb3IoNTQsIGxvYykNCiAgICAgICk7DQogICAgICBub2RlLmNoaWxkcmVuLmxlbmd0aCA9IDA7DQogICAgfQ0KICAgIHJldHVybiB7DQogICAgICBwcm9wczogWw0KICAgICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eSgNCiAgICAgICAgICBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGBpbm5lckhUTUxgLCB0cnVlLCBsb2MpLA0KICAgICAgICAgIGV4cCB8fCBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKCIiLCB0cnVlKQ0KICAgICAgICApDQogICAgICBdDQogICAgfTsNCiAgfTsNCg0KICBjb25zdCB0cmFuc2Zvcm1WVGV4dCA9IChkaXIsIG5vZGUsIGNvbnRleHQpID0+IHsNCiAgICBjb25zdCB7IGV4cCwgbG9jIH0gPSBkaXI7DQogICAgaWYgKCFleHApIHsNCiAgICAgIGNvbnRleHQub25FcnJvcigNCiAgICAgICAgY3JlYXRlRE9NQ29tcGlsZXJFcnJvcig1NSwgbG9jKQ0KICAgICAgKTsNCiAgICB9DQogICAgaWYgKG5vZGUuY2hpbGRyZW4ubGVuZ3RoKSB7DQogICAgICBjb250ZXh0Lm9uRXJyb3IoDQogICAgICAgIGNyZWF0ZURPTUNvbXBpbGVyRXJyb3IoNTYsIGxvYykNCiAgICAgICk7DQogICAgICBub2RlLmNoaWxkcmVuLmxlbmd0aCA9IDA7DQogICAgfQ0KICAgIHJldHVybiB7DQogICAgICBwcm9wczogWw0KICAgICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eSgNCiAgICAgICAgICBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGB0ZXh0Q29udGVudGAsIHRydWUpLA0KICAgICAgICAgIGV4cCA/IGdldENvbnN0YW50VHlwZShleHAsIGNvbnRleHQpID4gMCA/IGV4cCA6IGNyZWF0ZUNhbGxFeHByZXNzaW9uKA0KICAgICAgICAgICAgY29udGV4dC5oZWxwZXJTdHJpbmcoVE9fRElTUExBWV9TVFJJTkcpLA0KICAgICAgICAgICAgW2V4cF0sDQogICAgICAgICAgICBsb2MNCiAgICAgICAgICApIDogY3JlYXRlU2ltcGxlRXhwcmVzc2lvbigiIiwgdHJ1ZSkNCiAgICAgICAgKQ0KICAgICAgXQ0KICAgIH07DQogIH07DQoNCiAgY29uc3QgdHJhbnNmb3JtTW9kZWwgPSAoZGlyLCBub2RlLCBjb250ZXh0KSA9PiB7DQogICAgY29uc3QgYmFzZVJlc3VsdCA9IHRyYW5zZm9ybU1vZGVsJDEoZGlyLCBub2RlLCBjb250ZXh0KTsNCiAgICBpZiAoIWJhc2VSZXN1bHQucHJvcHMubGVuZ3RoIHx8IG5vZGUudGFnVHlwZSA9PT0gMSkgew0KICAgICAgcmV0dXJuIGJhc2VSZXN1bHQ7DQogICAgfQ0KICAgIGlmIChkaXIuYXJnKSB7DQogICAgICBjb250ZXh0Lm9uRXJyb3IoDQogICAgICAgIGNyZWF0ZURPTUNvbXBpbGVyRXJyb3IoDQogICAgICAgICAgNTgsDQogICAgICAgICAgZGlyLmFyZy5sb2MNCiAgICAgICAgKQ0KICAgICAgKTsNCiAgICB9DQogICAgZnVuY3Rpb24gY2hlY2tEdXBsaWNhdGVkVmFsdWUoKSB7DQogICAgICBjb25zdCB2YWx1ZSA9IGZpbmREaXIobm9kZSwgImJpbmQiKTsNCiAgICAgIGlmICh2YWx1ZSAmJiBpc1N0YXRpY0FyZ09mKHZhbHVlLmFyZywgInZhbHVlIikpIHsNCiAgICAgICAgY29udGV4dC5vbkVycm9yKA0KICAgICAgICAgIGNyZWF0ZURPTUNvbXBpbGVyRXJyb3IoDQogICAgICAgICAgICA2MCwNCiAgICAgICAgICAgIHZhbHVlLmxvYw0KICAgICAgICAgICkNCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICB9DQogICAgY29uc3QgeyB0YWcgfSA9IG5vZGU7DQogICAgY29uc3QgaXNDdXN0b21FbGVtZW50ID0gY29udGV4dC5pc0N1c3RvbUVsZW1lbnQodGFnKTsNCiAgICBpZiAodGFnID09PSAiaW5wdXQiIHx8IHRhZyA9PT0gInRleHRhcmVhIiB8fCB0YWcgPT09ICJzZWxlY3QiIHx8IGlzQ3VzdG9tRWxlbWVudCkgew0KICAgICAgbGV0IGRpcmVjdGl2ZVRvVXNlID0gVl9NT0RFTF9URVhUOw0KICAgICAgbGV0IGlzSW52YWxpZFR5cGUgPSBmYWxzZTsNCiAgICAgIGlmICh0YWcgPT09ICJpbnB1dCIgfHwgaXNDdXN0b21FbGVtZW50KSB7DQogICAgICAgIGNvbnN0IHR5cGUgPSBmaW5kUHJvcChub2RlLCBgdHlwZWApOw0KICAgICAgICBpZiAodHlwZSkgew0KICAgICAgICAgIGlmICh0eXBlLnR5cGUgPT09IDcpIHsNCiAgICAgICAgICAgIGRpcmVjdGl2ZVRvVXNlID0gVl9NT0RFTF9EWU5BTUlDOw0KICAgICAgICAgIH0gZWxzZSBpZiAodHlwZS52YWx1ZSkgew0KICAgICAgICAgICAgc3dpdGNoICh0eXBlLnZhbHVlLmNvbnRlbnQpIHsNCiAgICAgICAgICAgICAgY2FzZSAicmFkaW8iOg0KICAgICAgICAgICAgICAgIGRpcmVjdGl2ZVRvVXNlID0gVl9NT0RFTF9SQURJTzsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgY2FzZSAiY2hlY2tib3giOg0KICAgICAgICAgICAgICAgIGRpcmVjdGl2ZVRvVXNlID0gVl9NT0RFTF9DSEVDS0JPWDsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgY2FzZSAiZmlsZSI6DQogICAgICAgICAgICAgICAgaXNJbnZhbGlkVHlwZSA9IHRydWU7DQogICAgICAgICAgICAgICAgY29udGV4dC5vbkVycm9yKA0KICAgICAgICAgICAgICAgICAgY3JlYXRlRE9NQ29tcGlsZXJFcnJvcigNCiAgICAgICAgICAgICAgICAgICAgNTksDQogICAgICAgICAgICAgICAgICAgIGRpci5sb2MNCiAgICAgICAgICAgICAgICAgICkNCiAgICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICBkZWZhdWx0Og0KICAgICAgICAgICAgICAgIGNoZWNrRHVwbGljYXRlZFZhbHVlKCk7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9IGVsc2UgaWYgKGhhc0R5bmFtaWNLZXlWQmluZChub2RlKSkgew0KICAgICAgICAgIGRpcmVjdGl2ZVRvVXNlID0gVl9NT0RFTF9EWU5BTUlDOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGNoZWNrRHVwbGljYXRlZFZhbHVlKCk7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSBpZiAodGFnID09PSAic2VsZWN0Iikgew0KICAgICAgICBkaXJlY3RpdmVUb1VzZSA9IFZfTU9ERUxfU0VMRUNUOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY2hlY2tEdXBsaWNhdGVkVmFsdWUoKTsNCiAgICAgIH0NCiAgICAgIGlmICghaXNJbnZhbGlkVHlwZSkgew0KICAgICAgICBiYXNlUmVzdWx0Lm5lZWRSdW50aW1lID0gY29udGV4dC5oZWxwZXIoZGlyZWN0aXZlVG9Vc2UpOw0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICBjb250ZXh0Lm9uRXJyb3IoDQogICAgICAgIGNyZWF0ZURPTUNvbXBpbGVyRXJyb3IoDQogICAgICAgICAgNTcsDQogICAgICAgICAgZGlyLmxvYw0KICAgICAgICApDQogICAgICApOw0KICAgIH0NCiAgICBiYXNlUmVzdWx0LnByb3BzID0gYmFzZVJlc3VsdC5wcm9wcy5maWx0ZXIoDQogICAgICAocCkgPT4gIShwLmtleS50eXBlID09PSA0ICYmIHAua2V5LmNvbnRlbnQgPT09ICJtb2RlbFZhbHVlIikNCiAgICApOw0KICAgIHJldHVybiBiYXNlUmVzdWx0Ow0KICB9Ow0KDQogIGNvbnN0IGlzRXZlbnRPcHRpb25Nb2RpZmllciA9IC8qIEBfX1BVUkVfXyAqLyBtYWtlTWFwKGBwYXNzaXZlLG9uY2UsY2FwdHVyZWApOw0KICBjb25zdCBpc05vbktleU1vZGlmaWVyID0gLyogQF9fUFVSRV9fICovIG1ha2VNYXAoDQogICAgLy8gZXZlbnQgcHJvcGFnYXRpb24gbWFuYWdlbWVudA0KICAgIGBzdG9wLHByZXZlbnQsc2VsZixjdHJsLHNoaWZ0LGFsdCxtZXRhLGV4YWN0LG1pZGRsZWANCiAgKTsNCiAgY29uc3QgbWF5YmVLZXlNb2RpZmllciA9IC8qIEBfX1BVUkVfXyAqLyBtYWtlTWFwKCJsZWZ0LHJpZ2h0Iik7DQogIGNvbnN0IGlzS2V5Ym9hcmRFdmVudCA9IC8qIEBfX1BVUkVfXyAqLyBtYWtlTWFwKGBvbmtleXVwLG9ua2V5ZG93bixvbmtleXByZXNzYCk7DQogIGNvbnN0IHJlc29sdmVNb2RpZmllcnMgPSAoa2V5LCBtb2RpZmllcnMsIGNvbnRleHQsIGxvYykgPT4gew0KICAgIGNvbnN0IGtleU1vZGlmaWVycyA9IFtdOw0KICAgIGNvbnN0IG5vbktleU1vZGlmaWVycyA9IFtdOw0KICAgIGNvbnN0IGV2ZW50T3B0aW9uTW9kaWZpZXJzID0gW107DQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtb2RpZmllcnMubGVuZ3RoOyBpKyspIHsNCiAgICAgIGNvbnN0IG1vZGlmaWVyID0gbW9kaWZpZXJzW2ldLmNvbnRlbnQ7DQogICAgICBpZiAoaXNFdmVudE9wdGlvbk1vZGlmaWVyKG1vZGlmaWVyKSkgew0KICAgICAgICBldmVudE9wdGlvbk1vZGlmaWVycy5wdXNoKG1vZGlmaWVyKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGlmIChtYXliZUtleU1vZGlmaWVyKG1vZGlmaWVyKSkgew0KICAgICAgICAgIGlmIChpc1N0YXRpY0V4cChrZXkpKSB7DQogICAgICAgICAgICBpZiAoaXNLZXlib2FyZEV2ZW50KGtleS5jb250ZW50LnRvTG93ZXJDYXNlKCkpKSB7DQogICAgICAgICAgICAgIGtleU1vZGlmaWVycy5wdXNoKG1vZGlmaWVyKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgIG5vbktleU1vZGlmaWVycy5wdXNoKG1vZGlmaWVyKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAga2V5TW9kaWZpZXJzLnB1c2gobW9kaWZpZXIpOw0KICAgICAgICAgICAgbm9uS2V5TW9kaWZpZXJzLnB1c2gobW9kaWZpZXIpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBpZiAoaXNOb25LZXlNb2RpZmllcihtb2RpZmllcikpIHsNCiAgICAgICAgICAgIG5vbktleU1vZGlmaWVycy5wdXNoKG1vZGlmaWVyKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAga2V5TW9kaWZpZXJzLnB1c2gobW9kaWZpZXIpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gew0KICAgICAga2V5TW9kaWZpZXJzLA0KICAgICAgbm9uS2V5TW9kaWZpZXJzLA0KICAgICAgZXZlbnRPcHRpb25Nb2RpZmllcnMNCiAgICB9Ow0KICB9Ow0KICBjb25zdCB0cmFuc2Zvcm1DbGljayA9IChrZXksIGV2ZW50KSA9PiB7DQogICAgY29uc3QgaXNTdGF0aWNDbGljayA9IGlzU3RhdGljRXhwKGtleSkgJiYga2V5LmNvbnRlbnQudG9Mb3dlckNhc2UoKSA9PT0gIm9uY2xpY2siOw0KICAgIHJldHVybiBpc1N0YXRpY0NsaWNrID8gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihldmVudCwgdHJ1ZSkgOiBrZXkudHlwZSAhPT0gNCA/IGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbihbDQogICAgICBgKGAsDQogICAgICBrZXksDQogICAgICBgKSA9PT0gIm9uQ2xpY2siID8gIiR7ZXZlbnR9IiA6IChgLA0KICAgICAga2V5LA0KICAgICAgYClgDQogICAgXSkgOiBrZXk7DQogIH07DQogIGNvbnN0IHRyYW5zZm9ybU9uID0gKGRpciwgbm9kZSwgY29udGV4dCkgPT4gew0KICAgIHJldHVybiB0cmFuc2Zvcm1PbiQxKGRpciwgbm9kZSwgY29udGV4dCwgKGJhc2VSZXN1bHQpID0+IHsNCiAgICAgIGNvbnN0IHsgbW9kaWZpZXJzIH0gPSBkaXI7DQogICAgICBpZiAoIW1vZGlmaWVycy5sZW5ndGgpIHJldHVybiBiYXNlUmVzdWx0Ow0KICAgICAgbGV0IHsga2V5LCB2YWx1ZTogaGFuZGxlckV4cCB9ID0gYmFzZVJlc3VsdC5wcm9wc1swXTsNCiAgICAgIGNvbnN0IHsga2V5TW9kaWZpZXJzLCBub25LZXlNb2RpZmllcnMsIGV2ZW50T3B0aW9uTW9kaWZpZXJzIH0gPSByZXNvbHZlTW9kaWZpZXJzKGtleSwgbW9kaWZpZXJzLCBjb250ZXh0LCBkaXIubG9jKTsNCiAgICAgIGlmIChub25LZXlNb2RpZmllcnMuaW5jbHVkZXMoInJpZ2h0IikpIHsNCiAgICAgICAga2V5ID0gdHJhbnNmb3JtQ2xpY2soa2V5LCBgb25Db250ZXh0bWVudWApOw0KICAgICAgfQ0KICAgICAgaWYgKG5vbktleU1vZGlmaWVycy5pbmNsdWRlcygibWlkZGxlIikpIHsNCiAgICAgICAga2V5ID0gdHJhbnNmb3JtQ2xpY2soa2V5LCBgb25Nb3VzZXVwYCk7DQogICAgICB9DQogICAgICBpZiAobm9uS2V5TW9kaWZpZXJzLmxlbmd0aCkgew0KICAgICAgICBoYW5kbGVyRXhwID0gY3JlYXRlQ2FsbEV4cHJlc3Npb24oY29udGV4dC5oZWxwZXIoVl9PTl9XSVRIX01PRElGSUVSUyksIFsNCiAgICAgICAgICBoYW5kbGVyRXhwLA0KICAgICAgICAgIEpTT04uc3RyaW5naWZ5KG5vbktleU1vZGlmaWVycykNCiAgICAgICAgXSk7DQogICAgICB9DQogICAgICBpZiAoa2V5TW9kaWZpZXJzLmxlbmd0aCAmJiAvLyBpZiBldmVudCBuYW1lIGlzIGR5bmFtaWMsIGFsd2F5cyB3cmFwIHdpdGgga2V5cyBndWFyZA0KICAgICAgKCFpc1N0YXRpY0V4cChrZXkpIHx8IGlzS2V5Ym9hcmRFdmVudChrZXkuY29udGVudC50b0xvd2VyQ2FzZSgpKSkpIHsNCiAgICAgICAgaGFuZGxlckV4cCA9IGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKFZfT05fV0lUSF9LRVlTKSwgWw0KICAgICAgICAgIGhhbmRsZXJFeHAsDQogICAgICAgICAgSlNPTi5zdHJpbmdpZnkoa2V5TW9kaWZpZXJzKQ0KICAgICAgICBdKTsNCiAgICAgIH0NCiAgICAgIGlmIChldmVudE9wdGlvbk1vZGlmaWVycy5sZW5ndGgpIHsNCiAgICAgICAgY29uc3QgbW9kaWZpZXJQb3N0Zml4ID0gZXZlbnRPcHRpb25Nb2RpZmllcnMubWFwKGNhcGl0YWxpemUpLmpvaW4oIiIpOw0KICAgICAgICBrZXkgPSBpc1N0YXRpY0V4cChrZXkpID8gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgJHtrZXkuY29udGVudH0ke21vZGlmaWVyUG9zdGZpeH1gLCB0cnVlKSA6IGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbihbYChgLCBrZXksIGApICsgIiR7bW9kaWZpZXJQb3N0Zml4fSJgXSk7DQogICAgICB9DQogICAgICByZXR1cm4gew0KICAgICAgICBwcm9wczogW2NyZWF0ZU9iamVjdFByb3BlcnR5KGtleSwgaGFuZGxlckV4cCldDQogICAgICB9Ow0KICAgIH0pOw0KICB9Ow0KDQogIGNvbnN0IHRyYW5zZm9ybVNob3cgPSAoZGlyLCBub2RlLCBjb250ZXh0KSA9PiB7DQogICAgY29uc3QgeyBleHAsIGxvYyB9ID0gZGlyOw0KICAgIGlmICghZXhwKSB7DQogICAgICBjb250ZXh0Lm9uRXJyb3IoDQogICAgICAgIGNyZWF0ZURPTUNvbXBpbGVyRXJyb3IoNjEsIGxvYykNCiAgICAgICk7DQogICAgfQ0KICAgIHJldHVybiB7DQogICAgICBwcm9wczogW10sDQogICAgICBuZWVkUnVudGltZTogY29udGV4dC5oZWxwZXIoVl9TSE9XKQ0KICAgIH07DQogIH07DQoNCiAgY29uc3QgdHJhbnNmb3JtVHJhbnNpdGlvbiA9IChub2RlLCBjb250ZXh0KSA9PiB7DQogICAgaWYgKG5vZGUudHlwZSA9PT0gMSAmJiBub2RlLnRhZ1R5cGUgPT09IDEpIHsNCiAgICAgIGNvbnN0IGNvbXBvbmVudCA9IGNvbnRleHQuaXNCdWlsdEluQ29tcG9uZW50KG5vZGUudGFnKTsNCiAgICAgIGlmIChjb21wb25lbnQgPT09IFRSQU5TSVRJT04pIHsNCiAgICAgICAgcmV0dXJuICgpID0+IHsNCiAgICAgICAgICBpZiAoIW5vZGUuY2hpbGRyZW4ubGVuZ3RoKSB7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgfQ0KICAgICAgICAgIGlmIChoYXNNdWx0aXBsZUNoaWxkcmVuKG5vZGUpKSB7DQogICAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoDQogICAgICAgICAgICAgIGNyZWF0ZURPTUNvbXBpbGVyRXJyb3IoDQogICAgICAgICAgICAgICAgNjIsDQogICAgICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgICAgc3RhcnQ6IG5vZGUuY2hpbGRyZW5bMF0ubG9jLnN0YXJ0LA0KICAgICAgICAgICAgICAgICAgZW5kOiBub2RlLmNoaWxkcmVuW25vZGUuY2hpbGRyZW4ubGVuZ3RoIC0gMV0ubG9jLmVuZCwNCiAgICAgICAgICAgICAgICAgIHNvdXJjZTogIiINCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICkNCiAgICAgICAgICAgICk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGNvbnN0IGNoaWxkID0gbm9kZS5jaGlsZHJlblswXTsNCiAgICAgICAgICBpZiAoY2hpbGQudHlwZSA9PT0gMSkgew0KICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIGNoaWxkLnByb3BzKSB7DQogICAgICAgICAgICAgIGlmIChwLnR5cGUgPT09IDcgJiYgcC5uYW1lID09PSAic2hvdyIpIHsNCiAgICAgICAgICAgICAgICBub2RlLnByb3BzLnB1c2goew0KICAgICAgICAgICAgICAgICAgdHlwZTogNiwNCiAgICAgICAgICAgICAgICAgIG5hbWU6ICJwZXJzaXN0ZWQiLA0KICAgICAgICAgICAgICAgICAgbmFtZUxvYzogbm9kZS5sb2MsDQogICAgICAgICAgICAgICAgICB2YWx1ZTogdm9pZCAwLA0KICAgICAgICAgICAgICAgICAgbG9jOiBub2RlLmxvYw0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgfQ0KICAgIH0NCiAgfTsNCiAgZnVuY3Rpb24gaGFzTXVsdGlwbGVDaGlsZHJlbihub2RlKSB7DQogICAgY29uc3QgY2hpbGRyZW4gPSBub2RlLmNoaWxkcmVuID0gbm9kZS5jaGlsZHJlbi5maWx0ZXIoDQogICAgICAoYykgPT4gYy50eXBlICE9PSAzICYmICEoYy50eXBlID09PSAyICYmICFjLmNvbnRlbnQudHJpbSgpKQ0KICAgICk7DQogICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlblswXTsNCiAgICByZXR1cm4gY2hpbGRyZW4ubGVuZ3RoICE9PSAxIHx8IGNoaWxkLnR5cGUgPT09IDExIHx8IGNoaWxkLnR5cGUgPT09IDkgJiYgY2hpbGQuYnJhbmNoZXMuc29tZShoYXNNdWx0aXBsZUNoaWxkcmVuKTsNCiAgfQ0KDQogIGNvbnN0IGlnbm9yZVNpZGVFZmZlY3RUYWdzID0gKG5vZGUsIGNvbnRleHQpID0+IHsNCiAgICBpZiAobm9kZS50eXBlID09PSAxICYmIG5vZGUudGFnVHlwZSA9PT0gMCAmJiAobm9kZS50YWcgPT09ICJzY3JpcHQiIHx8IG5vZGUudGFnID09PSAic3R5bGUiKSkgew0KICAgICAgY29udGV4dC5vbkVycm9yKA0KICAgICAgICBjcmVhdGVET01Db21waWxlckVycm9yKA0KICAgICAgICAgIDYzLA0KICAgICAgICAgIG5vZGUubG9jDQogICAgICAgICkNCiAgICAgICk7DQogICAgICBjb250ZXh0LnJlbW92ZU5vZGUoKTsNCiAgICB9DQogIH07DQoNCiAgZnVuY3Rpb24gaXNWYWxpZEhUTUxOZXN0aW5nKHBhcmVudCwgY2hpbGQpIHsNCiAgICBpZiAocGFyZW50ID09PSAidGVtcGxhdGUiKSB7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogICAgaWYgKHBhcmVudCBpbiBvbmx5VmFsaWRDaGlsZHJlbikgew0KICAgICAgcmV0dXJuIG9ubHlWYWxpZENoaWxkcmVuW3BhcmVudF0uaGFzKGNoaWxkKTsNCiAgICB9DQogICAgaWYgKGNoaWxkIGluIG9ubHlWYWxpZFBhcmVudHMpIHsNCiAgICAgIHJldHVybiBvbmx5VmFsaWRQYXJlbnRzW2NoaWxkXS5oYXMocGFyZW50KTsNCiAgICB9DQogICAgaWYgKHBhcmVudCBpbiBrbm93bkludmFsaWRDaGlsZHJlbikgew0KICAgICAgaWYgKGtub3duSW52YWxpZENoaWxkcmVuW3BhcmVudF0uaGFzKGNoaWxkKSkgcmV0dXJuIGZhbHNlOw0KICAgIH0NCiAgICBpZiAoY2hpbGQgaW4ga25vd25JbnZhbGlkUGFyZW50cykgew0KICAgICAgaWYgKGtub3duSW52YWxpZFBhcmVudHNbY2hpbGRdLmhhcyhwYXJlbnQpKSByZXR1cm4gZmFsc2U7DQogICAgfQ0KICAgIHJldHVybiB0cnVlOw0KICB9DQogIGNvbnN0IGhlYWRpbmdzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWyJoMSIsICJoMiIsICJoMyIsICJoNCIsICJoNSIsICJoNiJdKTsNCiAgY29uc3QgZW1wdHlTZXQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbXSk7DQogIGNvbnN0IG9ubHlWYWxpZENoaWxkcmVuID0gew0KICAgIGhlYWQ6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsNCiAgICAgICJiYXNlIiwNCiAgICAgICJiYXNlZnJvbnQiLA0KICAgICAgImJnc291bmQiLA0KICAgICAgImxpbmsiLA0KICAgICAgIm1ldGEiLA0KICAgICAgInRpdGxlIiwNCiAgICAgICJub3NjcmlwdCIsDQogICAgICAibm9mcmFtZXMiLA0KICAgICAgInN0eWxlIiwNCiAgICAgICJzY3JpcHQiLA0KICAgICAgInRlbXBsYXRlIg0KICAgIF0pLA0KICAgIG9wdGdyb3VwOiAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbIm9wdGlvbiJdKSwNCiAgICBzZWxlY3Q6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsib3B0Z3JvdXAiLCAib3B0aW9uIiwgImhyIl0pLA0KICAgIC8vIHRhYmxlDQogICAgdGFibGU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsiY2FwdGlvbiIsICJjb2xncm91cCIsICJ0Ym9keSIsICJ0Zm9vdCIsICJ0aGVhZCJdKSwNCiAgICB0cjogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWyJ0ZCIsICJ0aCJdKSwNCiAgICBjb2xncm91cDogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWyJjb2wiXSksDQogICAgdGJvZHk6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsidHIiXSksDQogICAgdGhlYWQ6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsidHIiXSksDQogICAgdGZvb3Q6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsidHIiXSksDQogICAgLy8gdGhlc2UgZWxlbWVudHMgY2FuIG5vdCBoYXZlIGFueSBjaGlsZHJlbiBlbGVtZW50cw0KICAgIHNjcmlwdDogZW1wdHlTZXQsDQogICAgaWZyYW1lOiBlbXB0eVNldCwNCiAgICBvcHRpb246IGVtcHR5U2V0LA0KICAgIHRleHRhcmVhOiBlbXB0eVNldCwNCiAgICBzdHlsZTogZW1wdHlTZXQsDQogICAgdGl0bGU6IGVtcHR5U2V0DQogIH07DQogIGNvbnN0IG9ubHlWYWxpZFBhcmVudHMgPSB7DQogICAgLy8gc2VjdGlvbnMNCiAgICBodG1sOiBlbXB0eVNldCwNCiAgICBib2R5OiAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbImh0bWwiXSksDQogICAgaGVhZDogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWyJodG1sIl0pLA0KICAgIC8vIHRhYmxlDQogICAgdGQ6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsidHIiXSksDQogICAgY29sZ3JvdXA6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsidGFibGUiXSksDQogICAgY2FwdGlvbjogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWyJ0YWJsZSJdKSwNCiAgICB0Ym9keTogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWyJ0YWJsZSJdKSwNCiAgICB0Zm9vdDogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWyJ0YWJsZSJdKSwNCiAgICBjb2w6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsiY29sZ3JvdXAiXSksDQogICAgdGg6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsidHIiXSksDQogICAgdGhlYWQ6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsidGFibGUiXSksDQogICAgdHI6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsidGJvZHkiLCAidGhlYWQiLCAidGZvb3QiXSksDQogICAgLy8gZGF0YSBsaXN0DQogICAgZGQ6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsiZGwiLCAiZGl2Il0pLA0KICAgIGR0OiAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbImRsIiwgImRpdiJdKSwNCiAgICAvLyBvdGhlcg0KICAgIGZpZ2NhcHRpb246IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsiZmlndXJlIl0pLA0KICAgIC8vIGxpOiBuZXcgU2V0KFsidWwiLCAib2wiXSksDQogICAgc3VtbWFyeTogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWyJkZXRhaWxzIl0pLA0KICAgIGFyZWE6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsibWFwIl0pDQogIH07DQogIGNvbnN0IGtub3duSW52YWxpZENoaWxkcmVuID0gew0KICAgIHA6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsNCiAgICAgICJhZGRyZXNzIiwNCiAgICAgICJhcnRpY2xlIiwNCiAgICAgICJhc2lkZSIsDQogICAgICAiYmxvY2txdW90ZSIsDQogICAgICAiY2VudGVyIiwNCiAgICAgICJkZXRhaWxzIiwNCiAgICAgICJkaWFsb2ciLA0KICAgICAgImRpciIsDQogICAgICAiZGl2IiwNCiAgICAgICJkbCIsDQogICAgICAiZmllbGRzZXQiLA0KICAgICAgImZpZ3VyZSIsDQogICAgICAiZm9vdGVyIiwNCiAgICAgICJmb3JtIiwNCiAgICAgICJoMSIsDQogICAgICAiaDIiLA0KICAgICAgImgzIiwNCiAgICAgICJoNCIsDQogICAgICAiaDUiLA0KICAgICAgImg2IiwNCiAgICAgICJoZWFkZXIiLA0KICAgICAgImhncm91cCIsDQogICAgICAiaHIiLA0KICAgICAgImxpIiwNCiAgICAgICJtYWluIiwNCiAgICAgICJuYXYiLA0KICAgICAgIm1lbnUiLA0KICAgICAgIm9sIiwNCiAgICAgICJwIiwNCiAgICAgICJwcmUiLA0KICAgICAgInNlY3Rpb24iLA0KICAgICAgInRhYmxlIiwNCiAgICAgICJ1bCINCiAgICBdKSwNCiAgICBzdmc6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsNCiAgICAgICJiIiwNCiAgICAgICJibG9ja3F1b3RlIiwNCiAgICAgICJiciIsDQogICAgICAiY29kZSIsDQogICAgICAiZGQiLA0KICAgICAgImRpdiIsDQogICAgICAiZGwiLA0KICAgICAgImR0IiwNCiAgICAgICJlbSIsDQogICAgICAiZW1iZWQiLA0KICAgICAgImgxIiwNCiAgICAgICJoMiIsDQogICAgICAiaDMiLA0KICAgICAgImg0IiwNCiAgICAgICJoNSIsDQogICAgICAiaDYiLA0KICAgICAgImhyIiwNCiAgICAgICJpIiwNCiAgICAgICJpbWciLA0KICAgICAgImxpIiwNCiAgICAgICJtZW51IiwNCiAgICAgICJtZXRhIiwNCiAgICAgICJvbCIsDQogICAgICAicCIsDQogICAgICAicHJlIiwNCiAgICAgICJydWJ5IiwNCiAgICAgICJzIiwNCiAgICAgICJzbWFsbCIsDQogICAgICAic3BhbiIsDQogICAgICAic3Ryb25nIiwNCiAgICAgICJzdWIiLA0KICAgICAgInN1cCIsDQogICAgICAidGFibGUiLA0KICAgICAgInUiLA0KICAgICAgInVsIiwNCiAgICAgICJ2YXIiDQogICAgXSkNCiAgfTsNCiAgY29uc3Qga25vd25JbnZhbGlkUGFyZW50cyA9IHsNCiAgICBhOiAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbImEiXSksDQogICAgYnV0dG9uOiAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbImJ1dHRvbiJdKSwNCiAgICBkZDogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWyJkZCIsICJkdCJdKSwNCiAgICBkdDogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWyJkZCIsICJkdCJdKSwNCiAgICBmb3JtOiAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbImZvcm0iXSksDQogICAgbGk6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsibGkiXSksDQogICAgaDE6IGhlYWRpbmdzLA0KICAgIGgyOiBoZWFkaW5ncywNCiAgICBoMzogaGVhZGluZ3MsDQogICAgaDQ6IGhlYWRpbmdzLA0KICAgIGg1OiBoZWFkaW5ncywNCiAgICBoNjogaGVhZGluZ3MNCiAgfTsNCg0KICBjb25zdCB2YWxpZGF0ZUh0bWxOZXN0aW5nID0gKG5vZGUsIGNvbnRleHQpID0+IHsNCiAgICBpZiAobm9kZS50eXBlID09PSAxICYmIG5vZGUudGFnVHlwZSA9PT0gMCAmJiBjb250ZXh0LnBhcmVudCAmJiBjb250ZXh0LnBhcmVudC50eXBlID09PSAxICYmIGNvbnRleHQucGFyZW50LnRhZ1R5cGUgPT09IDAgJiYgIWlzVmFsaWRIVE1MTmVzdGluZyhjb250ZXh0LnBhcmVudC50YWcsIG5vZGUudGFnKSkgew0KICAgICAgY29uc3QgZXJyb3IgPSBuZXcgU3ludGF4RXJyb3IoDQogICAgICAgIGA8JHtub2RlLnRhZ30+IGNhbm5vdCBiZSBjaGlsZCBvZiA8JHtjb250ZXh0LnBhcmVudC50YWd9PiwgYWNjb3JkaW5nIHRvIEhUTUwgc3BlY2lmaWNhdGlvbnMuIFRoaXMgY2FuIGNhdXNlIGh5ZHJhdGlvbiBlcnJvcnMgb3IgcG90ZW50aWFsbHkgZGlzcnVwdCBmdXR1cmUgZnVuY3Rpb25hbGl0eS5gDQogICAgICApOw0KICAgICAgZXJyb3IubG9jID0gbm9kZS5sb2M7DQogICAgICBjb250ZXh0Lm9uV2FybihlcnJvcik7DQogICAgfQ0KICB9Ow0KDQogIGNvbnN0IERPTU5vZGVUcmFuc2Zvcm1zID0gWw0KICAgIHRyYW5zZm9ybVN0eWxlLA0KICAgIC4uLlt0cmFuc2Zvcm1UcmFuc2l0aW9uLCB2YWxpZGF0ZUh0bWxOZXN0aW5nXSANCiAgXTsNCiAgY29uc3QgRE9NRGlyZWN0aXZlVHJhbnNmb3JtcyA9IHsNCiAgICBjbG9hazogbm9vcERpcmVjdGl2ZVRyYW5zZm9ybSwNCiAgICBodG1sOiB0cmFuc2Zvcm1WSHRtbCwNCiAgICB0ZXh0OiB0cmFuc2Zvcm1WVGV4dCwNCiAgICBtb2RlbDogdHJhbnNmb3JtTW9kZWwsDQogICAgLy8gb3ZlcnJpZGUgY29tcGlsZXItY29yZQ0KICAgIG9uOiB0cmFuc2Zvcm1PbiwNCiAgICAvLyBvdmVycmlkZSBjb21waWxlci1jb3JlDQogICAgc2hvdzogdHJhbnNmb3JtU2hvdw0KICB9Ow0KICBmdW5jdGlvbiBjb21waWxlKHNyYywgb3B0aW9ucyA9IHt9KSB7DQogICAgcmV0dXJuIGJhc2VDb21waWxlKA0KICAgICAgc3JjLA0KICAgICAgZXh0ZW5kKHt9LCBwYXJzZXJPcHRpb25zLCBvcHRpb25zLCB7DQogICAgICAgIG5vZGVUcmFuc2Zvcm1zOiBbDQogICAgICAgICAgLy8gaWdub3JlIDxzY3JpcHQ+IGFuZCA8dGFnPg0KICAgICAgICAgIC8vIHRoaXMgaXMgbm90IHB1dCBpbnNpZGUgRE9NTm9kZVRyYW5zZm9ybXMgYmVjYXVzZSB0aGF0IGxpc3QgaXMgdXNlZA0KICAgICAgICAgIC8vIGJ5IGNvbXBpbGVyLXNzciB0byBnZW5lcmF0ZSB2bm9kZSBmYWxsYmFjayBicmFuY2hlcw0KICAgICAgICAgIGlnbm9yZVNpZGVFZmZlY3RUYWdzLA0KICAgICAgICAgIC4uLkRPTU5vZGVUcmFuc2Zvcm1zLA0KICAgICAgICAgIC4uLm9wdGlvbnMubm9kZVRyYW5zZm9ybXMgfHwgW10NCiAgICAgICAgXSwNCiAgICAgICAgZGlyZWN0aXZlVHJhbnNmb3JtczogZXh0ZW5kKA0KICAgICAgICAgIHt9LA0KICAgICAgICAgIERPTURpcmVjdGl2ZVRyYW5zZm9ybXMsDQogICAgICAgICAgb3B0aW9ucy5kaXJlY3RpdmVUcmFuc2Zvcm1zIHx8IHt9DQogICAgICAgICksDQogICAgICAgIHRyYW5zZm9ybUhvaXN0OiBudWxsIA0KICAgICAgfSkNCiAgICApOw0KICB9DQoNCiAgew0KICAgIGluaXREZXYoKTsNCiAgfQ0KICBjb25zdCBjb21waWxlQ2FjaGUgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsNCiAgZnVuY3Rpb24gY29tcGlsZVRvRnVuY3Rpb24odGVtcGxhdGUsIG9wdGlvbnMpIHsNCiAgICBpZiAoIWlzU3RyaW5nKHRlbXBsYXRlKSkgew0KICAgICAgaWYgKHRlbXBsYXRlLm5vZGVUeXBlKSB7DQogICAgICAgIHRlbXBsYXRlID0gdGVtcGxhdGUuaW5uZXJIVE1MOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgd2FybihgaW52YWxpZCB0ZW1wbGF0ZSBvcHRpb246IGAsIHRlbXBsYXRlKTsNCiAgICAgICAgcmV0dXJuIE5PT1A7DQogICAgICB9DQogICAgfQ0KICAgIGNvbnN0IGtleSA9IGdlbkNhY2hlS2V5KHRlbXBsYXRlLCBvcHRpb25zKTsNCiAgICBjb25zdCBjYWNoZWQgPSBjb21waWxlQ2FjaGVba2V5XTsNCiAgICBpZiAoY2FjaGVkKSB7DQogICAgICByZXR1cm4gY2FjaGVkOw0KICAgIH0NCiAgICBpZiAodGVtcGxhdGVbMF0gPT09ICIjIikgew0KICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHRlbXBsYXRlKTsNCiAgICAgIGlmICghZWwpIHsNCiAgICAgICAgd2FybihgVGVtcGxhdGUgZWxlbWVudCBub3QgZm91bmQgb3IgaXMgZW1wdHk6ICR7dGVtcGxhdGV9YCk7DQogICAgICB9DQogICAgICB0ZW1wbGF0ZSA9IGVsID8gZWwuaW5uZXJIVE1MIDogYGA7DQogICAgfQ0KICAgIGNvbnN0IG9wdHMgPSBleHRlbmQoDQogICAgICB7DQogICAgICAgIGhvaXN0U3RhdGljOiB0cnVlLA0KICAgICAgICBvbkVycm9yOiBvbkVycm9yICwNCiAgICAgICAgb25XYXJuOiAoZSkgPT4gb25FcnJvcihlLCB0cnVlKSANCiAgICAgIH0sDQogICAgICBvcHRpb25zDQogICAgKTsNCiAgICBpZiAoIW9wdHMuaXNDdXN0b21FbGVtZW50ICYmIHR5cGVvZiBjdXN0b21FbGVtZW50cyAhPT0gInVuZGVmaW5lZCIpIHsNCiAgICAgIG9wdHMuaXNDdXN0b21FbGVtZW50ID0gKHRhZykgPT4gISFjdXN0b21FbGVtZW50cy5nZXQodGFnKTsNCiAgICB9DQogICAgY29uc3QgeyBjb2RlIH0gPSBjb21waWxlKHRlbXBsYXRlLCBvcHRzKTsNCiAgICBmdW5jdGlvbiBvbkVycm9yKGVyciwgYXNXYXJuaW5nID0gZmFsc2UpIHsNCiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBhc1dhcm5pbmcgPyBlcnIubWVzc2FnZSA6IGBUZW1wbGF0ZSBjb21waWxhdGlvbiBlcnJvcjogJHtlcnIubWVzc2FnZX1gOw0KICAgICAgY29uc3QgY29kZUZyYW1lID0gZXJyLmxvYyAmJiBnZW5lcmF0ZUNvZGVGcmFtZSgNCiAgICAgICAgdGVtcGxhdGUsDQogICAgICAgIGVyci5sb2Muc3RhcnQub2Zmc2V0LA0KICAgICAgICBlcnIubG9jLmVuZC5vZmZzZXQNCiAgICAgICk7DQogICAgICB3YXJuKGNvZGVGcmFtZSA/IGAke21lc3NhZ2V9DQoke2NvZGVGcmFtZX1gIDogbWVzc2FnZSk7DQogICAgfQ0KICAgIGNvbnN0IHJlbmRlciA9IG5ldyBGdW5jdGlvbihjb2RlKSgpIDsNCiAgICByZW5kZXIuX3JjID0gdHJ1ZTsNCiAgICByZXR1cm4gY29tcGlsZUNhY2hlW2tleV0gPSByZW5kZXI7DQogIH0NCiAgcmVnaXN0ZXJSdW50aW1lQ29tcGlsZXIoY29tcGlsZVRvRnVuY3Rpb24pOw0KDQogIGV4cG9ydHMuQmFzZVRyYW5zaXRpb24gPSBCYXNlVHJhbnNpdGlvbjsNCiAgZXhwb3J0cy5CYXNlVHJhbnNpdGlvblByb3BzVmFsaWRhdG9ycyA9IEJhc2VUcmFuc2l0aW9uUHJvcHNWYWxpZGF0b3JzOw0KICBleHBvcnRzLkNvbW1lbnQgPSBDb21tZW50Ow0KICBleHBvcnRzLkRlcHJlY2F0aW9uVHlwZXMgPSBEZXByZWNhdGlvblR5cGVzOw0KICBleHBvcnRzLkVmZmVjdFNjb3BlID0gRWZmZWN0U2NvcGU7DQogIGV4cG9ydHMuRXJyb3JDb2RlcyA9IEVycm9yQ29kZXM7DQogIGV4cG9ydHMuRXJyb3JUeXBlU3RyaW5ncyA9IEVycm9yVHlwZVN0cmluZ3M7DQogIGV4cG9ydHMuRnJhZ21lbnQgPSBGcmFnbWVudDsNCiAgZXhwb3J0cy5LZWVwQWxpdmUgPSBLZWVwQWxpdmU7DQogIGV4cG9ydHMuUmVhY3RpdmVFZmZlY3QgPSBSZWFjdGl2ZUVmZmVjdDsNCiAgZXhwb3J0cy5TdGF0aWMgPSBTdGF0aWM7DQogIGV4cG9ydHMuU3VzcGVuc2UgPSBTdXNwZW5zZTsNCiAgZXhwb3J0cy5UZWxlcG9ydCA9IFRlbGVwb3J0Ow0KICBleHBvcnRzLlRleHQgPSBUZXh0Ow0KICBleHBvcnRzLlRyYWNrT3BUeXBlcyA9IFRyYWNrT3BUeXBlczsNCiAgZXhwb3J0cy5UcmFuc2l0aW9uID0gVHJhbnNpdGlvbjsNCiAgZXhwb3J0cy5UcmFuc2l0aW9uR3JvdXAgPSBUcmFuc2l0aW9uR3JvdXA7DQogIGV4cG9ydHMuVHJpZ2dlck9wVHlwZXMgPSBUcmlnZ2VyT3BUeXBlczsNCiAgZXhwb3J0cy5WdWVFbGVtZW50ID0gVnVlRWxlbWVudDsNCiAgZXhwb3J0cy5hc3NlcnROdW1iZXIgPSBhc3NlcnROdW1iZXI7DQogIGV4cG9ydHMuY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcgPSBjYWxsV2l0aEFzeW5jRXJyb3JIYW5kbGluZzsNCiAgZXhwb3J0cy5jYWxsV2l0aEVycm9ySGFuZGxpbmcgPSBjYWxsV2l0aEVycm9ySGFuZGxpbmc7DQogIGV4cG9ydHMuY2FtZWxpemUgPSBjYW1lbGl6ZTsNCiAgZXhwb3J0cy5jYXBpdGFsaXplID0gY2FwaXRhbGl6ZTsNCiAgZXhwb3J0cy5jbG9uZVZOb2RlID0gY2xvbmVWTm9kZTsNCiAgZXhwb3J0cy5jb21wYXRVdGlscyA9IGNvbXBhdFV0aWxzOw0KICBleHBvcnRzLmNvbXBpbGUgPSBjb21waWxlVG9GdW5jdGlvbjsNCiAgZXhwb3J0cy5jb21wdXRlZCA9IGNvbXB1dGVkOw0KICBleHBvcnRzLmNyZWF0ZUFwcCA9IGNyZWF0ZUFwcDsNCiAgZXhwb3J0cy5jcmVhdGVCbG9jayA9IGNyZWF0ZUJsb2NrOw0KICBleHBvcnRzLmNyZWF0ZUNvbW1lbnRWTm9kZSA9IGNyZWF0ZUNvbW1lbnRWTm9kZTsNCiAgZXhwb3J0cy5jcmVhdGVFbGVtZW50QmxvY2sgPSBjcmVhdGVFbGVtZW50QmxvY2s7DQogIGV4cG9ydHMuY3JlYXRlRWxlbWVudFZOb2RlID0gY3JlYXRlQmFzZVZOb2RlOw0KICBleHBvcnRzLmNyZWF0ZUh5ZHJhdGlvblJlbmRlcmVyID0gY3JlYXRlSHlkcmF0aW9uUmVuZGVyZXI7DQogIGV4cG9ydHMuY3JlYXRlUHJvcHNSZXN0UHJveHkgPSBjcmVhdGVQcm9wc1Jlc3RQcm94eTsNCiAgZXhwb3J0cy5jcmVhdGVSZW5kZXJlciA9IGNyZWF0ZVJlbmRlcmVyOw0KICBleHBvcnRzLmNyZWF0ZVNTUkFwcCA9IGNyZWF0ZVNTUkFwcDsNCiAgZXhwb3J0cy5jcmVhdGVTbG90cyA9IGNyZWF0ZVNsb3RzOw0KICBleHBvcnRzLmNyZWF0ZVN0YXRpY1ZOb2RlID0gY3JlYXRlU3RhdGljVk5vZGU7DQogIGV4cG9ydHMuY3JlYXRlVGV4dFZOb2RlID0gY3JlYXRlVGV4dFZOb2RlOw0KICBleHBvcnRzLmNyZWF0ZVZOb2RlID0gY3JlYXRlVk5vZGU7DQogIGV4cG9ydHMuY3VzdG9tUmVmID0gY3VzdG9tUmVmOw0KICBleHBvcnRzLmRlZmluZUFzeW5jQ29tcG9uZW50ID0gZGVmaW5lQXN5bmNDb21wb25lbnQ7DQogIGV4cG9ydHMuZGVmaW5lQ29tcG9uZW50ID0gZGVmaW5lQ29tcG9uZW50Ow0KICBleHBvcnRzLmRlZmluZUN1c3RvbUVsZW1lbnQgPSBkZWZpbmVDdXN0b21FbGVtZW50Ow0KICBleHBvcnRzLmRlZmluZUVtaXRzID0gZGVmaW5lRW1pdHM7DQogIGV4cG9ydHMuZGVmaW5lRXhwb3NlID0gZGVmaW5lRXhwb3NlOw0KICBleHBvcnRzLmRlZmluZU1vZGVsID0gZGVmaW5lTW9kZWw7DQogIGV4cG9ydHMuZGVmaW5lT3B0aW9ucyA9IGRlZmluZU9wdGlvbnM7DQogIGV4cG9ydHMuZGVmaW5lUHJvcHMgPSBkZWZpbmVQcm9wczsNCiAgZXhwb3J0cy5kZWZpbmVTU1JDdXN0b21FbGVtZW50ID0gZGVmaW5lU1NSQ3VzdG9tRWxlbWVudDsNCiAgZXhwb3J0cy5kZWZpbmVTbG90cyA9IGRlZmluZVNsb3RzOw0KICBleHBvcnRzLmRldnRvb2xzID0gZGV2dG9vbHM7DQogIGV4cG9ydHMuZWZmZWN0ID0gZWZmZWN0Ow0KICBleHBvcnRzLmVmZmVjdFNjb3BlID0gZWZmZWN0U2NvcGU7DQogIGV4cG9ydHMuZ2V0Q3VycmVudEluc3RhbmNlID0gZ2V0Q3VycmVudEluc3RhbmNlOw0KICBleHBvcnRzLmdldEN1cnJlbnRTY29wZSA9IGdldEN1cnJlbnRTY29wZTsNCiAgZXhwb3J0cy5nZXRDdXJyZW50V2F0Y2hlciA9IGdldEN1cnJlbnRXYXRjaGVyOw0KICBleHBvcnRzLmdldFRyYW5zaXRpb25SYXdDaGlsZHJlbiA9IGdldFRyYW5zaXRpb25SYXdDaGlsZHJlbjsNCiAgZXhwb3J0cy5ndWFyZFJlYWN0aXZlUHJvcHMgPSBndWFyZFJlYWN0aXZlUHJvcHM7DQogIGV4cG9ydHMuaCA9IGg7DQogIGV4cG9ydHMuaGFuZGxlRXJyb3IgPSBoYW5kbGVFcnJvcjsNCiAgZXhwb3J0cy5oYXNJbmplY3Rpb25Db250ZXh0ID0gaGFzSW5qZWN0aW9uQ29udGV4dDsNCiAgZXhwb3J0cy5oeWRyYXRlID0gaHlkcmF0ZTsNCiAgZXhwb3J0cy5oeWRyYXRlT25JZGxlID0gaHlkcmF0ZU9uSWRsZTsNCiAgZXhwb3J0cy5oeWRyYXRlT25JbnRlcmFjdGlvbiA9IGh5ZHJhdGVPbkludGVyYWN0aW9uOw0KICBleHBvcnRzLmh5ZHJhdGVPbk1lZGlhUXVlcnkgPSBoeWRyYXRlT25NZWRpYVF1ZXJ5Ow0KICBleHBvcnRzLmh5ZHJhdGVPblZpc2libGUgPSBoeWRyYXRlT25WaXNpYmxlOw0KICBleHBvcnRzLmluaXRDdXN0b21Gb3JtYXR0ZXIgPSBpbml0Q3VzdG9tRm9ybWF0dGVyOw0KICBleHBvcnRzLmluaXREaXJlY3RpdmVzRm9yU1NSID0gaW5pdERpcmVjdGl2ZXNGb3JTU1I7DQogIGV4cG9ydHMuaW5qZWN0ID0gaW5qZWN0Ow0KICBleHBvcnRzLmlzTWVtb1NhbWUgPSBpc01lbW9TYW1lOw0KICBleHBvcnRzLmlzUHJveHkgPSBpc1Byb3h5Ow0KICBleHBvcnRzLmlzUmVhY3RpdmUgPSBpc1JlYWN0aXZlOw0KICBleHBvcnRzLmlzUmVhZG9ubHkgPSBpc1JlYWRvbmx5Ow0KICBleHBvcnRzLmlzUmVmID0gaXNSZWY7DQogIGV4cG9ydHMuaXNSdW50aW1lT25seSA9IGlzUnVudGltZU9ubHk7DQogIGV4cG9ydHMuaXNTaGFsbG93ID0gaXNTaGFsbG93Ow0KICBleHBvcnRzLmlzVk5vZGUgPSBpc1ZOb2RlOw0KICBleHBvcnRzLm1hcmtSYXcgPSBtYXJrUmF3Ow0KICBleHBvcnRzLm1lcmdlRGVmYXVsdHMgPSBtZXJnZURlZmF1bHRzOw0KICBleHBvcnRzLm1lcmdlTW9kZWxzID0gbWVyZ2VNb2RlbHM7DQogIGV4cG9ydHMubWVyZ2VQcm9wcyA9IG1lcmdlUHJvcHM7DQogIGV4cG9ydHMubmV4dFRpY2sgPSBuZXh0VGljazsNCiAgZXhwb3J0cy5ub3JtYWxpemVDbGFzcyA9IG5vcm1hbGl6ZUNsYXNzOw0KICBleHBvcnRzLm5vcm1hbGl6ZVByb3BzID0gbm9ybWFsaXplUHJvcHM7DQogIGV4cG9ydHMubm9ybWFsaXplU3R5bGUgPSBub3JtYWxpemVTdHlsZTsNCiAgZXhwb3J0cy5vbkFjdGl2YXRlZCA9IG9uQWN0aXZhdGVkOw0KICBleHBvcnRzLm9uQmVmb3JlTW91bnQgPSBvbkJlZm9yZU1vdW50Ow0KICBleHBvcnRzLm9uQmVmb3JlVW5tb3VudCA9IG9uQmVmb3JlVW5tb3VudDsNCiAgZXhwb3J0cy5vbkJlZm9yZVVwZGF0ZSA9IG9uQmVmb3JlVXBkYXRlOw0KICBleHBvcnRzLm9uRGVhY3RpdmF0ZWQgPSBvbkRlYWN0aXZhdGVkOw0KICBleHBvcnRzLm9uRXJyb3JDYXB0dXJlZCA9IG9uRXJyb3JDYXB0dXJlZDsNCiAgZXhwb3J0cy5vbk1vdW50ZWQgPSBvbk1vdW50ZWQ7DQogIGV4cG9ydHMub25SZW5kZXJUcmFja2VkID0gb25SZW5kZXJUcmFja2VkOw0KICBleHBvcnRzLm9uUmVuZGVyVHJpZ2dlcmVkID0gb25SZW5kZXJUcmlnZ2VyZWQ7DQogIGV4cG9ydHMub25TY29wZURpc3Bvc2UgPSBvblNjb3BlRGlzcG9zZTsNCiAgZXhwb3J0cy5vblNlcnZlclByZWZldGNoID0gb25TZXJ2ZXJQcmVmZXRjaDsNCiAgZXhwb3J0cy5vblVubW91bnRlZCA9IG9uVW5tb3VudGVkOw0KICBleHBvcnRzLm9uVXBkYXRlZCA9IG9uVXBkYXRlZDsNCiAgZXhwb3J0cy5vbldhdGNoZXJDbGVhbnVwID0gb25XYXRjaGVyQ2xlYW51cDsNCiAgZXhwb3J0cy5vcGVuQmxvY2sgPSBvcGVuQmxvY2s7DQogIGV4cG9ydHMucG9wU2NvcGVJZCA9IHBvcFNjb3BlSWQ7DQogIGV4cG9ydHMucHJvdmlkZSA9IHByb3ZpZGU7DQogIGV4cG9ydHMucHJveHlSZWZzID0gcHJveHlSZWZzOw0KICBleHBvcnRzLnB1c2hTY29wZUlkID0gcHVzaFNjb3BlSWQ7DQogIGV4cG9ydHMucXVldWVQb3N0Rmx1c2hDYiA9IHF1ZXVlUG9zdEZsdXNoQ2I7DQogIGV4cG9ydHMucmVhY3RpdmUgPSByZWFjdGl2ZTsNCiAgZXhwb3J0cy5yZWFkb25seSA9IHJlYWRvbmx5Ow0KICBleHBvcnRzLnJlZiA9IHJlZjsNCiAgZXhwb3J0cy5yZWdpc3RlclJ1bnRpbWVDb21waWxlciA9IHJlZ2lzdGVyUnVudGltZUNvbXBpbGVyOw0KICBleHBvcnRzLnJlbmRlciA9IHJlbmRlcjsNCiAgZXhwb3J0cy5yZW5kZXJMaXN0ID0gcmVuZGVyTGlzdDsNCiAgZXhwb3J0cy5yZW5kZXJTbG90ID0gcmVuZGVyU2xvdDsNCiAgZXhwb3J0cy5yZXNvbHZlQ29tcG9uZW50ID0gcmVzb2x2ZUNvbXBvbmVudDsNCiAgZXhwb3J0cy5yZXNvbHZlRGlyZWN0aXZlID0gcmVzb2x2ZURpcmVjdGl2ZTsNCiAgZXhwb3J0cy5yZXNvbHZlRHluYW1pY0NvbXBvbmVudCA9IHJlc29sdmVEeW5hbWljQ29tcG9uZW50Ow0KICBleHBvcnRzLnJlc29sdmVGaWx0ZXIgPSByZXNvbHZlRmlsdGVyOw0KICBleHBvcnRzLnJlc29sdmVUcmFuc2l0aW9uSG9va3MgPSByZXNvbHZlVHJhbnNpdGlvbkhvb2tzOw0KICBleHBvcnRzLnNldEJsb2NrVHJhY2tpbmcgPSBzZXRCbG9ja1RyYWNraW5nOw0KICBleHBvcnRzLnNldERldnRvb2xzSG9vayA9IHNldERldnRvb2xzSG9vazsNCiAgZXhwb3J0cy5zZXRUcmFuc2l0aW9uSG9va3MgPSBzZXRUcmFuc2l0aW9uSG9va3M7DQogIGV4cG9ydHMuc2hhbGxvd1JlYWN0aXZlID0gc2hhbGxvd1JlYWN0aXZlOw0KICBleHBvcnRzLnNoYWxsb3dSZWFkb25seSA9IHNoYWxsb3dSZWFkb25seTsNCiAgZXhwb3J0cy5zaGFsbG93UmVmID0gc2hhbGxvd1JlZjsNCiAgZXhwb3J0cy5zc3JDb250ZXh0S2V5ID0gc3NyQ29udGV4dEtleTsNCiAgZXhwb3J0cy5zc3JVdGlscyA9IHNzclV0aWxzOw0KICBleHBvcnRzLnN0b3AgPSBzdG9wOw0KICBleHBvcnRzLnRvRGlzcGxheVN0cmluZyA9IHRvRGlzcGxheVN0cmluZzsNCiAgZXhwb3J0cy50b0hhbmRsZXJLZXkgPSB0b0hhbmRsZXJLZXk7DQogIGV4cG9ydHMudG9IYW5kbGVycyA9IHRvSGFuZGxlcnM7DQogIGV4cG9ydHMudG9SYXcgPSB0b1JhdzsNCiAgZXhwb3J0cy50b1JlZiA9IHRvUmVmOw0KICBleHBvcnRzLnRvUmVmcyA9IHRvUmVmczsNCiAgZXhwb3J0cy50b1ZhbHVlID0gdG9WYWx1ZTsNCiAgZXhwb3J0cy50cmFuc2Zvcm1WTm9kZUFyZ3MgPSB0cmFuc2Zvcm1WTm9kZUFyZ3M7DQogIGV4cG9ydHMudHJpZ2dlclJlZiA9IHRyaWdnZXJSZWY7DQogIGV4cG9ydHMudW5yZWYgPSB1bnJlZjsNCiAgZXhwb3J0cy51c2VBdHRycyA9IHVzZUF0dHJzOw0KICBleHBvcnRzLnVzZUNzc01vZHVsZSA9IHVzZUNzc01vZHVsZTsNCiAgZXhwb3J0cy51c2VDc3NWYXJzID0gdXNlQ3NzVmFyczsNCiAgZXhwb3J0cy51c2VIb3N0ID0gdXNlSG9zdDsNCiAgZXhwb3J0cy51c2VJZCA9IHVzZUlkOw0KICBleHBvcnRzLnVzZU1vZGVsID0gdXNlTW9kZWw7DQogIGV4cG9ydHMudXNlU1NSQ29udGV4dCA9IHVzZVNTUkNvbnRleHQ7DQogIGV4cG9ydHMudXNlU2hhZG93Um9vdCA9IHVzZVNoYWRvd1Jvb3Q7DQogIGV4cG9ydHMudXNlU2xvdHMgPSB1c2VTbG90czsNCiAgZXhwb3J0cy51c2VUZW1wbGF0ZVJlZiA9IHVzZVRlbXBsYXRlUmVmOw0KICBleHBvcnRzLnVzZVRyYW5zaXRpb25TdGF0ZSA9IHVzZVRyYW5zaXRpb25TdGF0ZTsNCiAgZXhwb3J0cy52TW9kZWxDaGVja2JveCA9IHZNb2RlbENoZWNrYm94Ow0KICBleHBvcnRzLnZNb2RlbER5bmFtaWMgPSB2TW9kZWxEeW5hbWljOw0KICBleHBvcnRzLnZNb2RlbFJhZGlvID0gdk1vZGVsUmFkaW87DQogIGV4cG9ydHMudk1vZGVsU2VsZWN0ID0gdk1vZGVsU2VsZWN0Ow0KICBleHBvcnRzLnZNb2RlbFRleHQgPSB2TW9kZWxUZXh0Ow0KICBleHBvcnRzLnZTaG93ID0gdlNob3c7DQogIGV4cG9ydHMudmVyc2lvbiA9IHZlcnNpb247DQogIGV4cG9ydHMud2FybiA9IHdhcm47DQogIGV4cG9ydHMud2F0Y2ggPSB3YXRjaDsNCiAgZXhwb3J0cy53YXRjaEVmZmVjdCA9IHdhdGNoRWZmZWN0Ow0KICBleHBvcnRzLndhdGNoUG9zdEVmZmVjdCA9IHdhdGNoUG9zdEVmZmVjdDsNCiAgZXhwb3J0cy53YXRjaFN5bmNFZmZlY3QgPSB3YXRjaFN5bmNFZmZlY3Q7DQogIGV4cG9ydHMud2l0aEFzeW5jQ29udGV4dCA9IHdpdGhBc3luY0NvbnRleHQ7DQogIGV4cG9ydHMud2l0aEN0eCA9IHdpdGhDdHg7DQogIGV4cG9ydHMud2l0aERlZmF1bHRzID0gd2l0aERlZmF1bHRzOw0KICBleHBvcnRzLndpdGhEaXJlY3RpdmVzID0gd2l0aERpcmVjdGl2ZXM7DQogIGV4cG9ydHMud2l0aEtleXMgPSB3aXRoS2V5czsNCiAgZXhwb3J0cy53aXRoTWVtbyA9IHdpdGhNZW1vOw0KICBleHBvcnRzLndpdGhNb2RpZmllcnMgPSB3aXRoTW9kaWZpZXJzOw0KICBleHBvcnRzLndpdGhTY29wZUlkID0gd2l0aFNjb3BlSWQ7DQoNCiAgcmV0dXJuIGV4cG9ydHM7DQoNCn0pKHt9KTsNCg=='
const vueProd = 'data:text/javascript;base64,LyoqDQoqIHZ1ZSB2My41LjE3DQoqIChjKSAyMDE4LXByZXNlbnQgWXV4aSAoRXZhbikgWW91IGFuZCBWdWUgY29udHJpYnV0b3JzDQoqIEBsaWNlbnNlIE1JVA0KKiovdmFyIFZ1ZT1mdW5jdGlvbihlKXsidXNlIHN0cmljdCI7dmFyIHQsbixyO2xldCBpLGwscyxvLGEsYyx1LGQscCxoLGYsbSxnO2Z1bmN0aW9uIHkoZSl7bGV0IHQ9T2JqZWN0LmNyZWF0ZShudWxsKTtmb3IobGV0IG4gb2YgZS5zcGxpdCgiLCIpKXRbbl09MTtyZXR1cm4gZT0+ZSBpbiB0fWxldCBiPXt9LF89W10sUz0oKT0+e30seD0oKT0+ITEsQz1lPT4xMTE9PT1lLmNoYXJDb2RlQXQoMCkmJjExMD09PWUuY2hhckNvZGVBdCgxKSYmKGUuY2hhckNvZGVBdCgyKT4xMjJ8fDk3PmUuY2hhckNvZGVBdCgyKSksaz1lPT5lLnN0YXJ0c1dpdGgoIm9uVXBkYXRlOiIpLFQ9T2JqZWN0LmFzc2lnbixOPShlLHQpPT57bGV0IG49ZS5pbmRleE9mKHQpO24+LTEmJmUuc3BsaWNlKG4sMSl9LHc9T2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSxBPShlLHQpPT53LmNhbGwoZSx0KSxFPUFycmF5LmlzQXJyYXksST1lPT4iW29iamVjdCBNYXBdIj09PVYoZSksUj1lPT4iW29iamVjdCBTZXRdIj09PVYoZSksTz1lPT4iW29iamVjdCBEYXRlXSI9PT1WKGUpLFA9ZT0+ImZ1bmN0aW9uIj09dHlwZW9mIGUsTT1lPT4ic3RyaW5nIj09dHlwZW9mIGUsTD1lPT4ic3ltYm9sIj09dHlwZW9mIGUsJD1lPT5udWxsIT09ZSYmIm9iamVjdCI9PXR5cGVvZiBlLEQ9ZT0+KCQoZSl8fFAoZSkpJiZQKGUudGhlbikmJlAoZS5jYXRjaCksRj1PYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLFY9ZT0+Ri5jYWxsKGUpLEI9ZT0+IltvYmplY3QgT2JqZWN0XSI9PT1WKGUpLFU9ZT0+TShlKSYmIk5hTiIhPT1lJiYiLSIhPT1lWzBdJiYiIitwYXJzZUludChlLDEwKT09PWUsaj15KCIsa2V5LHJlZixyZWZfZm9yLHJlZl9rZXksb25Wbm9kZUJlZm9yZU1vdW50LG9uVm5vZGVNb3VudGVkLG9uVm5vZGVCZWZvcmVVcGRhdGUsb25Wbm9kZVVwZGF0ZWQsb25Wbm9kZUJlZm9yZVVubW91bnQsb25Wbm9kZVVubW91bnRlZCIpLEg9eSgiYmluZCxjbG9hayxlbHNlLWlmLGVsc2UsZm9yLGh0bWwsaWYsbW9kZWwsb24sb25jZSxwcmUsc2hvdyxzbG90LHRleHQsbWVtbyIpLHE9ZT0+e2xldCB0PU9iamVjdC5jcmVhdGUobnVsbCk7cmV0dXJuIG49PnRbbl18fCh0W25dPWUobikpfSxXPS8tKFx3KS9nLEs9cShlPT5lLnJlcGxhY2UoVywoZSx0KT0+dD90LnRvVXBwZXJDYXNlKCk6IiIpKSx6PS9cQihbQS1aXSkvZyxKPXEoZT0+ZS5yZXBsYWNlKHosIi0kMSIpLnRvTG93ZXJDYXNlKCkpLEc9cShlPT5lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpK2Uuc2xpY2UoMSkpLFg9cShlPT5lP2BvbiR7RyhlKX1gOiIiKSxRPShlLHQpPT4hT2JqZWN0LmlzKGUsdCksWj0oZSwuLi50KT0+e2ZvcihsZXQgbj0wO248ZS5sZW5ndGg7bisrKWVbbl0oLi4udCl9LFk9KGUsdCxuLHI9ITEpPT57T2JqZWN0LmRlZmluZVByb3BlcnR5KGUsdCx7Y29uZmlndXJhYmxlOiEwLGVudW1lcmFibGU6ITEsd3JpdGFibGU6cix2YWx1ZTpufSl9LGVlPWU9PntsZXQgdD1wYXJzZUZsb2F0KGUpO3JldHVybiBpc05hTih0KT9lOnR9LGV0PWU9PntsZXQgdD1NKGUpP051bWJlcihlKTpOYU47cmV0dXJuIGlzTmFOKHQpP2U6dH0sZW49KCk9Pml8fChpPSJ1bmRlZmluZWQiIT10eXBlb2YgZ2xvYmFsVGhpcz9nbG9iYWxUaGlzOiJ1bmRlZmluZWQiIT10eXBlb2Ygc2VsZj9zZWxmOiJ1bmRlZmluZWQiIT10eXBlb2Ygd2luZG93P3dpbmRvdzoidW5kZWZpbmVkIiE9dHlwZW9mIGdsb2JhbD9nbG9iYWw6e30pLGVyPXkoIkluZmluaXR5LHVuZGVmaW5lZCxOYU4saXNGaW5pdGUsaXNOYU4scGFyc2VGbG9hdCxwYXJzZUludCxkZWNvZGVVUkksZGVjb2RlVVJJQ29tcG9uZW50LGVuY29kZVVSSSxlbmNvZGVVUklDb21wb25lbnQsTWF0aCxOdW1iZXIsRGF0ZSxBcnJheSxPYmplY3QsQm9vbGVhbixTdHJpbmcsUmVnRXhwLE1hcCxTZXQsSlNPTixJbnRsLEJpZ0ludCxjb25zb2xlLEVycm9yLFN5bWJvbCIpO2Z1bmN0aW9uIGVpKGUpe2lmKEUoZSkpe2xldCB0PXt9O2ZvcihsZXQgbj0wO248ZS5sZW5ndGg7bisrKXtsZXQgcj1lW25dLGk9TShyKT9lYShyKTplaShyKTtpZihpKWZvcihsZXQgZSBpbiBpKXRbZV09aVtlXX1yZXR1cm4gdH1pZihNKGUpfHwkKGUpKXJldHVybiBlfWxldCBlbD0vOyg/IVteKF0qXCkpL2csZXM9LzooW15dKykvLGVvPS9cL1wqW15dKj9cKlwvL2c7ZnVuY3Rpb24gZWEoZSl7bGV0IHQ9e307cmV0dXJuIGUucmVwbGFjZShlbywiIikuc3BsaXQoZWwpLmZvckVhY2goZT0+e2lmKGUpe2xldCBuPWUuc3BsaXQoZXMpO24ubGVuZ3RoPjEmJih0W25bMF0udHJpbSgpXT1uWzFdLnRyaW0oKSl9fSksdH1mdW5jdGlvbiBlYyhlKXtsZXQgdD0iIjtpZihNKGUpKXQ9ZTtlbHNlIGlmKEUoZSkpZm9yKGxldCBuPTA7bjxlLmxlbmd0aDtuKyspe2xldCByPWVjKGVbbl0pO3ImJih0Kz1yKyIgIil9ZWxzZSBpZigkKGUpKWZvcihsZXQgbiBpbiBlKWVbbl0mJih0Kz1uKyIgIik7cmV0dXJuIHQudHJpbSgpfWxldCBldT15KCJodG1sLGJvZHksYmFzZSxoZWFkLGxpbmssbWV0YSxzdHlsZSx0aXRsZSxhZGRyZXNzLGFydGljbGUsYXNpZGUsZm9vdGVyLGhlYWRlcixoZ3JvdXAsaDEsaDIsaDMsaDQsaDUsaDYsbmF2LHNlY3Rpb24sZGl2LGRkLGRsLGR0LGZpZ2NhcHRpb24sZmlndXJlLHBpY3R1cmUsaHIsaW1nLGxpLG1haW4sb2wscCxwcmUsdWwsYSxiLGFiYnIsYmRpLGJkbyxicixjaXRlLGNvZGUsZGF0YSxkZm4sZW0saSxrYmQsbWFyayxxLHJwLHJ0LHJ1YnkscyxzYW1wLHNtYWxsLHNwYW4sc3Ryb25nLHN1YixzdXAsdGltZSx1LHZhcix3YnIsYXJlYSxhdWRpbyxtYXAsdHJhY2ssdmlkZW8sZW1iZWQsb2JqZWN0LHBhcmFtLHNvdXJjZSxjYW52YXMsc2NyaXB0LG5vc2NyaXB0LGRlbCxpbnMsY2FwdGlvbixjb2wsY29sZ3JvdXAsdGFibGUsdGhlYWQsdGJvZHksdGQsdGgsdHIsYnV0dG9uLGRhdGFsaXN0LGZpZWxkc2V0LGZvcm0saW5wdXQsbGFiZWwsbGVnZW5kLG1ldGVyLG9wdGdyb3VwLG9wdGlvbixvdXRwdXQscHJvZ3Jlc3Msc2VsZWN0LHRleHRhcmVhLGRldGFpbHMsZGlhbG9nLG1lbnUsc3VtbWFyeSx0ZW1wbGF0ZSxibG9ja3F1b3RlLGlmcmFtZSx0Zm9vdCIpLGVkPXkoInN2ZyxhbmltYXRlLGFuaW1hdGVNb3Rpb24sYW5pbWF0ZVRyYW5zZm9ybSxjaXJjbGUsY2xpcFBhdGgsY29sb3ItcHJvZmlsZSxkZWZzLGRlc2MsZGlzY2FyZCxlbGxpcHNlLGZlQmxlbmQsZmVDb2xvck1hdHJpeCxmZUNvbXBvbmVudFRyYW5zZmVyLGZlQ29tcG9zaXRlLGZlQ29udm9sdmVNYXRyaXgsZmVEaWZmdXNlTGlnaHRpbmcsZmVEaXNwbGFjZW1lbnRNYXAsZmVEaXN0YW50TGlnaHQsZmVEcm9wU2hhZG93LGZlRmxvb2QsZmVGdW5jQSxmZUZ1bmNCLGZlRnVuY0csZmVGdW5jUixmZUdhdXNzaWFuQmx1cixmZUltYWdlLGZlTWVyZ2UsZmVNZXJnZU5vZGUsZmVNb3JwaG9sb2d5LGZlT2Zmc2V0LGZlUG9pbnRMaWdodCxmZVNwZWN1bGFyTGlnaHRpbmcsZmVTcG90TGlnaHQsZmVUaWxlLGZlVHVyYnVsZW5jZSxmaWx0ZXIsZm9yZWlnbk9iamVjdCxnLGhhdGNoLGhhdGNocGF0aCxpbWFnZSxsaW5lLGxpbmVhckdyYWRpZW50LG1hcmtlcixtYXNrLG1lc2gsbWVzaGdyYWRpZW50LG1lc2hwYXRjaCxtZXNocm93LG1ldGFkYXRhLG1wYXRoLHBhdGgscGF0dGVybixwb2x5Z29uLHBvbHlsaW5lLHJhZGlhbEdyYWRpZW50LHJlY3Qsc2V0LHNvbGlkY29sb3Isc3RvcCxzd2l0Y2gsc3ltYm9sLHRleHQsdGV4dFBhdGgsdGl0bGUsdHNwYW4sdW5rbm93bix1c2UsdmlldyIpLGVwPXkoImFubm90YXRpb24sYW5ub3RhdGlvbi14bWwsbWFjdGlvbixtYWxpZ25ncm91cCxtYWxpZ25tYXJrLG1hdGgsbWVuY2xvc2UsbWVycm9yLG1mZW5jZWQsbWZyYWMsbWZyYWN0aW9uLG1nbHlwaCxtaSxtbGFiZWxlZHRyLG1sb25nZGl2LG1tdWx0aXNjcmlwdHMsbW4sbW8sbW92ZXIsbXBhZGRlZCxtcGhhbnRvbSxtcHJlc2NyaXB0cyxtcm9vdCxtcm93LG1zLG1zY2Fycmllcyxtc2NhcnJ5LG1zZ3JvdXAsbXNsaW5lLG1zcGFjZSxtc3FydCxtc3Jvdyxtc3RhY2ssbXN0eWxlLG1zdWIsbXN1YnN1cCxtc3VwLG10YWJsZSxtdGQsbXRleHQsbXRyLG11bmRlcixtdW5kZXJvdmVyLG5vbmUsc2VtYW50aWNzIiksZWg9eSgiYXJlYSxiYXNlLGJyLGNvbCxlbWJlZCxocixpbWcsaW5wdXQsbGluayxtZXRhLHBhcmFtLHNvdXJjZSx0cmFjayx3YnIiKSxlZj15KCJpdGVtc2NvcGUsYWxsb3dmdWxsc2NyZWVuLGZvcm1ub3ZhbGlkYXRlLGlzbWFwLG5vbW9kdWxlLG5vdmFsaWRhdGUscmVhZG9ubHkiKTtmdW5jdGlvbiBlbShlLHQpe2lmKGU9PT10KXJldHVybiEwO2xldCBuPU8oZSkscj1PKHQpO2lmKG58fHIpcmV0dXJuISFuJiYhIXImJmUuZ2V0VGltZSgpPT09dC5nZXRUaW1lKCk7aWYobj1MKGUpLHI9TCh0KSxufHxyKXJldHVybiBlPT09dDtpZihuPUUoZSkscj1FKHQpLG58fHIpcmV0dXJuISFuJiYhIXImJmZ1bmN0aW9uKGUsdCl7aWYoZS5sZW5ndGghPT10Lmxlbmd0aClyZXR1cm4hMTtsZXQgbj0hMDtmb3IobGV0IHI9MDtuJiZyPGUubGVuZ3RoO3IrKyluPWVtKGVbcl0sdFtyXSk7cmV0dXJuIG59KGUsdCk7aWYobj0kKGUpLHI9JCh0KSxufHxyKXtpZighbnx8IXJ8fE9iamVjdC5rZXlzKGUpLmxlbmd0aCE9PU9iamVjdC5rZXlzKHQpLmxlbmd0aClyZXR1cm4hMTtmb3IobGV0IG4gaW4gZSl7bGV0IHI9ZS5oYXNPd25Qcm9wZXJ0eShuKSxpPXQuaGFzT3duUHJvcGVydHkobik7aWYociYmIWl8fCFyJiZpfHwhZW0oZVtuXSx0W25dKSlyZXR1cm4hMX19cmV0dXJuIFN0cmluZyhlKT09PVN0cmluZyh0KX1mdW5jdGlvbiBlZyhlLHQpe3JldHVybiBlLmZpbmRJbmRleChlPT5lbShlLHQpKX1sZXQgZXY9ZT0+ISEoZSYmITA9PT1lLl9fdl9pc1JlZiksZXk9ZT0+TShlKT9lOm51bGw9PWU/IiI6RShlKXx8JChlKSYmKGUudG9TdHJpbmc9PT1GfHwhUChlLnRvU3RyaW5nKSk/ZXYoZSk/ZXkoZS52YWx1ZSk6SlNPTi5zdHJpbmdpZnkoZSxlYiwyKTpTdHJpbmcoZSksZWI9KGUsdCk9PntpZihldih0KSlyZXR1cm4gZWIoZSx0LnZhbHVlKTtpZihJKHQpKXJldHVybntbYE1hcCgke3Quc2l6ZX0pYF06Wy4uLnQuZW50cmllcygpXS5yZWR1Y2UoKGUsW3Qsbl0scik9PihlW2VfKHQscikrIiA9PiJdPW4sZSkse30pfTtpZihSKHQpKXJldHVybntbYFNldCgke3Quc2l6ZX0pYF06Wy4uLnQudmFsdWVzKCldLm1hcChlPT5lXyhlKSl9O2lmKEwodCkpcmV0dXJuIGVfKHQpO2lmKCQodCkmJiFFKHQpJiYhQih0KSlyZXR1cm4gU3RyaW5nKHQpO3JldHVybiB0fSxlXz0oZSx0PSIiKT0+e3ZhciBuO3JldHVybiBMKGUpP2BTeW1ib2woJHtudWxsIT0obj1lLmRlc2NyaXB0aW9uKT9uOnR9KWA6ZX07Y2xhc3MgZVN7Y29uc3RydWN0b3IoZT0hMSl7dGhpcy5kZXRhY2hlZD1lLHRoaXMuX2FjdGl2ZT0hMCx0aGlzLl9vbj0wLHRoaXMuZWZmZWN0cz1bXSx0aGlzLmNsZWFudXBzPVtdLHRoaXMuX2lzUGF1c2VkPSExLHRoaXMucGFyZW50PWwsIWUmJmwmJih0aGlzLmluZGV4PShsLnNjb3Blc3x8KGwuc2NvcGVzPVtdKSkucHVzaCh0aGlzKS0xKX1nZXQgYWN0aXZlKCl7cmV0dXJuIHRoaXMuX2FjdGl2ZX1wYXVzZSgpe2lmKHRoaXMuX2FjdGl2ZSl7bGV0IGUsdDtpZih0aGlzLl9pc1BhdXNlZD0hMCx0aGlzLnNjb3Blcylmb3IoZT0wLHQ9dGhpcy5zY29wZXMubGVuZ3RoO2U8dDtlKyspdGhpcy5zY29wZXNbZV0ucGF1c2UoKTtmb3IoZT0wLHQ9dGhpcy5lZmZlY3RzLmxlbmd0aDtlPHQ7ZSsrKXRoaXMuZWZmZWN0c1tlXS5wYXVzZSgpfX1yZXN1bWUoKXtpZih0aGlzLl9hY3RpdmUmJnRoaXMuX2lzUGF1c2VkKXtsZXQgZSx0O2lmKHRoaXMuX2lzUGF1c2VkPSExLHRoaXMuc2NvcGVzKWZvcihlPTAsdD10aGlzLnNjb3Blcy5sZW5ndGg7ZTx0O2UrKyl0aGlzLnNjb3Blc1tlXS5yZXN1bWUoKTtmb3IoZT0wLHQ9dGhpcy5lZmZlY3RzLmxlbmd0aDtlPHQ7ZSsrKXRoaXMuZWZmZWN0c1tlXS5yZXN1bWUoKX19cnVuKGUpe2lmKHRoaXMuX2FjdGl2ZSl7bGV0IHQ9bDt0cnl7cmV0dXJuIGw9dGhpcyxlKCl9ZmluYWxseXtsPXR9fX1vbigpezE9PSsrdGhpcy5fb24mJih0aGlzLnByZXZTY29wZT1sLGw9dGhpcyl9b2ZmKCl7dGhpcy5fb24+MCYmMD09LS10aGlzLl9vbiYmKGw9dGhpcy5wcmV2U2NvcGUsdGhpcy5wcmV2U2NvcGU9dm9pZCAwKX1zdG9wKGUpe2lmKHRoaXMuX2FjdGl2ZSl7bGV0IHQsbjtmb3IodD0wLHRoaXMuX2FjdGl2ZT0hMSxuPXRoaXMuZWZmZWN0cy5sZW5ndGg7dDxuO3QrKyl0aGlzLmVmZmVjdHNbdF0uc3RvcCgpO2Zvcih0PTAsdGhpcy5lZmZlY3RzLmxlbmd0aD0wLG49dGhpcy5jbGVhbnVwcy5sZW5ndGg7dDxuO3QrKyl0aGlzLmNsZWFudXBzW3RdKCk7aWYodGhpcy5jbGVhbnVwcy5sZW5ndGg9MCx0aGlzLnNjb3Blcyl7Zm9yKHQ9MCxuPXRoaXMuc2NvcGVzLmxlbmd0aDt0PG47dCsrKXRoaXMuc2NvcGVzW3RdLnN0b3AoITApO3RoaXMuc2NvcGVzLmxlbmd0aD0wfWlmKCF0aGlzLmRldGFjaGVkJiZ0aGlzLnBhcmVudCYmIWUpe2xldCBlPXRoaXMucGFyZW50LnNjb3Blcy5wb3AoKTtlJiZlIT09dGhpcyYmKHRoaXMucGFyZW50LnNjb3Blc1t0aGlzLmluZGV4XT1lLGUuaW5kZXg9dGhpcy5pbmRleCl9dGhpcy5wYXJlbnQ9dm9pZCAwfX19bGV0IGV4PW5ldyBXZWFrU2V0O2NsYXNzIGVDe2NvbnN0cnVjdG9yKGUpe3RoaXMuZm49ZSx0aGlzLmRlcHM9dm9pZCAwLHRoaXMuZGVwc1RhaWw9dm9pZCAwLHRoaXMuZmxhZ3M9NSx0aGlzLm5leHQ9dm9pZCAwLHRoaXMuY2xlYW51cD12b2lkIDAsdGhpcy5zY2hlZHVsZXI9dm9pZCAwLGwmJmwuYWN0aXZlJiZsLmVmZmVjdHMucHVzaCh0aGlzKX1wYXVzZSgpe3RoaXMuZmxhZ3N8PTY0fXJlc3VtZSgpezY0JnRoaXMuZmxhZ3MmJih0aGlzLmZsYWdzJj0tNjUsZXguaGFzKHRoaXMpJiYoZXguZGVsZXRlKHRoaXMpLHRoaXMudHJpZ2dlcigpKSl9bm90aWZ5KCl7KCEoMiZ0aGlzLmZsYWdzKXx8MzImdGhpcy5mbGFncykmJig4JnRoaXMuZmxhZ3N8fGVUKHRoaXMpKX1ydW4oKXtpZighKDEmdGhpcy5mbGFncykpcmV0dXJuIHRoaXMuZm4oKTt0aGlzLmZsYWdzfD0yLGUkKHRoaXMpLGV3KHRoaXMpO2xldCBlPXMsdD1lTztzPXRoaXMsZU89ITA7dHJ5e3JldHVybiB0aGlzLmZuKCl9ZmluYWxseXtlQSh0aGlzKSxzPWUsZU89dCx0aGlzLmZsYWdzJj0tM319c3RvcCgpe2lmKDEmdGhpcy5mbGFncyl7Zm9yKGxldCBlPXRoaXMuZGVwcztlO2U9ZS5uZXh0RGVwKWVSKGUpO3RoaXMuZGVwcz10aGlzLmRlcHNUYWlsPXZvaWQgMCxlJCh0aGlzKSx0aGlzLm9uU3RvcCYmdGhpcy5vblN0b3AoKSx0aGlzLmZsYWdzJj0tMn19dHJpZ2dlcigpezY0JnRoaXMuZmxhZ3M/ZXguYWRkKHRoaXMpOnRoaXMuc2NoZWR1bGVyP3RoaXMuc2NoZWR1bGVyKCk6dGhpcy5ydW5JZkRpcnR5KCl9cnVuSWZEaXJ0eSgpe2VFKHRoaXMpJiZ0aGlzLnJ1bigpfWdldCBkaXJ0eSgpe3JldHVybiBlRSh0aGlzKX19bGV0IGVrPTA7ZnVuY3Rpb24gZVQoZSx0PSExKXtpZihlLmZsYWdzfD04LHQpe2UubmV4dD1hLGE9ZTtyZXR1cm59ZS5uZXh0PW8sbz1lfWZ1bmN0aW9uIGVOKCl7bGV0IGU7aWYoISgtLWVrPjApKXtpZihhKXtsZXQgZT1hO2ZvcihhPXZvaWQgMDtlOyl7bGV0IHQ9ZS5uZXh0O2UubmV4dD12b2lkIDAsZS5mbGFncyY9LTksZT10fX1mb3IoO287KXtsZXQgdD1vO2ZvcihvPXZvaWQgMDt0Oyl7bGV0IG49dC5uZXh0O2lmKHQubmV4dD12b2lkIDAsdC5mbGFncyY9LTksMSZ0LmZsYWdzKXRyeXt0LnRyaWdnZXIoKX1jYXRjaCh0KXtlfHwoZT10KX10PW59fWlmKGUpdGhyb3cgZX19ZnVuY3Rpb24gZXcoZSl7Zm9yKGxldCB0PWUuZGVwczt0O3Q9dC5uZXh0RGVwKXQudmVyc2lvbj0tMSx0LnByZXZBY3RpdmVMaW5rPXQuZGVwLmFjdGl2ZUxpbmssdC5kZXAuYWN0aXZlTGluaz10fWZ1bmN0aW9uIGVBKGUpe2xldCB0LG49ZS5kZXBzVGFpbCxyPW47Zm9yKDtyOyl7bGV0IGU9ci5wcmV2RGVwOy0xPT09ci52ZXJzaW9uPyhyPT09biYmKG49ZSksZVIociksZnVuY3Rpb24oZSl7bGV0e3ByZXZEZXA6dCxuZXh0RGVwOm59PWU7dCYmKHQubmV4dERlcD1uLGUucHJldkRlcD12b2lkIDApLG4mJihuLnByZXZEZXA9dCxlLm5leHREZXA9dm9pZCAwKX0ocikpOnQ9cixyLmRlcC5hY3RpdmVMaW5rPXIucHJldkFjdGl2ZUxpbmssci5wcmV2QWN0aXZlTGluaz12b2lkIDAscj1lfWUuZGVwcz10LGUuZGVwc1RhaWw9bn1mdW5jdGlvbiBlRShlKXtmb3IobGV0IHQ9ZS5kZXBzO3Q7dD10Lm5leHREZXApaWYodC5kZXAudmVyc2lvbiE9PXQudmVyc2lvbnx8dC5kZXAuY29tcHV0ZWQmJihlSSh0LmRlcC5jb21wdXRlZCl8fHQuZGVwLnZlcnNpb24hPT10LnZlcnNpb24pKXJldHVybiEwO3JldHVybiEhZS5fZGlydHl9ZnVuY3Rpb24gZUkoZSl7aWYoNCZlLmZsYWdzJiYhKDE2JmUuZmxhZ3MpfHwoZS5mbGFncyY9LTE3LGUuZ2xvYmFsVmVyc2lvbj09PWVEKXx8KGUuZ2xvYmFsVmVyc2lvbj1lRCwhZS5pc1NTUiYmMTI4JmUuZmxhZ3MmJighZS5kZXBzJiYhZS5fZGlydHl8fCFlRShlKSkpKXJldHVybjtlLmZsYWdzfD0yO2xldCB0PWUuZGVwLG49cyxyPWVPO3M9ZSxlTz0hMDt0cnl7ZXcoZSk7bGV0IG49ZS5mbihlLl92YWx1ZSk7KDA9PT10LnZlcnNpb258fFEobixlLl92YWx1ZSkpJiYoZS5mbGFnc3w9MTI4LGUuX3ZhbHVlPW4sdC52ZXJzaW9uKyspfWNhdGNoKGUpe3Rocm93IHQudmVyc2lvbisrLGV9ZmluYWxseXtzPW4sZU89cixlQShlKSxlLmZsYWdzJj0tM319ZnVuY3Rpb24gZVIoZSx0PSExKXtsZXR7ZGVwOm4scHJldlN1YjpyLG5leHRTdWI6aX09ZTtpZihyJiYoci5uZXh0U3ViPWksZS5wcmV2U3ViPXZvaWQgMCksaSYmKGkucHJldlN1Yj1yLGUubmV4dFN1Yj12b2lkIDApLG4uc3Vicz09PWUmJihuLnN1YnM9ciwhciYmbi5jb21wdXRlZCkpe24uY29tcHV0ZWQuZmxhZ3MmPS01O2ZvcihsZXQgZT1uLmNvbXB1dGVkLmRlcHM7ZTtlPWUubmV4dERlcCllUihlLCEwKX10fHwtLW4uc2N8fCFuLm1hcHx8bi5tYXAuZGVsZXRlKG4ua2V5KX1sZXQgZU89ITAsZVA9W107ZnVuY3Rpb24gZU0oKXtlUC5wdXNoKGVPKSxlTz0hMX1mdW5jdGlvbiBlTCgpe2xldCBlPWVQLnBvcCgpO2VPPXZvaWQgMD09PWV8fGV9ZnVuY3Rpb24gZSQoZSl7bGV0e2NsZWFudXA6dH09ZTtpZihlLmNsZWFudXA9dm9pZCAwLHQpe2xldCBlPXM7cz12b2lkIDA7dHJ5e3QoKX1maW5hbGx5e3M9ZX19fWxldCBlRD0wO2NsYXNzIGVGe2NvbnN0cnVjdG9yKGUsdCl7dGhpcy5zdWI9ZSx0aGlzLmRlcD10LHRoaXMudmVyc2lvbj10LnZlcnNpb24sdGhpcy5uZXh0RGVwPXRoaXMucHJldkRlcD10aGlzLm5leHRTdWI9dGhpcy5wcmV2U3ViPXRoaXMucHJldkFjdGl2ZUxpbms9dm9pZCAwfX1jbGFzcyBlVntjb25zdHJ1Y3RvcihlKXt0aGlzLmNvbXB1dGVkPWUsdGhpcy52ZXJzaW9uPTAsdGhpcy5hY3RpdmVMaW5rPXZvaWQgMCx0aGlzLnN1YnM9dm9pZCAwLHRoaXMubWFwPXZvaWQgMCx0aGlzLmtleT12b2lkIDAsdGhpcy5zYz0wLHRoaXMuX192X3NraXA9ITB9dHJhY2soZSl7aWYoIXN8fCFlT3x8cz09PXRoaXMuY29tcHV0ZWQpcmV0dXJuO2xldCB0PXRoaXMuYWN0aXZlTGluaztpZih2b2lkIDA9PT10fHx0LnN1YiE9PXMpdD10aGlzLmFjdGl2ZUxpbms9bmV3IGVGKHMsdGhpcykscy5kZXBzPyh0LnByZXZEZXA9cy5kZXBzVGFpbCxzLmRlcHNUYWlsLm5leHREZXA9dCxzLmRlcHNUYWlsPXQpOnMuZGVwcz1zLmRlcHNUYWlsPXQsZnVuY3Rpb24gZSh0KXtpZih0LmRlcC5zYysrLDQmdC5zdWIuZmxhZ3Mpe2xldCBuPXQuZGVwLmNvbXB1dGVkO2lmKG4mJiF0LmRlcC5zdWJzKXtuLmZsYWdzfD0yMDtmb3IobGV0IHQ9bi5kZXBzO3Q7dD10Lm5leHREZXApZSh0KX1sZXQgcj10LmRlcC5zdWJzO3IhPT10JiYodC5wcmV2U3ViPXIsciYmKHIubmV4dFN1Yj10KSksdC5kZXAuc3Vicz10fX0odCk7ZWxzZSBpZigtMT09PXQudmVyc2lvbiYmKHQudmVyc2lvbj10aGlzLnZlcnNpb24sdC5uZXh0RGVwKSl7bGV0IGU9dC5uZXh0RGVwO2UucHJldkRlcD10LnByZXZEZXAsdC5wcmV2RGVwJiYodC5wcmV2RGVwLm5leHREZXA9ZSksdC5wcmV2RGVwPXMuZGVwc1RhaWwsdC5uZXh0RGVwPXZvaWQgMCxzLmRlcHNUYWlsLm5leHREZXA9dCxzLmRlcHNUYWlsPXQscy5kZXBzPT09dCYmKHMuZGVwcz1lKX1yZXR1cm4gdH10cmlnZ2VyKGUpe3RoaXMudmVyc2lvbisrLGVEKyssdGhpcy5ub3RpZnkoZSl9bm90aWZ5KGUpe2VrKys7dHJ5e2ZvcihsZXQgZT10aGlzLnN1YnM7ZTtlPWUucHJldlN1YillLnN1Yi5ub3RpZnkoKSYmZS5zdWIuZGVwLm5vdGlmeSgpfWZpbmFsbHl7ZU4oKX19fWxldCBlQj1uZXcgV2Vha01hcCxlVT1TeW1ib2woIiIpLGVqPVN5bWJvbCgiIiksZUg9U3ltYm9sKCIiKTtmdW5jdGlvbiBlcShlLHQsbil7aWYoZU8mJnMpe2xldCB0PWVCLmdldChlKTt0fHxlQi5zZXQoZSx0PW5ldyBNYXApO2xldCByPXQuZ2V0KG4pO3J8fCh0LnNldChuLHI9bmV3IGVWKSxyLm1hcD10LHIua2V5PW4pLHIudHJhY2soKX19ZnVuY3Rpb24gZVcoZSx0LG4scixpLGwpe2xldCBzPWVCLmdldChlKTtpZighcylyZXR1cm4gdm9pZCBlRCsrO2xldCBvPWU9PntlJiZlLnRyaWdnZXIoKX07aWYoZWsrKywiY2xlYXIiPT09dClzLmZvckVhY2gobyk7ZWxzZXtsZXQgaT1FKGUpLGw9aSYmVShuKTtpZihpJiYibGVuZ3RoIj09PW4pe2xldCBlPU51bWJlcihyKTtzLmZvckVhY2goKHQsbik9PnsoImxlbmd0aCI9PT1ufHxuPT09ZUh8fCFMKG4pJiZuPj1lKSYmbyh0KX0pfWVsc2Ugc3dpdGNoKCh2b2lkIDAhPT1ufHxzLmhhcyh2b2lkIDApKSYmbyhzLmdldChuKSksbCYmbyhzLmdldChlSCkpLHQpe2Nhc2UiYWRkIjppP2wmJm8ocy5nZXQoImxlbmd0aCIpKToobyhzLmdldChlVSkpLEkoZSkmJm8ocy5nZXQoZWopKSk7YnJlYWs7Y2FzZSJkZWxldGUiOiFpJiYobyhzLmdldChlVSkpLEkoZSkmJm8ocy5nZXQoZWopKSk7YnJlYWs7Y2FzZSJzZXQiOkkoZSkmJm8ocy5nZXQoZVUpKX19ZU4oKX1mdW5jdGlvbiBlSyhlKXtsZXQgdD10UyhlKTtyZXR1cm4gdD09PWU/dDooZXEodCwiaXRlcmF0ZSIsZUgpLHRiKGUpP3Q6dC5tYXAodEMpKX1mdW5jdGlvbiBleihlKXtyZXR1cm4gZXEoZT10UyhlKSwiaXRlcmF0ZSIsZUgpLGV9bGV0IGVKPXtfX3Byb3RvX186bnVsbCxbU3ltYm9sLml0ZXJhdG9yXSgpe3JldHVybiBlRyh0aGlzLFN5bWJvbC5pdGVyYXRvcix0Qyl9LGNvbmNhdCguLi5lKXtyZXR1cm4gZUsodGhpcykuY29uY2F0KC4uLmUubWFwKGU9PkUoZSk/ZUsoZSk6ZSkpfSxlbnRyaWVzKCl7cmV0dXJuIGVHKHRoaXMsImVudHJpZXMiLGU9PihlWzFdPXRDKGVbMV0pLGUpKX0sZXZlcnkoZSx0KXtyZXR1cm4gZVEodGhpcywiZXZlcnkiLGUsdCx2b2lkIDAsYXJndW1lbnRzKX0sZmlsdGVyKGUsdCl7cmV0dXJuIGVRKHRoaXMsImZpbHRlciIsZSx0LGU9PmUubWFwKHRDKSxhcmd1bWVudHMpfSxmaW5kKGUsdCl7cmV0dXJuIGVRKHRoaXMsImZpbmQiLGUsdCx0Qyxhcmd1bWVudHMpfSxmaW5kSW5kZXgoZSx0KXtyZXR1cm4gZVEodGhpcywiZmluZEluZGV4IixlLHQsdm9pZCAwLGFyZ3VtZW50cyl9LGZpbmRMYXN0KGUsdCl7cmV0dXJuIGVRKHRoaXMsImZpbmRMYXN0IixlLHQsdEMsYXJndW1lbnRzKX0sZmluZExhc3RJbmRleChlLHQpe3JldHVybiBlUSh0aGlzLCJmaW5kTGFzdEluZGV4IixlLHQsdm9pZCAwLGFyZ3VtZW50cyl9LGZvckVhY2goZSx0KXtyZXR1cm4gZVEodGhpcywiZm9yRWFjaCIsZSx0LHZvaWQgMCxhcmd1bWVudHMpfSxpbmNsdWRlcyguLi5lKXtyZXR1cm4gZVkodGhpcywiaW5jbHVkZXMiLGUpfSxpbmRleE9mKC4uLmUpe3JldHVybiBlWSh0aGlzLCJpbmRleE9mIixlKX0sam9pbihlKXtyZXR1cm4gZUsodGhpcykuam9pbihlKX0sbGFzdEluZGV4T2YoLi4uZSl7cmV0dXJuIGVZKHRoaXMsImxhc3RJbmRleE9mIixlKX0sbWFwKGUsdCl7cmV0dXJuIGVRKHRoaXMsIm1hcCIsZSx0LHZvaWQgMCxhcmd1bWVudHMpfSxwb3AoKXtyZXR1cm4gZTAodGhpcywicG9wIil9LHB1c2goLi4uZSl7cmV0dXJuIGUwKHRoaXMsInB1c2giLGUpfSxyZWR1Y2UoZSwuLi50KXtyZXR1cm4gZVoodGhpcywicmVkdWNlIixlLHQpfSxyZWR1Y2VSaWdodChlLC4uLnQpe3JldHVybiBlWih0aGlzLCJyZWR1Y2VSaWdodCIsZSx0KX0sc2hpZnQoKXtyZXR1cm4gZTAodGhpcywic2hpZnQiKX0sc29tZShlLHQpe3JldHVybiBlUSh0aGlzLCJzb21lIixlLHQsdm9pZCAwLGFyZ3VtZW50cyl9LHNwbGljZSguLi5lKXtyZXR1cm4gZTAodGhpcywic3BsaWNlIixlKX0sdG9SZXZlcnNlZCgpe3JldHVybiBlSyh0aGlzKS50b1JldmVyc2VkKCl9LHRvU29ydGVkKGUpe3JldHVybiBlSyh0aGlzKS50b1NvcnRlZChlKX0sdG9TcGxpY2VkKC4uLmUpe3JldHVybiBlSyh0aGlzKS50b1NwbGljZWQoLi4uZSl9LHVuc2hpZnQoLi4uZSl7cmV0dXJuIGUwKHRoaXMsInVuc2hpZnQiLGUpfSx2YWx1ZXMoKXtyZXR1cm4gZUcodGhpcywidmFsdWVzIix0Qyl9fTtmdW5jdGlvbiBlRyhlLHQsbil7bGV0IHI9ZXooZSksaT1yW3RdKCk7cmV0dXJuIHI9PT1lfHx0YihlKXx8KGkuX25leHQ9aS5uZXh0LGkubmV4dD0oKT0+e2xldCBlPWkuX25leHQoKTtyZXR1cm4gZS52YWx1ZSYmKGUudmFsdWU9bihlLnZhbHVlKSksZX0pLGl9bGV0IGVYPUFycmF5LnByb3RvdHlwZTtmdW5jdGlvbiBlUShlLHQsbixyLGksbCl7bGV0IHM9ZXooZSksbz1zIT09ZSYmIXRiKGUpLGE9c1t0XTtpZihhIT09ZVhbdF0pe2xldCB0PWEuYXBwbHkoZSxsKTtyZXR1cm4gbz90Qyh0KTp0fWxldCBjPW47cyE9PWUmJihvP2M9ZnVuY3Rpb24odCxyKXtyZXR1cm4gbi5jYWxsKHRoaXMsdEModCkscixlKX06bi5sZW5ndGg+MiYmKGM9ZnVuY3Rpb24odCxyKXtyZXR1cm4gbi5jYWxsKHRoaXMsdCxyLGUpfSkpO2xldCB1PWEuY2FsbChzLGMscik7cmV0dXJuIG8mJmk/aSh1KTp1fWZ1bmN0aW9uIGVaKGUsdCxuLHIpe2xldCBpPWV6KGUpLGw9bjtyZXR1cm4gaSE9PWUmJih0YihlKT9uLmxlbmd0aD4zJiYobD1mdW5jdGlvbih0LHIsaSl7cmV0dXJuIG4uY2FsbCh0aGlzLHQscixpLGUpfSk6bD1mdW5jdGlvbih0LHIsaSl7cmV0dXJuIG4uY2FsbCh0aGlzLHQsdEMociksaSxlKX0pLGlbdF0obCwuLi5yKX1mdW5jdGlvbiBlWShlLHQsbil7bGV0IHI9dFMoZSk7ZXEociwiaXRlcmF0ZSIsZUgpO2xldCBpPXJbdF0oLi4ubik7cmV0dXJuKC0xPT09aXx8ITE9PT1pKSYmdF8oblswXSk/KG5bMF09dFMoblswXSksclt0XSguLi5uKSk6aX1mdW5jdGlvbiBlMChlLHQsbj1bXSl7ZU0oKSxlaysrO2xldCByPXRTKGUpW3RdLmFwcGx5KGUsbik7cmV0dXJuIGVOKCksZUwoKSxyfWxldCBlMT15KCJfX3Byb3RvX18sX192X2lzUmVmLF9faXNWdWUiKSxlMj1uZXcgU2V0KE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKFN5bWJvbCkuZmlsdGVyKGU9PiJhcmd1bWVudHMiIT09ZSYmImNhbGxlciIhPT1lKS5tYXAoZT0+U3ltYm9sW2VdKS5maWx0ZXIoTCkpO2Z1bmN0aW9uIGUzKGUpe0woZSl8fChlPVN0cmluZyhlKSk7bGV0IHQ9dFModGhpcyk7cmV0dXJuIGVxKHQsImhhcyIsZSksdC5oYXNPd25Qcm9wZXJ0eShlKX1jbGFzcyBlNntjb25zdHJ1Y3RvcihlPSExLHQ9ITEpe3RoaXMuX2lzUmVhZG9ubHk9ZSx0aGlzLl9pc1NoYWxsb3c9dH1nZXQoZSx0LG4pe2lmKCJfX3Zfc2tpcCI9PT10KXJldHVybiBlLl9fdl9za2lwO2xldCByPXRoaXMuX2lzUmVhZG9ubHksaT10aGlzLl9pc1NoYWxsb3c7aWYoIl9fdl9pc1JlYWN0aXZlIj09PXQpcmV0dXJuIXI7aWYoIl9fdl9pc1JlYWRvbmx5Ij09PXQpcmV0dXJuIHI7aWYoIl9fdl9pc1NoYWxsb3ciPT09dClyZXR1cm4gaTtpZigiX192X3JhdyI9PT10KXJldHVybiBuPT09KHI/aT90cDp0ZDppP3R1OnRjKS5nZXQoZSl8fE9iamVjdC5nZXRQcm90b3R5cGVPZihlKT09PU9iamVjdC5nZXRQcm90b3R5cGVPZihuKT9lOnZvaWQgMDtsZXQgbD1FKGUpO2lmKCFyKXtsZXQgZTtpZihsJiYoZT1lSlt0XSkpcmV0dXJuIGU7aWYoImhhc093blByb3BlcnR5Ij09PXQpcmV0dXJuIGUzfWxldCBzPVJlZmxlY3QuZ2V0KGUsdCx0VChlKT9lOm4pO3JldHVybihMKHQpP2UyLmhhcyh0KTplMSh0KSl8fChyfHxlcShlLCJnZXQiLHQpLGkpP3M6dFQocyk/bCYmVSh0KT9zOnMudmFsdWU6JChzKT9yP3RtKHMpOnRoKHMpOnN9fWNsYXNzIGU0IGV4dGVuZHMgZTZ7Y29uc3RydWN0b3IoZT0hMSl7c3VwZXIoITEsZSl9c2V0KGUsdCxuLHIpe2xldCBpPWVbdF07aWYoIXRoaXMuX2lzU2hhbGxvdyl7bGV0IHQ9dHkoaSk7aWYodGIobil8fHR5KG4pfHwoaT10UyhpKSxuPXRTKG4pKSwhRShlKSYmdFQoaSkmJiF0VChuKSlpZih0KXJldHVybiExO2Vsc2UgcmV0dXJuIGkudmFsdWU9biwhMH1sZXQgbD1FKGUpJiZVKHQpP051bWJlcih0KTxlLmxlbmd0aDpBKGUsdCkscz1SZWZsZWN0LnNldChlLHQsbix0VChlKT9lOnIpO3JldHVybiBlPT09dFMocikmJihsP1EobixpKSYmZVcoZSwic2V0Iix0LG4pOmVXKGUsImFkZCIsdCxuKSksc31kZWxldGVQcm9wZXJ0eShlLHQpe2xldCBuPUEoZSx0KTtlW3RdO2xldCByPVJlZmxlY3QuZGVsZXRlUHJvcGVydHkoZSx0KTtyZXR1cm4gciYmbiYmZVcoZSwiZGVsZXRlIix0LHZvaWQgMCkscn1oYXMoZSx0KXtsZXQgbj1SZWZsZWN0LmhhcyhlLHQpO3JldHVybiBMKHQpJiZlMi5oYXModCl8fGVxKGUsImhhcyIsdCksbn1vd25LZXlzKGUpe3JldHVybiBlcShlLCJpdGVyYXRlIixFKGUpPyJsZW5ndGgiOmVVKSxSZWZsZWN0Lm93bktleXMoZSl9fWNsYXNzIGU4IGV4dGVuZHMgZTZ7Y29uc3RydWN0b3IoZT0hMSl7c3VwZXIoITAsZSl9c2V0KGUsdCl7cmV0dXJuITB9ZGVsZXRlUHJvcGVydHkoZSx0KXtyZXR1cm4hMH19bGV0IGU1PW5ldyBlNCxlOT1uZXcgZTgsZTc9bmV3IGU0KCEwKSx0ZT1uZXcgZTgoITApLHR0PWU9PmUsdG49ZT0+UmVmbGVjdC5nZXRQcm90b3R5cGVPZihlKTtmdW5jdGlvbiB0cihlKXtyZXR1cm4gZnVuY3Rpb24oLi4udCl7cmV0dXJuImRlbGV0ZSIhPT1lJiYoImNsZWFyIj09PWU/dm9pZCAwOnRoaXMpfX1mdW5jdGlvbiB0aShlLHQpe2xldCBuPWZ1bmN0aW9uKGUsdCl7bGV0IG49e2dldChuKXtsZXQgcj10aGlzLl9fdl9yYXcsaT10UyhyKSxsPXRTKG4pO2V8fChRKG4sbCkmJmVxKGksImdldCIsbiksZXEoaSwiZ2V0IixsKSk7bGV0e2hhczpzfT10bihpKSxvPXQ/dHQ6ZT90azp0QztyZXR1cm4gcy5jYWxsKGksbik/byhyLmdldChuKSk6cy5jYWxsKGksbCk/byhyLmdldChsKSk6dm9pZChyIT09aSYmci5nZXQobikpfSxnZXQgc2l6ZSgpe2xldCB0PXRoaXMuX192X3JhdztyZXR1cm4gZXx8ZXEodFModCksIml0ZXJhdGUiLGVVKSxSZWZsZWN0LmdldCh0LCJzaXplIix0KX0saGFzKHQpe2xldCBuPXRoaXMuX192X3JhdyxyPXRTKG4pLGk9dFModCk7cmV0dXJuIGV8fChRKHQsaSkmJmVxKHIsImhhcyIsdCksZXEociwiaGFzIixpKSksdD09PWk/bi5oYXModCk6bi5oYXModCl8fG4uaGFzKGkpfSxmb3JFYWNoKG4scil7bGV0IGk9dGhpcyxsPWkuX192X3JhdyxzPXRTKGwpLG89dD90dDplP3RrOnRDO3JldHVybiBlfHxlcShzLCJpdGVyYXRlIixlVSksbC5mb3JFYWNoKChlLHQpPT5uLmNhbGwocixvKGUpLG8odCksaSkpfX07cmV0dXJuIFQobixlP3thZGQ6dHIoImFkZCIpLHNldDp0cigic2V0IiksZGVsZXRlOnRyKCJkZWxldGUiKSxjbGVhcjp0cigiY2xlYXIiKX06e2FkZChlKXt0fHx0YihlKXx8dHkoZSl8fChlPXRTKGUpKTtsZXQgbj10Uyh0aGlzKTtyZXR1cm4gdG4obikuaGFzLmNhbGwobixlKXx8KG4uYWRkKGUpLGVXKG4sImFkZCIsZSxlKSksdGhpc30sc2V0KGUsbil7dHx8dGIobil8fHR5KG4pfHwobj10UyhuKSk7bGV0IHI9dFModGhpcykse2hhczppLGdldDpsfT10bihyKSxzPWkuY2FsbChyLGUpO3N8fChlPXRTKGUpLHM9aS5jYWxsKHIsZSkpO2xldCBvPWwuY2FsbChyLGUpO3JldHVybiByLnNldChlLG4pLHM/UShuLG8pJiZlVyhyLCJzZXQiLGUsbik6ZVcociwiYWRkIixlLG4pLHRoaXN9LGRlbGV0ZShlKXtsZXQgdD10Uyh0aGlzKSx7aGFzOm4sZ2V0OnJ9PXRuKHQpLGk9bi5jYWxsKHQsZSk7aXx8KGU9dFMoZSksaT1uLmNhbGwodCxlKSksciYmci5jYWxsKHQsZSk7bGV0IGw9dC5kZWxldGUoZSk7cmV0dXJuIGkmJmVXKHQsImRlbGV0ZSIsZSx2b2lkIDApLGx9LGNsZWFyKCl7bGV0IGU9dFModGhpcyksdD0wIT09ZS5zaXplLG49ZS5jbGVhcigpO3JldHVybiB0JiZlVyhlLCJjbGVhciIsdm9pZCAwLHZvaWQgMCksbn19KSxbImtleXMiLCJ2YWx1ZXMiLCJlbnRyaWVzIixTeW1ib2wuaXRlcmF0b3JdLmZvckVhY2gocj0+e25bcl09ZnVuY3Rpb24oLi4ubil7bGV0IGk9dGhpcy5fX3ZfcmF3LGw9dFMoaSkscz1JKGwpLG89ImVudHJpZXMiPT09cnx8cj09PVN5bWJvbC5pdGVyYXRvciYmcyxhPWlbcl0oLi4ubiksYz10P3R0OmU/dGs6dEM7cmV0dXJuIGV8fGVxKGwsIml0ZXJhdGUiLCJrZXlzIj09PXImJnM/ZWo6ZVUpLHtuZXh0KCl7bGV0e3ZhbHVlOmUsZG9uZTp0fT1hLm5leHQoKTtyZXR1cm4gdD97dmFsdWU6ZSxkb25lOnR9Ont2YWx1ZTpvP1tjKGVbMF0pLGMoZVsxXSldOmMoZSksZG9uZTp0fX0sW1N5bWJvbC5pdGVyYXRvcl0oKXtyZXR1cm4gdGhpc319fX0pLG59KGUsdCk7cmV0dXJuKHQscixpKT0+Il9fdl9pc1JlYWN0aXZlIj09PXI/IWU6Il9fdl9pc1JlYWRvbmx5Ij09PXI/ZToiX192X3JhdyI9PT1yP3Q6UmVmbGVjdC5nZXQoQShuLHIpJiZyIGluIHQ/bjp0LHIsaSl9bGV0IHRsPXtnZXQ6dGkoITEsITEpfSx0cz17Z2V0OnRpKCExLCEwKX0sdG89e2dldDp0aSghMCwhMSl9LHRhPXtnZXQ6dGkoITAsITApfSx0Yz1uZXcgV2Vha01hcCx0dT1uZXcgV2Vha01hcCx0ZD1uZXcgV2Vha01hcCx0cD1uZXcgV2Vha01hcDtmdW5jdGlvbiB0aChlKXtyZXR1cm4gdHkoZSk/ZTp0ZyhlLCExLGU1LHRsLHRjKX1mdW5jdGlvbiB0ZihlKXtyZXR1cm4gdGcoZSwhMSxlNyx0cyx0dSl9ZnVuY3Rpb24gdG0oZSl7cmV0dXJuIHRnKGUsITAsZTksdG8sdGQpfWZ1bmN0aW9uIHRnKGUsdCxuLHIsaSl7dmFyIGw7aWYoISQoZSl8fGUuX192X3JhdyYmISh0JiZlLl9fdl9pc1JlYWN0aXZlKSlyZXR1cm4gZTtsZXQgcz0obD1lKS5fX3Zfc2tpcHx8IU9iamVjdC5pc0V4dGVuc2libGUobCk/MDpmdW5jdGlvbihlKXtzd2l0Y2goZSl7Y2FzZSJPYmplY3QiOmNhc2UiQXJyYXkiOnJldHVybiAxO2Nhc2UiTWFwIjpjYXNlIlNldCI6Y2FzZSJXZWFrTWFwIjpjYXNlIldlYWtTZXQiOnJldHVybiAyO2RlZmF1bHQ6cmV0dXJuIDB9fShWKGwpLnNsaWNlKDgsLTEpKTtpZigwPT09cylyZXR1cm4gZTtsZXQgbz1pLmdldChlKTtpZihvKXJldHVybiBvO2xldCBhPW5ldyBQcm94eShlLDI9PT1zP3I6bik7cmV0dXJuIGkuc2V0KGUsYSksYX1mdW5jdGlvbiB0dihlKXtyZXR1cm4gdHkoZSk/dHYoZS5fX3ZfcmF3KTohIShlJiZlLl9fdl9pc1JlYWN0aXZlKX1mdW5jdGlvbiB0eShlKXtyZXR1cm4hIShlJiZlLl9fdl9pc1JlYWRvbmx5KX1mdW5jdGlvbiB0YihlKXtyZXR1cm4hIShlJiZlLl9fdl9pc1NoYWxsb3cpfWZ1bmN0aW9uIHRfKGUpe3JldHVybiEhZSYmISFlLl9fdl9yYXd9ZnVuY3Rpb24gdFMoZSl7bGV0IHQ9ZSYmZS5fX3ZfcmF3O3JldHVybiB0P3RTKHQpOmV9ZnVuY3Rpb24gdHgoZSl7cmV0dXJuIUEoZSwiX192X3NraXAiKSYmT2JqZWN0LmlzRXh0ZW5zaWJsZShlKSYmWShlLCJfX3Zfc2tpcCIsITApLGV9bGV0IHRDPWU9PiQoZSk/dGgoZSk6ZSx0az1lPT4kKGUpP3RtKGUpOmU7ZnVuY3Rpb24gdFQoZSl7cmV0dXJuISFlJiYhMD09PWUuX192X2lzUmVmfWZ1bmN0aW9uIHROKGUpe3JldHVybiB0QShlLCExKX1mdW5jdGlvbiB0dyhlKXtyZXR1cm4gdEEoZSwhMCl9ZnVuY3Rpb24gdEEoZSx0KXtyZXR1cm4gdFQoZSk/ZTpuZXcgdEUoZSx0KX1jbGFzcyB0RXtjb25zdHJ1Y3RvcihlLHQpe3RoaXMuZGVwPW5ldyBlVix0aGlzLl9fdl9pc1JlZj0hMCx0aGlzLl9fdl9pc1NoYWxsb3c9ITEsdGhpcy5fcmF3VmFsdWU9dD9lOnRTKGUpLHRoaXMuX3ZhbHVlPXQ/ZTp0QyhlKSx0aGlzLl9fdl9pc1NoYWxsb3c9dH1nZXQgdmFsdWUoKXtyZXR1cm4gdGhpcy5kZXAudHJhY2soKSx0aGlzLl92YWx1ZX1zZXQgdmFsdWUoZSl7bGV0IHQ9dGhpcy5fcmF3VmFsdWUsbj10aGlzLl9fdl9pc1NoYWxsb3d8fHRiKGUpfHx0eShlKTtRKGU9bj9lOnRTKGUpLHQpJiYodGhpcy5fcmF3VmFsdWU9ZSx0aGlzLl92YWx1ZT1uP2U6dEMoZSksdGhpcy5kZXAudHJpZ2dlcigpKX19ZnVuY3Rpb24gdEkoZSl7cmV0dXJuIHRUKGUpP2UudmFsdWU6ZX1sZXQgdFI9e2dldDooZSx0LG4pPT4iX192X3JhdyI9PT10P2U6dEkoUmVmbGVjdC5nZXQoZSx0LG4pKSxzZXQ6KGUsdCxuLHIpPT57bGV0IGk9ZVt0XTtyZXR1cm4gdFQoaSkmJiF0VChuKT8oaS52YWx1ZT1uLCEwKTpSZWZsZWN0LnNldChlLHQsbixyKX19O2Z1bmN0aW9uIHRPKGUpe3JldHVybiB0dihlKT9lOm5ldyBQcm94eShlLHRSKX1jbGFzcyB0UHtjb25zdHJ1Y3RvcihlKXt0aGlzLl9fdl9pc1JlZj0hMCx0aGlzLl92YWx1ZT12b2lkIDA7bGV0IHQ9dGhpcy5kZXA9bmV3IGVWLHtnZXQ6bixzZXQ6cn09ZSh0LnRyYWNrLmJpbmQodCksdC50cmlnZ2VyLmJpbmQodCkpO3RoaXMuX2dldD1uLHRoaXMuX3NldD1yfWdldCB2YWx1ZSgpe3JldHVybiB0aGlzLl92YWx1ZT10aGlzLl9nZXQoKX1zZXQgdmFsdWUoZSl7dGhpcy5fc2V0KGUpfX1mdW5jdGlvbiB0TShlKXtyZXR1cm4gbmV3IHRQKGUpfWNsYXNzIHRMe2NvbnN0cnVjdG9yKGUsdCxuKXt0aGlzLl9vYmplY3Q9ZSx0aGlzLl9rZXk9dCx0aGlzLl9kZWZhdWx0VmFsdWU9bix0aGlzLl9fdl9pc1JlZj0hMCx0aGlzLl92YWx1ZT12b2lkIDB9Z2V0IHZhbHVlKCl7bGV0IGU9dGhpcy5fb2JqZWN0W3RoaXMuX2tleV07cmV0dXJuIHRoaXMuX3ZhbHVlPXZvaWQgMD09PWU/dGhpcy5fZGVmYXVsdFZhbHVlOmV9c2V0IHZhbHVlKGUpe3RoaXMuX29iamVjdFt0aGlzLl9rZXldPWV9Z2V0IGRlcCgpe3JldHVybiBmdW5jdGlvbihlLHQpe2xldCBuPWVCLmdldChlKTtyZXR1cm4gbiYmbi5nZXQodCl9KHRTKHRoaXMuX29iamVjdCksdGhpcy5fa2V5KX19Y2xhc3MgdCR7Y29uc3RydWN0b3IoZSl7dGhpcy5fZ2V0dGVyPWUsdGhpcy5fX3ZfaXNSZWY9ITAsdGhpcy5fX3ZfaXNSZWFkb25seT0hMCx0aGlzLl92YWx1ZT12b2lkIDB9Z2V0IHZhbHVlKCl7cmV0dXJuIHRoaXMuX3ZhbHVlPXRoaXMuX2dldHRlcigpfX1mdW5jdGlvbiB0RChlLHQsbil7bGV0IHI9ZVt0XTtyZXR1cm4gdFQocik/cjpuZXcgdEwoZSx0LG4pfWNsYXNzIHRGe2NvbnN0cnVjdG9yKGUsdCxuKXt0aGlzLmZuPWUsdGhpcy5zZXR0ZXI9dCx0aGlzLl92YWx1ZT12b2lkIDAsdGhpcy5kZXA9bmV3IGVWKHRoaXMpLHRoaXMuX192X2lzUmVmPSEwLHRoaXMuZGVwcz12b2lkIDAsdGhpcy5kZXBzVGFpbD12b2lkIDAsdGhpcy5mbGFncz0xNix0aGlzLmdsb2JhbFZlcnNpb249ZUQtMSx0aGlzLm5leHQ9dm9pZCAwLHRoaXMuZWZmZWN0PXRoaXMsdGhpcy5fX3ZfaXNSZWFkb25seT0hdCx0aGlzLmlzU1NSPW59bm90aWZ5KCl7aWYodGhpcy5mbGFnc3w9MTYsISg4JnRoaXMuZmxhZ3MpJiZzIT09dGhpcylyZXR1cm4gZVQodGhpcywhMCksITB9Z2V0IHZhbHVlKCl7bGV0IGU9dGhpcy5kZXAudHJhY2soKTtyZXR1cm4gZUkodGhpcyksZSYmKGUudmVyc2lvbj10aGlzLmRlcC52ZXJzaW9uKSx0aGlzLl92YWx1ZX1zZXQgdmFsdWUoZSl7dGhpcy5zZXR0ZXImJnRoaXMuc2V0dGVyKGUpfX1sZXQgdFY9e30sdEI9bmV3IFdlYWtNYXA7ZnVuY3Rpb24gdFUoZSx0PSExLG49bSl7aWYobil7bGV0IHQ9dEIuZ2V0KG4pO3R8fHRCLnNldChuLHQ9W10pLHQucHVzaChlKX19ZnVuY3Rpb24gdGooZSx0PTEvMCxuKXtpZih0PD0wfHwhJChlKXx8ZS5fX3Zfc2tpcHx8KG49bnx8bmV3IFNldCkuaGFzKGUpKXJldHVybiBlO2lmKG4uYWRkKGUpLHQtLSx0VChlKSl0aihlLnZhbHVlLHQsbik7ZWxzZSBpZihFKGUpKWZvcihsZXQgcj0wO3I8ZS5sZW5ndGg7cisrKXRqKGVbcl0sdCxuKTtlbHNlIGlmKFIoZSl8fEkoZSkpZS5mb3JFYWNoKGU9Pnt0aihlLHQsbil9KTtlbHNlIGlmKEIoZSkpe2ZvcihsZXQgciBpbiBlKXRqKGVbcl0sdCxuKTtmb3IobGV0IHIgb2YgT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKSlPYmplY3QucHJvdG90eXBlLnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSxyKSYmdGooZVtyXSx0LG4pfXJldHVybiBlfWZ1bmN0aW9uIHRIKGUsdCxuLHIpe3RyeXtyZXR1cm4gcj9lKC4uLnIpOmUoKX1jYXRjaChlKXt0VyhlLHQsbil9fWZ1bmN0aW9uIHRxKGUsdCxuLHIpe2lmKFAoZSkpe2xldCBpPXRIKGUsdCxuLHIpO3JldHVybiBpJiZEKGkpJiZpLmNhdGNoKGU9Pnt0VyhlLHQsbil9KSxpfWlmKEUoZSkpe2xldCBpPVtdO2ZvcihsZXQgbD0wO2w8ZS5sZW5ndGg7bCsrKWkucHVzaCh0cShlW2xdLHQsbixyKSk7cmV0dXJuIGl9fWZ1bmN0aW9uIHRXKGUsdCxuLHI9ITApe2xldCBpPXQ/dC52bm9kZTpudWxsLHtlcnJvckhhbmRsZXI6bCx0aHJvd1VuaGFuZGxlZEVycm9ySW5Qcm9kdWN0aW9uOnN9PXQmJnQuYXBwQ29udGV4dC5jb25maWd8fGI7aWYodCl7bGV0IHI9dC5wYXJlbnQsaT10LnByb3h5LHM9YGh0dHBzOi8vdnVlanMub3JnL2Vycm9yLXJlZmVyZW5jZS8jcnVudGltZS0ke259YDtmb3IoO3I7KXtsZXQgdD1yLmVjO2lmKHQpe2ZvcihsZXQgbj0wO248dC5sZW5ndGg7bisrKWlmKCExPT09dFtuXShlLGkscykpcmV0dXJufXI9ci5wYXJlbnR9aWYobCl7ZU0oKSx0SChsLG51bGwsMTAsW2UsaSxzXSksZUwoKTtyZXR1cm59fSFmdW5jdGlvbihlLHQsbixyPSEwLGk9ITEpe2lmKGkpdGhyb3cgZTtjb25zb2xlLmVycm9yKGUpfShlLDAsMCxyLHMpfWxldCB0Sz1bXSx0ej0tMSx0Sj1bXSx0Rz1udWxsLHRYPTAsdFE9UHJvbWlzZS5yZXNvbHZlKCksdFo9bnVsbDtmdW5jdGlvbiB0WShlKXtsZXQgdD10Wnx8dFE7cmV0dXJuIGU/dC50aGVuKHRoaXM/ZS5iaW5kKHRoaXMpOmUpOnR9ZnVuY3Rpb24gdDAoZSl7aWYoISgxJmUuZmxhZ3MpKXtsZXQgdD10NChlKSxuPXRLW3RLLmxlbmd0aC0xXTshbnx8ISgyJmUuZmxhZ3MpJiZ0Pj10NChuKT90Sy5wdXNoKGUpOnRLLnNwbGljZShmdW5jdGlvbihlKXtsZXQgdD10eisxLG49dEsubGVuZ3RoO2Zvcig7dDxuOyl7bGV0IHI9dCtuPj4+MSxpPXRLW3JdLGw9dDQoaSk7bDxlfHxsPT09ZSYmMiZpLmZsYWdzP3Q9cisxOm49cn1yZXR1cm4gdH0odCksMCxlKSxlLmZsYWdzfD0xLHQxKCl9fWZ1bmN0aW9uIHQxKCl7dFp8fCh0Wj10US50aGVuKGZ1bmN0aW9uIGUodCl7dHJ5e2Zvcih0ej0wO3R6PHRLLmxlbmd0aDt0eisrKXtsZXQgZT10S1t0el07ZSYmISg4JmUuZmxhZ3MpJiYoNCZlLmZsYWdzJiYoZS5mbGFncyY9LTIpLHRIKGUsZS5pLGUuaT8xNToxNCksNCZlLmZsYWdzfHwoZS5mbGFncyY9LTIpKX19ZmluYWxseXtmb3IoO3R6PHRLLmxlbmd0aDt0eisrKXtsZXQgZT10S1t0el07ZSYmKGUuZmxhZ3MmPS0yKX10ej0tMSx0Sy5sZW5ndGg9MCx0NigpLHRaPW51bGwsKHRLLmxlbmd0aHx8dEoubGVuZ3RoKSYmZSgpfX0pKX1mdW5jdGlvbiB0MihlKXtFKGUpP3RKLnB1c2goLi4uZSk6dEcmJi0xPT09ZS5pZD90Ry5zcGxpY2UodFgrMSwwLGUpOjEmZS5mbGFnc3x8KHRKLnB1c2goZSksZS5mbGFnc3w9MSksdDEoKX1mdW5jdGlvbiB0MyhlLHQsbj10eisxKXtmb3IoO248dEsubGVuZ3RoO24rKyl7bGV0IHQ9dEtbbl07aWYodCYmMiZ0LmZsYWdzKXtpZihlJiZ0LmlkIT09ZS51aWQpY29udGludWU7dEsuc3BsaWNlKG4sMSksbi0tLDQmdC5mbGFncyYmKHQuZmxhZ3MmPS0yKSx0KCksNCZ0LmZsYWdzfHwodC5mbGFncyY9LTIpfX19ZnVuY3Rpb24gdDYoZSl7aWYodEoubGVuZ3RoKXtsZXQgZT1bLi4ubmV3IFNldCh0SildLnNvcnQoKGUsdCk9PnQ0KGUpLXQ0KHQpKTtpZih0Si5sZW5ndGg9MCx0RylyZXR1cm4gdm9pZCB0Ry5wdXNoKC4uLmUpO2Zvcih0WD0wLHRHPWU7dFg8dEcubGVuZ3RoO3RYKyspe2xldCBlPXRHW3RYXTs0JmUuZmxhZ3MmJihlLmZsYWdzJj0tMiksOCZlLmZsYWdzfHxlKCksZS5mbGFncyY9LTJ9dEc9bnVsbCx0WD0wfX1sZXQgdDQ9ZT0+bnVsbD09ZS5pZD8yJmUuZmxhZ3M/LTE6MS8wOmUuaWQsdDg9bnVsbCx0NT1udWxsO2Z1bmN0aW9uIHQ5KGUpe2xldCB0PXQ4O3JldHVybiB0OD1lLHQ1PWUmJmUudHlwZS5fX3Njb3BlSWR8fG51bGwsdH1mdW5jdGlvbiB0NyhlLHQ9dDgsbil7aWYoIXR8fGUuX24pcmV0dXJuIGU7bGV0IHI9KC4uLm4pPT57bGV0IGk7ci5fZCYmaWEoLTEpO2xldCBsPXQ5KHQpO3RyeXtpPWUoLi4ubil9ZmluYWxseXt0OShsKSxyLl9kJiZpYSgxKX1yZXR1cm4gaX07cmV0dXJuIHIuX249ITAsci5fYz0hMCxyLl9kPSEwLHJ9ZnVuY3Rpb24gbmUoZSx0LG4scil7bGV0IGk9ZS5kaXJzLGw9dCYmdC5kaXJzO2ZvcihsZXQgcz0wO3M8aS5sZW5ndGg7cysrKXtsZXQgbz1pW3NdO2wmJihvLm9sZFZhbHVlPWxbc10udmFsdWUpO2xldCBhPW8uZGlyW3JdO2EmJihlTSgpLHRxKGEsbiw4LFtlLmVsLG8sZSx0XSksZUwoKSl9fWxldCBudD1TeW1ib2woIl92dGUiKSxubj1lPT5lJiYoZS5kaXNhYmxlZHx8IiI9PT1lLmRpc2FibGVkKSxucj1lPT5lJiYoZS5kZWZlcnx8IiI9PT1lLmRlZmVyKSxuaT1lPT4idW5kZWZpbmVkIiE9dHlwZW9mIFNWR0VsZW1lbnQmJmUgaW5zdGFuY2VvZiBTVkdFbGVtZW50LG5sPWU9PiJmdW5jdGlvbiI9PXR5cGVvZiBNYXRoTUxFbGVtZW50JiZlIGluc3RhbmNlb2YgTWF0aE1MRWxlbWVudCxucz0oZSx0KT0+e2xldCBuPWUmJmUudG87cmV0dXJuIE0obik/dD90KG4pOm51bGw6bn0sbm89e25hbWU6IlRlbGVwb3J0IixfX2lzVGVsZXBvcnQ6ITAscHJvY2VzcyhlLHQsbixyLGksbCxzLG8sYSxjKXtsZXR7bWM6dSxwYzpkLHBiYzpwLG86e2luc2VydDpoLHF1ZXJ5U2VsZWN0b3I6ZixjcmVhdGVUZXh0Om0sY3JlYXRlQ29tbWVudDpnfX09Yyx5PW5uKHQucHJvcHMpLHtzaGFwZUZsYWc6YixjaGlsZHJlbjpfLGR5bmFtaWNDaGlsZHJlbjpTfT10O2lmKG51bGw9PWUpe2xldCBlPXQuZWw9bSgiIiksYz10LmFuY2hvcj1tKCIiKTtoKGUsbixyKSxoKGMsbixyKTtsZXQgZD0oZSx0KT0+ezE2JmImJihpJiZpLmlzQ0UmJihpLmNlLl90ZWxlcG9ydFRhcmdldD1lKSx1KF8sZSx0LGksbCxzLG8sYSkpfSxwPSgpPT57bGV0IGU9dC50YXJnZXQ9bnModC5wcm9wcyxmKSxuPW51KGUsdCxtLGgpO2UmJigic3ZnIiE9PXMmJm5pKGUpP3M9InN2ZyI6Im1hdGhtbCIhPT1zJiZubChlKSYmKHM9Im1hdGhtbCIpLHl8fChkKGUsbiksbmModCwhMSkpKX07eSYmKGQobixjKSxuYyh0LCEwKSksbnIodC5wcm9wcyk/KHQuZWwuX19pc01vdW50ZWQ9ITEsck0oKCk9PntwKCksZGVsZXRlIHQuZWwuX19pc01vdW50ZWR9LGwpKTpwKCl9ZWxzZXtpZihucih0LnByb3BzKSYmITE9PT1lLmVsLl9faXNNb3VudGVkKXJldHVybiB2b2lkIHJNKCgpPT57bm8ucHJvY2VzcyhlLHQsbixyLGksbCxzLG8sYSxjKX0sbCk7dC5lbD1lLmVsLHQudGFyZ2V0U3RhcnQ9ZS50YXJnZXRTdGFydDtsZXQgdT10LmFuY2hvcj1lLmFuY2hvcixoPXQudGFyZ2V0PWUudGFyZ2V0LG09dC50YXJnZXRBbmNob3I9ZS50YXJnZXRBbmNob3IsZz1ubihlLnByb3BzKSxiPWc/bjpoLF89Zz91Om07aWYoInN2ZyI9PT1zfHxuaShoKT9zPSJzdmciOigibWF0aG1sIj09PXN8fG5sKGgpKSYmKHM9Im1hdGhtbCIpLFM/KHAoZS5keW5hbWljQ2hpbGRyZW4sUyxiLGksbCxzLG8pLHJCKGUsdCwhMCkpOmF8fGQoZSx0LGIsXyxpLGwscyxvLCExKSx5KWc/dC5wcm9wcyYmZS5wcm9wcyYmdC5wcm9wcy50byE9PWUucHJvcHMudG8mJih0LnByb3BzLnRvPWUucHJvcHMudG8pOm5hKHQsbix1LGMsMSk7ZWxzZSBpZigodC5wcm9wcyYmdC5wcm9wcy50bykhPT0oZS5wcm9wcyYmZS5wcm9wcy50bykpe2xldCBlPXQudGFyZ2V0PW5zKHQucHJvcHMsZik7ZSYmbmEodCxlLG51bGwsYywwKX1lbHNlIGcmJm5hKHQsaCxtLGMsMSk7bmModCx5KX19LHJlbW92ZShlLHQsbix7dW06cixvOntyZW1vdmU6aX19LGwpe2xldHtzaGFwZUZsYWc6cyxjaGlsZHJlbjpvLGFuY2hvcjphLHRhcmdldFN0YXJ0OmMsdGFyZ2V0QW5jaG9yOnUsdGFyZ2V0OmQscHJvcHM6cH09ZTtpZihkJiYoaShjKSxpKHUpKSxsJiZpKGEpLDE2JnMpe2xldCBlPWx8fCFubihwKTtmb3IobGV0IGk9MDtpPG8ubGVuZ3RoO2krKyl7bGV0IGw9b1tpXTtyKGwsdCxuLGUsISFsLmR5bmFtaWNDaGlsZHJlbil9fX0sbW92ZTpuYSxoeWRyYXRlOmZ1bmN0aW9uKGUsdCxuLHIsaSxsLHtvOntuZXh0U2libGluZzpzLHBhcmVudE5vZGU6byxxdWVyeVNlbGVjdG9yOmEsaW5zZXJ0OmMsY3JlYXRlVGV4dDp1fX0sZCl7bGV0IHA9dC50YXJnZXQ9bnModC5wcm9wcyxhKTtpZihwKXtsZXQgYT1ubih0LnByb3BzKSxoPXAuX2xwYXx8cC5maXJzdENoaWxkO2lmKDE2JnQuc2hhcGVGbGFnKWlmKGEpdC5hbmNob3I9ZChzKGUpLHQsbyhlKSxuLHIsaSxsKSx0LnRhcmdldFN0YXJ0PWgsdC50YXJnZXRBbmNob3I9aCYmcyhoKTtlbHNle3QuYW5jaG9yPXMoZSk7bGV0IG89aDtmb3IoO287KXtpZihvJiY4PT09by5ub2RlVHlwZSl7aWYoInRlbGVwb3J0IHN0YXJ0IGFuY2hvciI9PT1vLmRhdGEpdC50YXJnZXRTdGFydD1vO2Vsc2UgaWYoInRlbGVwb3J0IGFuY2hvciI9PT1vLmRhdGEpe3QudGFyZ2V0QW5jaG9yPW8scC5fbHBhPXQudGFyZ2V0QW5jaG9yJiZzKHQudGFyZ2V0QW5jaG9yKTticmVha319bz1zKG8pfXQudGFyZ2V0QW5jaG9yfHxudShwLHQsdSxjKSxkKGgmJnMoaCksdCxwLG4scixpLGwpfW5jKHQsYSl9cmV0dXJuIHQuYW5jaG9yJiZzKHQuYW5jaG9yKX19O2Z1bmN0aW9uIG5hKGUsdCxuLHtvOntpbnNlcnQ6cn0sbTppfSxsPTIpezA9PT1sJiZyKGUudGFyZ2V0QW5jaG9yLHQsbik7bGV0e2VsOnMsYW5jaG9yOm8sc2hhcGVGbGFnOmEsY2hpbGRyZW46Yyxwcm9wczp1fT1lLGQ9Mj09PWw7aWYoZCYmcihzLHQsbiksKCFkfHxubih1KSkmJjE2JmEpZm9yKGxldCBlPTA7ZTxjLmxlbmd0aDtlKyspaShjW2VdLHQsbiwyKTtkJiZyKG8sdCxuKX1mdW5jdGlvbiBuYyhlLHQpe2xldCBuPWUuY3R4O2lmKG4mJm4udXQpe2xldCByLGk7Zm9yKHQ/KHI9ZS5lbCxpPWUuYW5jaG9yKToocj1lLnRhcmdldFN0YXJ0LGk9ZS50YXJnZXRBbmNob3IpO3ImJnIhPT1pOykxPT09ci5ub2RlVHlwZSYmci5zZXRBdHRyaWJ1dGUoImRhdGEtdi1vd25lciIsbi51aWQpLHI9ci5uZXh0U2libGluZztuLnV0KCl9fWZ1bmN0aW9uIG51KGUsdCxuLHIpe2xldCBpPXQudGFyZ2V0U3RhcnQ9bigiIiksbD10LnRhcmdldEFuY2hvcj1uKCIiKTtyZXR1cm4gaVtudF09bCxlJiYocihpLGUpLHIobCxlKSksbH1sZXQgbmQ9U3ltYm9sKCJfbGVhdmVDYiIpLG5wPVN5bWJvbCgiX2VudGVyQ2IiKTtmdW5jdGlvbiBuaCgpe2xldCBlPXtpc01vdW50ZWQ6ITEsaXNMZWF2aW5nOiExLGlzVW5tb3VudGluZzohMSxsZWF2aW5nVk5vZGVzOm5ldyBNYXB9O3JldHVybiBuWCgoKT0+e2UuaXNNb3VudGVkPSEwfSksblkoKCk9PntlLmlzVW5tb3VudGluZz0hMH0pLGV9bGV0IG5mPVtGdW5jdGlvbixBcnJheV0sbm09e21vZGU6U3RyaW5nLGFwcGVhcjpCb29sZWFuLHBlcnNpc3RlZDpCb29sZWFuLG9uQmVmb3JlRW50ZXI6bmYsb25FbnRlcjpuZixvbkFmdGVyRW50ZXI6bmYsb25FbnRlckNhbmNlbGxlZDpuZixvbkJlZm9yZUxlYXZlOm5mLG9uTGVhdmU6bmYsb25BZnRlckxlYXZlOm5mLG9uTGVhdmVDYW5jZWxsZWQ6bmYsb25CZWZvcmVBcHBlYXI6bmYsb25BcHBlYXI6bmYsb25BZnRlckFwcGVhcjpuZixvbkFwcGVhckNhbmNlbGxlZDpuZn0sbmc9ZT0+e2xldCB0PWUuc3ViVHJlZTtyZXR1cm4gdC5jb21wb25lbnQ/bmcodC5jb21wb25lbnQpOnR9O2Z1bmN0aW9uIG52KGUpe2xldCB0PWVbMF07aWYoZS5sZW5ndGg+MSl7Zm9yKGxldCBuIG9mIGUpaWYobi50eXBlIT09aWUpe3Q9bjticmVha319cmV0dXJuIHR9bGV0IG55PXtuYW1lOiJCYXNlVHJhbnNpdGlvbiIscHJvcHM6bm0sc2V0dXAoZSx7c2xvdHM6dH0pe2xldCBuPWlFKCkscj1uaCgpO3JldHVybigpPT57bGV0IGk9dC5kZWZhdWx0JiZuayh0LmRlZmF1bHQoKSwhMCk7aWYoIWl8fCFpLmxlbmd0aClyZXR1cm47bGV0IGw9bnYoaSkscz10UyhlKSx7bW9kZTpvfT1zO2lmKHIuaXNMZWF2aW5nKXJldHVybiBuUyhsKTtsZXQgYT1ueChsKTtpZighYSlyZXR1cm4gblMobCk7bGV0IGM9bl8oYSxzLHIsbixlPT5jPWUpO2EudHlwZSE9PWllJiZuQyhhLGMpO2xldCB1PW4uc3ViVHJlZSYmbngobi5zdWJUcmVlKTtpZih1JiZ1LnR5cGUhPT1pZSYmIWlwKGEsdSkmJm5nKG4pLnR5cGUhPT1pZSl7bGV0IGU9bl8odSxzLHIsbik7aWYobkModSxlKSwib3V0LWluIj09PW8mJmEudHlwZSE9PWllKXJldHVybiByLmlzTGVhdmluZz0hMCxlLmFmdGVyTGVhdmU9KCk9PntyLmlzTGVhdmluZz0hMSw4Jm4uam9iLmZsYWdzfHxuLnVwZGF0ZSgpLGRlbGV0ZSBlLmFmdGVyTGVhdmUsdT12b2lkIDB9LG5TKGwpOyJpbi1vdXQiPT09byYmYS50eXBlIT09aWU/ZS5kZWxheUxlYXZlPShlLHQsbik9PntuYihyLHUpW1N0cmluZyh1LmtleSldPXUsZVtuZF09KCk9Pnt0KCksZVtuZF09dm9pZCAwLGRlbGV0ZSBjLmRlbGF5ZWRMZWF2ZSx1PXZvaWQgMH0sYy5kZWxheWVkTGVhdmU9KCk9PntuKCksZGVsZXRlIGMuZGVsYXllZExlYXZlLHU9dm9pZCAwfX06dT12b2lkIDB9ZWxzZSB1JiYodT12b2lkIDApO3JldHVybiBsfX19O2Z1bmN0aW9uIG5iKGUsdCl7bGV0e2xlYXZpbmdWTm9kZXM6bn09ZSxyPW4uZ2V0KHQudHlwZSk7cmV0dXJuIHJ8fChyPU9iamVjdC5jcmVhdGUobnVsbCksbi5zZXQodC50eXBlLHIpKSxyfWZ1bmN0aW9uIG5fKGUsdCxuLHIsaSl7bGV0e2FwcGVhcjpsLG1vZGU6cyxwZXJzaXN0ZWQ6bz0hMSxvbkJlZm9yZUVudGVyOmEsb25FbnRlcjpjLG9uQWZ0ZXJFbnRlcjp1LG9uRW50ZXJDYW5jZWxsZWQ6ZCxvbkJlZm9yZUxlYXZlOnAsb25MZWF2ZTpoLG9uQWZ0ZXJMZWF2ZTpmLG9uTGVhdmVDYW5jZWxsZWQ6bSxvbkJlZm9yZUFwcGVhcjpnLG9uQXBwZWFyOnksb25BZnRlckFwcGVhcjpiLG9uQXBwZWFyQ2FuY2VsbGVkOl99PXQsUz1TdHJpbmcoZS5rZXkpLHg9bmIobixlKSxDPShlLHQpPT57ZSYmdHEoZSxyLDksdCl9LGs9KGUsdCk9PntsZXQgbj10WzFdO0MoZSx0KSxFKGUpP2UuZXZlcnkoZT0+ZS5sZW5ndGg8PTEpJiZuKCk6ZS5sZW5ndGg8PTEmJm4oKX0sVD17bW9kZTpzLHBlcnNpc3RlZDpvLGJlZm9yZUVudGVyKHQpe2xldCByPWE7aWYoIW4uaXNNb3VudGVkKWlmKCFsKXJldHVybjtlbHNlIHI9Z3x8YTt0W25kXSYmdFtuZF0oITApO2xldCBpPXhbU107aSYmaXAoZSxpKSYmaS5lbFtuZF0mJmkuZWxbbmRdKCksQyhyLFt0XSl9LGVudGVyKGUpe2xldCB0PWMscj11LGk9ZDtpZighbi5pc01vdW50ZWQpaWYoIWwpcmV0dXJuO2Vsc2UgdD15fHxjLHI9Ynx8dSxpPV98fGQ7bGV0IHM9ITEsbz1lW25wXT10PT57c3x8KHM9ITAsdD9DKGksW2VdKTpDKHIsW2VdKSxULmRlbGF5ZWRMZWF2ZSYmVC5kZWxheWVkTGVhdmUoKSxlW25wXT12b2lkIDApfTt0P2sodCxbZSxvXSk6bygpfSxsZWF2ZSh0LHIpe2xldCBpPVN0cmluZyhlLmtleSk7aWYodFtucF0mJnRbbnBdKCEwKSxuLmlzVW5tb3VudGluZylyZXR1cm4gcigpO0MocCxbdF0pO2xldCBsPSExLHM9dFtuZF09bj0+e2x8fChsPSEwLHIoKSxuP0MobSxbdF0pOkMoZixbdF0pLHRbbmRdPXZvaWQgMCx4W2ldPT09ZSYmZGVsZXRlIHhbaV0pfTt4W2ldPWUsaD9rKGgsW3Qsc10pOnMoKX0sY2xvbmUoZSl7bGV0IGw9bl8oZSx0LG4scixpKTtyZXR1cm4gaSYmaShsKSxsfX07cmV0dXJuIFR9ZnVuY3Rpb24gblMoZSl7aWYobkIoZSkpcmV0dXJuKGU9aWIoZSkpLmNoaWxkcmVuPW51bGwsZX1mdW5jdGlvbiBueChlKXtpZighbkIoZSkpcmV0dXJuIGUudHlwZS5fX2lzVGVsZXBvcnQmJmUuY2hpbGRyZW4/bnYoZS5jaGlsZHJlbik6ZTtpZihlLmNvbXBvbmVudClyZXR1cm4gZS5jb21wb25lbnQuc3ViVHJlZTtsZXR7c2hhcGVGbGFnOnQsY2hpbGRyZW46bn09ZTtpZihuKXtpZigxNiZ0KXJldHVybiBuWzBdO2lmKDMyJnQmJlAobi5kZWZhdWx0KSlyZXR1cm4gbi5kZWZhdWx0KCl9fWZ1bmN0aW9uIG5DKGUsdCl7NiZlLnNoYXBlRmxhZyYmZS5jb21wb25lbnQ/KGUudHJhbnNpdGlvbj10LG5DKGUuY29tcG9uZW50LnN1YlRyZWUsdCkpOjEyOCZlLnNoYXBlRmxhZz8oZS5zc0NvbnRlbnQudHJhbnNpdGlvbj10LmNsb25lKGUuc3NDb250ZW50KSxlLnNzRmFsbGJhY2sudHJhbnNpdGlvbj10LmNsb25lKGUuc3NGYWxsYmFjaykpOmUudHJhbnNpdGlvbj10fWZ1bmN0aW9uIG5rKGUsdD0hMSxuKXtsZXQgcj1bXSxpPTA7Zm9yKGxldCBsPTA7bDxlLmxlbmd0aDtsKyspe2xldCBzPWVbbF0sbz1udWxsPT1uP3Mua2V5OlN0cmluZyhuKStTdHJpbmcobnVsbCE9cy5rZXk/cy5rZXk6bCk7cy50eXBlPT09cjk/KDEyOCZzLnBhdGNoRmxhZyYmaSsrLHI9ci5jb25jYXQobmsocy5jaGlsZHJlbix0LG8pKSk6KHR8fHMudHlwZSE9PWllKSYmci5wdXNoKG51bGwhPW8/aWIocyx7a2V5Om99KTpzKX1pZihpPjEpZm9yKGxldCBlPTA7ZTxyLmxlbmd0aDtlKyspcltlXS5wYXRjaEZsYWc9LTI7cmV0dXJuIHJ9ZnVuY3Rpb24gblQoZSx0KXtyZXR1cm4gUChlKT9UKHtuYW1lOmUubmFtZX0sdCx7c2V0dXA6ZX0pOmV9ZnVuY3Rpb24gbk4oZSl7ZS5pZHM9W2UuaWRzWzBdK2UuaWRzWzJdKysrIi0iLDAsMF19ZnVuY3Rpb24gbncoZSx0LG4scixpPSExKXtpZihFKGUpKXJldHVybiB2b2lkIGUuZm9yRWFjaCgoZSxsKT0+bncoZSx0JiYoRSh0KT90W2xdOnQpLG4scixpKSk7aWYobkYocikmJiFpKXs1MTImci5zaGFwZUZsYWcmJnIudHlwZS5fX2FzeW5jUmVzb2x2ZWQmJnIuY29tcG9uZW50LnN1YlRyZWUuY29tcG9uZW50JiZudyhlLHQsbixyLmNvbXBvbmVudC5zdWJUcmVlKTtyZXR1cm59bGV0IGw9NCZyLnNoYXBlRmxhZz9pVihyLmNvbXBvbmVudCk6ci5lbCxzPWk/bnVsbDpsLHtpOm8scjphfT1lLGM9dCYmdC5yLHU9by5yZWZzPT09Yj9vLnJlZnM9e306by5yZWZzLGQ9by5zZXR1cFN0YXRlLHA9dFMoZCksaD1kPT09Yj8oKT0+ITE6ZT0+QShwLGUpO2lmKG51bGwhPWMmJmMhPT1hJiYoTShjKT8odVtjXT1udWxsLGgoYykmJihkW2NdPW51bGwpKTp0VChjKSYmKGMudmFsdWU9bnVsbCkpLFAoYSkpdEgoYSxvLDEyLFtzLHVdKTtlbHNle2xldCB0PU0oYSkscj10VChhKTtpZih0fHxyKXtsZXQgbz0oKT0+e2lmKGUuZil7bGV0IG49dD9oKGEpP2RbYV06dVthXTphLnZhbHVlO2k/RShuKSYmTihuLGwpOkUobik/bi5pbmNsdWRlcyhsKXx8bi5wdXNoKGwpOnQ/KHVbYV09W2xdLGgoYSkmJihkW2FdPXVbYV0pKTooYS52YWx1ZT1bbF0sZS5rJiYodVtlLmtdPWEudmFsdWUpKX1lbHNlIHQ/KHVbYV09cyxoKGEpJiYoZFthXT1zKSk6ciYmKGEudmFsdWU9cyxlLmsmJih1W2Uua109cykpfTtzPyhvLmlkPS0xLHJNKG8sbikpOm8oKX19fWxldCBuQT0hMSxuRT0oKT0+e25BfHwoY29uc29sZS5lcnJvcigiSHlkcmF0aW9uIGNvbXBsZXRlZCBidXQgY29udGFpbnMgbWlzbWF0Y2hlcy4iKSxuQT0hMCl9LG5JPWU9PntpZigxPT09ZS5ub2RlVHlwZSl7aWYoZS5uYW1lc3BhY2VVUkkuaW5jbHVkZXMoInN2ZyIpJiYiZm9yZWlnbk9iamVjdCIhPT1lLnRhZ05hbWUpcmV0dXJuInN2ZyI7aWYoZS5uYW1lc3BhY2VVUkkuaW5jbHVkZXMoIk1hdGhNTCIpKXJldHVybiJtYXRobWwifX0sblI9ZT0+OD09PWUubm9kZVR5cGU7ZnVuY3Rpb24gbk8oZSl7bGV0e210OnQscDpuLG86e3BhdGNoUHJvcDpyLGNyZWF0ZVRleHQ6aSxuZXh0U2libGluZzpsLHBhcmVudE5vZGU6cyxyZW1vdmU6byxpbnNlcnQ6YSxjcmVhdGVDb21tZW50OmN9fT1lLHU9KG4scixvLGMsYixfPSExKT0+e189X3x8ISFyLmR5bmFtaWNDaGlsZHJlbjtsZXQgUz1uUihuKSYmIlsiPT09bi5kYXRhLHg9KCk9PmYobixyLG8sYyxiLFMpLHt0eXBlOkMscmVmOmssc2hhcGVGbGFnOlQscGF0Y2hGbGFnOk59PXIsdz1uLm5vZGVUeXBlO3IuZWw9biwtMj09PU4mJihfPSExLHIuZHluYW1pY0NoaWxkcmVuPW51bGwpO2xldCBBPW51bGw7c3dpdGNoKEMpe2Nhc2Ugcjc6MyE9PXc/IiI9PT1yLmNoaWxkcmVuPyhhKHIuZWw9aSgiIikscyhuKSxuKSxBPW4pOkE9eCgpOihuLmRhdGEhPT1yLmNoaWxkcmVuJiYobkUoKSxuLmRhdGE9ci5jaGlsZHJlbiksQT1sKG4pKTticmVhaztjYXNlIGllOnkobik/KEE9bChuKSxnKHIuZWw9bi5jb250ZW50LmZpcnN0Q2hpbGQsbixvKSk6QT04IT09d3x8Uz94KCk6bChuKTticmVhaztjYXNlIGl0OmlmKFMmJih3PShuPWwobikpLm5vZGVUeXBlKSwxPT09d3x8Mz09PXcpe0E9bjtsZXQgZT0hci5jaGlsZHJlbi5sZW5ndGg7Zm9yKGxldCB0PTA7dDxyLnN0YXRpY0NvdW50O3QrKyllJiYoci5jaGlsZHJlbis9MT09PUEubm9kZVR5cGU/QS5vdXRlckhUTUw6QS5kYXRhKSx0PT09ci5zdGF0aWNDb3VudC0xJiYoci5hbmNob3I9QSksQT1sKEEpO3JldHVybiBTP2woQSk6QX14KCk7YnJlYWs7Y2FzZSByOTpBPVM/aChuLHIsbyxjLGIsXyk6eCgpO2JyZWFrO2RlZmF1bHQ6aWYoMSZUKUE9MT09PXcmJnIudHlwZS50b0xvd2VyQ2FzZSgpPT09bi50YWdOYW1lLnRvTG93ZXJDYXNlKCl8fHkobik/ZChuLHIsbyxjLGIsXyk6eCgpO2Vsc2UgaWYoNiZUKXtyLnNsb3RTY29wZUlkcz1iO2xldCBlPXMobik7aWYoQT1TP20obik6blIobikmJiJ0ZWxlcG9ydCBzdGFydCI9PT1uLmRhdGE/bShuLG4uZGF0YSwidGVsZXBvcnQgZW5kIik6bChuKSx0KHIsZSxudWxsLG8sYyxuSShlKSxfKSxuRihyKSYmIXIudHlwZS5fX2FzeW5jUmVzb2x2ZWQpe2xldCB0O1M/KHQ9aXYocjkpKS5hbmNob3I9QT9BLnByZXZpb3VzU2libGluZzplLmxhc3RDaGlsZDp0PTM9PT1uLm5vZGVUeXBlP2lfKCIiKTppdigiZGl2IiksdC5lbD1uLHIuY29tcG9uZW50LnN1YlRyZWU9dH19ZWxzZSA2NCZUP0E9OCE9PXc/eCgpOnIudHlwZS5oeWRyYXRlKG4scixvLGMsYixfLGUscCk6MTI4JlQmJihBPXIudHlwZS5oeWRyYXRlKG4scixvLGMsbkkocyhuKSksYixfLGUsdSkpfXJldHVybiBudWxsIT1rJiZudyhrLG51bGwsYyxyKSxBfSxkPShlLHQsbixpLGwscyk9PntzPXN8fCEhdC5keW5hbWljQ2hpbGRyZW47bGV0e3R5cGU6YSxwcm9wczpjLHBhdGNoRmxhZzp1LHNoYXBlRmxhZzpkLGRpcnM6aCx0cmFuc2l0aW9uOmZ9PXQsbT0iaW5wdXQiPT09YXx8Im9wdGlvbiI9PT1hO2lmKG18fC0xIT09dSl7bGV0IGE7aCYmbmUodCxudWxsLG4sImNyZWF0ZWQiKTtsZXQgYj0hMTtpZih5KGUpKXtiPXJWKG51bGwsZikmJm4mJm4udm5vZGUucHJvcHMmJm4udm5vZGUucHJvcHMuYXBwZWFyO2xldCByPWUuY29udGVudC5maXJzdENoaWxkO2lmKGIpe2xldCBlPXIuZ2V0QXR0cmlidXRlKCJjbGFzcyIpO2UmJihyLiRjbHM9ZSksZi5iZWZvcmVFbnRlcihyKX1nKHIsZSxuKSx0LmVsPWU9cn1pZigxNiZkJiYhKGMmJihjLmlubmVySFRNTHx8Yy50ZXh0Q29udGVudCkpKXtsZXQgcj1wKGUuZmlyc3RDaGlsZCx0LGUsbixpLGwscyk7Zm9yKDtyOyl7bkwoZSwxKXx8bkUoKTtsZXQgdD1yO3I9ci5uZXh0U2libGluZyxvKHQpfX1lbHNlIGlmKDgmZCl7bGV0IG49dC5jaGlsZHJlbjtgDQpgPT09blswXSYmKCJQUkUiPT09ZS50YWdOYW1lfHwiVEVYVEFSRUEiPT09ZS50YWdOYW1lKSYmKG49bi5zbGljZSgxKSksZS50ZXh0Q29udGVudCE9PW4mJihuTChlLDApfHxuRSgpLGUudGV4dENvbnRlbnQ9dC5jaGlsZHJlbil9aWYoYyl7aWYobXx8IXN8fDQ4JnUpe2xldCB0PWUudGFnTmFtZS5pbmNsdWRlcygiLSIpO2ZvcihsZXQgaSBpbiBjKShtJiYoaS5lbmRzV2l0aCgidmFsdWUiKXx8ImluZGV0ZXJtaW5hdGUiPT09aSl8fEMoaSkmJiFqKGkpfHwiLiI9PT1pWzBdfHx0KSYmcihlLGksbnVsbCxjW2ldLHZvaWQgMCxuKX1lbHNlIGlmKGMub25DbGljaylyKGUsIm9uQ2xpY2siLG51bGwsYy5vbkNsaWNrLHZvaWQgMCxuKTtlbHNlIGlmKDQmdSYmdHYoYy5zdHlsZSkpZm9yKGxldCBlIGluIGMuc3R5bGUpYy5zdHlsZVtlXX0oYT1jJiZjLm9uVm5vZGVCZWZvcmVNb3VudCkmJmlUKGEsbix0KSxoJiZuZSh0LG51bGwsbiwiYmVmb3JlTW91bnQiKSwoKGE9YyYmYy5vblZub2RlTW91bnRlZCl8fGh8fGIpJiZyOCgoKT0+e2EmJmlUKGEsbix0KSxiJiZmLmVudGVyKGUpLGgmJm5lKHQsbnVsbCxuLCJtb3VudGVkIil9LGkpfXJldHVybiBlLm5leHRTaWJsaW5nfSxwPShlLHQscixzLG8sYyxkKT0+e2Q9ZHx8ISF0LmR5bmFtaWNDaGlsZHJlbjtsZXQgcD10LmNoaWxkcmVuLGg9cC5sZW5ndGg7Zm9yKGxldCB0PTA7dDxoO3QrKyl7bGV0IGY9ZD9wW3RdOnBbdF09aVMocFt0XSksbT1mLnR5cGU9PT1yNztlPyhtJiYhZCYmdCsxPGgmJmlTKHBbdCsxXSkudHlwZT09PXI3JiYoYShpKGUuZGF0YS5zbGljZShmLmNoaWxkcmVuLmxlbmd0aCkpLHIsbChlKSksZS5kYXRhPWYuY2hpbGRyZW4pLGU9dShlLGYscyxvLGMsZCkpOm0mJiFmLmNoaWxkcmVuP2EoZi5lbD1pKCIiKSxyKToobkwociwxKXx8bkUoKSxuKG51bGwsZixyLG51bGwscyxvLG5JKHIpLGMpKX1yZXR1cm4gZX0saD0oZSx0LG4scixpLG8pPT57bGV0e3Nsb3RTY29wZUlkczp1fT10O3UmJihpPWk/aS5jb25jYXQodSk6dSk7bGV0IGQ9cyhlKSxoPXAobChlKSx0LGQsbixyLGksbyk7cmV0dXJuIGgmJm5SKGgpJiYiXSI9PT1oLmRhdGE/bCh0LmFuY2hvcj1oKToobkUoKSxhKHQuYW5jaG9yPWMoIl0iKSxkLGgpLGgpfSxmPShlLHQscixpLGEsYyk9PntpZihuTChlLnBhcmVudEVsZW1lbnQsMSl8fG5FKCksdC5lbD1udWxsLGMpe2xldCB0PW0oZSk7Zm9yKDs7KXtsZXQgbj1sKGUpO2lmKG4mJm4hPT10KW8obik7ZWxzZSBicmVha319bGV0IHU9bChlKSxkPXMoZSk7cmV0dXJuIG8oZSksbihudWxsLHQsZCx1LHIsaSxuSShkKSxhKSxyJiYoci52bm9kZS5lbD10LmVsLHIwKHIsdC5lbCkpLHV9LG09KGUsdD0iWyIsbj0iXSIpPT57bGV0IHI9MDtmb3IoO2U7KWlmKChlPWwoZSkpJiZuUihlKSYmKGUuZGF0YT09PXQmJnIrKyxlLmRhdGE9PT1uKSlpZigwPT09cilyZXR1cm4gbChlKTtlbHNlIHItLTtyZXR1cm4gZX0sZz0oZSx0LG4pPT57bGV0IHI9dC5wYXJlbnROb2RlO3ImJnIucmVwbGFjZUNoaWxkKGUsdCk7bGV0IGk9bjtmb3IoO2k7KWkudm5vZGUuZWw9PT10JiYoaS52bm9kZS5lbD1pLnN1YlRyZWUuZWw9ZSksaT1pLnBhcmVudH0seT1lPT4xPT09ZS5ub2RlVHlwZSYmIlRFTVBMQVRFIj09PWUudGFnTmFtZTtyZXR1cm5bKGUsdCk9PntpZighdC5oYXNDaGlsZE5vZGVzKCkpe24obnVsbCxlLHQpLHQ2KCksdC5fdm5vZGU9ZTtyZXR1cm59dSh0LmZpcnN0Q2hpbGQsZSxudWxsLG51bGwsbnVsbCksdDYoKSx0Ll92bm9kZT1lfSx1XX1sZXQgblA9ImRhdGEtYWxsb3ctbWlzbWF0Y2giLG5NPXswOiJ0ZXh0IiwxOiJjaGlsZHJlbiIsMjoiY2xhc3MiLDM6InN0eWxlIiw0OiJhdHRyaWJ1dGUifTtmdW5jdGlvbiBuTChlLHQpe2lmKDA9PT10fHwxPT09dClmb3IoO2UmJiFlLmhhc0F0dHJpYnV0ZShuUCk7KWU9ZS5wYXJlbnRFbGVtZW50O2xldCBuPWUmJmUuZ2V0QXR0cmlidXRlKG5QKTtpZihudWxsPT1uKXJldHVybiExO3tpZigiIj09PW4pcmV0dXJuITA7bGV0IGU9bi5zcGxpdCgiLCIpO3JldHVybiEhKDA9PT10JiZlLmluY2x1ZGVzKCJjaGlsZHJlbiIpKXx8ZS5pbmNsdWRlcyhuTVt0XSl9fWxldCBuJD1lbigpLnJlcXVlc3RJZGxlQ2FsbGJhY2t8fChlPT5zZXRUaW1lb3V0KGUsMSkpLG5EPWVuKCkuY2FuY2VsSWRsZUNhbGxiYWNrfHwoZT0+Y2xlYXJUaW1lb3V0KGUpKSxuRj1lPT4hIWUudHlwZS5fX2FzeW5jTG9hZGVyO2Z1bmN0aW9uIG5WKGUsdCl7bGV0e3JlZjpuLHByb3BzOnIsY2hpbGRyZW46aSxjZTpsfT10LnZub2RlLHM9aXYoZSxyLGkpO3JldHVybiBzLnJlZj1uLHMuY2U9bCxkZWxldGUgdC52bm9kZS5jZSxzfWxldCBuQj1lPT5lLnR5cGUuX19pc0tlZXBBbGl2ZTtmdW5jdGlvbiBuVShlLHQpe3JldHVybiBFKGUpP2Uuc29tZShlPT5uVShlLHQpKTpNKGUpP2Uuc3BsaXQoIiwiKS5pbmNsdWRlcyh0KToiW29iamVjdCBSZWdFeHBdIj09PVYoZSkmJihlLmxhc3RJbmRleD0wLGUudGVzdCh0KSl9ZnVuY3Rpb24gbmooZSx0KXtucShlLCJhIix0KX1mdW5jdGlvbiBuSChlLHQpe25xKGUsImRhIix0KX1mdW5jdGlvbiBucShlLHQsbj1pQSl7bGV0IHI9ZS5fX3dkY3x8KGUuX193ZGM9KCk9PntsZXQgdD1uO2Zvcig7dDspe2lmKHQuaXNEZWFjdGl2YXRlZClyZXR1cm47dD10LnBhcmVudH1yZXR1cm4gZSgpfSk7aWYobnoodCxyLG4pLG4pe2xldCBlPW4ucGFyZW50O2Zvcig7ZSYmZS5wYXJlbnQ7KW5CKGUucGFyZW50LnZub2RlKSYmZnVuY3Rpb24oZSx0LG4scil7bGV0IGk9bnoodCxlLHIsITApO24wKCgpPT57TihyW3RdLGkpfSxuKX0ocix0LG4sZSksZT1lLnBhcmVudH19ZnVuY3Rpb24gblcoZSl7ZS5zaGFwZUZsYWcmPS0yNTcsZS5zaGFwZUZsYWcmPS01MTN9ZnVuY3Rpb24gbksoZSl7cmV0dXJuIDEyOCZlLnNoYXBlRmxhZz9lLnNzQ29udGVudDplfWZ1bmN0aW9uIG56KGUsdCxuPWlBLHI9ITEpe2lmKG4pe2xldCBpPW5bZV18fChuW2VdPVtdKSxsPXQuX193ZWh8fCh0Ll9fd2VoPSguLi5yKT0+e2VNKCk7bGV0IGk9aUkobiksbD10cSh0LG4sZSxyKTtyZXR1cm4gaSgpLGVMKCksbH0pO3JldHVybiByP2kudW5zaGlmdChsKTppLnB1c2gobCksbH19bGV0IG5KPWU9Pih0LG49aUEpPT57aVAmJiJzcCIhPT1lfHxueihlLCguLi5lKT0+dCguLi5lKSxuKX0sbkc9bkooImJtIiksblg9bkooIm0iKSxuUT1uSigiYnUiKSxuWj1uSigidSIpLG5ZPW5KKCJidW0iKSxuMD1uSigidW0iKSxuMT1uSigic3AiKSxuMj1uSigicnRnIiksbjM9bkooInJ0YyIpO2Z1bmN0aW9uIG42KGUsdD1pQSl7bnooImVjIixlLHQpfWxldCBuND0iY29tcG9uZW50cyIsbjg9U3ltYm9sLmZvcigidi1uZGMiKTtmdW5jdGlvbiBuNShlLHQsbj0hMCxyPSExKXtsZXQgaT10OHx8aUE7aWYoaSl7bGV0IG49aS50eXBlO2lmKGU9PT1uNCl7bGV0IGU9aUIobiwhMSk7aWYoZSYmKGU9PT10fHxlPT09Syh0KXx8ZT09PUcoSyh0KSkpKXJldHVybiBufWxldCBsPW45KGlbZV18fG5bZV0sdCl8fG45KGkuYXBwQ29udGV4dFtlXSx0KTtyZXR1cm4hbCYmcj9uOmx9fWZ1bmN0aW9uIG45KGUsdCl7cmV0dXJuIGUmJihlW3RdfHxlW0sodCldfHxlW0coSyh0KSldKX1sZXQgbjc9ZT0+ZT9pTyhlKT9pVihlKTpuNyhlLnBhcmVudCk6bnVsbCxyZT1UKE9iamVjdC5jcmVhdGUobnVsbCkseyQ6ZT0+ZSwkZWw6ZT0+ZS52bm9kZS5lbCwkZGF0YTplPT5lLmRhdGEsJHByb3BzOmU9PmUucHJvcHMsJGF0dHJzOmU9PmUuYXR0cnMsJHNsb3RzOmU9PmUuc2xvdHMsJHJlZnM6ZT0+ZS5yZWZzLCRwYXJlbnQ6ZT0+bjcoZS5wYXJlbnQpLCRyb290OmU9Pm43KGUucm9vdCksJGhvc3Q6ZT0+ZS5jZSwkZW1pdDplPT5lLmVtaXQsJG9wdGlvbnM6ZT0+cmEoZSksJGZvcmNlVXBkYXRlOmU9PmUuZnx8KGUuZj0oKT0+e3QwKGUudXBkYXRlKX0pLCRuZXh0VGljazplPT5lLm58fChlLm49dFkuYmluZChlLnByb3h5KSksJHdhdGNoOmU9PnJXLmJpbmQoZSl9KSxydD0oZSx0KT0+ZSE9PWImJiFlLl9faXNTY3JpcHRTZXR1cCYmQShlLHQpLHJuPXtnZXQoe186ZX0sdCl7bGV0IG4scixpO2lmKCJfX3Zfc2tpcCI9PT10KXJldHVybiEwO2xldHtjdHg6bCxzZXR1cFN0YXRlOnMsZGF0YTpvLHByb3BzOmEsYWNjZXNzQ2FjaGU6Yyx0eXBlOnUsYXBwQ29udGV4dDpkfT1lO2lmKCIkIiE9PXRbMF0pe2xldCByPWNbdF07aWYodm9pZCAwIT09cilzd2l0Y2gocil7Y2FzZSAxOnJldHVybiBzW3RdO2Nhc2UgMjpyZXR1cm4gb1t0XTtjYXNlIDQ6cmV0dXJuIGxbdF07Y2FzZSAzOnJldHVybiBhW3RdfWVsc2V7aWYocnQocyx0KSlyZXR1cm4gY1t0XT0xLHNbdF07aWYobyE9PWImJkEobyx0KSlyZXR1cm4gY1t0XT0yLG9bdF07aWYoKG49ZS5wcm9wc09wdGlvbnNbMF0pJiZBKG4sdCkpcmV0dXJuIGNbdF09MyxhW3RdO2lmKGwhPT1iJiZBKGwsdCkpcmV0dXJuIGNbdF09NCxsW3RdO3JzJiYoY1t0XT0wKX19bGV0IHA9cmVbdF07cmV0dXJuIHA/KCIkYXR0cnMiPT09dCYmZXEoZS5hdHRycywiZ2V0IiwiIikscChlKSk6KHI9dS5fX2Nzc01vZHVsZXMpJiYocj1yW3RdKT9yOmwhPT1iJiZBKGwsdCk/KGNbdF09NCxsW3RdKTpBKGk9ZC5jb25maWcuZ2xvYmFsUHJvcGVydGllcyx0KT9pW3RdOnZvaWQgMH0sc2V0KHtfOmV9LHQsbil7bGV0e2RhdGE6cixzZXR1cFN0YXRlOmksY3R4Omx9PWU7cmV0dXJuIHJ0KGksdCk/KGlbdF09biwhMCk6ciE9PWImJkEocix0KT8oclt0XT1uLCEwKTohQShlLnByb3BzLHQpJiYhKCIkIj09PXRbMF0mJnQuc2xpY2UoMSlpbiBlKSYmKGxbdF09biwhMCl9LGhhcyh7Xzp7ZGF0YTplLHNldHVwU3RhdGU6dCxhY2Nlc3NDYWNoZTpuLGN0eDpyLGFwcENvbnRleHQ6aSxwcm9wc09wdGlvbnM6bH19LHMpe2xldCBvO3JldHVybiEhbltzXXx8ZSE9PWImJkEoZSxzKXx8cnQodCxzKXx8KG89bFswXSkmJkEobyxzKXx8QShyLHMpfHxBKHJlLHMpfHxBKGkuY29uZmlnLmdsb2JhbFByb3BlcnRpZXMscyl9LGRlZmluZVByb3BlcnR5KGUsdCxuKXtyZXR1cm4gbnVsbCE9bi5nZXQ/ZS5fLmFjY2Vzc0NhY2hlW3RdPTA6QShuLCJ2YWx1ZSIpJiZ0aGlzLnNldChlLHQsbi52YWx1ZSxudWxsKSxSZWZsZWN0LmRlZmluZVByb3BlcnR5KGUsdCxuKX19LHJyPVQoe30scm4se2dldChlLHQpe2lmKHQhPT1TeW1ib2wudW5zY29wYWJsZXMpcmV0dXJuIHJuLmdldChlLHQsZSl9LGhhczooZSx0KT0+Il8iIT09dFswXSYmIWVyKHQpfSk7ZnVuY3Rpb24gcmkoKXtsZXQgZT1pRSgpO3JldHVybiBlLnNldHVwQ29udGV4dHx8KGUuc2V0dXBDb250ZXh0PWlGKGUpKX1mdW5jdGlvbiBybChlKXtyZXR1cm4gRShlKT9lLnJlZHVjZSgoZSx0KT0+KGVbdF09bnVsbCxlKSx7fSk6ZX1sZXQgcnM9ITA7ZnVuY3Rpb24gcm8oZSx0LG4pe3RxKEUoZSk/ZS5tYXAoZT0+ZS5iaW5kKHQucHJveHkpKTplLmJpbmQodC5wcm94eSksdCxuKX1mdW5jdGlvbiByYShlKXtsZXQgdCxuPWUudHlwZSx7bWl4aW5zOnIsZXh0ZW5kczppfT1uLHttaXhpbnM6bCxvcHRpb25zQ2FjaGU6cyxjb25maWc6e29wdGlvbk1lcmdlU3RyYXRlZ2llczpvfX09ZS5hcHBDb250ZXh0LGE9cy5nZXQobik7cmV0dXJuIGE/dD1hOmwubGVuZ3RofHxyfHxpPyh0PXt9LGwubGVuZ3RoJiZsLmZvckVhY2goZT0+cmModCxlLG8sITApKSxyYyh0LG4sbykpOnQ9biwkKG4pJiZzLnNldChuLHQpLHR9ZnVuY3Rpb24gcmMoZSx0LG4scj0hMSl7bGV0e21peGluczppLGV4dGVuZHM6bH09dDtmb3IobGV0IHMgaW4gbCYmcmMoZSxsLG4sITApLGkmJmkuZm9yRWFjaCh0PT5yYyhlLHQsbiwhMCkpLHQpaWYociYmImV4cG9zZSI9PT1zKTtlbHNle2xldCByPXJ1W3NdfHxuJiZuW3NdO2Vbc109cj9yKGVbc10sdFtzXSk6dFtzXX1yZXR1cm4gZX1sZXQgcnU9e2RhdGE6cmQscHJvcHM6cm0sZW1pdHM6cm0sbWV0aG9kczpyZixjb21wdXRlZDpyZixiZWZvcmVDcmVhdGU6cmgsY3JlYXRlZDpyaCxiZWZvcmVNb3VudDpyaCxtb3VudGVkOnJoLGJlZm9yZVVwZGF0ZTpyaCx1cGRhdGVkOnJoLGJlZm9yZURlc3Ryb3k6cmgsYmVmb3JlVW5tb3VudDpyaCxkZXN0cm95ZWQ6cmgsdW5tb3VudGVkOnJoLGFjdGl2YXRlZDpyaCxkZWFjdGl2YXRlZDpyaCxlcnJvckNhcHR1cmVkOnJoLHNlcnZlclByZWZldGNoOnJoLGNvbXBvbmVudHM6cmYsZGlyZWN0aXZlczpyZix3YXRjaDpmdW5jdGlvbihlLHQpe2lmKCFlKXJldHVybiB0O2lmKCF0KXJldHVybiBlO2xldCBuPVQoT2JqZWN0LmNyZWF0ZShudWxsKSxlKTtmb3IobGV0IHIgaW4gdCluW3JdPXJoKGVbcl0sdFtyXSk7cmV0dXJuIG59LHByb3ZpZGU6cmQsaW5qZWN0OmZ1bmN0aW9uKGUsdCl7cmV0dXJuIHJmKHJwKGUpLHJwKHQpKX19O2Z1bmN0aW9uIHJkKGUsdCl7cmV0dXJuIHQ/ZT9mdW5jdGlvbigpe3JldHVybiBUKFAoZSk/ZS5jYWxsKHRoaXMsdGhpcyk6ZSxQKHQpP3QuY2FsbCh0aGlzLHRoaXMpOnQpfTp0OmV9ZnVuY3Rpb24gcnAoZSl7aWYoRShlKSl7bGV0IHQ9e307Zm9yKGxldCBuPTA7bjxlLmxlbmd0aDtuKyspdFtlW25dXT1lW25dO3JldHVybiB0fXJldHVybiBlfWZ1bmN0aW9uIHJoKGUsdCl7cmV0dXJuIGU/Wy4uLm5ldyBTZXQoW10uY29uY2F0KGUsdCkpXTp0fWZ1bmN0aW9uIHJmKGUsdCl7cmV0dXJuIGU/VChPYmplY3QuY3JlYXRlKG51bGwpLGUsdCk6dH1mdW5jdGlvbiBybShlLHQpe3JldHVybiBlP0UoZSkmJkUodCk/Wy4uLm5ldyBTZXQoWy4uLmUsLi4udF0pXTpUKE9iamVjdC5jcmVhdGUobnVsbCkscmwoZSkscmwobnVsbCE9dD90Ont9KSk6dH1mdW5jdGlvbiByZygpe3JldHVybnthcHA6bnVsbCxjb25maWc6e2lzTmF0aXZlVGFnOngscGVyZm9ybWFuY2U6ITEsZ2xvYmFsUHJvcGVydGllczp7fSxvcHRpb25NZXJnZVN0cmF0ZWdpZXM6e30sZXJyb3JIYW5kbGVyOnZvaWQgMCx3YXJuSGFuZGxlcjp2b2lkIDAsY29tcGlsZXJPcHRpb25zOnt9fSxtaXhpbnM6W10sY29tcG9uZW50czp7fSxkaXJlY3RpdmVzOnt9LHByb3ZpZGVzOk9iamVjdC5jcmVhdGUobnVsbCksb3B0aW9uc0NhY2hlOm5ldyBXZWFrTWFwLHByb3BzQ2FjaGU6bmV3IFdlYWtNYXAsZW1pdHNDYWNoZTpuZXcgV2Vha01hcH19bGV0IHJ2PTAscnk9bnVsbDtmdW5jdGlvbiByYihlLHQpe2lmKGlBKXtsZXQgbj1pQS5wcm92aWRlcyxyPWlBLnBhcmVudCYmaUEucGFyZW50LnByb3ZpZGVzO3I9PT1uJiYobj1pQS5wcm92aWRlcz1PYmplY3QuY3JlYXRlKHIpKSxuW2VdPXR9fWZ1bmN0aW9uIHJfKGUsdCxuPSExKXtsZXQgcj1pQXx8dDg7aWYocnx8cnkpe2xldCBpPXJ5P3J5Ll9jb250ZXh0LnByb3ZpZGVzOnI/bnVsbD09ci5wYXJlbnR8fHIuY2U/ci52bm9kZS5hcHBDb250ZXh0JiZyLnZub2RlLmFwcENvbnRleHQucHJvdmlkZXM6ci5wYXJlbnQucHJvdmlkZXM6dm9pZCAwO2lmKGkmJmUgaW4gaSlyZXR1cm4gaVtlXTtpZihhcmd1bWVudHMubGVuZ3RoPjEpcmV0dXJuIG4mJlAodCk/dC5jYWxsKHImJnIucHJveHkpOnR9fWxldCByUz17fSxyeD0oKT0+T2JqZWN0LmNyZWF0ZShyUyksckM9ZT0+T2JqZWN0LmdldFByb3RvdHlwZU9mKGUpPT09clM7ZnVuY3Rpb24gcmsoZSx0LG4scil7bGV0IGksW2wsc109ZS5wcm9wc09wdGlvbnMsbz0hMTtpZih0KWZvcihsZXQgYSBpbiB0KXtsZXQgYztpZihqKGEpKWNvbnRpbnVlO2xldCB1PXRbYV07bCYmQShsLGM9SyhhKSk/cyYmcy5pbmNsdWRlcyhjKT8oaXx8KGk9e30pKVtjXT11Om5bY109dTpyRyhlLmVtaXRzT3B0aW9ucyxhKXx8YSBpbiByJiZ1PT09clthXXx8KHJbYV09dSxvPSEwKX1pZihzKXtsZXQgdD10UyhuKSxyPWl8fGI7Zm9yKGxldCBpPTA7aTxzLmxlbmd0aDtpKyspe2xldCBvPXNbaV07bltvXT1yVChsLHQsbyxyW29dLGUsIUEocixvKSl9fXJldHVybiBvfWZ1bmN0aW9uIHJUKGUsdCxuLHIsaSxsKXtsZXQgcz1lW25dO2lmKG51bGwhPXMpe2xldCBlPUEocywiZGVmYXVsdCIpO2lmKGUmJnZvaWQgMD09PXIpe2xldCBlPXMuZGVmYXVsdDtpZihzLnR5cGUhPT1GdW5jdGlvbiYmIXMuc2tpcEZhY3RvcnkmJlAoZSkpe2xldHtwcm9wc0RlZmF1bHRzOmx9PWk7aWYobiBpbiBsKXI9bFtuXTtlbHNle2xldCBzPWlJKGkpO3I9bFtuXT1lLmNhbGwobnVsbCx0KSxzKCl9fWVsc2Ugcj1lO2kuY2UmJmkuY2UuX3NldFByb3AobixyKX1zWzBdJiYobCYmIWU/cj0hMTpzWzFdJiYoIiI9PT1yfHxyPT09SihuKSkmJihyPSEwKSl9cmV0dXJuIHJ9bGV0IHJOPW5ldyBXZWFrTWFwO2Z1bmN0aW9uIHJ3KGUpe3JldHVybiEoIiQiPT09ZVswXXx8aihlKSl9bGV0IHJBPWU9PiJfIj09PWVbMF18fCIkc3RhYmxlIj09PWUsckU9ZT0+RShlKT9lLm1hcChpUyk6W2lTKGUpXSxyST0oZSx0LG4pPT57aWYodC5fbilyZXR1cm4gdDtsZXQgcj10NygoLi4uZSk9PnJFKHQoLi4uZSkpLG4pO3JldHVybiByLl9jPSExLHJ9LHJSPShlLHQsbik9PntsZXQgcj1lLl9jdHg7Zm9yKGxldCBuIGluIGUpe2lmKHJBKG4pKWNvbnRpbnVlO2xldCBpPWVbbl07aWYoUChpKSl0W25dPXJJKG4saSxyKTtlbHNlIGlmKG51bGwhPWkpe2xldCBlPXJFKGkpO3Rbbl09KCk9PmV9fX0sck89KGUsdCk9PntsZXQgbj1yRSh0KTtlLnNsb3RzLmRlZmF1bHQ9KCk9Pm59LHJQPShlLHQsbik9Pntmb3IobGV0IHIgaW4gdCkobnx8IXJBKHIpKSYmKGVbcl09dFtyXSl9LHJNPXI4O2Z1bmN0aW9uIHJMKGUpe3JldHVybiByJChlLG5PKX1mdW5jdGlvbiByJChlLHQpe3ZhciBuO2xldCByLGk7ZW4oKS5fX1ZVRV9fPSEwO2xldHtpbnNlcnQ6bCxyZW1vdmU6cyxwYXRjaFByb3A6byxjcmVhdGVFbGVtZW50OmEsY3JlYXRlVGV4dDpjLGNyZWF0ZUNvbW1lbnQ6ZCxzZXRUZXh0OnAsc2V0RWxlbWVudFRleHQ6aCxwYXJlbnROb2RlOmYsbmV4dFNpYmxpbmc6bSxzZXRTY29wZUlkOmc9UyxpbnNlcnRTdGF0aWNDb250ZW50Onl9PWUseD0oZSx0LG4scj1udWxsLGk9bnVsbCxsPW51bGwscyxvPW51bGwsYT0hIXQuZHluYW1pY0NoaWxkcmVuKT0+e2lmKGU9PT10KXJldHVybjtlJiYhaXAoZSx0KSYmKHI9ZXMoZSksZWUoZSxpLGwsITApLGU9bnVsbCksLTI9PT10LnBhdGNoRmxhZyYmKGE9ITEsdC5keW5hbWljQ2hpbGRyZW49bnVsbCk7bGV0e3R5cGU6YyxyZWY6dSxzaGFwZUZsYWc6ZH09dDtzd2l0Y2goYyl7Y2FzZSByNzpDKGUsdCxuLHIpO2JyZWFrO2Nhc2UgaWU6ayhlLHQsbixyKTticmVhaztjYXNlIGl0Om51bGw9PWUmJk4odCxuLHIscyk7YnJlYWs7Y2FzZSByOTpWKGUsdCxuLHIsaSxsLHMsbyxhKTticmVhaztkZWZhdWx0OjEmZD93KGUsdCxuLHIsaSxsLHMsbyxhKTo2JmQ/QihlLHQsbixyLGksbCxzLG8sYSk6NjQmZD9jLnByb2Nlc3MoZSx0LG4scixpLGwscyxvLGEsZWMpOjEyOCZkJiZjLnByb2Nlc3MoZSx0LG4scixpLGwscyxvLGEsZWMpfW51bGwhPXUmJmk/bncodSxlJiZlLnJlZixsLHR8fGUsIXQpOm51bGw9PXUmJmUmJm51bGwhPWUucmVmJiZudyhlLnJlZixudWxsLGwsZSwhMCl9LEM9KGUsdCxuLHIpPT57aWYobnVsbD09ZSlsKHQuZWw9Yyh0LmNoaWxkcmVuKSxuLHIpO2Vsc2V7bGV0IG49dC5lbD1lLmVsO3QuY2hpbGRyZW4hPT1lLmNoaWxkcmVuJiZwKG4sdC5jaGlsZHJlbil9fSxrPShlLHQsbixyKT0+e251bGw9PWU/bCh0LmVsPWQodC5jaGlsZHJlbnx8IiIpLG4scik6dC5lbD1lLmVsfSxOPShlLHQsbixyKT0+e1tlLmVsLGUuYW5jaG9yXT15KGUuY2hpbGRyZW4sdCxuLHIsZS5lbCxlLmFuY2hvcil9LHc9KGUsdCxuLHIsaSxsLHMsbyxhKT0+eyJzdmciPT09dC50eXBlP3M9InN2ZyI6Im1hdGgiPT09dC50eXBlJiYocz0ibWF0aG1sIiksbnVsbD09ZT9JKHQsbixyLGksbCxzLG8sYSk6TShlLHQsaSxsLHMsbyxhKX0sST0oZSx0LG4scixpLHMsYyx1KT0+e2xldCBkLHAse3Byb3BzOmYsc2hhcGVGbGFnOm0sdHJhbnNpdGlvbjpnLGRpcnM6eX09ZTtpZihkPWUuZWw9YShlLnR5cGUscyxmJiZmLmlzLGYpLDgmbT9oKGQsZS5jaGlsZHJlbik6MTYmbSYmTyhlLmNoaWxkcmVuLGQsbnVsbCxyLGksckQoZSxzKSxjLHUpLHkmJm5lKGUsbnVsbCxyLCJjcmVhdGVkIiksUihkLGUsZS5zY29wZUlkLGMsciksZil7Zm9yKGxldCBlIGluIGYpInZhbHVlIj09PWV8fGooZSl8fG8oZCxlLG51bGwsZltlXSxzLHIpOyJ2YWx1ZSJpbiBmJiZvKGQsInZhbHVlIixudWxsLGYudmFsdWUscyksKHA9Zi5vblZub2RlQmVmb3JlTW91bnQpJiZpVChwLHIsZSl9eSYmbmUoZSxudWxsLHIsImJlZm9yZU1vdW50Iik7bGV0IGI9clYoaSxnKTtiJiZnLmJlZm9yZUVudGVyKGQpLGwoZCx0LG4pLCgocD1mJiZmLm9uVm5vZGVNb3VudGVkKXx8Ynx8eSkmJnJNKCgpPT57cCYmaVQocCxyLGUpLGImJmcuZW50ZXIoZCkseSYmbmUoZSxudWxsLHIsIm1vdW50ZWQiKX0saSl9LFI9KGUsdCxuLHIsaSk9PntpZihuJiZnKGUsbikscilmb3IobGV0IHQ9MDt0PHIubGVuZ3RoO3QrKylnKGUsclt0XSk7aWYoaSl7bGV0IG49aS5zdWJUcmVlO2lmKHQ9PT1ufHxyMShuLnR5cGUpJiYobi5zc0NvbnRlbnQ9PT10fHxuLnNzRmFsbGJhY2s9PT10KSl7bGV0IHQ9aS52bm9kZTtSKGUsdCx0LnNjb3BlSWQsdC5zbG90U2NvcGVJZHMsaS5wYXJlbnQpfX19LE89KGUsdCxuLHIsaSxsLHMsbyxhPTApPT57Zm9yKGxldCBjPWE7YzxlLmxlbmd0aDtjKyspeChudWxsLGVbY109bz9peChlW2NdKTppUyhlW2NdKSx0LG4scixpLGwscyxvKX0sTT0oZSx0LG4scixpLGwscyk9PntsZXQgYSxjPXQuZWw9ZS5lbCx7cGF0Y2hGbGFnOnUsZHluYW1pY0NoaWxkcmVuOmQsZGlyczpwfT10O3V8PTE2JmUucGF0Y2hGbGFnO2xldCBmPWUucHJvcHN8fGIsbT10LnByb3BzfHxiO2lmKG4mJnJGKG4sITEpLChhPW0ub25Wbm9kZUJlZm9yZVVwZGF0ZSkmJmlUKGEsbix0LGUpLHAmJm5lKHQsZSxuLCJiZWZvcmVVcGRhdGUiKSxuJiZyRihuLCEwKSwoZi5pbm5lckhUTUwmJm51bGw9PW0uaW5uZXJIVE1MfHxmLnRleHRDb250ZW50JiZudWxsPT1tLnRleHRDb250ZW50KSYmaChjLCIiKSxkP0woZS5keW5hbWljQ2hpbGRyZW4sZCxjLG4scixyRCh0LGkpLGwpOnN8fHooZSx0LGMsbnVsbCxuLHIsckQodCxpKSxsLCExKSx1PjApe2lmKDE2JnUpRihjLGYsbSxuLGkpO2Vsc2UgaWYoMiZ1JiZmLmNsYXNzIT09bS5jbGFzcyYmbyhjLCJjbGFzcyIsbnVsbCxtLmNsYXNzLGkpLDQmdSYmbyhjLCJzdHlsZSIsZi5zdHlsZSxtLnN0eWxlLGkpLDgmdSl7bGV0IGU9dC5keW5hbWljUHJvcHM7Zm9yKGxldCB0PTA7dDxlLmxlbmd0aDt0Kyspe2xldCByPWVbdF0sbD1mW3JdLHM9bVtyXTsocyE9PWx8fCJ2YWx1ZSI9PT1yKSYmbyhjLHIsbCxzLGksbil9fTEmdSYmZS5jaGlsZHJlbiE9PXQuY2hpbGRyZW4mJmgoYyx0LmNoaWxkcmVuKX1lbHNlIHN8fG51bGwhPWR8fEYoYyxmLG0sbixpKTsoKGE9bS5vblZub2RlVXBkYXRlZCl8fHApJiZyTSgoKT0+e2EmJmlUKGEsbix0LGUpLHAmJm5lKHQsZSxuLCJ1cGRhdGVkIil9LHIpfSxMPShlLHQsbixyLGksbCxzKT0+e2ZvcihsZXQgbz0wO288dC5sZW5ndGg7bysrKXtsZXQgYT1lW29dLGM9dFtvXSx1PWEuZWwmJihhLnR5cGU9PT1yOXx8IWlwKGEsYyl8fDE5OCZhLnNoYXBlRmxhZyk/ZihhLmVsKTpuO3goYSxjLHUsbnVsbCxyLGksbCxzLCEwKX19LEY9KGUsdCxuLHIsaSk9PntpZih0IT09bil7aWYodCE9PWIpZm9yKGxldCBsIGluIHQpaihsKXx8bCBpbiBufHxvKGUsbCx0W2xdLG51bGwsaSxyKTtmb3IobGV0IGwgaW4gbil7aWYoaihsKSljb250aW51ZTtsZXQgcz1uW2xdLGE9dFtsXTtzIT09YSYmInZhbHVlIiE9PWwmJm8oZSxsLGEscyxpLHIpfSJ2YWx1ZSJpbiBuJiZvKGUsInZhbHVlIix0LnZhbHVlLG4udmFsdWUsaSl9fSxWPShlLHQsbixyLGkscyxvLGEsdSk9PntsZXQgZD10LmVsPWU/ZS5lbDpjKCIiKSxwPXQuYW5jaG9yPWU/ZS5hbmNob3I6YygiIikse3BhdGNoRmxhZzpoLGR5bmFtaWNDaGlsZHJlbjpmLHNsb3RTY29wZUlkczptfT10O20mJihhPWE/YS5jb25jYXQobSk6bSksbnVsbD09ZT8obChkLG4sciksbChwLG4sciksTyh0LmNoaWxkcmVufHxbXSxuLHAsaSxzLG8sYSx1KSk6aD4wJiY2NCZoJiZmJiZlLmR5bmFtaWNDaGlsZHJlbj8oTChlLmR5bmFtaWNDaGlsZHJlbixmLG4saSxzLG8sYSksKG51bGwhPXQua2V5fHxpJiZ0PT09aS5zdWJUcmVlKSYmckIoZSx0LCEwKSk6eihlLHQsbixwLGkscyxvLGEsdSl9LEI9KGUsdCxuLHIsaSxsLHMsbyxhKT0+e3Quc2xvdFNjb3BlSWRzPW8sbnVsbD09ZT81MTImdC5zaGFwZUZsYWc/aS5jdHguYWN0aXZhdGUodCxuLHIscyxhKTpVKHQsbixyLGksbCxzLGEpOkgoZSx0LGEpfSxVPShlLHQsbixyLGksbCxzKT0+e2xldCBvPWUuY29tcG9uZW50PWZ1bmN0aW9uKGUsdCxuKXtsZXQgcj1lLnR5cGUsaT0odD90LmFwcENvbnRleHQ6ZS5hcHBDb250ZXh0KXx8aU4sbD17dWlkOml3Kyssdm5vZGU6ZSx0eXBlOnIscGFyZW50OnQsYXBwQ29udGV4dDppLHJvb3Q6bnVsbCxuZXh0Om51bGwsc3ViVHJlZTpudWxsLGVmZmVjdDpudWxsLHVwZGF0ZTpudWxsLGpvYjpudWxsLHNjb3BlOm5ldyBlUyghMCkscmVuZGVyOm51bGwscHJveHk6bnVsbCxleHBvc2VkOm51bGwsZXhwb3NlUHJveHk6bnVsbCx3aXRoUHJveHk6bnVsbCxwcm92aWRlczp0P3QucHJvdmlkZXM6T2JqZWN0LmNyZWF0ZShpLnByb3ZpZGVzKSxpZHM6dD90LmlkczpbIiIsMCwwXSxhY2Nlc3NDYWNoZTpudWxsLHJlbmRlckNhY2hlOltdLGNvbXBvbmVudHM6bnVsbCxkaXJlY3RpdmVzOm51bGwscHJvcHNPcHRpb25zOmZ1bmN0aW9uIGUodCxuLHI9ITEpe2xldCBpPXI/ck46bi5wcm9wc0NhY2hlLGw9aS5nZXQodCk7aWYobClyZXR1cm4gbDtsZXQgcz10LnByb3BzLG89e30sYT1bXSxjPSExO2lmKCFQKHQpKXtsZXQgaT10PT57Yz0hMDtsZXRbcixpXT1lKHQsbiwhMCk7VChvLHIpLGkmJmEucHVzaCguLi5pKX07IXImJm4ubWl4aW5zLmxlbmd0aCYmbi5taXhpbnMuZm9yRWFjaChpKSx0LmV4dGVuZHMmJmkodC5leHRlbmRzKSx0Lm1peGlucyYmdC5taXhpbnMuZm9yRWFjaChpKX1pZighcyYmIWMpcmV0dXJuICQodCkmJmkuc2V0KHQsXyksXztpZihFKHMpKWZvcihsZXQgZT0wO2U8cy5sZW5ndGg7ZSsrKXtsZXQgdD1LKHNbZV0pO3J3KHQpJiYob1t0XT1iKX1lbHNlIGlmKHMpZm9yKGxldCBlIGluIHMpe2xldCB0PUsoZSk7aWYocncodCkpe2xldCBuPXNbZV0scj1vW3RdPUUobil8fFAobik/e3R5cGU6bn06VCh7fSxuKSxpPXIudHlwZSxsPSExLGM9ITA7aWYoRShpKSlmb3IobGV0IGU9MDtlPGkubGVuZ3RoOysrZSl7bGV0IHQ9aVtlXSxuPVAodCkmJnQubmFtZTtpZigiQm9vbGVhbiI9PT1uKXtsPSEwO2JyZWFrfSJTdHJpbmciPT09biYmKGM9ITEpfWVsc2UgbD1QKGkpJiYiQm9vbGVhbiI9PT1pLm5hbWU7clswXT1sLHJbMV09YywobHx8QShyLCJkZWZhdWx0IikpJiZhLnB1c2godCl9fWxldCB1PVtvLGFdO3JldHVybiAkKHQpJiZpLnNldCh0LHUpLHV9KHIsaSksZW1pdHNPcHRpb25zOmZ1bmN0aW9uIGUodCxuLHI9ITEpe2xldCBpPW4uZW1pdHNDYWNoZSxsPWkuZ2V0KHQpO2lmKHZvaWQgMCE9PWwpcmV0dXJuIGw7bGV0IHM9dC5lbWl0cyxvPXt9LGE9ITE7aWYoIVAodCkpe2xldCBpPXQ9PntsZXQgcj1lKHQsbiwhMCk7ciYmKGE9ITAsVChvLHIpKX07IXImJm4ubWl4aW5zLmxlbmd0aCYmbi5taXhpbnMuZm9yRWFjaChpKSx0LmV4dGVuZHMmJmkodC5leHRlbmRzKSx0Lm1peGlucyYmdC5taXhpbnMuZm9yRWFjaChpKX1yZXR1cm4gc3x8YT8oRShzKT9zLmZvckVhY2goZT0+b1tlXT1udWxsKTpUKG8scyksJCh0KSYmaS5zZXQodCxvKSxvKTooJCh0KSYmaS5zZXQodCxudWxsKSxudWxsKX0ocixpKSxlbWl0Om51bGwsZW1pdHRlZDpudWxsLHByb3BzRGVmYXVsdHM6Yixpbmhlcml0QXR0cnM6ci5pbmhlcml0QXR0cnMsY3R4OmIsZGF0YTpiLHByb3BzOmIsYXR0cnM6YixzbG90czpiLHJlZnM6YixzZXR1cFN0YXRlOmIsc2V0dXBDb250ZXh0Om51bGwsc3VzcGVuc2U6bixzdXNwZW5zZUlkOm4/bi5wZW5kaW5nSWQ6MCxhc3luY0RlcDpudWxsLGFzeW5jUmVzb2x2ZWQ6ITEsaXNNb3VudGVkOiExLGlzVW5tb3VudGVkOiExLGlzRGVhY3RpdmF0ZWQ6ITEsYmM6bnVsbCxjOm51bGwsYm06bnVsbCxtOm51bGwsYnU6bnVsbCx1Om51bGwsdW06bnVsbCxidW06bnVsbCxkYTpudWxsLGE6bnVsbCxydGc6bnVsbCxydGM6bnVsbCxlYzpudWxsLHNwOm51bGx9O3JldHVybiBsLmN0eD17XzpsfSxsLnJvb3Q9dD90LnJvb3Q6bCxsLmVtaXQ9ckouYmluZChudWxsLGwpLGUuY2UmJmUuY2UobCksbH0oZSxyLGkpO25CKGUpJiYoby5jdHgucmVuZGVyZXI9ZWMpLGZ1bmN0aW9uKGUsdD0hMSxuPSExKXt0JiZ1KHQpO2xldHtwcm9wczpyLGNoaWxkcmVuOml9PWUudm5vZGUsbD1pTyhlKTshZnVuY3Rpb24oZSx0LG4scj0hMSl7bGV0IGk9e30sbD1yeCgpO2ZvcihsZXQgbiBpbiBlLnByb3BzRGVmYXVsdHM9T2JqZWN0LmNyZWF0ZShudWxsKSxyayhlLHQsaSxsKSxlLnByb3BzT3B0aW9uc1swXSluIGluIGl8fChpW25dPXZvaWQgMCk7bj9lLnByb3BzPXI/aTp0ZihpKTplLnR5cGUucHJvcHM/ZS5wcm9wcz1pOmUucHJvcHM9bCxlLmF0dHJzPWx9KGUscixsLHQpLCgoZSx0LG4pPT57bGV0IHI9ZS5zbG90cz1yeCgpO2lmKDMyJmUudm5vZGUuc2hhcGVGbGFnKXtsZXQgZT10Ll9fO2UmJlkociwiX18iLGUsITApO2xldCBpPXQuXztpPyhyUChyLHQsbiksbiYmWShyLCJfIixpLCEwKSk6clIodCxyKX1lbHNlIHQmJnJPKGUsdCl9KShlLGksbnx8dCksbCYmZnVuY3Rpb24oZSx0KXtsZXQgbj1lLnR5cGU7ZS5hY2Nlc3NDYWNoZT1PYmplY3QuY3JlYXRlKG51bGwpLGUucHJveHk9bmV3IFByb3h5KGUuY3R4LHJuKTtsZXR7c2V0dXA6cn09bjtpZihyKXtlTSgpO2xldCBuPWUuc2V0dXBDb250ZXh0PXIubGVuZ3RoPjE/aUYoZSk6bnVsbCxpPWlJKGUpLGw9dEgocixlLDAsW2UucHJvcHMsbl0pLHM9RChsKTtpZihlTCgpLGkoKSwoc3x8ZS5zcCkmJiFuRihlKSYmbk4oZSkscyl7aWYobC50aGVuKGlSLGlSKSx0KXJldHVybiBsLnRoZW4obj0+e2lNKGUsbix0KX0pLmNhdGNoKHQ9Pnt0Vyh0LGUsMCl9KTtlLmFzeW5jRGVwPWx9ZWxzZSBpTShlLGwsdCl9ZWxzZSBpJChlLHQpfShlLHQpLHQmJnUoITEpfShvLCExLHMpLG8uYXN5bmNEZXA/KGkmJmkucmVnaXN0ZXJEZXAobyxxLHMpLGUuZWx8fGsobnVsbCxvLnN1YlRyZWU9aXYoaWUpLHQsbikpOnEobyxlLHQsbixpLGwscyl9LEg9KGUsdCxuKT0+e2xldCByPXQuY29tcG9uZW50PWUuY29tcG9uZW50O2lmKGZ1bmN0aW9uKGUsdCxuKXtsZXR7cHJvcHM6cixjaGlsZHJlbjppLGNvbXBvbmVudDpsfT1lLHtwcm9wczpzLGNoaWxkcmVuOm8scGF0Y2hGbGFnOmF9PXQsYz1sLmVtaXRzT3B0aW9ucztpZih0LmRpcnN8fHQudHJhbnNpdGlvbilyZXR1cm4hMDtpZighbnx8IShhPj0wKSlyZXR1cm4oISFpfHwhIW8pJiYoIW98fCFvLiRzdGFibGUpfHxyIT09cyYmKHI/IXN8fHJZKHIscyxjKTohIXMpO2lmKDEwMjQmYSlyZXR1cm4hMDtpZigxNiZhKXJldHVybiByP3JZKHIscyxjKTohIXM7aWYoOCZhKXtsZXQgZT10LmR5bmFtaWNQcm9wcztmb3IobGV0IHQ9MDt0PGUubGVuZ3RoO3QrKyl7bGV0IG49ZVt0XTtpZihzW25dIT09cltuXSYmIXJHKGMsbikpcmV0dXJuITB9fXJldHVybiExfShlLHQsbikpaWYoci5hc3luY0RlcCYmIXIuYXN5bmNSZXNvbHZlZClyZXR1cm4gdm9pZCBXKHIsdCxuKTtlbHNlIHIubmV4dD10LHIudXBkYXRlKCk7ZWxzZSB0LmVsPWUuZWwsci52bm9kZT10fSxxPShlLHQsbixyLGwscyxvKT0+e2xldCBhPSgpPT57aWYoZS5pc01vdW50ZWQpe2xldCB0LHtuZXh0Om4sYnU6cix1OmkscGFyZW50OmMsdm5vZGU6dX09ZTt7bGV0IHQ9ZnVuY3Rpb24gZSh0KXtsZXQgbj10LnN1YlRyZWUuY29tcG9uZW50O2lmKG4paWYobi5hc3luY0RlcCYmIW4uYXN5bmNSZXNvbHZlZClyZXR1cm4gbjtlbHNlIHJldHVybiBlKG4pfShlKTtpZih0KXtuJiYobi5lbD11LmVsLFcoZSxuLG8pKSx0LmFzeW5jRGVwLnRoZW4oKCk9PntlLmlzVW5tb3VudGVkfHxhKCl9KTtyZXR1cm59fWxldCBkPW47ckYoZSwhMSksbj8obi5lbD11LmVsLFcoZSxuLG8pKTpuPXUsciYmWihyKSwodD1uLnByb3BzJiZuLnByb3BzLm9uVm5vZGVCZWZvcmVVcGRhdGUpJiZpVCh0LGMsbix1KSxyRihlLCEwKTtsZXQgcD1yWChlKSxoPWUuc3ViVHJlZTtlLnN1YlRyZWU9cCx4KGgscCxmKGguZWwpLGVzKGgpLGUsbCxzKSxuLmVsPXAuZWwsbnVsbD09PWQmJnIwKGUscC5lbCksaSYmck0oaSxsKSwodD1uLnByb3BzJiZuLnByb3BzLm9uVm5vZGVVcGRhdGVkKSYmck0oKCk9PmlUKHQsYyxuLHUpLGwpfWVsc2V7bGV0IG8se2VsOmEscHJvcHM6Y309dCx7Ym06dSxtOmQscGFyZW50OnAscm9vdDpoLHR5cGU6Zn09ZSxtPW5GKHQpO2lmKHJGKGUsITEpLHUmJloodSksIW0mJihvPWMmJmMub25Wbm9kZUJlZm9yZU1vdW50KSYmaVQobyxwLHQpLHJGKGUsITApLGEmJmkpe2xldCB0PSgpPT57ZS5zdWJUcmVlPXJYKGUpLGkoYSxlLnN1YlRyZWUsZSxsLG51bGwpfTttJiZmLl9fYXN5bmNIeWRyYXRlP2YuX19hc3luY0h5ZHJhdGUoYSxlLHQpOnQoKX1lbHNle2guY2UmJiExIT09aC5jZS5fZGVmLnNoYWRvd1Jvb3QmJmguY2UuX2luamVjdENoaWxkU3R5bGUoZik7bGV0IGk9ZS5zdWJUcmVlPXJYKGUpO3gobnVsbCxpLG4scixlLGwscyksdC5lbD1pLmVsfWlmKGQmJnJNKGQsbCksIW0mJihvPWMmJmMub25Wbm9kZU1vdW50ZWQpKXtsZXQgZT10O3JNKCgpPT5pVChvLHAsZSksbCl9KDI1NiZ0LnNoYXBlRmxhZ3x8cCYmbkYocC52bm9kZSkmJjI1NiZwLnZub2RlLnNoYXBlRmxhZykmJmUuYSYmck0oZS5hLGwpLGUuaXNNb3VudGVkPSEwLHQ9bj1yPW51bGx9fTtlLnNjb3BlLm9uKCk7bGV0IGM9ZS5lZmZlY3Q9bmV3IGVDKGEpO2Uuc2NvcGUub2ZmKCk7bGV0IHU9ZS51cGRhdGU9Yy5ydW4uYmluZChjKSxkPWUuam9iPWMucnVuSWZEaXJ0eS5iaW5kKGMpO2QuaT1lLGQuaWQ9ZS51aWQsYy5zY2hlZHVsZXI9KCk9PnQwKGQpLHJGKGUsITApLHUoKX0sVz0oZSx0LG4pPT57dC5jb21wb25lbnQ9ZTtsZXQgcj1lLnZub2RlLnByb3BzO2Uudm5vZGU9dCxlLm5leHQ9bnVsbCxmdW5jdGlvbihlLHQsbixyKXtsZXR7cHJvcHM6aSxhdHRyczpsLHZub2RlOntwYXRjaEZsYWc6c319PWUsbz10UyhpKSxbYV09ZS5wcm9wc09wdGlvbnMsYz0hMTtpZigocnx8cz4wKSYmISgxNiZzKSl7aWYoOCZzKXtsZXQgbj1lLnZub2RlLmR5bmFtaWNQcm9wcztmb3IobGV0IHI9MDtyPG4ubGVuZ3RoO3IrKyl7bGV0IHM9bltyXTtpZihyRyhlLmVtaXRzT3B0aW9ucyxzKSljb250aW51ZTtsZXQgdT10W3NdO2lmKGEpaWYoQShsLHMpKXUhPT1sW3NdJiYobFtzXT11LGM9ITApO2Vsc2V7bGV0IHQ9SyhzKTtpW3RdPXJUKGEsbyx0LHUsZSwhMSl9ZWxzZSB1IT09bFtzXSYmKGxbc109dSxjPSEwKX19fWVsc2V7bGV0IHI7Zm9yKGxldCBzIGluIHJrKGUsdCxpLGwpJiYoYz0hMCksbyl0JiYoQSh0LHMpfHwocj1KKHMpKSE9PXMmJkEodCxyKSl8fChhP24mJih2b2lkIDAhPT1uW3NdfHx2b2lkIDAhPT1uW3JdKSYmKGlbc109clQoYSxvLHMsdm9pZCAwLGUsITApKTpkZWxldGUgaVtzXSk7aWYobCE9PW8pZm9yKGxldCBlIGluIGwpdCYmQSh0LGUpfHwoZGVsZXRlIGxbZV0sYz0hMCl9YyYmZVcoZS5hdHRycywic2V0IiwiIil9KGUsdC5wcm9wcyxyLG4pLCgoZSx0LG4pPT57bGV0e3Zub2RlOnIsc2xvdHM6aX09ZSxsPSEwLHM9YjtpZigzMiZyLnNoYXBlRmxhZyl7bGV0IGU9dC5fO2U/biYmMT09PWU/bD0hMTpyUChpLHQsbik6KGw9IXQuJHN0YWJsZSxyUih0LGkpKSxzPXR9ZWxzZSB0JiYock8oZSx0KSxzPXtkZWZhdWx0OjF9KTtpZihsKWZvcihsZXQgZSBpbiBpKXJBKGUpfHxudWxsIT1zW2VdfHxkZWxldGUgaVtlXX0pKGUsdC5jaGlsZHJlbixuKSxlTSgpLHQzKGUpLGVMKCl9LHo9KGUsdCxuLHIsaSxsLHMsbyxhPSExKT0+e2xldCBjPWUmJmUuY2hpbGRyZW4sdT1lP2Uuc2hhcGVGbGFnOjAsZD10LmNoaWxkcmVuLHtwYXRjaEZsYWc6cCxzaGFwZUZsYWc6Zn09dDtpZihwPjApe2lmKDEyOCZwKXJldHVybiB2b2lkIFgoYyxkLG4scixpLGwscyxvLGEpO2Vsc2UgaWYoMjU2JnApcmV0dXJuIHZvaWQgRyhjLGQsbixyLGksbCxzLG8sYSl9OCZmPygxNiZ1JiZlbChjLGksbCksZCE9PWMmJmgobixkKSk6MTYmdT8xNiZmP1goYyxkLG4scixpLGwscyxvLGEpOmVsKGMsaSxsLCEwKTooOCZ1JiZoKG4sIiIpLDE2JmYmJk8oZCxuLHIsaSxsLHMsbyxhKSl9LEc9KGUsdCxuLHIsaSxsLHMsbyxhKT0+e2xldCBjO2U9ZXx8Xyx0PXR8fF87bGV0IHU9ZS5sZW5ndGgsZD10Lmxlbmd0aCxwPU1hdGgubWluKHUsZCk7Zm9yKGM9MDtjPHA7YysrKXtsZXQgcj10W2NdPWE/aXgodFtjXSk6aVModFtjXSk7eChlW2NdLHIsbixudWxsLGksbCxzLG8sYSl9dT5kP2VsKGUsaSxsLCEwLCExLHApOk8odCxuLHIsaSxsLHMsbyxhLHApfSxYPShlLHQsbixyLGksbCxzLG8sYSk9PntsZXQgYz0wLHU9dC5sZW5ndGgsZD1lLmxlbmd0aC0xLHA9dS0xO2Zvcig7Yzw9ZCYmYzw9cDspe2xldCByPWVbY10sdT10W2NdPWE/aXgodFtjXSk6aVModFtjXSk7aWYoaXAocix1KSl4KHIsdSxuLG51bGwsaSxsLHMsbyxhKTtlbHNlIGJyZWFrO2MrK31mb3IoO2M8PWQmJmM8PXA7KXtsZXQgcj1lW2RdLGM9dFtwXT1hP2l4KHRbcF0pOmlTKHRbcF0pO2lmKGlwKHIsYykpeChyLGMsbixudWxsLGksbCxzLG8sYSk7ZWxzZSBicmVhaztkLS0scC0tfWlmKGM+ZCl7aWYoYzw9cCl7bGV0IGU9cCsxLGQ9ZTx1P3RbZV0uZWw6cjtmb3IoO2M8PXA7KXgobnVsbCx0W2NdPWE/aXgodFtjXSk6aVModFtjXSksbixkLGksbCxzLG8sYSksYysrfX1lbHNlIGlmKGM+cClmb3IoO2M8PWQ7KWVlKGVbY10saSxsLCEwKSxjKys7ZWxzZXtsZXQgaCxmPWMsbT1jLGc9bmV3IE1hcDtmb3IoYz1tO2M8PXA7YysrKXtsZXQgZT10W2NdPWE/aXgodFtjXSk6aVModFtjXSk7bnVsbCE9ZS5rZXkmJmcuc2V0KGUua2V5LGMpfWxldCB5PTAsYj1wLW0rMSxTPSExLEM9MCxrPUFycmF5KGIpO2ZvcihjPTA7YzxiO2MrKylrW2NdPTA7Zm9yKGM9ZjtjPD1kO2MrKyl7bGV0IHIsdT1lW2NdO2lmKHk+PWIpe2VlKHUsaSxsLCEwKTtjb250aW51ZX1pZihudWxsIT11LmtleSlyPWcuZ2V0KHUua2V5KTtlbHNlIGZvcihoPW07aDw9cDtoKyspaWYoMD09PWtbaC1tXSYmaXAodSx0W2hdKSl7cj1oO2JyZWFrfXZvaWQgMD09PXI/ZWUodSxpLGwsITApOihrW3ItbV09YysxLHI+PUM/Qz1yOlM9ITAseCh1LHRbcl0sbixudWxsLGksbCxzLG8sYSkseSsrKX1sZXQgVD1TP2Z1bmN0aW9uKGUpe2xldCB0LG4scixpLGwscz1lLnNsaWNlKCksbz1bMF0sYT1lLmxlbmd0aDtmb3IodD0wO3Q8YTt0Kyspe2xldCBhPWVbdF07aWYoMCE9PWEpe2lmKGVbbj1vW28ubGVuZ3RoLTFdXTxhKXtzW3RdPW4sby5wdXNoKHQpO2NvbnRpbnVlfWZvcihyPTAsaT1vLmxlbmd0aC0xO3I8aTspZVtvW2w9citpPj4xXV08YT9yPWwrMTppPWw7YTxlW29bcl1dJiYocj4wJiYoc1t0XT1vW3ItMV0pLG9bcl09dCl9fWZvcihyPW8ubGVuZ3RoLGk9b1tyLTFdO3ItLSA+MDspb1tyXT1pLGk9c1tpXTtyZXR1cm4gb30oayk6Xztmb3IoaD1ULmxlbmd0aC0xLGM9Yi0xO2M+PTA7Yy0tKXtsZXQgZT1tK2MsZD10W2VdLHA9ZSsxPHU/dFtlKzFdLmVsOnI7MD09PWtbY10/eChudWxsLGQsbixwLGksbCxzLG8sYSk6UyYmKGg8MHx8YyE9PVRbaF0/UShkLG4scCwyKTpoLS0pfX19LFE9KGUsdCxuLHIsaT1udWxsKT0+e2xldHtlbDpvLHR5cGU6YSx0cmFuc2l0aW9uOmMsY2hpbGRyZW46dSxzaGFwZUZsYWc6ZH09ZTtpZig2JmQpcmV0dXJuIHZvaWQgUShlLmNvbXBvbmVudC5zdWJUcmVlLHQsbixyKTtpZigxMjgmZClyZXR1cm4gdm9pZCBlLnN1c3BlbnNlLm1vdmUodCxuLHIpO2lmKDY0JmQpcmV0dXJuIHZvaWQgYS5tb3ZlKGUsdCxuLGVjKTtpZihhPT09cjkpe2wobyx0LG4pO2ZvcihsZXQgZT0wO2U8dS5sZW5ndGg7ZSsrKVEodVtlXSx0LG4scik7bChlLmFuY2hvcix0LG4pO3JldHVybn1pZihhPT09aXQpcmV0dXJuIHZvaWQoKHtlbDplLGFuY2hvcjp0fSxuLHIpPT57bGV0IGk7Zm9yKDtlJiZlIT09dDspaT1tKGUpLGwoZSxuLHIpLGU9aTtsKHQsbixyKX0pKGUsdCxuKTtpZigyIT09ciYmMSZkJiZjKWlmKDA9PT1yKWMuYmVmb3JlRW50ZXIobyksbChvLHQsbiksck0oKCk9PmMuZW50ZXIobyksaSk7ZWxzZXtsZXR7bGVhdmU6cixkZWxheUxlYXZlOmksYWZ0ZXJMZWF2ZTphfT1jLHU9KCk9PntlLmN0eC5pc1VubW91bnRlZD9zKG8pOmwobyx0LG4pfSxkPSgpPT57cihvLCgpPT57dSgpLGEmJmEoKX0pfTtpP2kobyx1LGQpOmQoKX1lbHNlIGwobyx0LG4pfSxlZT0oZSx0LG4scj0hMSxpPSExKT0+e2xldCBsLHt0eXBlOnMscHJvcHM6byxyZWY6YSxjaGlsZHJlbjpjLGR5bmFtaWNDaGlsZHJlbjp1LHNoYXBlRmxhZzpkLHBhdGNoRmxhZzpwLGRpcnM6aCxjYWNoZUluZGV4OmZ9PWU7aWYoLTI9PT1wJiYoaT0hMSksbnVsbCE9YSYmKGVNKCksbncoYSxudWxsLG4sZSwhMCksZUwoKSksbnVsbCE9ZiYmKHQucmVuZGVyQ2FjaGVbZl09dm9pZCAwKSwyNTYmZClyZXR1cm4gdm9pZCB0LmN0eC5kZWFjdGl2YXRlKGUpO2xldCBtPTEmZCYmaCxnPSFuRihlKTtpZihnJiYobD1vJiZvLm9uVm5vZGVCZWZvcmVVbm1vdW50KSYmaVQobCx0LGUpLDYmZCllaShlLmNvbXBvbmVudCxuLHIpO2Vsc2V7aWYoMTI4JmQpcmV0dXJuIHZvaWQgZS5zdXNwZW5zZS51bm1vdW50KG4scik7bSYmbmUoZSxudWxsLHQsImJlZm9yZVVubW91bnQiKSw2NCZkP2UudHlwZS5yZW1vdmUoZSx0LG4sZWMscik6dSYmIXUuaGFzT25jZSYmKHMhPT1yOXx8cD4wJiY2NCZwKT9lbCh1LHQsbiwhMSwhMCk6KHM9PT1yOSYmMzg0JnB8fCFpJiYxNiZkKSYmZWwoYyx0LG4pLHImJmV0KGUpfShnJiYobD1vJiZvLm9uVm5vZGVVbm1vdW50ZWQpfHxtKSYmck0oKCk9PntsJiZpVChsLHQsZSksbSYmbmUoZSxudWxsLHQsInVubW91bnRlZCIpfSxuKX0sZXQ9ZT0+e2xldHt0eXBlOnQsZWw6bixhbmNob3I6cix0cmFuc2l0aW9uOml9PWU7aWYodD09PXI5KXJldHVybiB2b2lkIGVyKG4scik7aWYodD09PWl0KXJldHVybiB2b2lkKCh7ZWw6ZSxhbmNob3I6dH0pPT57bGV0IG47Zm9yKDtlJiZlIT09dDspbj1tKGUpLHMoZSksZT1uO3ModCl9KShlKTtsZXQgbD0oKT0+e3MobiksaSYmIWkucGVyc2lzdGVkJiZpLmFmdGVyTGVhdmUmJmkuYWZ0ZXJMZWF2ZSgpfTtpZigxJmUuc2hhcGVGbGFnJiZpJiYhaS5wZXJzaXN0ZWQpe2xldHtsZWF2ZTp0LGRlbGF5TGVhdmU6cn09aSxzPSgpPT50KG4sbCk7cj9yKGUuZWwsbCxzKTpzKCl9ZWxzZSBsKCl9LGVyPShlLHQpPT57bGV0IG47Zm9yKDtlIT09dDspbj1tKGUpLHMoZSksZT1uO3ModCl9LGVpPShlLHQsbik9PntsZXR7YnVtOnIsc2NvcGU6aSxqb2I6bCxzdWJUcmVlOnMsdW06byxtOmEsYTpjLHBhcmVudDp1LHNsb3RzOntfXzpkfX09ZTtyVShhKSxyVShjKSxyJiZaKHIpLHUmJkUoZCkmJmQuZm9yRWFjaChlPT57dS5yZW5kZXJDYWNoZVtlXT12b2lkIDB9KSxpLnN0b3AoKSxsJiYobC5mbGFnc3w9OCxlZShzLGUsdCxuKSksbyYmck0obyx0KSxyTSgoKT0+e2UuaXNVbm1vdW50ZWQ9ITB9LHQpLHQmJnQucGVuZGluZ0JyYW5jaCYmIXQuaXNVbm1vdW50ZWQmJmUuYXN5bmNEZXAmJiFlLmFzeW5jUmVzb2x2ZWQmJmUuc3VzcGVuc2VJZD09PXQucGVuZGluZ0lkJiYodC5kZXBzLS0sMD09PXQuZGVwcyYmdC5yZXNvbHZlKCkpfSxlbD0oZSx0LG4scj0hMSxpPSExLGw9MCk9Pntmb3IobGV0IHM9bDtzPGUubGVuZ3RoO3MrKyllZShlW3NdLHQsbixyLGkpfSxlcz1lPT57aWYoNiZlLnNoYXBlRmxhZylyZXR1cm4gZXMoZS5jb21wb25lbnQuc3ViVHJlZSk7aWYoMTI4JmUuc2hhcGVGbGFnKXJldHVybiBlLnN1c3BlbnNlLm5leHQoKTtsZXQgdD1tKGUuYW5jaG9yfHxlLmVsKSxuPXQmJnRbbnRdO3JldHVybiBuP20obik6dH0sZW89ITEsZWE9KGUsdCxuKT0+e251bGw9PWU/dC5fdm5vZGUmJmVlKHQuX3Zub2RlLG51bGwsbnVsbCwhMCk6eCh0Ll92bm9kZXx8bnVsbCxlLHQsbnVsbCxudWxsLG51bGwsbiksdC5fdm5vZGU9ZSxlb3x8KGVvPSEwLHQzKCksdDYoKSxlbz0hMSl9LGVjPXtwOngsdW06ZWUsbTpRLHI6ZXQsbXQ6VSxtYzpPLHBjOnoscGJjOkwsbjplcyxvOmV9O3JldHVybiB0JiYoW3IsaV09dChlYykpLHtyZW5kZXI6ZWEsaHlkcmF0ZTpyLGNyZWF0ZUFwcDoobj1yLGZ1bmN0aW9uKGUsdD1udWxsKXtQKGUpfHwoZT1UKHt9LGUpKSxudWxsPT10fHwkKHQpfHwodD1udWxsKTtsZXQgcj1yZygpLGk9bmV3IFdlYWtTZXQsbD1bXSxzPSExLG89ci5hcHA9e191aWQ6cnYrKyxfY29tcG9uZW50OmUsX3Byb3BzOnQsX2NvbnRhaW5lcjpudWxsLF9jb250ZXh0OnIsX2luc3RhbmNlOm51bGwsdmVyc2lvbjppcSxnZXQgY29uZmlnKCl7cmV0dXJuIHIuY29uZmlnfSxzZXQgY29uZmlnKHYpe30sdXNlOihlLC4uLnQpPT4oaS5oYXMoZSl8fChlJiZQKGUuaW5zdGFsbCk/KGkuYWRkKGUpLGUuaW5zdGFsbChvLC4uLnQpKTpQKGUpJiYoaS5hZGQoZSksZShvLC4uLnQpKSksbyksbWl4aW46ZT0+KHIubWl4aW5zLmluY2x1ZGVzKGUpfHxyLm1peGlucy5wdXNoKGUpLG8pLGNvbXBvbmVudDooZSx0KT0+dD8oci5jb21wb25lbnRzW2VdPXQsbyk6ci5jb21wb25lbnRzW2VdLGRpcmVjdGl2ZTooZSx0KT0+dD8oci5kaXJlY3RpdmVzW2VdPXQsbyk6ci5kaXJlY3RpdmVzW2VdLG1vdW50KGksbCxhKXtpZighcyl7bGV0IGM9by5fY2VWTm9kZXx8aXYoZSx0KTtyZXR1cm4gYy5hcHBDb250ZXh0PXIsITA9PT1hP2E9InN2ZyI6ITE9PT1hJiYoYT12b2lkIDApLGwmJm4/bihjLGkpOmVhKGMsaSxhKSxzPSEwLG8uX2NvbnRhaW5lcj1pLGkuX192dWVfYXBwX189byxpVihjLmNvbXBvbmVudCl9fSxvblVubW91bnQoZSl7bC5wdXNoKGUpfSx1bm1vdW50KCl7cyYmKHRxKGwsby5faW5zdGFuY2UsMTYpLGVhKG51bGwsby5fY29udGFpbmVyKSxkZWxldGUgby5fY29udGFpbmVyLl9fdnVlX2FwcF9fKX0scHJvdmlkZTooZSx0KT0+KHIucHJvdmlkZXNbZV09dCxvKSxydW5XaXRoQ29udGV4dChlKXtsZXQgdD1yeTtyeT1vO3RyeXtyZXR1cm4gZSgpfWZpbmFsbHl7cnk9dH19fTtyZXR1cm4gb30pfX1mdW5jdGlvbiByRCh7dHlwZTplLHByb3BzOnR9LG4pe3JldHVybiJzdmciPT09biYmImZvcmVpZ25PYmplY3QiPT09ZXx8Im1hdGhtbCI9PT1uJiYiYW5ub3RhdGlvbi14bWwiPT09ZSYmdCYmdC5lbmNvZGluZyYmdC5lbmNvZGluZy5pbmNsdWRlcygiaHRtbCIpP3ZvaWQgMDpufWZ1bmN0aW9uIHJGKHtlZmZlY3Q6ZSxqb2I6dH0sbil7bj8oZS5mbGFnc3w9MzIsdC5mbGFnc3w9NCk6KGUuZmxhZ3MmPS0zMyx0LmZsYWdzJj0tNSl9ZnVuY3Rpb24gclYoZSx0KXtyZXR1cm4oIWV8fGUmJiFlLnBlbmRpbmdCcmFuY2gpJiZ0JiYhdC5wZXJzaXN0ZWR9ZnVuY3Rpb24gckIoZSx0LG49ITEpe2xldCByPWUuY2hpbGRyZW4saT10LmNoaWxkcmVuO2lmKEUocikmJkUoaSkpZm9yKGxldCBlPTA7ZTxyLmxlbmd0aDtlKyspe2xldCB0PXJbZV0sbD1pW2VdOzEmbC5zaGFwZUZsYWcmJiFsLmR5bmFtaWNDaGlsZHJlbiYmKChsLnBhdGNoRmxhZzw9MHx8MzI9PT1sLnBhdGNoRmxhZykmJigobD1pW2VdPWl4KGlbZV0pKS5lbD10LmVsKSxufHwtMj09PWwucGF0Y2hGbGFnfHxyQih0LGwpKSxsLnR5cGU9PT1yNyYmKGwuZWw9dC5lbCksbC50eXBlIT09aWV8fGwuZWx8fChsLmVsPXQuZWwpfX1mdW5jdGlvbiByVShlKXtpZihlKWZvcihsZXQgdD0wO3Q8ZS5sZW5ndGg7dCsrKWVbdF0uZmxhZ3N8PTh9bGV0IHJqPVN5bWJvbC5mb3IoInYtc2N4Iik7ZnVuY3Rpb24gckgoZSx0KXtyZXR1cm4gcnEoZSxudWxsLHtmbHVzaDoic3luYyJ9KX1mdW5jdGlvbiBycShlLHQsbj1iKXtsZXR7aW1tZWRpYXRlOnIsZGVlcDppLGZsdXNoOnMsb25jZTpvfT1uLGE9VCh7fSxuKSxjPWlBO2EuY2FsbD0oZSx0LG4pPT50cShlLGMsdCxuKTtsZXQgdT0hMTtyZXR1cm4icG9zdCI9PT1zP2Euc2NoZWR1bGVyPWU9PntyTShlLGMmJmMuc3VzcGVuc2UpfToic3luYyIhPT1zJiYodT0hMCxhLnNjaGVkdWxlcj0oZSx0KT0+e3Q/ZSgpOnQwKGUpfSksYS5hdWdtZW50Sm9iPWU9Pnt0JiYoZS5mbGFnc3w9NCksdSYmKGUuZmxhZ3N8PTIsYyYmKGUuaWQ9Yy51aWQsZS5pPWMpKX0sZnVuY3Rpb24oZSx0LG49Yil7bGV0IHIsaSxzLG8se2ltbWVkaWF0ZTphLGRlZXA6YyxvbmNlOnUsc2NoZWR1bGVyOmQsYXVnbWVudEpvYjpwLGNhbGw6aH09bixmPWU9PmM/ZTp0YihlKXx8ITE9PT1jfHwwPT09Yz90aihlLDEpOnRqKGUpLGc9ITEseT0hMTtpZih0VChlKT8oaT0oKT0+ZS52YWx1ZSxnPXRiKGUpKTp0dihlKT8oaT0oKT0+ZihlKSxnPSEwKTpFKGUpPyh5PSEwLGc9ZS5zb21lKGU9PnR2KGUpfHx0YihlKSksaT0oKT0+ZS5tYXAoZT0+dFQoZSk/ZS52YWx1ZTp0dihlKT9mKGUpOlAoZSk/aD9oKGUsMik6ZSgpOnZvaWQgMCkpOmk9UChlKT90P2g/KCk9PmgoZSwyKTplOigpPT57aWYocyl7ZU0oKTt0cnl7cygpfWZpbmFsbHl7ZUwoKX19bGV0IHQ9bTttPXI7dHJ5e3JldHVybiBoP2goZSwzLFtvXSk6ZShvKX1maW5hbGx5e209dH19OlMsdCYmYyl7bGV0IGU9aSx0PSEwPT09Yz8xLzA6YztpPSgpPT50aihlKCksdCl9bGV0IF89bCx4PSgpPT57ci5zdG9wKCksXyYmXy5hY3RpdmUmJk4oXy5lZmZlY3RzLHIpfTtpZih1JiZ0KXtsZXQgZT10O3Q9KC4uLnQpPT57ZSguLi50KSx4KCl9fWxldCBDPXk/QXJyYXkoZS5sZW5ndGgpLmZpbGwodFYpOnRWLGs9ZT0+e2lmKDEmci5mbGFncyYmKHIuZGlydHl8fGUpKWlmKHQpe2xldCBlPXIucnVuKCk7aWYoY3x8Z3x8KHk/ZS5zb21lKChlLHQpPT5RKGUsQ1t0XSkpOlEoZSxDKSkpe3MmJnMoKTtsZXQgbj1tO209cjt0cnl7bGV0IG49W2UsQz09PXRWP3ZvaWQgMDp5JiZDWzBdPT09dFY/W106QyxvXTtDPWUsaD9oKHQsMyxuKTp0KC4uLm4pfWZpbmFsbHl7bT1ufX19ZWxzZSByLnJ1bigpfTtyZXR1cm4gcCYmcChrKSwocj1uZXcgZUMoaSkpLnNjaGVkdWxlcj1kPygpPT5kKGssITEpOmssbz1lPT50VShlLCExLHIpLHM9ci5vblN0b3A9KCk9PntsZXQgZT10Qi5nZXQocik7aWYoZSl7aWYoaCloKGUsNCk7ZWxzZSBmb3IobGV0IHQgb2YgZSl0KCk7dEIuZGVsZXRlKHIpfX0sdD9hP2soITApOkM9ci5ydW4oKTpkP2Qoay5iaW5kKG51bGwsITApLCEwKTpyLnJ1bigpLHgucGF1c2U9ci5wYXVzZS5iaW5kKHIpLHgucmVzdW1lPXIucmVzdW1lLmJpbmQocikseC5zdG9wPXgseH0oZSx0LGEpfWZ1bmN0aW9uIHJXKGUsdCxuKXtsZXQgcixpPXRoaXMucHJveHksbD1NKGUpP2UuaW5jbHVkZXMoIi4iKT9ySyhpLGUpOigpPT5pW2VdOmUuYmluZChpLGkpO1AodCk/cj10OihyPXQuaGFuZGxlcixuPXQpO2xldCBzPWlJKHRoaXMpLG89cnEobCxyLmJpbmQoaSksbik7cmV0dXJuIHMoKSxvfWZ1bmN0aW9uIHJLKGUsdCl7bGV0IG49dC5zcGxpdCgiLiIpO3JldHVybigpPT57bGV0IHQ9ZTtmb3IobGV0IGU9MDtlPG4ubGVuZ3RoJiZ0O2UrKyl0PXRbbltlXV07cmV0dXJuIHR9fWxldCByej0oZSx0KT0+Im1vZGVsVmFsdWUiPT09dHx8Im1vZGVsLXZhbHVlIj09PXQ/ZS5tb2RlbE1vZGlmaWVyczplW2Ake3R9TW9kaWZpZXJzYF18fGVbYCR7Syh0KX1Nb2RpZmllcnNgXXx8ZVtgJHtKKHQpfU1vZGlmaWVyc2BdO2Z1bmN0aW9uIHJKKGUsdCwuLi5uKXtsZXQgcjtpZihlLmlzVW5tb3VudGVkKXJldHVybjtsZXQgaT1lLnZub2RlLnByb3BzfHxiLGw9bixzPXQuc3RhcnRzV2l0aCgidXBkYXRlOiIpLG89cyYmcnooaSx0LnNsaWNlKDcpKTtvJiYoby50cmltJiYobD1uLm1hcChlPT5NKGUpP2UudHJpbSgpOmUpKSxvLm51bWJlciYmKGw9bi5tYXAoZWUpKSk7bGV0IGE9aVtyPVgodCldfHxpW3I9WChLKHQpKV07IWEmJnMmJihhPWlbcj1YKEoodCkpXSksYSYmdHEoYSxlLDYsbCk7bGV0IGM9aVtyKyJPbmNlIl07aWYoYyl7aWYoZS5lbWl0dGVkKXtpZihlLmVtaXR0ZWRbcl0pcmV0dXJufWVsc2UgZS5lbWl0dGVkPXt9O2UuZW1pdHRlZFtyXT0hMCx0cShjLGUsNixsKX19ZnVuY3Rpb24gckcoZSx0KXtyZXR1cm4hIWUmJiEhQyh0KSYmKEEoZSwodD10LnNsaWNlKDIpLnJlcGxhY2UoL09uY2UkLywiIikpWzBdLnRvTG93ZXJDYXNlKCkrdC5zbGljZSgxKSl8fEEoZSxKKHQpKXx8QShlLHQpKX1mdW5jdGlvbiByWChlKXtsZXQgdCxuLHt0eXBlOnIsdm5vZGU6aSxwcm94eTpsLHdpdGhQcm94eTpzLHByb3BzT3B0aW9uczpbb10sc2xvdHM6YSxhdHRyczpjLGVtaXQ6dSxyZW5kZXI6ZCxyZW5kZXJDYWNoZTpwLHByb3BzOmgsZGF0YTpmLHNldHVwU3RhdGU6bSxjdHg6Zyxpbmhlcml0QXR0cnM6eX09ZSxiPXQ5KGUpO3RyeXtpZig0Jmkuc2hhcGVGbGFnKXtsZXQgZT1zfHxsO3Q9aVMoZC5jYWxsKGUsZSxwLGgsbSxmLGcpKSxuPWN9ZWxzZSB0PWlTKHIubGVuZ3RoPjE/cihoLHthdHRyczpjLHNsb3RzOmEsZW1pdDp1fSk6cihoLG51bGwpKSxuPXIucHJvcHM/YzpyUShjKX1jYXRjaChuKXtpci5sZW5ndGg9MCx0VyhuLGUsMSksdD1pdihpZSl9bGV0IF89dDtpZihuJiYhMSE9PXkpe2xldCBlPU9iamVjdC5rZXlzKG4pLHtzaGFwZUZsYWc6dH09XztlLmxlbmd0aCYmNyZ0JiYobyYmZS5zb21lKGspJiYobj1yWihuLG8pKSxfPWliKF8sbiwhMSwhMCkpfXJldHVybiBpLmRpcnMmJigoXz1pYihfLG51bGwsITEsITApKS5kaXJzPV8uZGlycz9fLmRpcnMuY29uY2F0KGkuZGlycyk6aS5kaXJzKSxpLnRyYW5zaXRpb24mJm5DKF8saS50cmFuc2l0aW9uKSx0PV8sdDkoYiksdH1sZXQgclE9ZT0+e2xldCB0O2ZvcihsZXQgbiBpbiBlKSgiY2xhc3MiPT09bnx8InN0eWxlIj09PW58fEMobikpJiYoKHR8fCh0PXt9KSlbbl09ZVtuXSk7cmV0dXJuIHR9LHJaPShlLHQpPT57bGV0IG49e307Zm9yKGxldCByIGluIGUpayhyKSYmci5zbGljZSg5KWluIHR8fChuW3JdPWVbcl0pO3JldHVybiBufTtmdW5jdGlvbiByWShlLHQsbil7bGV0IHI9T2JqZWN0LmtleXModCk7aWYoci5sZW5ndGghPT1PYmplY3Qua2V5cyhlKS5sZW5ndGgpcmV0dXJuITA7Zm9yKGxldCBpPTA7aTxyLmxlbmd0aDtpKyspe2xldCBsPXJbaV07aWYodFtsXSE9PWVbbF0mJiFyRyhuLGwpKXJldHVybiEwfXJldHVybiExfWZ1bmN0aW9uIHIwKHt2bm9kZTplLHBhcmVudDp0fSxuKXtmb3IoO3Q7KXtsZXQgcj10LnN1YlRyZWU7aWYoci5zdXNwZW5zZSYmci5zdXNwZW5zZS5hY3RpdmVCcmFuY2g9PT1lJiYoci5lbD1lLmVsKSxyPT09ZSkoZT10LnZub2RlKS5lbD1uLHQ9dC5wYXJlbnQ7ZWxzZSBicmVha319bGV0IHIxPWU9PmUuX19pc1N1c3BlbnNlLHIyPTA7ZnVuY3Rpb24gcjMoZSx0KXtsZXQgbj1lLnByb3BzJiZlLnByb3BzW3RdO1AobikmJm4oKX1mdW5jdGlvbiByNihlLHQsbixyLGksbCxzLG8sYSxjLHU9ITEpe2xldCBkLHtwOnAsbTpoLHVtOmYsbjptLG86e3BhcmVudE5vZGU6ZyxyZW1vdmU6eX19PWMsYj1mdW5jdGlvbihlKXtsZXQgdD1lLnByb3BzJiZlLnByb3BzLnN1c3BlbnNpYmxlO3JldHVybiBudWxsIT10JiYhMSE9PXR9KGUpO2ImJnQmJnQucGVuZGluZ0JyYW5jaCYmKGQ9dC5wZW5kaW5nSWQsdC5kZXBzKyspO2xldCBfPWUucHJvcHM/ZXQoZS5wcm9wcy50aW1lb3V0KTp2b2lkIDAsUz1sLHg9e3Zub2RlOmUscGFyZW50OnQscGFyZW50Q29tcG9uZW50Om4sbmFtZXNwYWNlOnMsY29udGFpbmVyOnIsaGlkZGVuQ29udGFpbmVyOmksZGVwczowLHBlbmRpbmdJZDpyMisrLHRpbWVvdXQ6Im51bWJlciI9PXR5cGVvZiBfP186LTEsYWN0aXZlQnJhbmNoOm51bGwscGVuZGluZ0JyYW5jaDpudWxsLGlzSW5GYWxsYmFjazohdSxpc0h5ZHJhdGluZzp1LGlzVW5tb3VudGVkOiExLGVmZmVjdHM6W10scmVzb2x2ZShlPSExLG49ITEpe2xldHt2bm9kZTpyLGFjdGl2ZUJyYW5jaDppLHBlbmRpbmdCcmFuY2g6cyxwZW5kaW5nSWQ6byxlZmZlY3RzOmEscGFyZW50Q29tcG9uZW50OmMsY29udGFpbmVyOnV9PXgscD0hMTt4LmlzSHlkcmF0aW5nP3guaXNIeWRyYXRpbmc9ITE6IWUmJigocD1pJiZzLnRyYW5zaXRpb24mJiJvdXQtaW4iPT09cy50cmFuc2l0aW9uLm1vZGUpJiYoaS50cmFuc2l0aW9uLmFmdGVyTGVhdmU9KCk9PntvPT09eC5wZW5kaW5nSWQmJihoKHMsdSxsPT09Uz9tKGkpOmwsMCksdDIoYSkpfSksaSYmKGcoaS5lbCk9PT11JiYobD1tKGkpKSxmKGksYyx4LCEwKSkscHx8aChzLHUsbCwwKSkscjUoeCxzKSx4LnBlbmRpbmdCcmFuY2g9bnVsbCx4LmlzSW5GYWxsYmFjaz0hMTtsZXQgeT14LnBhcmVudCxfPSExO2Zvcig7eTspe2lmKHkucGVuZGluZ0JyYW5jaCl7eS5lZmZlY3RzLnB1c2goLi4uYSksXz0hMDticmVha315PXkucGFyZW50fV98fHB8fHQyKGEpLHguZWZmZWN0cz1bXSxiJiZ0JiZ0LnBlbmRpbmdCcmFuY2gmJmQ9PT10LnBlbmRpbmdJZCYmKHQuZGVwcy0tLDAhPT10LmRlcHN8fG58fHQucmVzb2x2ZSgpKSxyMyhyLCJvblJlc29sdmUiKX0sZmFsbGJhY2soZSl7aWYoIXgucGVuZGluZ0JyYW5jaClyZXR1cm47bGV0e3Zub2RlOnQsYWN0aXZlQnJhbmNoOm4scGFyZW50Q29tcG9uZW50OnIsY29udGFpbmVyOmksbmFtZXNwYWNlOmx9PXg7cjModCwib25GYWxsYmFjayIpO2xldCBzPW0obiksYz0oKT0+e3guaXNJbkZhbGxiYWNrJiYocChudWxsLGUsaSxzLHIsbnVsbCxsLG8sYSkscjUoeCxlKSl9LHU9ZS50cmFuc2l0aW9uJiYib3V0LWluIj09PWUudHJhbnNpdGlvbi5tb2RlO3UmJihuLnRyYW5zaXRpb24uYWZ0ZXJMZWF2ZT1jKSx4LmlzSW5GYWxsYmFjaz0hMCxmKG4scixudWxsLCEwKSx1fHxjKCl9LG1vdmUoZSx0LG4pe3guYWN0aXZlQnJhbmNoJiZoKHguYWN0aXZlQnJhbmNoLGUsdCxuKSx4LmNvbnRhaW5lcj1lfSxuZXh0OigpPT54LmFjdGl2ZUJyYW5jaCYmbSh4LmFjdGl2ZUJyYW5jaCkscmVnaXN0ZXJEZXAoZSx0LG4pe2xldCByPSEheC5wZW5kaW5nQnJhbmNoO3ImJnguZGVwcysrO2xldCBpPWUudm5vZGUuZWw7ZS5hc3luY0RlcC5jYXRjaCh0PT57dFcodCxlLDApfSkudGhlbihsPT57aWYoZS5pc1VubW91bnRlZHx8eC5pc1VubW91bnRlZHx8eC5wZW5kaW5nSWQhPT1lLnN1c3BlbnNlSWQpcmV0dXJuO2UuYXN5bmNSZXNvbHZlZD0hMDtsZXR7dm5vZGU6b309ZTtpTShlLGwsITEpLGkmJihvLmVsPWkpO2xldCBhPSFpJiZlLnN1YlRyZWUuZWw7dChlLG8sZyhpfHxlLnN1YlRyZWUuZWwpLGk/bnVsbDptKGUuc3ViVHJlZSkseCxzLG4pLGEmJnkoYSkscjAoZSxvLmVsKSxyJiYwPT0tLXguZGVwcyYmeC5yZXNvbHZlKCl9KX0sdW5tb3VudChlLHQpe3guaXNVbm1vdW50ZWQ9ITAseC5hY3RpdmVCcmFuY2gmJmYoeC5hY3RpdmVCcmFuY2gsbixlLHQpLHgucGVuZGluZ0JyYW5jaCYmZih4LnBlbmRpbmdCcmFuY2gsbixlLHQpfX07cmV0dXJuIHh9ZnVuY3Rpb24gcjQoZSl7bGV0IHQ7aWYoUChlKSl7bGV0IG49aW8mJmUuX2M7biYmKGUuX2Q9ITEsaWwoKSksZT1lKCksbiYmKGUuX2Q9ITAsdD1paSxpcygpKX1yZXR1cm4gRShlKSYmKGU9ZnVuY3Rpb24oZSx0PSEwKXtsZXQgbjtmb3IobGV0IHQ9MDt0PGUubGVuZ3RoO3QrKyl7bGV0IHI9ZVt0XTtpZighaWQocikpcmV0dXJuO2lmKHIudHlwZSE9PWllfHwidi1pZiI9PT1yLmNoaWxkcmVuKWlmKG4pcmV0dXJuO2Vsc2Ugbj1yfXJldHVybiBufShlKSksZT1pUyhlKSx0JiYhZS5keW5hbWljQ2hpbGRyZW4mJihlLmR5bmFtaWNDaGlsZHJlbj10LmZpbHRlcih0PT50IT09ZSkpLGV9ZnVuY3Rpb24gcjgoZSx0KXt0JiZ0LnBlbmRpbmdCcmFuY2g/RShlKT90LmVmZmVjdHMucHVzaCguLi5lKTp0LmVmZmVjdHMucHVzaChlKTp0MihlKX1mdW5jdGlvbiByNShlLHQpe2UuYWN0aXZlQnJhbmNoPXQ7bGV0e3Zub2RlOm4scGFyZW50Q29tcG9uZW50OnJ9PWUsaT10LmVsO2Zvcig7IWkmJnQuY29tcG9uZW50OylpPSh0PXQuY29tcG9uZW50LnN1YlRyZWUpLmVsO24uZWw9aSxyJiZyLnN1YlRyZWU9PT1uJiYoci52bm9kZS5lbD1pLHIwKHIsaSkpfWxldCByOT1TeW1ib2wuZm9yKCJ2LWZndCIpLHI3PVN5bWJvbC5mb3IoInYtdHh0IiksaWU9U3ltYm9sLmZvcigidi1jbXQiKSxpdD1TeW1ib2wuZm9yKCJ2LXN0YyIpLGlyPVtdLGlpPW51bGw7ZnVuY3Rpb24gaWwoZT0hMSl7aXIucHVzaChpaT1lP251bGw6W10pfWZ1bmN0aW9uIGlzKCl7aXIucG9wKCksaWk9aXJbaXIubGVuZ3RoLTFdfHxudWxsfWxldCBpbz0xO2Z1bmN0aW9uIGlhKGUsdD0hMSl7aW8rPWUsZTwwJiZpaSYmdCYmKGlpLmhhc09uY2U9ITApfWZ1bmN0aW9uIGljKGUpe3JldHVybiBlLmR5bmFtaWNDaGlsZHJlbj1pbz4wP2lpfHxfOm51bGwsaXMoKSxpbz4wJiZpaSYmaWkucHVzaChlKSxlfWZ1bmN0aW9uIGl1KGUsdCxuLHIsaSl7cmV0dXJuIGljKGl2KGUsdCxuLHIsaSwhMCkpfWZ1bmN0aW9uIGlkKGUpe3JldHVybiEhZSYmITA9PT1lLl9fdl9pc1ZOb2RlfWZ1bmN0aW9uIGlwKGUsdCl7cmV0dXJuIGUudHlwZT09PXQudHlwZSYmZS5rZXk9PT10LmtleX1sZXQgaWg9KHtrZXk6ZX0pPT5udWxsIT1lP2U6bnVsbCxpbT0oe3JlZjplLHJlZl9rZXk6dCxyZWZfZm9yOm59KT0+KCJudW1iZXIiPT10eXBlb2YgZSYmKGU9IiIrZSksbnVsbCE9ZT9NKGUpfHx0VChlKXx8UChlKT97aTp0OCxyOmUsazp0LGY6ISFufTplOm51bGwpO2Z1bmN0aW9uIGlnKGUsdD1udWxsLG49bnVsbCxyPTAsaT1udWxsLGw9KyhlIT09cjkpLHM9ITEsbz0hMSl7bGV0IGE9e19fdl9pc1ZOb2RlOiEwLF9fdl9za2lwOiEwLHR5cGU6ZSxwcm9wczp0LGtleTp0JiZpaCh0KSxyZWY6dCYmaW0odCksc2NvcGVJZDp0NSxzbG90U2NvcGVJZHM6bnVsbCxjaGlsZHJlbjpuLGNvbXBvbmVudDpudWxsLHN1c3BlbnNlOm51bGwsc3NDb250ZW50Om51bGwsc3NGYWxsYmFjazpudWxsLGRpcnM6bnVsbCx0cmFuc2l0aW9uOm51bGwsZWw6bnVsbCxhbmNob3I6bnVsbCx0YXJnZXQ6bnVsbCx0YXJnZXRTdGFydDpudWxsLHRhcmdldEFuY2hvcjpudWxsLHN0YXRpY0NvdW50OjAsc2hhcGVGbGFnOmwscGF0Y2hGbGFnOnIsZHluYW1pY1Byb3BzOmksZHluYW1pY0NoaWxkcmVuOm51bGwsYXBwQ29udGV4dDpudWxsLGN0eDp0OH07cmV0dXJuIG8/KGlDKGEsbiksMTI4JmwmJmUubm9ybWFsaXplKGEpKTpuJiYoYS5zaGFwZUZsYWd8PU0obik/ODoxNiksaW8+MCYmIXMmJmlpJiYoYS5wYXRjaEZsYWc+MHx8NiZsKSYmMzIhPT1hLnBhdGNoRmxhZyYmaWkucHVzaChhKSxhfWxldCBpdj1mdW5jdGlvbihlLHQ9bnVsbCxuPW51bGwscj0wLGk9bnVsbCxsPSExKXt2YXIgcztpZihlJiZlIT09bjh8fChlPWllKSxpZChlKSl7bGV0IHI9aWIoZSx0LCEwKTtyZXR1cm4gbiYmaUMocixuKSxpbz4wJiYhbCYmaWkmJig2JnIuc2hhcGVGbGFnP2lpW2lpLmluZGV4T2YoZSldPXI6aWkucHVzaChyKSksci5wYXRjaEZsYWc9LTIscn1pZihQKHM9ZSkmJiJfX3ZjY09wdHMiaW4gcyYmKGU9ZS5fX3ZjY09wdHMpLHQpe2xldHtjbGFzczplLHN0eWxlOm59PXQ9aXkodCk7ZSYmIU0oZSkmJih0LmNsYXNzPWVjKGUpKSwkKG4pJiYodF8obikmJiFFKG4pJiYobj1UKHt9LG4pKSx0LnN0eWxlPWVpKG4pKX1sZXQgbz1NKGUpPzE6cjEoZSk/MTI4OmUuX19pc1RlbGVwb3J0PzY0OiQoZSk/NDoyKiEhUChlKTtyZXR1cm4gaWcoZSx0LG4scixpLG8sbCwhMCl9O2Z1bmN0aW9uIGl5KGUpe3JldHVybiBlP3RfKGUpfHxyQyhlKT9UKHt9LGUpOmU6bnVsbH1mdW5jdGlvbiBpYihlLHQsbj0hMSxyPSExKXtsZXR7cHJvcHM6aSxyZWY6bCxwYXRjaEZsYWc6cyxjaGlsZHJlbjpvLHRyYW5zaXRpb246YX09ZSxjPXQ/aWsoaXx8e30sdCk6aSx1PXtfX3ZfaXNWTm9kZTohMCxfX3Zfc2tpcDohMCx0eXBlOmUudHlwZSxwcm9wczpjLGtleTpjJiZpaChjKSxyZWY6dCYmdC5yZWY/biYmbD9FKGwpP2wuY29uY2F0KGltKHQpKTpbbCxpbSh0KV06aW0odCk6bCxzY29wZUlkOmUuc2NvcGVJZCxzbG90U2NvcGVJZHM6ZS5zbG90U2NvcGVJZHMsY2hpbGRyZW46byx0YXJnZXQ6ZS50YXJnZXQsdGFyZ2V0U3RhcnQ6ZS50YXJnZXRTdGFydCx0YXJnZXRBbmNob3I6ZS50YXJnZXRBbmNob3Isc3RhdGljQ291bnQ6ZS5zdGF0aWNDb3VudCxzaGFwZUZsYWc6ZS5zaGFwZUZsYWcscGF0Y2hGbGFnOnQmJmUudHlwZSE9PXI5Py0xPT09cz8xNjoxNnxzOnMsZHluYW1pY1Byb3BzOmUuZHluYW1pY1Byb3BzLGR5bmFtaWNDaGlsZHJlbjplLmR5bmFtaWNDaGlsZHJlbixhcHBDb250ZXh0OmUuYXBwQ29udGV4dCxkaXJzOmUuZGlycyx0cmFuc2l0aW9uOmEsY29tcG9uZW50OmUuY29tcG9uZW50LHN1c3BlbnNlOmUuc3VzcGVuc2Usc3NDb250ZW50OmUuc3NDb250ZW50JiZpYihlLnNzQ29udGVudCksc3NGYWxsYmFjazplLnNzRmFsbGJhY2smJmliKGUuc3NGYWxsYmFjayksZWw6ZS5lbCxhbmNob3I6ZS5hbmNob3IsY3R4OmUuY3R4LGNlOmUuY2V9O3JldHVybiBhJiZyJiZuQyh1LGEuY2xvbmUodSkpLHV9ZnVuY3Rpb24gaV8oZT0iICIsdD0wKXtyZXR1cm4gaXYocjcsbnVsbCxlLHQpfWZ1bmN0aW9uIGlTKGUpe3JldHVybiBudWxsPT1lfHwiYm9vbGVhbiI9PXR5cGVvZiBlP2l2KGllKTpFKGUpP2l2KHI5LG51bGwsZS5zbGljZSgpKTppZChlKT9peChlKTppdihyNyxudWxsLFN0cmluZyhlKSl9ZnVuY3Rpb24gaXgoZSl7cmV0dXJuIG51bGw9PT1lLmVsJiYtMSE9PWUucGF0Y2hGbGFnfHxlLm1lbW8/ZTppYihlKX1mdW5jdGlvbiBpQyhlLHQpe2xldCBuPTAse3NoYXBlRmxhZzpyfT1lO2lmKG51bGw9PXQpdD1udWxsO2Vsc2UgaWYoRSh0KSluPTE2O2Vsc2UgaWYoIm9iamVjdCI9PXR5cGVvZiB0KWlmKDY1JnIpe2xldCBuPXQuZGVmYXVsdDtuJiYobi5fYyYmKG4uX2Q9ITEpLGlDKGUsbigpKSxuLl9jJiYobi5fZD0hMCkpO3JldHVybn1lbHNle249MzI7bGV0IHI9dC5fO3J8fHJDKHQpPzM9PT1yJiZ0OCYmKDE9PT10OC5zbG90cy5fP3QuXz0xOih0Ll89MixlLnBhdGNoRmxhZ3w9MTAyNCkpOnQuX2N0eD10OH1lbHNlIFAodCk/KHQ9e2RlZmF1bHQ6dCxfY3R4OnQ4fSxuPTMyKToodD1TdHJpbmcodCksNjQmcj8obj0xNix0PVtpXyh0KV0pOm49OCk7ZS5jaGlsZHJlbj10LGUuc2hhcGVGbGFnfD1ufWZ1bmN0aW9uIGlrKC4uLmUpe2xldCB0PXt9O2ZvcihsZXQgbj0wO248ZS5sZW5ndGg7bisrKXtsZXQgcj1lW25dO2ZvcihsZXQgZSBpbiByKWlmKCJjbGFzcyI9PT1lKXQuY2xhc3MhPT1yLmNsYXNzJiYodC5jbGFzcz1lYyhbdC5jbGFzcyxyLmNsYXNzXSkpO2Vsc2UgaWYoInN0eWxlIj09PWUpdC5zdHlsZT1laShbdC5zdHlsZSxyLnN0eWxlXSk7ZWxzZSBpZihDKGUpKXtsZXQgbj10W2VdLGk9cltlXTtpJiZuIT09aSYmIShFKG4pJiZuLmluY2x1ZGVzKGkpKSYmKHRbZV09bj9bXS5jb25jYXQobixpKTppKX1lbHNlIiIhPT1lJiYodFtlXT1yW2VdKX1yZXR1cm4gdH1mdW5jdGlvbiBpVChlLHQsbixyPW51bGwpe3RxKGUsdCw3LFtuLHJdKX1sZXQgaU49cmcoKSxpdz0wLGlBPW51bGwsaUU9KCk9PmlBfHx0ODtjPWU9PntpQT1lfSx1PWU9PntpUD1lfTtsZXQgaUk9ZT0+e2xldCB0PWlBO3JldHVybiBjKGUpLGUuc2NvcGUub24oKSwoKT0+e2Uuc2NvcGUub2ZmKCksYyh0KX19LGlSPSgpPT57aUEmJmlBLnNjb3BlLm9mZigpLGMobnVsbCl9O2Z1bmN0aW9uIGlPKGUpe3JldHVybiA0JmUudm5vZGUuc2hhcGVGbGFnfWxldCBpUD0hMTtmdW5jdGlvbiBpTShlLHQsbil7UCh0KT9lLnJlbmRlcj10OiQodCkmJihlLnNldHVwU3RhdGU9dE8odCkpLGkkKGUsbil9ZnVuY3Rpb24gaUwoZSl7ZD1lLHA9ZT0+e2UucmVuZGVyLl9yYyYmKGUud2l0aFByb3h5PW5ldyBQcm94eShlLmN0eCxycikpfX1mdW5jdGlvbiBpJChlLHQsbil7bGV0IHI9ZS50eXBlO2lmKCFlLnJlbmRlcil7aWYoIXQmJmQmJiFyLnJlbmRlcil7bGV0IHQ9ci50ZW1wbGF0ZXx8cmEoZSkudGVtcGxhdGU7aWYodCl7bGV0e2lzQ3VzdG9tRWxlbWVudDpuLGNvbXBpbGVyT3B0aW9uczppfT1lLmFwcENvbnRleHQuY29uZmlnLHtkZWxpbWl0ZXJzOmwsY29tcGlsZXJPcHRpb25zOnN9PXIsbz1UKFQoe2lzQ3VzdG9tRWxlbWVudDpuLGRlbGltaXRlcnM6bH0saSkscyk7ci5yZW5kZXI9ZCh0LG8pfX1lLnJlbmRlcj1yLnJlbmRlcnx8UyxwJiZwKGUpfXtsZXQgdD1pSShlKTtlTSgpO3RyeXshZnVuY3Rpb24oZSl7bGV0IHQ9cmEoZSksbj1lLnByb3h5LHI9ZS5jdHg7cnM9ITEsdC5iZWZvcmVDcmVhdGUmJnJvKHQuYmVmb3JlQ3JlYXRlLGUsImJjIik7bGV0e2RhdGE6aSxjb21wdXRlZDpsLG1ldGhvZHM6cyx3YXRjaDpvLHByb3ZpZGU6YSxpbmplY3Q6YyxjcmVhdGVkOnUsYmVmb3JlTW91bnQ6ZCxtb3VudGVkOnAsYmVmb3JlVXBkYXRlOmgsdXBkYXRlZDpmLGFjdGl2YXRlZDptLGRlYWN0aXZhdGVkOmcsYmVmb3JlRGVzdHJveTp5LGJlZm9yZVVubW91bnQ6YixkZXN0cm95ZWQ6Xyx1bm1vdW50ZWQ6eCxyZW5kZXI6QyxyZW5kZXJUcmFja2VkOmsscmVuZGVyVHJpZ2dlcmVkOlQsZXJyb3JDYXB0dXJlZDpOLHNlcnZlclByZWZldGNoOncsZXhwb3NlOkEsaW5oZXJpdEF0dHJzOkksY29tcG9uZW50czpSLGRpcmVjdGl2ZXM6TyxmaWx0ZXJzOkx9PXQ7aWYoYyYmZnVuY3Rpb24oZSx0LG49Uyl7Zm9yKGxldCBuIGluIEUoZSkmJihlPXJwKGUpKSxlKXtsZXQgcixpPWVbbl07dFQocj0kKGkpPyJkZWZhdWx0ImluIGk/cl8oaS5mcm9tfHxuLGkuZGVmYXVsdCwhMCk6cl8oaS5mcm9tfHxuKTpyXyhpKSk/T2JqZWN0LmRlZmluZVByb3BlcnR5KHQsbix7ZW51bWVyYWJsZTohMCxjb25maWd1cmFibGU6ITAsZ2V0OigpPT5yLnZhbHVlLHNldDplPT5yLnZhbHVlPWV9KTp0W25dPXJ9fShjLHIsbnVsbCkscylmb3IobGV0IGUgaW4gcyl7bGV0IHQ9c1tlXTtQKHQpJiYocltlXT10LmJpbmQobikpfWlmKGkpe2xldCB0PWkuY2FsbChuLG4pOyQodCkmJihlLmRhdGE9dGgodCkpfWlmKHJzPSEwLGwpZm9yKGxldCBlIGluIGwpe2xldCB0PWxbZV0saT1QKHQpP3QuYmluZChuLG4pOlAodC5nZXQpP3QuZ2V0LmJpbmQobixuKTpTLHM9aVUoe2dldDppLHNldDohUCh0KSYmUCh0LnNldCk/dC5zZXQuYmluZChuKTpTfSk7T2JqZWN0LmRlZmluZVByb3BlcnR5KHIsZSx7ZW51bWVyYWJsZTohMCxjb25maWd1cmFibGU6ITAsZ2V0OigpPT5zLnZhbHVlLHNldDplPT5zLnZhbHVlPWV9KX1pZihvKWZvcihsZXQgZSBpbiBvKSFmdW5jdGlvbiBlKHQsbixyLGkpe3ZhciBsLHMsbyxhLGMsdSxkO2xldCBwPWkuaW5jbHVkZXMoIi4iKT9ySyhyLGkpOigpPT5yW2ldO2lmKE0odCkpe2xldCBlPW5bdF07UChlKSYmKGw9cCxzPWUscnEobCxzLHZvaWQgMCkpfWVsc2UgaWYoUCh0KSl7bz1wLGE9dC5iaW5kKHIpLHJxKG8sYSx2b2lkIDApfWVsc2UgaWYoJCh0KSlpZihFKHQpKXQuZm9yRWFjaCh0PT5lKHQsbixyLGkpKTtlbHNle2xldCBlPVAodC5oYW5kbGVyKT90LmhhbmRsZXIuYmluZChyKTpuW3QuaGFuZGxlcl07UChlKSYmKGM9cCx1PWUsZD10LHJxKGMsdSxkKSl9fShvW2VdLHIsbixlKTtpZihhKXtsZXQgZT1QKGEpP2EuY2FsbChuKTphO1JlZmxlY3Qub3duS2V5cyhlKS5mb3JFYWNoKHQ9PntyYih0LGVbdF0pfSl9ZnVuY3Rpb24gRChlLHQpe0UodCk/dC5mb3JFYWNoKHQ9PmUodC5iaW5kKG4pKSk6dCYmZSh0LmJpbmQobikpfWlmKHUmJnJvKHUsZSwiYyIpLEQobkcsZCksRChuWCxwKSxEKG5RLGgpLEQoblosZiksRChuaixtKSxEKG5ILGcpLEQobjYsTiksRChuMyxrKSxEKG4yLFQpLEQoblksYiksRChuMCx4KSxEKG4xLHcpLEUoQSkpaWYoQS5sZW5ndGgpe2xldCB0PWUuZXhwb3NlZHx8KGUuZXhwb3NlZD17fSk7QS5mb3JFYWNoKGU9PntPYmplY3QuZGVmaW5lUHJvcGVydHkodCxlLHtnZXQ6KCk9Pm5bZV0sc2V0OnQ9Pm5bZV09dH0pfSl9ZWxzZSBlLmV4cG9zZWR8fChlLmV4cG9zZWQ9e30pO0MmJmUucmVuZGVyPT09UyYmKGUucmVuZGVyPUMpLG51bGwhPUkmJihlLmluaGVyaXRBdHRycz1JKSxSJiYoZS5jb21wb25lbnRzPVIpLE8mJihlLmRpcmVjdGl2ZXM9Tyl9KGUpfWZpbmFsbHl7ZUwoKSx0KCl9fX1sZXQgaUQ9e2dldDooZSx0KT0+KGVxKGUsImdldCIsIiIpLGVbdF0pfTtmdW5jdGlvbiBpRihlKXtyZXR1cm57YXR0cnM6bmV3IFByb3h5KGUuYXR0cnMsaUQpLHNsb3RzOmUuc2xvdHMsZW1pdDplLmVtaXQsZXhwb3NlOnQ9PntlLmV4cG9zZWQ9dHx8e319fX1mdW5jdGlvbiBpVihlKXtyZXR1cm4gZS5leHBvc2VkP2UuZXhwb3NlUHJveHl8fChlLmV4cG9zZVByb3h5PW5ldyBQcm94eSh0Tyh0eChlLmV4cG9zZWQpKSx7Z2V0Oih0LG4pPT5uIGluIHQ/dFtuXTpuIGluIHJlP3JlW25dKGUpOnZvaWQgMCxoYXM6KGUsdCk9PnQgaW4gZXx8dCBpbiByZX0pKTplLnByb3h5fWZ1bmN0aW9uIGlCKGUsdD0hMCl7cmV0dXJuIFAoZSk/ZS5kaXNwbGF5TmFtZXx8ZS5uYW1lOmUubmFtZXx8dCYmZS5fX25hbWV9bGV0IGlVPShlLHQpPT4oZnVuY3Rpb24oZSx0LG49ITEpe2xldCByLGk7cmV0dXJuIFAoZSk/cj1lOihyPWUuZ2V0LGk9ZS5zZXQpLG5ldyB0RihyLGksbil9KShlLDAsaVApO2Z1bmN0aW9uIGlqKGUsdCxuKXtsZXQgcj1hcmd1bWVudHMubGVuZ3RoO3JldHVybiAyIT09cj8ocj4zP249QXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLDIpOjM9PT1yJiZpZChuKSYmKG49W25dKSxpdihlLHQsbikpOiEkKHQpfHxFKHQpP2l2KGUsbnVsbCx0KTppZCh0KT9pdihlLG51bGwsW3RdKTppdihlLHQpfWZ1bmN0aW9uIGlIKGUsdCl7bGV0IG49ZS5tZW1vO2lmKG4ubGVuZ3RoIT10Lmxlbmd0aClyZXR1cm4hMTtmb3IobGV0IGU9MDtlPG4ubGVuZ3RoO2UrKylpZihRKG5bZV0sdFtlXSkpcmV0dXJuITE7cmV0dXJuIGlvPjAmJmlpJiZpaS5wdXNoKGUpLCEwfWxldCBpcT0iMy41LjE3IixpVz0idW5kZWZpbmVkIiE9dHlwZW9mIHdpbmRvdyYmd2luZG93LnRydXN0ZWRUeXBlcztpZihpVyl0cnl7Zz1pVy5jcmVhdGVQb2xpY3koInZ1ZSIse2NyZWF0ZUhUTUw6ZT0+ZX0pfWNhdGNoKGUpe31sZXQgaUs9Zz9lPT5nLmNyZWF0ZUhUTUwoZSk6ZT0+ZSxpej0idW5kZWZpbmVkIiE9dHlwZW9mIGRvY3VtZW50P2RvY3VtZW50Om51bGwsaUo9aXomJml6LmNyZWF0ZUVsZW1lbnQoInRlbXBsYXRlIiksaUc9InRyYW5zaXRpb24iLGlYPSJhbmltYXRpb24iLGlRPVN5bWJvbCgiX3Z0YyIpLGlaPXtuYW1lOlN0cmluZyx0eXBlOlN0cmluZyxjc3M6e3R5cGU6Qm9vbGVhbixkZWZhdWx0OiEwfSxkdXJhdGlvbjpbU3RyaW5nLE51bWJlcixPYmplY3RdLGVudGVyRnJvbUNsYXNzOlN0cmluZyxlbnRlckFjdGl2ZUNsYXNzOlN0cmluZyxlbnRlclRvQ2xhc3M6U3RyaW5nLGFwcGVhckZyb21DbGFzczpTdHJpbmcsYXBwZWFyQWN0aXZlQ2xhc3M6U3RyaW5nLGFwcGVhclRvQ2xhc3M6U3RyaW5nLGxlYXZlRnJvbUNsYXNzOlN0cmluZyxsZWF2ZUFjdGl2ZUNsYXNzOlN0cmluZyxsZWF2ZVRvQ2xhc3M6U3RyaW5nfSxpWT1UKHt9LG5tLGlaKSxpMD0oKHQ9KGUse3Nsb3RzOnR9KT0+aWoobnksaTMoZSksdCkpLmRpc3BsYXlOYW1lPSJUcmFuc2l0aW9uIix0LnByb3BzPWlZLHQpLGkxPShlLHQ9W10pPT57RShlKT9lLmZvckVhY2goZT0+ZSguLi50KSk6ZSYmZSguLi50KX0saTI9ZT0+ISFlJiYoRShlKT9lLnNvbWUoZT0+ZS5sZW5ndGg+MSk6ZS5sZW5ndGg+MSk7ZnVuY3Rpb24gaTMoZSl7bGV0IHQ9e307Zm9yKGxldCBuIGluIGUpbiBpbiBpWnx8KHRbbl09ZVtuXSk7aWYoITE9PT1lLmNzcylyZXR1cm4gdDtsZXR7bmFtZTpuPSJ2Iix0eXBlOnIsZHVyYXRpb246aSxlbnRlckZyb21DbGFzczpsPWAke259LWVudGVyLWZyb21gLGVudGVyQWN0aXZlQ2xhc3M6cz1gJHtufS1lbnRlci1hY3RpdmVgLGVudGVyVG9DbGFzczpvPWAke259LWVudGVyLXRvYCxhcHBlYXJGcm9tQ2xhc3M6YT1sLGFwcGVhckFjdGl2ZUNsYXNzOmM9cyxhcHBlYXJUb0NsYXNzOnU9byxsZWF2ZUZyb21DbGFzczpkPWAke259LWxlYXZlLWZyb21gLGxlYXZlQWN0aXZlQ2xhc3M6cD1gJHtufS1sZWF2ZS1hY3RpdmVgLGxlYXZlVG9DbGFzczpoPWAke259LWxlYXZlLXRvYH09ZSxmPWZ1bmN0aW9uKGUpe2lmKG51bGw9PWUpcmV0dXJuIG51bGw7e2lmKCQoZSkpcmV0dXJuW2Z1bmN0aW9uKGUpe3JldHVybiBldChlKX0oZS5lbnRlciksZnVuY3Rpb24oZSl7cmV0dXJuIGV0KGUpfShlLmxlYXZlKV07bGV0IHQ9ZnVuY3Rpb24oZSl7cmV0dXJuIGV0KGUpfShlKTtyZXR1cm5bdCx0XX19KGkpLG09ZiYmZlswXSxnPWYmJmZbMV0se29uQmVmb3JlRW50ZXI6eSxvbkVudGVyOmIsb25FbnRlckNhbmNlbGxlZDpfLG9uTGVhdmU6UyxvbkxlYXZlQ2FuY2VsbGVkOngsb25CZWZvcmVBcHBlYXI6Qz15LG9uQXBwZWFyOms9YixvbkFwcGVhckNhbmNlbGxlZDpOPV99PXQsdz0oZSx0LG4scik9PntlLl9lbnRlckNhbmNlbGxlZD1yLGk0KGUsdD91Om8pLGk0KGUsdD9jOnMpLG4mJm4oKX0sQT0oZSx0KT0+e2UuX2lzTGVhdmluZz0hMSxpNChlLGQpLGk0KGUsaCksaTQoZSxwKSx0JiZ0KCl9LEU9ZT0+KHQsbik9PntsZXQgaT1lP2s6YixzPSgpPT53KHQsZSxuKTtpMShpLFt0LHNdKSxpOCgoKT0+e2k0KHQsZT9hOmwpLGk2KHQsZT91Om8pLGkyKGkpfHxpOSh0LHIsbSxzKX0pfTtyZXR1cm4gVCh0LHtvbkJlZm9yZUVudGVyKGUpe2kxKHksW2VdKSxpNihlLGwpLGk2KGUscyl9LG9uQmVmb3JlQXBwZWFyKGUpe2kxKEMsW2VdKSxpNihlLGEpLGk2KGUsYyl9LG9uRW50ZXI6RSghMSksb25BcHBlYXI6RSghMCksb25MZWF2ZShlLHQpe2UuX2lzTGVhdmluZz0hMDtsZXQgbj0oKT0+QShlLHQpO2k2KGUsZCksZS5fZW50ZXJDYW5jZWxsZWQ/KGk2KGUscCksbG4oKSk6KGxuKCksaTYoZSxwKSksaTgoKCk9PntlLl9pc0xlYXZpbmcmJihpNChlLGQpLGk2KGUsaCksaTIoUyl8fGk5KGUscixnLG4pKX0pLGkxKFMsW2Usbl0pfSxvbkVudGVyQ2FuY2VsbGVkKGUpe3coZSwhMSx2b2lkIDAsITApLGkxKF8sW2VdKX0sb25BcHBlYXJDYW5jZWxsZWQoZSl7dyhlLCEwLHZvaWQgMCwhMCksaTEoTixbZV0pfSxvbkxlYXZlQ2FuY2VsbGVkKGUpe0EoZSksaTEoeCxbZV0pfX0pfWZ1bmN0aW9uIGk2KGUsdCl7dC5zcGxpdCgvXHMrLykuZm9yRWFjaCh0PT50JiZlLmNsYXNzTGlzdC5hZGQodCkpLChlW2lRXXx8KGVbaVFdPW5ldyBTZXQpKS5hZGQodCl9ZnVuY3Rpb24gaTQoZSx0KXt0LnNwbGl0KC9ccysvKS5mb3JFYWNoKHQ9PnQmJmUuY2xhc3NMaXN0LnJlbW92ZSh0KSk7bGV0IG49ZVtpUV07biYmKG4uZGVsZXRlKHQpLG4uc2l6ZXx8KGVbaVFdPXZvaWQgMCkpfWZ1bmN0aW9uIGk4KGUpe3JlcXVlc3RBbmltYXRpb25GcmFtZSgoKT0+e3JlcXVlc3RBbmltYXRpb25GcmFtZShlKX0pfWxldCBpNT0wO2Z1bmN0aW9uIGk5KGUsdCxuLHIpe2xldCBpPWUuX2VuZElkPSsraTUsbD0oKT0+e2k9PT1lLl9lbmRJZCYmcigpfTtpZihudWxsIT1uKXJldHVybiBzZXRUaW1lb3V0KGwsbik7bGV0e3R5cGU6cyx0aW1lb3V0Om8scHJvcENvdW50OmF9PWk3KGUsdCk7aWYoIXMpcmV0dXJuIHIoKTtsZXQgYz1zKyJlbmQiLHU9MCxkPSgpPT57ZS5yZW1vdmVFdmVudExpc3RlbmVyKGMscCksbCgpfSxwPXQ9Pnt0LnRhcmdldD09PWUmJisrdT49YSYmZCgpfTtzZXRUaW1lb3V0KCgpPT57dTxhJiZkKCl9LG8rMSksZS5hZGRFdmVudExpc3RlbmVyKGMscCl9ZnVuY3Rpb24gaTcoZSx0KXtsZXQgbj13aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlKSxyPWU9PihuW2VdfHwiIikuc3BsaXQoIiwgIiksaT1yKGAke2lHfURlbGF5YCksbD1yKGAke2lHfUR1cmF0aW9uYCkscz1sZShpLGwpLG89cihgJHtpWH1EZWxheWApLGE9cihgJHtpWH1EdXJhdGlvbmApLGM9bGUobyxhKSx1PW51bGwsZD0wLHA9MDt0PT09aUc/cz4wJiYodT1pRyxkPXMscD1sLmxlbmd0aCk6dD09PWlYP2M+MCYmKHU9aVgsZD1jLHA9YS5sZW5ndGgpOnA9KHU9KGQ9TWF0aC5tYXgocyxjKSk+MD9zPmM/aUc6aVg6bnVsbCk/dT09PWlHP2wubGVuZ3RoOmEubGVuZ3RoOjA7bGV0IGg9dT09PWlHJiYvXGIodHJhbnNmb3JtfGFsbCkoLHwkKS8udGVzdChyKGAke2lHfVByb3BlcnR5YCkudG9TdHJpbmcoKSk7cmV0dXJue3R5cGU6dSx0aW1lb3V0OmQscHJvcENvdW50OnAsaGFzVHJhbnNmb3JtOmh9fWZ1bmN0aW9uIGxlKGUsdCl7Zm9yKDtlLmxlbmd0aDx0Lmxlbmd0aDspZT1lLmNvbmNhdChlKTtyZXR1cm4gTWF0aC5tYXgoLi4udC5tYXAoKHQsbik9Pmx0KHQpK2x0KGVbbl0pKSl9ZnVuY3Rpb24gbHQoZSl7cmV0dXJuImF1dG8iPT09ZT8wOjFlMypOdW1iZXIoZS5zbGljZSgwLC0xKS5yZXBsYWNlKCIsIiwiLiIpKX1mdW5jdGlvbiBsbigpe3JldHVybiBkb2N1bWVudC5ib2R5Lm9mZnNldEhlaWdodH1sZXQgbHI9U3ltYm9sKCJfdm9kIiksbGk9U3ltYm9sKCJfdnNoIik7ZnVuY3Rpb24gbGwoZSx0KXtlLnN0eWxlLmRpc3BsYXk9dD9lW2xyXToibm9uZSIsZVtsaV09IXR9bGV0IGxzPVN5bWJvbCgiIik7ZnVuY3Rpb24gbG8oZSx0KXtpZigxPT09ZS5ub2RlVHlwZSl7bGV0IG49ZS5zdHlsZSxyPSIiO2ZvcihsZXQgZSBpbiB0KW4uc2V0UHJvcGVydHkoYC0tJHtlfWAsdFtlXSkscis9YC0tJHtlfTogJHt0W2VdfTtgO25bbHNdPXJ9fWxldCBsYT0vKF58OylccypkaXNwbGF5XHMqOi8sbGM9L1xzKiFpbXBvcnRhbnQkLztmdW5jdGlvbiBsdShlLHQsbil7aWYoRShuKSluLmZvckVhY2gobj0+bHUoZSx0LG4pKTtlbHNlIGlmKG51bGw9PW4mJihuPSIiKSx0LnN0YXJ0c1dpdGgoIi0tIikpZS5zZXRQcm9wZXJ0eSh0LG4pO2Vsc2V7bGV0IHI9ZnVuY3Rpb24oZSx0KXtsZXQgbj1scFt0XTtpZihuKXJldHVybiBuO2xldCByPUsodCk7aWYoImZpbHRlciIhPT1yJiZyIGluIGUpcmV0dXJuIGxwW3RdPXI7cj1HKHIpO2ZvcihsZXQgbj0wO248bGQubGVuZ3RoO24rKyl7bGV0IGk9bGRbbl0rcjtpZihpIGluIGUpcmV0dXJuIGxwW3RdPWl9cmV0dXJuIHR9KGUsdCk7bGMudGVzdChuKT9lLnNldFByb3BlcnR5KEoociksbi5yZXBsYWNlKGxjLCIiKSwiaW1wb3J0YW50Iik6ZVtyXT1ufX1sZXQgbGQ9WyJXZWJraXQiLCJNb3oiLCJtcyJdLGxwPXt9LGxoPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIjtmdW5jdGlvbiBsZihlLHQsbixyLGksbD1lZih0KSl7aWYociYmdC5zdGFydHNXaXRoKCJ4bGluazoiKSludWxsPT1uP2UucmVtb3ZlQXR0cmlidXRlTlMobGgsdC5zbGljZSg2LHQubGVuZ3RoKSk6ZS5zZXRBdHRyaWJ1dGVOUyhsaCx0LG4pO2Vsc2UgbnVsbD09bnx8bCYmIShufHwiIj09PW4pP2UucmVtb3ZlQXR0cmlidXRlKHQpOmUuc2V0QXR0cmlidXRlKHQsbD8iIjpMKG4pP1N0cmluZyhuKTpuKX1mdW5jdGlvbiBsbShlLHQsbixyLGkpe2lmKCJpbm5lckhUTUwiPT09dHx8InRleHRDb250ZW50Ij09PXQpe251bGwhPW4mJihlW3RdPSJpbm5lckhUTUwiPT09dD9pSyhuKTpuKTtyZXR1cm59bGV0IGw9ZS50YWdOYW1lO2lmKCJ2YWx1ZSI9PT10JiYiUFJPR1JFU1MiIT09bCYmIWwuaW5jbHVkZXMoIi0iKSl7bGV0IHI9Ik9QVElPTiI9PT1sP2UuZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpfHwiIjplLnZhbHVlLGk9bnVsbD09bj8iY2hlY2tib3giPT09ZS50eXBlPyJvbiI6IiI6U3RyaW5nKG4pO3I9PT1pJiYiX3ZhbHVlImluIGV8fChlLnZhbHVlPWkpLG51bGw9PW4mJmUucmVtb3ZlQXR0cmlidXRlKHQpLGUuX3ZhbHVlPW47cmV0dXJufWxldCBzPSExO2lmKCIiPT09bnx8bnVsbD09bil7bGV0IHI9dHlwZW9mIGVbdF07aWYoImJvb2xlYW4iPT09cil7dmFyIG87bj0hIShvPW4pfHwiIj09PW99ZWxzZSBudWxsPT1uJiYic3RyaW5nIj09PXI/KG49IiIscz0hMCk6Im51bWJlciI9PT1yJiYobj0wLHM9ITApfXRyeXtlW3RdPW59Y2F0Y2goZSl7fXMmJmUucmVtb3ZlQXR0cmlidXRlKGl8fHQpfWZ1bmN0aW9uIGxnKGUsdCxuLHIpe2UuYWRkRXZlbnRMaXN0ZW5lcih0LG4scil9bGV0IGx2PVN5bWJvbCgiX3ZlaSIpLGx5PS8oPzpPbmNlfFBhc3NpdmV8Q2FwdHVyZSkkLyxsYj0wLGxfPVByb21pc2UucmVzb2x2ZSgpLGxTPWU9PjExMT09PWUuY2hhckNvZGVBdCgwKSYmMTEwPT09ZS5jaGFyQ29kZUF0KDEpJiZlLmNoYXJDb2RlQXQoMik+OTYmJjEyMz5lLmNoYXJDb2RlQXQoMiksbHg9e307ZnVuY3Rpb24gbEMoZSx0LG4pe2xldCByPW5UKGUsdCk7QihyKSYmVChyLHQpO2NsYXNzIGkgZXh0ZW5kcyBsVHtjb25zdHJ1Y3RvcihlKXtzdXBlcihyLGUsbil9fXJldHVybiBpLmRlZj1yLGl9bGV0IGxrPSJ1bmRlZmluZWQiIT10eXBlb2YgSFRNTEVsZW1lbnQ/SFRNTEVsZW1lbnQ6Y2xhc3N7fTtjbGFzcyBsVCBleHRlbmRzIGxre2NvbnN0cnVjdG9yKGUsdD17fSxuPWwxKXtzdXBlcigpLHRoaXMuX2RlZj1lLHRoaXMuX3Byb3BzPXQsdGhpcy5fY3JlYXRlQXBwPW4sdGhpcy5faXNWdWVDRT0hMCx0aGlzLl9pbnN0YW5jZT1udWxsLHRoaXMuX2FwcD1udWxsLHRoaXMuX25vbmNlPXRoaXMuX2RlZi5ub25jZSx0aGlzLl9jb25uZWN0ZWQ9ITEsdGhpcy5fcmVzb2x2ZWQ9ITEsdGhpcy5fbnVtYmVyUHJvcHM9bnVsbCx0aGlzLl9zdHlsZUNoaWxkcmVuPW5ldyBXZWFrU2V0LHRoaXMuX29iPW51bGwsdGhpcy5zaGFkb3dSb290JiZuIT09bDE/dGhpcy5fcm9vdD10aGlzLnNoYWRvd1Jvb3Q6ITEhPT1lLnNoYWRvd1Jvb3Q/KHRoaXMuYXR0YWNoU2hhZG93KHttb2RlOiJvcGVuIn0pLHRoaXMuX3Jvb3Q9dGhpcy5zaGFkb3dSb290KTp0aGlzLl9yb290PXRoaXN9Y29ubmVjdGVkQ2FsbGJhY2soKXtpZighdGhpcy5pc0Nvbm5lY3RlZClyZXR1cm47dGhpcy5zaGFkb3dSb290fHx0aGlzLl9yZXNvbHZlZHx8dGhpcy5fcGFyc2VTbG90cygpLHRoaXMuX2Nvbm5lY3RlZD0hMDtsZXQgZT10aGlzO2Zvcig7ZT1lJiYoZS5wYXJlbnROb2RlfHxlLmhvc3QpOylpZihlIGluc3RhbmNlb2YgbFQpe3RoaXMuX3BhcmVudD1lO2JyZWFrfXRoaXMuX2luc3RhbmNlfHwodGhpcy5fcmVzb2x2ZWQ/dGhpcy5fbW91bnQodGhpcy5fZGVmKTplJiZlLl9wZW5kaW5nUmVzb2x2ZT90aGlzLl9wZW5kaW5nUmVzb2x2ZT1lLl9wZW5kaW5nUmVzb2x2ZS50aGVuKCgpPT57dGhpcy5fcGVuZGluZ1Jlc29sdmU9dm9pZCAwLHRoaXMuX3Jlc29sdmVEZWYoKX0pOnRoaXMuX3Jlc29sdmVEZWYoKSl9X3NldFBhcmVudChlPXRoaXMuX3BhcmVudCl7ZSYmKHRoaXMuX2luc3RhbmNlLnBhcmVudD1lLl9pbnN0YW5jZSx0aGlzLl9pbmhlcml0UGFyZW50Q29udGV4dChlKSl9X2luaGVyaXRQYXJlbnRDb250ZXh0KGU9dGhpcy5fcGFyZW50KXtlJiZ0aGlzLl9hcHAmJk9iamVjdC5zZXRQcm90b3R5cGVPZih0aGlzLl9hcHAuX2NvbnRleHQucHJvdmlkZXMsZS5faW5zdGFuY2UucHJvdmlkZXMpfWRpc2Nvbm5lY3RlZENhbGxiYWNrKCl7dGhpcy5fY29ubmVjdGVkPSExLHRZKCgpPT57dGhpcy5fY29ubmVjdGVkfHwodGhpcy5fb2ImJih0aGlzLl9vYi5kaXNjb25uZWN0KCksdGhpcy5fb2I9bnVsbCksdGhpcy5fYXBwJiZ0aGlzLl9hcHAudW5tb3VudCgpLHRoaXMuX2luc3RhbmNlJiYodGhpcy5faW5zdGFuY2UuY2U9dm9pZCAwKSx0aGlzLl9hcHA9dGhpcy5faW5zdGFuY2U9bnVsbCl9KX1fcmVzb2x2ZURlZigpe2lmKHRoaXMuX3BlbmRpbmdSZXNvbHZlKXJldHVybjtmb3IobGV0IGU9MDtlPHRoaXMuYXR0cmlidXRlcy5sZW5ndGg7ZSsrKXRoaXMuX3NldEF0dHIodGhpcy5hdHRyaWJ1dGVzW2VdLm5hbWUpO3RoaXMuX29iPW5ldyBNdXRhdGlvbk9ic2VydmVyKGU9Pntmb3IobGV0IHQgb2YgZSl0aGlzLl9zZXRBdHRyKHQuYXR0cmlidXRlTmFtZSl9KSx0aGlzLl9vYi5vYnNlcnZlKHRoaXMse2F0dHJpYnV0ZXM6ITB9KTtsZXQgZT0oZSx0PSExKT0+e2xldCBuO3RoaXMuX3Jlc29sdmVkPSEwLHRoaXMuX3BlbmRpbmdSZXNvbHZlPXZvaWQgMDtsZXR7cHJvcHM6cixzdHlsZXM6aX09ZTtpZihyJiYhRShyKSlmb3IobGV0IGUgaW4gcil7bGV0IHQ9cltlXTsodD09PU51bWJlcnx8dCYmdC50eXBlPT09TnVtYmVyKSYmKGUgaW4gdGhpcy5fcHJvcHMmJih0aGlzLl9wcm9wc1tlXT1ldCh0aGlzLl9wcm9wc1tlXSkpLChufHwobj1PYmplY3QuY3JlYXRlKG51bGwpKSlbSyhlKV09ITApfXRoaXMuX251bWJlclByb3BzPW4sdGhpcy5fcmVzb2x2ZVByb3BzKGUpLHRoaXMuc2hhZG93Um9vdCYmdGhpcy5fYXBwbHlTdHlsZXMoaSksdGhpcy5fbW91bnQoZSl9LHQ9dGhpcy5fZGVmLl9fYXN5bmNMb2FkZXI7dD90aGlzLl9wZW5kaW5nUmVzb2x2ZT10KCkudGhlbih0PT57dC5jb25maWd1cmVBcHA9dGhpcy5fZGVmLmNvbmZpZ3VyZUFwcCxlKHRoaXMuX2RlZj10LCEwKX0pOmUodGhpcy5fZGVmKX1fbW91bnQoZSl7dGhpcy5fYXBwPXRoaXMuX2NyZWF0ZUFwcChlKSx0aGlzLl9pbmhlcml0UGFyZW50Q29udGV4dCgpLGUuY29uZmlndXJlQXBwJiZlLmNvbmZpZ3VyZUFwcCh0aGlzLl9hcHApLHRoaXMuX2FwcC5fY2VWTm9kZT10aGlzLl9jcmVhdGVWTm9kZSgpLHRoaXMuX2FwcC5tb3VudCh0aGlzLl9yb290KTtsZXQgdD10aGlzLl9pbnN0YW5jZSYmdGhpcy5faW5zdGFuY2UuZXhwb3NlZDtpZih0KWZvcihsZXQgZSBpbiB0KUEodGhpcyxlKXx8T2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsZSx7Z2V0OigpPT50SSh0W2VdKX0pfV9yZXNvbHZlUHJvcHMoZSl7bGV0e3Byb3BzOnR9PWUsbj1FKHQpP3Q6T2JqZWN0LmtleXModHx8e30pO2ZvcihsZXQgZSBvZiBPYmplY3Qua2V5cyh0aGlzKSkiXyIhPT1lWzBdJiZuLmluY2x1ZGVzKGUpJiZ0aGlzLl9zZXRQcm9wKGUsdGhpc1tlXSk7Zm9yKGxldCBlIG9mIG4ubWFwKEspKU9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLGUse2dldCgpe3JldHVybiB0aGlzLl9nZXRQcm9wKGUpfSxzZXQodCl7dGhpcy5fc2V0UHJvcChlLHQsITAsITApfX0pfV9zZXRBdHRyKGUpe2lmKGUuc3RhcnRzV2l0aCgiZGF0YS12LSIpKXJldHVybjtsZXQgdD10aGlzLmhhc0F0dHJpYnV0ZShlKSxuPXQ/dGhpcy5nZXRBdHRyaWJ1dGUoZSk6bHgscj1LKGUpO3QmJnRoaXMuX251bWJlclByb3BzJiZ0aGlzLl9udW1iZXJQcm9wc1tyXSYmKG49ZXQobikpLHRoaXMuX3NldFByb3AocixuLCExLCEwKX1fZ2V0UHJvcChlKXtyZXR1cm4gdGhpcy5fcHJvcHNbZV19X3NldFByb3AoZSx0LG49ITAscj0hMSl7aWYodCE9PXRoaXMuX3Byb3BzW2VdJiYodD09PWx4P2RlbGV0ZSB0aGlzLl9wcm9wc1tlXToodGhpcy5fcHJvcHNbZV09dCwia2V5Ij09PWUmJnRoaXMuX2FwcCYmKHRoaXMuX2FwcC5fY2VWTm9kZS5rZXk9dCkpLHImJnRoaXMuX2luc3RhbmNlJiZ0aGlzLl91cGRhdGUoKSxuKSl7bGV0IG49dGhpcy5fb2I7biYmbi5kaXNjb25uZWN0KCksITA9PT10P3RoaXMuc2V0QXR0cmlidXRlKEooZSksIiIpOiJzdHJpbmciPT10eXBlb2YgdHx8Im51bWJlciI9PXR5cGVvZiB0P3RoaXMuc2V0QXR0cmlidXRlKEooZSksdCsiIik6dHx8dGhpcy5yZW1vdmVBdHRyaWJ1dGUoSihlKSksbiYmbi5vYnNlcnZlKHRoaXMse2F0dHJpYnV0ZXM6ITB9KX19X3VwZGF0ZSgpe2xldCBlPXRoaXMuX2NyZWF0ZVZOb2RlKCk7dGhpcy5fYXBwJiYoZS5hcHBDb250ZXh0PXRoaXMuX2FwcC5fY29udGV4dCksbDAoZSx0aGlzLl9yb290KX1fY3JlYXRlVk5vZGUoKXtsZXQgZT17fTt0aGlzLnNoYWRvd1Jvb3R8fChlLm9uVm5vZGVNb3VudGVkPWUub25Wbm9kZVVwZGF0ZWQ9dGhpcy5fcmVuZGVyU2xvdHMuYmluZCh0aGlzKSk7bGV0IHQ9aXYodGhpcy5fZGVmLFQoZSx0aGlzLl9wcm9wcykpO3JldHVybiB0aGlzLl9pbnN0YW5jZXx8KHQuY2U9ZT0+e3RoaXMuX2luc3RhbmNlPWUsZS5jZT10aGlzLGUuaXNDRT0hMDtsZXQgdD0oZSx0KT0+e3RoaXMuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoZSxCKHRbMF0pP1Qoe2RldGFpbDp0fSx0WzBdKTp7ZGV0YWlsOnR9KSl9O2UuZW1pdD0oZSwuLi5uKT0+e3QoZSxuKSxKKGUpIT09ZSYmdChKKGUpLG4pfSx0aGlzLl9zZXRQYXJlbnQoKX0pLHR9X2FwcGx5U3R5bGVzKGUsdCl7aWYoIWUpcmV0dXJuO2lmKHQpe2lmKHQ9PT10aGlzLl9kZWZ8fHRoaXMuX3N0eWxlQ2hpbGRyZW4uaGFzKHQpKXJldHVybjt0aGlzLl9zdHlsZUNoaWxkcmVuLmFkZCh0KX1sZXQgbj10aGlzLl9ub25jZTtmb3IobGV0IHQ9ZS5sZW5ndGgtMTt0Pj0wO3QtLSl7bGV0IHI9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTtuJiZyLnNldEF0dHJpYnV0ZSgibm9uY2UiLG4pLHIudGV4dENvbnRlbnQ9ZVt0XSx0aGlzLnNoYWRvd1Jvb3QucHJlcGVuZChyKX19X3BhcnNlU2xvdHMoKXtsZXQgZSx0PXRoaXMuX3Nsb3RzPXt9O2Zvcig7ZT10aGlzLmZpcnN0Q2hpbGQ7KXtsZXQgbj0xPT09ZS5ub2RlVHlwZSYmZS5nZXRBdHRyaWJ1dGUoInNsb3QiKXx8ImRlZmF1bHQiOyh0W25dfHwodFtuXT1bXSkpLnB1c2goZSksdGhpcy5yZW1vdmVDaGlsZChlKX19X3JlbmRlclNsb3RzKCl7bGV0IGU9KHRoaXMuX3RlbGVwb3J0VGFyZ2V0fHx0aGlzKS5xdWVyeVNlbGVjdG9yQWxsKCJzbG90IiksdD10aGlzLl9pbnN0YW5jZS50eXBlLl9fc2NvcGVJZDtmb3IobGV0IG49MDtuPGUubGVuZ3RoO24rKyl7bGV0IHI9ZVtuXSxpPXIuZ2V0QXR0cmlidXRlKCJuYW1lIil8fCJkZWZhdWx0IixsPXRoaXMuX3Nsb3RzW2ldLHM9ci5wYXJlbnROb2RlO2lmKGwpZm9yKGxldCBlIG9mIGwpe2lmKHQmJjE9PT1lLm5vZGVUeXBlKXtsZXQgbixyPXQrIi1zIixpPWRvY3VtZW50LmNyZWF0ZVRyZWVXYWxrZXIoZSwxKTtmb3IoZS5zZXRBdHRyaWJ1dGUociwiIik7bj1pLm5leHROb2RlKCk7KW4uc2V0QXR0cmlidXRlKHIsIiIpfXMuaW5zZXJ0QmVmb3JlKGUscil9ZWxzZSBmb3IoO3IuZmlyc3RDaGlsZDspcy5pbnNlcnRCZWZvcmUoci5maXJzdENoaWxkLHIpO3MucmVtb3ZlQ2hpbGQocil9fV9pbmplY3RDaGlsZFN0eWxlKGUpe3RoaXMuX2FwcGx5U3R5bGVzKGUuc3R5bGVzLGUpfV9yZW1vdmVDaGlsZFN0eWxlKGUpe319ZnVuY3Rpb24gbE4oZSl7bGV0IHQ9aUUoKSxuPXQmJnQuY2U7cmV0dXJuIG58fG51bGx9bGV0IGx3PW5ldyBXZWFrTWFwLGxBPW5ldyBXZWFrTWFwLGxFPVN5bWJvbCgiX21vdmVDYiIpLGxJPVN5bWJvbCgiX2VudGVyQ2IiKSxsUj0obj17bmFtZToiVHJhbnNpdGlvbkdyb3VwIixwcm9wczpUKHt9LGlZLHt0YWc6U3RyaW5nLG1vdmVDbGFzczpTdHJpbmd9KSxzZXR1cChlLHtzbG90czp0fSl7bGV0IG4scixpPWlFKCksbD1uaCgpO3JldHVybiBuWigoKT0+e2lmKCFuLmxlbmd0aClyZXR1cm47bGV0IHQ9ZS5tb3ZlQ2xhc3N8fGAke2UubmFtZXx8InYifS1tb3ZlYDtpZighZnVuY3Rpb24oZSx0LG4pe2xldCByPWUuY2xvbmVOb2RlKCksaT1lW2lRXTtpJiZpLmZvckVhY2goZT0+e2Uuc3BsaXQoL1xzKy8pLmZvckVhY2goZT0+ZSYmci5jbGFzc0xpc3QucmVtb3ZlKGUpKX0pLG4uc3BsaXQoL1xzKy8pLmZvckVhY2goZT0+ZSYmci5jbGFzc0xpc3QuYWRkKGUpKSxyLnN0eWxlLmRpc3BsYXk9Im5vbmUiO2xldCBsPTE9PT10Lm5vZGVUeXBlP3Q6dC5wYXJlbnROb2RlO2wuYXBwZW5kQ2hpbGQocik7bGV0e2hhc1RyYW5zZm9ybTpzfT1pNyhyKTtyZXR1cm4gbC5yZW1vdmVDaGlsZChyKSxzfShuWzBdLmVsLGkudm5vZGUuZWwsdCkpe249W107cmV0dXJufW4uZm9yRWFjaChsTyksbi5mb3JFYWNoKGxQKTtsZXQgcj1uLmZpbHRlcihsTSk7bG4oKSxyLmZvckVhY2goZT0+e2xldCBuPWUuZWwscj1uLnN0eWxlO2k2KG4sdCksci50cmFuc2Zvcm09ci53ZWJraXRUcmFuc2Zvcm09ci50cmFuc2l0aW9uRHVyYXRpb249IiI7bGV0IGk9bltsRV09ZT0+eyghZXx8ZS50YXJnZXQ9PT1uKSYmKCFlfHwvdHJhbnNmb3JtJC8udGVzdChlLnByb3BlcnR5TmFtZSkpJiYobi5yZW1vdmVFdmVudExpc3RlbmVyKCJ0cmFuc2l0aW9uZW5kIixpKSxuW2xFXT1udWxsLGk0KG4sdCkpfTtuLmFkZEV2ZW50TGlzdGVuZXIoInRyYW5zaXRpb25lbmQiLGkpfSksbj1bXX0pLCgpPT57bGV0IHM9dFMoZSksbz1pMyhzKSxhPXMudGFnfHxyOTtpZihuPVtdLHIpZm9yKGxldCBlPTA7ZTxyLmxlbmd0aDtlKyspe2xldCB0PXJbZV07dC5lbCYmdC5lbCBpbnN0YW5jZW9mIEVsZW1lbnQmJihuLnB1c2godCksbkModCxuXyh0LG8sbCxpKSksbHcuc2V0KHQsdC5lbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSkpfXI9dC5kZWZhdWx0P25rKHQuZGVmYXVsdCgpKTpbXTtmb3IobGV0IGU9MDtlPHIubGVuZ3RoO2UrKyl7bGV0IHQ9cltlXTtudWxsIT10LmtleSYmbkModCxuXyh0LG8sbCxpKSl9cmV0dXJuIGl2KGEsbnVsbCxyKX19fSxkZWxldGUgbi5wcm9wcy5tb2RlLG4pO2Z1bmN0aW9uIGxPKGUpe2xldCB0PWUuZWw7dFtsRV0mJnRbbEVdKCksdFtsSV0mJnRbbEldKCl9ZnVuY3Rpb24gbFAoZSl7bEEuc2V0KGUsZS5lbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSl9ZnVuY3Rpb24gbE0oZSl7bGV0IHQ9bHcuZ2V0KGUpLG49bEEuZ2V0KGUpLHI9dC5sZWZ0LW4ubGVmdCxpPXQudG9wLW4udG9wO2lmKHJ8fGkpe2xldCB0PWUuZWwuc3R5bGU7cmV0dXJuIHQudHJhbnNmb3JtPXQud2Via2l0VHJhbnNmb3JtPWB0cmFuc2xhdGUoJHtyfXB4LCR7aX1weClgLHQudHJhbnNpdGlvbkR1cmF0aW9uPSIwcyIsZX19bGV0IGxMPWU9PntsZXQgdD1lLnByb3BzWyJvblVwZGF0ZTptb2RlbFZhbHVlIl18fCExO3JldHVybiBFKHQpP2U9PloodCxlKTp0fTtmdW5jdGlvbiBsJChlKXtlLnRhcmdldC5jb21wb3Npbmc9ITB9ZnVuY3Rpb24gbEQoZSl7bGV0IHQ9ZS50YXJnZXQ7dC5jb21wb3NpbmcmJih0LmNvbXBvc2luZz0hMSx0LmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KCJpbnB1dCIpKSl9bGV0IGxGPVN5bWJvbCgiX2Fzc2lnbiIpLGxWPXtjcmVhdGVkKGUse21vZGlmaWVyczp7bGF6eTp0LHRyaW06bixudW1iZXI6cn19LGkpe2VbbEZdPWxMKGkpO2xldCBsPXJ8fGkucHJvcHMmJiJudW1iZXIiPT09aS5wcm9wcy50eXBlO2xnKGUsdD8iY2hhbmdlIjoiaW5wdXQiLHQ9PntpZih0LnRhcmdldC5jb21wb3NpbmcpcmV0dXJuO2xldCByPWUudmFsdWU7biYmKHI9ci50cmltKCkpLGwmJihyPWVlKHIpKSxlW2xGXShyKX0pLG4mJmxnKGUsImNoYW5nZSIsKCk9PntlLnZhbHVlPWUudmFsdWUudHJpbSgpfSksdHx8KGxnKGUsImNvbXBvc2l0aW9uc3RhcnQiLGwkKSxsZyhlLCJjb21wb3NpdGlvbmVuZCIsbEQpLGxnKGUsImNoYW5nZSIsbEQpKX0sbW91bnRlZChlLHt2YWx1ZTp0fSl7ZS52YWx1ZT1udWxsPT10PyIiOnR9LGJlZm9yZVVwZGF0ZShlLHt2YWx1ZTp0LG9sZFZhbHVlOm4sbW9kaWZpZXJzOntsYXp5OnIsdHJpbTppLG51bWJlcjpsfX0scyl7aWYoZVtsRl09bEwocyksZS5jb21wb3NpbmcpcmV0dXJuO2xldCBvPShsfHwibnVtYmVyIj09PWUudHlwZSkmJiEvXjBcZC8udGVzdChlLnZhbHVlKT9lZShlLnZhbHVlKTplLnZhbHVlLGE9bnVsbD09dD8iIjp0O2lmKG8hPT1hKXtpZihkb2N1bWVudC5hY3RpdmVFbGVtZW50PT09ZSYmInJhbmdlIiE9PWUudHlwZSYmKHImJnQ9PT1ufHxpJiZlLnZhbHVlLnRyaW0oKT09PWEpKXJldHVybjtlLnZhbHVlPWF9fX0sbEI9e2RlZXA6ITAsY3JlYXRlZChlLHQsbil7ZVtsRl09bEwobiksbGcoZSwiY2hhbmdlIiwoKT0+e2xldCB0PWUuX21vZGVsVmFsdWUsbj1sVyhlKSxyPWUuY2hlY2tlZCxpPWVbbEZdO2lmKEUodCkpe2xldCBlPWVnKHQsbiksbD0tMSE9PWU7aWYociYmIWwpaSh0LmNvbmNhdChuKSk7ZWxzZSBpZighciYmbCl7bGV0IG49Wy4uLnRdO24uc3BsaWNlKGUsMSksaShuKX19ZWxzZSBpZihSKHQpKXtsZXQgZT1uZXcgU2V0KHQpO3I/ZS5hZGQobik6ZS5kZWxldGUobiksaShlKX1lbHNlIGkobEsoZSxyKSl9KX0sbW91bnRlZDpsVSxiZWZvcmVVcGRhdGUoZSx0LG4pe2VbbEZdPWxMKG4pLGxVKGUsdCxuKX19O2Z1bmN0aW9uIGxVKGUse3ZhbHVlOnQsb2xkVmFsdWU6bn0scil7bGV0IGk7aWYoZS5fbW9kZWxWYWx1ZT10LEUodCkpaT1lZyh0LHIucHJvcHMudmFsdWUpPi0xO2Vsc2UgaWYoUih0KSlpPXQuaGFzKHIucHJvcHMudmFsdWUpO2Vsc2V7aWYodD09PW4pcmV0dXJuO2k9ZW0odCxsSyhlLCEwKSl9ZS5jaGVja2VkIT09aSYmKGUuY2hlY2tlZD1pKX1sZXQgbGo9e2NyZWF0ZWQoZSx7dmFsdWU6dH0sbil7ZS5jaGVja2VkPWVtKHQsbi5wcm9wcy52YWx1ZSksZVtsRl09bEwobiksbGcoZSwiY2hhbmdlIiwoKT0+e2VbbEZdKGxXKGUpKX0pfSxiZWZvcmVVcGRhdGUoZSx7dmFsdWU6dCxvbGRWYWx1ZTpufSxyKXtlW2xGXT1sTChyKSx0IT09biYmKGUuY2hlY2tlZD1lbSh0LHIucHJvcHMudmFsdWUpKX19LGxIPXtkZWVwOiEwLGNyZWF0ZWQoZSx7dmFsdWU6dCxtb2RpZmllcnM6e251bWJlcjpufX0scil7bGV0IGk9Uih0KTtsZyhlLCJjaGFuZ2UiLCgpPT57bGV0IHQ9QXJyYXkucHJvdG90eXBlLmZpbHRlci5jYWxsKGUub3B0aW9ucyxlPT5lLnNlbGVjdGVkKS5tYXAoZT0+bj9lZShsVyhlKSk6bFcoZSkpO2VbbEZdKGUubXVsdGlwbGU/aT9uZXcgU2V0KHQpOnQ6dFswXSksZS5fYXNzaWduaW5nPSEwLHRZKCgpPT57ZS5fYXNzaWduaW5nPSExfSl9KSxlW2xGXT1sTChyKX0sbW91bnRlZChlLHt2YWx1ZTp0fSl7bHEoZSx0KX0sYmVmb3JlVXBkYXRlKGUsdCxuKXtlW2xGXT1sTChuKX0sdXBkYXRlZChlLHt2YWx1ZTp0fSl7ZS5fYXNzaWduaW5nfHxscShlLHQpfX07ZnVuY3Rpb24gbHEoZSx0KXtsZXQgbj1lLm11bHRpcGxlLHI9RSh0KTtpZighbnx8cnx8Uih0KSl7Zm9yKGxldCBpPTAsbD1lLm9wdGlvbnMubGVuZ3RoO2k8bDtpKyspe2xldCBsPWUub3B0aW9uc1tpXSxzPWxXKGwpO2lmKG4paWYocil7bGV0IGU9dHlwZW9mIHM7InN0cmluZyI9PT1lfHwibnVtYmVyIj09PWU/bC5zZWxlY3RlZD10LnNvbWUoZT0+U3RyaW5nKGUpPT09U3RyaW5nKHMpKTpsLnNlbGVjdGVkPWVnKHQscyk+LTF9ZWxzZSBsLnNlbGVjdGVkPXQuaGFzKHMpO2Vsc2UgaWYoZW0obFcobCksdCkpe2Uuc2VsZWN0ZWRJbmRleCE9PWkmJihlLnNlbGVjdGVkSW5kZXg9aSk7cmV0dXJufX1ufHwtMT09PWUuc2VsZWN0ZWRJbmRleHx8KGUuc2VsZWN0ZWRJbmRleD0tMSl9fWZ1bmN0aW9uIGxXKGUpe3JldHVybiJfdmFsdWUiaW4gZT9lLl92YWx1ZTplLnZhbHVlfWZ1bmN0aW9uIGxLKGUsdCl7bGV0IG49dD8iX3RydWVWYWx1ZSI6Il9mYWxzZVZhbHVlIjtyZXR1cm4gbiBpbiBlP2Vbbl06dH1mdW5jdGlvbiBseihlLHQsbixyLGkpe2xldCBsPWZ1bmN0aW9uKGUsdCl7c3dpdGNoKGUpe2Nhc2UiU0VMRUNUIjpyZXR1cm4gbEg7Y2FzZSJURVhUQVJFQSI6cmV0dXJuIGxWO2RlZmF1bHQ6c3dpdGNoKHQpe2Nhc2UiY2hlY2tib3giOnJldHVybiBsQjtjYXNlInJhZGlvIjpyZXR1cm4gbGo7ZGVmYXVsdDpyZXR1cm4gbFZ9fX0oZS50YWdOYW1lLG4ucHJvcHMmJm4ucHJvcHMudHlwZSlbaV07bCYmbChlLHQsbixyKX1sZXQgbEo9WyJjdHJsIiwic2hpZnQiLCJhbHQiLCJtZXRhIl0sbEc9e3N0b3A6ZT0+ZS5zdG9wUHJvcGFnYXRpb24oKSxwcmV2ZW50OmU9PmUucHJldmVudERlZmF1bHQoKSxzZWxmOmU9PmUudGFyZ2V0IT09ZS5jdXJyZW50VGFyZ2V0LGN0cmw6ZT0+IWUuY3RybEtleSxzaGlmdDplPT4hZS5zaGlmdEtleSxhbHQ6ZT0+IWUuYWx0S2V5LG1ldGE6ZT0+IWUubWV0YUtleSxsZWZ0OmU9PiJidXR0b24iaW4gZSYmMCE9PWUuYnV0dG9uLG1pZGRsZTplPT4iYnV0dG9uImluIGUmJjEhPT1lLmJ1dHRvbixyaWdodDplPT4iYnV0dG9uImluIGUmJjIhPT1lLmJ1dHRvbixleGFjdDooZSx0KT0+bEouc29tZShuPT5lW2Ake259S2V5YF0mJiF0LmluY2x1ZGVzKG4pKX0sbFg9e2VzYzoiZXNjYXBlIixzcGFjZToiICIsdXA6ImFycm93LXVwIixsZWZ0OiJhcnJvdy1sZWZ0IixyaWdodDoiYXJyb3ctcmlnaHQiLGRvd246ImFycm93LWRvd24iLGRlbGV0ZToiYmFja3NwYWNlIn0sbFE9VCh7cGF0Y2hQcm9wOihlLHQsbixyLGksbCk9PntsZXQgcz0ic3ZnIj09PWk7aWYoImNsYXNzIj09PXQpe3ZhciBvPXI7bGV0IHQ9ZVtpUV07dCYmKG89KG8/W28sLi4udF06Wy4uLnRdKS5qb2luKCIgIikpLG51bGw9PW8/ZS5yZW1vdmVBdHRyaWJ1dGUoImNsYXNzIik6cz9lLnNldEF0dHJpYnV0ZSgiY2xhc3MiLG8pOmUuY2xhc3NOYW1lPW99ZWxzZSJzdHlsZSI9PT10P2Z1bmN0aW9uKGUsdCxuKXtsZXQgcj1lLnN0eWxlLGk9TShuKSxsPSExO2lmKG4mJiFpKXtpZih0KWlmKE0odCkpZm9yKGxldCBlIG9mIHQuc3BsaXQoIjsiKSl7bGV0IHQ9ZS5zbGljZSgwLGUuaW5kZXhPZigiOiIpKS50cmltKCk7bnVsbD09blt0XSYmbHUocix0LCIiKX1lbHNlIGZvcihsZXQgZSBpbiB0KW51bGw9PW5bZV0mJmx1KHIsZSwiIik7Zm9yKGxldCBlIGluIG4pImRpc3BsYXkiPT09ZSYmKGw9ITApLGx1KHIsZSxuW2VdKX1lbHNlIGlmKGkpe2lmKHQhPT1uKXtsZXQgZT1yW2xzXTtlJiYobis9IjsiK2UpLHIuY3NzVGV4dD1uLGw9bGEudGVzdChuKX19ZWxzZSB0JiZlLnJlbW92ZUF0dHJpYnV0ZSgic3R5bGUiKTtsciBpbiBlJiYoZVtscl09bD9yLmRpc3BsYXk6IiIsZVtsaV0mJihyLmRpc3BsYXk9Im5vbmUiKSl9KGUsbixyKTpDKHQpP2sodCl8fGZ1bmN0aW9uKGUsdCxuLHIsaT1udWxsKXtsZXQgbD1lW2x2XXx8KGVbbHZdPXt9KSxzPWxbdF07aWYociYmcylzLnZhbHVlPXI7ZWxzZXtsZXRbbixvXT1mdW5jdGlvbihlKXtsZXQgdDtpZihseS50ZXN0KGUpKXtsZXQgbjtmb3IodD17fTtuPWUubWF0Y2gobHkpOyllPWUuc2xpY2UoMCxlLmxlbmd0aC1uWzBdLmxlbmd0aCksdFtuWzBdLnRvTG93ZXJDYXNlKCldPSEwfXJldHVyblsiOiI9PT1lWzJdP2Uuc2xpY2UoMyk6SihlLnNsaWNlKDIpKSx0XX0odCk7aWYocilsZyhlLG4sbFt0XT1mdW5jdGlvbihlLHQpe2xldCBuPWU9PntpZihlLl92dHMpe2lmKGUuX3Z0czw9bi5hdHRhY2hlZClyZXR1cm59ZWxzZSBlLl92dHM9RGF0ZS5ub3coKTt0cShmdW5jdGlvbihlLHQpe2lmKCFFKHQpKXJldHVybiB0O3tsZXQgbj1lLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjtyZXR1cm4gZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb249KCk9PntuLmNhbGwoZSksZS5fc3RvcHBlZD0hMH0sdC5tYXAoZT0+dD0+IXQuX3N0b3BwZWQmJmUmJmUodCkpfX0oZSxuLnZhbHVlKSx0LDUsW2VdKX07cmV0dXJuIG4udmFsdWU9ZSxuLmF0dGFjaGVkPWxifHwobF8udGhlbigoKT0+bGI9MCksbGI9RGF0ZS5ub3coKSksbn0ocixpKSxvKTtlbHNlIHMmJihlLnJlbW92ZUV2ZW50TGlzdGVuZXIobixzLG8pLGxbdF09dm9pZCAwKX19KGUsdCwwLHIsbCk6KCIuIj09PXRbMF0/KHQ9dC5zbGljZSgxKSwwKToiXiI9PT10WzBdPyh0PXQuc2xpY2UoMSksMSk6IWZ1bmN0aW9uKGUsdCxuLHIpe2lmKHIpcmV0dXJuISEoImlubmVySFRNTCI9PT10fHwidGV4dENvbnRlbnQiPT09dHx8dCBpbiBlJiZsUyh0KSYmUChuKSk7aWYoInNwZWxsY2hlY2siPT09dHx8ImRyYWdnYWJsZSI9PT10fHwidHJhbnNsYXRlIj09PXR8fCJhdXRvY29ycmVjdCI9PT10fHwiZm9ybSI9PT10fHwibGlzdCI9PT10JiYiSU5QVVQiPT09ZS50YWdOYW1lfHwidHlwZSI9PT10JiYiVEVYVEFSRUEiPT09ZS50YWdOYW1lKXJldHVybiExO2lmKCJ3aWR0aCI9PT10fHwiaGVpZ2h0Ij09PXQpe2xldCB0PWUudGFnTmFtZTtpZigiSU1HIj09PXR8fCJWSURFTyI9PT10fHwiQ0FOVkFTIj09PXR8fCJTT1VSQ0UiPT09dClyZXR1cm4hMX1yZXR1cm4hKGxTKHQpJiZNKG4pKSYmdCBpbiBlfShlLHQscixzKSk/ZS5faXNWdWVDRSYmKC9bQS1aXS8udGVzdCh0KXx8IU0ocikpP2xtKGUsSyh0KSxyLGwsdCk6KCJ0cnVlLXZhbHVlIj09PXQ/ZS5fdHJ1ZVZhbHVlPXI6ImZhbHNlLXZhbHVlIj09PXQmJihlLl9mYWxzZVZhbHVlPXIpLGxmKGUsdCxyLHMpKToobG0oZSx0LHIpLGUudGFnTmFtZS5pbmNsdWRlcygiLSIpfHwidmFsdWUiIT09dCYmImNoZWNrZWQiIT09dCYmInNlbGVjdGVkIiE9PXR8fGxmKGUsdCxyLHMsbCwidmFsdWUiIT09dCkpfX0se2luc2VydDooZSx0LG4pPT57dC5pbnNlcnRCZWZvcmUoZSxufHxudWxsKX0scmVtb3ZlOmU9PntsZXQgdD1lLnBhcmVudE5vZGU7dCYmdC5yZW1vdmVDaGlsZChlKX0sY3JlYXRlRWxlbWVudDooZSx0LG4scik9PntsZXQgaT0ic3ZnIj09PXQ/aXouY3JlYXRlRWxlbWVudE5TKCJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIsZSk6Im1hdGhtbCI9PT10P2l6LmNyZWF0ZUVsZW1lbnROUygiaHR0cDovL3d3dy53My5vcmcvMTk5OC9NYXRoL01hdGhNTCIsZSk6bj9pei5jcmVhdGVFbGVtZW50KGUse2lzOm59KTppei5jcmVhdGVFbGVtZW50KGUpO3JldHVybiJzZWxlY3QiPT09ZSYmciYmbnVsbCE9ci5tdWx0aXBsZSYmaS5zZXRBdHRyaWJ1dGUoIm11bHRpcGxlIixyLm11bHRpcGxlKSxpfSxjcmVhdGVUZXh0OmU9Pml6LmNyZWF0ZVRleHROb2RlKGUpLGNyZWF0ZUNvbW1lbnQ6ZT0+aXouY3JlYXRlQ29tbWVudChlKSxzZXRUZXh0OihlLHQpPT57ZS5ub2RlVmFsdWU9dH0sc2V0RWxlbWVudFRleHQ6KGUsdCk9PntlLnRleHRDb250ZW50PXR9LHBhcmVudE5vZGU6ZT0+ZS5wYXJlbnROb2RlLG5leHRTaWJsaW5nOmU9PmUubmV4dFNpYmxpbmcscXVlcnlTZWxlY3RvcjplPT5pei5xdWVyeVNlbGVjdG9yKGUpLHNldFNjb3BlSWQoZSx0KXtlLnNldEF0dHJpYnV0ZSh0LCIiKX0saW5zZXJ0U3RhdGljQ29udGVudChlLHQsbixyLGksbCl7bGV0IHM9bj9uLnByZXZpb3VzU2libGluZzp0Lmxhc3RDaGlsZDtpZihpJiYoaT09PWx8fGkubmV4dFNpYmxpbmcpKWZvcig7dC5pbnNlcnRCZWZvcmUoaS5jbG9uZU5vZGUoITApLG4pLGkhPT1sJiYoaT1pLm5leHRTaWJsaW5nKTspO2Vsc2V7aUouaW5uZXJIVE1MPWlLKCJzdmciPT09cj9gPHN2Zz4ke2V9PC9zdmc+YDoibWF0aG1sIj09PXI/YDxtYXRoPiR7ZX08L21hdGg+YDplKTtsZXQgaT1pSi5jb250ZW50O2lmKCJzdmciPT09cnx8Im1hdGhtbCI9PT1yKXtsZXQgZT1pLmZpcnN0Q2hpbGQ7Zm9yKDtlLmZpcnN0Q2hpbGQ7KWkuYXBwZW5kQ2hpbGQoZS5maXJzdENoaWxkKTtpLnJlbW92ZUNoaWxkKGUpfXQuaW5zZXJ0QmVmb3JlKGksbil9cmV0dXJuW3M/cy5uZXh0U2libGluZzp0LmZpcnN0Q2hpbGQsbj9uLnByZXZpb3VzU2libGluZzp0Lmxhc3RDaGlsZF19fSksbFo9ITE7ZnVuY3Rpb24gbFkoKXtyZXR1cm4gaD1sWj9oOnJMKGxRKSxsWj0hMCxofWxldCBsMD0oLi4uZSk9PnsoaHx8KGg9ciQobFEpKSkucmVuZGVyKC4uLmUpfSxsMT0oLi4uZSk9PntsZXQgdD0oaHx8KGg9ciQobFEpKSkuY3JlYXRlQXBwKC4uLmUpLHttb3VudDpufT10O3JldHVybiB0Lm1vdW50PWU9PntsZXQgcj1sNihlKTtpZighcilyZXR1cm47bGV0IGk9dC5fY29tcG9uZW50O1AoaSl8fGkucmVuZGVyfHxpLnRlbXBsYXRlfHwoaS50ZW1wbGF0ZT1yLmlubmVySFRNTCksMT09PXIubm9kZVR5cGUmJihyLnRleHRDb250ZW50PSIiKTtsZXQgbD1uKHIsITEsbDMocikpO3JldHVybiByIGluc3RhbmNlb2YgRWxlbWVudCYmKHIucmVtb3ZlQXR0cmlidXRlKCJ2LWNsb2FrIiksci5zZXRBdHRyaWJ1dGUoImRhdGEtdi1hcHAiLCIiKSksbH0sdH0sbDI9KC4uLmUpPT57bGV0IHQ9bFkoKS5jcmVhdGVBcHAoLi4uZSkse21vdW50Om59PXQ7cmV0dXJuIHQubW91bnQ9ZT0+e2xldCB0PWw2KGUpO2lmKHQpcmV0dXJuIG4odCwhMCxsMyh0KSl9LHR9O2Z1bmN0aW9uIGwzKGUpe3JldHVybiBlIGluc3RhbmNlb2YgU1ZHRWxlbWVudD8ic3ZnIjoiZnVuY3Rpb24iPT10eXBlb2YgTWF0aE1MRWxlbWVudCYmZSBpbnN0YW5jZW9mIE1hdGhNTEVsZW1lbnQ/Im1hdGhtbCI6dm9pZCAwfWZ1bmN0aW9uIGw2KGUpe3JldHVybiBNKGUpP2RvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoZSk6ZX1sZXQgbDQ9U3ltYm9sKCIiKSxsOD1TeW1ib2woIiIpLGw1PVN5bWJvbCgiIiksbDk9U3ltYm9sKCIiKSxsNz1TeW1ib2woIiIpLHNlPVN5bWJvbCgiIiksc3Q9U3ltYm9sKCIiKSxzbj1TeW1ib2woIiIpLHNyPVN5bWJvbCgiIiksc2k9U3ltYm9sKCIiKSxzbD1TeW1ib2woIiIpLHNzPVN5bWJvbCgiIiksc289U3ltYm9sKCIiKSxzYT1TeW1ib2woIiIpLHNjPVN5bWJvbCgiIiksc3U9U3ltYm9sKCIiKSxzZD1TeW1ib2woIiIpLHNwPVN5bWJvbCgiIiksc2g9U3ltYm9sKCIiKSxzZj1TeW1ib2woIiIpLHNtPVN5bWJvbCgiIiksc2c9U3ltYm9sKCIiKSxzdj1TeW1ib2woIiIpLHN5PVN5bWJvbCgiIiksc2I9U3ltYm9sKCIiKSxzXz1TeW1ib2woIiIpLHNTPVN5bWJvbCgiIiksc3g9U3ltYm9sKCIiKSxzQz1TeW1ib2woIiIpLHNrPVN5bWJvbCgiIiksc1Q9U3ltYm9sKCIiKSxzTj1TeW1ib2woIiIpLHN3PVN5bWJvbCgiIiksc0E9U3ltYm9sKCIiKSxzRT1TeW1ib2woIiIpLHNJPVN5bWJvbCgiIiksc1I9U3ltYm9sKCIiKSxzTz1TeW1ib2woIiIpLHNQPVN5bWJvbCgiIiksc009e1tsNF06IkZyYWdtZW50IixbbDhdOiJUZWxlcG9ydCIsW2w1XToiU3VzcGVuc2UiLFtsOV06IktlZXBBbGl2ZSIsW2w3XToiQmFzZVRyYW5zaXRpb24iLFtzZV06Im9wZW5CbG9jayIsW3N0XToiY3JlYXRlQmxvY2siLFtzbl06ImNyZWF0ZUVsZW1lbnRCbG9jayIsW3NyXToiY3JlYXRlVk5vZGUiLFtzaV06ImNyZWF0ZUVsZW1lbnRWTm9kZSIsW3NsXToiY3JlYXRlQ29tbWVudFZOb2RlIixbc3NdOiJjcmVhdGVUZXh0Vk5vZGUiLFtzb106ImNyZWF0ZVN0YXRpY1ZOb2RlIixbc2FdOiJyZXNvbHZlQ29tcG9uZW50Iixbc2NdOiJyZXNvbHZlRHluYW1pY0NvbXBvbmVudCIsW3N1XToicmVzb2x2ZURpcmVjdGl2ZSIsW3NkXToicmVzb2x2ZUZpbHRlciIsW3NwXToid2l0aERpcmVjdGl2ZXMiLFtzaF06InJlbmRlckxpc3QiLFtzZl06InJlbmRlclNsb3QiLFtzbV06ImNyZWF0ZVNsb3RzIixbc2ddOiJ0b0Rpc3BsYXlTdHJpbmciLFtzdl06Im1lcmdlUHJvcHMiLFtzeV06Im5vcm1hbGl6ZUNsYXNzIixbc2JdOiJub3JtYWxpemVTdHlsZSIsW3NfXToibm9ybWFsaXplUHJvcHMiLFtzU106Imd1YXJkUmVhY3RpdmVQcm9wcyIsW3N4XToidG9IYW5kbGVycyIsW3NDXToiY2FtZWxpemUiLFtza106ImNhcGl0YWxpemUiLFtzVF06InRvSGFuZGxlcktleSIsW3NOXToic2V0QmxvY2tUcmFja2luZyIsW3N3XToicHVzaFNjb3BlSWQiLFtzQV06InBvcFNjb3BlSWQiLFtzRV06IndpdGhDdHgiLFtzSV06InVucmVmIixbc1JdOiJpc1JlZiIsW3NPXToid2l0aE1lbW8iLFtzUF06ImlzTWVtb1NhbWUifSxzTD17c3RhcnQ6e2xpbmU6MSxjb2x1bW46MSxvZmZzZXQ6MH0sZW5kOntsaW5lOjEsY29sdW1uOjEsb2Zmc2V0OjB9LHNvdXJjZToiIn07ZnVuY3Rpb24gcyQoZSx0LG4scixpLGwscyxvPSExLGE9ITEsYz0hMSx1PXNMKXt2YXIgZCxwLGgsZjtyZXR1cm4gZSYmKG8/KGUuaGVscGVyKHNlKSxlLmhlbHBlcigoZD1lLmluU1NSLHA9YyxkfHxwP3N0OnNuKSkpOmUuaGVscGVyKChoPWUuaW5TU1IsZj1jLGh8fGY/c3I6c2kpKSxzJiZlLmhlbHBlcihzcCkpLHt0eXBlOjEzLHRhZzp0LHByb3BzOm4sY2hpbGRyZW46cixwYXRjaEZsYWc6aSxkeW5hbWljUHJvcHM6bCxkaXJlY3RpdmVzOnMsaXNCbG9jazpvLGRpc2FibGVUcmFja2luZzphLGlzQ29tcG9uZW50OmMsbG9jOnV9fWZ1bmN0aW9uIHNEKGUsdD1zTCl7cmV0dXJue3R5cGU6MTcsbG9jOnQsZWxlbWVudHM6ZX19ZnVuY3Rpb24gc0YoZSx0PXNMKXtyZXR1cm57dHlwZToxNSxsb2M6dCxwcm9wZXJ0aWVzOmV9fWZ1bmN0aW9uIHNWKGUsdCl7cmV0dXJue3R5cGU6MTYsbG9jOnNMLGtleTpNKGUpP3NCKGUsITApOmUsdmFsdWU6dH19ZnVuY3Rpb24gc0IoZSx0PSExLG49c0wscj0wKXtyZXR1cm57dHlwZTo0LGxvYzpuLGNvbnRlbnQ6ZSxpc1N0YXRpYzp0LGNvbnN0VHlwZTp0PzM6cn19ZnVuY3Rpb24gc1UoZSx0PXNMKXtyZXR1cm57dHlwZTo4LGxvYzp0LGNoaWxkcmVuOmV9fWZ1bmN0aW9uIHNqKGUsdD1bXSxuPXNMKXtyZXR1cm57dHlwZToxNCxsb2M6bixjYWxsZWU6ZSxhcmd1bWVudHM6dH19ZnVuY3Rpb24gc0goZSx0LG49ITEscj0hMSxpPXNMKXtyZXR1cm57dHlwZToxOCxwYXJhbXM6ZSxyZXR1cm5zOnQsbmV3bGluZTpuLGlzU2xvdDpyLGxvYzppfX1mdW5jdGlvbiBzcShlLHQsbixyPSEwKXtyZXR1cm57dHlwZToxOSx0ZXN0OmUsY29uc2VxdWVudDp0LGFsdGVybmF0ZTpuLG5ld2xpbmU6cixsb2M6c0x9fWZ1bmN0aW9uIHNXKGUse2hlbHBlcjp0LHJlbW92ZUhlbHBlcjpuLGluU1NSOnJ9KXtpZighZS5pc0Jsb2NrKXt2YXIgaSxsO2UuaXNCbG9jaz0hMCxuKChpPWUuaXNDb21wb25lbnQscnx8aT9zcjpzaSkpLHQoc2UpLHQoKGw9ZS5pc0NvbXBvbmVudCxyfHxsP3N0OnNuKSl9fWxldCBzSz1uZXcgVWludDhBcnJheShbMTIzLDEyM10pLHN6PW5ldyBVaW50OEFycmF5KFsxMjUsMTI1XSk7ZnVuY3Rpb24gc0ooZSl7cmV0dXJuIGU+PTk3JiZlPD0xMjJ8fGU+PTY1JiZlPD05MH1mdW5jdGlvbiBzRyhlKXtyZXR1cm4gMzI9PT1lfHwxMD09PWV8fDk9PT1lfHwxMj09PWV8fDEzPT09ZX1mdW5jdGlvbiBzWChlKXtyZXR1cm4gNDc9PT1lfHw2Mj09PWV8fHNHKGUpfWZ1bmN0aW9uIHNRKGUpe2xldCB0PW5ldyBVaW50OEFycmF5KGUubGVuZ3RoKTtmb3IobGV0IG49MDtuPGUubGVuZ3RoO24rKyl0W25dPWUuY2hhckNvZGVBdChuKTtyZXR1cm4gdH1sZXQgc1o9e0NkYXRhOm5ldyBVaW50OEFycmF5KFs2Nyw2OCw2NSw4NCw2NSw5MV0pLENkYXRhRW5kOm5ldyBVaW50OEFycmF5KFs5Myw5Myw2Ml0pLENvbW1lbnRFbmQ6bmV3IFVpbnQ4QXJyYXkoWzQ1LDQ1LDYyXSksU2NyaXB0RW5kOm5ldyBVaW50OEFycmF5KFs2MCw0NywxMTUsOTksMTE0LDEwNSwxMTIsMTE2XSksU3R5bGVFbmQ6bmV3IFVpbnQ4QXJyYXkoWzYwLDQ3LDExNSwxMTYsMTIxLDEwOCwxMDFdKSxUaXRsZUVuZDpuZXcgVWludDhBcnJheShbNjAsNDcsMTE2LDEwNSwxMTYsMTA4LDEwMV0pLFRleHRhcmVhRW5kOm5ldyBVaW50OEFycmF5KFs2MCw0NywxMTYsMTAxLDEyMCwxMTYsOTcsMTE0LDEwMSw5N10pfTtmdW5jdGlvbiBzWShlKXt0aHJvdyBlfWZ1bmN0aW9uIHMwKGUpe31mdW5jdGlvbiBzMShlLHQsbixyKXtsZXQgaT1TeW50YXhFcnJvcihTdHJpbmcoYGh0dHBzOi8vdnVlanMub3JnL2Vycm9yLXJlZmVyZW5jZS8jY29tcGlsZXItJHtlfWApKTtyZXR1cm4gaS5jb2RlPWUsaS5sb2M9dCxpfWxldCBzMj1lPT40PT09ZS50eXBlJiZlLmlzU3RhdGljO2Z1bmN0aW9uIHMzKGUpe3N3aXRjaChlKXtjYXNlIlRlbGVwb3J0IjpjYXNlInRlbGVwb3J0IjpyZXR1cm4gbDg7Y2FzZSJTdXNwZW5zZSI6Y2FzZSJzdXNwZW5zZSI6cmV0dXJuIGw1O2Nhc2UiS2VlcEFsaXZlIjpjYXNlImtlZXAtYWxpdmUiOnJldHVybiBsOTtjYXNlIkJhc2VUcmFuc2l0aW9uIjpjYXNlImJhc2UtdHJhbnNpdGlvbiI6cmV0dXJuIGw3fX1sZXQgczY9L15cZHxbXlwkXHdceEEwLVx1RkZGRl0vLHM0PWU9PiFzNi50ZXN0KGUpLHM4PS9bQS1aYS16XyRceEEwLVx1RkZGRl0vLHM1PS9bXC5cP1x3JFx4QTAtXHVGRkZGXS8sczk9L1xzK1suW11ccyp8XHMqWy5bXVxzKy9nLHM3PWU9PjQ9PT1lLnR5cGU/ZS5jb250ZW50OmUubG9jLnNvdXJjZSxvZT1lPT57bGV0IHQ9czcoZSkudHJpbSgpLnJlcGxhY2UoczksZT0+ZS50cmltKCkpLG49MCxyPVtdLGk9MCxsPTAscz1udWxsO2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKXtsZXQgbz10LmNoYXJBdChlKTtzd2l0Y2gobil7Y2FzZSAwOmlmKCJbIj09PW8pci5wdXNoKG4pLG49MSxpKys7ZWxzZSBpZigiKCI9PT1vKXIucHVzaChuKSxuPTIsbCsrO2Vsc2UgaWYoISgwPT09ZT9zODpzNSkudGVzdChvKSlyZXR1cm4hMTticmVhaztjYXNlIDE6IiciPT09b3x8JyInPT09b3x8ImAiPT09bz8oci5wdXNoKG4pLG49MyxzPW8pOiJbIj09PW8/aSsrOiJdIiE9PW98fC0taXx8KG49ci5wb3AoKSk7YnJlYWs7Y2FzZSAyOmlmKCInIj09PW98fCciJz09PW98fCJgIj09PW8pci5wdXNoKG4pLG49MyxzPW87ZWxzZSBpZigiKCI9PT1vKWwrKztlbHNlIGlmKCIpIj09PW8pe2lmKGU9PT10Lmxlbmd0aC0xKXJldHVybiExOy0tbHx8KG49ci5wb3AoKSl9YnJlYWs7Y2FzZSAzOm89PT1zJiYobj1yLnBvcCgpLHM9bnVsbCl9fXJldHVybiFpJiYhbH0sb3Q9L15ccyooYXN5bmNccyopPyhcKFteKV0qP1wpfFtcdyRfXSspXHMqKDpbXj1dKyk/PT58XlxzKihhc3luY1xzKyk/ZnVuY3Rpb24oPzpccytbXHckXSspP1xzKlwoLztmdW5jdGlvbiBvbihlLHQsbj0hMSl7Zm9yKGxldCByPTA7cjxlLnByb3BzLmxlbmd0aDtyKyspe2xldCBpPWUucHJvcHNbcl07aWYoNz09PWkudHlwZSYmKG58fGkuZXhwKSYmKE0odCk/aS5uYW1lPT09dDp0LnRlc3QoaS5uYW1lKSkpcmV0dXJuIGl9fWZ1bmN0aW9uIG9yKGUsdCxuPSExLHI9ITEpe2ZvcihsZXQgaT0wO2k8ZS5wcm9wcy5sZW5ndGg7aSsrKXtsZXQgbD1lLnByb3BzW2ldO2lmKDY9PT1sLnR5cGUpe2lmKG4pY29udGludWU7aWYobC5uYW1lPT09dCYmKGwudmFsdWV8fHIpKXJldHVybiBsfWVsc2UgaWYoImJpbmQiPT09bC5uYW1lJiYobC5leHB8fHIpJiZvaShsLmFyZyx0KSlyZXR1cm4gbH19ZnVuY3Rpb24gb2koZSx0KXtyZXR1cm4hIShlJiZzMihlKSYmZS5jb250ZW50PT09dCl9ZnVuY3Rpb24gb2woZSl7cmV0dXJuIDU9PT1lLnR5cGV8fDI9PT1lLnR5cGV9ZnVuY3Rpb24gb3MoZSl7cmV0dXJuIDc9PT1lLnR5cGUmJiJzbG90Ij09PWUubmFtZX1mdW5jdGlvbiBvbyhlKXtyZXR1cm4gMT09PWUudHlwZSYmMz09PWUudGFnVHlwZX1mdW5jdGlvbiBvYShlKXtyZXR1cm4gMT09PWUudHlwZSYmMj09PWUudGFnVHlwZX1sZXQgb2M9bmV3IFNldChbc18sc1NdKTtmdW5jdGlvbiBvdShlLHQsbil7bGV0IHIsaSxsPTEzPT09ZS50eXBlP2UucHJvcHM6ZS5hcmd1bWVudHNbMl0scz1bXTtpZihsJiYhTShsKSYmMTQ9PT1sLnR5cGUpe2xldCBlPWZ1bmN0aW9uIGUodCxuPVtdKXtpZih0JiYhTSh0KSYmMTQ9PT10LnR5cGUpe2xldCByPXQuY2FsbGVlO2lmKCFNKHIpJiZvYy5oYXMocikpcmV0dXJuIGUodC5hcmd1bWVudHNbMF0sbi5jb25jYXQodCkpfXJldHVyblt0LG5dfShsKTtsPWVbMF0saT0ocz1lWzFdKVtzLmxlbmd0aC0xXX1pZihudWxsPT1sfHxNKGwpKXI9c0YoW3RdKTtlbHNlIGlmKDE0PT09bC50eXBlKXtsZXQgZT1sLmFyZ3VtZW50c1swXTtNKGUpfHwxNSE9PWUudHlwZT9sLmNhbGxlZT09PXN4P3I9c2oobi5oZWxwZXIoc3YpLFtzRihbdF0pLGxdKTpsLmFyZ3VtZW50cy51bnNoaWZ0KHNGKFt0XSkpOm9kKHQsZSl8fGUucHJvcGVydGllcy51bnNoaWZ0KHQpLHJ8fChyPWwpfWVsc2UgMTU9PT1sLnR5cGU/KG9kKHQsbCl8fGwucHJvcGVydGllcy51bnNoaWZ0KHQpLHI9bCk6KHI9c2oobi5oZWxwZXIoc3YpLFtzRihbdF0pLGxdKSxpJiZpLmNhbGxlZT09PXNTJiYoaT1zW3MubGVuZ3RoLTJdKSk7MTM9PT1lLnR5cGU/aT9pLmFyZ3VtZW50c1swXT1yOmUucHJvcHM9cjppP2kuYXJndW1lbnRzWzBdPXI6ZS5hcmd1bWVudHNbMl09cn1mdW5jdGlvbiBvZChlLHQpe2xldCBuPSExO2lmKDQ9PT1lLmtleS50eXBlKXtsZXQgcj1lLmtleS5jb250ZW50O249dC5wcm9wZXJ0aWVzLnNvbWUoZT0+ND09PWUua2V5LnR5cGUmJmUua2V5LmNvbnRlbnQ9PT1yKX1yZXR1cm4gbn1mdW5jdGlvbiBvcChlLHQpe3JldHVybmBfJHt0fV8ke2UucmVwbGFjZSgvW15cd10vZywodCxuKT0+Ii0iPT09dD8iXyI6ZS5jaGFyQ29kZUF0KG4pLnRvU3RyaW5nKCkpfWB9bGV0IG9oPS8oW1xzXFNdKj8pXHMrKD86aW58b2YpXHMrKFxTW1xzXFNdKikvLG9mPXtwYXJzZU1vZGU6ImJhc2UiLG5zOjAsZGVsaW1pdGVyczpbInt7IiwifX0iXSxnZXROYW1lc3BhY2U6KCk9PjAsaXNWb2lkVGFnOngsaXNQcmVUYWc6eCxpc0lnbm9yZU5ld2xpbmVUYWc6eCxpc0N1c3RvbUVsZW1lbnQ6eCxvbkVycm9yOnNZLG9uV2FybjpzMCxjb21tZW50czohMSxwcmVmaXhJZGVudGlmaWVyczohMX0sb209b2Ysb2c9bnVsbCxvdj0iIixveT1udWxsLG9iPW51bGwsb189IiIsb1M9LTEsb3g9LTEsb0M9MCxvaz0hMSxvVD1udWxsLG9OPVtdLG93PW5ldyBjbGFzc3tjb25zdHJ1Y3RvcihlLHQpe3RoaXMuc3RhY2s9ZSx0aGlzLmNicz10LHRoaXMuc3RhdGU9MSx0aGlzLmJ1ZmZlcj0iIix0aGlzLnNlY3Rpb25TdGFydD0wLHRoaXMuaW5kZXg9MCx0aGlzLmVudGl0eVN0YXJ0PTAsdGhpcy5iYXNlU3RhdGU9MSx0aGlzLmluUkNEQVRBPSExLHRoaXMuaW5YTUw9ITEsdGhpcy5pblZQcmU9ITEsdGhpcy5uZXdsaW5lcz1bXSx0aGlzLm1vZGU9MCx0aGlzLmRlbGltaXRlck9wZW49c0ssdGhpcy5kZWxpbWl0ZXJDbG9zZT1zeix0aGlzLmRlbGltaXRlckluZGV4PS0xLHRoaXMuY3VycmVudFNlcXVlbmNlPXZvaWQgMCx0aGlzLnNlcXVlbmNlSW5kZXg9MH1nZXQgaW5TRkNSb290KCl7cmV0dXJuIDI9PT10aGlzLm1vZGUmJjA9PT10aGlzLnN0YWNrLmxlbmd0aH1yZXNldCgpe3RoaXMuc3RhdGU9MSx0aGlzLm1vZGU9MCx0aGlzLmJ1ZmZlcj0iIix0aGlzLnNlY3Rpb25TdGFydD0wLHRoaXMuaW5kZXg9MCx0aGlzLmJhc2VTdGF0ZT0xLHRoaXMuaW5SQ0RBVEE9ITEsdGhpcy5jdXJyZW50U2VxdWVuY2U9dm9pZCAwLHRoaXMubmV3bGluZXMubGVuZ3RoPTAsdGhpcy5kZWxpbWl0ZXJPcGVuPXNLLHRoaXMuZGVsaW1pdGVyQ2xvc2U9c3p9Z2V0UG9zKGUpe2xldCB0PTEsbj1lKzE7Zm9yKGxldCByPXRoaXMubmV3bGluZXMubGVuZ3RoLTE7cj49MDtyLS0pe2xldCBpPXRoaXMubmV3bGluZXNbcl07aWYoZT5pKXt0PXIrMixuPWUtaTticmVha319cmV0dXJue2NvbHVtbjpuLGxpbmU6dCxvZmZzZXQ6ZX19cGVlaygpe3JldHVybiB0aGlzLmJ1ZmZlci5jaGFyQ29kZUF0KHRoaXMuaW5kZXgrMSl9c3RhdGVUZXh0KGUpezYwPT09ZT8odGhpcy5pbmRleD50aGlzLnNlY3Rpb25TdGFydCYmdGhpcy5jYnMub250ZXh0KHRoaXMuc2VjdGlvblN0YXJ0LHRoaXMuaW5kZXgpLHRoaXMuc3RhdGU9NSx0aGlzLnNlY3Rpb25TdGFydD10aGlzLmluZGV4KTp0aGlzLmluVlByZXx8ZSE9PXRoaXMuZGVsaW1pdGVyT3BlblswXXx8KHRoaXMuc3RhdGU9Mix0aGlzLmRlbGltaXRlckluZGV4PTAsdGhpcy5zdGF0ZUludGVycG9sYXRpb25PcGVuKGUpKX1zdGF0ZUludGVycG9sYXRpb25PcGVuKGUpe2lmKGU9PT10aGlzLmRlbGltaXRlck9wZW5bdGhpcy5kZWxpbWl0ZXJJbmRleF0paWYodGhpcy5kZWxpbWl0ZXJJbmRleD09PXRoaXMuZGVsaW1pdGVyT3Blbi5sZW5ndGgtMSl7bGV0IGU9dGhpcy5pbmRleCsxLXRoaXMuZGVsaW1pdGVyT3Blbi5sZW5ndGg7ZT50aGlzLnNlY3Rpb25TdGFydCYmdGhpcy5jYnMub250ZXh0KHRoaXMuc2VjdGlvblN0YXJ0LGUpLHRoaXMuc3RhdGU9Myx0aGlzLnNlY3Rpb25TdGFydD1lfWVsc2UgdGhpcy5kZWxpbWl0ZXJJbmRleCsrO2Vsc2UgdGhpcy5pblJDREFUQT8odGhpcy5zdGF0ZT0zMix0aGlzLnN0YXRlSW5SQ0RBVEEoZSkpOih0aGlzLnN0YXRlPTEsdGhpcy5zdGF0ZVRleHQoZSkpfXN0YXRlSW50ZXJwb2xhdGlvbihlKXtlPT09dGhpcy5kZWxpbWl0ZXJDbG9zZVswXSYmKHRoaXMuc3RhdGU9NCx0aGlzLmRlbGltaXRlckluZGV4PTAsdGhpcy5zdGF0ZUludGVycG9sYXRpb25DbG9zZShlKSl9c3RhdGVJbnRlcnBvbGF0aW9uQ2xvc2UoZSl7ZT09PXRoaXMuZGVsaW1pdGVyQ2xvc2VbdGhpcy5kZWxpbWl0ZXJJbmRleF0/dGhpcy5kZWxpbWl0ZXJJbmRleD09PXRoaXMuZGVsaW1pdGVyQ2xvc2UubGVuZ3RoLTE/KHRoaXMuY2JzLm9uaW50ZXJwb2xhdGlvbih0aGlzLnNlY3Rpb25TdGFydCx0aGlzLmluZGV4KzEpLHRoaXMuaW5SQ0RBVEE/dGhpcy5zdGF0ZT0zMjp0aGlzLnN0YXRlPTEsdGhpcy5zZWN0aW9uU3RhcnQ9dGhpcy5pbmRleCsxKTp0aGlzLmRlbGltaXRlckluZGV4Kys6KHRoaXMuc3RhdGU9Myx0aGlzLnN0YXRlSW50ZXJwb2xhdGlvbihlKSl9c3RhdGVTcGVjaWFsU3RhcnRTZXF1ZW5jZShlKXtsZXQgdD10aGlzLnNlcXVlbmNlSW5kZXg9PT10aGlzLmN1cnJlbnRTZXF1ZW5jZS5sZW5ndGg7aWYodD9zWChlKTooMzJ8ZSk9PT10aGlzLmN1cnJlbnRTZXF1ZW5jZVt0aGlzLnNlcXVlbmNlSW5kZXhdKXtpZighdClyZXR1cm4gdm9pZCB0aGlzLnNlcXVlbmNlSW5kZXgrK31lbHNlIHRoaXMuaW5SQ0RBVEE9ITE7dGhpcy5zZXF1ZW5jZUluZGV4PTAsdGhpcy5zdGF0ZT02LHRoaXMuc3RhdGVJblRhZ05hbWUoZSl9c3RhdGVJblJDREFUQShlKXtpZih0aGlzLnNlcXVlbmNlSW5kZXg9PT10aGlzLmN1cnJlbnRTZXF1ZW5jZS5sZW5ndGgpe2lmKDYyPT09ZXx8c0coZSkpe2xldCB0PXRoaXMuaW5kZXgtdGhpcy5jdXJyZW50U2VxdWVuY2UubGVuZ3RoO2lmKHRoaXMuc2VjdGlvblN0YXJ0PHQpe2xldCBlPXRoaXMuaW5kZXg7dGhpcy5pbmRleD10LHRoaXMuY2JzLm9udGV4dCh0aGlzLnNlY3Rpb25TdGFydCx0KSx0aGlzLmluZGV4PWV9dGhpcy5zZWN0aW9uU3RhcnQ9dCsyLHRoaXMuc3RhdGVJbkNsb3NpbmdUYWdOYW1lKGUpLHRoaXMuaW5SQ0RBVEE9ITE7cmV0dXJufXRoaXMuc2VxdWVuY2VJbmRleD0wfSgzMnxlKT09PXRoaXMuY3VycmVudFNlcXVlbmNlW3RoaXMuc2VxdWVuY2VJbmRleF0/dGhpcy5zZXF1ZW5jZUluZGV4Kz0xOjA9PT10aGlzLnNlcXVlbmNlSW5kZXg/dGhpcy5jdXJyZW50U2VxdWVuY2UhPT1zWi5UaXRsZUVuZCYmKHRoaXMuY3VycmVudFNlcXVlbmNlIT09c1ouVGV4dGFyZWFFbmR8fHRoaXMuaW5TRkNSb290KT90aGlzLmZhc3RGb3J3YXJkVG8oNjApJiYodGhpcy5zZXF1ZW5jZUluZGV4PTEpOnRoaXMuaW5WUHJlfHxlIT09dGhpcy5kZWxpbWl0ZXJPcGVuWzBdfHwodGhpcy5zdGF0ZT0yLHRoaXMuZGVsaW1pdGVySW5kZXg9MCx0aGlzLnN0YXRlSW50ZXJwb2xhdGlvbk9wZW4oZSkpOnRoaXMuc2VxdWVuY2VJbmRleD1OdW1iZXIoNjA9PT1lKX1zdGF0ZUNEQVRBU2VxdWVuY2UoZSl7ZT09PXNaLkNkYXRhW3RoaXMuc2VxdWVuY2VJbmRleF0/Kyt0aGlzLnNlcXVlbmNlSW5kZXg9PT1zWi5DZGF0YS5sZW5ndGgmJih0aGlzLnN0YXRlPTI4LHRoaXMuY3VycmVudFNlcXVlbmNlPXNaLkNkYXRhRW5kLHRoaXMuc2VxdWVuY2VJbmRleD0wLHRoaXMuc2VjdGlvblN0YXJ0PXRoaXMuaW5kZXgrMSk6KHRoaXMuc2VxdWVuY2VJbmRleD0wLHRoaXMuc3RhdGU9MjMsdGhpcy5zdGF0ZUluRGVjbGFyYXRpb24oZSkpfWZhc3RGb3J3YXJkVG8oZSl7Zm9yKDsrK3RoaXMuaW5kZXg8dGhpcy5idWZmZXIubGVuZ3RoOyl7bGV0IHQ9dGhpcy5idWZmZXIuY2hhckNvZGVBdCh0aGlzLmluZGV4KTtpZigxMD09PXQmJnRoaXMubmV3bGluZXMucHVzaCh0aGlzLmluZGV4KSx0PT09ZSlyZXR1cm4hMH1yZXR1cm4gdGhpcy5pbmRleD10aGlzLmJ1ZmZlci5sZW5ndGgtMSwhMX1zdGF0ZUluQ29tbWVudExpa2UoZSl7ZT09PXRoaXMuY3VycmVudFNlcXVlbmNlW3RoaXMuc2VxdWVuY2VJbmRleF0/Kyt0aGlzLnNlcXVlbmNlSW5kZXg9PT10aGlzLmN1cnJlbnRTZXF1ZW5jZS5sZW5ndGgmJih0aGlzLmN1cnJlbnRTZXF1ZW5jZT09PXNaLkNkYXRhRW5kP3RoaXMuY2JzLm9uY2RhdGEodGhpcy5zZWN0aW9uU3RhcnQsdGhpcy5pbmRleC0yKTp0aGlzLmNicy5vbmNvbW1lbnQodGhpcy5zZWN0aW9uU3RhcnQsdGhpcy5pbmRleC0yKSx0aGlzLnNlcXVlbmNlSW5kZXg9MCx0aGlzLnNlY3Rpb25TdGFydD10aGlzLmluZGV4KzEsdGhpcy5zdGF0ZT0xKTowPT09dGhpcy5zZXF1ZW5jZUluZGV4P3RoaXMuZmFzdEZvcndhcmRUbyh0aGlzLmN1cnJlbnRTZXF1ZW5jZVswXSkmJih0aGlzLnNlcXVlbmNlSW5kZXg9MSk6ZSE9PXRoaXMuY3VycmVudFNlcXVlbmNlW3RoaXMuc2VxdWVuY2VJbmRleC0xXSYmKHRoaXMuc2VxdWVuY2VJbmRleD0wKX1zdGFydFNwZWNpYWwoZSx0KXt0aGlzLmVudGVyUkNEQVRBKGUsdCksdGhpcy5zdGF0ZT0zMX1lbnRlclJDREFUQShlLHQpe3RoaXMuaW5SQ0RBVEE9ITAsdGhpcy5jdXJyZW50U2VxdWVuY2U9ZSx0aGlzLnNlcXVlbmNlSW5kZXg9dH1zdGF0ZUJlZm9yZVRhZ05hbWUoZSl7MzM9PT1lPyh0aGlzLnN0YXRlPTIyLHRoaXMuc2VjdGlvblN0YXJ0PXRoaXMuaW5kZXgrMSk6NjM9PT1lPyh0aGlzLnN0YXRlPTI0LHRoaXMuc2VjdGlvblN0YXJ0PXRoaXMuaW5kZXgrMSk6c0ooZSk/KHRoaXMuc2VjdGlvblN0YXJ0PXRoaXMuaW5kZXgsMD09PXRoaXMubW9kZT90aGlzLnN0YXRlPTY6dGhpcy5pblNGQ1Jvb3Q/dGhpcy5zdGF0ZT0zNDp0aGlzLmluWE1MP3RoaXMuc3RhdGU9NjoxMTY9PT1lP3RoaXMuc3RhdGU9MzA6dGhpcy5zdGF0ZT0xMTU9PT1lPzI5OjYpOjQ3PT09ZT90aGlzLnN0YXRlPTg6KHRoaXMuc3RhdGU9MSx0aGlzLnN0YXRlVGV4dChlKSl9c3RhdGVJblRhZ05hbWUoZSl7c1goZSkmJnRoaXMuaGFuZGxlVGFnTmFtZShlKX1zdGF0ZUluU0ZDUm9vdFRhZ05hbWUoZSl7aWYoc1goZSkpe2xldCB0PXRoaXMuYnVmZmVyLnNsaWNlKHRoaXMuc2VjdGlvblN0YXJ0LHRoaXMuaW5kZXgpOyJ0ZW1wbGF0ZSIhPT10JiZ0aGlzLmVudGVyUkNEQVRBKHNRKCI8LyIrdCksMCksdGhpcy5oYW5kbGVUYWdOYW1lKGUpfX1oYW5kbGVUYWdOYW1lKGUpe3RoaXMuY2JzLm9ub3BlbnRhZ25hbWUodGhpcy5zZWN0aW9uU3RhcnQsdGhpcy5pbmRleCksdGhpcy5zZWN0aW9uU3RhcnQ9LTEsdGhpcy5zdGF0ZT0xMSx0aGlzLnN0YXRlQmVmb3JlQXR0ck5hbWUoZSl9c3RhdGVCZWZvcmVDbG9zaW5nVGFnTmFtZShlKXtzRyhlKXx8KDYyPT09ZT8odGhpcy5zdGF0ZT0xLHRoaXMuc2VjdGlvblN0YXJ0PXRoaXMuaW5kZXgrMSk6KHRoaXMuc3RhdGU9c0ooZSk/OToyNyx0aGlzLnNlY3Rpb25TdGFydD10aGlzLmluZGV4KSl9c3RhdGVJbkNsb3NpbmdUYWdOYW1lKGUpeyg2Mj09PWV8fHNHKGUpKSYmKHRoaXMuY2JzLm9uY2xvc2V0YWcodGhpcy5zZWN0aW9uU3RhcnQsdGhpcy5pbmRleCksdGhpcy5zZWN0aW9uU3RhcnQ9LTEsdGhpcy5zdGF0ZT0xMCx0aGlzLnN0YXRlQWZ0ZXJDbG9zaW5nVGFnTmFtZShlKSl9c3RhdGVBZnRlckNsb3NpbmdUYWdOYW1lKGUpezYyPT09ZSYmKHRoaXMuc3RhdGU9MSx0aGlzLnNlY3Rpb25TdGFydD10aGlzLmluZGV4KzEpfXN0YXRlQmVmb3JlQXR0ck5hbWUoZSl7NjI9PT1lPyh0aGlzLmNicy5vbm9wZW50YWdlbmQodGhpcy5pbmRleCksdGhpcy5pblJDREFUQT90aGlzLnN0YXRlPTMyOnRoaXMuc3RhdGU9MSx0aGlzLnNlY3Rpb25TdGFydD10aGlzLmluZGV4KzEpOjQ3PT09ZT90aGlzLnN0YXRlPTc6NjA9PT1lJiY0Nz09PXRoaXMucGVlaygpPyh0aGlzLmNicy5vbm9wZW50YWdlbmQodGhpcy5pbmRleCksdGhpcy5zdGF0ZT01LHRoaXMuc2VjdGlvblN0YXJ0PXRoaXMuaW5kZXgpOnNHKGUpfHx0aGlzLmhhbmRsZUF0dHJTdGFydChlKX1oYW5kbGVBdHRyU3RhcnQoZSl7MTE4PT09ZSYmNDU9PT10aGlzLnBlZWsoKT8odGhpcy5zdGF0ZT0xMyx0aGlzLnNlY3Rpb25TdGFydD10aGlzLmluZGV4KTo0Nj09PWV8fDU4PT09ZXx8NjQ9PT1lfHwzNT09PWU/KHRoaXMuY2JzLm9uZGlybmFtZSh0aGlzLmluZGV4LHRoaXMuaW5kZXgrMSksdGhpcy5zdGF0ZT0xNCx0aGlzLnNlY3Rpb25TdGFydD10aGlzLmluZGV4KzEpOih0aGlzLnN0YXRlPTEyLHRoaXMuc2VjdGlvblN0YXJ0PXRoaXMuaW5kZXgpfXN0YXRlSW5TZWxmQ2xvc2luZ1RhZyhlKXs2Mj09PWU/KHRoaXMuY2JzLm9uc2VsZmNsb3Npbmd0YWcodGhpcy5pbmRleCksdGhpcy5zdGF0ZT0xLHRoaXMuc2VjdGlvblN0YXJ0PXRoaXMuaW5kZXgrMSx0aGlzLmluUkNEQVRBPSExKTpzRyhlKXx8KHRoaXMuc3RhdGU9MTEsdGhpcy5zdGF0ZUJlZm9yZUF0dHJOYW1lKGUpKX1zdGF0ZUluQXR0ck5hbWUoZSl7KDYxPT09ZXx8c1goZSkpJiYodGhpcy5jYnMub25hdHRyaWJuYW1lKHRoaXMuc2VjdGlvblN0YXJ0LHRoaXMuaW5kZXgpLHRoaXMuaGFuZGxlQXR0ck5hbWVFbmQoZSkpfXN0YXRlSW5EaXJOYW1lKGUpezYxPT09ZXx8c1goZSk/KHRoaXMuY2JzLm9uZGlybmFtZSh0aGlzLnNlY3Rpb25TdGFydCx0aGlzLmluZGV4KSx0aGlzLmhhbmRsZUF0dHJOYW1lRW5kKGUpKTo1OD09PWU/KHRoaXMuY2JzLm9uZGlybmFtZSh0aGlzLnNlY3Rpb25TdGFydCx0aGlzLmluZGV4KSx0aGlzLnN0YXRlPTE0LHRoaXMuc2VjdGlvblN0YXJ0PXRoaXMuaW5kZXgrMSk6NDY9PT1lJiYodGhpcy5jYnMub25kaXJuYW1lKHRoaXMuc2VjdGlvblN0YXJ0LHRoaXMuaW5kZXgpLHRoaXMuc3RhdGU9MTYsdGhpcy5zZWN0aW9uU3RhcnQ9dGhpcy5pbmRleCsxKX1zdGF0ZUluRGlyQXJnKGUpezYxPT09ZXx8c1goZSk/KHRoaXMuY2JzLm9uZGlyYXJnKHRoaXMuc2VjdGlvblN0YXJ0LHRoaXMuaW5kZXgpLHRoaXMuaGFuZGxlQXR0ck5hbWVFbmQoZSkpOjkxPT09ZT90aGlzLnN0YXRlPTE1OjQ2PT09ZSYmKHRoaXMuY2JzLm9uZGlyYXJnKHRoaXMuc2VjdGlvblN0YXJ0LHRoaXMuaW5kZXgpLHRoaXMuc3RhdGU9MTYsdGhpcy5zZWN0aW9uU3RhcnQ9dGhpcy5pbmRleCsxKX1zdGF0ZUluRHluYW1pY0RpckFyZyhlKXs5Mz09PWU/dGhpcy5zdGF0ZT0xNDooNjE9PT1lfHxzWChlKSkmJih0aGlzLmNicy5vbmRpcmFyZyh0aGlzLnNlY3Rpb25TdGFydCx0aGlzLmluZGV4KzEpLHRoaXMuaGFuZGxlQXR0ck5hbWVFbmQoZSkpfXN0YXRlSW5EaXJNb2RpZmllcihlKXs2MT09PWV8fHNYKGUpPyh0aGlzLmNicy5vbmRpcm1vZGlmaWVyKHRoaXMuc2VjdGlvblN0YXJ0LHRoaXMuaW5kZXgpLHRoaXMuaGFuZGxlQXR0ck5hbWVFbmQoZSkpOjQ2PT09ZSYmKHRoaXMuY2JzLm9uZGlybW9kaWZpZXIodGhpcy5zZWN0aW9uU3RhcnQsdGhpcy5pbmRleCksdGhpcy5zZWN0aW9uU3RhcnQ9dGhpcy5pbmRleCsxKX1oYW5kbGVBdHRyTmFtZUVuZChlKXt0aGlzLnNlY3Rpb25TdGFydD10aGlzLmluZGV4LHRoaXMuc3RhdGU9MTcsdGhpcy5jYnMub25hdHRyaWJuYW1lZW5kKHRoaXMuaW5kZXgpLHRoaXMuc3RhdGVBZnRlckF0dHJOYW1lKGUpfXN0YXRlQWZ0ZXJBdHRyTmFtZShlKXs2MT09PWU/dGhpcy5zdGF0ZT0xODo0Nz09PWV8fDYyPT09ZT8odGhpcy5jYnMub25hdHRyaWJlbmQoMCx0aGlzLnNlY3Rpb25TdGFydCksdGhpcy5zZWN0aW9uU3RhcnQ9LTEsdGhpcy5zdGF0ZT0xMSx0aGlzLnN0YXRlQmVmb3JlQXR0ck5hbWUoZSkpOnNHKGUpfHwodGhpcy5jYnMub25hdHRyaWJlbmQoMCx0aGlzLnNlY3Rpb25TdGFydCksdGhpcy5oYW5kbGVBdHRyU3RhcnQoZSkpfXN0YXRlQmVmb3JlQXR0clZhbHVlKGUpezM0PT09ZT8odGhpcy5zdGF0ZT0xOSx0aGlzLnNlY3Rpb25TdGFydD10aGlzLmluZGV4KzEpOjM5PT09ZT8odGhpcy5zdGF0ZT0yMCx0aGlzLnNlY3Rpb25TdGFydD10aGlzLmluZGV4KzEpOnNHKGUpfHwodGhpcy5zZWN0aW9uU3RhcnQ9dGhpcy5pbmRleCx0aGlzLnN0YXRlPTIxLHRoaXMuc3RhdGVJbkF0dHJWYWx1ZU5vUXVvdGVzKGUpKX1oYW5kbGVJbkF0dHJWYWx1ZShlLHQpeyhlPT09dHx8dGhpcy5mYXN0Rm9yd2FyZFRvKHQpKSYmKHRoaXMuY2JzLm9uYXR0cmliZGF0YSh0aGlzLnNlY3Rpb25TdGFydCx0aGlzLmluZGV4KSx0aGlzLnNlY3Rpb25TdGFydD0tMSx0aGlzLmNicy5vbmF0dHJpYmVuZCgzND09PXQ/MzoyLHRoaXMuaW5kZXgrMSksdGhpcy5zdGF0ZT0xMSl9c3RhdGVJbkF0dHJWYWx1ZURvdWJsZVF1b3RlcyhlKXt0aGlzLmhhbmRsZUluQXR0clZhbHVlKGUsMzQpfXN0YXRlSW5BdHRyVmFsdWVTaW5nbGVRdW90ZXMoZSl7dGhpcy5oYW5kbGVJbkF0dHJWYWx1ZShlLDM5KX1zdGF0ZUluQXR0clZhbHVlTm9RdW90ZXMoZSl7c0coZSl8fDYyPT09ZT8odGhpcy5jYnMub25hdHRyaWJkYXRhKHRoaXMuc2VjdGlvblN0YXJ0LHRoaXMuaW5kZXgpLHRoaXMuc2VjdGlvblN0YXJ0PS0xLHRoaXMuY2JzLm9uYXR0cmliZW5kKDEsdGhpcy5pbmRleCksdGhpcy5zdGF0ZT0xMSx0aGlzLnN0YXRlQmVmb3JlQXR0ck5hbWUoZSkpOigzOT09PWV8fDYwPT09ZXx8NjE9PT1lfHw5Nj09PWUpJiZ0aGlzLmNicy5vbmVycigxOCx0aGlzLmluZGV4KX1zdGF0ZUJlZm9yZURlY2xhcmF0aW9uKGUpezkxPT09ZT8odGhpcy5zdGF0ZT0yNix0aGlzLnNlcXVlbmNlSW5kZXg9MCk6dGhpcy5zdGF0ZT00NT09PWU/MjU6MjN9c3RhdGVJbkRlY2xhcmF0aW9uKGUpeyg2Mj09PWV8fHRoaXMuZmFzdEZvcndhcmRUbyg2MikpJiYodGhpcy5zdGF0ZT0xLHRoaXMuc2VjdGlvblN0YXJ0PXRoaXMuaW5kZXgrMSl9c3RhdGVJblByb2Nlc3NpbmdJbnN0cnVjdGlvbihlKXsoNjI9PT1lfHx0aGlzLmZhc3RGb3J3YXJkVG8oNjIpKSYmKHRoaXMuY2JzLm9ucHJvY2Vzc2luZ2luc3RydWN0aW9uKHRoaXMuc2VjdGlvblN0YXJ0LHRoaXMuaW5kZXgpLHRoaXMuc3RhdGU9MSx0aGlzLnNlY3Rpb25TdGFydD10aGlzLmluZGV4KzEpfXN0YXRlQmVmb3JlQ29tbWVudChlKXs0NT09PWU/KHRoaXMuc3RhdGU9MjgsdGhpcy5jdXJyZW50U2VxdWVuY2U9c1ouQ29tbWVudEVuZCx0aGlzLnNlcXVlbmNlSW5kZXg9Mix0aGlzLnNlY3Rpb25TdGFydD10aGlzLmluZGV4KzEpOnRoaXMuc3RhdGU9MjN9c3RhdGVJblNwZWNpYWxDb21tZW50KGUpeyg2Mj09PWV8fHRoaXMuZmFzdEZvcndhcmRUbyg2MikpJiYodGhpcy5jYnMub25jb21tZW50KHRoaXMuc2VjdGlvblN0YXJ0LHRoaXMuaW5kZXgpLHRoaXMuc3RhdGU9MSx0aGlzLnNlY3Rpb25TdGFydD10aGlzLmluZGV4KzEpfXN0YXRlQmVmb3JlU3BlY2lhbFMoZSl7ZT09PXNaLlNjcmlwdEVuZFszXT90aGlzLnN0YXJ0U3BlY2lhbChzWi5TY3JpcHRFbmQsNCk6ZT09PXNaLlN0eWxlRW5kWzNdP3RoaXMuc3RhcnRTcGVjaWFsKHNaLlN0eWxlRW5kLDQpOih0aGlzLnN0YXRlPTYsdGhpcy5zdGF0ZUluVGFnTmFtZShlKSl9c3RhdGVCZWZvcmVTcGVjaWFsVChlKXtlPT09c1ouVGl0bGVFbmRbM10/dGhpcy5zdGFydFNwZWNpYWwoc1ouVGl0bGVFbmQsNCk6ZT09PXNaLlRleHRhcmVhRW5kWzNdP3RoaXMuc3RhcnRTcGVjaWFsKHNaLlRleHRhcmVhRW5kLDQpOih0aGlzLnN0YXRlPTYsdGhpcy5zdGF0ZUluVGFnTmFtZShlKSl9c3RhcnRFbnRpdHkoKXt9c3RhdGVJbkVudGl0eSgpe31wYXJzZShlKXtmb3IodGhpcy5idWZmZXI9ZTt0aGlzLmluZGV4PHRoaXMuYnVmZmVyLmxlbmd0aDspe2xldCBlPXRoaXMuYnVmZmVyLmNoYXJDb2RlQXQodGhpcy5pbmRleCk7c3dpdGNoKDEwPT09ZSYmMzMhPT10aGlzLnN0YXRlJiZ0aGlzLm5ld2xpbmVzLnB1c2godGhpcy5pbmRleCksdGhpcy5zdGF0ZSl7Y2FzZSAxOnRoaXMuc3RhdGVUZXh0KGUpO2JyZWFrO2Nhc2UgMjp0aGlzLnN0YXRlSW50ZXJwb2xhdGlvbk9wZW4oZSk7YnJlYWs7Y2FzZSAzOnRoaXMuc3RhdGVJbnRlcnBvbGF0aW9uKGUpO2JyZWFrO2Nhc2UgNDp0aGlzLnN0YXRlSW50ZXJwb2xhdGlvbkNsb3NlKGUpO2JyZWFrO2Nhc2UgMzE6dGhpcy5zdGF0ZVNwZWNpYWxTdGFydFNlcXVlbmNlKGUpO2JyZWFrO2Nhc2UgMzI6dGhpcy5zdGF0ZUluUkNEQVRBKGUpO2JyZWFrO2Nhc2UgMjY6dGhpcy5zdGF0ZUNEQVRBU2VxdWVuY2UoZSk7YnJlYWs7Y2FzZSAxOTp0aGlzLnN0YXRlSW5BdHRyVmFsdWVEb3VibGVRdW90ZXMoZSk7YnJlYWs7Y2FzZSAxMjp0aGlzLnN0YXRlSW5BdHRyTmFtZShlKTticmVhaztjYXNlIDEzOnRoaXMuc3RhdGVJbkRpck5hbWUoZSk7YnJlYWs7Y2FzZSAxNDp0aGlzLnN0YXRlSW5EaXJBcmcoZSk7YnJlYWs7Y2FzZSAxNTp0aGlzLnN0YXRlSW5EeW5hbWljRGlyQXJnKGUpO2JyZWFrO2Nhc2UgMTY6dGhpcy5zdGF0ZUluRGlyTW9kaWZpZXIoZSk7YnJlYWs7Y2FzZSAyODp0aGlzLnN0YXRlSW5Db21tZW50TGlrZShlKTticmVhaztjYXNlIDI3OnRoaXMuc3RhdGVJblNwZWNpYWxDb21tZW50KGUpO2JyZWFrO2Nhc2UgMTE6dGhpcy5zdGF0ZUJlZm9yZUF0dHJOYW1lKGUpO2JyZWFrO2Nhc2UgNjp0aGlzLnN0YXRlSW5UYWdOYW1lKGUpO2JyZWFrO2Nhc2UgMzQ6dGhpcy5zdGF0ZUluU0ZDUm9vdFRhZ05hbWUoZSk7YnJlYWs7Y2FzZSA5OnRoaXMuc3RhdGVJbkNsb3NpbmdUYWdOYW1lKGUpO2JyZWFrO2Nhc2UgNTp0aGlzLnN0YXRlQmVmb3JlVGFnTmFtZShlKTticmVhaztjYXNlIDE3OnRoaXMuc3RhdGVBZnRlckF0dHJOYW1lKGUpO2JyZWFrO2Nhc2UgMjA6dGhpcy5zdGF0ZUluQXR0clZhbHVlU2luZ2xlUXVvdGVzKGUpO2JyZWFrO2Nhc2UgMTg6dGhpcy5zdGF0ZUJlZm9yZUF0dHJWYWx1ZShlKTticmVhaztjYXNlIDg6dGhpcy5zdGF0ZUJlZm9yZUNsb3NpbmdUYWdOYW1lKGUpO2JyZWFrO2Nhc2UgMTA6dGhpcy5zdGF0ZUFmdGVyQ2xvc2luZ1RhZ05hbWUoZSk7YnJlYWs7Y2FzZSAyOTp0aGlzLnN0YXRlQmVmb3JlU3BlY2lhbFMoZSk7YnJlYWs7Y2FzZSAzMDp0aGlzLnN0YXRlQmVmb3JlU3BlY2lhbFQoZSk7YnJlYWs7Y2FzZSAyMTp0aGlzLnN0YXRlSW5BdHRyVmFsdWVOb1F1b3RlcyhlKTticmVhaztjYXNlIDc6dGhpcy5zdGF0ZUluU2VsZkNsb3NpbmdUYWcoZSk7YnJlYWs7Y2FzZSAyMzp0aGlzLnN0YXRlSW5EZWNsYXJhdGlvbihlKTticmVhaztjYXNlIDIyOnRoaXMuc3RhdGVCZWZvcmVEZWNsYXJhdGlvbihlKTticmVhaztjYXNlIDI1OnRoaXMuc3RhdGVCZWZvcmVDb21tZW50KGUpO2JyZWFrO2Nhc2UgMjQ6dGhpcy5zdGF0ZUluUHJvY2Vzc2luZ0luc3RydWN0aW9uKGUpO2JyZWFrO2Nhc2UgMzM6dGhpcy5zdGF0ZUluRW50aXR5KCl9dGhpcy5pbmRleCsrfXRoaXMuY2xlYW51cCgpLHRoaXMuZmluaXNoKCl9Y2xlYW51cCgpe3RoaXMuc2VjdGlvblN0YXJ0IT09dGhpcy5pbmRleCYmKDE9PT10aGlzLnN0YXRlfHwzMj09PXRoaXMuc3RhdGUmJjA9PT10aGlzLnNlcXVlbmNlSW5kZXg/KHRoaXMuY2JzLm9udGV4dCh0aGlzLnNlY3Rpb25TdGFydCx0aGlzLmluZGV4KSx0aGlzLnNlY3Rpb25TdGFydD10aGlzLmluZGV4KTooMTk9PT10aGlzLnN0YXRlfHwyMD09PXRoaXMuc3RhdGV8fDIxPT09dGhpcy5zdGF0ZSkmJih0aGlzLmNicy5vbmF0dHJpYmRhdGEodGhpcy5zZWN0aW9uU3RhcnQsdGhpcy5pbmRleCksdGhpcy5zZWN0aW9uU3RhcnQ9dGhpcy5pbmRleCkpfWZpbmlzaCgpe3RoaXMuaGFuZGxlVHJhaWxpbmdEYXRhKCksdGhpcy5jYnMub25lbmQoKX1oYW5kbGVUcmFpbGluZ0RhdGEoKXtsZXQgZT10aGlzLmJ1ZmZlci5sZW5ndGg7dGhpcy5zZWN0aW9uU3RhcnQ+PWV8fCgyOD09PXRoaXMuc3RhdGU/dGhpcy5jdXJyZW50U2VxdWVuY2U9PT1zWi5DZGF0YUVuZD90aGlzLmNicy5vbmNkYXRhKHRoaXMuc2VjdGlvblN0YXJ0LGUpOnRoaXMuY2JzLm9uY29tbWVudCh0aGlzLnNlY3Rpb25TdGFydCxlKTo2PT09dGhpcy5zdGF0ZXx8MTE9PT10aGlzLnN0YXRlfHwxOD09PXRoaXMuc3RhdGV8fDE3PT09dGhpcy5zdGF0ZXx8MTI9PT10aGlzLnN0YXRlfHwxMz09PXRoaXMuc3RhdGV8fDE0PT09dGhpcy5zdGF0ZXx8MTU9PT10aGlzLnN0YXRlfHwxNj09PXRoaXMuc3RhdGV8fDIwPT09dGhpcy5zdGF0ZXx8MTk9PT10aGlzLnN0YXRlfHwyMT09PXRoaXMuc3RhdGV8fDk9PT10aGlzLnN0YXRlfHx0aGlzLmNicy5vbnRleHQodGhpcy5zZWN0aW9uU3RhcnQsZSkpfWVtaXRDb2RlUG9pbnQoZSx0KXt9fShvTix7b25lcnI6b0gsb250ZXh0KGUsdCl7b08ob0koZSx0KSxlLHQpfSxvbnRleHRlbnRpdHkoZSx0LG4pe29PKGUsdCxuKX0sb25pbnRlcnBvbGF0aW9uKGUsdCl7aWYob2spcmV0dXJuIG9PKG9JKGUsdCksZSx0KTtsZXQgbj1lK293LmRlbGltaXRlck9wZW4ubGVuZ3RoLHI9dC1vdy5kZWxpbWl0ZXJDbG9zZS5sZW5ndGg7Zm9yKDtzRyhvdi5jaGFyQ29kZUF0KG4pKTspbisrO2Zvcig7c0cob3YuY2hhckNvZGVBdChyLTEpKTspci0tO2xldCBpPW9JKG4scik7aS5pbmNsdWRlcygiJiIpJiYoaT1vbS5kZWNvZGVFbnRpdGllcyhpLCExKSksb1Yoe3R5cGU6NSxjb250ZW50Om9qKGksITEsb0IobixyKSksbG9jOm9CKGUsdCl9KX0sb25vcGVudGFnbmFtZShlLHQpe2xldCBuPW9JKGUsdCk7b3k9e3R5cGU6MSx0YWc6bixuczpvbS5nZXROYW1lc3BhY2UobixvTlswXSxvbS5ucyksdGFnVHlwZTowLHByb3BzOltdLGNoaWxkcmVuOltdLGxvYzpvQihlLTEsdCksY29kZWdlbk5vZGU6dm9pZCAwfX0sb25vcGVudGFnZW5kKGUpe29SKGUpfSxvbmNsb3NldGFnKGUsdCl7bGV0IG49b0koZSx0KTtpZighb20uaXNWb2lkVGFnKG4pKXtsZXQgcj0hMTtmb3IobGV0IGU9MDtlPG9OLmxlbmd0aDtlKyspaWYob05bZV0udGFnLnRvTG93ZXJDYXNlKCk9PT1uLnRvTG93ZXJDYXNlKCkpe3I9ITAsZT4wJiZvTlswXS5sb2Muc3RhcnQub2Zmc2V0O2ZvcihsZXQgbj0wO248PWU7bisrKW9QKG9OLnNoaWZ0KCksdCxuPGUpO2JyZWFrfXJ8fG9NKGUsNjApfX0sb25zZWxmY2xvc2luZ3RhZyhlKXtsZXQgdD1veS50YWc7b3kuaXNTZWxmQ2xvc2luZz0hMCxvUihlKSxvTlswXSYmb05bMF0udGFnPT09dCYmb1Aob04uc2hpZnQoKSxlKX0sb25hdHRyaWJuYW1lKGUsdCl7b2I9e3R5cGU6NixuYW1lOm9JKGUsdCksbmFtZUxvYzpvQihlLHQpLHZhbHVlOnZvaWQgMCxsb2M6b0IoZSl9fSxvbmRpcm5hbWUoZSx0KXtsZXQgbj1vSShlLHQpLHI9Ii4iPT09bnx8IjoiPT09bj8iYmluZCI6IkAiPT09bj8ib24iOiIjIj09PW4/InNsb3QiOm4uc2xpY2UoMik7aWYob2t8fCIiPT09cilvYj17dHlwZTo2LG5hbWU6bixuYW1lTG9jOm9CKGUsdCksdmFsdWU6dm9pZCAwLGxvYzpvQihlKX07ZWxzZSBpZihvYj17dHlwZTo3LG5hbWU6cixyYXdOYW1lOm4sZXhwOnZvaWQgMCxhcmc6dm9pZCAwLG1vZGlmaWVyczoiLiI9PT1uP1tzQigicHJvcCIpXTpbXSxsb2M6b0IoZSl9LCJwcmUiPT09cil7b2s9b3cuaW5WUHJlPSEwLG9UPW95O2xldCBlPW95LnByb3BzO2ZvcihsZXQgdD0wO3Q8ZS5sZW5ndGg7dCsrKTc9PT1lW3RdLnR5cGUmJihlW3RdPWZ1bmN0aW9uKGUpe2xldCB0PXt0eXBlOjYsbmFtZTplLnJhd05hbWUsbmFtZUxvYzpvQihlLmxvYy5zdGFydC5vZmZzZXQsZS5sb2Muc3RhcnQub2Zmc2V0K2UucmF3TmFtZS5sZW5ndGgpLHZhbHVlOnZvaWQgMCxsb2M6ZS5sb2N9O2lmKGUuZXhwKXtsZXQgbj1lLmV4cC5sb2M7bi5lbmQub2Zmc2V0PGUubG9jLmVuZC5vZmZzZXQmJihuLnN0YXJ0Lm9mZnNldC0tLG4uc3RhcnQuY29sdW1uLS0sbi5lbmQub2Zmc2V0Kyssbi5lbmQuY29sdW1uKyspLHQudmFsdWU9e3R5cGU6Mixjb250ZW50OmUuZXhwLmNvbnRlbnQsbG9jOm59fXJldHVybiB0fShlW3RdKSl9fSxvbmRpcmFyZyhlLHQpe2lmKGU9PT10KXJldHVybjtsZXQgbj1vSShlLHQpO2lmKG9rKW9iLm5hbWUrPW4sb1Uob2IubmFtZUxvYyx0KTtlbHNle2xldCByPSJbIiE9PW5bMF07b2IuYXJnPW9qKHI/bjpuLnNsaWNlKDEsLTEpLHIsb0IoZSx0KSwzKiEhcil9fSxvbmRpcm1vZGlmaWVyKGUsdCl7bGV0IG49b0koZSx0KTtpZihvaylvYi5uYW1lKz0iLiIrbixvVShvYi5uYW1lTG9jLHQpO2Vsc2UgaWYoInNsb3QiPT09b2IubmFtZSl7bGV0IGU9b2IuYXJnO2UmJihlLmNvbnRlbnQrPSIuIituLG9VKGUubG9jLHQpKX1lbHNle2xldCByPXNCKG4sITAsb0IoZSx0KSk7b2IubW9kaWZpZXJzLnB1c2gocil9fSxvbmF0dHJpYmRhdGEoZSx0KXtvXys9b0koZSx0KSxvUzwwJiYob1M9ZSksb3g9dH0sb25hdHRyaWJlbnRpdHkoZSx0LG4pe29fKz1lLG9TPDAmJihvUz10KSxveD1ufSxvbmF0dHJpYm5hbWVlbmQoZSl7bGV0IHQ9b0kob2IubG9jLnN0YXJ0Lm9mZnNldCxlKTs3PT09b2IudHlwZSYmKG9iLnJhd05hbWU9dCksb3kucHJvcHMuc29tZShlPT4oNz09PWUudHlwZT9lLnJhd05hbWU6ZS5uYW1lKT09PXQpfSxvbmF0dHJpYmVuZChlLHQpe295JiZvYiYmKG9VKG9iLmxvYyx0KSwwIT09ZSYmKG9fLmluY2x1ZGVzKCImIikmJihvXz1vbS5kZWNvZGVFbnRpdGllcyhvXywhMCkpLDY9PT1vYi50eXBlPygiY2xhc3MiPT09b2IubmFtZSYmKG9fPW9GKG9fKS50cmltKCkpLG9iLnZhbHVlPXt0eXBlOjIsY29udGVudDpvXyxsb2M6MT09PWU/b0Iob1Msb3gpOm9CKG9TLTEsb3grMSl9LG93LmluU0ZDUm9vdCYmInRlbXBsYXRlIj09PW95LnRhZyYmImxhbmciPT09b2IubmFtZSYmb18mJiJodG1sIiE9PW9fJiZvdy5lbnRlclJDREFUQShzUSgiPC90ZW1wbGF0ZSIpLDApKToob2IuZXhwPW9qKG9fLCExLG9CKG9TLG94KSwwLDApLCJmb3IiPT09b2IubmFtZSYmKG9iLmZvclBhcnNlUmVzdWx0PWZ1bmN0aW9uKGUpe2xldCB0PWUubG9jLG49ZS5jb250ZW50LHI9bi5tYXRjaChvaCk7aWYoIXIpcmV0dXJuO2xldFssaSxsXT1yLHM9KGUsbixyPSExKT0+e2xldCBpPXQuc3RhcnQub2Zmc2V0K24sbD1pK2UubGVuZ3RoO3JldHVybiBvaihlLCExLG9CKGksbCksMCwrISFyKX0sbz17c291cmNlOnMobC50cmltKCksbi5pbmRleE9mKGwsaS5sZW5ndGgpKSx2YWx1ZTp2b2lkIDAsa2V5OnZvaWQgMCxpbmRleDp2b2lkIDAsZmluYWxpemVkOiExfSxhPWkudHJpbSgpLnJlcGxhY2Uob0UsIiIpLnRyaW0oKSxjPWkuaW5kZXhPZihhKSx1PWEubWF0Y2gob0EpO2lmKHUpe2xldCBlO2E9YS5yZXBsYWNlKG9BLCIiKS50cmltKCk7bGV0IHQ9dVsxXS50cmltKCk7aWYodCYmKGU9bi5pbmRleE9mKHQsYythLmxlbmd0aCksby5rZXk9cyh0LGUsITApKSx1WzJdKXtsZXQgcj11WzJdLnRyaW0oKTtyJiYoby5pbmRleD1zKHIsbi5pbmRleE9mKHIsby5rZXk/ZSt0Lmxlbmd0aDpjK2EubGVuZ3RoKSwhMCkpfX1yZXR1cm4gYSYmKG8udmFsdWU9cyhhLGMsITApKSxvfShvYi5leHApKSkpLCg3IT09b2IudHlwZXx8InByZSIhPT1vYi5uYW1lKSYmb3kucHJvcHMucHVzaChvYikpLG9fPSIiLG9TPW94PS0xfSxvbmNvbW1lbnQoZSx0KXtvbS5jb21tZW50cyYmb1Yoe3R5cGU6Myxjb250ZW50Om9JKGUsdCksbG9jOm9CKGUtNCx0KzMpfSl9LG9uZW5kKCl7bGV0IGU9b3YubGVuZ3RoO2ZvcihsZXQgdD0wO3Q8b04ubGVuZ3RoO3QrKylvUChvTlt0XSxlLTEpLG9OW3RdLmxvYy5zdGFydC5vZmZzZXR9LG9uY2RhdGEoZSx0KXswIT09b05bMF0ubnMmJm9PKG9JKGUsdCksZSx0KX0sb25wcm9jZXNzaW5naW5zdHJ1Y3Rpb24oZSl7KG9OWzBdP29OWzBdLm5zOm9tLm5zKT09PTAmJm9IKDIxLGUtMSl9fSksb0E9LywoW14sXH1cXV0qKSg/OiwoW14sXH1cXV0qKSk/JC8sb0U9L15cKHxcKSQvZztmdW5jdGlvbiBvSShlLHQpe3JldHVybiBvdi5zbGljZShlLHQpfWZ1bmN0aW9uIG9SKGUpe293LmluU0ZDUm9vdCYmKG95LmlubmVyTG9jPW9CKGUrMSxlKzEpKSxvVihveSk7bGV0e3RhZzp0LG5zOm59PW95OzA9PT1uJiZvbS5pc1ByZVRhZyh0KSYmb0MrKyxvbS5pc1ZvaWRUYWcodCk/b1Aob3ksZSk6KG9OLnVuc2hpZnQob3kpLCgxPT09bnx8Mj09PW4pJiYob3cuaW5YTUw9ITApKSxveT1udWxsfWZ1bmN0aW9uIG9PKGUsdCxuKXt7bGV0IHQ9b05bMF0mJm9OWzBdLnRhZzsic2NyaXB0IiE9PXQmJiJzdHlsZSIhPT10JiZlLmluY2x1ZGVzKCImIikmJihlPW9tLmRlY29kZUVudGl0aWVzKGUsITEpKX1sZXQgcj1vTlswXXx8b2csaT1yLmNoaWxkcmVuW3IuY2hpbGRyZW4ubGVuZ3RoLTFdO2kmJjI9PT1pLnR5cGU/KGkuY29udGVudCs9ZSxvVShpLmxvYyxuKSk6ci5jaGlsZHJlbi5wdXNoKHt0eXBlOjIsY29udGVudDplLGxvYzpvQih0LG4pfSl9ZnVuY3Rpb24gb1AoZSx0LG49ITEpe24/b1UoZS5sb2Msb00odCw2MCkpOm9VKGUubG9jLGZ1bmN0aW9uKGUsdCl7bGV0IG49ZTtmb3IoOzYyIT09b3YuY2hhckNvZGVBdChuKSYmbjxvdi5sZW5ndGgtMTspbisrO3JldHVybiBufSh0LDYyKSsxKSxvdy5pblNGQ1Jvb3QmJihlLmNoaWxkcmVuLmxlbmd0aD9lLmlubmVyTG9jLmVuZD1UKHt9LGUuY2hpbGRyZW5bZS5jaGlsZHJlbi5sZW5ndGgtMV0ubG9jLmVuZCk6ZS5pbm5lckxvYy5lbmQ9VCh7fSxlLmlubmVyTG9jLnN0YXJ0KSxlLmlubmVyTG9jLnNvdXJjZT1vSShlLmlubmVyTG9jLnN0YXJ0Lm9mZnNldCxlLmlubmVyTG9jLmVuZC5vZmZzZXQpKTtsZXR7dGFnOnIsbnM6aSxjaGlsZHJlbjpsfT1lO2lmKCFvayYmKCJzbG90Ij09PXI/ZS50YWdUeXBlPTI6IWZ1bmN0aW9uKHt0YWc6ZSxwcm9wczp0fSl7aWYoInRlbXBsYXRlIj09PWUpe2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKWlmKDc9PT10W2VdLnR5cGUmJm9MLmhhcyh0W2VdLm5hbWUpKXJldHVybiEwfXJldHVybiExfShlKT9mdW5jdGlvbih7dGFnOmUscHJvcHM6dH0pe3ZhciBuO2lmKG9tLmlzQ3VzdG9tRWxlbWVudChlKSlyZXR1cm4hMTtpZigiY29tcG9uZW50Ij09PWV8fChuPWUuY2hhckNvZGVBdCgwKSk+NjQmJm48OTF8fHMzKGUpfHxvbS5pc0J1aWx0SW5Db21wb25lbnQmJm9tLmlzQnVpbHRJbkNvbXBvbmVudChlKXx8b20uaXNOYXRpdmVUYWcmJiFvbS5pc05hdGl2ZVRhZyhlKSlyZXR1cm4hMDtmb3IobGV0IGU9MDtlPHQubGVuZ3RoO2UrKyl7bGV0IG49dFtlXTtpZig2PT09bi50eXBlJiYiaXMiPT09bi5uYW1lJiZuLnZhbHVlJiZuLnZhbHVlLmNvbnRlbnQuc3RhcnRzV2l0aCgidnVlOiIpKXJldHVybiEwfXJldHVybiExfShlKSYmKGUudGFnVHlwZT0xKTplLnRhZ1R5cGU9Myksb3cuaW5SQ0RBVEF8fChlLmNoaWxkcmVuPW9EKGwpKSwwPT09aSYmb20uaXNJZ25vcmVOZXdsaW5lVGFnKHIpKXtsZXQgZT1sWzBdO2UmJjI9PT1lLnR5cGUmJihlLmNvbnRlbnQ9ZS5jb250ZW50LnJlcGxhY2UoL15ccj9cbi8sIiIpKX0wPT09aSYmb20uaXNQcmVUYWcocikmJm9DLS0sb1Q9PT1lJiYob2s9b3cuaW5WUHJlPSExLG9UPW51bGwpLG93LmluWE1MJiYob05bMF0/b05bMF0ubnM6b20ubnMpPT09MCYmKG93LmluWE1MPSExKX1mdW5jdGlvbiBvTShlLHQpe2xldCBuPWU7Zm9yKDtvdi5jaGFyQ29kZUF0KG4pIT09dCYmbj49MDspbi0tO3JldHVybiBufWxldCBvTD1uZXcgU2V0KFsiaWYiLCJlbHNlIiwiZWxzZS1pZiIsImZvciIsInNsb3QiXSksbyQ9L1xyXG4vZztmdW5jdGlvbiBvRChlKXtsZXQgdD0icHJlc2VydmUiIT09b20ud2hpdGVzcGFjZSxuPSExO2ZvcihsZXQgcj0wO3I8ZS5sZW5ndGg7cisrKXtsZXQgaT1lW3JdO2lmKDI9PT1pLnR5cGUpaWYob0MpaS5jb250ZW50PWkuY29udGVudC5yZXBsYWNlKG8kLGANCmApO2Vsc2UgaWYoZnVuY3Rpb24oZSl7Zm9yKGxldCB0PTA7dDxlLmxlbmd0aDt0KyspaWYoIXNHKGUuY2hhckNvZGVBdCh0KSkpcmV0dXJuITE7cmV0dXJuITB9KGkuY29udGVudCkpe2xldCBsPWVbci0xXSYmZVtyLTFdLnR5cGUscz1lW3IrMV0mJmVbcisxXS50eXBlOyFsfHwhc3x8dCYmKDM9PT1sJiYoMz09PXN8fDE9PT1zKXx8MT09PWwmJigzPT09c3x8MT09PXMmJmZ1bmN0aW9uKGUpe2ZvcihsZXQgdD0wO3Q8ZS5sZW5ndGg7dCsrKXtsZXQgbj1lLmNoYXJDb2RlQXQodCk7aWYoMTA9PT1ufHwxMz09PW4pcmV0dXJuITB9cmV0dXJuITF9KGkuY29udGVudCkpKT8obj0hMCxlW3JdPW51bGwpOmkuY29udGVudD0iICJ9ZWxzZSB0JiYoaS5jb250ZW50PW9GKGkuY29udGVudCkpfXJldHVybiBuP2UuZmlsdGVyKEJvb2xlYW4pOmV9ZnVuY3Rpb24gb0YoZSl7bGV0IHQ9IiIsbj0hMTtmb3IobGV0IHI9MDtyPGUubGVuZ3RoO3IrKylzRyhlLmNoYXJDb2RlQXQocikpP258fCh0Kz0iICIsbj0hMCk6KHQrPWVbcl0sbj0hMSk7cmV0dXJuIHR9ZnVuY3Rpb24gb1YoZSl7KG9OWzBdfHxvZykuY2hpbGRyZW4ucHVzaChlKX1mdW5jdGlvbiBvQihlLHQpe3JldHVybntzdGFydDpvdy5nZXRQb3MoZSksZW5kOm51bGw9PXQ/dDpvdy5nZXRQb3ModCksc291cmNlOm51bGw9PXQ/dDpvSShlLHQpfX1mdW5jdGlvbiBvVShlLHQpe2UuZW5kPW93LmdldFBvcyh0KSxlLnNvdXJjZT1vSShlLnN0YXJ0Lm9mZnNldCx0KX1mdW5jdGlvbiBvaihlLHQ9ITEsbixyPTAsaT0wKXtyZXR1cm4gc0IoZSx0LG4scil9ZnVuY3Rpb24gb0goZSx0LG4pe29tLm9uRXJyb3IoczEoZSxvQih0LHQpKSl9ZnVuY3Rpb24gb3EoZSl7bGV0IHQ9ZS5jaGlsZHJlbi5maWx0ZXIoZT0+MyE9PWUudHlwZSk7cmV0dXJuIDEhPT10Lmxlbmd0aHx8MSE9PXRbMF0udHlwZXx8b2EodFswXSk/bnVsbDp0WzBdfWZ1bmN0aW9uIG9XKGUsdCl7bGV0e2NvbnN0YW50Q2FjaGU6bn09dDtzd2l0Y2goZS50eXBlKXtjYXNlIDE6aWYoMCE9PWUudGFnVHlwZSlyZXR1cm4gMDtsZXQgcj1uLmdldChlKTtpZih2b2lkIDAhPT1yKXJldHVybiByO2xldCBpPWUuY29kZWdlbk5vZGU7aWYoMTMhPT1pLnR5cGV8fGkuaXNCbG9jayYmInN2ZyIhPT1lLnRhZyYmImZvcmVpZ25PYmplY3QiIT09ZS50YWcmJiJtYXRoIiE9PWUudGFnKXJldHVybiAwO2lmKHZvaWQgMCE9PWkucGF0Y2hGbGFnKXJldHVybiBuLnNldChlLDApLDA7e2xldCByPTMsYz1veihlLHQpO2lmKDA9PT1jKXJldHVybiBuLnNldChlLDApLDA7YzxyJiYocj1jKTtmb3IobGV0IGk9MDtpPGUuY2hpbGRyZW4ubGVuZ3RoO2krKyl7bGV0IGw9b1coZS5jaGlsZHJlbltpXSx0KTtpZigwPT09bClyZXR1cm4gbi5zZXQoZSwwKSwwO2w8ciYmKHI9bCl9aWYocj4xKWZvcihsZXQgaT0wO2k8ZS5wcm9wcy5sZW5ndGg7aSsrKXtsZXQgbD1lLnByb3BzW2ldO2lmKDc9PT1sLnR5cGUmJiJiaW5kIj09PWwubmFtZSYmbC5leHApe2xldCBpPW9XKGwuZXhwLHQpO2lmKDA9PT1pKXJldHVybiBuLnNldChlLDApLDA7aTxyJiYocj1pKX19aWYoaS5pc0Jsb2NrKXt2YXIgbCxzLG8sYTtmb3IobGV0IHQ9MDt0PGUucHJvcHMubGVuZ3RoO3QrKylpZig3PT09ZS5wcm9wc1t0XS50eXBlKXJldHVybiBuLnNldChlLDApLDA7dC5yZW1vdmVIZWxwZXIoc2UpLHQucmVtb3ZlSGVscGVyKChsPXQuaW5TU1Iscz1pLmlzQ29tcG9uZW50LGx8fHM/c3Q6c24pKSxpLmlzQmxvY2s9ITEsdC5oZWxwZXIoKG89dC5pblNTUixhPWkuaXNDb21wb25lbnQsb3x8YT9zcjpzaSkpfXJldHVybiBuLnNldChlLHIpLHJ9Y2FzZSAyOmNhc2UgMzpyZXR1cm4gMztjYXNlIDk6Y2FzZSAxMTpjYXNlIDEwOmRlZmF1bHQ6cmV0dXJuIDA7Y2FzZSA1OmNhc2UgMTI6cmV0dXJuIG9XKGUuY29udGVudCx0KTtjYXNlIDQ6cmV0dXJuIGUuY29uc3RUeXBlO2Nhc2UgODpsZXQgYz0zO2ZvcihsZXQgbj0wO248ZS5jaGlsZHJlbi5sZW5ndGg7bisrKXtsZXQgcj1lLmNoaWxkcmVuW25dO2lmKE0ocil8fEwocikpY29udGludWU7bGV0IGk9b1cocix0KTtpZigwPT09aSlyZXR1cm4gMDtpPGMmJihjPWkpfXJldHVybiBjO2Nhc2UgMjA6cmV0dXJuIDJ9fWxldCBvSz1uZXcgU2V0KFtzeSxzYixzXyxzU10pO2Z1bmN0aW9uIG96KGUsdCl7bGV0IG49MyxyPW9KKGUpO2lmKHImJjE1PT09ci50eXBlKXtsZXR7cHJvcGVydGllczplfT1yO2ZvcihsZXQgcj0wO3I8ZS5sZW5ndGg7cisrKXtsZXQgaSx7a2V5OmwsdmFsdWU6c309ZVtyXSxvPW9XKGwsdCk7aWYoMD09PW8pcmV0dXJuIG87aWYobzxuJiYobj1vKSwwPT09KGk9ND09PXMudHlwZT9vVyhzLHQpOjE0PT09cy50eXBlP2Z1bmN0aW9uIGUodCxuKXtpZigxND09PXQudHlwZSYmIU0odC5jYWxsZWUpJiZvSy5oYXModC5jYWxsZWUpKXtsZXQgcj10LmFyZ3VtZW50c1swXTtpZig0PT09ci50eXBlKXJldHVybiBvVyhyLG4pO2lmKDE0PT09ci50eXBlKXJldHVybiBlKHIsbil9cmV0dXJuIDB9KHMsdCk6MCkpcmV0dXJuIGk7aTxuJiYobj1pKX19cmV0dXJuIG59ZnVuY3Rpb24gb0ooZSl7bGV0IHQ9ZS5jb2RlZ2VuTm9kZTtpZigxMz09PXQudHlwZSlyZXR1cm4gdC5wcm9wc31mdW5jdGlvbiBvRyhlLHQpe3QuY3VycmVudE5vZGU9ZTtsZXR7bm9kZVRyYW5zZm9ybXM6bn09dCxyPVtdO2ZvcihsZXQgaT0wO2k8bi5sZW5ndGg7aSsrKXtsZXQgbD1uW2ldKGUsdCk7aWYobCYmKEUobCk/ci5wdXNoKC4uLmwpOnIucHVzaChsKSksIXQuY3VycmVudE5vZGUpcmV0dXJuO2U9dC5jdXJyZW50Tm9kZX1zd2l0Y2goZS50eXBlKXtjYXNlIDM6dC5zc3J8fHQuaGVscGVyKHNsKTticmVhaztjYXNlIDU6dC5zc3J8fHQuaGVscGVyKHNnKTticmVhaztjYXNlIDk6Zm9yKGxldCBuPTA7bjxlLmJyYW5jaGVzLmxlbmd0aDtuKyspb0coZS5icmFuY2hlc1tuXSx0KTticmVhaztjYXNlIDEwOmNhc2UgMTE6Y2FzZSAxOmNhc2UgMDp2YXIgaT1lO2xldCBsPTAscz0oKT0+e2wtLX07Zm9yKDtsPGkuY2hpbGRyZW4ubGVuZ3RoO2wrKyl7bGV0IGU9aS5jaGlsZHJlbltsXTtNKGUpfHwodC5ncmFuZFBhcmVudD10LnBhcmVudCx0LnBhcmVudD1pLHQuY2hpbGRJbmRleD1sLHQub25Ob2RlUmVtb3ZlZD1zLG9HKGUsdCkpfX10LmN1cnJlbnROb2RlPWU7bGV0IG89ci5sZW5ndGg7Zm9yKDtvLS07KXJbb10oKX1mdW5jdGlvbiBvWChlLHQpe2xldCBuPU0oZSk/dD0+dD09PWU6dD0+ZS50ZXN0KHQpO3JldHVybihlLHIpPT57aWYoMT09PWUudHlwZSl7bGV0e3Byb3BzOml9PWU7aWYoMz09PWUudGFnVHlwZSYmaS5zb21lKG9zKSlyZXR1cm47bGV0IGw9W107Zm9yKGxldCBzPTA7czxpLmxlbmd0aDtzKyspe2xldCBvPWlbc107aWYoNz09PW8udHlwZSYmbihvLm5hbWUpKXtpLnNwbGljZShzLDEpLHMtLTtsZXQgbj10KGUsbyxyKTtuJiZsLnB1c2gobil9fXJldHVybiBsfX19bGV0IG9RPSIvKkBfX1BVUkVfXyovIixvWj1lPT5gJHtzTVtlXX06IF8ke3NNW2VdfWA7ZnVuY3Rpb24gb1koZSx0LHtoZWxwZXI6bixwdXNoOnIsbmV3bGluZTppLGlzVFM6bH0pe2xldCBzPW4oImNvbXBvbmVudCI9PT10P3NhOnN1KTtmb3IobGV0IG49MDtuPGUubGVuZ3RoO24rKyl7bGV0IG89ZVtuXSxhPW8uZW5kc1dpdGgoIl9fc2VsZiIpO2EmJihvPW8uc2xpY2UoMCwtNikpLHIoYGNvbnN0ICR7b3Aobyx0KX0gPSAke3N9KCR7SlNPTi5zdHJpbmdpZnkobyl9JHthPyIsIHRydWUiOiIifSkke2w/IiEiOiIifWApLG48ZS5sZW5ndGgtMSYmaSgpfX1mdW5jdGlvbiBvMChlLHQpe2xldCBuPWUubGVuZ3RoPjM7dC5wdXNoKCJbIiksbiYmdC5pbmRlbnQoKSxvMShlLHQsbiksbiYmdC5kZWluZGVudCgpLHQucHVzaCgiXSIpfWZ1bmN0aW9uIG8xKGUsdCxuPSExLHI9ITApe2xldHtwdXNoOmksbmV3bGluZTpsfT10O2ZvcihsZXQgcz0wO3M8ZS5sZW5ndGg7cysrKXtsZXQgbz1lW3NdO00obyk/aShvLC0zKTpFKG8pP28wKG8sdCk6bzIobyx0KSxzPGUubGVuZ3RoLTEmJihuPyhyJiZpKCIsIiksbCgpKTpyJiZpKCIsICIpKX19ZnVuY3Rpb24gbzIoZSx0KXtpZihNKGUpKXJldHVybiB2b2lkIHQucHVzaChlLC0zKTtpZihMKGUpKXJldHVybiB2b2lkIHQucHVzaCh0LmhlbHBlcihlKSk7c3dpdGNoKGUudHlwZSl7Y2FzZSAxOmNhc2UgOTpjYXNlIDExOmNhc2UgMTI6bzIoZS5jb2RlZ2VuTm9kZSx0KTticmVhaztjYXNlIDI6bj1lLHQucHVzaChKU09OLnN0cmluZ2lmeShuLmNvbnRlbnQpLC0zLG4pO2JyZWFrO2Nhc2UgNDpvMyhlLHQpO2JyZWFrO2Nhc2UgNTp2YXIgbixyLGksbD1lLHM9dDtsZXR7cHVzaDpvLGhlbHBlcjphLHB1cmU6Y309cztjJiZvKG9RKSxvKGAke2Eoc2cpfShgKSxvMihsLmNvbnRlbnQscyksbygiKSIpO2JyZWFrO2Nhc2UgODpvNihlLHQpO2JyZWFrO2Nhc2UgMzp2YXIgdT1lLGQ9dDtsZXR7cHVzaDpwLGhlbHBlcjpoLHB1cmU6Zn09ZDtmJiZwKG9RKSxwKGAke2goc2wpfSgke0pTT04uc3RyaW5naWZ5KHUuY29udGVudCl9KWAsLTMsdSk7YnJlYWs7Y2FzZSAxMzohZnVuY3Rpb24oZSx0KXt2YXIgbixyO2xldCBpLHtwdXNoOmwsaGVscGVyOnMscHVyZTpvfT10LHt0YWc6YSxwcm9wczpjLGNoaWxkcmVuOnUscGF0Y2hGbGFnOmQsZHluYW1pY1Byb3BzOnAsZGlyZWN0aXZlczpoLGlzQmxvY2s6ZixkaXNhYmxlVHJhY2tpbmc6bSxpc0NvbXBvbmVudDpnfT1lO2QmJihpPVN0cmluZyhkKSksaCYmbChzKHNwKSsiKCIpLGYmJmwoYCgke3Moc2UpfSgke20/InRydWUiOiIifSksIGApLG8mJmwob1EpLGwocyhmPyhuPXQuaW5TU1Isbnx8Zz9zdDpzbik6KHI9dC5pblNTUixyfHxnP3NyOnNpKSkrIigiLC0yLGUpLG8xKGZ1bmN0aW9uKGUpe2xldCB0PWUubGVuZ3RoO2Zvcig7dC0tJiZudWxsPT1lW3RdOyk7cmV0dXJuIGUuc2xpY2UoMCx0KzEpLm1hcChlPT5lfHwibnVsbCIpfShbYSxjLHUsaSxwXSksdCksbCgiKSIpLGYmJmwoIikiKSxoJiYobCgiLCAiKSxvMihoLHQpLGwoIikiKSl9KGUsdCk7YnJlYWs7Y2FzZSAxNDp2YXIgbT1lLGc9dDtsZXR7cHVzaDp5LGhlbHBlcjpiLHB1cmU6X309ZyxTPU0obS5jYWxsZWUpP20uY2FsbGVlOmIobS5jYWxsZWUpO18mJnkob1EpLHkoUysiKCIsLTIsbSksbzEobS5hcmd1bWVudHMsZykseSgiKSIpO2JyZWFrO2Nhc2UgMTU6IWZ1bmN0aW9uKGUsdCl7bGV0e3B1c2g6bixpbmRlbnQ6cixkZWluZGVudDppLG5ld2xpbmU6bH09dCx7cHJvcGVydGllczpzfT1lO2lmKCFzLmxlbmd0aClyZXR1cm4gbigie30iLC0yLGUpO2xldCBvPXMubGVuZ3RoPjE7bihvPyJ7IjoieyAiKSxvJiZyKCk7Zm9yKGxldCBlPTA7ZTxzLmxlbmd0aDtlKyspe2xldHtrZXk6cix2YWx1ZTppfT1zW2VdLHtwdXNoOm99PXQ7OD09PXIudHlwZT8obygiWyIpLG82KHIsdCksbygiXSIpKTpyLmlzU3RhdGljP28oczQoci5jb250ZW50KT9yLmNvbnRlbnQ6SlNPTi5zdHJpbmdpZnkoci5jb250ZW50KSwtMixyKTpvKGBbJHtyLmNvbnRlbnR9XWAsLTMsciksbigiOiAiKSxvMihpLHQpLGU8cy5sZW5ndGgtMSYmKG4oIiwiKSxsKCkpfW8mJmkoKSxuKG8/In0iOiIgfSIpfShlLHQpO2JyZWFrO2Nhc2UgMTc6cj1lLGk9dCxvMChyLmVsZW1lbnRzLGkpO2JyZWFrO2Nhc2UgMTg6dmFyIHg9ZSxDPXQ7bGV0e3B1c2g6ayxpbmRlbnQ6VCxkZWluZGVudDpOfT1DLHtwYXJhbXM6dyxyZXR1cm5zOkEsYm9keTpJLG5ld2xpbmU6Uixpc1Nsb3Q6T309eDtPJiZrKGBfJHtzTVtzRV19KGApLGsoIigiLC0yLHgpLEUodyk/bzEodyxDKTp3JiZvMih3LEMpLGsoIikgPT4gIiksKFJ8fEkpJiYoaygieyIpLFQoKSksQT8oUiYmaygicmV0dXJuICIpLEUoQSk/bzAoQSxDKTpvMihBLEMpKTpJJiZvMihJLEMpLChSfHxJKSYmKE4oKSxrKCJ9IikpLE8mJmsoIikiKTticmVhaztjYXNlIDE5OnZhciBQPWUsJD10O2xldHt0ZXN0OkQsY29uc2VxdWVudDpGLGFsdGVybmF0ZTpWLG5ld2xpbmU6Qn09UCx7cHVzaDpVLGluZGVudDpqLGRlaW5kZW50OkgsbmV3bGluZTpxfT0kO2lmKDQ9PT1ELnR5cGUpe2xldCBlPSFzNChELmNvbnRlbnQpO2UmJlUoIigiKSxvMyhELCQpLGUmJlUoIikiKX1lbHNlIFUoIigiKSxvMihELCQpLFUoIikiKTtCJiZqKCksJC5pbmRlbnRMZXZlbCsrLEJ8fFUoIiAiKSxVKCI/ICIpLG8yKEYsJCksJC5pbmRlbnRMZXZlbC0tLEImJnEoKSxCfHxVKCIgIiksVSgiOiAiKTtsZXQgVz0xOT09PVYudHlwZTshVyYmJC5pbmRlbnRMZXZlbCsrLG8yKFYsJCksIVcmJiQuaW5kZW50TGV2ZWwtLSxCJiZIKCEwKTticmVhaztjYXNlIDIwOnZhciBLPWUsej10O2xldHtwdXNoOkosaGVscGVyOkcsaW5kZW50OlgsZGVpbmRlbnQ6USxuZXdsaW5lOlp9PXose25lZWRQYXVzZVRyYWNraW5nOlksbmVlZEFycmF5U3ByZWFkOmVlfT1LO2VlJiZKKCJbLi4uKCIpLEooYF9jYWNoZVske0suaW5kZXh9XSB8fCAoYCksWSYmKFgoKSxKKGAke0coc04pfSgtMWApLEsuaW5WT25jZSYmSigiLCB0cnVlIiksSigiKSwiKSxaKCksSigiKCIpKSxKKGBfY2FjaGVbJHtLLmluZGV4fV0gPSBgKSxvMihLLnZhbHVlLHopLFkmJihKKGApLmNhY2hlSW5kZXggPSAke0suaW5kZXh9LGApLFooKSxKKGAke0coc04pfSgxKSxgKSxaKCksSihgX2NhY2hlWyR7Sy5pbmRleH1dYCksUSgpKSxKKCIpIiksZWUmJkooIildIik7YnJlYWs7Y2FzZSAyMTpvMShlLmJvZHksdCwhMCwhMSl9fWZ1bmN0aW9uIG8zKGUsdCl7bGV0e2NvbnRlbnQ6bixpc1N0YXRpYzpyfT1lO3QucHVzaChyP0pTT04uc3RyaW5naWZ5KG4pOm4sLTMsZSl9ZnVuY3Rpb24gbzYoZSx0KXtmb3IobGV0IG49MDtuPGUuY2hpbGRyZW4ubGVuZ3RoO24rKyl7bGV0IHI9ZS5jaGlsZHJlbltuXTtNKHIpP3QucHVzaChyLC0zKTpvMihyLHQpfX1sZXQgbzQ9b1goL14oaWZ8ZWxzZXxlbHNlLWlmKSQvLChlLHQsbik9PihmdW5jdGlvbihlLHQsbixyKXtpZigiZWxzZSIhPT10Lm5hbWUmJighdC5leHB8fCF0LmV4cC5jb250ZW50LnRyaW0oKSkpe2xldCByPXQuZXhwP3QuZXhwLmxvYzplLmxvYztuLm9uRXJyb3IoczEoMjgsdC5sb2MpKSx0LmV4cD1zQigidHJ1ZSIsITEscil9aWYoImlmIj09PXQubmFtZSl7dmFyIGk7bGV0IGw9bzgoZSx0KSxzPXt0eXBlOjksbG9jOm9CKChpPWUubG9jKS5zdGFydC5vZmZzZXQsaS5lbmQub2Zmc2V0KSxicmFuY2hlczpbbF19O2lmKG4ucmVwbGFjZU5vZGUocykscilyZXR1cm4gcihzLGwsITApfWVsc2V7bGV0IGk9bi5wYXJlbnQuY2hpbGRyZW4sbD1pLmluZGV4T2YoZSk7Zm9yKDtsLS0gPj0tMTspe2xldCBzPWlbbF07aWYocyYmMz09PXMudHlwZXx8cyYmMj09PXMudHlwZSYmIXMuY29udGVudC50cmltKCkubGVuZ3RoKXtuLnJlbW92ZU5vZGUocyk7Y29udGludWV9aWYocyYmOT09PXMudHlwZSl7ImVsc2UtaWYiPT09dC5uYW1lJiZ2b2lkIDA9PT1zLmJyYW5jaGVzW3MuYnJhbmNoZXMubGVuZ3RoLTFdLmNvbmRpdGlvbiYmbi5vbkVycm9yKHMxKDMwLGUubG9jKSksbi5yZW1vdmVOb2RlKCk7bGV0IGk9bzgoZSx0KTtzLmJyYW5jaGVzLnB1c2goaSk7bGV0IGw9ciYmcihzLGksITEpO29HKGksbiksbCYmbCgpLG4uY3VycmVudE5vZGU9bnVsbH1lbHNlIG4ub25FcnJvcihzMSgzMCxlLmxvYykpO2JyZWFrfX19KShlLHQsbiwoZSx0LHIpPT57bGV0IGk9bi5wYXJlbnQuY2hpbGRyZW4sbD1pLmluZGV4T2YoZSkscz0wO2Zvcig7bC0tID49MDspe2xldCBlPWlbbF07ZSYmOT09PWUudHlwZSYmKHMrPWUuYnJhbmNoZXMubGVuZ3RoKX1yZXR1cm4oKT0+e3I/ZS5jb2RlZ2VuTm9kZT1vNSh0LHMsbik6ZnVuY3Rpb24oZSl7Zm9yKDs7KWlmKDE5PT09ZS50eXBlKWlmKDE5IT09ZS5hbHRlcm5hdGUudHlwZSlyZXR1cm4gZTtlbHNlIGU9ZS5hbHRlcm5hdGU7ZWxzZSAyMD09PWUudHlwZSYmKGU9ZS52YWx1ZSl9KGUuY29kZWdlbk5vZGUpLmFsdGVybmF0ZT1vNSh0LHMrZS5icmFuY2hlcy5sZW5ndGgtMSxuKX19KSk7ZnVuY3Rpb24gbzgoZSx0KXtsZXQgbj0zPT09ZS50YWdUeXBlO3JldHVybnt0eXBlOjEwLGxvYzplLmxvYyxjb25kaXRpb246ImVsc2UiPT09dC5uYW1lP3ZvaWQgMDp0LmV4cCxjaGlsZHJlbjpuJiYhb24oZSwiZm9yIik/ZS5jaGlsZHJlbjpbZV0sdXNlcktleTpvcihlLCJrZXkiKSxpc1RlbXBsYXRlSWY6bn19ZnVuY3Rpb24gbzUoZSx0LG4pe3JldHVybiBlLmNvbmRpdGlvbj9zcShlLmNvbmRpdGlvbixvOShlLHQsbiksc2oobi5oZWxwZXIoc2wpLFsnIiInLCJ0cnVlIl0pKTpvOShlLHQsbil9ZnVuY3Rpb24gbzkoZSx0LG4pe2xldHtoZWxwZXI6cn09bixpPXNWKCJrZXkiLHNCKGAke3R9YCwhMSxzTCwyKSkse2NoaWxkcmVuOmx9PWUscz1sWzBdO2lmKDEhPT1sLmxlbmd0aHx8MSE9PXMudHlwZSlpZigxIT09bC5sZW5ndGh8fDExIT09cy50eXBlKXJldHVybiBzJChuLHIobDQpLHNGKFtpXSksbCw2NCx2b2lkIDAsdm9pZCAwLCEwLCExLCExLGUubG9jKTtlbHNle2xldCBlPXMuY29kZWdlbk5vZGU7cmV0dXJuIG91KGUsaSxuKSxlfXtsZXQgZT1zLmNvZGVnZW5Ob2RlLHQ9MTQ9PT1lLnR5cGUmJmUuY2FsbGVlPT09c08/ZS5hcmd1bWVudHNbMV0ucmV0dXJuczplO3JldHVybiAxMz09PXQudHlwZSYmc1codCxuKSxvdSh0LGksbiksZX19bGV0IG83PShlLHQsbik9PntsZXR7bW9kaWZpZXJzOnIsbG9jOml9PWUsbD1lLmFyZyx7ZXhwOnN9PWU7aWYocyYmND09PXMudHlwZSYmIXMuY29udGVudC50cmltKCkmJihzPXZvaWQgMCksIXMpe2lmKDQhPT1sLnR5cGV8fCFsLmlzU3RhdGljKXJldHVybiBuLm9uRXJyb3IoczEoNTIsbC5sb2MpKSx7cHJvcHM6W3NWKGwsc0IoIiIsITAsaSkpXX07YWUoZSkscz1lLmV4cH1yZXR1cm4gNCE9PWwudHlwZT8obC5jaGlsZHJlbi51bnNoaWZ0KCIoIiksbC5jaGlsZHJlbi5wdXNoKCcpIHx8ICIiJykpOmwuaXNTdGF0aWN8fChsLmNvbnRlbnQ9YCR7bC5jb250ZW50fSB8fCAiImApLHIuc29tZShlPT4iY2FtZWwiPT09ZS5jb250ZW50KSYmKDQ9PT1sLnR5cGU/bC5pc1N0YXRpYz9sLmNvbnRlbnQ9SyhsLmNvbnRlbnQpOmwuY29udGVudD1gJHtuLmhlbHBlclN0cmluZyhzQyl9KCR7bC5jb250ZW50fSlgOihsLmNoaWxkcmVuLnVuc2hpZnQoYCR7bi5oZWxwZXJTdHJpbmcoc0MpfShgKSxsLmNoaWxkcmVuLnB1c2goIikiKSkpLCFuLmluU1NSJiYoci5zb21lKGU9PiJwcm9wIj09PWUuY29udGVudCkmJmF0KGwsIi4iKSxyLnNvbWUoZT0+ImF0dHIiPT09ZS5jb250ZW50KSYmYXQobCwiXiIpKSx7cHJvcHM6W3NWKGwscyldfX0sYWU9KGUsdCk9PntsZXQgbj1lLmFyZztlLmV4cD1zQihLKG4uY29udGVudCksITEsbi5sb2MpfSxhdD0oZSx0KT0+ezQ9PT1lLnR5cGU/ZS5pc1N0YXRpYz9lLmNvbnRlbnQ9dCtlLmNvbnRlbnQ6ZS5jb250ZW50PWBcYCR7dH1cJHske2UuY29udGVudH19XGBgOihlLmNoaWxkcmVuLnVuc2hpZnQoYCcke3R9JyArIChgKSxlLmNoaWxkcmVuLnB1c2goIikiKSl9LGFuPW9YKCJmb3IiLChlLHQsbik9PntsZXR7aGVscGVyOnIscmVtb3ZlSGVscGVyOml9PW47cmV0dXJuIGZ1bmN0aW9uKGUsdCxuLHIpe2lmKCF0LmV4cClyZXR1cm4gdm9pZCBuLm9uRXJyb3IoczEoMzEsdC5sb2MpKTtsZXQgaT10LmZvclBhcnNlUmVzdWx0O2lmKCFpKXJldHVybiB2b2lkIG4ub25FcnJvcihzMSgzMix0LmxvYykpO2FyKGkpO2xldHthZGRJZGVudGlmaWVyczpsLHJlbW92ZUlkZW50aWZpZXJzOnMsc2NvcGVzOm99PW4se3NvdXJjZTphLHZhbHVlOmMsa2V5OnUsaW5kZXg6ZH09aSxwPXt0eXBlOjExLGxvYzp0LmxvYyxzb3VyY2U6YSx2YWx1ZUFsaWFzOmMsa2V5QWxpYXM6dSxvYmplY3RJbmRleEFsaWFzOmQscGFyc2VSZXN1bHQ6aSxjaGlsZHJlbjpvbyhlKT9lLmNoaWxkcmVuOltlXX07bi5yZXBsYWNlTm9kZShwKSxvLnZGb3IrKztsZXQgaD1yJiZyKHApO3JldHVybigpPT57by52Rm9yLS0saCYmaCgpfX0oZSx0LG4sdD0+e2xldCBsPXNqKHIoc2gpLFt0LnNvdXJjZV0pLHM9b28oZSksbz1vbihlLCJtZW1vIiksYT1vcihlLCJrZXkiLCExLCEwKTthJiY3PT09YS50eXBlJiYhYS5leHAmJmFlKGEpO2xldCBjPWEmJig2PT09YS50eXBlP2EudmFsdWU/c0IoYS52YWx1ZS5jb250ZW50LCEwKTp2b2lkIDA6YS5leHApLHU9YSYmYz9zVigia2V5IixjKTpudWxsLGQ9ND09PXQuc291cmNlLnR5cGUmJnQuc291cmNlLmNvbnN0VHlwZT4wLHA9ZD82NDphPzEyODoyNTY7cmV0dXJuIHQuY29kZWdlbk5vZGU9cyQobixyKGw0KSx2b2lkIDAsbCxwLHZvaWQgMCx2b2lkIDAsITAsIWQsITEsZS5sb2MpLCgpPT57bGV0IGEse2NoaWxkcmVuOnB9PXQsaD0xIT09cC5sZW5ndGh8fDEhPT1wWzBdLnR5cGUsZj1vYShlKT9lOnMmJjE9PT1lLmNoaWxkcmVuLmxlbmd0aCYmb2EoZS5jaGlsZHJlblswXSk/ZS5jaGlsZHJlblswXTpudWxsO2lmKGYpYT1mLmNvZGVnZW5Ob2RlLHMmJnUmJm91KGEsdSxuKTtlbHNlIGlmKGgpYT1zJChuLHIobDQpLHU/c0YoW3VdKTp2b2lkIDAsZS5jaGlsZHJlbiw2NCx2b2lkIDAsdm9pZCAwLCEwLHZvaWQgMCwhMSk7ZWxzZXt2YXIgbSxnLHksYixfLFMseCxDO2E9cFswXS5jb2RlZ2VuTm9kZSxzJiZ1JiZvdShhLHUsbiksIWQhPT1hLmlzQmxvY2smJihhLmlzQmxvY2s/KGkoc2UpLGkoKG09bi5pblNTUixnPWEuaXNDb21wb25lbnQsbXx8Zz9zdDpzbikpKTppKCh5PW4uaW5TU1IsYj1hLmlzQ29tcG9uZW50LHl8fGI/c3I6c2kpKSksKGEuaXNCbG9jaz0hZCxhLmlzQmxvY2spPyhyKHNlKSxyKChfPW4uaW5TU1IsUz1hLmlzQ29tcG9uZW50LF98fFM/c3Q6c24pKSk6cigoeD1uLmluU1NSLEM9YS5pc0NvbXBvbmVudCx4fHxDP3NyOnNpKSl9aWYobyl7bGV0IGU9c0goYWkodC5wYXJzZVJlc3VsdCxbc0IoIl9jYWNoZWQiKV0pKTtlLmJvZHk9e3R5cGU6MjEsYm9keTpbc1UoWyJjb25zdCBfbWVtbyA9ICgiLG8uZXhwLCIpIl0pLHNVKFsiaWYgKF9jYWNoZWQiLC4uLmM/WyIgJiYgX2NhY2hlZC5rZXkgPT09ICIsY106W10sYCAmJiAke24uaGVscGVyU3RyaW5nKHNQKX0oX2NhY2hlZCwgX21lbW8pKSByZXR1cm4gX2NhY2hlZGBdKSxzVShbImNvbnN0IF9pdGVtID0gIixhXSksc0IoIl9pdGVtLm1lbW8gPSBfbWVtbyIpLHNCKCJyZXR1cm4gX2l0ZW0iKV0sbG9jOnNMfSxsLmFyZ3VtZW50cy5wdXNoKGUsc0IoIl9jYWNoZSIpLHNCKFN0cmluZyhuLmNhY2hlZC5sZW5ndGgpKSksbi5jYWNoZWQucHVzaChudWxsKX1lbHNlIGwuYXJndW1lbnRzLnB1c2goc0goYWkodC5wYXJzZVJlc3VsdCksYSwhMCkpfX0pfSk7ZnVuY3Rpb24gYXIoZSx0KXtlLmZpbmFsaXplZHx8KGUuZmluYWxpemVkPSEwKX1mdW5jdGlvbiBhaSh7dmFsdWU6ZSxrZXk6dCxpbmRleDpufSxyPVtdKXt2YXIgaT1bZSx0LG4sLi4ucl07bGV0IGw9aS5sZW5ndGg7Zm9yKDtsLS0mJiFpW2xdOyk7cmV0dXJuIGkuc2xpY2UoMCxsKzEpLm1hcCgoZSx0KT0+ZXx8c0IoIl8iLnJlcGVhdCh0KzEpLCExKSl9bGV0IGFsPXNCKCJ1bmRlZmluZWQiLCExKSxhcz0oZSx0KT0+e2lmKDE9PT1lLnR5cGUmJigxPT09ZS50YWdUeXBlfHwzPT09ZS50YWdUeXBlKSl7bGV0IG49b24oZSwic2xvdCIpO2lmKG4pcmV0dXJuIG4uZXhwLHQuc2NvcGVzLnZTbG90KyssKCk9Pnt0LnNjb3Blcy52U2xvdC0tfX19O2Z1bmN0aW9uIGFvKGUsdCxuKXtsZXQgcj1bc1YoIm5hbWUiLGUpLHNWKCJmbiIsdCldO3JldHVybiBudWxsIT1uJiZyLnB1c2goc1YoImtleSIsc0IoU3RyaW5nKG4pLCEwKSkpLHNGKHIpfWZ1bmN0aW9uIGFhKGUpe3JldHVybiAyIT09ZS50eXBlJiYxMiE9PWUudHlwZXx8KDI9PT1lLnR5cGU/ISFlLmNvbnRlbnQudHJpbSgpOmFhKGUuY29udGVudCkpfWxldCBhYz1uZXcgV2Vha01hcCxhdT0oZSx0KT0+ZnVuY3Rpb24oKXtsZXQgbixyLGksbCxzO2lmKDEhPT0oZT10LmN1cnJlbnROb2RlKS50eXBlfHwwIT09ZS50YWdUeXBlJiYxIT09ZS50YWdUeXBlKXJldHVybjtsZXR7dGFnOm8scHJvcHM6YX09ZSxjPTE9PT1lLnRhZ1R5cGUsdT1jP2Z1bmN0aW9uKGUsdCxuPSExKXtsZXR7dGFnOnJ9PWUsaT1haChyKSxsPW9yKGUsImlzIiwhMSwhMCk7aWYobClpZihpKXtsZXQgZTtpZig2PT09bC50eXBlP2U9bC52YWx1ZSYmc0IobC52YWx1ZS5jb250ZW50LCEwKTooZT1sLmV4cCl8fChlPXNCKCJpcyIsITEsbC5hcmcubG9jKSksZSlyZXR1cm4gc2oodC5oZWxwZXIoc2MpLFtlXSl9ZWxzZSA2PT09bC50eXBlJiZsLnZhbHVlLmNvbnRlbnQuc3RhcnRzV2l0aCgidnVlOiIpJiYocj1sLnZhbHVlLmNvbnRlbnQuc2xpY2UoNCkpO2xldCBzPXMzKHIpfHx0LmlzQnVpbHRJbkNvbXBvbmVudChyKTtyZXR1cm4gcz8obnx8dC5oZWxwZXIocykscyk6KHQuaGVscGVyKHNhKSx0LmNvbXBvbmVudHMuYWRkKHIpLG9wKHIsImNvbXBvbmVudCIpKX0oZSx0KTpgIiR7b30iYCxkPSQodSkmJnUuY2FsbGVlPT09c2MscD0wLGg9ZHx8dT09PWw4fHx1PT09bDV8fCFjJiYoInN2ZyI9PT1vfHwiZm9yZWlnbk9iamVjdCI9PT1vfHwibWF0aCI9PT1vKTtpZihhLmxlbmd0aD4wKXtsZXQgcj1hZChlLHQsdm9pZCAwLGMsZCk7bj1yLnByb3BzLHA9ci5wYXRjaEZsYWcsbD1yLmR5bmFtaWNQcm9wTmFtZXM7bGV0IGk9ci5kaXJlY3RpdmVzO3M9aSYmaS5sZW5ndGg/c0QoaS5tYXAoZT0+KGZ1bmN0aW9uKGUsdCl7bGV0IG49W10scj1hYy5nZXQoZSk7cj9uLnB1c2godC5oZWxwZXJTdHJpbmcocikpOih0LmhlbHBlcihzdSksdC5kaXJlY3RpdmVzLmFkZChlLm5hbWUpLG4ucHVzaChvcChlLm5hbWUsImRpcmVjdGl2ZSIpKSk7bGV0e2xvYzppfT1lO2lmKGUuZXhwJiZuLnB1c2goZS5leHApLGUuYXJnJiYoZS5leHB8fG4ucHVzaCgidm9pZCAwIiksbi5wdXNoKGUuYXJnKSksT2JqZWN0LmtleXMoZS5tb2RpZmllcnMpLmxlbmd0aCl7ZS5hcmd8fChlLmV4cHx8bi5wdXNoKCJ2b2lkIDAiKSxuLnB1c2goInZvaWQgMCIpKTtsZXQgdD1zQigidHJ1ZSIsITEsaSk7bi5wdXNoKHNGKGUubW9kaWZpZXJzLm1hcChlPT5zVihlLHQpKSxpKSl9cmV0dXJuIHNEKG4sZS5sb2MpfSkoZSx0KSkpOnZvaWQgMCxyLnNob3VsZFVzZUJsb2NrJiYoaD0hMCl9aWYoZS5jaGlsZHJlbi5sZW5ndGg+MClpZih1PT09bDkmJihoPSEwLHB8PTEwMjQpLGMmJnUhPT1sOCYmdSE9PWw5KXtsZXR7c2xvdHM6bixoYXNEeW5hbWljU2xvdHM6aX09ZnVuY3Rpb24oZSx0LG49KGUsdCxuLHIpPT5zSChlLG4sITEsITAsbi5sZW5ndGg/blswXS5sb2M6cikpe3QuaGVscGVyKHNFKTtsZXR7Y2hpbGRyZW46cixsb2M6aX09ZSxsPVtdLHM9W10sbz10LnNjb3Blcy52U2xvdD4wfHx0LnNjb3Blcy52Rm9yPjAsYT1vbihlLCJzbG90IiwhMCk7aWYoYSl7bGV0e2FyZzplLGV4cDp0fT1hO2UmJiFzMihlKSYmKG89ITApLGwucHVzaChzVihlfHxzQigiZGVmYXVsdCIsITApLG4odCx2b2lkIDAscixpKSkpfWxldCBjPSExLHU9ITEsZD1bXSxwPW5ldyBTZXQsaD0wO2ZvcihsZXQgZT0wO2U8ci5sZW5ndGg7ZSsrKXtsZXQgaSxmLG0sZyx5PXJbZV07aWYoIW9vKHkpfHwhKGk9b24oeSwic2xvdCIsITApKSl7MyE9PXkudHlwZSYmZC5wdXNoKHkpO2NvbnRpbnVlfWlmKGEpe3Qub25FcnJvcihzMSgzNyxpLmxvYykpO2JyZWFrfWM9ITA7bGV0e2NoaWxkcmVuOmIsbG9jOl99PXkse2FyZzpTPXNCKCJkZWZhdWx0IiwhMCksZXhwOngsbG9jOkN9PWk7czIoUyk/Zj1TP1MuY29udGVudDoiZGVmYXVsdCI6bz0hMDtsZXQgaz1vbih5LCJmb3IiKSxUPW4oeCxrLGIsXyk7aWYobT1vbih5LCJpZiIpKW89ITAscy5wdXNoKHNxKG0uZXhwLGFvKFMsVCxoKyspLGFsKSk7ZWxzZSBpZihnPW9uKHksL15lbHNlKC1pZik/JC8sITApKXtsZXQgbixpPWU7Zm9yKDtpLS0mJiEoMyE9PShuPXJbaV0pLnR5cGUmJmFhKG4pKTspO2lmKG4mJm9vKG4pJiZvbihuLC9eKGVsc2UtKT9pZiQvKSl7bGV0IGU9c1tzLmxlbmd0aC0xXTtmb3IoOzE5PT09ZS5hbHRlcm5hdGUudHlwZTspZT1lLmFsdGVybmF0ZTtlLmFsdGVybmF0ZT1nLmV4cD9zcShnLmV4cCxhbyhTLFQsaCsrKSxhbCk6YW8oUyxULGgrKyl9ZWxzZSB0Lm9uRXJyb3IoczEoMzAsZy5sb2MpKX1lbHNlIGlmKGspe289ITA7bGV0IGU9ay5mb3JQYXJzZVJlc3VsdDtlPyhhcihlKSxzLnB1c2goc2oodC5oZWxwZXIoc2gpLFtlLnNvdXJjZSxzSChhaShlKSxhbyhTLFQpLCEwKV0pKSk6dC5vbkVycm9yKHMxKDMyLGsubG9jKSl9ZWxzZXtpZihmKXtpZihwLmhhcyhmKSl7dC5vbkVycm9yKHMxKDM4LEMpKTtjb250aW51ZX1wLmFkZChmKSwiZGVmYXVsdCI9PT1mJiYodT0hMCl9bC5wdXNoKHNWKFMsVCkpfX1pZighYSl7bGV0IGU9KGUsdCk9PnNWKCJkZWZhdWx0IixuKGUsdm9pZCAwLHQsaSkpO2M/ZC5sZW5ndGgmJmQuc29tZShlPT5hYShlKSkmJih1P3Qub25FcnJvcihzMSgzOSxkWzBdLmxvYykpOmwucHVzaChlKHZvaWQgMCxkKSkpOmwucHVzaChlKHZvaWQgMCxyKSl9bGV0IGY9bz8yOiFmdW5jdGlvbiBlKHQpe2ZvcihsZXQgbj0wO248dC5sZW5ndGg7bisrKXtsZXQgcj10W25dO3N3aXRjaChyLnR5cGUpe2Nhc2UgMTppZigyPT09ci50YWdUeXBlfHxlKHIuY2hpbGRyZW4pKXJldHVybiEwO2JyZWFrO2Nhc2UgOTppZihlKHIuYnJhbmNoZXMpKXJldHVybiEwO2JyZWFrO2Nhc2UgMTA6Y2FzZSAxMTppZihlKHIuY2hpbGRyZW4pKXJldHVybiEwfX1yZXR1cm4hMX0oZS5jaGlsZHJlbik/MTozLG09c0YobC5jb25jYXQoc1YoIl8iLHNCKGYrIiIsITEpKSksaSk7cmV0dXJuIHMubGVuZ3RoJiYobT1zaih0LmhlbHBlcihzbSksW20sc0QocyldKSkse3Nsb3RzOm0saGFzRHluYW1pY1Nsb3RzOm99fShlLHQpO3I9bixpJiYocHw9MTAyNCl9ZWxzZSBpZigxPT09ZS5jaGlsZHJlbi5sZW5ndGgmJnUhPT1sOCl7bGV0IG49ZS5jaGlsZHJlblswXSxpPW4udHlwZSxsPTU9PT1pfHw4PT09aTtsJiYwPT09b1cobix0KSYmKHB8PTEpLHI9bHx8Mj09PWk/bjplLmNoaWxkcmVufWVsc2Ugcj1lLmNoaWxkcmVuO2wmJmwubGVuZ3RoJiYoaT1mdW5jdGlvbihlKXtsZXQgdD0iWyI7Zm9yKGxldCBuPTAscj1lLmxlbmd0aDtuPHI7bisrKXQrPUpTT04uc3RyaW5naWZ5KGVbbl0pLG48ci0xJiYodCs9IiwgIik7cmV0dXJuIHQrIl0ifShsKSksZS5jb2RlZ2VuTm9kZT1zJCh0LHUsbixyLDA9PT1wP3ZvaWQgMDpwLGkscywhIWgsITEsYyxlLmxvYyl9O2Z1bmN0aW9uIGFkKGUsdCxuPWUucHJvcHMscixpLGw9ITEpe2xldCBzLHt0YWc6byxsb2M6YSxjaGlsZHJlbjpjfT1lLHU9W10sZD1bXSxwPVtdLGg9Yy5sZW5ndGg+MCxmPSExLG09MCxnPSExLHk9ITEsYj0hMSxfPSExLFM9ITEseD0hMSxrPVtdLFQ9ZT0+e3UubGVuZ3RoJiYoZC5wdXNoKHNGKGFwKHUpLGEpKSx1PVtdKSxlJiZkLnB1c2goZSl9LE49KCk9Pnt0LnNjb3Blcy52Rm9yPjAmJnUucHVzaChzVihzQigicmVmX2ZvciIsITApLHNCKCJ0cnVlIikpKX0sdz0oe2tleTplLHZhbHVlOm59KT0+e2lmKHMyKGUpKXtsZXQgbD1lLmNvbnRlbnQscz1DKGwpO3MmJighcnx8aSkmJiJvbmNsaWNrIiE9PWwudG9Mb3dlckNhc2UoKSYmIm9uVXBkYXRlOm1vZGVsVmFsdWUiIT09bCYmIWoobCkmJihfPSEwKSxzJiZqKGwpJiYoeD0hMCkscyYmMTQ9PT1uLnR5cGUmJihuPW4uYXJndW1lbnRzWzBdKSwyMD09PW4udHlwZXx8KDQ9PT1uLnR5cGV8fDg9PT1uLnR5cGUpJiZvVyhuLHQpPjB8fCgicmVmIj09PWw/Zz0hMDoiY2xhc3MiPT09bD95PSEwOiJzdHlsZSI9PT1sP2I9ITA6ImtleSI9PT1sfHxrLmluY2x1ZGVzKGwpfHxrLnB1c2gobCksciYmKCJjbGFzcyI9PT1sfHwic3R5bGUiPT09bCkmJiFrLmluY2x1ZGVzKGwpJiZrLnB1c2gobCkpfWVsc2UgUz0hMH07Zm9yKGxldCBpPTA7aTxuLmxlbmd0aDtpKyspe2xldCBzPW5baV07aWYoNj09PXMudHlwZSl7bGV0e2xvYzplLG5hbWU6dCxuYW1lTG9jOm4sdmFsdWU6cn09cztpZigicmVmIj09PXQmJihnPSEwLE4oKSksImlzIj09PXQmJihhaChvKXx8ciYmci5jb250ZW50LnN0YXJ0c1dpdGgoInZ1ZToiKSkpY29udGludWU7dS5wdXNoKHNWKHNCKHQsITAsbiksc0Iocj9yLmNvbnRlbnQ6IiIsITAscj9yLmxvYzplKSkpfWVsc2V7bGV0e25hbWU6bixhcmc6aSxleHA6Yyxsb2M6Zyxtb2RpZmllcnM6eX09cyxiPSJiaW5kIj09PW4sXz0ib24iPT09bjtpZigic2xvdCI9PT1uKXtyfHx0Lm9uRXJyb3IoczEoNDAsZykpO2NvbnRpbnVlfWlmKCJvbmNlIj09PW58fCJtZW1vIj09PW58fCJpcyI9PT1ufHxiJiZvaShpLCJpcyIpJiZhaChvKXx8XyYmbCljb250aW51ZTtpZigoYiYmb2koaSwia2V5Iil8fF8mJmgmJm9pKGksInZ1ZTpiZWZvcmUtdXBkYXRlIikpJiYoZj0hMCksYiYmb2koaSwicmVmIikmJk4oKSwhaSYmKGJ8fF8pKXtTPSEwLGM/Yj8oTigpLFQoKSxkLnB1c2goYykpOlQoe3R5cGU6MTQsbG9jOmcsY2FsbGVlOnQuaGVscGVyKHN4KSxhcmd1bWVudHM6cj9bY106W2MsInRydWUiXX0pOnQub25FcnJvcihzMShiPzM0OjM1LGcpKTtjb250aW51ZX1iJiZ5LnNvbWUoZT0+InByb3AiPT09ZS5jb250ZW50KSYmKG18PTMyKTtsZXQgeD10LmRpcmVjdGl2ZVRyYW5zZm9ybXNbbl07aWYoeCl7bGV0e3Byb3BzOm4sbmVlZFJ1bnRpbWU6cn09eChzLGUsdCk7bHx8bi5mb3JFYWNoKHcpLF8mJmkmJiFzMihpKT9UKHNGKG4sYSkpOnUucHVzaCguLi5uKSxyJiYocC5wdXNoKHMpLEwocikmJmFjLnNldChzLHIpKX1lbHNlIUgobikmJihwLnB1c2gocyksaCYmKGY9ITApKX19aWYoZC5sZW5ndGg/KFQoKSxzPWQubGVuZ3RoPjE/c2oodC5oZWxwZXIoc3YpLGQsYSk6ZFswXSk6dS5sZW5ndGgmJihzPXNGKGFwKHUpLGEpKSxTP218PTE2Oih5JiYhciYmKG18PTIpLGImJiFyJiYobXw9NCksay5sZW5ndGgmJihtfD04KSxfJiYobXw9MzIpKSwhZiYmKDA9PT1tfHwzMj09PW0pJiYoZ3x8eHx8cC5sZW5ndGg+MCkmJihtfD01MTIpLCF0LmluU1NSJiZzKXN3aXRjaChzLnR5cGUpe2Nhc2UgMTU6bGV0IEE9LTEsRT0tMSxJPSExO2ZvcihsZXQgZT0wO2U8cy5wcm9wZXJ0aWVzLmxlbmd0aDtlKyspe2xldCB0PXMucHJvcGVydGllc1tlXS5rZXk7czIodCk/ImNsYXNzIj09PXQuY29udGVudD9BPWU6InN0eWxlIj09PXQuY29udGVudCYmKEU9ZSk6dC5pc0hhbmRsZXJLZXl8fChJPSEwKX1sZXQgUj1zLnByb3BlcnRpZXNbQV0sTz1zLnByb3BlcnRpZXNbRV07ST9zPXNqKHQuaGVscGVyKHNfKSxbc10pOihSJiYhczIoUi52YWx1ZSkmJihSLnZhbHVlPXNqKHQuaGVscGVyKHN5KSxbUi52YWx1ZV0pKSxPJiYoYnx8ND09PU8udmFsdWUudHlwZSYmIlsiPT09Ty52YWx1ZS5jb250ZW50LnRyaW0oKVswXXx8MTc9PT1PLnZhbHVlLnR5cGUpJiYoTy52YWx1ZT1zaih0LmhlbHBlcihzYiksW08udmFsdWVdKSkpO2JyZWFrO2Nhc2UgMTQ6YnJlYWs7ZGVmYXVsdDpzPXNqKHQuaGVscGVyKHNfKSxbc2oodC5oZWxwZXIoc1MpLFtzXSldKX1yZXR1cm57cHJvcHM6cyxkaXJlY3RpdmVzOnAscGF0Y2hGbGFnOm0sZHluYW1pY1Byb3BOYW1lczprLHNob3VsZFVzZUJsb2NrOmZ9fWZ1bmN0aW9uIGFwKGUpe2xldCB0PW5ldyBNYXAsbj1bXTtmb3IobGV0IGw9MDtsPGUubGVuZ3RoO2wrKyl7dmFyIHIsaTtsZXQgcz1lW2xdO2lmKDg9PT1zLmtleS50eXBlfHwhcy5rZXkuaXNTdGF0aWMpe24ucHVzaChzKTtjb250aW51ZX1sZXQgbz1zLmtleS5jb250ZW50LGE9dC5nZXQobyk7YT8oInN0eWxlIj09PW98fCJjbGFzcyI9PT1vfHxDKG8pKSYmKHI9YSxpPXMsMTc9PT1yLnZhbHVlLnR5cGU/ci52YWx1ZS5lbGVtZW50cy5wdXNoKGkudmFsdWUpOnIudmFsdWU9c0QoW3IudmFsdWUsaS52YWx1ZV0sci5sb2MpKToodC5zZXQobyxzKSxuLnB1c2gocykpfXJldHVybiBufWZ1bmN0aW9uIGFoKGUpe3JldHVybiJjb21wb25lbnQiPT09ZXx8IkNvbXBvbmVudCI9PT1lfWxldCBhZj0oZSx0KT0+e2lmKG9hKGUpKXtsZXR7Y2hpbGRyZW46bixsb2M6cn09ZSx7c2xvdE5hbWU6aSxzbG90UHJvcHM6bH09ZnVuY3Rpb24oZSx0KXtsZXQgbixyPSciZGVmYXVsdCInLGk9W107Zm9yKGxldCB0PTA7dDxlLnByb3BzLmxlbmd0aDt0Kyspe2xldCBuPWUucHJvcHNbdF07aWYoNj09PW4udHlwZSluLnZhbHVlJiYoIm5hbWUiPT09bi5uYW1lP3I9SlNPTi5zdHJpbmdpZnkobi52YWx1ZS5jb250ZW50KToobi5uYW1lPUsobi5uYW1lKSxpLnB1c2gobikpKTtlbHNlIGlmKCJiaW5kIj09PW4ubmFtZSYmb2kobi5hcmcsIm5hbWUiKSl7aWYobi5leHApcj1uLmV4cDtlbHNlIGlmKG4uYXJnJiY0PT09bi5hcmcudHlwZSl7bGV0IGU9SyhuLmFyZy5jb250ZW50KTtyPW4uZXhwPXNCKGUsITEsbi5hcmcubG9jKX19ZWxzZSJiaW5kIj09PW4ubmFtZSYmbi5hcmcmJnMyKG4uYXJnKSYmKG4uYXJnLmNvbnRlbnQ9SyhuLmFyZy5jb250ZW50KSksaS5wdXNoKG4pfWlmKGkubGVuZ3RoPjApe2xldHtwcm9wczpyLGRpcmVjdGl2ZXM6bH09YWQoZSx0LGksITEsITEpO249cixsLmxlbmd0aCYmdC5vbkVycm9yKHMxKDM2LGxbMF0ubG9jKSl9cmV0dXJue3Nsb3ROYW1lOnIsc2xvdFByb3BzOm59fShlLHQpLHM9W3QucHJlZml4SWRlbnRpZmllcnM/Il9jdHguJHNsb3RzIjoiJHNsb3RzIixpLCJ7fSIsInVuZGVmaW5lZCIsInRydWUiXSxvPTI7bCYmKHNbMl09bCxvPTMpLG4ubGVuZ3RoJiYoc1szXT1zSChbXSxuLCExLCExLHIpLG89NCksdC5zY29wZUlkJiYhdC5zbG90dGVkJiYobz01KSxzLnNwbGljZShvKSxlLmNvZGVnZW5Ob2RlPXNqKHQuaGVscGVyKHNmKSxzLHIpfX0sYW09KGUsdCxuLHIpPT57bGV0IGkse2xvYzpsLG1vZGlmaWVyczpzLGFyZzpvfT1lO2lmKCFlLmV4cCYmIXMubGVuZ3RoLDQ9PT1vLnR5cGUpaWYoby5pc1N0YXRpYyl7bGV0IGU9by5jb250ZW50O2Uuc3RhcnRzV2l0aCgidnVlOiIpJiYoZT1gdm5vZGUtJHtlLnNsaWNlKDQpfWApLGk9c0IoMCE9PXQudGFnVHlwZXx8ZS5zdGFydHNXaXRoKCJ2bm9kZSIpfHwhL1tBLVpdLy50ZXN0KGUpP1goSyhlKSk6YG9uOiR7ZX1gLCEwLG8ubG9jKX1lbHNlIGk9c1UoW2Ake24uaGVscGVyU3RyaW5nKHNUKX0oYCxvLCIpIl0pO2Vsc2UoaT1vKS5jaGlsZHJlbi51bnNoaWZ0KGAke24uaGVscGVyU3RyaW5nKHNUKX0oYCksaS5jaGlsZHJlbi5wdXNoKCIpIik7bGV0IGE9ZS5leHA7YSYmIWEuY29udGVudC50cmltKCkmJihhPXZvaWQgMCk7bGV0IGM9bi5jYWNoZUhhbmRsZXJzJiYhYSYmIW4uaW5WT25jZTtpZihhKXtsZXQgZSx0PW9lKGEpLG49ISh0fHwoZT1hLG90LnRlc3QoczcoZSkpKSkscj1hLmNvbnRlbnQuaW5jbHVkZXMoIjsiKTsobnx8YyYmdCkmJihhPXNVKFtgJHtuPyIkZXZlbnQiOiIoLi4uYXJncykifSA9PiAke3I/InsiOiIoIn1gLGEscj8ifSI6IikiXSkpfWxldCB1PXtwcm9wczpbc1YoaSxhfHxzQigiKCkgPT4ge30iLCExLGwpKV19O3JldHVybiByJiYodT1yKHUpKSxjJiYodS5wcm9wc1swXS52YWx1ZT1uLmNhY2hlKHUucHJvcHNbMF0udmFsdWUpKSx1LnByb3BzLmZvckVhY2goZT0+ZS5rZXkuaXNIYW5kbGVyS2V5PSEwKSx1fSxhZz0oZSx0KT0+e2lmKDA9PT1lLnR5cGV8fDE9PT1lLnR5cGV8fDExPT09ZS50eXBlfHwxMD09PWUudHlwZSlyZXR1cm4oKT0+e2xldCBuLHI9ZS5jaGlsZHJlbixpPSExO2ZvcihsZXQgZT0wO2U8ci5sZW5ndGg7ZSsrKXtsZXQgdD1yW2VdO2lmKG9sKHQpKXtpPSEwO2ZvcihsZXQgaT1lKzE7aTxyLmxlbmd0aDtpKyspe2xldCBsPXJbaV07aWYob2wobCkpbnx8KG49cltlXT1zVShbdF0sdC5sb2MpKSxuLmNoaWxkcmVuLnB1c2goIiArICIsbCksci5zcGxpY2UoaSwxKSxpLS07ZWxzZXtuPXZvaWQgMDticmVha319fX1pZihpJiYoMSE9PXIubGVuZ3RofHwwIT09ZS50eXBlJiYoMSE9PWUudHlwZXx8MCE9PWUudGFnVHlwZXx8ZS5wcm9wcy5maW5kKGU9Pjc9PT1lLnR5cGUmJiF0LmRpcmVjdGl2ZVRyYW5zZm9ybXNbZS5uYW1lXSkpKSlmb3IobGV0IGU9MDtlPHIubGVuZ3RoO2UrKyl7bGV0IG49cltlXTtpZihvbChuKXx8OD09PW4udHlwZSl7bGV0IGk9W107KDIhPT1uLnR5cGV8fCIgIiE9PW4uY29udGVudCkmJmkucHVzaChuKSx0LnNzcnx8MCE9PW9XKG4sdCl8fGkucHVzaCgiMSIpLHJbZV09e3R5cGU6MTIsY29udGVudDpuLGxvYzpuLmxvYyxjb2RlZ2VuTm9kZTpzaih0LmhlbHBlcihzcyksaSl9fX19fSxhdj1uZXcgV2Vha1NldCxheT0oZSx0KT0+e2lmKDE9PT1lLnR5cGUmJm9uKGUsIm9uY2UiLCEwKSYmIWF2LmhhcyhlKSYmIXQuaW5WT25jZSYmIXQuaW5TU1IpcmV0dXJuIGF2LmFkZChlKSx0LmluVk9uY2U9ITAsdC5oZWxwZXIoc04pLCgpPT57dC5pblZPbmNlPSExO2xldCBlPXQuY3VycmVudE5vZGU7ZS5jb2RlZ2VuTm9kZSYmKGUuY29kZWdlbk5vZGU9dC5jYWNoZShlLmNvZGVnZW5Ob2RlLCEwLCEwKSl9fSxhYj0oZSx0LG4pPT57bGV0IHIse2V4cDppLGFyZzpsfT1lO2lmKCFpKXJldHVybiBuLm9uRXJyb3IoczEoNDEsZS5sb2MpKSxhXygpO2xldCBzPWkubG9jLnNvdXJjZS50cmltKCksbz00PT09aS50eXBlP2kuY29udGVudDpzLGE9bi5iaW5kaW5nTWV0YWRhdGFbc107aWYoInByb3BzIj09PWF8fCJwcm9wcy1hbGlhc2VkIj09PWEpcmV0dXJuIGkubG9jLGFfKCk7aWYoIW8udHJpbSgpfHwhb2UoaSkpcmV0dXJuIG4ub25FcnJvcihzMSg0MixpLmxvYykpLGFfKCk7bGV0IGM9bHx8c0IoIm1vZGVsVmFsdWUiLCEwKSx1PWw/czIobCk/YG9uVXBkYXRlOiR7SyhsLmNvbnRlbnQpfWA6c1UoWycib25VcGRhdGU6IiArICcsbF0pOiJvblVwZGF0ZTptb2RlbFZhbHVlIixkPW4uaXNUUz8iKCRldmVudDogYW55KSI6IiRldmVudCI7cj1zVShbYCR7ZH0gPT4gKChgLGksIikgPSAkZXZlbnQpIl0pO2xldCBwPVtzVihjLGUuZXhwKSxzVih1LHIpXTtpZihlLm1vZGlmaWVycy5sZW5ndGgmJjE9PT10LnRhZ1R5cGUpe2xldCB0PWUubW9kaWZpZXJzLm1hcChlPT5lLmNvbnRlbnQpLm1hcChlPT4oczQoZSk/ZTpKU09OLnN0cmluZ2lmeShlKSkrIjogdHJ1ZSIpLmpvaW4oIiwgIiksbj1sP3MyKGwpP2Ake2wuY29udGVudH1Nb2RpZmllcnNgOnNVKFtsLCcgKyAiTW9kaWZpZXJzIiddKToibW9kZWxNb2RpZmllcnMiO3AucHVzaChzVihuLHNCKGB7ICR7dH0gfWAsITEsZS5sb2MsMikpKX1yZXR1cm4gYV8ocCl9O2Z1bmN0aW9uIGFfKGU9W10pe3JldHVybntwcm9wczplfX1sZXQgYVM9bmV3IFdlYWtTZXQsYXg9KGUsdCk9PntpZigxPT09ZS50eXBlKXtsZXQgbj1vbihlLCJtZW1vIik7aWYoISghbnx8YVMuaGFzKGUpKSlyZXR1cm4gYVMuYWRkKGUpLCgpPT57bGV0IHI9ZS5jb2RlZ2VuTm9kZXx8dC5jdXJyZW50Tm9kZS5jb2RlZ2VuTm9kZTtyJiYxMz09PXIudHlwZSYmKDEhPT1lLnRhZ1R5cGUmJnNXKHIsdCksZS5jb2RlZ2VuTm9kZT1zaih0LmhlbHBlcihzTyksW24uZXhwLHNIKHZvaWQgMCxyKSwiX2NhY2hlIixTdHJpbmcodC5jYWNoZWQubGVuZ3RoKV0pLHQuY2FjaGVkLnB1c2gobnVsbCkpfX19LGFDPVN5bWJvbCgiIiksYWs9U3ltYm9sKCIiKSxhVD1TeW1ib2woIiIpLGFOPVN5bWJvbCgiIiksYXc9U3ltYm9sKCIiKSxhQT1TeW1ib2woIiIpLGFFPVN5bWJvbCgiIiksYUk9U3ltYm9sKCIiKSxhUj1TeW1ib2woIiIpLGFPPVN5bWJvbCgiIik7T2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhyPXtbYUNdOiJ2TW9kZWxSYWRpbyIsW2FrXToidk1vZGVsQ2hlY2tib3giLFthVF06InZNb2RlbFRleHQiLFthTl06InZNb2RlbFNlbGVjdCIsW2F3XToidk1vZGVsRHluYW1pYyIsW2FBXToid2l0aE1vZGlmaWVycyIsW2FFXToid2l0aEtleXMiLFthSV06InZTaG93IixbYVJdOiJUcmFuc2l0aW9uIixbYU9dOiJUcmFuc2l0aW9uR3JvdXAifSkuZm9yRWFjaChlPT57c01bZV09cltlXX0pO2xldCBhUD17cGFyc2VNb2RlOiJodG1sIixpc1ZvaWRUYWc6ZWgsaXNOYXRpdmVUYWc6ZT0+ZXUoZSl8fGVkKGUpfHxlcChlKSxpc1ByZVRhZzplPT4icHJlIj09PWUsaXNJZ25vcmVOZXdsaW5lVGFnOmU9PiJwcmUiPT09ZXx8InRleHRhcmVhIj09PWUsZGVjb2RlRW50aXRpZXM6ZnVuY3Rpb24oZSx0PSExKXtyZXR1cm4oZnx8KGY9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikpLHQpPyhmLmlubmVySFRNTD1gPGRpdiBmb289IiR7ZS5yZXBsYWNlKC8iL2csIiZxdW90OyIpfSI+YCxmLmNoaWxkcmVuWzBdLmdldEF0dHJpYnV0ZSgiZm9vIikpOihmLmlubmVySFRNTD1lLGYudGV4dENvbnRlbnQpfSxpc0J1aWx0SW5Db21wb25lbnQ6ZT0+IlRyYW5zaXRpb24iPT09ZXx8InRyYW5zaXRpb24iPT09ZT9hUjoiVHJhbnNpdGlvbkdyb3VwIj09PWV8fCJ0cmFuc2l0aW9uLWdyb3VwIj09PWU/YU86dm9pZCAwLGdldE5hbWVzcGFjZShlLHQsbil7bGV0IHI9dD90Lm5zOm47aWYodCYmMj09PXIpaWYoImFubm90YXRpb24teG1sIj09PXQudGFnKXtpZigic3ZnIj09PWUpcmV0dXJuIDE7dC5wcm9wcy5zb21lKGU9PjY9PT1lLnR5cGUmJiJlbmNvZGluZyI9PT1lLm5hbWUmJm51bGwhPWUudmFsdWUmJigidGV4dC9odG1sIj09PWUudmFsdWUuY29udGVudHx8ImFwcGxpY2F0aW9uL3hodG1sK3htbCI9PT1lLnZhbHVlLmNvbnRlbnQpKSYmKHI9MCl9ZWxzZS9ebSg/Oltpb25zXXx0ZXh0KSQvLnRlc3QodC50YWcpJiYibWdseXBoIiE9PWUmJiJtYWxpZ25tYXJrIiE9PWUmJihyPTApO2Vsc2UgdCYmMT09PXImJigiZm9yZWlnbk9iamVjdCI9PT10LnRhZ3x8ImRlc2MiPT09dC50YWd8fCJ0aXRsZSI9PT10LnRhZykmJihyPTApO2lmKDA9PT1yKXtpZigic3ZnIj09PWUpcmV0dXJuIDE7aWYoIm1hdGgiPT09ZSlyZXR1cm4gMn1yZXR1cm4gcn19LGFNPXkoInBhc3NpdmUsb25jZSxjYXB0dXJlIiksYUw9eSgic3RvcCxwcmV2ZW50LHNlbGYsY3RybCxzaGlmdCxhbHQsbWV0YSxleGFjdCxtaWRkbGUiKSxhJD15KCJsZWZ0LHJpZ2h0IiksYUQ9eSgib25rZXl1cCxvbmtleWRvd24sb25rZXlwcmVzcyIpLGFGPShlLHQpPT5zMihlKSYmIm9uY2xpY2siPT09ZS5jb250ZW50LnRvTG93ZXJDYXNlKCk/c0IodCwhMCk6NCE9PWUudHlwZT9zVShbIigiLGUsYCkgPT09ICJvbkNsaWNrIiA/ICIke3R9IiA6IChgLGUsIikiXSk6ZSxhVj0oZSx0KT0+ezE9PT1lLnR5cGUmJjA9PT1lLnRhZ1R5cGUmJigic2NyaXB0Ij09PWUudGFnfHwic3R5bGUiPT09ZS50YWcpJiZ0LnJlbW92ZU5vZGUoKX0sYUI9W2U9PnsxPT09ZS50eXBlJiZlLnByb3BzLmZvckVhY2goKHQsbik9PntsZXQgcixpOzY9PT10LnR5cGUmJiJzdHlsZSI9PT10Lm5hbWUmJnQudmFsdWUmJihlLnByb3BzW25dPXt0eXBlOjcsbmFtZToiYmluZCIsYXJnOnNCKCJzdHlsZSIsITAsdC5sb2MpLGV4cDoocj10LnZhbHVlLmNvbnRlbnQsaT10LmxvYyxzQihKU09OLnN0cmluZ2lmeShlYShyKSksITEsaSwzKSksbW9kaWZpZXJzOltdLGxvYzp0LmxvY30pfSl9XSxhVT17Y2xvYWs6KCk9Pih7cHJvcHM6W119KSxodG1sOihlLHQsbik9PntsZXR7ZXhwOnIsbG9jOml9PWU7cmV0dXJuIHJ8fG4ub25FcnJvcihzMSg1MyxpKSksdC5jaGlsZHJlbi5sZW5ndGgmJihuLm9uRXJyb3IoczEoNTQsaSkpLHQuY2hpbGRyZW4ubGVuZ3RoPTApLHtwcm9wczpbc1Yoc0IoImlubmVySFRNTCIsITAsaSkscnx8c0IoIiIsITApKV19fSx0ZXh0OihlLHQsbik9PntsZXR7ZXhwOnIsbG9jOml9PWU7cmV0dXJuIHJ8fG4ub25FcnJvcihzMSg1NSxpKSksdC5jaGlsZHJlbi5sZW5ndGgmJihuLm9uRXJyb3IoczEoNTYsaSkpLHQuY2hpbGRyZW4ubGVuZ3RoPTApLHtwcm9wczpbc1Yoc0IoInRleHRDb250ZW50IiwhMCkscj9vVyhyLG4pPjA/cjpzaihuLmhlbHBlclN0cmluZyhzZyksW3JdLGkpOnNCKCIiLCEwKSldfX0sbW9kZWw6KGUsdCxuKT0+e2xldCByPWFiKGUsdCxuKTtpZighci5wcm9wcy5sZW5ndGh8fDE9PT10LnRhZ1R5cGUpcmV0dXJuIHI7ZS5hcmcmJm4ub25FcnJvcihzMSg1OCxlLmFyZy5sb2MpKTtsZXR7dGFnOml9PXQsbD1uLmlzQ3VzdG9tRWxlbWVudChpKTtpZigiaW5wdXQiPT09aXx8InRleHRhcmVhIj09PWl8fCJzZWxlY3QiPT09aXx8bCl7bGV0IHM9YVQsbz0hMTtpZigiaW5wdXQiPT09aXx8bCl7bGV0IHI9b3IodCwidHlwZSIpO2lmKHIpe2lmKDc9PT1yLnR5cGUpcz1hdztlbHNlIGlmKHIudmFsdWUpc3dpdGNoKHIudmFsdWUuY29udGVudCl7Y2FzZSJyYWRpbyI6cz1hQzticmVhaztjYXNlImNoZWNrYm94IjpzPWFrO2JyZWFrO2Nhc2UiZmlsZSI6bz0hMCxuLm9uRXJyb3IoczEoNTksZS5sb2MpKX19ZWxzZSB0LnByb3BzLnNvbWUoZT0+Nz09PWUudHlwZSYmImJpbmQiPT09ZS5uYW1lJiYoIWUuYXJnfHw0IT09ZS5hcmcudHlwZXx8IWUuYXJnLmlzU3RhdGljKSkmJihzPWF3KX1lbHNlInNlbGVjdCI9PT1pJiYocz1hTik7b3x8KHIubmVlZFJ1bnRpbWU9bi5oZWxwZXIocykpfWVsc2Ugbi5vbkVycm9yKHMxKDU3LGUubG9jKSk7cmV0dXJuIHIucHJvcHM9ci5wcm9wcy5maWx0ZXIoZT0+NCE9PWUua2V5LnR5cGV8fCJtb2RlbFZhbHVlIiE9PWUua2V5LmNvbnRlbnQpLHJ9LG9uOihlLHQsbik9PmFtKGUsdCxuLHQ9PntsZXR7bW9kaWZpZXJzOnJ9PWU7aWYoIXIubGVuZ3RoKXJldHVybiB0O2xldHtrZXk6aSx2YWx1ZTpsfT10LnByb3BzWzBdLHtrZXlNb2RpZmllcnM6cyxub25LZXlNb2RpZmllcnM6byxldmVudE9wdGlvbk1vZGlmaWVyczphfT0oKGUsdCxuLHIpPT57bGV0IGk9W10sbD1bXSxzPVtdO2ZvcihsZXQgbj0wO248dC5sZW5ndGg7bisrKXtsZXQgcj10W25dLmNvbnRlbnQ7YU0ocik/cy5wdXNoKHIpOmEkKHIpP3MyKGUpP2FEKGUuY29udGVudC50b0xvd2VyQ2FzZSgpKT9pLnB1c2gocik6bC5wdXNoKHIpOihpLnB1c2gociksbC5wdXNoKHIpKTphTChyKT9sLnB1c2gocik6aS5wdXNoKHIpfXJldHVybntrZXlNb2RpZmllcnM6aSxub25LZXlNb2RpZmllcnM6bCxldmVudE9wdGlvbk1vZGlmaWVyczpzfX0pKGksciwwLGUubG9jKTtpZihvLmluY2x1ZGVzKCJyaWdodCIpJiYoaT1hRihpLCJvbkNvbnRleHRtZW51IikpLG8uaW5jbHVkZXMoIm1pZGRsZSIpJiYoaT1hRihpLCJvbk1vdXNldXAiKSksby5sZW5ndGgmJihsPXNqKG4uaGVscGVyKGFBKSxbbCxKU09OLnN0cmluZ2lmeShvKV0pKSxzLmxlbmd0aCYmKCFzMihpKXx8YUQoaS5jb250ZW50LnRvTG93ZXJDYXNlKCkpKSYmKGw9c2oobi5oZWxwZXIoYUUpLFtsLEpTT04uc3RyaW5naWZ5KHMpXSkpLGEubGVuZ3RoKXtsZXQgZT1hLm1hcChHKS5qb2luKCIiKTtpPXMyKGkpP3NCKGAke2kuY29udGVudH0ke2V9YCwhMCk6c1UoWyIoIixpLGApICsgIiR7ZX0iYF0pfXJldHVybntwcm9wczpbc1YoaSxsKV19fSksc2hvdzooZSx0LG4pPT57bGV0e2V4cDpyLGxvYzppfT1lO3JldHVybiByfHxuLm9uRXJyb3IoczEoNjEsaSkpLHtwcm9wczpbXSxuZWVkUnVudGltZTpuLmhlbHBlcihhSSl9fX0sYWo9T2JqZWN0LmNyZWF0ZShudWxsKTtmdW5jdGlvbiBhSChlLHQpe2lmKCFNKGUpKWlmKCFlLm5vZGVUeXBlKXJldHVybiBTO2Vsc2UgZT1lLmlubmVySFRNTDtsZXQgbj1lK0pTT04uc3RyaW5naWZ5KHQsKGUsdCk9PiJmdW5jdGlvbiI9PXR5cGVvZiB0P3QudG9TdHJpbmcoKTp0KSxyPWFqW25dO2lmKHIpcmV0dXJuIHI7aWYoIiMiPT09ZVswXSl7bGV0IHQ9ZG9jdW1lbnQucXVlcnlTZWxlY3RvcihlKTtlPXQ/dC5pbm5lckhUTUw6IiJ9bGV0IGk9VCh7aG9pc3RTdGF0aWM6ITAsb25FcnJvcjp2b2lkIDAsb25XYXJuOlN9LHQpO2kuaXNDdXN0b21FbGVtZW50fHwidW5kZWZpbmVkIj09dHlwZW9mIGN1c3RvbUVsZW1lbnRzfHwoaS5pc0N1c3RvbUVsZW1lbnQ9ZT0+ISFjdXN0b21FbGVtZW50cy5nZXQoZSkpO2xldHtjb2RlOmx9PWZ1bmN0aW9uKGUsdD17fSl7cmV0dXJuIGZ1bmN0aW9uKGUsdD17fSl7bGV0IG49dC5vbkVycm9yfHxzWSxyPSJtb2R1bGUiPT09dC5tb2RlOyEwPT09dC5wcmVmaXhJZGVudGlmaWVycz9uKHMxKDQ3KSk6ciYmbihzMSg0OCkpLHQuY2FjaGVIYW5kbGVycyYmbihzMSg0OSkpLHQuc2NvcGVJZCYmIXImJm4oczEoNTApKTtsZXQgaT1UKHt9LHQse3ByZWZpeElkZW50aWZpZXJzOiExfSksbD1NKGUpP2Z1bmN0aW9uKGUsdCl7aWYob3cucmVzZXQoKSxveT1udWxsLG9iPW51bGwsb189IiIsb1M9LTEsb3g9LTEsb04ubGVuZ3RoPTAsb3Y9ZSxvbT1UKHt9LG9mKSx0KXtsZXQgZTtmb3IoZSBpbiB0KW51bGwhPXRbZV0mJihvbVtlXT10W2VdKX1vdy5tb2RlPSJodG1sIj09PW9tLnBhcnNlTW9kZT8xOjIqKCJzZmMiPT09b20ucGFyc2VNb2RlKSxvdy5pblhNTD0xPT09b20ubnN8fDI9PT1vbS5ucztsZXQgbj10JiZ0LmRlbGltaXRlcnM7biYmKG93LmRlbGltaXRlck9wZW49c1EoblswXSksb3cuZGVsaW1pdGVyQ2xvc2U9c1EoblsxXSkpO2xldCByPW9nPWZ1bmN0aW9uKGUsdD0iIil7cmV0dXJue3R5cGU6MCxzb3VyY2U6dCxjaGlsZHJlbjplLGhlbHBlcnM6bmV3IFNldCxjb21wb25lbnRzOltdLGRpcmVjdGl2ZXM6W10saG9pc3RzOltdLGltcG9ydHM6W10sY2FjaGVkOltdLHRlbXBzOjAsY29kZWdlbk5vZGU6dm9pZCAwLGxvYzpzTH19KFtdLGUpO3JldHVybiBvdy5wYXJzZShvdiksci5sb2M9b0IoMCxlLmxlbmd0aCksci5jaGlsZHJlbj1vRChyLmNoaWxkcmVuKSxvZz1udWxsLHJ9KGUsaSk6ZSxbcyxvXT1bW2F5LG80LGF4LGFuLGFmLGF1LGFzLGFnXSx7b246YW0sYmluZDpvNyxtb2RlbDphYn1dO3ZhciBhPVQoe30saSx7bm9kZVRyYW5zZm9ybXM6Wy4uLnMsLi4udC5ub2RlVHJhbnNmb3Jtc3x8W11dLGRpcmVjdGl2ZVRyYW5zZm9ybXM6VCh7fSxvLHQuZGlyZWN0aXZlVHJhbnNmb3Jtc3x8e30pfSk7bGV0IGM9ZnVuY3Rpb24oZSx7ZmlsZW5hbWU6dD0iIixwcmVmaXhJZGVudGlmaWVyczpuPSExLGhvaXN0U3RhdGljOnI9ITEsaG1yOmk9ITEsY2FjaGVIYW5kbGVyczpsPSExLG5vZGVUcmFuc2Zvcm1zOnM9W10sZGlyZWN0aXZlVHJhbnNmb3JtczpvPXt9LHRyYW5zZm9ybUhvaXN0OmE9bnVsbCxpc0J1aWx0SW5Db21wb25lbnQ6Yz1TLGlzQ3VzdG9tRWxlbWVudDp1PVMsZXhwcmVzc2lvblBsdWdpbnM6ZD1bXSxzY29wZUlkOnA9bnVsbCxzbG90dGVkOmg9ITAsc3NyOmY9ITEsaW5TU1I6bT0hMSxzc3JDc3NWYXJzOmc9IiIsYmluZGluZ01ldGFkYXRhOnk9YixpbmxpbmU6Xz0hMSxpc1RTOng9ITEsb25FcnJvcjpDPXNZLG9uV2FybjprPXMwLGNvbXBhdENvbmZpZzpUfSl7bGV0IE49dC5yZXBsYWNlKC9cPy4qJC8sIiIpLm1hdGNoKC8oW14vXFxdKylcLlx3KyQvKSx3PXtmaWxlbmFtZTp0LHNlbGZOYW1lOk4mJkcoSyhOWzFdKSkscHJlZml4SWRlbnRpZmllcnM6bixob2lzdFN0YXRpYzpyLGhtcjppLGNhY2hlSGFuZGxlcnM6bCxub2RlVHJhbnNmb3JtczpzLGRpcmVjdGl2ZVRyYW5zZm9ybXM6byx0cmFuc2Zvcm1Ib2lzdDphLGlzQnVpbHRJbkNvbXBvbmVudDpjLGlzQ3VzdG9tRWxlbWVudDp1LGV4cHJlc3Npb25QbHVnaW5zOmQsc2NvcGVJZDpwLHNsb3R0ZWQ6aCxzc3I6ZixpblNTUjptLHNzckNzc1ZhcnM6ZyxiaW5kaW5nTWV0YWRhdGE6eSxpbmxpbmU6Xyxpc1RTOngsb25FcnJvcjpDLG9uV2FybjprLGNvbXBhdENvbmZpZzpULHJvb3Q6ZSxoZWxwZXJzOm5ldyBNYXAsY29tcG9uZW50czpuZXcgU2V0LGRpcmVjdGl2ZXM6bmV3IFNldCxob2lzdHM6W10saW1wb3J0czpbXSxjYWNoZWQ6W10sY29uc3RhbnRDYWNoZTpuZXcgV2Vha01hcCx0ZW1wczowLGlkZW50aWZpZXJzOk9iamVjdC5jcmVhdGUobnVsbCksc2NvcGVzOnt2Rm9yOjAsdlNsb3Q6MCx2UHJlOjAsdk9uY2U6MH0scGFyZW50Om51bGwsZ3JhbmRQYXJlbnQ6bnVsbCxjdXJyZW50Tm9kZTplLGNoaWxkSW5kZXg6MCxpblZPbmNlOiExLGhlbHBlcihlKXtsZXQgdD13LmhlbHBlcnMuZ2V0KGUpfHwwO3JldHVybiB3LmhlbHBlcnMuc2V0KGUsdCsxKSxlfSxyZW1vdmVIZWxwZXIoZSl7bGV0IHQ9dy5oZWxwZXJzLmdldChlKTtpZih0KXtsZXQgbj10LTE7bj93LmhlbHBlcnMuc2V0KGUsbik6dy5oZWxwZXJzLmRlbGV0ZShlKX19LGhlbHBlclN0cmluZzplPT5gXyR7c01bdy5oZWxwZXIoZSldfWAscmVwbGFjZU5vZGUoZSl7dy5wYXJlbnQuY2hpbGRyZW5bdy5jaGlsZEluZGV4XT13LmN1cnJlbnROb2RlPWV9LHJlbW92ZU5vZGUoZSl7bGV0IHQ9dy5wYXJlbnQuY2hpbGRyZW4sbj1lP3QuaW5kZXhPZihlKTp3LmN1cnJlbnROb2RlP3cuY2hpbGRJbmRleDotMTtlJiZlIT09dy5jdXJyZW50Tm9kZT93LmNoaWxkSW5kZXg+biYmKHcuY2hpbGRJbmRleC0tLHcub25Ob2RlUmVtb3ZlZCgpKToody5jdXJyZW50Tm9kZT1udWxsLHcub25Ob2RlUmVtb3ZlZCgpKSx3LnBhcmVudC5jaGlsZHJlbi5zcGxpY2UobiwxKX0sb25Ob2RlUmVtb3ZlZDpTLGFkZElkZW50aWZpZXJzKGUpe30scmVtb3ZlSWRlbnRpZmllcnMoZSl7fSxob2lzdChlKXtNKGUpJiYoZT1zQihlKSksdy5ob2lzdHMucHVzaChlKTtsZXQgdD1zQihgX2hvaXN0ZWRfJHt3LmhvaXN0cy5sZW5ndGh9YCwhMSxlLmxvYywyKTtyZXR1cm4gdC5ob2lzdGVkPWUsdH0sY2FjaGUoZSx0PSExLG49ITEpe2xldCByPWZ1bmN0aW9uKGUsdCxuPSExLHI9ITEpe3JldHVybnt0eXBlOjIwLGluZGV4OmUsdmFsdWU6dCxuZWVkUGF1c2VUcmFja2luZzpuLGluVk9uY2U6cixuZWVkQXJyYXlTcHJlYWQ6ITEsbG9jOnNMfX0ody5jYWNoZWQubGVuZ3RoLGUsdCxuKTtyZXR1cm4gdy5jYWNoZWQucHVzaChyKSxyfX07cmV0dXJuIHd9KGwsYSk7cmV0dXJuIG9HKGwsYyksYS5ob2lzdFN0YXRpYyYmZnVuY3Rpb24gZSh0LG4scixpPSExLGw9ITEpe2xldHtjaGlsZHJlbjpzfT10LG89W107Zm9yKGxldCBuPTA7bjxzLmxlbmd0aDtuKyspe2xldCBhPXNbbl07aWYoMT09PWEudHlwZSYmMD09PWEudGFnVHlwZSl7bGV0IGU9aT8wOm9XKGEscik7aWYoZT4wKXtpZihlPj0yKXthLmNvZGVnZW5Ob2RlLnBhdGNoRmxhZz0tMSxvLnB1c2goYSk7Y29udGludWV9fWVsc2V7bGV0IGU9YS5jb2RlZ2VuTm9kZTtpZigxMz09PWUudHlwZSl7bGV0IHQ9ZS5wYXRjaEZsYWc7aWYoKHZvaWQgMD09PXR8fDUxMj09PXR8fDE9PT10KSYmb3ooYSxyKT49Mil7bGV0IHQ9b0ooYSk7dCYmKGUucHJvcHM9ci5ob2lzdCh0KSl9ZS5keW5hbWljUHJvcHMmJihlLmR5bmFtaWNQcm9wcz1yLmhvaXN0KGUuZHluYW1pY1Byb3BzKSl9fX1lbHNlIGlmKDEyPT09YS50eXBlJiYoaT8wOm9XKGEscikpPj0yKXtvLnB1c2goYSk7Y29udGludWV9aWYoMT09PWEudHlwZSl7bGV0IG49MT09PWEudGFnVHlwZTtuJiZyLnNjb3Blcy52U2xvdCsrLGUoYSx0LHIsITEsbCksbiYmci5zY29wZXMudlNsb3QtLX1lbHNlIGlmKDExPT09YS50eXBlKWUoYSx0LHIsMT09PWEuY2hpbGRyZW4ubGVuZ3RoLCEwKTtlbHNlIGlmKDk9PT1hLnR5cGUpZm9yKGxldCBuPTA7bjxhLmJyYW5jaGVzLmxlbmd0aDtuKyspZShhLmJyYW5jaGVzW25dLHQsciwxPT09YS5icmFuY2hlc1tuXS5jaGlsZHJlbi5sZW5ndGgsbCl9bGV0IGE9ITEsYz1bXTtpZihvLmxlbmd0aD09PXMubGVuZ3RoJiYxPT09dC50eXBlKXtpZigwPT09dC50YWdUeXBlJiZ0LmNvZGVnZW5Ob2RlJiYxMz09PXQuY29kZWdlbk5vZGUudHlwZSYmRSh0LmNvZGVnZW5Ob2RlLmNoaWxkcmVuKSl0LmNvZGVnZW5Ob2RlLmNoaWxkcmVuPXUoc0QodC5jb2RlZ2VuTm9kZS5jaGlsZHJlbikpLGE9ITA7ZWxzZSBpZigxPT09dC50YWdUeXBlJiZ0LmNvZGVnZW5Ob2RlJiYxMz09PXQuY29kZWdlbk5vZGUudHlwZSYmdC5jb2RlZ2VuTm9kZS5jaGlsZHJlbiYmIUUodC5jb2RlZ2VuTm9kZS5jaGlsZHJlbikmJjE1PT09dC5jb2RlZ2VuTm9kZS5jaGlsZHJlbi50eXBlKXtsZXQgZT1kKHQuY29kZWdlbk5vZGUsImRlZmF1bHQiKTtlJiYoYy5wdXNoKHIuY2FjaGVkLmxlbmd0aCksZS5yZXR1cm5zPXUoc0QoZS5yZXR1cm5zKSksYT0hMCl9ZWxzZSBpZigzPT09dC50YWdUeXBlJiZuJiYxPT09bi50eXBlJiYxPT09bi50YWdUeXBlJiZuLmNvZGVnZW5Ob2RlJiYxMz09PW4uY29kZWdlbk5vZGUudHlwZSYmbi5jb2RlZ2VuTm9kZS5jaGlsZHJlbiYmIUUobi5jb2RlZ2VuTm9kZS5jaGlsZHJlbikmJjE1PT09bi5jb2RlZ2VuTm9kZS5jaGlsZHJlbi50eXBlKXtsZXQgZT1vbih0LCJzbG90IiwhMCksaT1lJiZlLmFyZyYmZChuLmNvZGVnZW5Ob2RlLGUuYXJnKTtpJiYoYy5wdXNoKHIuY2FjaGVkLmxlbmd0aCksaS5yZXR1cm5zPXUoc0QoaS5yZXR1cm5zKSksYT0hMCl9fWlmKCFhKWZvcihsZXQgZSBvZiBvKWMucHVzaChyLmNhY2hlZC5sZW5ndGgpLGUuY29kZWdlbk5vZGU9ci5jYWNoZShlLmNvZGVnZW5Ob2RlKTtmdW5jdGlvbiB1KGUpe2xldCB0PXIuY2FjaGUoZSk7cmV0dXJuIGwmJnIuaG1yJiYodC5uZWVkQXJyYXlTcHJlYWQ9ITApLHR9ZnVuY3Rpb24gZChlLHQpe2lmKGUuY2hpbGRyZW4mJiFFKGUuY2hpbGRyZW4pJiYxNT09PWUuY2hpbGRyZW4udHlwZSl7bGV0IG49ZS5jaGlsZHJlbi5wcm9wZXJ0aWVzLmZpbmQoZT0+ZS5rZXk9PT10fHxlLmtleS5jb250ZW50PT09dCk7cmV0dXJuIG4mJm4udmFsdWV9fWMubGVuZ3RoJiYxPT09dC50eXBlJiYxPT09dC50YWdUeXBlJiZ0LmNvZGVnZW5Ob2RlJiYxMz09PXQuY29kZWdlbk5vZGUudHlwZSYmdC5jb2RlZ2VuTm9kZS5jaGlsZHJlbiYmIUUodC5jb2RlZ2VuTm9kZS5jaGlsZHJlbikmJjE1PT09dC5jb2RlZ2VuTm9kZS5jaGlsZHJlbi50eXBlJiZ0LmNvZGVnZW5Ob2RlLmNoaWxkcmVuLnByb3BlcnRpZXMucHVzaChzVigiX18iLHNCKEpTT04uc3RyaW5naWZ5KGMpLCExKSkpLG8ubGVuZ3RoJiZyLnRyYW5zZm9ybUhvaXN0JiZyLnRyYW5zZm9ybUhvaXN0KHMscix0KX0obCx2b2lkIDAsYywhIW9xKGwpKSxhLnNzcnx8ZnVuY3Rpb24oZSx0KXtsZXR7aGVscGVyOm59PXQse2NoaWxkcmVuOnJ9PWU7aWYoMT09PXIubGVuZ3RoKXtsZXQgbj1vcShlKTtpZihuJiZuLmNvZGVnZW5Ob2RlKXtsZXQgcj1uLmNvZGVnZW5Ob2RlOzEzPT09ci50eXBlJiZzVyhyLHQpLGUuY29kZWdlbk5vZGU9cn1lbHNlIGUuY29kZWdlbk5vZGU9clswXX1lbHNlIHIubGVuZ3RoPjEmJihlLmNvZGVnZW5Ob2RlPXMkKHQsbihsNCksdm9pZCAwLGUuY2hpbGRyZW4sNjQsdm9pZCAwLHZvaWQgMCwhMCx2b2lkIDAsITEpKX0obCxjKSxsLmhlbHBlcnM9bmV3IFNldChbLi4uYy5oZWxwZXJzLmtleXMoKV0pLGwuY29tcG9uZW50cz1bLi4uYy5jb21wb25lbnRzXSxsLmRpcmVjdGl2ZXM9Wy4uLmMuZGlyZWN0aXZlc10sbC5pbXBvcnRzPWMuaW1wb3J0cyxsLmhvaXN0cz1jLmhvaXN0cyxsLnRlbXBzPWMudGVtcHMsbC5jYWNoZWQ9Yy5jYWNoZWQsbC50cmFuc2Zvcm1lZD0hMCxmdW5jdGlvbihlLHQ9e30pe2xldCBuPWZ1bmN0aW9uKGUse21vZGU6dD0iZnVuY3Rpb24iLHByZWZpeElkZW50aWZpZXJzOm49Im1vZHVsZSI9PT10LHNvdXJjZU1hcDpyPSExLGZpbGVuYW1lOmk9InRlbXBsYXRlLnZ1ZS5odG1sIixzY29wZUlkOmw9bnVsbCxvcHRpbWl6ZUltcG9ydHM6cz0hMSxydW50aW1lR2xvYmFsTmFtZTpvPSJWdWUiLHJ1bnRpbWVNb2R1bGVOYW1lOmE9InZ1ZSIsc3NyUnVudGltZU1vZHVsZU5hbWU6Yz0idnVlL3NlcnZlci1yZW5kZXJlciIsc3NyOnU9ITEsaXNUUzpkPSExLGluU1NSOnA9ITF9KXtsZXQgaD17bW9kZTp0LHByZWZpeElkZW50aWZpZXJzOm4sc291cmNlTWFwOnIsZmlsZW5hbWU6aSxzY29wZUlkOmwsb3B0aW1pemVJbXBvcnRzOnMscnVudGltZUdsb2JhbE5hbWU6byxydW50aW1lTW9kdWxlTmFtZTphLHNzclJ1bnRpbWVNb2R1bGVOYW1lOmMsc3NyOnUsaXNUUzpkLGluU1NSOnAsc291cmNlOmUuc291cmNlLGNvZGU6IiIsY29sdW1uOjEsbGluZToxLG9mZnNldDowLGluZGVudExldmVsOjAscHVyZTohMSxtYXA6dm9pZCAwLGhlbHBlcjplPT5gXyR7c01bZV19YCxwdXNoKGUsdD0tMixuKXtoLmNvZGUrPWV9LGluZGVudCgpe2YoKytoLmluZGVudExldmVsKX0sZGVpbmRlbnQoZT0hMSl7ZT8tLWguaW5kZW50TGV2ZWw6ZigtLWguaW5kZW50TGV2ZWwpfSxuZXdsaW5lKCl7ZihoLmluZGVudExldmVsKX19O2Z1bmN0aW9uIGYoZSl7aC5wdXNoKGANCmArIiAgIi5yZXBlYXQoZSksMCl9cmV0dXJuIGh9KGUsdCk7dC5vbkNvbnRleHRDcmVhdGVkJiZ0Lm9uQ29udGV4dENyZWF0ZWQobik7bGV0e21vZGU6cixwdXNoOmkscHJlZml4SWRlbnRpZmllcnM6bCxpbmRlbnQ6cyxkZWluZGVudDpvLG5ld2xpbmU6YSxzY29wZUlkOmMsc3NyOnV9PW4sZD1BcnJheS5mcm9tKGUuaGVscGVycykscD1kLmxlbmd0aD4wLGg9IWwmJiJtb2R1bGUiIT09cjt2YXIgZj1lLG09bjtsZXR7c3NyOmcscHJlZml4SWRlbnRpZmllcnM6eSxwdXNoOmIsbmV3bGluZTpfLHJ1bnRpbWVNb2R1bGVOYW1lOlMscnVudGltZUdsb2JhbE5hbWU6eCxzc3JSdW50aW1lTW9kdWxlTmFtZTpDfT1tLGs9QXJyYXkuZnJvbShmLmhlbHBlcnMpO2lmKGsubGVuZ3RoPjAmJihiKGBjb25zdCBfVnVlID0gJHt4fQ0KYCwtMSksZi5ob2lzdHMubGVuZ3RoKSl7bGV0IGU9W3NyLHNpLHNsLHNzLHNvXS5maWx0ZXIoZT0+ay5pbmNsdWRlcyhlKSkubWFwKG9aKS5qb2luKCIsICIpO2IoYGNvbnN0IHsgJHtlfSB9ID0gX1Z1ZQ0KYCwtMSl9KGZ1bmN0aW9uKGUsdCl7aWYoIWUubGVuZ3RoKXJldHVybjt0LnB1cmU9ITA7bGV0e3B1c2g6bixuZXdsaW5lOnJ9PXQ7cigpO2ZvcihsZXQgaT0wO2k8ZS5sZW5ndGg7aSsrKXtsZXQgbD1lW2ldO2wmJihuKGBjb25zdCBfaG9pc3RlZF8ke2krMX0gPSBgKSxvMihsLHQpLHIoKSl9dC5wdXJlPSExfSkoZi5ob2lzdHMsbSksXygpLGIoInJldHVybiAiKTtsZXQgVD0odT9bIl9jdHgiLCJfcHVzaCIsIl9wYXJlbnQiLCJfYXR0cnMiXTpbIl9jdHgiLCJfY2FjaGUiXSkuam9pbigiLCAiKTtpZihpKGBmdW5jdGlvbiAke3U/InNzclJlbmRlciI6InJlbmRlciJ9KCR7VH0pIHtgKSxzKCksaCYmKGkoIndpdGggKF9jdHgpIHsiKSxzKCkscCYmKGkoYGNvbnN0IHsgJHtkLm1hcChvWikuam9pbigiLCAiKX0gfSA9IF9WdWUNCmAsLTEpLGEoKSkpLGUuY29tcG9uZW50cy5sZW5ndGgmJihvWShlLmNvbXBvbmVudHMsImNvbXBvbmVudCIsbiksKGUuZGlyZWN0aXZlcy5sZW5ndGh8fGUudGVtcHM+MCkmJmEoKSksZS5kaXJlY3RpdmVzLmxlbmd0aCYmKG9ZKGUuZGlyZWN0aXZlcywiZGlyZWN0aXZlIixuKSxlLnRlbXBzPjAmJmEoKSksZS50ZW1wcz4wKXtpKCJsZXQgIik7Zm9yKGxldCB0PTA7dDxlLnRlbXBzO3QrKylpKGAke3Q+MD8iLCAiOiIifV90ZW1wJHt0fWApfXJldHVybihlLmNvbXBvbmVudHMubGVuZ3RofHxlLmRpcmVjdGl2ZXMubGVuZ3RofHxlLnRlbXBzKSYmKGkoYA0KYCwwKSxhKCkpLHV8fGkoInJldHVybiAiKSxlLmNvZGVnZW5Ob2RlP28yKGUuY29kZWdlbk5vZGUsbik6aSgibnVsbCIpLGgmJihvKCksaSgifSIpKSxvKCksaSgifSIpLHthc3Q6ZSxjb2RlOm4uY29kZSxwcmVhbWJsZToiIixtYXA6bi5tYXA/bi5tYXAudG9KU09OKCk6dm9pZCAwfX0obCxpKX0oZSxUKHt9LGFQLHQse25vZGVUcmFuc2Zvcm1zOlthViwuLi5hQiwuLi50Lm5vZGVUcmFuc2Zvcm1zfHxbXV0sZGlyZWN0aXZlVHJhbnNmb3JtczpUKHt9LGFVLHQuZGlyZWN0aXZlVHJhbnNmb3Jtc3x8e30pLHRyYW5zZm9ybUhvaXN0Om51bGx9KSl9KGUsaSkscz1GdW5jdGlvbihsKSgpO3JldHVybiBzLl9yYz0hMCxhaltuXT1zfXJldHVybiBpTChhSCksZS5CYXNlVHJhbnNpdGlvbj1ueSxlLkJhc2VUcmFuc2l0aW9uUHJvcHNWYWxpZGF0b3JzPW5tLGUuQ29tbWVudD1pZSxlLkRlcHJlY2F0aW9uVHlwZXM9bnVsbCxlLkVmZmVjdFNjb3BlPWVTLGUuRXJyb3JDb2Rlcz17U0VUVVBfRlVOQ1RJT046MCwwOiJTRVRVUF9GVU5DVElPTiIsUkVOREVSX0ZVTkNUSU9OOjEsMToiUkVOREVSX0ZVTkNUSU9OIixOQVRJVkVfRVZFTlRfSEFORExFUjo1LDU6Ik5BVElWRV9FVkVOVF9IQU5ETEVSIixDT01QT05FTlRfRVZFTlRfSEFORExFUjo2LDY6IkNPTVBPTkVOVF9FVkVOVF9IQU5ETEVSIixWTk9ERV9IT09LOjcsNzoiVk5PREVfSE9PSyIsRElSRUNUSVZFX0hPT0s6OCw4OiJESVJFQ1RJVkVfSE9PSyIsVFJBTlNJVElPTl9IT09LOjksOToiVFJBTlNJVElPTl9IT09LIixBUFBfRVJST1JfSEFORExFUjoxMCwxMDoiQVBQX0VSUk9SX0hBTkRMRVIiLEFQUF9XQVJOX0hBTkRMRVI6MTEsMTE6IkFQUF9XQVJOX0hBTkRMRVIiLEZVTkNUSU9OX1JFRjoxMiwxMjoiRlVOQ1RJT05fUkVGIixBU1lOQ19DT01QT05FTlRfTE9BREVSOjEzLDEzOiJBU1lOQ19DT01QT05FTlRfTE9BREVSIixTQ0hFRFVMRVI6MTQsMTQ6IlNDSEVEVUxFUiIsQ09NUE9ORU5UX1VQREFURToxNSwxNToiQ09NUE9ORU5UX1VQREFURSIsQVBQX1VOTU9VTlRfQ0xFQU5VUDoxNiwxNjoiQVBQX1VOTU9VTlRfQ0xFQU5VUCJ9LGUuRXJyb3JUeXBlU3RyaW5ncz1udWxsLGUuRnJhZ21lbnQ9cjksZS5LZWVwQWxpdmU9e25hbWU6IktlZXBBbGl2ZSIsX19pc0tlZXBBbGl2ZTohMCxwcm9wczp7aW5jbHVkZTpbU3RyaW5nLFJlZ0V4cCxBcnJheV0sZXhjbHVkZTpbU3RyaW5nLFJlZ0V4cCxBcnJheV0sbWF4OltTdHJpbmcsTnVtYmVyXX0sc2V0dXAoZSx7c2xvdHM6dH0pe2xldCBuPWlFKCkscj1uLmN0eCxpPW5ldyBNYXAsbD1uZXcgU2V0LHM9bnVsbCxvPW4uc3VzcGVuc2Use3JlbmRlcmVyOntwOmEsbTpjLHVtOnUsbzp7Y3JlYXRlRWxlbWVudDpkfX19PXIscD1kKCJkaXYiKTtmdW5jdGlvbiBoKGUpe25XKGUpLHUoZSxuLG8sITApfWZ1bmN0aW9uIGYoZSl7aS5mb3JFYWNoKCh0LG4pPT57bGV0IHI9aUIodC50eXBlKTtyJiYhZShyKSYmbShuKX0pfWZ1bmN0aW9uIG0oZSl7bGV0IHQ9aS5nZXQoZSk7IXR8fHMmJmlwKHQscyk/cyYmblcocyk6aCh0KSxpLmRlbGV0ZShlKSxsLmRlbGV0ZShlKX1yLmFjdGl2YXRlPShlLHQsbixyLGkpPT57bGV0IGw9ZS5jb21wb25lbnQ7YyhlLHQsbiwwLG8pLGEobC52bm9kZSxlLHQsbixsLG8scixlLnNsb3RTY29wZUlkcyxpKSxyTSgoKT0+e2wuaXNEZWFjdGl2YXRlZD0hMSxsLmEmJloobC5hKTtsZXQgdD1lLnByb3BzJiZlLnByb3BzLm9uVm5vZGVNb3VudGVkO3QmJmlUKHQsbC5wYXJlbnQsZSl9LG8pfSxyLmRlYWN0aXZhdGU9ZT0+e2xldCB0PWUuY29tcG9uZW50O3JVKHQubSksclUodC5hKSxjKGUscCxudWxsLDEsbyksck0oKCk9Pnt0LmRhJiZaKHQuZGEpO2xldCBuPWUucHJvcHMmJmUucHJvcHMub25Wbm9kZVVubW91bnRlZDtuJiZpVChuLHQucGFyZW50LGUpLHQuaXNEZWFjdGl2YXRlZD0hMH0sbyl9LHJxKCgpPT5bZS5pbmNsdWRlLGUuZXhjbHVkZV0sKFtlLHRdKT0+e2UmJmYodD0+blUoZSx0KSksdCYmZihlPT4hblUodCxlKSl9LHtmbHVzaDoicG9zdCIsZGVlcDohMH0pO2xldCBnPW51bGwseT0oKT0+e251bGwhPWcmJihyMShuLnN1YlRyZWUudHlwZSk/ck0oKCk9PntpLnNldChnLG5LKG4uc3ViVHJlZSkpfSxuLnN1YlRyZWUuc3VzcGVuc2UpOmkuc2V0KGcsbksobi5zdWJUcmVlKSkpfTtyZXR1cm4gblgoeSksblooeSksblkoKCk9PntpLmZvckVhY2goZT0+e2xldHtzdWJUcmVlOnQsc3VzcGVuc2U6cn09bixpPW5LKHQpO2lmKGUudHlwZT09PWkudHlwZSYmZS5rZXk9PT1pLmtleSl7blcoaSk7bGV0IGU9aS5jb21wb25lbnQuZGE7ZSYmck0oZSxyKTtyZXR1cm59aChlKX0pfSksKCk9PntpZihnPW51bGwsIXQuZGVmYXVsdClyZXR1cm4gcz1udWxsO2xldCBuPXQuZGVmYXVsdCgpLHI9blswXTtpZihuLmxlbmd0aD4xKXJldHVybiBzPW51bGwsbjtpZighaWQocil8fCEoNCZyLnNoYXBlRmxhZykmJiEoMTI4JnIuc2hhcGVGbGFnKSlyZXR1cm4gcz1udWxsLHI7bGV0IG89bksocik7aWYoby50eXBlPT09aWUpcmV0dXJuIHM9bnVsbCxvO2xldCBhPW8udHlwZSxjPWlCKG5GKG8pP28udHlwZS5fX2FzeW5jUmVzb2x2ZWR8fHt9OmEpLHtpbmNsdWRlOnUsZXhjbHVkZTpkLG1heDpwfT1lO2lmKHUmJighY3x8IW5VKHUsYykpfHxkJiZjJiZuVShkLGMpKXJldHVybiBvLnNoYXBlRmxhZyY9LTI1NyxzPW8scjtsZXQgaD1udWxsPT1vLmtleT9hOm8ua2V5LGY9aS5nZXQoaCk7cmV0dXJuIG8uZWwmJihvPWliKG8pLDEyOCZyLnNoYXBlRmxhZyYmKHIuc3NDb250ZW50PW8pKSxnPWgsZj8oby5lbD1mLmVsLG8uY29tcG9uZW50PWYuY29tcG9uZW50LG8udHJhbnNpdGlvbiYmbkMobyxvLnRyYW5zaXRpb24pLG8uc2hhcGVGbGFnfD01MTIsbC5kZWxldGUoaCksbC5hZGQoaCkpOihsLmFkZChoKSxwJiZsLnNpemU+cGFyc2VJbnQocCwxMCkmJm0obC52YWx1ZXMoKS5uZXh0KCkudmFsdWUpKSxvLnNoYXBlRmxhZ3w9MjU2LHM9byxyMShyLnR5cGUpP3I6b319fSxlLlJlYWN0aXZlRWZmZWN0PWVDLGUuU3RhdGljPWl0LGUuU3VzcGVuc2U9e25hbWU6IlN1c3BlbnNlIixfX2lzU3VzcGVuc2U6ITAscHJvY2VzcyhlLHQsbixyLGksbCxzLG8sYSxjKXtpZihudWxsPT1lKXt2YXIgdT10LGQ9bixwPXIsaD1pLGY9bCxtPXMsZz1vLHk9YSxiPWM7bGV0e3A6ZSxvOntjcmVhdGVFbGVtZW50Ol99fT1iLFM9XygiZGl2IikseD11LnN1c3BlbnNlPXI2KHUsZixoLGQsUyxwLG0sZyx5LGIpO2UobnVsbCx4LnBlbmRpbmdCcmFuY2g9dS5zc0NvbnRlbnQsUyxudWxsLGgseCxtLGcpLHguZGVwcz4wPyhyMyh1LCJvblBlbmRpbmciKSxyMyh1LCJvbkZhbGxiYWNrIiksZShudWxsLHUuc3NGYWxsYmFjayxkLHAsaCxudWxsLG0sZykscjUoeCx1LnNzRmFsbGJhY2spKTp4LnJlc29sdmUoITEsITApfWVsc2V7aWYobCYmbC5kZXBzPjAmJiFlLnN1c3BlbnNlLmlzSW5GYWxsYmFjayl7dC5zdXNwZW5zZT1lLnN1c3BlbnNlLHQuc3VzcGVuc2Uudm5vZGU9dCx0LmVsPWUuZWw7cmV0dXJufSFmdW5jdGlvbihlLHQsbixyLGksbCxzLG8se3A6YSx1bTpjLG86e2NyZWF0ZUVsZW1lbnQ6dX19KXtsZXQgZD10LnN1c3BlbnNlPWUuc3VzcGVuc2U7ZC52bm9kZT10LHQuZWw9ZS5lbDtsZXQgcD10LnNzQ29udGVudCxoPXQuc3NGYWxsYmFjayx7YWN0aXZlQnJhbmNoOmYscGVuZGluZ0JyYW5jaDptLGlzSW5GYWxsYmFjazpnLGlzSHlkcmF0aW5nOnl9PWQ7aWYobSlkLnBlbmRpbmdCcmFuY2g9cCxpcChwLG0pPyhhKG0scCxkLmhpZGRlbkNvbnRhaW5lcixudWxsLGksZCxsLHMsbyksZC5kZXBzPD0wP2QucmVzb2x2ZSgpOmcmJiF5JiYoYShmLGgsbixyLGksbnVsbCxsLHMsbykscjUoZCxoKSkpOihkLnBlbmRpbmdJZD1yMisrLHk/KGQuaXNIeWRyYXRpbmc9ITEsZC5hY3RpdmVCcmFuY2g9bSk6YyhtLGksZCksZC5kZXBzPTAsZC5lZmZlY3RzLmxlbmd0aD0wLGQuaGlkZGVuQ29udGFpbmVyPXUoImRpdiIpLGc/KGEobnVsbCxwLGQuaGlkZGVuQ29udGFpbmVyLG51bGwsaSxkLGwscyxvKSxkLmRlcHM8PTA/ZC5yZXNvbHZlKCk6KGEoZixoLG4scixpLG51bGwsbCxzLG8pLHI1KGQsaCkpKTpmJiZpcChwLGYpPyhhKGYscCxuLHIsaSxkLGwscyxvKSxkLnJlc29sdmUoITApKTooYShudWxsLHAsZC5oaWRkZW5Db250YWluZXIsbnVsbCxpLGQsbCxzLG8pLGQuZGVwczw9MCYmZC5yZXNvbHZlKCkpKTtlbHNlIGlmKGYmJmlwKHAsZikpYShmLHAsbixyLGksZCxsLHMsbykscjUoZCxwKTtlbHNlIGlmKHIzKHQsIm9uUGVuZGluZyIpLGQucGVuZGluZ0JyYW5jaD1wLDUxMiZwLnNoYXBlRmxhZz9kLnBlbmRpbmdJZD1wLmNvbXBvbmVudC5zdXNwZW5zZUlkOmQucGVuZGluZ0lkPXIyKyssYShudWxsLHAsZC5oaWRkZW5Db250YWluZXIsbnVsbCxpLGQsbCxzLG8pLGQuZGVwczw9MClkLnJlc29sdmUoKTtlbHNle2xldHt0aW1lb3V0OmUscGVuZGluZ0lkOnR9PWQ7ZT4wP3NldFRpbWVvdXQoKCk9PntkLnBlbmRpbmdJZD09PXQmJmQuZmFsbGJhY2soaCl9LGUpOjA9PT1lJiZkLmZhbGxiYWNrKGgpfX0oZSx0LG4scixpLHMsbyxhLGMpfX0saHlkcmF0ZTpmdW5jdGlvbihlLHQsbixyLGksbCxzLG8sYSl7bGV0IGM9dC5zdXNwZW5zZT1yNih0LHIsbixlLnBhcmVudE5vZGUsZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksbnVsbCxpLGwscyxvLCEwKSx1PWEoZSxjLnBlbmRpbmdCcmFuY2g9dC5zc0NvbnRlbnQsbixjLGwscyk7cmV0dXJuIDA9PT1jLmRlcHMmJmMucmVzb2x2ZSghMSwhMCksdX0sbm9ybWFsaXplOmZ1bmN0aW9uKGUpe2xldHtzaGFwZUZsYWc6dCxjaGlsZHJlbjpufT1lLHI9MzImdDtlLnNzQ29udGVudD1yNChyP24uZGVmYXVsdDpuKSxlLnNzRmFsbGJhY2s9cj9yNChuLmZhbGxiYWNrKTppdihpZSl9fSxlLlRlbGVwb3J0PW5vLGUuVGV4dD1yNyxlLlRyYWNrT3BUeXBlcz17R0VUOiJnZXQiLEhBUzoiaGFzIixJVEVSQVRFOiJpdGVyYXRlIn0sZS5UcmFuc2l0aW9uPWkwLGUuVHJhbnNpdGlvbkdyb3VwPWxSLGUuVHJpZ2dlck9wVHlwZXM9e1NFVDoic2V0IixBREQ6ImFkZCIsREVMRVRFOiJkZWxldGUiLENMRUFSOiJjbGVhciJ9LGUuVnVlRWxlbWVudD1sVCxlLmFzc2VydE51bWJlcj1mdW5jdGlvbihlLHQpe30sZS5jYWxsV2l0aEFzeW5jRXJyb3JIYW5kbGluZz10cSxlLmNhbGxXaXRoRXJyb3JIYW5kbGluZz10SCxlLmNhbWVsaXplPUssZS5jYXBpdGFsaXplPUcsZS5jbG9uZVZOb2RlPWliLGUuY29tcGF0VXRpbHM9bnVsbCxlLmNvbXBpbGU9YUgsZS5jb21wdXRlZD1pVSxlLmNyZWF0ZUFwcD1sMSxlLmNyZWF0ZUJsb2NrPWl1LGUuY3JlYXRlQ29tbWVudFZOb2RlPWZ1bmN0aW9uKGU9IiIsdD0hMSl7cmV0dXJuIHQ/KGlsKCksaXUoaWUsbnVsbCxlKSk6aXYoaWUsbnVsbCxlKX0sZS5jcmVhdGVFbGVtZW50QmxvY2s9ZnVuY3Rpb24oZSx0LG4scixpLGwpe3JldHVybiBpYyhpZyhlLHQsbixyLGksbCwhMCkpfSxlLmNyZWF0ZUVsZW1lbnRWTm9kZT1pZyxlLmNyZWF0ZUh5ZHJhdGlvblJlbmRlcmVyPXJMLGUuY3JlYXRlUHJvcHNSZXN0UHJveHk9ZnVuY3Rpb24oZSx0KXtsZXQgbj17fTtmb3IobGV0IHIgaW4gZSl0LmluY2x1ZGVzKHIpfHxPYmplY3QuZGVmaW5lUHJvcGVydHkobixyLHtlbnVtZXJhYmxlOiEwLGdldDooKT0+ZVtyXX0pO3JldHVybiBufSxlLmNyZWF0ZVJlbmRlcmVyPWZ1bmN0aW9uKGUpe3JldHVybiByJChlKX0sZS5jcmVhdGVTU1JBcHA9bDIsZS5jcmVhdGVTbG90cz1mdW5jdGlvbihlLHQpe2ZvcihsZXQgbj0wO248dC5sZW5ndGg7bisrKXtsZXQgcj10W25dO2lmKEUocikpZm9yKGxldCB0PTA7dDxyLmxlbmd0aDt0KyspZVtyW3RdLm5hbWVdPXJbdF0uZm47ZWxzZSByJiYoZVtyLm5hbWVdPXIua2V5PyguLi5lKT0+e2xldCB0PXIuZm4oLi4uZSk7cmV0dXJuIHQmJih0LmtleT1yLmtleSksdH06ci5mbil9cmV0dXJuIGV9LGUuY3JlYXRlU3RhdGljVk5vZGU9ZnVuY3Rpb24oZSx0KXtsZXQgbj1pdihpdCxudWxsLGUpO3JldHVybiBuLnN0YXRpY0NvdW50PXQsbn0sZS5jcmVhdGVUZXh0Vk5vZGU9aV8sZS5jcmVhdGVWTm9kZT1pdixlLmN1c3RvbVJlZj10TSxlLmRlZmluZUFzeW5jQ29tcG9uZW50PWZ1bmN0aW9uKGUpe2xldCB0O1AoZSkmJihlPXtsb2FkZXI6ZX0pO2xldHtsb2FkZXI6bixsb2FkaW5nQ29tcG9uZW50OnIsZXJyb3JDb21wb25lbnQ6aSxkZWxheTpsPTIwMCxoeWRyYXRlOnMsdGltZW91dDpvLHN1c3BlbnNpYmxlOmE9ITAsb25FcnJvcjpjfT1lLHU9bnVsbCxkPTAscD0oKT0+e2xldCBlO3JldHVybiB1fHwoZT11PW4oKS5jYXRjaChlPT57aWYoZT1lIGluc3RhbmNlb2YgRXJyb3I/ZTpFcnJvcihTdHJpbmcoZSkpLGMpcmV0dXJuIG5ldyBQcm9taXNlKCh0LG4pPT57YyhlLCgpPT50KChkKyssdT1udWxsLHAoKSkpLCgpPT5uKGUpLGQrMSl9KTt0aHJvdyBlfSkudGhlbihuPT5lIT09dSYmdT91OihuJiYobi5fX2VzTW9kdWxlfHwiTW9kdWxlIj09PW5bU3ltYm9sLnRvU3RyaW5nVGFnXSkmJihuPW4uZGVmYXVsdCksdD1uLG4pKSl9O3JldHVybiBuVCh7bmFtZToiQXN5bmNDb21wb25lbnRXcmFwcGVyIixfX2FzeW5jTG9hZGVyOnAsX19hc3luY0h5ZHJhdGUoZSxuLHIpe2xldCBpPXM/KCk9PntsZXQgdD1zKCgpPT57cigpfSx0PT4oZnVuY3Rpb24oZSx0KXtpZihuUihlKSYmIlsiPT09ZS5kYXRhKXtsZXQgbj0xLHI9ZS5uZXh0U2libGluZztmb3IoO3I7KXtpZigxPT09ci5ub2RlVHlwZSl7aWYoITE9PT10KHIpKWJyZWFrfWVsc2UgaWYoblIocikpaWYoIl0iPT09ci5kYXRhKXtpZigwPT0tLW4pYnJlYWt9ZWxzZSJbIj09PXIuZGF0YSYmbisrO3I9ci5uZXh0U2libGluZ319ZWxzZSB0KGUpfSkoZSx0KSk7dCYmKG4uYnVtfHwobi5idW09W10pKS5wdXNoKHQpLChuLnV8fChuLnU9W10pKS5wdXNoKCgpPT4hMCl9OnI7dD9pKCk6cCgpLnRoZW4oKCk9PiFuLmlzVW5tb3VudGVkJiZpKCkpfSxnZXQgX19hc3luY1Jlc29sdmVkKCl7cmV0dXJuIHR9LHNldHVwKCl7bGV0IGU9aUE7aWYobk4oZSksdClyZXR1cm4oKT0+blYodCxlKTtsZXQgbj10PT57dT1udWxsLHRXKHQsZSwxMywhaSl9O2lmKGEmJmUuc3VzcGVuc2UpcmV0dXJuIHAoKS50aGVuKHQ9PigpPT5uVih0LGUpKS5jYXRjaChlPT4obihlKSwoKT0+aT9pdihpLHtlcnJvcjplfSk6bnVsbCkpO2xldCBzPXROKCExKSxjPXROKCksZD10TighIWwpO3JldHVybiBsJiZzZXRUaW1lb3V0KCgpPT57ZC52YWx1ZT0hMX0sbCksbnVsbCE9byYmc2V0VGltZW91dCgoKT0+e2lmKCFzLnZhbHVlJiYhYy52YWx1ZSl7bGV0IGU9RXJyb3IoYEFzeW5jIGNvbXBvbmVudCB0aW1lZCBvdXQgYWZ0ZXIgJHtvfW1zLmApO24oZSksYy52YWx1ZT1lfX0sbykscCgpLnRoZW4oKCk9PntzLnZhbHVlPSEwLGUucGFyZW50JiZuQihlLnBhcmVudC52bm9kZSkmJmUucGFyZW50LnVwZGF0ZSgpfSkuY2F0Y2goZT0+e24oZSksYy52YWx1ZT1lfSksKCk9PnMudmFsdWUmJnQ/blYodCxlKTpjLnZhbHVlJiZpP2l2KGkse2Vycm9yOmMudmFsdWV9KTpyJiYhZC52YWx1ZT9pdihyKTp2b2lkIDB9fSl9LGUuZGVmaW5lQ29tcG9uZW50PW5ULGUuZGVmaW5lQ3VzdG9tRWxlbWVudD1sQyxlLmRlZmluZUVtaXRzPWZ1bmN0aW9uKCl7cmV0dXJuIG51bGx9LGUuZGVmaW5lRXhwb3NlPWZ1bmN0aW9uKGUpe30sZS5kZWZpbmVNb2RlbD1mdW5jdGlvbigpe30sZS5kZWZpbmVPcHRpb25zPWZ1bmN0aW9uKGUpe30sZS5kZWZpbmVQcm9wcz1mdW5jdGlvbigpe3JldHVybiBudWxsfSxlLmRlZmluZVNTUkN1c3RvbUVsZW1lbnQ9KGUsdCk9PmxDKGUsdCxsMiksZS5kZWZpbmVTbG90cz1mdW5jdGlvbigpe3JldHVybiBudWxsfSxlLmRldnRvb2xzPXZvaWQgMCxlLmVmZmVjdD1mdW5jdGlvbihlLHQpe2UuZWZmZWN0IGluc3RhbmNlb2YgZUMmJihlPWUuZWZmZWN0LmZuKTtsZXQgbj1uZXcgZUMoZSk7dCYmVChuLHQpO3RyeXtuLnJ1bigpfWNhdGNoKGUpe3Rocm93IG4uc3RvcCgpLGV9bGV0IHI9bi5ydW4uYmluZChuKTtyZXR1cm4gci5lZmZlY3Q9bixyfSxlLmVmZmVjdFNjb3BlPWZ1bmN0aW9uKGUpe3JldHVybiBuZXcgZVMoZSl9LGUuZ2V0Q3VycmVudEluc3RhbmNlPWlFLGUuZ2V0Q3VycmVudFNjb3BlPWZ1bmN0aW9uKCl7cmV0dXJuIGx9LGUuZ2V0Q3VycmVudFdhdGNoZXI9ZnVuY3Rpb24oKXtyZXR1cm4gbX0sZS5nZXRUcmFuc2l0aW9uUmF3Q2hpbGRyZW49bmssZS5ndWFyZFJlYWN0aXZlUHJvcHM9aXksZS5oPWlqLGUuaGFuZGxlRXJyb3I9dFcsZS5oYXNJbmplY3Rpb25Db250ZXh0PWZ1bmN0aW9uKCl7cmV0dXJuISEoaUF8fHQ4fHxyeSl9LGUuaHlkcmF0ZT0oLi4uZSk9PntsWSgpLmh5ZHJhdGUoLi4uZSl9LGUuaHlkcmF0ZU9uSWRsZT0oZT0xZTQpPT50PT57bGV0IG49biQodCx7dGltZW91dDplfSk7cmV0dXJuKCk9Pm5EKG4pfSxlLmh5ZHJhdGVPbkludGVyYWN0aW9uPShlPVtdKT0+KHQsbik9PntNKGUpJiYoZT1bZV0pO2xldCByPSExLGk9ZT0+e3J8fChyPSEwLGwoKSx0KCksZS50YXJnZXQuZGlzcGF0Y2hFdmVudChuZXcgZS5jb25zdHJ1Y3RvcihlLnR5cGUsZSkpKX0sbD0oKT0+e24odD0+e2ZvcihsZXQgbiBvZiBlKXQucmVtb3ZlRXZlbnRMaXN0ZW5lcihuLGkpfSl9O3JldHVybiBuKHQ9Pntmb3IobGV0IG4gb2YgZSl0LmFkZEV2ZW50TGlzdGVuZXIobixpLHtvbmNlOiEwfSl9KSxsfSxlLmh5ZHJhdGVPbk1lZGlhUXVlcnk9ZT0+dD0+e2lmKGUpe2xldCBuPW1hdGNoTWVkaWEoZSk7aWYoIW4ubWF0Y2hlcylyZXR1cm4gbi5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLHQse29uY2U6ITB9KSwoKT0+bi5yZW1vdmVFdmVudExpc3RlbmVyKCJjaGFuZ2UiLHQpO3QoKX19LGUuaHlkcmF0ZU9uVmlzaWJsZT1lPT4odCxuKT0+e2xldCByPW5ldyBJbnRlcnNlY3Rpb25PYnNlcnZlcihlPT57Zm9yKGxldCBuIG9mIGUpaWYobi5pc0ludGVyc2VjdGluZyl7ci5kaXNjb25uZWN0KCksdCgpO2JyZWFrfX0sZSk7cmV0dXJuIG4oZT0+e2lmKGUgaW5zdGFuY2VvZiBFbGVtZW50KXtpZihmdW5jdGlvbihlKXtsZXR7dG9wOnQsbGVmdDpuLGJvdHRvbTpyLHJpZ2h0Oml9PWUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkse2lubmVySGVpZ2h0OmwsaW5uZXJXaWR0aDpzfT13aW5kb3c7cmV0dXJuKHQ+MCYmdDxsfHxyPjAmJnI8bCkmJihuPjAmJm48c3x8aT4wJiZpPHMpfShlKSlyZXR1cm4gdCgpLHIuZGlzY29ubmVjdCgpLCExO3Iub2JzZXJ2ZShlKX19KSwoKT0+ci5kaXNjb25uZWN0KCl9LGUuaW5pdEN1c3RvbUZvcm1hdHRlcj1mdW5jdGlvbigpe30sZS5pbml0RGlyZWN0aXZlc0ZvclNTUj1TLGUuaW5qZWN0PXJfLGUuaXNNZW1vU2FtZT1pSCxlLmlzUHJveHk9dF8sZS5pc1JlYWN0aXZlPXR2LGUuaXNSZWFkb25seT10eSxlLmlzUmVmPXRULGUuaXNSdW50aW1lT25seT0oKT0+IWQsZS5pc1NoYWxsb3c9dGIsZS5pc1ZOb2RlPWlkLGUubWFya1Jhdz10eCxlLm1lcmdlRGVmYXVsdHM9ZnVuY3Rpb24oZSx0KXtsZXQgbj1ybChlKTtmb3IobGV0IGUgaW4gdCl7aWYoZS5zdGFydHNXaXRoKCJfX3NraXAiKSljb250aW51ZTtsZXQgcj1uW2VdO3I/RShyKXx8UChyKT9yPW5bZV09e3R5cGU6cixkZWZhdWx0OnRbZV19OnIuZGVmYXVsdD10W2VdOm51bGw9PT1yJiYocj1uW2VdPXtkZWZhdWx0OnRbZV19KSxyJiZ0W2BfX3NraXBfJHtlfWBdJiYoci5za2lwRmFjdG9yeT0hMCl9cmV0dXJuIG59LGUubWVyZ2VNb2RlbHM9ZnVuY3Rpb24oZSx0KXtyZXR1cm4gZSYmdD9FKGUpJiZFKHQpP2UuY29uY2F0KHQpOlQoe30scmwoZSkscmwodCkpOmV8fHR9LGUubWVyZ2VQcm9wcz1payxlLm5leHRUaWNrPXRZLGUubm9ybWFsaXplQ2xhc3M9ZWMsZS5ub3JtYWxpemVQcm9wcz1mdW5jdGlvbihlKXtpZighZSlyZXR1cm4gbnVsbDtsZXR7Y2xhc3M6dCxzdHlsZTpufT1lO3JldHVybiB0JiYhTSh0KSYmKGUuY2xhc3M9ZWModCkpLG4mJihlLnN0eWxlPWVpKG4pKSxlfSxlLm5vcm1hbGl6ZVN0eWxlPWVpLGUub25BY3RpdmF0ZWQ9bmosZS5vbkJlZm9yZU1vdW50PW5HLGUub25CZWZvcmVVbm1vdW50PW5ZLGUub25CZWZvcmVVcGRhdGU9blEsZS5vbkRlYWN0aXZhdGVkPW5ILGUub25FcnJvckNhcHR1cmVkPW42LGUub25Nb3VudGVkPW5YLGUub25SZW5kZXJUcmFja2VkPW4zLGUub25SZW5kZXJUcmlnZ2VyZWQ9bjIsZS5vblNjb3BlRGlzcG9zZT1mdW5jdGlvbihlLHQ9ITEpe2wmJmwuY2xlYW51cHMucHVzaChlKX0sZS5vblNlcnZlclByZWZldGNoPW4xLGUub25Vbm1vdW50ZWQ9bjAsZS5vblVwZGF0ZWQ9blosZS5vbldhdGNoZXJDbGVhbnVwPXRVLGUub3BlbkJsb2NrPWlsLGUucG9wU2NvcGVJZD1mdW5jdGlvbigpe3Q1PW51bGx9LGUucHJvdmlkZT1yYixlLnByb3h5UmVmcz10TyxlLnB1c2hTY29wZUlkPWZ1bmN0aW9uKGUpe3Q1PWV9LGUucXVldWVQb3N0Rmx1c2hDYj10MixlLnJlYWN0aXZlPXRoLGUucmVhZG9ubHk9dG0sZS5yZWY9dE4sZS5yZWdpc3RlclJ1bnRpbWVDb21waWxlcj1pTCxlLnJlbmRlcj1sMCxlLnJlbmRlckxpc3Q9ZnVuY3Rpb24oZSx0LG4scil7bGV0IGksbD1uJiZuW3JdLHM9RShlKTtpZihzfHxNKGUpKXtsZXQgbj1zJiZ0dihlKSxyPSExLG89ITE7biYmKHI9IXRiKGUpLG89dHkoZSksZT1leihlKSksaT1BcnJheShlLmxlbmd0aCk7Zm9yKGxldCBuPTAscz1lLmxlbmd0aDtuPHM7bisrKWlbbl09dChyP28/dGsodEMoZVtuXSkpOnRDKGVbbl0pOmVbbl0sbix2b2lkIDAsbCYmbFtuXSl9ZWxzZSBpZigibnVtYmVyIj09dHlwZW9mIGUpe2k9QXJyYXkoZSk7Zm9yKGxldCBuPTA7bjxlO24rKylpW25dPXQobisxLG4sdm9pZCAwLGwmJmxbbl0pfWVsc2UgaWYoJChlKSlpZihlW1N5bWJvbC5pdGVyYXRvcl0paT1BcnJheS5mcm9tKGUsKGUsbik9PnQoZSxuLHZvaWQgMCxsJiZsW25dKSk7ZWxzZXtsZXQgbj1PYmplY3Qua2V5cyhlKTtpPUFycmF5KG4ubGVuZ3RoKTtmb3IobGV0IHI9MCxzPW4ubGVuZ3RoO3I8cztyKyspe2xldCBzPW5bcl07aVtyXT10KGVbc10scyxyLGwmJmxbcl0pfX1lbHNlIGk9W107cmV0dXJuIG4mJihuW3JdPWkpLGl9LGUucmVuZGVyU2xvdD1mdW5jdGlvbihlLHQsbj17fSxyLGkpe2lmKHQ4LmNlfHx0OC5wYXJlbnQmJm5GKHQ4LnBhcmVudCkmJnQ4LnBhcmVudC5jZSlyZXR1cm4iZGVmYXVsdCIhPT10JiYobi5uYW1lPXQpLGlsKCksaXUocjksbnVsbCxbaXYoInNsb3QiLG4sciYmcigpKV0sNjQpO2xldCBsPWVbdF07bCYmbC5fYyYmKGwuX2Q9ITEpLGlsKCk7bGV0IHM9bCYmZnVuY3Rpb24gZSh0KXtyZXR1cm4gdC5zb21lKHQ9PiFpZCh0KXx8dC50eXBlIT09aWUmJih0LnR5cGUhPT1yOXx8ISFlKHQuY2hpbGRyZW4pKSk/dDpudWxsfShsKG4pKSxvPW4ua2V5fHxzJiZzLmtleSxhPWl1KHI5LHtrZXk6KG8mJiFMKG8pP286YF8ke3R9YCkrKCFzJiZyPyJfZmIiOiIiKX0sc3x8KHI/cigpOltdKSxzJiYxPT09ZS5fPzY0Oi0yKTtyZXR1cm4haSYmYS5zY29wZUlkJiYoYS5zbG90U2NvcGVJZHM9W2Euc2NvcGVJZCsiLXMiXSksbCYmbC5fYyYmKGwuX2Q9ITApLGF9LGUucmVzb2x2ZUNvbXBvbmVudD1mdW5jdGlvbihlLHQpe3JldHVybiBuNShuNCxlLCEwLHQpfHxlfSxlLnJlc29sdmVEaXJlY3RpdmU9ZnVuY3Rpb24oZSl7cmV0dXJuIG41KCJkaXJlY3RpdmVzIixlKX0sZS5yZXNvbHZlRHluYW1pY0NvbXBvbmVudD1mdW5jdGlvbihlKXtyZXR1cm4gTShlKT9uNShuNCxlLCExKXx8ZTplfHxuOH0sZS5yZXNvbHZlRmlsdGVyPW51bGwsZS5yZXNvbHZlVHJhbnNpdGlvbkhvb2tzPW5fLGUuc2V0QmxvY2tUcmFja2luZz1pYSxlLnNldERldnRvb2xzSG9vaz1TLGUuc2V0VHJhbnNpdGlvbkhvb2tzPW5DLGUuc2hhbGxvd1JlYWN0aXZlPXRmLGUuc2hhbGxvd1JlYWRvbmx5PWZ1bmN0aW9uKGUpe3JldHVybiB0ZyhlLCEwLHRlLHRhLHRwKX0sZS5zaGFsbG93UmVmPXR3LGUuc3NyQ29udGV4dEtleT1yaixlLnNzclV0aWxzPW51bGwsZS5zdG9wPWZ1bmN0aW9uKGUpe2UuZWZmZWN0LnN0b3AoKX0sZS50b0Rpc3BsYXlTdHJpbmc9ZXksZS50b0hhbmRsZXJLZXk9WCxlLnRvSGFuZGxlcnM9ZnVuY3Rpb24oZSx0KXtsZXQgbj17fTtmb3IobGV0IHIgaW4gZSluW3QmJi9bQS1aXS8udGVzdChyKT9gb246JHtyfWA6WChyKV09ZVtyXTtyZXR1cm4gbn0sZS50b1Jhdz10UyxlLnRvUmVmPWZ1bmN0aW9uKGUsdCxuKXtyZXR1cm4gdFQoZSk/ZTpQKGUpP25ldyB0JChlKTokKGUpJiZhcmd1bWVudHMubGVuZ3RoPjE/dEQoZSx0LG4pOnROKGUpfSxlLnRvUmVmcz1mdW5jdGlvbihlKXtsZXQgdD1FKGUpP0FycmF5KGUubGVuZ3RoKTp7fTtmb3IobGV0IG4gaW4gZSl0W25dPXREKGUsbik7cmV0dXJuIHR9LGUudG9WYWx1ZT1mdW5jdGlvbihlKXtyZXR1cm4gUChlKT9lKCk6dEkoZSl9LGUudHJhbnNmb3JtVk5vZGVBcmdzPWZ1bmN0aW9uKGUpe30sZS50cmlnZ2VyUmVmPWZ1bmN0aW9uKGUpe2UuZGVwJiZlLmRlcC50cmlnZ2VyKCl9LGUudW5yZWY9dEksZS51c2VBdHRycz1mdW5jdGlvbigpe3JldHVybiByaSgpLmF0dHJzfSxlLnVzZUNzc01vZHVsZT1mdW5jdGlvbihlPSIkc3R5bGUiKXtyZXR1cm4gYn0sZS51c2VDc3NWYXJzPWZ1bmN0aW9uKGUpe2xldCB0PWlFKCk7aWYoIXQpcmV0dXJuO2xldCBuPXQudXQ9KG49ZSh0LnByb3h5KSk9PntBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoYFtkYXRhLXYtb3duZXI9IiR7dC51aWR9Il1gKSkuZm9yRWFjaChlPT5sbyhlLG4pKX0scj0oKT0+e2xldCByPWUodC5wcm94eSk7dC5jZT9sbyh0LmNlLHIpOmZ1bmN0aW9uIGUodCxuKXtpZigxMjgmdC5zaGFwZUZsYWcpe2xldCByPXQuc3VzcGVuc2U7dD1yLmFjdGl2ZUJyYW5jaCxyLnBlbmRpbmdCcmFuY2gmJiFyLmlzSHlkcmF0aW5nJiZyLmVmZmVjdHMucHVzaCgoKT0+e2Uoci5hY3RpdmVCcmFuY2gsbil9KX1mb3IoO3QuY29tcG9uZW50Oyl0PXQuY29tcG9uZW50LnN1YlRyZWU7aWYoMSZ0LnNoYXBlRmxhZyYmdC5lbClsbyh0LmVsLG4pO2Vsc2UgaWYodC50eXBlPT09cjkpdC5jaGlsZHJlbi5mb3JFYWNoKHQ9PmUodCxuKSk7ZWxzZSBpZih0LnR5cGU9PT1pdCl7bGV0e2VsOmUsYW5jaG9yOnJ9PXQ7Zm9yKDtlJiYobG8oZSxuKSxlIT09cik7KWU9ZS5uZXh0U2libGluZ319KHQuc3ViVHJlZSxyKSxuKHIpfTtuUSgoKT0+e3QyKHIpfSksblgoKCk9PntycShyLFMse2ZsdXNoOiJwb3N0In0pO2xldCBlPW5ldyBNdXRhdGlvbk9ic2VydmVyKHIpO2Uub2JzZXJ2ZSh0LnN1YlRyZWUuZWwucGFyZW50Tm9kZSx7Y2hpbGRMaXN0OiEwfSksbjAoKCk9PmUuZGlzY29ubmVjdCgpKX0pfSxlLnVzZUhvc3Q9bE4sZS51c2VJZD1mdW5jdGlvbigpe2xldCBlPWlFKCk7cmV0dXJuIGU/KGUuYXBwQ29udGV4dC5jb25maWcuaWRQcmVmaXh8fCJ2IikrIi0iK2UuaWRzWzBdK2UuaWRzWzFdKys6IiJ9LGUudXNlTW9kZWw9ZnVuY3Rpb24oZSx0LG49Yil7bGV0IHI9aUUoKSxpPUsodCksbD1KKHQpLHM9cnooZSxpKSxvPXRNKChzLG8pPT57bGV0IGEsYyx1PWI7cmV0dXJuIHJIKCgpPT57bGV0IHQ9ZVtpXTtRKGEsdCkmJihhPXQsbygpKX0pLHtnZXQ6KCk9PihzKCksbi5nZXQ/bi5nZXQoYSk6YSksc2V0KGUpe2xldCBzPW4uc2V0P24uc2V0KGUpOmU7aWYoIVEocyxhKSYmISh1IT09YiYmUShlLHUpKSlyZXR1cm47bGV0IGQ9ci52bm9kZS5wcm9wcztkJiYodCBpbiBkfHxpIGluIGR8fGwgaW4gZCkmJihgb25VcGRhdGU6JHt0fWBpbiBkfHxgb25VcGRhdGU6JHtpfWBpbiBkfHxgb25VcGRhdGU6JHtsfWBpbiBkKXx8KGE9ZSxvKCkpLHIuZW1pdChgdXBkYXRlOiR7dH1gLHMpLFEoZSxzKSYmUShlLHUpJiYhUShzLGMpJiZvKCksdT1lLGM9c319fSk7cmV0dXJuIG9bU3ltYm9sLml0ZXJhdG9yXT0oKT0+e2xldCBlPTA7cmV0dXJue25leHQ6KCk9PmU8Mj97dmFsdWU6ZSsrP3N8fGI6byxkb25lOiExfTp7ZG9uZTohMH19fSxvfSxlLnVzZVNTUkNvbnRleHQ9KCk9Pnt9LGUudXNlU2hhZG93Um9vdD1mdW5jdGlvbigpe2xldCBlPWxOKCk7cmV0dXJuIGUmJmUuc2hhZG93Um9vdH0sZS51c2VTbG90cz1mdW5jdGlvbigpe3JldHVybiByaSgpLnNsb3RzfSxlLnVzZVRlbXBsYXRlUmVmPWZ1bmN0aW9uKGUpe2xldCB0PWlFKCksbj10dyhudWxsKTtyZXR1cm4gdCYmT2JqZWN0LmRlZmluZVByb3BlcnR5KHQucmVmcz09PWI/dC5yZWZzPXt9OnQucmVmcyxlLHtlbnVtZXJhYmxlOiEwLGdldDooKT0+bi52YWx1ZSxzZXQ6ZT0+bi52YWx1ZT1lfSksbn0sZS51c2VUcmFuc2l0aW9uU3RhdGU9bmgsZS52TW9kZWxDaGVja2JveD1sQixlLnZNb2RlbER5bmFtaWM9e2NyZWF0ZWQoZSx0LG4pe2x6KGUsdCxuLG51bGwsImNyZWF0ZWQiKX0sbW91bnRlZChlLHQsbil7bHooZSx0LG4sbnVsbCwibW91bnRlZCIpfSxiZWZvcmVVcGRhdGUoZSx0LG4scil7bHooZSx0LG4sciwiYmVmb3JlVXBkYXRlIil9LHVwZGF0ZWQoZSx0LG4scil7bHooZSx0LG4sciwidXBkYXRlZCIpfX0sZS52TW9kZWxSYWRpbz1saixlLnZNb2RlbFNlbGVjdD1sSCxlLnZNb2RlbFRleHQ9bFYsZS52U2hvdz17YmVmb3JlTW91bnQoZSx7dmFsdWU6dH0se3RyYW5zaXRpb246bn0pe2VbbHJdPSJub25lIj09PWUuc3R5bGUuZGlzcGxheT8iIjplLnN0eWxlLmRpc3BsYXksbiYmdD9uLmJlZm9yZUVudGVyKGUpOmxsKGUsdCl9LG1vdW50ZWQoZSx7dmFsdWU6dH0se3RyYW5zaXRpb246bn0pe24mJnQmJm4uZW50ZXIoZSl9LHVwZGF0ZWQoZSx7dmFsdWU6dCxvbGRWYWx1ZTpufSx7dHJhbnNpdGlvbjpyfSl7IXQhPSFuJiYocj90PyhyLmJlZm9yZUVudGVyKGUpLGxsKGUsITApLHIuZW50ZXIoZSkpOnIubGVhdmUoZSwoKT0+e2xsKGUsITEpfSk6bGwoZSx0KSl9LGJlZm9yZVVubW91bnQoZSx7dmFsdWU6dH0pe2xsKGUsdCl9fSxlLnZlcnNpb249aXEsZS53YXJuPVMsZS53YXRjaD1mdW5jdGlvbihlLHQsbil7cmV0dXJuIHJxKGUsdCxuKX0sZS53YXRjaEVmZmVjdD1mdW5jdGlvbihlLHQpe3JldHVybiBycShlLG51bGwsdCl9LGUud2F0Y2hQb3N0RWZmZWN0PWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHJxKGUsbnVsbCx7Zmx1c2g6InBvc3QifSl9LGUud2F0Y2hTeW5jRWZmZWN0PXJILGUud2l0aEFzeW5jQ29udGV4dD1mdW5jdGlvbihlKXtsZXQgdD1pRSgpLG49ZSgpO3JldHVybiBpUigpLEQobikmJihuPW4uY2F0Y2goZT0+e3Rocm93IGlJKHQpLGV9KSksW24sKCk9PmlJKHQpXX0sZS53aXRoQ3R4PXQ3LGUud2l0aERlZmF1bHRzPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIG51bGx9LGUud2l0aERpcmVjdGl2ZXM9ZnVuY3Rpb24oZSx0KXtpZihudWxsPT09dDgpcmV0dXJuIGU7bGV0IG49aVYodDgpLHI9ZS5kaXJzfHwoZS5kaXJzPVtdKTtmb3IobGV0IGU9MDtlPHQubGVuZ3RoO2UrKyl7bGV0W2ksbCxzLG89Yl09dFtlXTtpJiYoUChpKSYmKGk9e21vdW50ZWQ6aSx1cGRhdGVkOml9KSxpLmRlZXAmJnRqKGwpLHIucHVzaCh7ZGlyOmksaW5zdGFuY2U6bix2YWx1ZTpsLG9sZFZhbHVlOnZvaWQgMCxhcmc6cyxtb2RpZmllcnM6b30pKX1yZXR1cm4gZX0sZS53aXRoS2V5cz0oZSx0KT0+e2xldCBuPWUuX3dpdGhLZXlzfHwoZS5fd2l0aEtleXM9e30pLHI9dC5qb2luKCIuIik7cmV0dXJuIG5bcl18fChuW3JdPW49PntpZighKCJrZXkiaW4gbikpcmV0dXJuO2xldCByPUoobi5rZXkpO2lmKHQuc29tZShlPT5lPT09cnx8bFhbZV09PT1yKSlyZXR1cm4gZShuKX0pfSxlLndpdGhNZW1vPWZ1bmN0aW9uKGUsdCxuLHIpe2xldCBpPW5bcl07aWYoaSYmaUgoaSxlKSlyZXR1cm4gaTtsZXQgbD10KCk7cmV0dXJuIGwubWVtbz1lLnNsaWNlKCksbC5jYWNoZUluZGV4PXIsbltyXT1sfSxlLndpdGhNb2RpZmllcnM9KGUsdCk9PntsZXQgbj1lLl93aXRoTW9kc3x8KGUuX3dpdGhNb2RzPXt9KSxyPXQuam9pbigiLiIpO3JldHVybiBuW3JdfHwobltyXT0obiwuLi5yKT0+e2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKXtsZXQgcj1sR1t0W2VdXTtpZihyJiZyKG4sdCkpcmV0dXJufXJldHVybiBlKG4sLi4ucil9KX0sZS53aXRoU2NvcGVJZD1lPT50NyxlfSh7fSk7DQo='

export default function inlineVue() {
  return {
    name: 'inline-vue',
    configResolved(config) {
      isBuilding = config.command === 'build'
    },
    async transformIndexHtml(html) {
      const match = html.match(/^[ \t]*<!-- Vue UMD -->.*$/m)
      const indent = match ? match[0].match(/^[ \t]*/)[0] : ''

      const vue = `<!-- Vue UMD ${isBuilding ? 'production' : 'development'} -->\n${indent}<script src="${isBuilding ? vueProd : vueDev}"></script>`;

      return html.replace(/<!-- Vue UMD -->/, vue)
    }
  }
}
